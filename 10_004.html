<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
                    
        <head><meta content="application/xhtml+xml; charset=utf-8" http-equiv="Content-Type"/>
            <meta content="application/xhtml+xml; charset=utf-8" name="content-type"/>
            <meta content="REST Server" name="title"/>
            <meta content="Sebastian Springer" name="author"/>
            <meta content="Rheinwerk Publishing" name="publisher"/>
            <meta content="© 2022 by Rheinwerk Publishing Inc., Boston (MA)" name="copyright"/>
            <meta content="Node.js - The Comprehensive Guide - REST Server" name="description"/>
            <meta content="en" name="language"/>
            <title>REST Server</title>
            <link href="common/main.css" rel="stylesheet" type="text/css"/>
<meta content="urn:uuid:e0000000-0000-0000-0000-000029756394" name="Adept.expected.resource"/>
        </head>
    


                    <body class="office_us type_kapitel">
                        <div id="main">
        <h2 class="t2" id="h10.4">10.4    Read Requests</h2>
        <p class="standard"><a class="indexanchor" id="i10_19"/>The movie database currently has one type of resource: the movie. You can access this resource via the URL <span class="italic">http://localhost:8080/movie</span>. A request to this address should return all the movies that exist in the database. If you’re only interested in a single data record, you must use the URL <span class="italic">http://localhost:8080/movie/1</span>. According to the specification, you must use the <samp class="listingcharacter listingcharacter">GET</samp> method for read access.</p>
        
            <h3 class="t3" id="h10.4.1">10.4.1    Reading<a class="indexanchor" id="i10_20"/> All Data Records of a Resource</h3>
            <p class="standard">If you access <span class="italic">http://localhost:8080/movie</span> to display all records for a list view, for example, this is mapped via the router in the <span class="italic">movie/index.js</span> file. To make the new interface <a id="p299"/>work, you reduce the size of this file significantly by removing all routes except the common list route. <span class="crossreference "><a href="10_004.html#l10.3">Listing 10.3</a></span> shows the new version of the <span class="italic">movie/index.js</span> file.</p>
            <div class="listing " id="l10.3"><pre><span class="rot">import</span><span class="schwarz"> { Router } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'express'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> { listAction } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./controller.js'</span><span class="schwarz">;</span><br/> <br/><span class="rot">const</span><span class="schwarz"> router </span><span class="dunkelblau">=</span><span class="schwarz"> Router();</span><br/> <br/>router.get(<span class="hellblau">'/'</span><span class="schwarz">, listAction);</span><br/> <br/><span class="rot">export</span><span class="schwarz"> { router }; </span><span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 10.3</b>    
            Customizing the Movie Router (movie/index.js)</p>
            <p class="standard">Some changes to the controller are also required, as it’s currently still trying to render the template; in addition, you don’t have a user ID at the moment. You can solve this problem by fixing the user ID in the controller to the value <samp class="listingcharacter listingcharacter">1</samp> until the final authentication implementation is done. This saves you unnecessary modification work on the model later on. <span class="crossreference "><a href="10_004.html#l10.4">Listing 10.4</a></span> shows the customization of the controller.</p>
            <div class="listing " id="l10.4"><pre><span class="rot">import</span><span class="schwarz"> { getAll } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./model.js'</span><span class="schwarz">;</span><br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> listAction(request, response) {</span><br/>  <span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">const</span><span class="schwarz"> movies </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> getAll(1);</span></samp></span><br/>  <span class="rot">const</span><span class="schwarz"> moviesResponse </span><span class="dunkelblau">=</span><span class="schwarz"> {</span><br/>    movies,<br/>    links: [{ rel: <span class="hellblau">'self'</span><span class="schwarz">, href: request.baseUrl </span><span class="dunkelblau">+</span><span class="schwarz"> </span><span class="hellblau">'/'</span><span class="schwarz"> }],</span><br/>  };<br/>  <span class="bold"><samp class="listingcharacter listingcharacter">response.json(moviesResponse);</samp></span><br/>} <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 10.4</b>    
            “listAction” in the Controller (movie/controller.js)</p>
            <p class="standard">The integration of the model remains almost unchanged. In the callback function, you create an object that contains the data records and an additional <samp class="listingcharacter listingcharacter">links</samp> property that points to further operations or currently only to itself. You send this object back to the client using the <samp class="listingcharacter listingcharacter">json</samp> method instead of the <samp class="listingcharacter listingcharacter">render</samp> or <samp class="listingcharacter listingcharacter">send</samp> method of the <samp class="listingcharacter listingcharacter">response</samp> object. This method is responsible for setting the correct header information and encoding the body for you. Finally, you can simplify the model a little because the ratings are no longer part of the <samp class="listingcharacter listingcharacter">movie</samp> resource. <span class="crossreference "><a href="10_004.html#l10.5">Listing 10.5</a></span> shows the adjustments to the model.</p>
            <div class="listing " id="l10.5"><pre><span class="rot">import</span><span class="schwarz"> sqlite </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'sqlite3'</span><span class="schwarz">;</span><br/> <br/><span class="rot">const</span><span class="schwarz"> db </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">new sqlite</span><span class="schwarz">.Database(</span><span class="hellblau">'./movie.db'</span><span class="schwarz">);</span><br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> getAll(userId) {</span><br/>  <span class="rot">return</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">Promise((resolve, reject) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/><a id="p300"/>    <span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">const</span><span class="schwarz"> query </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="violett">`SELECT * FROM Movies WHERE user = ? OR public = 1`</span><span class="schwarz">;</span><br/> </samp></span><br/>    db.all(query, <span class="bold"><samp class="listingcharacter listingcharacter">[userId]</samp></span>, (error, results) <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>      <span class="rot">if</span><span class="schwarz"> (error) {</span><br/>        reject(error);<br/>      } <span class="rot">else</span><span class="schwarz"> {</span><br/>        resolve(results);<br/>      }<br/>    });<br/>  });<br/>}<br/>... <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 10.5</b>    
            Customized Movie Model (movie/model.js)</p>
            <p class="standard">With these adjustments, you can now access your server and read the list of records. If you use Postman, it’s useful to create a collection, that is, a collection of query templates in Postman, for the movie database. After that, you can generate the request. <span class="crossreference "><a href="10_004.html#f10.2">Figure 10.2</a></span> shows the display in Postman<a class="indexanchor" id="i10_21"/> after you’ve sent the request. In the upper section, you can see the type of the request, which, in this case, is the <samp class="listingcharacter listingcharacter">GET</samp> value, and the destination: <span class="italic">http://localhost:8080/movie</span>. In the lower section of the window, you can see the result of the request.</p>
            <div class="imagebox figure-type"><a href="img-f10.2.html" id="f10.2"><img alt="Querying Movie Records with Postman" id="img-f10.2" src="bilderklein/klein10_002.png"/></a></div>
            <p class="caption "><b>Figure 10.2</b>    
            Querying Movie Records with Postman</p>
            <p class="standard">You can also make the same request using cURL<a class="indexanchor" id="i10_22"/> on the command line. <span class="crossreference "><a href="10_004.html#l10.6">Listing 10.6</a></span> shows the required command and the output.</p>
            <div class="listing " id="l10.6"><pre><span class="bold"><samp class="listingcharacter listingcharacter"><a id="p301"/>$ curl http://localhost:8080/movie</samp></span><br/>{<br/>  "movies": [<br/>    { "id": 1, "title": "Iron Man", "year": 2008, "user": 1, "public": 1 },<br/>    { "id": 2, "title": "Thor", "year": 2011, "user": 1, "public": 1 },<br/>    { "id": 3, "title": "Captain America", "year": 2011, "user": 1, "public": 1}<br/>  ],<br/>  "links": [{ "rel": "self", "href": "/movie/" }]<br/>} </pre></div>
            <p class="caption "><b>Listing 10.6</b>    
            Read Request via cURL (Formatted Output)</p>
        
        
            <h3 class="t3" id="h10.4.2">10.4.2    Accessing a Data Record<a class="indexanchor" id="i10_23"/></h3>
            <p class="standard">With a REST interface, it’s usually also possible to address individual data records. In this case, you append the ID of the relevant data record to the URL pointing to the resource. Currently, such a route doesn’t exist in your application, which is why the router in the <span class="italic">movie/index.js</span> file is the starting point for this customization (see <span class="crossreference "><a href="10_004.html#l10.7">Listing 10.7</a></span>).</p>
            <div class="listing " id="l10.7"><pre><span class="rot">import</span><span class="schwarz"> { Router } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'express'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> { listAction, </span><span class="bold"><samp class="listingcharacter listingcharacter">detailAction</samp></span> } <span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./controller.js'</span><span class="schwarz">;</span><br/> <br/><span class="rot">const</span><span class="schwarz"> router </span><span class="dunkelblau">=</span><span class="schwarz"> Router();</span><br/> <br/>router.get(<span class="hellblau">'/'</span><span class="schwarz">, listAction);</span><br/><span class="bold"><samp class="listingcharacter listingcharacter">router.get(<span class="hellblau">'/:id'</span><span class="schwarz">, detailAction);</span><br/> </samp></span><br/><span class="rot">export</span><span class="schwarz"> { router }; </span><span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 10.7</b>    
            Integrating a Route for Accessing a Single Data Record (movie/index.js)</p>
            <p class="standard">As you can see in <span class="crossreference "><a href="10_004.html#l10.7">Listing 10.7</a></span>, at this point, you add an additional route with a variable that receives the ID of the data record you want. The callback function behind the route originates from the controller and is called <samp class="listingcharacter listingcharacter">detailAction</samp>. The implementation is similar to the list view. <span class="crossreference "><a href="10_004.html#l10.8">Listing 10.8</a></span> shows the corresponding source code.</p>
            <div class="listing " id="l10.8"><pre><span class="rot">import</span><span class="schwarz"> { getAll, </span><span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">get</span></samp></span><span class="schwarz"> } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./model.js'</span><span class="schwarz">;</span><br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> listAction(request, response) {...}</span><br/> <br/><span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> detailAction(request, response) {</span><br/>  <span class="rot">const</span><span class="schwarz"> movie </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> get(request.params.id, 1);</span><br/>  <span class="rot">const</span><span class="schwarz"> moviesResponse </span><span class="dunkelblau">=</span><span class="schwarz"> {</span><br/>    ...movie,<br/>    links: [{ rel: <span class="hellblau">'self'</span><span class="schwarz">, href: </span><span class="violett">`${request.baseUrl}/${movie.id}`</span><span class="schwarz"> }],</span><br/><a id="p302"/>  };<br/>  response.json(moviesResponse);<br/>}</samp></span> <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 10.8</b>    
            Implementing “detailAction” in the Controller (movie/controller.js)</p>
            <p class="standard">With this customization, you can now also query individual data records directly. But you can also display them via cURL from the command line or with Postman via a GUI. <span class="crossreference "><a href="10_004.html#l10.9">Listing 10.9</a></span> contains the required cURL request.</p>
            <div class="listing " id="l10.9"><pre><span class="bold"><samp class="listingcharacter listingcharacter">$ curl http://localhost:8080/movie/1</samp></span><br/>{"id":1,"title":"Iron Man","year":2008,"user":1,"public":1,"links": [{"rel":"self","href":"/movie/1"}]} </pre></div>
            <p class="caption "><b>Listing 10.9</b>    
            Reading a Data Record with cURL</p>
            <p class="standard"><span class="crossreference "><a href="10_004.html#f10.3">Figure 10.3</a></span> shows the MovieDB collection extension in Postman that allows you to query a single data record.</p>
            <div class="imagebox figure-type"><a href="img-f10.3.html" id="f10.3"><img alt="Querying a Data Record with Postman" id="img-f10.3" src="bilderklein/klein10_003.png"/></a></div>
            <p class="caption "><b>Figure 10.3</b>    
            Querying a Data Record with Postman</p>
            <p class="standard">In the next step, you must now make sure that errors are handled correctly.</p>
        
        
            <h3 class="t3" id="h10.4.3">10.4.3    Error Handling<a class="indexanchor" id="i10_24"/></h3>
            <p class="standard">REST was originally developed for the purpose of machine-to-machine communication<a class="indexanchor" id="i10_25"/><a class="indexanchor" id="i10_26"/>. The communication between client and server can also be considered as a variant of this type of communication in the broadest sense because in a single-page application, the <a id="p303"/>raw data is further processed within the application before it’s finally displayed to the user. For this reason, it’s also very important to handle error cases correctly.</p>
            <p class="standard">Currently, the controller doesn’t handle error cases at all. This means that users aren’t really informed about problems occurring within the application. In our case, we can address two different errors. First, a general error<a class="indexanchor" id="i10_27"/> can occur at various points in the application, for example, within the database driver during a query. Second, there are also specific errors, for example, that the data record searched for but can’t be found in a single query. We can solve both problems with the adjustments to the controller from <span class="crossreference "><a href="10_004.html#l10.10">Listing 10.10</a></span>.</p>
            <div class="listing " id="l10.10"><pre><span class="rot">import</span><span class="schwarz"> { getAll, </span><span class="rot">get</span><span class="schwarz"> } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./model.js'</span><span class="schwarz">;</span><br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> listAction(request, response) {</span><br/>  <span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">try</span><span class="schwarz"> {</span></samp></span><br/>    <span class="rot">const</span><span class="schwarz"> movies </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> getAll(1);</span><br/>    <span class="rot">const</span><span class="schwarz"> moviesResponse </span><span class="dunkelblau">=</span><span class="schwarz"> {</span><br/>      movies,<br/>      links: [{ rel: <span class="hellblau">'self'</span><span class="schwarz">, href: request.baseUrl </span><span class="dunkelblau">+</span><span class="schwarz"> </span><span class="hellblau">'/'</span><span class="schwarz"> }],</span><br/>    };<br/>    response.json(moviesResponse);<br/>  <span class="bold"><samp class="listingcharacter listingcharacter">} <span class="rot">catch </span><span class="schwarz">(</span><span class="rot">e</span><span class="schwarz">) {</span><br/>    <span class="magenta">console</span><span class="schwarz">.error(e);</span><br/>    response.status(500).send(<span class="hellblau">'An error happened'</span><span class="schwarz">);</span><br/>  }</samp></span><br/>}<br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> detailAction(request, response) {</span><br/>  <span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">try</span><span class="schwarz"> {</span></samp></span><br/>    <span class="rot">const</span><span class="schwarz"> movie </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> get(request.params.id, 1);</span><br/>    <span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">if</span><span class="schwarz"> (</span><span class="dunkelblau">!</span><span class="schwarz">movie) {</span><br/>      response.status(404).send(<span class="hellblau">'Not Found'</span><span class="schwarz">);</span><br/>      <span class="rot">return</span><span class="schwarz">;</span><br/>    }<br/> </samp></span><br/>    <span class="rot">const</span><span class="schwarz"> moviesResponse </span><span class="dunkelblau">=</span><span class="schwarz"> {</span><br/>      ...movie,<br/>      links: [{ rel: <span class="hellblau">'self'</span><span class="schwarz">, href: </span><span class="violett">`${request.baseUrl}/${movie.id}`</span><span class="schwarz"> }],</span><br/>    };<br/>    response.json(moviesResponse);<br/>  <span class="bold"><samp class="listingcharacter listingcharacter">} <span class="rot">catch </span><span class="schwarz">(</span><span class="rot">e</span><span class="schwarz">) {</span><br/>    <span class="magenta">console</span><span class="schwarz">.error(e);</span><br/>    response.status(500).send(<span class="hellblau">'An error happened'</span><span class="schwarz">);</span><br/>  }</samp></span><br/>} <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 10.10</b>    
            Error Handling in the Controller (movie/controller.js)</p>
            <p class="standard"><a id="p304"/>If an exception is triggered while one or more data records are being read, the <samp class="listingcharacter listingcharacter">try-catch</samp> statement intercepts it, writes the error to the console, and sends a response to the client. The <samp class="listingcharacter listingcharacter">status</samp> method of the <samp class="listingcharacter listingcharacter">response</samp> object ensures that the correct status code<a class="indexanchor" id="i10_28"/>, in this case, <samp class="listingcharacter listingcharacter">500</samp>, is set to indicate an internal server error. As a response body, you can send the string <samp class="listingcharacter listingcharacter">An error happened</samp> to avoid giving a potential attacker many details about your system unnecessarily. The same applies if the required data record can’t be found. When querying a data record, you must check if the database return contains a value; if it doesn’t, you can send a response with the status code <samp class="listingcharacter listingcharacter">404</samp> and the text <samp class="listingcharacter listingcharacter">Not Found</samp>. Due to the respective status code, the remote system, for example, a web frontend, can respond to it and inform the user about the problem. In the next step, you provide the remote system with the option to modify the return via parameters.</p>
        
        
            <h3 class="t3" id="h10.4.4">10.4.4    Sorting the List<a class="indexanchor" id="i10_29"/></h3>
            <p class="standard">The tasks that are most common when implementing a REST interface include sorting, paging, and filtering the resource list. As an example, you’ll implement the option to retrieve the list also in a sorted format. For this purpose, you adjust both the controller and the model. The router can remain as it is because the information about the sorting is transmitted via query parameters<a class="indexanchor" id="i10_30"/> of the URL. In general, you should exercise caution when using query parameters, as their structure is completely up to the client. In this context, the links of the resource specified by REST are pretty useful. <span class="crossreference "><a href="10_004.html#l10.11">Listing 10.11</a></span> contains the customized source code of the controller.</p>
            <div class="listing " id="l10.11"><pre><span class="rot">import</span><span class="schwarz"> { getAll, </span><span class="rot">get</span><span class="schwarz"> } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./model.js'</span><span class="schwarz">;</span><br/> <br/><span class="rot">function</span><span class="schwarz"> getLinks(current, base) {</span><br/>  <span class="rot">const</span><span class="schwarz"> links </span><span class="dunkelblau">=</span><span class="schwarz"> [</span><br/>    { rel: <span class="hellblau">'base'</span><span class="schwarz">, href: base </span><span class="dunkelblau">+</span><span class="schwarz"> </span><span class="hellblau">'/'</span><span class="schwarz"> },</span><br/>    { rel: <span class="hellblau">'sort-ascending'</span><span class="schwarz">, href: base </span><span class="dunkelblau">+</span><span class="schwarz"> </span><span class="hellblau">'/?sort=asc'</span><span class="schwarz"> },</span><br/>    { rel: <span class="hellblau">'sort-descending'</span><span class="schwarz">, href: base </span><span class="dunkelblau">+</span><span class="schwarz"> </span><span class="hellblau">'/?sort=desc'</span><span class="schwarz"> },</span><br/>  ];<br/>  <span class="rot">return</span><span class="schwarz"> links.map((link) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>    <span class="rot">if</span><span class="schwarz"> (current.length </span><span class="dunkelblau">&gt;</span><span class="schwarz"> 0 </span><span class="dunkelblau">&amp;&amp;</span><span class="schwarz"> link.rel.includes(current)) {</span><br/>      link.rel <span class="dunkelblau">=</span><span class="schwarz"> </span><span class="hellblau">'self'</span><span class="schwarz">;</span><br/>    } <span class="rot">else</span><span class="schwarz"> </span><span class="rot">if</span><span class="schwarz"> (current.length </span><span class="dunkelblau">===</span><span class="schwarz"> 0 </span><span class="dunkelblau">&amp;&amp;</span><span class="schwarz"> link.rel </span><span class="dunkelblau">===</span><span class="schwarz"> </span><span class="hellblau">'base'</span><span class="schwarz">) {</span><br/>      link.rel <span class="dunkelblau">=</span><span class="schwarz"> </span><span class="hellblau">'self'</span><span class="schwarz">;</span><br/>    }<br/>    <span class="rot">return</span><span class="schwarz"> link;</span><br/>  });<br/>}<br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> listAction(request, response) {</span><br/>  <span class="rot">try</span><span class="schwarz"> {</span><br/>    <span class="rot">const</span><span class="schwarz"> options </span><span class="dunkelblau">=</span><span class="schwarz"> {</span><br/><a id="p305"/>      userId: 1,<br/>      sort: request.query.sort <span class="dunkelblau">?</span><span class="schwarz"> request.query.sort : </span><span class="hellblau">''</span><span class="schwarz">,</span><br/>    };<br/> <br/>    <span class="rot">const</span><span class="schwarz"> movies </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> getAll(options);</span><br/>    <span class="rot">const</span><span class="schwarz"> moviesResponse </span><span class="dunkelblau">=</span><span class="schwarz"> {</span><br/>      movies,<br/>      links: getLinks(options.sort, request.baseUrl),<br/>    };<br/>    response.json(moviesResponse);<br/>  } <span class="rot">catch </span><span class="schwarz">(</span><span class="rot">e</span><span class="schwarz">) {</span><br/>    <span class="magenta">console</span><span class="schwarz">.error(e);</span><br/>    response.status(500).send(<span class="hellblau">'An error happened'</span><span class="schwarz">);</span><br/>  }<br/>}<br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> detailAction(request, response) {...} </span><span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 10.11</b>    
            Extending the Controller with a List Sorting Feature (movie/controller.js)</p>
            <p class="standard">Depending on how you retrieve the movie resource, you need to adjust the links<a class="indexanchor" id="i10_31"/>. You swap out the process of generating the corresponding information to the <samp class="listingcharacter listingcharacter">getLinks</samp> function. This function receives the currently selected sort option and the <samp class="listingcharacter listingcharacter">baseUrl</samp> of the request. Based on this information, the three currently available links are generated, and the active status is marked with <samp class="listingcharacter listingcharacter">rel='self'</samp>. Then you pass the sort option to the model as well. For the purpose of better and simpler structuring, in this case, you should choose an option object as a container for configuring the query. This makes the model more flexible and also easier to adapt for future extensions. <span class="crossreference "><a href="10_004.html#l10.12">Listing 10.12</a></span> shows the changes to the code of the model.</p>
            <div class="listing " id="l10.12"><pre><span class="rot">import</span><span class="schwarz"> sqlite </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'sqlite3'</span><span class="schwarz">;</span><br/> <br/><span class="rot">const</span><span class="schwarz"> db </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">new sqlite</span><span class="schwarz">.Database(</span><span class="hellblau">'./movie.db'</span><span class="schwarz">);</span><br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> getAll(</span><span class="bold"><samp class="listingcharacter listingcharacter">options</samp></span>) {<br/>  <span class="rot">return</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">Promise((resolve, reject) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>    <span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">let</span></samp></span><span class="schwarz"> query </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="violett">`SELECT * FROM Movies WHERE user = ? OR public = 1`</span><span class="schwarz">;</span><br/> <br/>    <span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">if</span><span class="schwarz"> (options.sort </span><span class="dunkelblau">&amp;&amp;</span><span class="schwarz"> </span><br/>        [<span class="hellblau">'asc'</span><span class="schwarz">, </span><span class="hellblau">'desc'</span><span class="schwarz">].includes(options.sort.toLowerCase())) {</span><br/>      query <span class="dunkelblau">+=</span><span class="schwarz"> </span><span class="hellblau">' ORDER BY title '</span><span class="schwarz"> </span><span class="dunkelblau">+</span><span class="schwarz"> options.sort;</span><br/>    }<br/> </samp></span><br/>    db.all(query, [<span class="bold"><samp class="listingcharacter listingcharacter">options.userId</samp></span>], (error, results) <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>      <span class="rot">if</span><span class="schwarz"> (error) {</span><br/><a id="p306"/>        reject(error);<br/>      } <span class="rot">else</span><span class="schwarz"> {</span><br/>        resolve(results);<br/>      }<br/>    });<br/>  });<br/>}<br/> <br/>... <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 10.12</b>    
            Extending the Model with a Sorting Feature (movie/model.js)</p>
            <p class="standard">Inside the <samp class="listingcharacter listingcharacter">getAll</samp> function, you must check if a sort option was passed and if it has a valid value. If this is the case, the query is extended accordingly. Invalid values are ignored in this implementation. With the implementation of this feature, you’re now able to sort the movie list in ascending and descending order based on the title. For this purpose, you request the movie resource via the links <span class="italic">http://localhost:8080/movie?sort=asc</span> and <span class="italic">http://localhost:8080/movie?sort=desc</span>, respectively. <span class="crossreference "><a href="10_004.html#l10.13">Listing 10.13</a></span> shows an example of such a request with cURL, while <span class="crossreference "><a href="10_004.html#f10.4">Figure 10.4</a></span> contains a corresponding request in Postman.</p>
            <div class="imagebox figure-type"><a href="img-f10.4.html" id="f10.4"><img alt="Sorting the Movie List with Postman" id="img-f10.4" src="bilderklein/klein10_004.png"/></a></div>
            <p class="caption "><b>Figure 10.4</b>    
            Sorting the Movie List with Postman</p>
            <div class="listing " id="l10.13"><pre><span class="bold"><samp class="listingcharacter listingcharacter"><a id="p307"/>$ curl http://localhost:8080/movie?sort=desc</samp></span><br/>{"movies":[{"id":2,"title":"Thor","year":2011,"user":1,"public":1},{"id":1,"title":<br/>"Iron Man","year":2008,"user":1,"public":1},{"id":3,"title":"Captain America",<br/>"year":2011,"user":1,"public":1}],"links":[{"rel":"base","href":"/movie/"},{"rel":"sort-ascending","href":"/movie/?sort=asc"},{"rel":"self",<br/>"href":"/movie/?sort=desc"}]} </pre></div>
            <p class="caption "><b>Listing 10.13</b>    
            cURL Request for a Sorted List</p>
        
        
            <h3 class="t3" id="h10.4.5">10.4.5    Controlling the Output Format<a class="indexanchor" id="i10_32"/></h3>
            <p class="standard">JSON has become the standard format for exchanging information via web services in large parts of web development. Despite this fact, in some cases, it’s necessary to provide your users with the option to control the output format of the service. As a rule, <samp class="listingcharacter listingcharacter">accept header</samp><a class="indexanchor" id="i10_33"/> is used in this respect. It’s best to integrate such a switch for the output format directly in the controller. <span class="crossreference "><a href="10_004.html#l10.14">Listing 10.14</a></span> contains the source code for the switch. In the concrete case, the user can use <samp class="listingcharacter listingcharacter">accept header</samp> to control whether the output should be JSON<a class="indexanchor" id="i10_34"/>—the default case—or XML<a class="indexanchor" id="i10_35"/>.</p>
            <div class="listing " id="l10.14"><pre><span class="rot">import</span><span class="schwarz"> { getAll, </span><span class="rot">get</span><span class="schwarz"> } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./model.js'</span><span class="schwarz">;</span><br/><span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">import</span><span class="schwarz"> jsonXml </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'jsontoxml'</span><span class="schwarz">;</span><br/> </samp></span><br/><span class="rot">function</span><span class="schwarz"> getLinks(current, base) {...}</span><br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> listAction(request, response) {</span><br/>  <span class="rot">try</span><span class="schwarz"> {</span><br/>    <span class="rot">const</span><span class="schwarz"> options </span><span class="dunkelblau">=</span><span class="schwarz"> {</span><br/>      userId: 1,<br/>      sort: request.query.sort <span class="dunkelblau">?</span><span class="schwarz"> request.query.sort : </span><span class="hellblau">''</span><span class="schwarz">,</span><br/>    };<br/> <br/>    <span class="rot">const</span><span class="schwarz"> movies </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> getAll(options);</span><br/>    <span class="rot">const</span><span class="schwarz"> moviesResponse </span><span class="dunkelblau">=</span><span class="schwarz"> {</span><br/>      movies,<br/>      links: getLinks(options.sort, request.baseUrl),<br/>    };<br/> <br/>    <span class="bold"><samp class="listingcharacter listingcharacter">response.format({<br/>      xml() {<br/>        moviesResponse.movies <span class="dunkelblau">=</span><span class="schwarz"> moviesResponse.movies.map((movie) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> ({</span><br/>          movie,<br/>        }));<br/>        response.send(jsonXml(moviesResponse));<br/>      },<br/><a id="p308"/>      json() {<br/>        response.json(moviesResponse);<br/>      },<br/>      default() {<br/>        response.json(moviesResponse);<br/>      },<br/>    });</samp></span><br/>  } <span class="rot">catch </span><span class="schwarz">(</span><span class="rot">e</span><span class="schwarz">) {</span><br/>    <span class="magenta">console</span><span class="schwarz">.error(e);</span><br/>    response.status(500).send(<span class="hellblau">'An error happened'</span><span class="schwarz">);</span><br/>  }<br/>}<br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> detailAction(request, response) {...} </span><span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 10.14</b>    
            Controlling the Output Format in the Controller (movie/controller.js)</p>
            <p class="standard">To simplify the XML output, you should install the <samp class="listingcharacter listingcharacter">jsontoxml</samp><a class="indexanchor" id="i10_36"/> package via the <samp class="listingcharacter listingcharacter">npm install jsontoxml</samp> command. This package exports a function to which you can pass a JSON structure, and it will be converted to an XML document. To ensure that the structure displays correctly, you should insert an additional object layer, as shown in the example. To make a distinction based on the incoming <samp class="listingcharacter listingcharacter">accept</samp> header, you can use the <samp class="listingcharacter listingcharacter">format</samp> method of the <samp class="listingcharacter listingcharacter">response</samp> object. To this method, you pass an object with various functions. The key of the object denotes the format, for example, <samp class="listingcharacter listingcharacter">xml</samp> or <samp class="listingcharacter listingcharacter">json</samp>, and the function is responsible for the correct format of the response. For example, if you request the resource with cURL using the command <samp class="listingcharacter listingcharacter">curl -H "Accept: application/xml" http://localhost:8080/movie</samp>, you’ll receive the corresponding XML structure as a response. <span class="crossreference "><a href="10_004.html#l10.15">Listing 10.15</a></span> contains the server’s abbreviated response to this request.</p>
            <div class="listing " id="l10.15"><pre><span class="bold"><samp class="listingcharacter listingcharacter">$ curl -H "Accept: application/xml" http://localhost:8080/movie</samp></span><br/>&lt;movies&gt;<br/>  &lt;movie&gt;<br/>    &lt;id&gt;1&lt;/id&gt;<br/>    &lt;title&gt;Iron Man&lt;/title&gt;<br/>    &lt;year&gt;2008&lt;/year&gt;<br/>    &lt;user&gt;1&lt;/user&gt;<br/>    &lt;public&gt;1&lt;/public&gt;<br/>  &lt;/movie&gt; </pre></div>
            <p class="caption "><b>Listing 10.15</b>    
            cURL Request with XML Response</p>
            <p class="standard">Now that you’ve learned about some of the specifics of read requests, the following sections deal with write accesses to the REST interface.</p>
        
    </div><p class="signatur"/>
                    </body>
                </html>