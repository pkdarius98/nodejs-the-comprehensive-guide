<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
                    
        <head><meta content="application/xhtml+xml; charset=utf-8" http-equiv="Content-Type"/>
            <meta content="application/xhtml+xml; charset=utf-8" name="content-type"/>
            <meta content="Testing" name="title"/>
            <meta content="Sebastian Springer" name="author"/>
            <meta content="Rheinwerk Publishing" name="publisher"/>
            <meta content="© 2022 by Rheinwerk Publishing Inc., Boston (MA)" name="copyright"/>
            <meta content="Node.js - The Comprehensive Guide - Testing" name="description"/>
            <meta content="en" name="language"/>
            <title>Testing</title>
            <link href="common/main.css" rel="stylesheet" type="text/css"/>
<meta content="urn:uuid:e0000000-0000-0000-0000-000029756394" name="Adept.expected.resource"/>
        </head>
    


                    <body class="office_us type_kapitel">
                        <div id="main">
        <h2 class="t2" id="h23.5">23.5    Practical Example of Unit Tests with Jest</h2>
        <p class="standard">Unit tests are created at the function level, so you use them to secure the building blocks of your application. In practice, this means that you call a function with certain parameters and then compare the return value of that function with the value you expect to be returned. For the development of the function, this means it should have as few external dependencies<a class="indexanchor" id="i23_72"/> as possible. If dependencies are required, they should be passed to the function via the input values.</p>
        <p class="standard">When implementing your source code, you should make sure that the code is testable. This means inputs should be made as little as possible via global variables or object properties, but they should be passed explicitly to the function as input values. This makes it easier for you to prepare the environment in the arrange phase of the test.</p>
        <p class="standard">The same applies to the outputs of a function. The return of a function serves as an indicator as to whether the function has done its job properly. The best examples for this are mathematical functions. They accept one or more values and transform them into an output using a given algorithm. So, to improve the testability of your code, you should always use meaningful return values.</p>
        <p class="standard">Side effects<a class="indexanchor" id="i23_73"/> of a function can’t be avoided to a certain extent, especially if they are used as a method within an object context and modify the object itself. Examples of this case are setter methods that set a property of an object. In this context, testing becomes a bit more laborious, as you’re no longer allowed to look at just the input and output, but you have to check the object that was changed.</p>
        <div class="box box_standard">
            <h6 class="boxheading">Test-Driven Development (TDD)<a class="indexanchor" id="i23_74"/></h6>
            <p class="standard first">The best approach to writing a good test is to create it prior to the actual source code and align the implementation of the production source code with that test. The advantages of this approach are as follows:</p>
            <ul>
                <li>
                    <p class="standard first-item last-item">You must first deal with and understand the problem.</p>
                </li>
                <li>
                    <p class="standard first-item last-item">With TDD, you achieve a very high degree of test coverage.</p>
                </li>
                <li>
                    <p class="standard first-item last-item">By writing the test first, you develop only source code that’s required to meet your test criteria, thus focusing on the essentials.</p>
                </li>
            </ul>
        </div>
        <p class="standard"><a id="p675"/>A small example will illustrate the procedure for TDD.</p>
        
            <h3 class="t3" id="h23.5.1">23.5.1    The Test</h3>
            <p class="standard"><a class="indexanchor" id="i23_75"/>Suppose you have developed an application in which you need to handle products that are organized into different categories. Your application receives the product data in JavaScript Object Notation (JSON) format from a web service. Your task now is to extract the existing categories from the data structure of the products. The list of categories should be sorted in ascending order according to their position. For this example, you must first create a file named <span class="italic">product.js</span> that contains the source code, and another file named <span class="italic">product.test.js</span> that contains the unit tests.</p>
            <p class="standard">If you follow a test-driven approach, you must first create a test based on the preceding information. <span class="crossreference "><a href="23_005.html#l23.27">Listing 23.27</a></span> shows what such a test could look like.</p>
            <div class="listing " id="l23.27"><pre><span class="rot">import</span><span class="schwarz"> product </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./product.js'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="schwarz">describe(</span><span class="hellblau">'Product'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">()</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="schwarz">describe(</span><span class="hellblau">'getCategories'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">()</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="schwarz">it(</span><span class="hellblau">'should get categories from JSON'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">()</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>      <span class="rot">const</span><span class="schwarz"> input </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="schwarz">[</span><span class="schwarz"><br/></span>        <span class="schwarz">{</span><span class="schwarz"><br/></span>          id<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'800001'</span><span class="schwarz">,</span><span class="schwarz"><br/></span>          name<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'Papier A4'</span><span class="schwarz">,</span><span class="schwarz"><br/></span>          category<span class="schwarz">:</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> id</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="schwarz">1,</span><span class="schwarz"> name</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'Papier'</span><span class="schwarz">,</span><span class="schwarz"> position</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'3'</span><span class="schwarz"> </span><span class="schwarz">},</span><span class="schwarz"><br/></span>        <span class="schwarz">},</span><span class="schwarz"><br/></span>        <span class="schwarz">{</span><span class="schwarz"><br/></span>          id<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'90273'</span><span class="schwarz">,</span><span class="schwarz"><br/></span>          name<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'Ball pens'</span><span class="schwarz">,</span><span class="schwarz"><br/></span>          category<span class="schwarz">:</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> id</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="schwarz">3,</span><span class="schwarz"> name</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'Stationery'</span><span class="schwarz">,</span><span class="schwarz"> position</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'1'</span><span class="schwarz"> </span><span class="schwarz">},</span><span class="schwarz"><br/></span>        <span class="schwarz">},</span><span class="schwarz"><br/></span>      <span class="schwarz">];</span><span class="schwarz"><br/></span> <br/>      <span class="rot">const</span><span class="schwarz"> output </span><span class="dunkelblau">=</span><span class="schwarz"> product</span><span class="schwarz">.getCategories(</span><span class="schwarz">JSON</span><span class="schwarz">.stringify(</span><span class="schwarz">input</span><span class="schwarz">));</span><span class="schwarz"><br/></span> <br/>      <span class="schwarz">expect(</span><span class="schwarz">output</span><span class="schwarz">).toStrictEqual([</span><span class="hellblau">'Stationery'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="hellblau">'Paper'</span><span class="schwarz">]);</span><span class="schwarz"><br/></span>    <span class="schwarz">});</span><span class="schwarz"><br/></span>  <span class="schwarz">});</span><span class="schwarz"><br/></span><span class="schwarz">});</span><span class="schwarz"> </span></pre></div>
            <p class="caption "><b>Listing 23.27</b>    
            First Step in a TDD Test (product.test.js)</p>
            <p class="standard">When you run this test now, it fails as expected, because no source code exists yet that could be tested (see <span class="crossreference "><a href="23_005.html#l23.28">Listing 23.28</a></span>).<a class="indexanchor" id="i23_76"/></p>
            <div class="listing " id="l23.28"><pre><a id="p676"/>$ <span class="bold"><samp class="listingcharacter listingcharacter">npm test <br/></samp></span><br/>&gt; node-book@1.0.0 test<br/>&gt; jest<br/><br/>FAIL  ./product.test.js<br/>  <img alt="inline image" class="inline_image" src="bilder/punkt.png"/> Test suite failed to run<br/><br/>    SyntaxError: The requested module './product.js' does not provide an <img alt="inline image" class="inline_image" src="bilder/umbruchpfeil.png"/><br/>      export named 'default'<br/><br/>      at Runtime.linkAndEvaluateModule (node_modules/jest-runtime/build/ <img alt="inline image" class="inline_image" src="bilder/umbruchpfeil.png"/><br/>        index.js:704:5)<br/>      at TestScheduler.scheduleTests (node_modules/@jest/core/build/ <img alt="inline image" class="inline_image" src="bilder/umbruchpfeil.png"/><br/>        TestScheduler.js:333:13)<br/>      at runJest (node_modules/@jest/core/build/runJest.js:387:19)<br/>      at _run10000 (node_modules/@jest/core/build/cli/index.js:408:7)<br/>      at runCLI (node_modules/@jest/core/build/cli/index.js:261:3)<br/><br/>Test Suites: 1 failed, 1 total<br/>Tests:       0 total<br/>Snapshots:   0 total<br/>Time:        0.484 s<br/>Ran all test suites. </pre></div>
            <p class="caption "><b>Listing 23.28</b>    
            Failed Test</p>
        
        
            <h3 class="t3" id="h23.5.2">23.5.2    Implementation</h3>
            <p class="standard">Your goal now shouldn’t be to implement the logic that ensures the test passes successfully. Instead, you should just make sure that the test succeeds, which you can do by having the <samp class="listingcharacter listingcharacter">getCategories</samp> method return the requested array. This approach is also referred to as <span class="italic">fake it till you make it</span><a class="indexanchor" id="i23_77"/>, when you first return static values instead of calculated ones. With this approach, you take several steps at once. You should always make sure that your tests are successful, and you should do this in as small of steps as possible. How small you choose these steps is up to you and also depends to a certain extent on your experience. <span class="crossreference "><a href="23_005.html#l23.29">Listing 23.29</a></span> shows the implementation that will make your test run successfully.</p>
            <div class="listing " id="l23.29"><pre><span class="rot">export</span><span class="schwarz"> </span><span class="rot">default</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="schwarz">getCategories(</span><span class="schwarz">jsonData</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="rot">return</span><span class="schwarz"> </span><span class="schwarz">[</span><span class="hellblau">'stationery'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="hellblau">'paper'</span><span class="schwarz">];</span><span class="schwarz"><br/></span>  <span class="schwarz">},</span><span class="schwarz"><br/></span><span class="schwarz">};</span><span class="schwarz"> </span></pre></div>
            <p class="caption "><b>Listing 23.29</b>    
            Simple Implementation of “getCategories” (product.js)</p>
            <p class="standard"><a id="p677"/>If you always pass the same values to your <samp class="listingcharacter listingcharacter">getCategories</samp> method, your problem would have been solved with this implementation. If you run your test completely, you’ll get a success message like the one shown in <span class="crossreference "><a href="23_005.html#l23.30">Listing 23.30</a></span>.</p>
            <div class="listing " id="l23.30"><pre><span class="bold"><samp class="listingcharacter listingcharacter">$ npm test<br/> </samp></span><br/>&gt; node-book@1.0.0 test<br/>&gt; jest<br/> <br/> PASS  ./product.test.js<br/>  Product<br/>    getCategories<br/>      ✓ should get categories from JSON (2 ms)<br/> <br/>Test Suites: 1 passed, 1 total<br/>Tests:       1 passed, 1 total<br/>Snapshots:   0 total<br/>Time:        0.389 s, estimated 1 s<br/>Ran all test suites. </pre></div>
            <p class="caption "><b>Listing 23.30</b>    
            Successful Test Run</p>
        
        
            <h3 class="t3" id="h23.5.3">23.5.3    Triangulation<a class="indexanchor" id="i23_78"/>: Second Test</h3>
            <p class="standard">In a real-life scenario, you can’t assume that the web service will always deliver the same two products, so you need to write another test.</p>
            <p class="standard">The test in <span class="crossreference "><a href="23_005.html#l23.31">Listing 23.31</a></span> is similar to the first test except for the differences in the input data and output data. If you run the tests again, you’ll receive a message stating that although the first test passes without errors, the second one fails. Then you’ll get an error message informing you that the expected value doesn’t match the passed value. This approach is called <span class="italic">triangulation</span> because you approach your problem from two sides.</p>
            <div class="listing " id="l23.31"><pre><span class="rot">import</span><span class="schwarz"> product </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./product.js'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="schwarz">describe(</span><span class="hellblau">'Product'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">()</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="schwarz">describe(</span><span class="hellblau">'getCategories'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">()</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="schwarz">it(</span><span class="hellblau">'should get categories from JSON'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">()</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>      <span class="rot">const</span><span class="schwarz"> input </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="schwarz">[</span><span class="schwarz"><br/></span>        <span class="schwarz">{</span><span class="schwarz"><br/></span>          id<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'800001'</span><span class="schwarz">,</span><span class="schwarz"><br/></span>          name<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'Papier A4'</span><span class="schwarz">,</span><span class="schwarz"><br/></span>          category<span class="schwarz">:</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> id</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="schwarz">1,</span><span class="schwarz"> name</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'Papier'</span><span class="schwarz">,</span><span class="schwarz"> position</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'3'</span><span class="schwarz"> </span><span class="schwarz">},</span><span class="schwarz"><br/></span>        <span class="schwarz">},</span><span class="schwarz"><br/></span>        <span class="schwarz">{</span><span class="schwarz"><br/></span><a id="p678"/>          id<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'90273'</span><span class="schwarz">,</span><span class="schwarz"><br/></span>          name<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'Ball pens'</span><span class="schwarz">,</span><span class="schwarz"><br/></span>          category<span class="schwarz">:</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> id</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="schwarz">3,</span><span class="schwarz"> name</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'Stationery'</span><span class="schwarz">,</span><span class="schwarz"> position</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'1'</span><span class="schwarz"> </span><span class="schwarz">},</span><span class="schwarz"><br/></span>        <span class="schwarz">},</span><span class="schwarz"><br/></span>      <span class="schwarz">];</span><span class="schwarz"><br/></span> <br/>      <span class="rot">const</span><span class="schwarz"> output </span><span class="dunkelblau">=</span><span class="schwarz"> product</span><span class="schwarz">.getCategories(</span><span class="schwarz">JSON</span><span class="schwarz">.stringify(</span><span class="schwarz">input</span><span class="schwarz">));</span><span class="schwarz"><br/></span> <br/>      <span class="schwarz">expect(</span><span class="schwarz">output</span><span class="schwarz">).toStrictEqual([</span><span class="hellblau">'Stationery'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="hellblau">'Paper'</span><span class="schwarz">]);</span><span class="schwarz"><br/></span>    <span class="schwarz">});</span><span class="schwarz"><br/></span>  <span class="schwarz">});</span><span class="schwarz"><br/></span>  <span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter">it(<span class="hellblau">'should get other categories from JSON'</span><span class="schwarz">, () </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>    <span class="rot">const</span><span class="schwarz"> input </span><span class="dunkelblau">=</span><span class="schwarz"> [</span><br/>      {<br/>        id: <span class="hellblau">'600320'</span><span class="schwarz">,</span><br/>        name: <span class="hellblau">'Eraser'</span><span class="schwarz">,</span><br/>        category: { id: 1, name: <span class="hellblau">'Accessories'</span><span class="schwarz">, position: </span><span class="hellblau">'4'</span><span class="schwarz"> },</span><br/>      },<br/>      {<br/>        id: <span class="hellblau">'90273'</span><span class="schwarz">,</span><br/>        name: <span class="hellblau">'Ball pens'</span><span class="schwarz">,</span><br/>        category: { id: 3, name: <span class="hellblau">'Stationery'</span><span class="schwarz">, position: </span><span class="hellblau">'1'</span><span class="schwarz"> },</span><br/>      },<br/>    ];<br/> <br/>    <span class="rot">const</span><span class="schwarz"> output </span><span class="dunkelblau">=</span><span class="schwarz"> product.getCategories(JSON.stringify(input));</span><br/> <br/>    expect(output).toStrictEqual([<span class="hellblau">'stationery'</span><span class="schwarz">, </span><span class="hellblau">'accessories'</span><span class="schwarz">]);</span><br/>  });</samp></span><br/>}); <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 23.31</b>    
            TDD: A Second Test (product.test.js)</p>
        
        
            <h3 class="t3" id="h23.5.4">23.5.4    Optimizing the Implementation<a class="indexanchor" id="i23_79"/></h3>
            <p class="standard">The next step is to implement the logic which ensures that both tests pass successfully. <span class="crossreference "><a href="23_005.html#l23.32">Listing 23.32</a></span> contains a proposal for such an implementation.</p>
            <div class="listing " id="l23.32"><pre><span class="rot">export</span><span class="schwarz"> </span><span class="rot">default</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="schwarz">getCategories(</span><span class="schwarz">jsonData</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">const</span><span class="schwarz"> data </span><span class="dunkelblau">=</span><span class="schwarz"> JSON.parse(jsonData);</span><br/>    <span class="rot">const</span><span class="schwarz"> categories </span><span class="dunkelblau">=</span><span class="schwarz"> {};</span><br/>    data.forEach(<br/>      (product) <span class="dunkelblau">=&gt;</span><span class="schwarz"> (categories[product.category.id] </span><span class="dunkelblau">=</span><span class="schwarz"> product.category),</span><br/>    );<br/><a id="p679"/>    <span class="rot">return</span><span class="schwarz"> Object.values(categories)</span><br/>      .sort((a, b) <span class="dunkelblau">=&gt;</span><span class="schwarz"> parseInt(a.position, 10) </span><span class="dunkelblau">-</span><span class="schwarz"> parseInt(b.position, 10))</span><br/>      .map((category) <span class="dunkelblau">=&gt;</span><span class="schwarz"> category.name);</span></samp></span><br/>  },<br/>}; <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 23.32</b>    
            Implementation of the “getCategories” Method (product.js)</p>
            <p class="standard">In the implementation, you first convert the passed JSON string into a JavaScript object. After that, you create a <samp class="listingcharacter listingcharacter">categories</samp> object that will contain the categories. To populate this object with data, you iterate over the input data and insert the category object into the <samp class="listingcharacter listingcharacter">categories</samp> object. The <samp class="listingcharacter listingcharacter">id</samp> of the category is also the key in the object. This ensures the uniqueness of the objects and eliminates duplicates. Then you access the category objects, sort them by position, and extract the category names, which you finally return as an array.</p>
            <p class="standard">If you now run the <samp class="listingcharacter listingcharacter">npm test</samp> command, you’ll see on the console that two tests have been run successfully.</p>
            <p class="standard">In this context, it’s important that you run your existing tests very frequently to get quick feedback on the impact of your changes. Combined with very small implementation steps, where you should always aim for the simplest solution, TDD ensures very high-quality code. This code quality<a class="indexanchor" id="i23_80"/> is also reflected in a very low number of errors in the software in most cases.</p>
        
    </div><p class="signatur"/>
                    </body>
                </html>