<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
                    
        <head><meta content="application/xhtml+xml; charset=utf-8" http-equiv="Content-Type"/>
            <meta content="application/xhtml+xml; charset=utf-8" name="content-type"/>
            <meta content="Web Applications with Nest" name="title"/>
            <meta content="Sebastian Springer" name="author"/>
            <meta content="Rheinwerk Publishing" name="publisher"/>
            <meta content="© 2022 by Rheinwerk Publishing Inc., Boston (MA)" name="copyright"/>
            <meta content="Node.js - The Comprehensive Guide - Web Applications with Nest" name="description"/>
            <meta content="en" name="language"/>
            <title>Web Applications with Nest</title>
            <link href="common/main.css" rel="stylesheet" type="text/css"/>
<meta content="urn:uuid:e0000000-0000-0000-0000-000029756394" name="Adept.expected.resource"/>
        </head>
    


                    <body class="office_us type_kapitel">
                        <div id="main">
        <h2 class="t2" id="h14.7">14.7    Accessing Databases<a class="indexanchor" id="i14_87"/></h2>
        <p class="standard">To this point, you only store the information locally in your application, which means all changes will be lost when the process is restarted. This problem can be solved with databases, as you’ve already seen in <span class="crossreference "><a href="08_001.html#h8">Chapter 8</a></span>. Nest provides for a rather convenient solution here as well, in that the framework provides you with direct integration of TypeORM<a class="indexanchor" id="i14_88"/> into your application via the <samp class="listingcharacter listingcharacter">@nestjs/typeorm</samp> package.</p>
        
            <h3 class="t3" id="h14.7.1">14.7.1    Setup and Installation</h3>
            <p class="standard">First, you need a database instance for your application. TypeORM supports a whole range of databases such as MySQL<a class="indexanchor" id="i14_89"/>, PostgresSQL, and SQLite, but also MongoDB. For our example, we’ll use a MySQL database running in a Docker<a class="indexanchor" id="i14_90"/> container. <span class="crossreference "><a href="14_007.html#l14.16">Listing 14.16</a></span> shows the contents of the <span class="italic">initDB.sql</span> file, which you save in a new directory named <span class="italic">db</span> in your application and which enables you to define the initial database structure.</p>
            <div class="listing " id="l14.16"><pre><span class="dunkelblau">CREATE</span><span class="schwarz"> </span><span class="dunkelblau">DATABASE</span><span class="schwarz"> </span><span class="rot">`Movie`</span><span class="schwarz">;</span><br/><br/>USE <span class="rot">`Movie`</span><span class="schwarz">;</span><br/><br/><span class="dunkelblau"><a id="p433"/>CREATE</span><span class="schwarz"> </span><span class="dunkelblau">TABLE</span><span class="schwarz"> </span><span class="rot">`Movie`</span><span class="schwarz"> (</span><br/>  <span class="rot">`id`</span><span class="schwarz"> int(</span><span class="schwarz">11</span><span class="schwarz">) </span><span class="dunkelblau">NOT</span><span class="schwarz"> </span><span class="dunkelblau">NULL</span><span class="schwarz"> AUTO_INCREMENT,</span><br/>  <span class="rot">`title`</span><span class="schwarz"> </span><span class="dunkelblau">varchar</span><span class="schwarz">(</span><span class="schwarz">255</span><span class="schwarz">) </span><span class="dunkelblau">DEFAULT</span><span class="schwarz"> </span><span class="dunkelblau">NULL</span><span class="schwarz">,</span><br/>  <span class="rot">`year`</span><span class="schwarz"> int(</span><span class="schwarz">11</span><span class="schwarz">) </span><span class="dunkelblau">DEFAULT</span><span class="schwarz"> </span><span class="dunkelblau">NULL</span><span class="schwarz">,</span><br/>  <span class="dunkelblau">PRIMARY</span><span class="schwarz"> </span><span class="dunkelblau">KEY</span><span class="schwarz"> (</span><span class="rot">`id`</span><span class="schwarz">)</span><br/>) ENGINE=InnoDB <span class="dunkelblau">DEFAULT</span><span class="schwarz"> CHARSET=utf8;</span><br/><br/><span class="dunkelblau">INSERT</span><span class="schwarz"> </span><span class="dunkelblau">INTO</span><span class="schwarz"> </span><span class="rot">`Movie`</span><span class="schwarz"> (</span><span class="rot">`title`</span><span class="schwarz">, </span><span class="rot">`year`</span><span class="schwarz">) VALUES</span><br/>(<span class="rot">'Iron Man'</span><span class="schwarz">, </span><span class="schwarz">2008</span><span class="schwarz">),</span><br/>(<span class="rot">'Thor'</span><span class="schwarz">, </span><span class="schwarz">2011</span><span class="schwarz">),</span><br/>(<span class="rot">'Captain America'</span><span class="schwarz">, </span><span class="schwarz">2011</span><span class="schwarz">);</span><br/><br/><span class="dunkelblau">CREATE</span><span class="schwarz"> </span><span class="dunkelblau">TABLE</span><span class="schwarz"> </span><span class="rot">`User`</span><span class="schwarz"> (</span><br/>  <span class="rot">`id`</span><span class="schwarz"> int(</span><span class="schwarz">11</span><span class="schwarz">) </span><span class="dunkelblau">NOT</span><span class="schwarz"> </span><span class="dunkelblau">NULL</span><span class="schwarz"> AUTO_INCREMENT,</span><br/>  <span class="rot">`username`</span><span class="schwarz"> </span><span class="dunkelblau">varchar</span><span class="schwarz">(</span><span class="schwarz">255</span><span class="schwarz">) </span><span class="dunkelblau">DEFAULT</span><span class="schwarz"> </span><span class="dunkelblau">NULL</span><span class="schwarz">,</span><br/>  <span class="rot">`password`</span><span class="schwarz"> </span><span class="dunkelblau">varchar</span><span class="schwarz">(</span><span class="schwarz">255</span><span class="schwarz">) </span><span class="dunkelblau">DEFAULT</span><span class="schwarz"> </span><span class="dunkelblau">NULL</span><span class="schwarz">,</span><br/>  <span class="dunkelblau">PRIMARY</span><span class="schwarz"> </span><span class="dunkelblau">KEY</span><span class="schwarz"> (</span><span class="rot">`id`</span><span class="schwarz">)</span><br/>) ENGINE=InnoDB <span class="dunkelblau">DEFAULT</span><span class="schwarz"> CHARSET=utf8;</span><br/><br/><span class="dunkelblau">INSERT</span><span class="schwarz"> </span><span class="dunkelblau">INTO</span><span class="schwarz"> </span><span class="rot">`User`</span><span class="schwarz"> (</span><span class="rot">`username`</span><span class="schwarz">, </span><span class="rot">`password`</span><span class="schwarz">) VALUES</span><br/>(<span class="rot">'sspringer'</span><span class="schwarz">, </span><span class="rot">'test'</span><span class="schwarz">); </span></pre></div>
            <p class="caption "><b>Listing 14.16</b>    
            Initial Database Structure (initDB.sql)</p>
            <p class="standard">With this SQL script, you create the two tables <samp class="listingcharacter listingcharacter">Movie</samp> and <samp class="listingcharacter listingcharacter">User</samp>, which you initially fill with data records. In the next step, you’ll start the database container using the command from <span class="crossreference "><a href="14_007.html#l14.17">Listing 14.17</a></span>.</p>
            <div class="listing " id="l14.17"><pre>docker run <br/>  --name mysql <br/>  -v /srv/node/movie-db/db:/docker-entrypoint-initdb.d <br/>  -e MYSQL_ROOT_PASSWORD=topSecret <br/>  -e MYSQL_ROOT_HOST=% <br/>  -e MYSQL_DATABASE=Movie<br/>  -p 3306:3306 <br/>  -d<br/>  mysql:latest </pre></div>
            <p class="caption "><b>Listing 14.17</b>    
            Command to Start the Database Container</p>
            <p class="standard">The command assumes that your application is located in the <span class="italic">/srv/node/movie-db</span> directory to mount the directory with the initialization script as a volume on the container. If the MySQL container<a class="indexanchor" id="i14_91"/> finds a file with the <span class="italic">.sql</span> extension in the <span class="italic">docker-entrypoint-initd.d</span> directory, it runs this script to initialize the database.</p>
            <p class="standard"><a id="p434"/>With this setup, you can now use the <samp class="listingcharacter listingcharacter">npm install @nestjs/typeorm typeorm mysql2</samp> command to install the required dependencies. After that, you can connect your application to the database. You can achieve this by configuring the TypeORM module<a class="indexanchor" id="i14_92"/>. You import the module at a central location, that is, preferably within the app module, and pass it an appropriate configuration<a class="indexanchor" id="i14_93"/>. <span class="crossreference "><a href="14_007.html#l14.18">Listing 14.18</a></span> shows the corresponding configuration.</p>
            <div class="listing " id="l14.18"><pre><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> Module </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'@nestjs/common'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">import</span><span class="schwarz"> { TypeOrmModule } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'@nestjs/typeorm'</span><span class="schwarz">;</span></samp></span><br/><span class="rot">import</span><span class="schwarz"> { AppController } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./app.controller'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> { AppService } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./app.service'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> { MovieModule } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./movie/movie.module'</span><span class="schwarz">;</span><br/> <br/>@Module({<br/>  imports: [<br/>    MovieModule,<br/>    <span class="bold"><samp class="listingcharacter listingcharacter">TypeOrmModule.forRoot({<br/>      type: <span class="hellblau">'mysql'</span><span class="schwarz">,</span><br/>      host: <span class="hellblau">'localhost'</span><span class="schwarz">,</span><br/>      port: 3306,<br/>      username: <span class="hellblau">'root'</span><span class="schwarz">,</span><br/>      password: <span class="hellblau">'topSecret'</span><span class="schwarz">,</span><br/>      database: <span class="hellblau">'Movie'</span><span class="schwarz">,</span><br/>      entities: [],<br/>      synchronize: <span class="rot">false</span><span class="schwarz">,</span><br/>    }),</samp></span><br/>  ],<br/>  controllers: [AppController],<br/>  providers: [AppService],<br/>})<br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">class AppModule</span><span class="schwarz"> {} </span><span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 14.18</b>    
            Configuration of the TypeORM Module (src/app.module.ts)</p>
            <p class="standard">In the app module, you use the <samp class="listingcharacter listingcharacter">forRoot</samp> method of the <samp class="listingcharacter listingcharacter">TypeORM</samp> module and pass a configuration object with the database credentials to this method.</p>
            <div class="box box_standard">
                <h6 class="boxheading">Warning!</h6>
                <p class="standard first last">For production operation, you should by no means store the credentials directly in the source code, but rather swap them out to an environment configuration that isn’t versioned with the source code. Here, environment variables<a class="indexanchor" id="i14_94"/> come in handy, which you can include via <samp class="listingcharacter listingcharacter">process.env</samp>, or you can use Nest’s config module<a class="indexanchor" id="i14_95"/> for this purpose.</p>
            </div>
            <p class="standard">With this basic setup, you can move on to modeling the entities for the database in the next step.</p>
        
        
            <h3 class="t3" id="h14.7.2">14.7.2    <a id="p435"/>Accessing the Database<a class="indexanchor" id="i14_96"/></h3>
            <p class="standard">TypeORM uses the repository pattern<a class="indexanchor" id="i14_97"/> and entity classes. The entities map the structure of the individual tables and represent the individual data records. You can use the respective database tables via the repositories. Both simple read and write operations are possible as well as more complex queries that map 1:n and n:m relations<a class="indexanchor" id="i14_98"/><a class="indexanchor" id="i14_99"/>, for example.</p>
            <p class="standard">In the first step, our goal is to map the functionality of the movie service via TypeORM. For this purpose, you must first define a movie entity<a class="indexanchor" id="i14_100"/>. The basis for this is a TypeScript class, which you can create via the <samp class="listingcharacter listingcharacter">nest generate class movie.entity movie</samp> command. Then, in this class, you model the structure of the <samp class="listingcharacter listingcharacter">movie</samp> table, as shown in <span class="crossreference "><a href="14_007.html#l14.19">Listing 14.19</a></span>.</p>
            <div class="listing " id="l14.19"><pre><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> Column</span><span class="schwarz">,</span><span class="schwarz"> Entity</span><span class="schwarz">,</span><span class="schwarz"> PrimaryGeneratedColumn </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'typeorm'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/>@<span class="schwarz">Entity(</span><span class="hellblau">'Movie'</span><span class="schwarz">)</span><span class="schwarz"><br/></span><span class="rot">export</span><span class="schwarz"> </span><span class="rot">class Movie</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  @<span class="schwarz">PrimaryGeneratedColumn()</span><span class="schwarz"><br/></span>  id number<span class="schwarz">;</span><span class="schwarz"><br/></span> <br/>  @<span class="schwarz">Column()</span><span class="schwarz"><br/></span>  title<span class="schwarz">:</span><span class="schwarz"> string</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/>  @<span class="schwarz">Column()</span><span class="schwarz"><br/></span>  year<span class="schwarz">:</span><span class="schwarz"> number</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"> </span></pre></div>
            <p class="caption "><b>Listing 14.19</b>    
            Movie Entity (src/movie/movie.entity.ts)</p>
            <p class="standard">TypeORM assumes that the table name is like the entity class, but with a lowercase letter at the beginning. In our case, however, the table name starts with a capital letter. If, in your application, the names of the entity class<a class="indexanchor" id="i14_101"/> and of the database table are different, you can pass the name of the table in the call of the <samp class="listingcharacter listingcharacter">entity</samp> decorator, as you can also see in the code example. The next step is to make this entity known in both the app and movie modules. For this purpose, you add a reference to the movie entity in the <samp class="listingcharacter listingcharacter">entity</samp> array of the app module, as shown in <span class="crossreference "><a href="14_007.html#l14.20">Listing 14.20</a></span>.</p>
            <div class="listing " id="l14.20"><pre><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">import</span><span class="schwarz"> { Movie } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./movie/movie.entity'</span><span class="schwarz">;</span></samp></span><br/>...<br/>@Module({<br/>  imports: [<br/>    MovieModule,<br/>    TypeOrmModule.forRoot({<br/>      ...<br/>      entities: [<span class="bold"><samp class="listingcharacter listingcharacter">Movie</samp></span>],<br/>      synchronize: <span class="rot">false</span><span class="schwarz">,</span><br/><a id="p436"/>    }),<br/>  ],<br/>  controllers: [AppController],<br/>  providers: [AppService],<br/>})<br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">class AppModule</span><span class="schwarz"> {} </span><span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 14.20</b>    
            Registering the Movie Entity in the App Module (src/app.module.ts)</p>
            <p class="standard">You must also perform the registration in the movie module. Here you use the <samp class="listingcharacter listingcharacter">forFeature</samp><a class="indexanchor" id="i14_102"/> method of the TypeORM module, but not its <samp class="listingcharacter listingcharacter">forRoot</samp><a class="indexanchor" id="i14_103"/> (see <span class="crossreference "><a href="14_007.html#l14.21">Listing 14.21</a></span>).</p>
            <div class="listing " id="l14.21"><pre><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> Module </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'@nestjs/common'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">import</span><span class="schwarz"> { TypeOrmModule } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'@nestjs/typeorm'</span><span class="schwarz">;</span></samp></span><br/><span class="rot">import</span><span class="schwarz"> { MovieController } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./movie.controller'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> { Movie } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./movie.entity'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> { MovieService } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./movie.service'</span><span class="schwarz">;</span><br/> <br/>@Module({<br/>  imports: [<span class="bold"><samp class="listingcharacter listingcharacter">TypeOrmModule.forFeature([Movie])</samp></span>],<br/>  controllers: [MovieController],<br/>  providers: [MovieService],<br/>  exports: [],<br/>})<br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">class MovieModule</span><span class="schwarz"> {} </span><span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 14.21</b>    
            Registering the Movie Entity in the Movie Module (src/movie/movie.module.ts)</p>
            <p class="standard">Once you’ve included the module and registered the entity, you can use TypeORM in your service. To access it, you use the <samp class="listingcharacter listingcharacter">repository</samp> provider of TypeORM and let it know that you want to use the movie entity, as shown in <span class="crossreference "><a href="14_007.html#l14.22">Listing 14.22</a></span>. The whole thing then runs again via dependency injection<a class="indexanchor" id="i14_104"/>, but this time in the service and not in the controller.</p>
            <div class="listing " id="l14.22"><pre><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> Injectable </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'@nestjs/common'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> InjectRepository </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'@nestjs/typeorm'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> DeleteResult</span><span class="schwarz">,</span><span class="schwarz"> Repository </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'typeorm'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> Movie </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./movie.entity'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> InputMovie </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./movie.interface'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/>@<span class="schwarz">Injectable()</span><span class="schwarz"><br/></span><span class="rot">export</span><span class="schwarz"> </span><span class="rot">class MovieService</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="schwarz">constructor(</span><span class="schwarz"><br/></span>    @<span class="schwarz">InjectRepository(</span><span class="schwarz">Movie</span><span class="schwarz">)</span><span class="schwarz"><br/></span>    <span class="rot">private</span><span class="schwarz"> movieRepository</span><span class="schwarz">:</span><span class="schwarz"> Repository</span><span class="dunkelblau">&lt;</span><span class="schwarz">Movie</span><span class="dunkelblau">&gt;</span><span class="schwarz">,</span><span class="schwarz"><br/></span>  <span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{}</span><span class="schwarz"><br/></span><a id="p437"/> <br/>  <span class="schwarz">getAllMovies():</span><span class="schwarz"> Promise</span><span class="dunkelblau">&lt;</span><span class="schwarz">Movie</span><span class="schwarz">[]</span><span class="dunkelblau">&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="rot">return</span><span class="schwarz"> </span><span class="rot">this</span><span class="schwarz">.</span><span class="schwarz">movieRepository</span><span class="schwarz">.find();</span><span class="schwarz"><br/></span>  <span class="schwarz">}</span><span class="schwarz"><br/></span> <br/>  <span class="schwarz">getOneMovie(</span><span class="schwarz">id</span><span class="schwarz">:</span><span class="schwarz"> number</span><span class="schwarz">):</span><span class="schwarz"> Promise</span><span class="dunkelblau">&lt;</span><span class="schwarz">Movie</span><span class="dunkelblau">&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="rot">return</span><span class="schwarz"> </span><span class="rot">this</span><span class="schwarz">.</span><span class="schwarz">movieRepository</span><span class="schwarz">.findOne(</span><span class="schwarz">id</span><span class="schwarz">);</span><span class="schwarz"><br/></span>  <span class="schwarz">}</span><span class="schwarz"><br/></span> <br/>  <span class="schwarz">createNewMovie(</span><span class="schwarz">movie</span><span class="schwarz">:</span><span class="schwarz"> InputMovie</span><span class="schwarz">):</span><span class="schwarz"> Promise</span><span class="dunkelblau">&lt;</span><span class="schwarz">Movie</span><span class="dunkelblau">&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="rot">return</span><span class="schwarz"> </span><span class="rot">this</span><span class="schwarz">.</span><span class="schwarz">movieRepository</span><span class="schwarz">.save(</span><span class="schwarz">movie</span><span class="schwarz">);</span><span class="schwarz"><br/></span>  <span class="schwarz">}</span><span class="schwarz"><br/></span> <br/>  <span class="schwarz">udpateMovie(</span><span class="schwarz">id</span><span class="schwarz">:</span><span class="schwarz"> number</span><span class="schwarz">,</span><span class="schwarz"> movie</span><span class="schwarz">:</span><span class="schwarz"> Movie</span><span class="schwarz">):</span><span class="schwarz"> Promise</span><span class="dunkelblau">&lt;</span><span class="schwarz">Movie</span><span class="dunkelblau">&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="rot">return</span><span class="schwarz"> </span><span class="rot">this</span><span class="schwarz">.</span><span class="schwarz">movieRepository</span><span class="schwarz">.save(</span><span class="schwarz">movie</span><span class="schwarz">);</span><span class="schwarz"><br/></span>  <span class="schwarz">}</span><span class="schwarz"><br/></span> <br/>  <span class="schwarz">removeMovie(</span><span class="schwarz">id</span><span class="schwarz">:</span><span class="schwarz"> number</span><span class="schwarz">):</span><span class="schwarz"> Promise</span><span class="dunkelblau">&lt;</span><span class="schwarz">DeleteResult</span><span class="dunkelblau">&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="rot">return</span><span class="schwarz"> </span><span class="rot">this</span><span class="schwarz">.</span><span class="schwarz">movieRepository</span><span class="schwarz">.delete(</span><span class="schwarz">id</span><span class="schwarz">);</span><span class="schwarz"><br/></span>  <span class="schwarz">}</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"> </span></pre></div>
            <p class="caption "><b>Listing 14.22</b>    
            Linking the Movie Service to the Database (src/movie/movie.service.ts)</p>
            <p class="standard">The service changes fundamentally through the integration of TypeORM. The only places that remain the same are the class definition and the method names. In the newly created constructor, you use the <samp class="listingcharacter listingcharacter">InjectRepository</samp> decorator<a class="indexanchor" id="i14_105"/> in conjunction with the generic repository provider to make the movie repository available in the service via the private <samp class="listingcharacter listingcharacter">movieRepository</samp> property. The actual work here is done by Nest’s dependency injection, as mentioned earlier. Within the service, you can now access the repository. During the data reading process, you use the <samp class="listingcharacter listingcharacter">find</samp><a class="indexanchor" id="i14_106"/> and <samp class="listingcharacter listingcharacter">findOne</samp><a class="indexanchor" id="i14_107"/> methods of the repository, which return an array of movie objects and a single object, respectively. For saving and updating, you use the <samp class="listingcharacter listingcharacter">save</samp><a class="indexanchor" id="i14_108"/> method, to which you pass the movie object to save, whereas for deleting you use the <samp class="listingcharacter listingcharacter">delete</samp><a class="indexanchor" id="i14_109"/> method of the repository. All methods use promises as return values, so you also have to adapt the signatures of your service methods accordingly, which results in a change to the controller in the next step because it now also has to work with promises. Fortunately, Nest supports not only simple objects as return values of controller methods but also promises, so all you need to do in the controller is customize the return types, as shown in <span class="crossreference "><a href="14_007.html#l14.23">Listing 14.23</a></span>.</p>
            <div class="listing " id="l14.23"><pre><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  Body<span class="schwarz">,</span><span class="schwarz"><br/></span>  Controller<span class="schwarz">,</span><span class="schwarz"><br/></span>  Delete<span class="schwarz">,</span><span class="schwarz"><br/></span><a id="p438"/>  Get<span class="schwarz">,</span><span class="schwarz"><br/></span>  HttpCode<span class="schwarz">,</span><span class="schwarz"><br/></span>  Param<span class="schwarz">,</span><span class="schwarz"><br/></span>  Post<span class="schwarz">,</span><span class="schwarz"><br/></span>  Put<span class="schwarz">,</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'@nestjs/common'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">import</span><span class="schwarz"> { Movie } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./movie.entity'</span><span class="schwarz">;</span></samp></span><br/><span class="rot">import</span><span class="schwarz"> { InputMovie } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./movie.interface'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> { MovieService } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./movie.service'</span><span class="schwarz">;</span><br/> <br/>@Controller(<span class="hellblau">'movie'</span><span class="schwarz">)</span><br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">class MovieController</span><span class="schwarz"> {</span><br/>  constructor(<span class="rot">private</span><span class="schwarz"> readonly movieService: MovieService) {}</span><br/> <br/>  @Get()<br/>  getAllMovies(): <span class="bold"><samp class="listingcharacter listingcharacter">Promise<span class="dunkelblau">&lt;</span><span class="schwarz">Movie[]</span><span class="dunkelblau">&gt;</span></samp></span><span class="schwarz"> {</span><br/>    <span class="rot">return</span><span class="schwarz"> </span><span class="rot">this</span><span class="schwarz">.movieService.getAllMovies();</span><br/>  }<br/> <br/>  @Get(<span class="hellblau">':id'</span><span class="schwarz">)</span><br/>  getOneMovie(@Param(<span class="hellblau">'id'</span><span class="schwarz">) id: string): </span><span class="bold"><samp class="listingcharacter listingcharacter">Promise<span class="dunkelblau">&lt;</span><span class="schwarz">Movie</span><span class="dunkelblau">&gt;</span></samp></span><span class="schwarz"> {</span><br/>    <span class="rot">return</span><span class="schwarz"> </span><span class="rot">this</span><span class="schwarz">.movieService.getOneMovie(parseInt(id, 10));</span><br/>  }<br/> <br/>  @Post()<br/>  createNewMovie(@Body() movie: InputMovie): <span class="bold"><samp class="listingcharacter listingcharacter">Promise<span class="dunkelblau">&lt;</span><span class="schwarz">Movie</span><span class="dunkelblau">&gt;</span></samp></span><span class="schwarz"> {</span><br/>    <span class="rot">return</span><span class="schwarz"> </span><span class="rot">this</span><span class="schwarz">.movieService.createNewMovie(movie);</span><br/>  }<br/> <br/>  @Put(<span class="hellblau">':id'</span><span class="schwarz">)</span><br/>  udpateMovie(@Param(<span class="hellblau">'id'</span><span class="schwarz">) id: string, @Body() movie: Movie): </span><span class="bold"><samp class="listingcharacter listingcharacter">Promise<span class="dunkelblau">&lt;</span><span class="schwarz">Movie</span><span class="dunkelblau">&gt;</span></samp></span><span class="schwarz"> {</span><br/>    <span class="rot">return</span><span class="schwarz"> </span><span class="rot">this</span><span class="schwarz">.movieService.udpateMovie(parseInt(id, 10), movie);</span><br/>  }<br/> <br/>  @Delete(<span class="hellblau">':id'</span><span class="schwarz">)</span><br/>  @HttpCode(204)<br/>  removeMovie(@Param(<span class="hellblau">'id'</span><span class="schwarz">) id: string): </span><span class="rot">void</span><span class="schwarz"> {</span><br/>    <span class="rot">this</span><span class="schwarz">.movieService.removeMovie(parseInt(id, 10));</span><br/>  }<br/>} <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 14.23</b>    
            Type Adjustments in the Movie Controller (src/movie/movie.controller.ts)</p>
            <p class="standard"><a id="p439"/>With these customizations, you can now manage your data records, and the changes are recorded in the database, so they’ll survive a restart of your application.</p>
        
    </div><p class="signatur"/>
                    </body>
                </html>