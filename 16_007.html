<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
                    
        <head><meta content="application/xhtml+xml; charset=utf-8" http-equiv="Content-Type"/>
            <meta content="application/xhtml+xml; charset=utf-8" name="content-type"/>
            <meta content="Asynchronous Programming" name="title"/>
            <meta content="Sebastian Springer" name="author"/>
            <meta content="Rheinwerk Publishing" name="publisher"/>
            <meta content="© 2022 by Rheinwerk Publishing Inc., Boston (MA)" name="copyright"/>
            <meta content="Node.js - The Comprehensive Guide - Asynchronous Programming" name="description"/>
            <meta content="en" name="language"/>
            <title>Asynchronous Programming</title>
            <link href="common/main.css" rel="stylesheet" type="text/css"/>
<meta content="urn:uuid:e0000000-0000-0000-0000-000029756394" name="Adept.expected.resource"/>
        </head>
    


                    <body class="office_us type_kapitel">
                        <div id="main">
        <h2 class="t2" id="h16.7">16.7    Async Functions<a class="indexanchor" id="i16_128"/></h2>
        <p class="standard">Promises are very good for structuring interdependent asynchronous operations in a readable way and avoiding nested callback functions, called “callback hell<a class="indexanchor" id="i16_129"/>.” However, callback functions aren’t redundant compared to the previous callback-based approach. And this is where another language feature of JavaScript comes into play: async functions. Based on the concept of promises, you can write asynchronous source code without callback functions using the <samp class="listingcharacter listingcharacter">async</samp> and <samp class="listingcharacter listingcharacter">await</samp> keywords.</p>
        <p class="standard">The <samp class="listingcharacter listingcharacter">await</samp> keyword lets you wait for the result of an asynchronous operation, as it were, and lets you assign the result of a successfully resolved promise to a variable. To use <samp class="listingcharacter listingcharacter"><a id="p515"/>await</samp><a class="indexanchor" id="i16_130"/>, you must be in a function marked <samp class="listingcharacter listingcharacter">async</samp><a class="indexanchor" id="i16_131"/>. In <span class="crossreference "><a href="16_007.html#l16.26">Listing 16.26</a></span>, this task is carried out by the <samp class="listingcharacter listingcharacter">handleAsyncOperations</samp> function.</p>
        <div class="listing " id="l16.26"><pre><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">asyncOperation(</span><span class="schwarz">resolve</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="magenta">value</span><span class="schwarz">,</span><span class="schwarz"> time</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="rot">return</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">Promise((</span><span class="schwarz">res</span><span class="schwarz">,</span><span class="schwarz"> rej</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="schwarz">setTimeout(()</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>      <span class="rot">if</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">resolve</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>        <span class="schwarz">res(</span><span class="magenta">value</span><span class="schwarz">);</span><span class="schwarz"><br/></span>      <span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">else</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>        <span class="schwarz">rej(</span><span class="magenta">value</span><span class="schwarz">);</span><span class="schwarz"><br/></span>      <span class="schwarz">}</span><span class="schwarz"><br/></span>    <span class="schwarz">},</span><span class="schwarz"> time</span><span class="schwarz">);</span><span class="schwarz"><br/></span>  <span class="schwarz">});</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"><br/></span> <br/><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> handleAsyncOperations() {</span><br/>  <span class="rot">const</span><span class="schwarz"> hello </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> asyncOperation(</span><span class="rot">true</span><span class="schwarz">, </span><span class="hellblau">'Hello'</span><span class="schwarz">, 100);</span><br/>  <span class="rot">const</span><span class="schwarz"> world </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> asyncOperation(</span><span class="rot">true</span><span class="schwarz">, </span><span class="hellblau">'World'</span><span class="schwarz">, 100);</span><br/>  <span class="rot">try</span><span class="schwarz"> {</span><br/>    <span class="rot">await</span><span class="schwarz"> asyncOperation(</span><span class="rot">false</span><span class="schwarz">, </span><span class="hellblau">'!'</span><span class="schwarz">, 100);</span><br/>  } <span class="rot">catch </span><span class="schwarz">(</span><span class="rot">err</span><span class="schwarz">) {</span><br/>    <span class="magenta">console</span><span class="schwarz">.error(</span><span class="violett">`Caught Error: ${err}`</span><span class="schwarz">);</span><span class="gruen"> // Output: Caught Error: !</span><span class="schwarz"><br/></span>  }<br/>  <span class="magenta">console</span><span class="schwarz">.log(</span><span class="violett">`${hello} ${world}`</span><span class="schwarz">);       </span><span class="gruen"> // Output: Hello World</span><span class="schwarz"><br/></span>}<br/> <br/>handleAsyncOperations();</samp></span> <span class="schwarz"/></pre></div>
        <p class="caption "><b>Listing 16.26</b>    
            Async Functions in Node.js</p>
        <p class="standard">You can mark all functions, methods, and arrow functions as <samp class="listingcharacter listingcharacter">async</samp>, but then you have to keep in mind that they don’t have a regular return value anymore. Instead, they return a promise object that encapsulates the return value—and it doesn’t matter if you use promises and the <samp class="listingcharacter listingcharacter">await</samp> keyword. The source code in <span class="crossreference "><a href="16_007.html#l16.27">Listing 16.27</a></span> shows the result.</p>
        <div class="listing " id="l16.27"><pre><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">asyncOperation(</span><span class="schwarz">resolve</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="magenta">value</span><span class="schwarz">,</span><span class="schwarz"> time</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="rot">return</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">Promise((</span><span class="schwarz">res</span><span class="schwarz">,</span><span class="schwarz"> rej</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="schwarz">setTimeout(()</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>      <span class="rot">if</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">resolve</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>        <span class="schwarz">res(</span><span class="magenta">value</span><span class="schwarz">);</span><span class="schwarz"><br/></span>      <span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">else</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>        <span class="schwarz">rej(</span><span class="magenta">value</span><span class="schwarz">);</span><span class="schwarz"><br/></span>      <span class="schwarz">}</span><span class="schwarz"><br/></span>    <span class="schwarz">},</span><span class="schwarz"> time</span><span class="schwarz">);</span><span class="schwarz"><br/></span><a id="p516"/>  <span class="schwarz">});</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"><br/></span> <br/><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> greet() {</span><br/>  <span class="rot">const</span><span class="schwarz"> hello </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> asyncOperation(</span><span class="rot">true</span><span class="schwarz">, </span><span class="hellblau">'Hello'</span><span class="schwarz">, 100);</span><br/>  <span class="rot">const</span><span class="schwarz"> world </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> asyncOperation(</span><span class="rot">true</span><span class="schwarz">, </span><span class="hellblau">'World'</span><span class="schwarz">, 100);</span><br/>  <span class="rot">return</span><span class="schwarz"> hello </span><span class="dunkelblau">+</span><span class="schwarz"> </span><span class="hellblau">' '</span><span class="schwarz"> </span><span class="dunkelblau">+</span><span class="schwarz"> world;</span><br/>}<br/> <br/><span class="rot">const</span><span class="schwarz"> greetResult </span><span class="dunkelblau">=</span><span class="schwarz"> greet();</span><br/> <br/><span class="magenta">console</span><span class="schwarz">.log(greetResult);                     </span><span class="gruen"> // Output: Promise { &lt;pending&gt; }</span><span class="schwarz"><br/></span>greetResult.then((data) <span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="magenta">console</span><span class="schwarz">.log(data));</span><span class="gruen"> // Output: Hello World</span></samp></span><span class="schwarz"> </span><span class="schwarz"/></pre></div>
        <p class="caption "><b>Listing 16.27</b>    
            Return Value of an “async” Function</p>
        <p class="standard">In <span class="crossreference "><a href="16_007.html#l16.27">Listing 16.27</a></span>, you call the <samp class="listingcharacter listingcharacter">asyncOperation</samp> function twice and receive the values <samp class="listingcharacter listingcharacter">Hello</samp> and <samp class="listingcharacter listingcharacter">World</samp> after a wait time of <samp class="listingcharacter listingcharacter">100</samp> milliseconds, which doesn’t block the process. The asynchronous function <samp class="listingcharacter listingcharacter">greet</samp> encapsulates these calls and, as a result, returns the values of both promises as a composite string. If you output the return value of the <samp class="listingcharacter listingcharacter">greet</samp> function directly to the console, you’ll see that it’s a waiting promise object. Only the <samp class="listingcharacter listingcharacter">then</samp> method of the promise object provides access to the actual value.</p>
        <p class="standard">As you can see, async functions transform promise-based functions into readable code without callback functions.</p>
        
            <h3 class="t3" id="h16.7.1">16.7.1    Top-Level Await<a class="indexanchor" id="i16_132"/></h3>
            <p class="standard">Until some time ago, you still had to encapsulate the <samp class="listingcharacter listingcharacter">await</samp> keyword inside an <samp class="listingcharacter listingcharacter">async</samp> function. This has changed with the introduction of the <span class="italic">top-level await feature</span> in Node.js. Since version 14.8, you can also use the <samp class="listingcharacter listingcharacter">await</samp> keyword outside of a top-level <samp class="listingcharacter listingcharacter">async</samp> function in a JavaScript file in Node.js. However, there is still one condition you need to fulfill to use this feature: You must enable the ECMAScript module system<a class="indexanchor" id="i16_133"/>. In CommonJS, the <samp class="listingcharacter listingcharacter">await</samp> keyword outside an <samp class="listingcharacter listingcharacter">async</samp> function results in an error.</p>
            <p class="standard">In <span class="crossreference "><a href="16_007.html#l16.28">Listing 16.28</a></span>, you can see how to use the <samp class="listingcharacter listingcharacter">asyncOperation</samp> function from the previous examples with top-level await.</p>
            <div class="listing " id="l16.28"><pre><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">asyncOperation(</span><span class="schwarz">resolve</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="magenta">value</span><span class="schwarz">,</span><span class="schwarz"> time</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="rot">return</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">Promise((</span><span class="schwarz">res</span><span class="schwarz">,</span><span class="schwarz"> rej</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="schwarz">setTimeout(()</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>      <span class="rot">if</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">resolve</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>        <span class="schwarz">res(</span><span class="magenta">value</span><span class="schwarz">);</span><span class="schwarz"><br/></span>      <span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">else</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>        <span class="schwarz">rej(</span><span class="magenta">value</span><span class="schwarz">);</span><span class="schwarz"><br/></span>      <span class="schwarz">}</span><span class="schwarz"><br/></span><a id="p517"/>    <span class="schwarz">},</span><span class="schwarz"> time</span><span class="schwarz">);</span><span class="schwarz"><br/></span>  <span class="schwarz">});</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"><br/></span> <br/><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">const</span><span class="schwarz"> hello </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> asyncOperation(</span><span class="rot">true</span><span class="schwarz">, </span><span class="hellblau">'Hello'</span><span class="schwarz">, 100);</span><br/><span class="rot">const</span><span class="schwarz"> world </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> asyncOperation(</span><span class="rot">true</span><span class="schwarz">, </span><span class="hellblau">'World'</span><span class="schwarz">, 100);</span><br/><span class="magenta">console</span><span class="schwarz">.log(hello </span><span class="dunkelblau">+</span><span class="schwarz"> </span><span class="hellblau">' '</span><span class="schwarz"> </span><span class="dunkelblau">+</span><span class="schwarz"> world);</span></samp></span> <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 16.28</b>    
            Top-Level Await</p>
        
    </div><p class="signatur"/>
                    </body>
                </html>