<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
                    
        <head><meta content="application/xhtml+xml; charset=utf-8" http-equiv="Content-Type"/>
            <meta content="application/xhtml+xml; charset=utf-8" name="content-type"/>
            <meta content="Authentication and Session Handling" name="title"/>
            <meta content="Sebastian Springer" name="author"/>
            <meta content="Rheinwerk Publishing" name="publisher"/>
            <meta content="© 2022 by Rheinwerk Publishing Inc., Boston (MA)" name="copyright"/>
            <meta content="Node.js - The Comprehensive Guide - Authentication and Session Handling" name="description"/>
            <meta content="en" name="language"/>
            <title>Authentication and Session Handling</title>
            <link href="common/main.css" rel="stylesheet" type="text/css"/>
<meta content="urn:uuid:e0000000-0000-0000-0000-000029756394" name="Adept.expected.resource"/>
        </head>
    


                    <body class="office_us type_kapitel">
                        <div id="main">
        <h2 class="t2" id="h9.3">9.3    Logging<a class="indexanchor" id="i09_25"/> In to the Application</h2>
        <p class="standard">The <samp class="listingcharacter listingcharacter">local</samp> strategy<a class="indexanchor" id="i09_26"/> used in this example requires users to enter their user name and password and send both to the server via a <samp class="listingcharacter listingcharacter">POST</samp> request. To do this, you first need a login form.</p>
        
            <h3 class="t3" id="h9.3.1">9.3.1    Login Form<a class="indexanchor" id="i09_27"/></h3>
            <p class="standard">Because the login form is a purely static page<a class="indexanchor" id="i09_28"/>, you can save the necessary source code in the <span class="italic">public</span> directory of your application in the <span class="italic">login.html</span> file.</p>
            <p class="standard">The form in <span class="crossreference "><a href="09_003.html#l9.3">Listing 9.3</a></span> is an ordinary HTML form<a class="indexanchor" id="i09_29"/> sent to the server via <samp class="listingcharacter listingcharacter">POST</samp> request to the <span class="italic">/login</span> path. Based on the standard requirements of the <samp class="listingcharacter listingcharacter">local</samp> strategy, the user name is submitted as <samp class="listingcharacter listingcharacter">username</samp> and the password as <samp class="listingcharacter listingcharacter">password</samp>.</p>
            <div class="listing " id="l9.3"><pre><span class="dunkelblau">&lt;!DOCTYPE html&gt;</span><span class="schwarz"><br/></span><span class="dunkelblau">&lt;html </span><span class="magenta">lang=</span><span class="hellblau">"en"</span><span class="dunkelblau">&gt;</span><span class="schwarz"/><br/><br/><span class="dunkelblau">&lt;head&gt;</span><span class="schwarz"/><br/>  <span class="dunkelblau">&lt;meta </span><span class="magenta">charset=</span><span class="hellblau">"UTF-8"</span><span class="dunkelblau">&gt;</span><span class="schwarz"/><br/>  <span class="dunkelblau">&lt;title&gt;</span><span class="schwarz">Document</span><span class="dunkelblau">&lt;/title&gt;</span><span class="schwarz"/><br/>  <span class="dunkelblau">&lt;link </span><span class="magenta">rel=</span><span class="hellblau">"stylesheet"</span><span class="dunkelblau"> </span><span class="magenta">href=</span><span class="hellblau">"style.css"</span><span class="dunkelblau">&gt;</span><span class="schwarz"/><br/><span class="dunkelblau">&lt;/head&gt;</span><span class="schwarz"/><br/><br/><span class="dunkelblau">&lt;body&gt;</span><span class="schwarz"/><br/><a id="p278"/>  <span class="dunkelblau">&lt;form </span><span class="magenta">action=</span><span class="hellblau">"/login"</span><span class="dunkelblau"> </span><span class="magenta">method=</span><span class="hellblau">"post"</span><span class="dunkelblau"> </span><span class="magenta">id=</span><span class="hellblau">"login"</span><span class="dunkelblau">&gt;</span><span class="schwarz"/><br/>    <span class="dunkelblau">&lt;div&gt;</span><span class="schwarz"/><br/>      <span class="dunkelblau">&lt;h1&gt;</span><span class="schwarz">Please log in</span><span class="dunkelblau">&lt;/h1&gt;</span><span class="schwarz"/><br/>      <span class="dunkelblau">&lt;div&gt;</span><span class="schwarz"/><br/>        <span class="dunkelblau">&lt;label </span><span class="magenta">for=</span><span class="hellblau">"username"</span><span class="dunkelblau">&gt;</span><span class="schwarz">Username:</span><span class="dunkelblau">&lt;/label&gt;</span><span class="schwarz"/><br/>        <span class="dunkelblau">&lt;input </span><span class="magenta">type=</span><span class="hellblau">"text"</span><span class="dunkelblau"> </span><span class="magenta">name=</span><span class="hellblau">"username"</span><span class="dunkelblau"> </span><span class="magenta">id=</span><span class="hellblau">"username"</span><span class="dunkelblau"> autofocus&gt;</span><span class="schwarz"/><br/>      <span class="dunkelblau">&lt;/div&gt;</span><span class="schwarz"/><br/>      <span class="dunkelblau">&lt;div&gt;</span><span class="schwarz"/><br/>        <span class="dunkelblau">&lt;label </span><span class="magenta">for=</span><span class="hellblau">"password"</span><span class="dunkelblau">&gt;</span><span class="schwarz">Password:</span><span class="dunkelblau">&lt;/label&gt;</span><span class="schwarz"/><br/>        <span class="dunkelblau">&lt;input </span><span class="magenta">type=</span><span class="hellblau">"password"</span><span class="dunkelblau"> </span><span class="magenta">name=</span><span class="hellblau">"password"</span><span class="dunkelblau"> </span><span class="magenta">id=</span><span class="hellblau">"password"</span><span class="dunkelblau">&gt;</span><span class="schwarz"/><br/>      <span class="dunkelblau">&lt;/div&gt;</span><span class="schwarz"/><br/>    <span class="dunkelblau">&lt;/div&gt;</span><span class="schwarz"/><br/>    <span class="dunkelblau">&lt;button </span><span class="magenta">type=</span><span class="hellblau">"submit"</span><span class="dunkelblau">&gt;</span><span class="schwarz">anmelden</span><span class="dunkelblau">&lt;/button&gt;</span><span class="schwarz"/><br/>  <span class="dunkelblau">&lt;/form&gt;</span><span class="schwarz"/><br/><span class="dunkelblau">&lt;/body&gt;</span><span class="schwarz"/><br/><br/><span class="dunkelblau">&lt;/html&gt;</span><span class="schwarz"> </span></pre></div>
            <p class="caption "><b>Listing 9.3</b>    
            Login Form (public/login.html)</p>
            <p class="standard">On the server side, you then define the appropriate route to perform authentication. <span class="crossreference "><a href="09_003.html#l9.4">Listing 9.4</a></span> shows the implementation of this route.</p>
            <div class="listing " id="l9.4"><pre><span class="rot">import</span><span class="schwarz"> passport </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'passport'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> expressSession </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'express-session'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> LocalStrategy </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'passport-local'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">default</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">app</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  passport<span class="schwarz">.serializeUser((</span><span class="schwarz">user</span><span class="schwarz">,</span><span class="schwarz"> done</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">done(</span><span class="rot">null</span><span class="schwarz">,</span><span class="schwarz"> user</span><span class="schwarz">.</span><span class="schwarz">username</span><span class="schwarz">));</span><span class="schwarz"><br/></span>  passport<span class="schwarz">.deserializeUser((</span><span class="schwarz">id</span><span class="schwarz">,</span><span class="schwarz"> done</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{...});</span><span class="schwarz"><br/></span> <br/>  passport<span class="schwarz">.use(</span><span class="schwarz"><br/></span>    <span class="rot">new </span><span class="schwarz">LocalStrategy((</span><span class="schwarz">username</span><span class="schwarz">,</span><span class="schwarz"> password</span><span class="schwarz">,</span><span class="schwarz"> done</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{...}),</span><span class="schwarz"><br/></span>  <span class="schwarz">);</span><span class="schwarz"><br/></span> <br/>  app<span class="schwarz">.use(</span><span class="schwarz"><br/></span>    <span class="schwarz">expressSession({...}),</span><span class="schwarz"><br/></span>  <span class="schwarz">);</span><span class="schwarz"><br/></span>  app<span class="schwarz">.use(</span><span class="schwarz">passport</span><span class="schwarz">.initialize());</span><span class="schwarz"><br/></span>  app<span class="schwarz">.use(</span><span class="schwarz">passport</span><span class="schwarz">.session());</span><span class="schwarz"><br/></span> <br/>  <span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter">app.post(<br/>    <span class="hellblau">'/login'</span><span class="schwarz">,</span><br/>    passport.authenticate(<span class="hellblau">'local'</span><span class="schwarz">, { failureRedirect: </span><span class="hellblau">'/login.html'</span><span class="schwarz"> }),</span><br/>    (request, response) <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/><a id="p279"/>      response.redirect(<span class="hellblau">'/'</span><span class="schwarz">);</span><br/>    },<br/>  );</samp></span><br/>} <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 9.4</b>    
            Authentication Integration (auth.js)</p>
            <p class="standard">First, you apply the <samp class="listingcharacter listingcharacter">authenticate</samp> method of Passport as middleware to the login route<a class="indexanchor" id="i09_30"/>. This takes care of logging the user in based on the previously defined logic. If the login fails, the request is redirected back to the login page. If it’s successful, the subsequent callback function is executed. This function ensures that the user is redirected to the default route<a class="indexanchor" id="i09_31"/>. For the login process to your application to work, you still need to integrate the <samp class="listingcharacter listingcharacter">auth</samp> module into your application. This is done in the initial file with a call to the function exported by the <samp class="listingcharacter listingcharacter">auth</samp> module. The concrete integration is shown in <span class="crossreference "><a href="09_003.html#l9.5">Listing 9.5</a></span>.</p>
            <div class="listing " id="l9.5"><pre><span class="rot">import</span><span class="schwarz"> express </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'express'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> morgan </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'morgan'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> dirname </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'path'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> fileURLToPath </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'url'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> router </span><span class="rot">as</span><span class="schwarz"> movieRouter </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./movie/index.js'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">import</span><span class="schwarz"> auth </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./auth.js'</span><span class="schwarz">;</span><br/> </samp></span><br/><span class="rot">const</span><span class="schwarz"> app </span><span class="dunkelblau">=</span><span class="schwarz"> express();</span><br/> <br/>app.set(<span class="hellblau">'view engine'</span><span class="schwarz">, </span><span class="hellblau">'pug'</span><span class="schwarz">);</span><br/> <br/>app.use(express.static(dirname(fileURLToPath(<span class="rot">import</span><span class="schwarz">.meta.url)) </span><span class="dunkelblau">+</span><span class="schwarz"> </span><span class="hellblau">'/public'</span><span class="schwarz">));</span><br/> <br/>app.use(morgan(<span class="hellblau">'common'</span><span class="schwarz">, { immediate: </span><span class="rot">true</span><span class="schwarz"> }));</span><br/> <br/>app.use(express.urlencoded({ extended: <span class="rot">false</span><span class="schwarz"> }));</span><br/> <br/><span class="bold"><samp class="listingcharacter listingcharacter">auth(app);<br/> </samp></span><br/>app.use(<span class="hellblau">'/movie'</span><span class="schwarz">, movieRouter);</span><br/> <br/>app.get(<span class="hellblau">'/'</span><span class="schwarz">, (request, response) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> response.redirect(</span><span class="hellblau">'/movie'</span><span class="schwarz">));</span><br/> <br/>app.listen(8080, () <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>  <span class="magenta">console</span><span class="schwarz">.log(</span><span class="hellblau">'Server is listening to http://localhost:8080'</span><span class="schwarz">);</span><br/>}); <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 9.5</b>    
            Integrating the Auth Module (index.js)</p>
            <p class="standard"><a id="p280"/>When you restart your server process, you can access the login form at <span class="italic">http://localhost:8080/login.html</span>. <span class="crossreference "><a href="09_003.html#f9.1">Figure 9.1</a></span> shows the current state of the login screen.</p>
            <div class="imagebox figure-type"><a href="img-f9.1.html" id="f9.1"><img alt="Login Form" id="img-f9.1" src="bilderklein/klein09_001.png"/></a></div>
            <p class="caption "><b>Figure 9.1</b>    
            Login Form</p>
        
        
            <h3 class="t3" id="h9.3.2">9.3.2    Securing Resources<a class="indexanchor" id="i09_32"/></h3>
            <p class="standard">Your application is now prepared up to the point where you can start making parts of the application available only to logged-in users because in the current state, users can log in but also perform all available actions without being logged in. To solve this task, you can draw on an existing package called <samp class="listingcharacter listingcharacter">connect-ensure-login</samp><a class="indexanchor" id="i09_33"/>, which you can install using the <samp class="listingcharacter listingcharacter">npm install connect-ensure-login</samp> command. <span class="crossreference "><a href="09_003.html#l9.6">Listing 9.6</a></span> shows how you can secure the entire <samp class="listingcharacter listingcharacter">movie</samp> module.</p>
            <div class="listing " id="l9.6"><pre><span class="rot">import</span><span class="schwarz"> express </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'express'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> morgan </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'morgan'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> dirname </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'path'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> fileURLToPath </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'url'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> router </span><span class="rot">as</span><span class="schwarz"> movieRouter </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./movie/index.js'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> auth </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./auth.js'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">import</span><span class="schwarz"> { ensureLoggedIn } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'connect-ensure-login'</span><span class="schwarz">;</span><br/> </samp></span><br/><span class="rot">const</span><span class="schwarz"> app </span><span class="dunkelblau">=</span><span class="schwarz"> express();</span><br/> <br/>app.set(<span class="hellblau">'view engine'</span><span class="schwarz">, </span><span class="hellblau">'pug'</span><span class="schwarz">);</span><br/> <br/>app.use(express.static(dirname(fileURLToPath(<span class="rot">import</span><span class="schwarz">.meta.url)) </span><span class="dunkelblau">+</span><span class="schwarz"> </span><span class="hellblau">'/public'</span><span class="schwarz">));</span><br/> <br/>app.use(morgan(<span class="hellblau">'common'</span><span class="schwarz">, { immediate: </span><span class="rot">true</span><span class="schwarz"> }));</span><br/> <br/>app.use(express.urlencoded({ extended: <span class="rot">false</span><span class="schwarz"> }));</span><br/> <br/>auth(app);<br/><a id="p281"/> <br/>app.use(<span class="hellblau">'/movie'</span><span class="bold"><samp class="listingcharacter listingcharacter"><span class="schwarz">, ensureLoggedIn(</span><span class="hellblau">'/login.html'</span><span class="schwarz">)</span></samp></span>, movieRouter);<br/> <br/>app.get(<span class="hellblau">'/'</span><span class="schwarz">, (request, response) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> response.redirect(</span><span class="hellblau">'/movie'</span><span class="schwarz">));</span><br/> <br/>app.listen(8080, () <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>  <span class="magenta">console</span><span class="schwarz">.log(</span><span class="hellblau">'Server is listening to http://localhost:8080'</span><span class="schwarz">);</span><br/>}); <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 9.6</b>    
            Securing Resources (index.js)</p>
            <p class="standard">The <samp class="listingcharacter listingcharacter">connect-ensure-login</samp> package provides you with the <samp class="listingcharacter listingcharacter">ensureLoggedIn</samp> and <samp class="listingcharacter listingcharacter">ensureLoggedOut</samp> methods, which you can use as middleware to determine whether the current user is logged in or logged out.</p>
            <p class="standard">You pass the route to which a user who isn’t logged in should be redirected to the <samp class="listingcharacter listingcharacter">ensureLoggedIn</samp> middleware<a class="indexanchor" id="i09_34"/> function. In the example, that’s the login form. When you now restart your application, it’s no longer possible to access the movie list without logging in. Currently, however, you can only log out by deleting the site’s cookies, as they keep the reference to the session. So, the next step is to make the logout process more convenient for your users.</p>
        
        
            <h3 class="t3" id="h9.3.3">9.3.3    Logging Out<a class="indexanchor" id="i09_35"/></h3>
            <p class="standard">If you want to log in with a different user or simply end your current session, you can currently do this only by means of a workaround. However, the goal is to enable this process via a link within the application. For this purpose, you must extend the central template with a link to the <samp class="listingcharacter listingcharacter">logout</samp> route<a class="indexanchor" id="i09_36"/>. <span class="crossreference "><a href="09_003.html#l9.7">Listing 9.7</a></span> shows the source code of the <span class="italic">templates/base.pug</span> file.</p>
            <div class="listing " id="l9.7"><pre>doctype html<br/>html(lang="en")<br/>  head<br/>    meta(charset="UTF-8")<br/>    title Movie list<br/>    link(rel="stylesheet" href="/style.css")<br/>  body<br/><br/>  <span class="bold"><samp class="listingcharacter listingcharacter">a(href="/logout") logout</samp></span><br/>  img.logo(src="logo.png" height="50")<br/><br/>  block content<br/>    div No content </pre></div>
            <p class="caption "><b>Listing 9.7</b>    
            Inserting the Logout Link (templates/base.pug)</p>
            <p class="standard"><a id="p282"/>You must also implement the counterpart of this route in the <span class="italic">auth.js</span> file to group all the functionalities associated with authentication in one module.</p>
            <p class="standard">As you can see in <span class="crossreference "><a href="09_003.html#l9.8">Listing 9.8</a></span>, Passport extends the <samp class="listingcharacter listingcharacter">request</samp> object with a <samp class="listingcharacter listingcharacter">logout</samp> method<a class="indexanchor" id="i09_37"/>. You can use this method to discard the current logon session and thus log off the user. After that, you redirect the user to the application’s entry page, which eventually takes the user back to the login page.</p>
            <div class="listing " id="l9.8"><pre><span class="rot">import</span><span class="schwarz"> passport </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'passport'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> expressSession </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'express-session'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> LocalStrategy </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'passport-local'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">default</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">app</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  passport<span class="schwarz">.serializeUser((</span><span class="schwarz">user</span><span class="schwarz">,</span><span class="schwarz"> done</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">done(</span><span class="rot">null</span><span class="schwarz">,</span><span class="schwarz"> user</span><span class="schwarz">.</span><span class="schwarz">username</span><span class="schwarz">));</span><span class="schwarz"><br/></span>  passport<span class="schwarz">.deserializeUser((</span><span class="schwarz">id</span><span class="schwarz">,</span><span class="schwarz"> done</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{...});</span><span class="schwarz"><br/></span> <br/>  passport<span class="schwarz">.use(</span><span class="schwarz"><br/></span>    <span class="rot">new </span><span class="schwarz">LocalStrategy((</span><span class="schwarz">username</span><span class="schwarz">,</span><span class="schwarz"> password</span><span class="schwarz">,</span><span class="schwarz"> done</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{...}),</span><span class="schwarz"><br/></span>  <span class="schwarz">);</span><span class="schwarz"><br/></span> <br/>  app<span class="schwarz">.use(</span><span class="schwarz"><br/></span>    <span class="schwarz">expressSession({...}),</span><span class="schwarz"><br/></span>  <span class="schwarz">);</span><span class="schwarz"><br/></span>  app<span class="schwarz">.use(</span><span class="schwarz">passport</span><span class="schwarz">.initialize());</span><span class="schwarz"><br/></span>  app<span class="schwarz">.use(</span><span class="schwarz">passport</span><span class="schwarz">.session());</span><span class="schwarz"><br/></span> <br/>  app<span class="schwarz">.post(</span><span class="hellblau">'/login'</span><span class="schwarz">,...);</span><span class="schwarz"><br/></span> <br/>  <span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter">app.get(<span class="hellblau">'/logout'</span><span class="schwarz">, (request, response) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>    request.logout();<br/>    response.redirect(<span class="hellblau">'/'</span><span class="schwarz">);</span><br/>  });</samp></span><br/>} <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 9.8</b>    
            Implementing the Logout Route (auth.js)</p>
        
        
            <h3 class="t3" id="h9.3.4">9.3.4    Connecting to the Database<a class="indexanchor" id="i09_38"/></h3>
            <p class="standard">The current implementation of the application is based on static data that exists in the source code. To make your application more flexible at this point, you can use the existing SQLite<a class="indexanchor" id="i09_39"/> database and store the user data there.</p>
            <p class="standard">First, you need to add a user table<a class="indexanchor" id="i09_40"/> to your database and insert at least one data record. <span class="crossreference "><a href="09_003.html#l9.9">Listing 9.9</a></span> shows the queries used to extend your database accordingly.</p>
            <div class="listing " id="l9.9"><pre><span class="dunkelblau"><a id="p283"/>CREATE</span><span class="schwarz"> </span><span class="dunkelblau">TABLE</span><span class="schwarz"> </span><span class="rot">`Users`</span><span class="schwarz"> (</span><br/>id <span class="dunkelblau">INTEGER</span><span class="schwarz"> </span><span class="dunkelblau">PRIMARY</span><span class="schwarz"> </span><span class="dunkelblau">KEY</span><span class="schwarz">,</span><br/>firstname TEXT,<br/>lastname TEXT,<br/>username TEXT,<br/>password TEXT);<br/><span class="dunkelblau">INSERT</span><span class="schwarz"> </span><span class="dunkelblau">INTO</span><span class="schwarz"> </span><span class="rot">`Users`</span><span class="schwarz"> (</span><span class="rot">`firstname`</span><span class="schwarz">, </span><span class="rot">`lastname`</span><span class="schwarz">, </span><span class="rot">`username`</span><span class="schwarz">, </span><span class="rot">`password`</span><span class="schwarz">) VALUES </span><br/>(<span class="rot">'Sebastian'</span><span class="schwarz">, </span><span class="rot">'Springer'</span><span class="schwarz">, </span><span class="rot">'sspringer'</span><span class="schwarz">, </span><span class="rot">'098f6bcd4621d373cade4e832627b4f6'</span><span class="schwarz">); </span></pre></div>
            <p class="caption "><b>Listing 9.9</b>    
            Extending the Database by a User Table</p>
            <p class="standard">It has become a best practice not to store passwords in plain text in the database, but to encrypt them instead or to store a hash value<a class="indexanchor" id="i09_41"/> of the password. In this case, it’s a simple MD5 hash<a class="indexanchor" id="i09_42"/>. To access the database, you need a model in your application. Because you only have read access to the database in this example, the implementation of a <samp class="listingcharacter listingcharacter">get</samp> method in the model is sufficient. The implementation of the model that you store in the <span class="italic">user</span> directory in the <span class="italic">model.js</span> file is shown in <span class="crossreference "><a href="09_003.html#l9.10">Listing 9.10</a></span>.</p>
            <div class="listing " id="l9.10"><pre><span class="rot">import</span><span class="schwarz"> sqlite </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'sqlite3'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="rot">const</span><span class="schwarz"> db </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">new sqlite</span><span class="schwarz">.Database(</span><span class="hellblau">'./movie.db'</span><span class="schwarz">);</span><span class="schwarz"><br/></span> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">get(</span><span class="schwarz">query </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="schwarz">{})</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="rot">return</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">Promise((</span><span class="schwarz">resolve</span><span class="schwarz">,</span><span class="schwarz"> reject</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="rot">const</span><span class="schwarz"> queryElements </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="schwarz">[];</span><span class="schwarz"><br/></span>    <span class="rot">if</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">query</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>      <span class="rot">for</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="rot">let</span><span class="schwarz"> </span><span class="magenta">key</span><span class="schwarz"> </span><span class="rot">in</span><span class="schwarz"> query</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>        queryElements<span class="schwarz">.push(</span><span class="violett">`${key} = ?`</span><span class="schwarz">);</span><span class="schwarz"><br/></span>      <span class="schwarz">}</span><span class="schwarz"><br/></span>    <span class="schwarz">}</span><span class="schwarz"><br/></span> <br/>    <span class="rot">const</span><span class="schwarz"> queryString </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="violett">`SELECT * FROM Users WHERE ${queryElements.join(</span><br/>      <span class="hellblau">' AND '</span><span class="violett">,</span><br/>    )}`<span class="schwarz">;</span><span class="schwarz"><br/></span> <br/>    db<span class="schwarz">.get(</span><span class="schwarz">queryString</span><span class="schwarz">,</span><span class="schwarz"> Object</span><span class="schwarz">.values(</span><span class="schwarz">query</span><span class="schwarz">),</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">error</span><span class="schwarz">,</span><span class="schwarz"> results</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>      <span class="rot">if</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">error</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>        <span class="schwarz">reject(</span><span class="schwarz">error</span><span class="schwarz">);</span><span class="schwarz"><br/></span>      <span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">else</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>        <span class="schwarz">resolve(</span><span class="schwarz">results</span><span class="schwarz">);</span><span class="schwarz"><br/></span>      <span class="schwarz">}</span><span class="schwarz"><br/></span>    <span class="schwarz">});</span><span class="schwarz"><br/></span>  <span class="schwarz">});</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"> </span></pre></div>
            <p class="caption "><b>Listing 9.10</b>    
            Implementing the User Model (user/model.js)</p>
            <p class="standard"><a id="p284"/>The implementation of the <samp class="listingcharacter listingcharacter">get</samp> method is kept at a general level so that you can search for a user name and password combination as well as a user ID. For this purpose, the passed <samp class="listingcharacter listingcharacter">query</samp> object is decomposed, and the query is assembled in such a way that you can use the escaping of the SQLite driver.</p>
            <p class="standard">Due to this extension, you can now replace the static credentials in the <span class="italic">auth.js</span> file with queries from the database. The source code in <span class="crossreference "><a href="09_003.html#l9.11">Listing 9.11</a></span>, which we’ll explain step by step afterwards, provides an overview.</p>
            <div class="listing " id="l9.11"><pre><span class="rot">import</span><span class="schwarz"> passport </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'passport'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> expressSession </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'express-session'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> LocalStrategy </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'passport-local'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">import</span><span class="schwarz"> { createHash } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'crypto'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> { </span><span class="rot">get</span><span class="schwarz"> } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./user/model.js'</span><span class="schwarz">;</span><br/> </samp></span><br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">default</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> (app) {</span><br/>  passport.serializeUser((user, done) <span class="dunkelblau">=&gt;</span><span class="schwarz"> done(</span><span class="rot">null</span><span class="schwarz">, </span><span class="bold"><samp class="listingcharacter listingcharacter">user.id</samp></span>));<br/>  passport.deserializeUser(<span class="rot">async</span><span class="schwarz"> (id, done) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>    <span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">const</span><span class="schwarz"> user </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> get({ id });</span><br/>    <span class="rot">if</span><span class="schwarz"> (</span><span class="dunkelblau">!</span><span class="schwarz">user) {</span><br/>      done(<span class="hellblau">'User not found'</span><span class="schwarz">);</span><br/>    } <span class="rot">else</span><span class="schwarz"> {</span><br/>      done(<span class="rot">null</span><span class="schwarz">, user);</span><br/>    }</samp></span><br/>  });<br/> <br/>  passport.use(<br/>    <span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">new </span><span class="schwarz">LocalStrategy(</span><span class="rot">async</span><span class="schwarz"> (username, password, done) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>      <span class="rot">const</span><span class="schwarz"> hash </span><span class="dunkelblau">=</span><span class="schwarz"> createHash(</span><span class="hellblau">'md5'</span><span class="schwarz">).update(password).digest(</span><span class="hellblau">'hex'</span><span class="schwarz">);</span><br/>      <span class="rot">const</span><span class="schwarz"> user </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> get({ username, password: hash });</span><br/>      <span class="rot">if</span><span class="schwarz"> (</span><span class="dunkelblau">!</span><span class="schwarz">user) {</span><br/>        done(<span class="rot">null</span><span class="schwarz">, </span><span class="rot">false</span><span class="schwarz">);</span><br/>      } <span class="rot">else</span><span class="schwarz"> {</span><br/>        done(<span class="rot">null</span><span class="schwarz">, user);</span><br/>      }<br/>    }),</samp></span><br/>  );<br/> <br/>  app.use(expressSession({...}));<br/>  app.use(passport.initialize());<br/>  app.use(passport.session());<br/> <br/>  app.post(<span class="hellblau">'/login'</span><span class="schwarz">, ...);</span><br/> <br/>  app.get(<span class="hellblau">'/logout'</span><span class="schwarz">, (request, response) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {...});</span><br/>} <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 9.11</b>    
            User Authentication against a Database (auth.js)</p>
            <p class="standard"><a id="p285"/>At the beginning of the file, you import the <samp class="listingcharacter listingcharacter">createHash</samp> function of the <samp class="listingcharacter listingcharacter">crypto</samp> module to convert the passed password into the MD5 hash<a class="indexanchor" id="i09_43"/> used in the example.</p>
            <p class="standard">This means you no longer serialize the user by the user name, but by their unique user ID. In the <samp class="listingcharacter listingcharacter">deserializeUser</samp> method, whose callback function is now an <samp class="listingcharacter listingcharacter">async</samp> function, you read the user information from the database using the serialized user ID. The <samp class="listingcharacter listingcharacter">get</samp> method will either return the relevant data record of the user—in which case, you call the <samp class="listingcharacter listingcharacter">done</samp> callback function with the value <samp class="listingcharacter listingcharacter">null</samp> as the error object and the user object—or the record won’t be found. This then indicates an error, and you call the <samp class="listingcharacter listingcharacter">done</samp> callback function with a corresponding message as an error object.</p>
            <p class="standard">Passwords are stored as hashes in the database, so you’ll need this form of password to query the database. The <samp class="listingcharacter listingcharacter">createHash</samp> function enables you to create the MD5 hash, pass the password in plain text<a class="indexanchor" id="i09_44"/> via the <samp class="listingcharacter listingcharacter">update</samp> method, and have it output a character string formatted with hex values. You pass the user name and encrypted password to the <samp class="listingcharacter listingcharacter">get</samp> function of your <samp class="listingcharacter listingcharacter">user</samp> model for querying. When dealing with the result, you proceed in an analogous way to the deserialization of the user.</p>
            <p class="standard">The following sections describe the handling of resources in your application.</p>
        
    </div><p class="signatur"/>
                    </body>
                </html>