<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
                    
        <head><meta content="application/xhtml+xml; charset=utf-8" http-equiv="Content-Type"/>
            <meta content="application/xhtml+xml; charset=utf-8" name="content-type"/>
            <meta content="Authentication and Session Handling" name="title"/>
            <meta content="Sebastian Springer" name="author"/>
            <meta content="Rheinwerk Publishing" name="publisher"/>
            <meta content="© 2022 by Rheinwerk Publishing Inc., Boston (MA)" name="copyright"/>
            <meta content="Node.js - The Comprehensive Guide - Authentication and Session Handling" name="description"/>
            <meta content="en" name="language"/>
            <title>Authentication and Session Handling</title>
            <link href="common/main.css" rel="stylesheet" type="text/css"/>
<meta content="urn:uuid:e0000000-0000-0000-0000-000029756394" name="Adept.expected.resource"/>
        </head>
    


                    <body class="office_us type_kapitel">
                        <div id="main">
        <h2 class="t2" id="h9.4">9.4    Accessing Resources<a class="indexanchor" id="i09_45"/></h2>
        <p class="standard">Individual pages make up the largest category of resources in your application. You’ve already secured this type with Passport to prevent unauthorized people from accessing protected pages. However, in your application, you can also control at a lower level how your users work with the application’s data.</p>
        
            <h3 class="t3" id="h9.4.1">9.4.1    Access Restriction<a class="indexanchor" id="i09_46"/></h3>
            <p class="standard">In this section, you’ll limit the access to data records to the respective creator of the record and add the option to share movies with all users. For this purpose, you use the information stored in the session about the currently logged-in user<a class="indexanchor" id="i09_47"/> for both write and read accesses. First, you have to extend the movie table of your database with an additional field, as shown in <span class="crossreference "><a href="09_004.html#l9.12">Listing 9.12</a></span>.</p>
            <div class="listing " id="l9.12"><pre><span class="dunkelblau">ALTER</span><span class="schwarz"> </span><span class="dunkelblau">TABLE</span><span class="schwarz"> </span><span class="rot">`Movies`</span><span class="schwarz"> </span><span class="dunkelblau">ADD</span><span class="schwarz"> </span><span class="dunkelblau">COLUMN</span><span class="schwarz"> </span><span class="rot">`user`</span><span class="schwarz"> </span><span class="dunkelblau">INTEGER</span><span class="schwarz">;</span><br/><span class="dunkelblau">ALTER</span><span class="schwarz"> </span><span class="dunkelblau">TABLE</span><span class="schwarz"> </span><span class="rot">`Movies`</span><span class="schwarz"> </span><span class="dunkelblau">ADD</span><span class="schwarz"> </span><span class="dunkelblau">COLUMN</span><span class="schwarz"> </span><span class="rot">`public`</span><span class="schwarz"> </span><span class="dunkelblau">INTEGER</span><span class="schwarz">; </span></pre></div>
            <p class="caption "><b>Listing 9.12</b>    
            Extending the Movie Table</p>
            <p class="standard">When customizing the application, you move from the frontend toward the database and provide your users with the option to mark a movie as public so that all other users can see it. For this purpose, you must extend the input form in the <span class="italic">movie/form.js</span> file. Here, you insert the block from <span class="crossreference "><a href="09_004.html#l9.13">Listing 9.13</a></span> below the input field for the year.</p>
            <div class="listing " id="l9.13"><pre><span class="dunkelblau"><a id="p286"/>&lt;div&gt;</span><span class="schwarz"/><br/>  <span class="dunkelblau">&lt;label </span><span class="magenta">for=</span><span class="hellblau">"id"</span><span class="dunkelblau">&gt;</span><span class="schwarz">Public:</span><span class="dunkelblau">&lt;/label&gt;</span><span class="schwarz"/><br/>  <span class="dunkelblau">&lt;input </span><span class="magenta">type=</span><span class="hellblau">"checkbox"</span><span class="dunkelblau"> </span><span class="magenta">id=</span><span class="hellblau">"public"</span><span class="dunkelblau"> </span><span class="magenta">name=</span><span class="hellblau">"public"</span><span class="dunkelblau"> </span><span class="magenta">value=</span><span class="hellblau">"1"</span><span class="dunkelblau"> ${</span><br/>    movie.public ? '<span class="magenta">checked=</span><span class="hellblau">"checked"</span><span class="dunkelblau"> ' : ''</span><br/>  } /&gt;<span class="schwarz"/><br/><span class="dunkelblau">&lt;/div&gt;</span><span class="schwarz"> </span></pre></div>
            <p class="caption "><b>Listing 9.13</b>    
            Extending the Form (movie/form.js)</p>
            <p class="standard">In the controller, you need to make changes in several places. In <samp class="listingcharacter listingcharacter">formAction</samp>, which is responsible for the form representation, you insert the <samp class="listingcharacter listingcharacter">public</samp> property with an empty character string as the default value, and in <samp class="listingcharacter listingcharacter">saveAction</samp>, you read the <samp class="listingcharacter listingcharacter">public</samp> property from the request and correctly place the information in the object to be saved. You must also pass the user ID to the model for each method call so that permissions can be applied correctly. You obtain this information through the <samp class="listingcharacter listingcharacter">request.user</samp> object Passport inserted for you. <span class="crossreference "><a href="09_004.html#l9.14">Listing 9.14</a></span> summarizes these customizations.</p>
            <div class="listing " id="l9.14"><pre><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> dirname </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'path'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> fileURLToPath </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'url'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> getAll</span><span class="schwarz">,</span><span class="schwarz"> remove</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="rot">get</span><span class="schwarz">,</span><span class="schwarz"> save </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./model.js'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> render </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./view.js'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> render </span><span class="rot">as</span><span class="schwarz"> form </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./form.js'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">listAction(</span><span class="schwarz">request</span><span class="schwarz">,</span><span class="schwarz"> response</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="rot">const</span><span class="schwarz"> movies </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> </span><span class="schwarz">getAll(</span><span class="bold"><samp class="listingcharacter listingcharacter">request.user.id</samp></span>);<br/>  response.render(dirname(fileURLToPath(<span class="rot">import</span><span class="schwarz">.meta.url)) </span><span class="dunkelblau">+</span><span class="schwarz"> </span><span class="hellblau">'/views/list'</span><span class="schwarz">, {</span><br/>    movies,<br/>  });<br/>}<br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> removeAction(request, response) {</span><br/>  <span class="rot">const</span><span class="schwarz"> id </span><span class="dunkelblau">=</span><span class="schwarz"> parseInt(request.params.id, 10);</span><br/>  <span class="rot">await</span><span class="schwarz"> remove(id</span><span class="bold"><samp class="listingcharacter listingcharacter">, request.user.id</samp></span>);<br/>  response.redirect(request.baseUrl);<br/>}<br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> formAction(request, response) {</span><br/>  <span class="rot">let</span><span class="schwarz"> movie </span><span class="dunkelblau">=</span><span class="schwarz"> { id: </span><span class="hellblau">''</span><span class="schwarz">, title: </span><span class="hellblau">''</span><span class="schwarz">, year: </span><span class="hellblau">''</span><span class="bold"><samp class="listingcharacter listingcharacter"><span class="schwarz">, </span><span class="rot">public</span><span class="schwarz">: </span><span class="hellblau">''</span></samp></span><span class="schwarz"> };</span><br/> <br/>  <span class="rot">if</span><span class="schwarz"> (request.params.id) {</span><br/>    movie <span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> get(parseInt(request.params.id, 10)</span><span class="bold"><samp class="listingcharacter listingcharacter">, request.user.id</samp></span>);<br/>  }<br/> <br/>  <span class="rot">const</span><span class="schwarz"> body </span><span class="dunkelblau">=</span><span class="schwarz"> form(movie);</span><br/>  response.send(body);<br/><a id="p287"/>}<br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> saveAction(request, response) {</span><br/>  <span class="rot">const</span><span class="schwarz"> movie </span><span class="dunkelblau">=</span><span class="schwarz"> {</span><br/>    id: request.body.id,<br/>    title: request.body.title,<br/>    year: request.body.year,<br/>    <span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">public</span><span class="schwarz">: request.body.</span><span class="rot">public</span><span class="schwarz"> </span><span class="dunkelblau">===</span><span class="schwarz"> </span><span class="hellblau">'1'</span><span class="schwarz"> </span><span class="dunkelblau">?</span><span class="schwarz"> 1 : 0,</span></samp></span><br/>  };<br/>  <span class="rot">await</span><span class="schwarz"> save(movie</span><span class="bold"><samp class="listingcharacter listingcharacter">, request.user.id</samp></span>);<br/>  response.redirect(request.baseUrl);<br/>} <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 9.14</b>    
            Extending the Controller with the “public” Property (movie/controller.js)</p>
            <p class="standard">The model in the <span class="italic">movie/model.js</span> file takes care of managing the data and thus handling permissions<a class="indexanchor" id="i09_48"/>. For each read request, only those records are read that the user is allowed to read.</p>
            <div class="listing " id="l9.15"><pre><span class="rot">import</span><span class="schwarz"> sqlite </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'sqlite3'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="rot">const</span><span class="schwarz"> db </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">new sqlite</span><span class="schwarz">.Database(</span><span class="hellblau">'./movie.db'</span><span class="schwarz">);</span><span class="schwarz"><br/></span> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">getAll(</span><span class="bold"><samp class="listingcharacter listingcharacter">userId</samp></span>) {<br/>  <span class="rot">return</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">Promise((resolve, reject) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>    <span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">const</span><span class="schwarz"> query </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="hellblau">'SELECT * FROM Movies WHERE user = ? OR public = 1'</span><span class="schwarz">;</span></samp></span><br/>    db.all(query<span class="bold"><samp class="listingcharacter listingcharacter">, [userId]</samp></span>, (error, results) <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>      <span class="rot">if</span><span class="schwarz"> (error) {</span><br/>        reject(error);<br/>      } <span class="rot">else</span><span class="schwarz"> {</span><br/>        resolve(results);<br/>      }<br/>    });<br/>  });<br/>}<br/> <br/><span class="rot">function</span><span class="schwarz"> insert(movie</span><span class="bold"><samp class="listingcharacter listingcharacter">, userId</samp></span>) {<br/>  <span class="rot">return</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">Promise((resolve, reject) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>    <span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">const</span><span class="schwarz"> query </span><span class="dunkelblau">=</span><span class="schwarz"><br/></span>      <span class="hellblau">'INSERT INTO Movies (title, year, public, user) VALUES (?, ?, ?, ?)'</span><span class="schwarz">;</span></samp></span><br/>    db.run(<br/>      query,<br/>      [movie.title, movie.year<span class="bold"><samp class="listingcharacter listingcharacter">, movie.<span class="rot">public</span><span class="schwarz">, userId</span></samp></span>],<br/>      <span class="rot">function</span><span class="schwarz"> (error, results) {</span><br/>        <span class="rot">if</span><span class="schwarz"> (error) {</span><br/><a id="p288"/>          reject(error);<br/>        } <span class="rot">else</span><span class="schwarz"> {</span><br/>          resolve({ ...movie, id: <span class="rot">this</span><span class="schwarz">.lastID });</span><br/>        }<br/>      },<br/>    );<br/>  });<br/>}<br/> <br/><span class="rot">function</span><span class="schwarz"> update(movie</span><span class="bold"><samp class="listingcharacter listingcharacter">, userId</samp></span>) {<br/>  <span class="rot">return</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">Promise((resolve, reject) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>    <span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">const</span><span class="schwarz"> query </span><span class="dunkelblau">=</span><span class="schwarz"><br/></span>      <span class="hellblau">'UPDATE Movies SET title = ?, year = ?, public = ?, </span></samp></span><img alt="inline image" class="inline_image" src="bilder/umbruchpfeil.png"/><span class="bold"><samp class="listingcharacter listingcharacter"><br/>        user = ? WHERE id = ?'<span class="schwarz">;</span></samp></span><br/>    db.run(<br/>      query,<br/>      [movie.title, movie.year<span class="bold"><samp class="listingcharacter listingcharacter">, movie.<span class="rot">public</span><span class="schwarz">, userId</span></samp></span>, movie.id],<br/>      (error, results) <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>        <span class="rot">if</span><span class="schwarz"> (error) {</span><br/>          reject(error);<br/>        } <span class="rot">else</span><span class="schwarz"> {</span><br/>          resolve(results);<br/>        }<br/>      },<br/>    );<br/>  });<br/>}<br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> get(id</span><span class="bold"><samp class="listingcharacter listingcharacter">, userId</samp></span>) {<br/>  <span class="rot">return</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">Promise((resolve, reject) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>    <span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">const</span><span class="schwarz"> query </span><span class="dunkelblau">=</span><span class="schwarz"><br/></span>      <span class="hellblau">'SELECT * FROM Movies WHERE id = ? AND (user = ? OR public = 1)'</span><span class="schwarz">;</span></samp></span><br/>    db.get(query, [id<span class="bold"><samp class="listingcharacter listingcharacter">, userId</samp></span>], (error, results) <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>      <span class="rot">if</span><span class="schwarz"> (error) {</span><br/>        reject(error);<br/>      } <span class="rot">else</span><span class="schwarz"> {</span><br/>        resolve(results);<br/>      }<br/>    });<br/>  });<br/>}<br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> save(movie</span><span class="bold"><samp class="listingcharacter listingcharacter">, userId</samp></span>) {<br/>  <span class="rot">if</span><span class="schwarz"> (</span><span class="dunkelblau">!</span><span class="schwarz">movie.id) {</span><br/><a id="p289"/>    <span class="rot">return</span><span class="schwarz"> insert(movie</span><span class="bold"><samp class="listingcharacter listingcharacter">, userId</samp></span>);<br/>  } <span class="rot">else</span><span class="schwarz"> {</span><br/>    <span class="rot">return</span><span class="schwarz"> update(movie</span><span class="bold"><samp class="listingcharacter listingcharacter">, userId</samp></span>);<br/>  }<br/>}<br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> remove(id</span><span class="bold"><samp class="listingcharacter listingcharacter">, userId</samp></span>) {<br/>  <span class="rot">return</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">Promise((resolve, reject) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>    <span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">const</span><span class="schwarz"> query </span><span class="dunkelblau">=</span><span class="schwarz"><br/></span>      <span class="hellblau">'DELETE FROM Movies WHERE id = ? AND (user = ? OR public = 1)'</span><span class="schwarz">;</span></samp></span><br/>    db.run(query, [id, userId], (error, results) <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>      <span class="rot">if</span><span class="schwarz"> (error) {</span><br/>        reject(error);<br/>      } <span class="rot">else</span><span class="schwarz"> {</span><br/>        resolve(results);<br/>      }<br/>    });<br/>  });<br/>} <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 9.15</b>    
            Adjustments to the Model (movie/model.js)</p>
            <p class="standard">With the <samp class="listingcharacter listingcharacter">getAll</samp> function, you limit the data records that are read to those directly assigned<a class="indexanchor" id="i09_49"/> to the user or marked as <samp class="listingcharacter listingcharacter">public</samp>. You also adapt the <samp class="listingcharacter listingcharacter">get</samp> function so that it only returns a data record if it’s assigned to the user or is public.</p>
            <p class="standard">When inserting a record, you write the information regarding whether a movie is public or not from the user input to the database. In addition, you add the information about the creating user from the current session.</p>
            <p class="standard">If it’s a matter of updating a data record, you proceed in the same way as for inserting it. As a result, the information in the <samp class="listingcharacter listingcharacter">user</samp> column doesn’t indicate the creating user, but the user who made the last change.</p>
            <p class="standard">When deleting records, you customize the query so that users are only able to delete their own or public records, but not the nonpublic records of other users.</p>
        
        
            <h3 class="t3" id="h9.4.2">9.4.2    Submitting Ratings</h3>
            <p class="standard">The unique assignment of data records to users covers only a part of the problems you can map with authenticated users, however. Another feature you can now integrate into your movie database is a rating system. You want all users to be able to rate the movies. To solve this task, you must first create another table that maps the relation<a class="indexanchor" id="i09_50"/> between user and movie. This table is named <samp class="listingcharacter listingcharacter">Ratings</samp>. The corresponding <samp class="listingcharacter listingcharacter">CREATE</samp> statement is shown in <span class="crossreference "><a href="09_004.html#l9.16">Listing 9.16</a></span>.</p>
            <div class="listing " id="l9.16"><pre><span class="dunkelblau"><a id="p290"/>CREATE</span><span class="schwarz"> </span><span class="dunkelblau">TABLE</span><span class="schwarz"> </span><span class="rot">`Ratings`</span><span class="schwarz"> (</span><br/>user <span class="dunkelblau">INTEGER</span><span class="schwarz">,</span><br/>movie <span class="dunkelblau">INTEGER</span><span class="schwarz">,</span><br/>rating <span class="dunkelblau">INTEGER</span><span class="schwarz">); </span></pre></div>
            <p class="caption "><b>Listing 9.16</b>    
            Creating the Ratings Table</p>
            <p class="standard">The rating system only affects the list view of the movies and here specifically the <span class="italic">movie/views/list-item.pug</span> file. <span class="crossreference "><a href="09_004.html#l9.17">Listing 9.17</a></span> shows the necessary adjustments.</p>
            <div class="listing " id="l9.17"><pre>mixin <span class="schwarz">listItem(</span><span class="schwarz">movie</span><span class="schwarz">)</span><span class="schwarz"><br/></span>  tr<br/>    td #<span class="schwarz">{</span><span class="schwarz">movie</span><span class="schwarz">.</span><span class="schwarz">id</span><span class="schwarz">}</span><span class="schwarz"><br/></span>    td #<span class="schwarz">{</span><span class="schwarz">movie</span><span class="schwarz">.</span><span class="schwarz">title</span><span class="schwarz">}</span><span class="schwarz"><br/></span>    td #<span class="schwarz">{</span><span class="schwarz">movie</span><span class="schwarz">.</span><span class="schwarz">year</span><span class="schwarz">}</span><span class="schwarz"><br/></span>    <span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter">td <br/>      <span class="dunkelblau">-</span><span class="schwarz"> </span><span class="rot">const</span><span class="schwarz"> one </span><span class="dunkelblau">=</span><span class="schwarz"> movie.userRating </span><span class="dunkelblau">&gt;=</span><span class="schwarz"> 1 </span><span class="dunkelblau">?</span><span class="schwarz"> </span><span class="hellblau">'</span></samp></span><img alt="inline image" class="inline_image" src="bilder/star-filled.png"/><span class="bold"><samp class="listingcharacter listingcharacter">'<span class="schwarz">: </span><span class="hellblau">'</span></samp></span><img alt="inline image" class="inline_image" src="bilder/star-unfilled.png"/><span class="bold"><samp class="listingcharacter listingcharacter">'<span class="schwarz"><br/></span>      a(href<span class="dunkelblau">=</span><span class="hellblau">"/movie/rate/"</span><span class="schwarz"> </span><span class="dunkelblau">+</span><span class="schwarz"> movie.id </span><span class="dunkelblau">+</span><span class="schwarz"> </span><span class="hellblau">"/1"</span><span class="schwarz">) #{one}</span><br/>      <span class="dunkelblau">-</span><span class="schwarz"> </span><span class="rot">const</span><span class="schwarz"> two </span><span class="dunkelblau">=</span><span class="schwarz"> movie.userRating </span><span class="dunkelblau">&gt;=</span><span class="schwarz"> 2 </span><span class="dunkelblau">?</span><span class="schwarz"> </span><span class="hellblau">'</span></samp></span><img alt="inline image" class="inline_image" src="bilder/star-filled.png"/><span class="bold"><samp class="listingcharacter listingcharacter">'<span class="schwarz">: </span><span class="hellblau">'</span></samp></span><img alt="inline image" class="inline_image" src="bilder/star-unfilled.png"/><span class="bold"><samp class="listingcharacter listingcharacter">'<span class="schwarz"><br/></span>      a(href<span class="dunkelblau">=</span><span class="hellblau">"/movie/rate/"</span><span class="schwarz"> </span><span class="dunkelblau">+</span><span class="schwarz"> movie.id </span><span class="dunkelblau">+</span><span class="schwarz"> </span><span class="hellblau">"/2"</span><span class="schwarz">) #{two}</span><br/>      <span class="dunkelblau">-</span><span class="schwarz"> </span><span class="rot">const</span><span class="schwarz"> three </span><span class="dunkelblau">=</span><span class="schwarz"> movie.userRating </span><span class="dunkelblau">&gt;=</span><span class="schwarz"> 3 </span><span class="dunkelblau">?</span><span class="schwarz"> </span><span class="hellblau">'</span></samp></span><img alt="inline image" class="inline_image" src="bilder/star-filled.png"/><span class="bold"><samp class="listingcharacter listingcharacter">'<span class="schwarz">: </span><span class="hellblau">'</span></samp></span><img alt="inline image" class="inline_image" src="bilder/star-unfilled.png"/><span class="bold"><samp class="listingcharacter listingcharacter">'<span class="schwarz"><br/></span>      a(href<span class="dunkelblau">=</span><span class="hellblau">"/movie/rate/"</span><span class="schwarz"> </span><span class="dunkelblau">+</span><span class="schwarz"> movie.id </span><span class="dunkelblau">+</span><span class="schwarz"> </span><span class="hellblau">"/3"</span><span class="schwarz">) #{three}</span><br/>      <span class="dunkelblau">-</span><span class="schwarz"> </span><span class="rot">const</span><span class="schwarz"> four </span><span class="dunkelblau">=</span><span class="schwarz"> movie.userRating </span><span class="dunkelblau">&gt;=</span><span class="schwarz"> 4 </span><span class="dunkelblau">?</span><span class="schwarz"> </span><span class="hellblau">'</span></samp></span><img alt="inline image" class="inline_image" src="bilder/star-filled.png"/><span class="bold"><samp class="listingcharacter listingcharacter">'<span class="schwarz">: </span><span class="hellblau">'</span></samp></span><img alt="inline image" class="inline_image" src="bilder/star-unfilled.png"/><span class="bold"><samp class="listingcharacter listingcharacter">'<span class="schwarz"><br/></span>      a(href<span class="dunkelblau">=</span><span class="hellblau">"/movie/rate/"</span><span class="schwarz"> </span><span class="dunkelblau">+</span><span class="schwarz"> movie.id </span><span class="dunkelblau">+</span><span class="schwarz"> </span><span class="hellblau">"/4"</span><span class="schwarz">) #{four}</span><br/>      <span class="dunkelblau">-</span><span class="schwarz"> </span><span class="rot">const</span><span class="schwarz"> five </span><span class="dunkelblau">=</span><span class="schwarz"> movie.userRating </span><span class="dunkelblau">&gt;=</span><span class="schwarz"> 5 </span><span class="dunkelblau">?</span><span class="schwarz"> </span><span class="hellblau">'</span></samp></span><img alt="inline image" class="inline_image" src="bilder/star-filled.png"/><span class="bold"><samp class="listingcharacter listingcharacter">'<span class="schwarz">: </span><span class="hellblau">'</span></samp></span><img alt="inline image" class="inline_image" src="bilder/star-unfilled.png"/><span class="bold"><samp class="listingcharacter listingcharacter">'<span class="schwarz"><br/></span>      a(href<span class="dunkelblau">=</span><span class="hellblau">"/movie/rate/"</span><span class="schwarz"> </span><span class="dunkelblau">+</span><span class="schwarz"> movie.id </span><span class="dunkelblau">+</span><span class="schwarz"> </span><span class="hellblau">"/5"</span><span class="schwarz">) #{five}</span><br/> <br/>      <span class="dunkelblau">-</span><span class="schwarz"> </span><span class="rot">const</span><span class="schwarz"> overall </span><span class="dunkelblau">=</span><span class="schwarz"> Math.round((movie.sumOfRatings </span><span class="dunkelblau">/</span><span class="schwarz"> </span></samp></span><img alt="inline image" class="inline_image" src="bilder/umbruchpfeil.png"/><span class="bold"><samp class="listingcharacter listingcharacter"><br/>          movie.numOfRatings) <span class="dunkelblau">*</span><span class="schwarz"> 10) </span><span class="dunkelblau">/</span><span class="schwarz"> 10</span><br/>      span (#{isNaN(overall) <span class="dunkelblau">?</span><span class="schwarz"> 0 : overall})</span><br/> <br/></samp></span>    td<br/>      a(href<span class="dunkelblau">=</span><span class="hellblau">"/movie/delete/"</span><span class="schwarz"> </span><span class="dunkelblau">+</span><span class="schwarz"> movie.id) </span><span class="rot">delete</span><span class="schwarz"><br/></span>    td<br/>      a(href<span class="dunkelblau">=</span><span class="hellblau">"/movie/form/"</span><span class="schwarz"> </span><span class="dunkelblau">+</span><span class="schwarz"> movie.id) edit </span><span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 9.17</b>    
            Customizing the List View (movie/views/list-item.pug)</p>
            <p class="standard">In this extension, you add a new column to the table that contains five links for rating. The link points to a new route to which you pass the ID of the movie you want to rate and the rating number. Depending on the rating the user has given so far, either a <img alt="inline image" class="inline_image" src="bilder/star-filled.png"/> or a <img alt="inline image" class="inline_image" src="bilder/star-unfilled.png"/> is displayed. The average rating is also displayed next to these links. This is the sum total of all ratings divided by the number of ratings. The <samp class="listingcharacter listingcharacter">movie</samp> object passed to the view must therefore be extended with the appropriate information. In the next step, you need to define the route for the assessment. This happens in the <span class="italic">movie/index.js</span> file, as shown in <span class="crossreference "><a href="09_004.html#l9.18">Listing 9.18</a></span>.</p>
            <div class="listing " id="l9.18"><pre><span class="rot"><a id="p291"/>import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> Router </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'express'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  listAction<span class="schwarz">,</span><span class="schwarz"><br/></span>  removeAction<span class="schwarz">,</span><span class="schwarz"><br/></span>  formAction<span class="schwarz">,</span><span class="schwarz"><br/></span>  saveAction<span class="schwarz">,</span><span class="schwarz"><br/></span>  <span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter">rateAction,</samp></span><br/>} <span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./controller.js'</span><span class="schwarz">;</span><br/> <br/><span class="rot">const</span><span class="schwarz"> router </span><span class="dunkelblau">=</span><span class="schwarz"> Router();</span><br/> <br/>router.get(<span class="hellblau">'/'</span><span class="schwarz">, listAction);</span><br/>router.get(<span class="hellblau">'/delete/:id'</span><span class="schwarz">, removeAction);</span><br/>router.get(<span class="hellblau">'/form/:id?'</span><span class="schwarz">, formAction);</span><br/>router.post(<span class="hellblau">'/save'</span><span class="schwarz">, saveAction);</span><br/><span class="bold"><samp class="listingcharacter listingcharacter">router.get(<span class="hellblau">'/rate/:movie/:rating'</span><span class="schwarz">, rateAction);</span><br/> </samp></span><br/><span class="rot">export</span><span class="schwarz"> { router }; </span><span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 9.18</b>    
            Route Definition for Rating (movie/index.js)</p>
            <p class="standard">The <span class="italic">/rate</span> route contains the aforementioned two variables, <samp class="listingcharacter listingcharacter">movie</samp> and <samp class="listingcharacter listingcharacter">rating</samp>, which you can use in the controller to access<a class="indexanchor" id="i09_51"/> the values submitted by the user. This route is based on the <samp class="listingcharacter listingcharacter">rateAction</samp> of the movie controller in the <span class="italic">movie/controller.js</span> file. The implementation of this function is shown in <span class="crossreference "><a href="09_004.html#l9.19">Listing 9.19</a></span>.</p>
            <div class="listing " id="l9.19"><pre><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> dirname </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'path'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> fileURLToPath </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'url'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> getAll</span><span class="schwarz">,</span><span class="schwarz"> remove</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="rot">get</span><span class="schwarz">,</span><span class="schwarz"> save</span><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter">, rate</samp></span> } <span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./model.js'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> { render } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./view.js'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> { render </span><span class="rot">as</span><span class="schwarz"> form } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./form.js'</span><span class="schwarz">;</span><br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> listAction(request, response) {...}</span><br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> removeAction(request, response) {...}</span><br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> formAction(request, response) {...}</span><br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> saveAction(request, response) {...}</span><br/> <br/><span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> rateAction(request, response) {</span><br/>  <span class="rot">const</span><span class="schwarz"> rating </span><span class="dunkelblau">=</span><span class="schwarz"> {</span><br/>    movie: parseInt(request.params.movie, 10),<br/>    user: request.user.id,<br/>    rating: parseInt(request.params.rating, 10),<br/><a id="p292"/>  };<br/>  <span class="rot">await</span><span class="schwarz"> rate(rating);</span><br/>  response.redirect(request.baseUrl);<br/>}</samp></span> <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 9.19</b>    
            Implementing “rateAction” in the Controller (movie/controller.js)</p>
            <p class="standard">When implementing <samp class="listingcharacter listingcharacter">rateAction</samp>, you first assemble a new object based on the information passed by the user via the newly created link and from the user ID from the session. You then pass this object to the <samp class="listingcharacter listingcharacter">rate</samp> function of the model, which makes sure that the data gets saved. After successful saving, you redirect the user back to the movie list to view the updated representation. Then you need to make two changes to the model. This way, you ensure first that the rating data is available in the list view, and, second, that the ratings are correctly stored in the database. Here you have to make sure that there are no duplicates<a class="indexanchor" id="i09_52"/> when a user changes a rating.</p>
            <div class="listing " id="l9.20"><pre><span class="rot">import</span><span class="schwarz"> sqlite </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'sqlite3'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="rot">const</span><span class="schwarz"> db </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">new sqlite</span><span class="schwarz">.Database(</span><span class="hellblau">'./movie.db'</span><span class="schwarz">);</span><span class="schwarz"><br/></span> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">getAll(</span><span class="schwarz">userId</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="rot">return</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">Promise((</span><span class="schwarz">resolve</span><span class="schwarz">,</span><span class="schwarz"> reject</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">const</span><span class="schwarz"> query </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="violett">`SELECT Movies.*, </span><br/>      count(Ratings.rating) AS numOfRatings, <br/>      sum(Ratings.rating) AS sumOfRatings, <br/>      r.rating AS userRating <br/>    FROM Movies <br/>    LEFT JOIN Ratings ON Movies.id = Ratings.movie <br/>    LEFT JOIN Ratings AS r ON Movies.id = r.movie AND r.user = ? <br/>    WHERE Movies.user = ? OR public = 1<br/>    GROUP BY Movies.id;`<span class="schwarz">;</span><br/> </samp></span><br/>    db.all(query, [userId, <span class="bold"><samp class="listingcharacter listingcharacter">userId</samp></span>], (error, results) <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>      <span class="rot">if</span><span class="schwarz"> (error) {</span><br/>        reject(error);<br/>      } <span class="rot">else</span><span class="schwarz"> {</span><br/>        resolve(results);<br/>      }<br/>    });<br/>  });<br/>}<br/> <br/><span class="rot">function</span><span class="schwarz"> insert(movie, userId) {...}</span><br/> <br/><span class="rot">function</span><span class="schwarz"> update(movie, userId) {...}</span><br/> <br/><span class="rot"><a id="p293"/>export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> get(id, userId) {...}</span><br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> save(movie, userId) {...}</span><br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> remove(id, userId) {...}</span><br/> <br/><span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> rate(rating) {</span><br/>  <span class="rot">const</span><span class="schwarz"> deleteQuery </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="hellblau">'DELETE FROM Ratings WHERE movie = ? AND user = ?'</span><span class="schwarz">;</span><br/>  <span class="rot">await</span><span class="schwarz"> db.run(deleteQuery, [rating.movie, rating.user]);</span><br/>  <span class="rot">const</span><span class="schwarz"> insertQuery </span><span class="dunkelblau">=</span><span class="schwarz"><br/></span>    <span class="hellblau">'INSERT INTO Ratings (movie, user, rating) VALUES (?, ?, ?)'</span><span class="schwarz">;</span><br/>  <span class="rot">return</span><span class="schwarz"> db.run(insertQuery, [rating.movie, rating.user, rating.rating]);</span><br/>}</samp></span> <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 9.20</b>    
            Extending the Model with the Rating Function (movie/model.js)</p>
            <p class="standard">To aggregate<a class="indexanchor" id="i09_53"/> the information, you use two <samp class="listingcharacter listingcharacter">LEFT JOIN</samp> statements to get the information you need. With this query, you extend the objects of the resulting movie array with the number of the respective ratings, with the sum of the ratings, and with the rating that the user himself has submitted.</p>
            <p class="standard">The second adjustment concerns implementing the <samp class="listingcharacter listingcharacter">rate</samp> function. In this context, you must first make sure that the user can’t submit duplicate ratings for a movie by deleting all records with the combination of user ID and movie. Then you must create a new data record and resolve the promise. With these adjustments, you can now submit ratings for movies as a logged-in user in your application. The list view is shown in <span class="crossreference "><a href="09_004.html#f9.2">Figure 9.2</a></span>.</p>
            <div class="imagebox figure-type"><a href="img-f9.2.html" id="f9.2"><img alt="List View with Ratings" id="img-f9.2" src="bilderklein/klein09_002.png"/></a></div>
            <p class="caption "><b>Figure 9.2</b>    
            List View with Ratings</p>
        
    </div><p class="signatur"/>
                    </body>
                </html>