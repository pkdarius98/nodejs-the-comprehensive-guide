<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
                    
        <head><meta content="application/xhtml+xml; charset=utf-8" http-equiv="Content-Type"/>
            <meta content="application/xhtml+xml; charset=utf-8" name="content-type"/>
            <meta content="Node.js Modules" name="title"/>
            <meta content="Sebastian Springer" name="author"/>
            <meta content="Rheinwerk Publishing" name="publisher"/>
            <meta content="© 2022 by Rheinwerk Publishing Inc., Boston (MA)" name="copyright"/>
            <meta content="Node.js - The Comprehensive Guide - Node.js Modules" name="description"/>
            <meta content="en" name="language"/>
            <title>Node.js Modules</title>
            <link href="common/main.css" rel="stylesheet" type="text/css"/>
<meta content="urn:uuid:e0000000-0000-0000-0000-000029756394" name="Adept.expected.resource"/>
        </head>
    


                    <body class="office_us type_kapitel">
                        <div id="main">
        <h2 class="t2" id="h4.4">4.4    Creating and Using<a class="indexanchor" id="i04_122"/> Your Own Modules</h2>
        <p class="standard">If you’re working on a Node.js application, you should make it as modular as possible; that is, divide your source code into several files. One of the most important reasons for <a id="p125"/>this type of structuring<a class="indexanchor" id="i04_123"/> is clarity. In a file of several thousand lines of source code, finding specific code sections becomes increasingly difficult. It also makes it nearly impossible to reuse<a class="indexanchor" id="i04_124"/> code blocks across applications. But reusability within an application is also much more convenient with self-contained modules, each in its own file. Once your application becomes more extensive and complex, and areas with self-contained functionality begin to emerge that can be communicated with via uniform interfaces, the time is right to outsource this source code and integrate it as a module. A sure sign to start modularizing<a class="indexanchor" id="i04_125"/> is when you start copying entire blocks of code. In this case, you should swap out the code block and generalize it so that it can be used in multiple places.</p>
        
            <h3 class="t3" id="h4.4.1">4.4.1    Modules in Node.js: CommonJS</h3>
            <p class="standard">For your Node.js application, this principle should be followed: one structure<a class="indexanchor" id="i04_126"/>, one file. This means that all logical units of your application are located in their own files. The advantage here is that each file deals with only one topic and has only one defined interface to the rest of the application, so the different parts of your application can be located quickly and easily.</p>
            <div class="box box_standard">
                <h6 class="boxheading">Loose Coupling<a class="indexanchor" id="i04_127"/>, Tight Cohesion<a class="indexanchor" id="i04_128"/></h6>
                <p class="standard first">This type of modularization uses the principle of <span class="italic">loose coupling</span>, which means that the structures (i.e., functions, objects, or classes) of an application are only loosely connected via interfaces<a class="indexanchor" id="i04_129"/>. This in turn has the benefit that you can replace individual modules without having to rebuild the entire system.</p>
                <p class="standard">The components of the individual modules must be closely related to each other, which is referred to as <span class="italic">tight cohesion</span>. This means that only the logic actually belonging to the topic of the module is placed in a module. Everything else is swapped to a separate module and addressed via interfaces.</p>
                <p class="standard last">As a result, you have an application that consists of numerous manageable modules, which ultimately leads to improved maintainability, greater parallelizability of tasks, better testability of the source code, and better responsiveness to changing requirements.</p>
            </div>
            <p class="standard">Normally, when you build your application, you group your modules according to topics. When outsourcing blocks of code that are used multiple times, the trick is to find the right balance between generalization<a class="indexanchor" id="i04_130"/> and effort. As a guideline here, you should keep in mind to always primarily solve your current problem and only ever generalize as much as is necessary for your application. If you write code that is too generic, it automatically becomes more complex, harder to read, and more expensive to implement.</p>
            <p class="standard">In practice, your modules usually export either classes that you instantiate in other modules or functions and objects you can interact with directly. A good example is provided by the modules that Node.js makes available to you.</p>
        
        
            <h3 class="t3" id="h4.4.2">4.4.2    <a id="p126"/>Custom Node.js Modules</h3>
            <p class="standard">In the following example, you’ll implement a function to count the frequency of words in a sentence. This function is exported via the module system. The first variant shows the implementation in the CommonJS module system, and the second shows it in the ECMAScript module system.</p>
            <p class="standard">First, in <span class="crossreference "><a href="04_004.html#l4.24">Listing 4.24</a></span>, a period and comma are stored in a regular expression to ignore these characters during processing. The space character as word separator is also stored in a constant. The <samp class="listingcharacter listingcharacter">wordCount</samp> function itself accepts a string in which you first replace periods and commas with an empty string. The string prepared in this way is converted to lowercase to ignore case sensitivity. Then you use the <samp class="listingcharacter listingcharacter">split</samp> method to convert the string into an array of words. The actual counting of words is carried out in the <samp class="listingcharacter listingcharacter">reduce</samp> method. An empty object is used as the start value. The individual words are used as keys in the object. For each word, either an existing value is increased by one or the initial value is set to one if the word doesn’t yet exist as a key in the object.</p>
            <div class="listing " id="l4.24"><pre><span class="rot">const</span><span class="schwarz"> ignore </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="dunkelblau">/</span><span class="schwarz">[</span><span class="schwarz">\</span><span class="schwarz">.,]</span><span class="dunkelblau">/</span><span class="schwarz">g</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">const</span><span class="schwarz"> separator </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="hellblau">' '</span><span class="schwarz">;</span><span class="schwarz"><br/></span>module<span class="schwarz">.</span><span class="schwarz">exports </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">wordCount(</span><span class="schwarz">sentence</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="rot">return</span><span class="schwarz"> sentence</span><br/>    <span class="schwarz">.replace(</span><span class="schwarz">ignore</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="hellblau">''</span><span class="schwarz">)</span><span class="schwarz"><br/></span>    <span class="schwarz">.toLowerCase()</span><span class="schwarz"><br/></span>    <span class="schwarz">.split(</span><span class="schwarz">separator</span><span class="schwarz">)</span><span class="schwarz"><br/></span>    <span class="schwarz">.reduce((</span><span class="schwarz">prev</span><span class="schwarz">,</span><span class="schwarz"> current</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>      prev<span class="schwarz">[</span><span class="schwarz">current</span><span class="schwarz">]</span><span class="schwarz"> </span><span class="dunkelblau">=</span><span class="schwarz"> prev</span><span class="schwarz">[</span><span class="schwarz">current</span><span class="schwarz">]</span><span class="schwarz"> </span><span class="dunkelblau">+</span><span class="schwarz"> </span><span class="schwarz">1</span><span class="schwarz"> </span><span class="dunkelblau">||</span><span class="schwarz"> </span><span class="schwarz">1;</span><span class="schwarz"><br/></span>      <span class="rot">return</span><span class="schwarz"> prev</span><span class="schwarz">;</span><span class="schwarz"><br/></span>    <span class="schwarz">},</span><span class="schwarz"> </span><span class="schwarz">{});</span><span class="schwarz"><br/></span><span class="schwarz">};</span><span class="schwarz"> </span></pre></div>
            <p class="caption "><b>Listing 4.24</b>    
            Implementing the “wordCount" Function as a CommonJS Module (word-count.js)</p>
            <p class="standard">The function is made available as an interface of the module using the <samp class="listingcharacter listingcharacter">module.exports</samp> object, so you can include it in your application using the <samp class="listingcharacter listingcharacter">require</samp> function.</p>
            <p class="standard">The source code from <span class="crossreference "><a href="04_004.html#l4.25">Listing 4.25</a></span> shows how you can use the module you just created. Use the <samp class="listingcharacter listingcharacter">wc = require('./word-count')</samp> statement to include the module in the current application. This assumes that you’ve saved the source code from <span class="crossreference "><a href="04_004.html#l4.24">Listing 4.24</a></span> in a file named <span class="italic">word-count.js</span>. All functions and objects that you’ve assigned as properties to the <samp class="listingcharacter listingcharacter">module.exports</samp> object in the module are available.</p>
            <div class="listing " id="l4.25"><pre><span class="rot">const</span><span class="schwarz"> wc </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="schwarz">require(</span><span class="hellblau">'./word-count'</span><span class="schwarz">);</span><span class="schwarz"><br/></span><span class="rot">const</span><span class="schwarz"> sentence </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="hellblau">'Where there is much light, there is also much shadow.'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">const</span><span class="schwarz"> wordCount </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="schwarz">wc(</span><span class="schwarz">sentence</span><span class="schwarz">);</span><span class="schwarz"><br/></span><span class="magenta">console</span><span class="schwarz">.log(</span><span class="schwarz">sentence</span><span class="schwarz">);</span><span class="schwarz"><br/></span><span class="rot">for</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="rot">let</span><span class="schwarz"> i </span><span class="rot">in</span><span class="schwarz"> wordCount</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span><a id="p127"/>  <span class="magenta">console</span><span class="schwarz">.log(</span><span class="schwarz">wordCount</span><span class="schwarz">[</span><span class="schwarz">i</span><span class="schwarz">]</span><span class="schwarz"> </span><span class="dunkelblau">+</span><span class="schwarz"> </span><span class="hellblau">' x '</span><span class="schwarz"> </span><span class="dunkelblau">+</span><span class="schwarz"> i</span><span class="schwarz">);</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"> </span></pre></div>
            <p class="caption "><b>Listing 4.25</b>    
            Using the “wordCount” Module (index.js)</p>
            <div class="box box_standard">
                <h6 class="boxheading">Naming Files<a class="indexanchor" id="i04_131"/> and JavaScript Structures</h6>
                <p class="standard first">Unlike JavaScript, not all file systems are case sensitive<a class="indexanchor" id="i04_132"/>. To prevent problems in this context, you should only use lowercase letters when naming your files. If a file or directory name consists of several words, separate them with a hyphen. The CamelCase designation, on the other hand, is now much more common. Here, the individual words in the file name are introduced with a capital letter.</p>
                <p class="standard last">Note that you can’t use hyphens in variable names in JavaScript. This is possible via the array notation when accessing object properties, but you should still avoid it. JavaScript objects and functions begin with a lowercase letter. Otherwise, you can use the CamelCase notation. Only class names start with a capital letter.</p>
            </div>
            <p class="standard">As you’ve seen in <span class="crossreference "><a href="04_004.html#l4.25">Listing 4.25</a></span>, only the contents and interfaces of a module that are made available through the <samp class="listingcharacter listingcharacter">exports</samp> object are published. All other variables, functions, or classes defined within a module are only available in that module. So, in this case, you don’t have to worry about keeping the global scope of your application clean.</p>
        
        
            <h3 class="t3" id="h4.4.3">4.4.3    Modules in Node.js: ECMAScript</h3>
            <p class="standard">So far, we’ve used the <span class="italic">.mjs</span><a class="indexanchor" id="i04_133"/> file extension for ECMAScript modules in all examples. In this example, we use the <samp class="listingcharacter listingcharacter">type</samp><a class="indexanchor" id="i04_134"/> field in the <span class="italic">package.json</span> file to activate the ECMAScript module system. To do this, you must first run the <samp class="listingcharacter listingcharacter">npm init -y</samp> command in the directory where you want to create your initial file. This command creates a standard <span class="italic">package.json</span>. Then you must insert the <samp class="listingcharacter listingcharacter">type</samp> field, as shown in <span class="crossreference "><a href="04_004.html#l4.26">Listing 4.26</a></span>.</p>
            <div class="listing " id="l4.26"><pre><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="hellblau">"name"</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">"node-book"</span><span class="schwarz">,</span><span class="schwarz"><br/></span>  <span class="hellblau">"version"</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">"1.0.0"</span><span class="schwarz">,</span><span class="schwarz"><br/></span>  <span class="hellblau">"description"</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">""</span><span class="schwarz">,</span><span class="schwarz"><br/></span>  <span class="hellblau">"main"</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">"index.js"</span><span class="schwarz">,</span><span class="schwarz"><br/></span>  <span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="hellblau">"type"</span><span class="schwarz">: </span><span class="hellblau">"module"</span><span class="schwarz">,</span></samp></span><br/>  <span class="hellblau">"scripts"</span><span class="schwarz">: {</span><br/>    <span class="hellblau">"test"</span><span class="schwarz">: </span><span class="hellblau">"echo \"</span><span class="schwarz">Error: no test specified\</span><span class="hellblau">" &amp;&amp; exit 1"</span><span class="schwarz"><br/></span>  },<br/>  <span class="hellblau">"keywords"</span><span class="schwarz">: [],</span><br/>  <span class="hellblau">"author"</span><span class="schwarz">: </span><span class="hellblau">""</span><span class="schwarz">,</span><br/>  <span class="hellblau">"license"</span><span class="schwarz">: </span><span class="hellblau">"ISC"</span><span class="schwarz"><br/></span>} <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 4.26</b>    
            “package.json” with “type” Field</p>
            <p class="standard"><a id="p128"/>With this preparation, you can transfer the previous example to the ECMAScript module system with only a few adjustments. In <span class="crossreference "><a href="04_004.html#l4.27">Listing 4.27</a></span>, you can find the customized source code of the <samp class="listingcharacter listingcharacter">wordCount</samp> module. By making adjustments to the <span class="italic">package.json</span> file, you can also keep the <span class="italic">.js</span> file extension.</p>
            <div class="listing " id="l4.27"><pre><span class="rot">const</span><span class="schwarz"> ignore </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="dunkelblau">/</span><span class="schwarz">[</span><span class="schwarz">\</span><span class="schwarz">.,]</span><span class="dunkelblau">/</span><span class="schwarz">g</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">const</span><span class="schwarz"> separator </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="hellblau">' '</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">export</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> wordCount(sentence) {</span></samp></span><br/>  <span class="rot">return</span><span class="schwarz"> sentence</span><br/>    .replace(ignore, <span class="hellblau">''</span><span class="schwarz">)</span><br/>    .toLowerCase()<br/>    .split(separator)<br/>    .reduce((prev, current) <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>      prev[current] <span class="dunkelblau">=</span><span class="schwarz"> prev[current] </span><span class="dunkelblau">+</span><span class="schwarz"> 1 </span><span class="dunkelblau">||</span><span class="schwarz"> 1;</span><br/>      <span class="rot">return</span><span class="schwarz"> prev;</span><br/>    }, {});<br/>} <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 4.27</b>    
            “wordCount” Module as ECMAScript Module (word-count.js)</p>
            <p class="standard">The change here is that instead of assigning it to <samp class="listingcharacter listingcharacter">module.exports</samp>, you use the <samp class="listingcharacter listingcharacter">export</samp> keyword. In this case, you create a named export that you can use in your application. The customization in <span class="crossreference "><a href="04_004.html#l4.25">Listing 4.25</a></span> is also limited to just one line, as you can see in <span class="crossreference "><a href="04_004.html#l4.28">Listing 4.28</a></span>.</p>
            <div class="listing " id="l4.28"><pre><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">import</span><span class="schwarz"> { wordCount </span><span class="rot">as</span><span class="schwarz"> wc } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./word-count.js'</span><span class="schwarz">;</span></samp></span><br/><span class="rot">const</span><span class="schwarz"> sentence </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="hellblau">'Where there is much light, there is also much shadow.'</span><span class="schwarz">;</span><br/><span class="rot">const</span><span class="schwarz"> wordCount </span><span class="dunkelblau">=</span><span class="schwarz"> wc(sentence);</span><br/><span class="magenta">console</span><span class="schwarz">.log(sentence);</span><br/><span class="rot">for</span><span class="schwarz"> (</span><span class="rot">let</span><span class="schwarz"> i </span><span class="rot">in</span><span class="schwarz"> wordCount) {</span><br/>  <span class="magenta">console</span><span class="schwarz">.log(wordCount[i] </span><span class="dunkelblau">+</span><span class="schwarz"> </span><span class="hellblau">' x '</span><span class="schwarz"> </span><span class="dunkelblau">+</span><span class="schwarz"> i);</span><br/>} <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 4.28</b>    
            Integrating the “wordCount" Module</p>
            <p class="standard">In <span class="crossreference "><a href="04_004.html#l4.28">Listing 4.28</a></span>, you import the <samp class="listingcharacter listingcharacter">wordCount</samp> function from the <span class="italic">word-count.js</span> file using the <samp class="listingcharacter listingcharacter">import</samp> keyword. Because this name is already used in the source code, the function is renamed to <samp class="listingcharacter listingcharacter">wc</samp> using the <samp class="listingcharacter listingcharacter">as</samp> keyword. The remainder of the source code remains unchanged.</p>
            <div class="box box_standard">
                <h6 class="boxheading">Required File Name Extension<a class="indexanchor" id="i04_135"/></h6>
                <p class="standard first">As you’ve seen in the examples in this chapter, specifying the file name extension is mandatory when loading modules in the ECMAScript module system. This applies to both absolute and relative path specifications.</p>
                <p class="standard last">If you omit the extension, Node.js returns a corresponding error.</p>
            </div>
        
        
            <h3 class="t3" id="h4.4.4">4.4.4    <a id="p129"/>Exporting Different Types<a class="indexanchor" id="i04_136"/> of Data</h3>
            <p class="standard">When using the Node.js module system, you’re not limited to just using functions, as you can export any type of data. So it’s possible that you export classes or objects or just provide simple values like a string or a number.</p>
            <p class="standard"><span class="crossreference "><a href="04_004.html#l4.29">Listing 4.29</a></span> contains an example in which an object with several functions is exported.</p>
            <div class="listing " id="l4.29"><pre><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">add(</span><span class="schwarz">a</span><span class="schwarz">,</span><span class="schwarz"> b</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="rot">return</span><span class="schwarz"> a </span><span class="dunkelblau">+</span><span class="schwarz"> b</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"><br/></span><br/><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">subtract(</span><span class="schwarz">a</span><span class="schwarz">,</span><span class="schwarz"> b</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="rot">return</span><span class="schwarz"> a </span><span class="dunkelblau">-</span><span class="schwarz"> b</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"><br/></span><br/>module<span class="schwarz">.</span><span class="schwarz">exports </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> add</span><span class="schwarz">,</span><span class="schwarz">  subtract </span><span class="schwarz">};</span><span class="schwarz"> </span></pre></div>
            <p class="caption "><b>Listing 4.29</b>    
            Exporting Objects</p>
            <p class="standard"><span class="crossreference "><a href="04_004.html#l4.30">Listing 4.30</a></span> shows the same functionality, but in ECMAScript module syntax.</p>
            <div class="listing " id="l4.30"><pre><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">add(</span><span class="schwarz">a</span><span class="schwarz">,</span><span class="schwarz"> b</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="rot">return</span><span class="schwarz"> a </span><span class="dunkelblau">+</span><span class="schwarz"> b</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"><br/></span><br/><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">subtract(</span><span class="schwarz">a</span><span class="schwarz">,</span><span class="schwarz"> b</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="rot">return</span><span class="schwarz"> a </span><span class="dunkelblau">-</span><span class="schwarz"> b</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"><br/></span><br/><span class="rot">export</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> add</span><span class="schwarz">,</span><span class="schwarz"> subtract </span><span class="schwarz">};</span><span class="schwarz"> </span></pre></div>
            <p class="caption "><b>Listing 4.30</b>    
            Exporting Objects in ECMAScript Modules</p>
            <p class="standard">In the examples shown in <span class="crossreference "><a href="04_004.html#l4.29">Listing 4.29</a></span> and <span class="crossreference "><a href="04_004.html#l4.30">Listing 4.30</a></span>, you can see that implementation and export are separated processes. This is a best practice<a class="indexanchor" id="i04_137"/> to make the source code clearer. You should always place the exports at the end of the file so that all developers working with your code will know where to find the module’s interface definition. Another unique feature about this example is that it uses the shorthand notation introduced with ECMAScript 2015 for object properties, where the property name and the variable containing the value have the same designation.</p>
            <p class="standard">There are cases when you need to manipulate the behavior of a module from the outside. You can do this by exporting a function that receives arguments from outside and generates a return value based on them. The source code from <span class="crossreference "><a href="04_004.html#l4.31">Listing 4.31</a></span> clarifies the example.</p>
            <div class="listing " id="l4.31"><pre><span class="rot"><a id="p130"/>export</span><span class="schwarz"> </span><span class="rot">default</span><span class="schwarz"> </span><span class="schwarz">function(</span><span class="schwarz">DEBUG</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="rot">return</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    options<span class="schwarz">:</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>      outputStyle<span class="schwarz">:</span><span class="schwarz"> DEBUG </span><span class="dunkelblau">?</span><span class="schwarz"> </span><span class="hellblau">'expanded'</span><span class="schwarz"> </span><span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'compressed'</span><span class="schwarz">,</span><span class="schwarz"><br/></span>      sourceMap<span class="schwarz">:</span><span class="schwarz"> DEBUG</span><span class="schwarz">,</span><span class="schwarz"><br/></span>      sourceMapEmbed<span class="schwarz">:</span><span class="schwarz"> </span><span class="rot">true</span><span class="schwarz">,</span><span class="schwarz"><br/></span>    <span class="schwarz">},</span><span class="schwarz"><br/></span>    files<span class="schwarz">:</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>      <span class="hellblau">'style/style.css'</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'style/style.scss'</span><span class="schwarz">,</span><span class="schwarz"><br/></span>    <span class="schwarz">},</span><span class="schwarz"><br/></span>  <span class="schwarz">};</span><span class="schwarz"><br/></span><span class="schwarz">};</span><span class="schwarz"> </span></pre></div>
            <p class="caption "><b>Listing 4.31</b>    
            Manipulating Modules</p>
            <p class="standard">In <span class="crossreference "><a href="04_004.html#l4.31">Listing 4.31</a></span>, you transfer a Boolean value that affects the returned object. This is the swapped configuration of parts of a grunt configuration for the CSS preprocessor, Sass.</p>
        
        
            <h3 class="t3" id="h4.4.5">4.4.5    The modules Module<a class="indexanchor" id="i04_138"/></h3>
            <p class="standard">The <samp class="listingcharacter listingcharacter">modules</samp> module represents the CommonJS module loader<a class="indexanchor" id="i04_139"/>. This module shouldn’t be used in conjunction with ECMAScript modules.</p>
            <p class="standard">The two most important components of the <samp class="listingcharacter listingcharacter">modules</samp> module are the <samp class="listingcharacter listingcharacter">exports</samp> or <samp class="listingcharacter listingcharacter">module.exports</samp> object, which you can use to publish modules, and the <samp class="listingcharacter listingcharacter">require</samp> function, which you can use to include the module. In addition to these two core features, however, this module offers you a number of other functionalities that can be very helpful in the development and operation of modules. For this purpose, the Node.js platform provides you with the <samp class="listingcharacter listingcharacter">module</samp> object globally. If you use the ECMAScript module system, then this isn’t the case, and the <samp class="listingcharacter listingcharacter">module</samp> variable isn’t defined. You can use this object to query various information about the current module. First and foremost, the <samp class="listingcharacter listingcharacter">module.id</samp> and <samp class="listingcharacter listingcharacter">module.filename</samp> properties should be mentioned here. These two properties normally specify the absolute file name of the module. If you want to use this information as a basis, you should use the second variant, that is, <samp class="listingcharacter listingcharacter">module.filename</samp>. The <samp class="listingcharacter listingcharacter">module.id</samp><a class="indexanchor" id="i04_140"/> property contains the value <samp class="listingcharacter listingcharacter">.</samp> when you access it outside of a module, such as in the main file of your application. You can also use these two properties of the <samp class="listingcharacter listingcharacter">module</samp> object in the Node.js REPL. In this case, the <samp class="listingcharacter listingcharacter">id</samp> property has the value <samp class="listingcharacter listingcharacter">repl</samp>, and the <samp class="listingcharacter listingcharacter">filename</samp> has the value <samp class="listingcharacter listingcharacter">null</samp>.</p>
            <p class="standard">You can use the <samp class="listingcharacter listingcharacter">loaded</samp> property of the <samp class="listingcharacter listingcharacter">module</samp> object to find out if the current module has already been loaded. In this case, the value is <samp class="listingcharacter listingcharacter">true</samp>. If the current module hasn’t been loaded yet or is still in the load process, the value of this property is <samp class="listingcharacter listingcharacter">false</samp>.</p>
            <p class="standard">When a Node.js application is launched, the <samp class="listingcharacter listingcharacter">require.main</samp> property is automatically populated with the <samp class="listingcharacter listingcharacter">module</samp> object of the initial file. Therefore, you can access the file <a id="p131"/>name of the file that serves as the entry point to your application in each module via <samp class="listingcharacter listingcharacter">require.main.filename</samp>.</p>
            <p class="standard">In addition to this information, the <samp class="listingcharacter listingcharacter">modules</samp> module also contains data about the relationships between the modules, that is, which module was loaded by which other module or which modules are loaded by a particular module. The <samp class="listingcharacter listingcharacter">parent</samp> property of the <samp class="listingcharacter listingcharacter">module</samp> object provides information about the module that loaded the current module. Again, this information comes in the form of a <samp class="listingcharacter listingcharacter">module</samp> object, which means you have access to the <samp class="listingcharacter listingcharacter">id</samp> or <samp class="listingcharacter listingcharacter">filename</samp> properties of the parent module<a class="indexanchor" id="i04_141"/>, among others. The <samp class="listingcharacter listingcharacter">children</samp> property contains an array of modules that the current module loads via <samp class="listingcharacter listingcharacter">require</samp>. However, this only applies to your own modules. The core modules aren’t listed in the <samp class="listingcharacter listingcharacter">children</samp> array. The objects in this data structure have the same structure as the <samp class="listingcharacter listingcharacter">parent</samp> object.</p>
        
        
            <h3 class="t3" id="h4.4.6">4.4.6    Module Loader<a class="indexanchor" id="i04_142"/></h3>
            <p class="standard">The inclusion of modules is done either via the <samp class="listingcharacter listingcharacter">require</samp> function or via the <samp class="listingcharacter listingcharacter">import</samp> statement. For this purpose, you should commit the name of the file that contains the source code of the module. You can specify the file name both as an absolute name and relative to the current file.</p>
            <p class="standard">Assuming a directory structure<a class="indexanchor" id="i04_143"/> like the one in <span class="crossreference "><a href="04_004.html#l4.32">Listing 4.32</a></span>, that is, the two JavaScript files <span class="italic">word-count.js</span> and <span class="italic">index.js</span>, where <span class="italic">index.js</span> is the entry point to your application, your application is launched via the <samp class="listingcharacter listingcharacter">node index.js</samp> command. You can then include the <samp class="listingcharacter listingcharacter">word-count</samp> module either through a relative path using <samp class="listingcharacter listingcharacter">require('./word-count')</samp> or <samp class="listingcharacter listingcharacter">import wordCount from './word-count'</samp>, or via the absolute path, that is, using <samp class="listingcharacter listingcharacter">require('/srv/node/word-count/word-count')</samp> or <samp class="listingcharacter listingcharacter">import wordCount from '/srv/node/word-count/word-count'</samp>. As already mentioned, you should use the relative variant, which allows you to run the application on other systems or make it available to other people.</p>
            <div class="listing " id="l4.32"><pre><span class="bold">$ ls /srv/node/word-count</span><br/>word-count.js index.js package.json </pre></div>
            <p class="caption "><b>Listing 4.32</b>    
            Directory Listing of the “wordCount" Application</p>
            
                <h4 class="t4" id="h4.4.6.1">Resolving Node Package Manager Modules<a class="indexanchor" id="i04_144"/></h4>
                <p class="standard">When searching for npm modules, the CommonJS module loader and the ECMAScript module loader behave in the same way. You can load npm modules by not prefixing <span class="italic">/</span> or <span class="italic">./</span> to the module you want to load. In this case, the module loader either looks for a Node.js core module, or it searches<a class="indexanchor" id="i04_145"/> for a package with the corresponding name in the <span class="italic">node_modules</span> subdirectory of the current directory. If the package isn’t found there, an attempt is made one level higher to resolve the package name. In the directory structure from <span class="crossreference "><a href="04_004.html#l4.32">Listing 4.32</a></span> this means that the search will first take place in the <span class="italic">/srv/node/word-count/node_modules</span> directory, then in <span class="italic">/srv/node/node_modules</span>, and so <a id="p132"/>on until the module loader has reached the root directory. If the module loader can’t find the package in this directory structure, it searches in the directories specified in the <samp class="listingcharacter listingcharacter">NODE_PATH</samp> environment variable<a class="indexanchor" id="i04_146"/>. It also searches in the <span class="italic">&lt;home&gt;/.node_modules</span>, <span class="italic">&lt;home&gt;/.node_libraries</span>, and <span class="italic">&lt;install-prefix&gt;/lib/node</span> directories. This way of searching for modules allows you to install different versions of npm packages on your system and control which version the module loader should load via the placement of each package. This allows you to avoid version conflicts<a class="indexanchor" id="i04_147"/> caused by another application or library requiring a different version of a package.</p>
                <p class="standard">Depending on where you store the packages, you can influence the speed of the load process<a class="indexanchor" id="i04_148"/>. Best practice has been to install packages in the root directory of the application, if possible. Packages placed in the local <span class="italic">node_modules</span> directory are loaded fastest, avoiding a lengthy search process.</p>
                <p class="standard">The following list briefly summarizes again in which directories packages are searched for in the example:</p>
                <ul>
                    <li>
                        <p class="standard first-item last-item"><span class="italic">/srv/node/word-count/node_modules</span></p>
                    </li>
                    <li>
                        <p class="standard first-item last-item"><span class="italic">/srv/node/node_modules</span></p>
                    </li>
                    <li>
                        <p class="standard first-item last-item"><span class="italic">/srv/node_modules</span></p>
                    </li>
                    <li>
                        <p class="standard first-item last-item"><span class="italic">/node_modules</span></p>
                    </li>
                    <li>
                        <p class="standard first-item last-item"><span class="italic">/home/&lt;username&gt;/.node_modules</span></p>
                    </li>
                    <li>
                        <p class="standard first-item last-item"><span class="italic">/home/&lt;username&gt;/.node_libraries</span></p>
                    </li>
                    <li>
                        <p class="standard first-item last-item"><span class="italic">/usr/local/lib/node_modules</span></p>
                    </li>
                </ul>
                <p class="standard">On this system, the <samp class="listingcharacter listingcharacter">NODE_PATH</samp> environment variable is empty, so this doesn’t add an additional path.</p>
            
            
                <h4 class="t4" id="h4.4.6.2">Importing Directories<a class="indexanchor" id="i04_149"/></h4>
                <p class="standard">With the CommonJS module loader of Node.js, there is yet another way to include modules in your application. Instead of specifying the name of a module, you can also specify an entire directory. The reason is that libraries are often stored in their own directory structures. For those modules, there is a defined naming convention on how to name the files so that the module loader can find the source code and include it in a correct way. If, instead of a file name, you pass a directory to the module loader, it tries to find a <span class="italic">package.json</span><a class="indexanchor" id="i04_150"/> in the first step. You can use this file to point to the entry point<a class="indexanchor" id="i04_151"/> of a module within a directory. To demonstrate this case, we must adjust the word counter example slightly. First, you need to create a directory named <span class="italic">word-count</span>. This directory should contain your module later. In this directory, you must again create a subdirectory named <span class="italic">lib</span>, and then you must copy the <span class="italic">word-count.js</span> file from <span class="crossreference "><a href="04_004.html#l4.24">Listing 4.24</a></span> into it. Next, you must create a file named <span class="italic">package.json</span> in the <span class="italic">word-count</span> directory. The content of this file corresponds to the source code from <span class="crossreference "><a href="04_004.html#l4.33">Listing 4.33</a></span>.</p>
                <div class="listing " id="l4.33"><pre><span class="schwarz"><a id="p133"/>{</span><span class="schwarz"><br/></span>  <span class="hellblau">"name"</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">"word-count"</span><span class="schwarz">,</span><span class="schwarz"><br/></span>  <span class="hellblau">"main"</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">"./lib/word-count.js"</span><span class="schwarz">,</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"> </span></pre></div>
                <p class="caption "><b>Listing 4.33</b>    
            “package.json” for the “wordCount" Module</p>
                <p class="standard">The last adjustment must be implemented in <span class="italic">index.js</span> from <span class="crossreference "><a href="04_004.html#l4.25">Listing 4.25</a></span>, that is, in the entry point of the application. Here, you just have to make sure that the <samp class="listingcharacter listingcharacter">wordCount</samp> module is included via the <samp class="listingcharacter listingcharacter">const wc = require('./word-count')</samp> command. If you specify a directory when you want to load a module and that directory doesn’t have a <span class="italic">package.json</span> file with a valid <samp class="listingcharacter listingcharacter">main</samp> field, the module loader alternatively searches for the <span class="italic">index.js</span><a class="indexanchor" id="i04_152"/> and <span class="italic">index.node</span><a class="indexanchor" id="i04_153"/> files as entry points to the module.</p>
            
            
                <h4 class="t4" id="h4.4.6.3">Module Cache<a class="indexanchor" id="i04_154"/></h4>
                <p class="standard">Within your application, you can load a module not only once at the beginning of a source code file, or even only in a single file, but also as often as you like, at different places, and thus also multiple times. To avoid having to read these modules from the file system multiple times, both the CommonJS and ECMAScript loaders<a class="indexanchor" id="i04_155"/> perform an optimization by caching the module in memory. This means that the module only needs to be loaded and run the first time. The remaining <samp class="listingcharacter listingcharacter">require</samp> or <samp class="listingcharacter listingcharacter">import</samp> calls with the name of the module are then provided from the cache. As a result, this feature makes sure that the source code is only executed at the first <samp class="listingcharacter listingcharacter">require</samp> or <samp class="listingcharacter listingcharacter">import</samp> call. If you want to get a side effect<a class="indexanchor" id="i04_156"/> on every call, you have to force this via other functions. In <span class="crossreference "><a href="04_004.html#l4.34">Listing 4.34</a></span> and <span class="crossreference "><a href="04_004.html#l4.35">Listing 4.35</a></span>, you can see how this behavior can be re-created.</p>
                <div class="listing " id="l4.34"><pre><span class="magenta">console</span><span class="schwarz">.log(</span><span class="hellblau">'myModule called'</span><span class="schwarz">);</span><span class="schwarz"> </span></pre></div>
                <p class="caption "><b>Listing 4.34</b>    
            “my-module.js”</p>
                <div class="listing " id="l4.35"><pre><span class="schwarz">require(</span><span class="hellblau">'./my-module'</span><span class="schwarz">);</span><span class="schwarz">   </span><span class="gruen"> // Output: myModule called</span><span class="schwarz"><br/></span><span class="schwarz">require(</span><span class="hellblau">'./my-module.js'</span><span class="schwarz">);</span><span class="gruen"> // no output</span><span class="schwarz"> </span></pre></div>
                <p class="caption "><b>Listing 4.35</b>    
            “index.js”</p>
                <p class="standard">When you run the source code via the <samp class="listingcharacter listingcharacter">node index.js</samp> command, you get the output <samp class="listingcharacter listingcharacter">myModule called</samp> only once because the second <samp class="listingcharacter listingcharacter">require</samp> call is provided directly from the cache, and the <span class="italic">my-module.js</span> file isn’t run a second time. The same result occurs if you customize the <span class="italic">index.js</span> file as shown in <span class="crossreference "><a href="04_004.html#l4.36">Listing 4.36</a></span> and use the ECMAScript module system.</p>
                <div class="listing " id="l4.36"><pre><span class="rot">import</span><span class="schwarz"> </span><span class="hellblau">'./my-module.js'</span><span class="schwarz">;</span><span class="gruen"> // Output: myModule called</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="hellblau">'./my-module.js'</span><span class="schwarz">;</span><span class="gruen"> // no output</span><span class="schwarz"> </span></pre></div>
                <p class="caption "><b>Listing 4.36</b>    
            Multiple Imports of the Same Module in the ECMAScript Module System</p>
                <p class="standard"><a id="p134"/>Like the CommonJS module system, the ECMAScript module system has a local cache. However, both caches are independent of each other. Another difference is that you can manipulate the CommonJS module cache much more easily.</p>
                <p class="standard">There are several ways to achieve a multiple effect when loading a module. For example, you can load the module, clear the module cache, and load the module again. The better variant, however, is to dispense with any side effect when loading a module and encapsulate it in a function instead. This way, you only have to load the module once and can call the returned function as often as you like. <span class="crossreference "><a href="04_004.html#l4.37">Listing 4.37</a></span> and <span class="crossreference "><a href="04_004.html#l4.38">Listing 4.38</a></span> show what this looks like for the CommonJS module system, and <span class="crossreference "><a href="04_004.html#l4.39">Listing 4.39</a></span> and <span class="crossreference "><a href="04_004.html#l4.40">Listing 4.40</a></span> show the same for the ECMAScript module system.</p>
                <div class="listing " id="l4.37"><pre>module<span class="schwarz">.</span><span class="schwarz">exports </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">()</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="magenta">console</span><span class="schwarz">.log(</span><span class="hellblau">'myModule called'</span><span class="schwarz">);</span><span class="schwarz"><br/></span><span class="schwarz">};</span><span class="schwarz"> </span></pre></div>
                <p class="caption "><b>Listing 4.37</b>    
            Exported Function in CommonJS (my-module.js)</p>
                <div class="listing " id="l4.38"><pre><span class="rot">const</span><span class="schwarz"> myModule </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="schwarz">require(</span><span class="hellblau">'./my-module'</span><span class="schwarz">);</span><span class="schwarz"><br/></span> <br/><span class="schwarz">myModule();</span><span class="gruen"> // Output: myModule called</span><span class="schwarz"><br/></span><span class="schwarz">myModule();</span><span class="gruen"> // Output: myModule called</span><span class="schwarz"> </span></pre></div>
                <p class="caption "><b>Listing 4.38</b>    
            Multiple Calls of the Exported Function in CommonJS (index.js)</p>
                <div class="listing " id="l4.39"><pre><span class="rot">export</span><span class="schwarz"> </span><span class="rot">default</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">()</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="magenta">console</span><span class="schwarz">.log(</span><span class="hellblau">'myModule called'</span><span class="schwarz">);</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"> </span></pre></div>
                <p class="caption "><b>Listing 4.39</b>    
            Exported Function in ECMAScript (my-module.js)</p>
                <div class="listing " id="l4.40"><pre><span class="rot">import</span><span class="schwarz"> myModule </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./my-module.js'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="schwarz">myModule();</span><span class="gruen"> // Output: myModule called</span><span class="schwarz"><br/></span><span class="schwarz">myModule();</span><span class="gruen"> // Output: myModule called</span><span class="schwarz"> </span></pre></div>
                <p class="caption "><b>Listing 4.40</b>    
            Multiple Calls of the Exported Function in ECMAScript (index.js)</p>
            
            
                <h4 class="t4" id="h4.4.6.4">require Functionality<a class="indexanchor" id="i04_157"/></h4>
                <p class="standard">The structure of CommonJS module loader of Node.js is relatively simple. Nevertheless, it can be difficult to keep track of applications with many modules. It’s also challenging to deal with different versions of certain modules in one system. The caching mechanism of the module loader can also become a problem under certain circumstances. In addition to the functionalities of the Node.js module system presented so far, there are other features that can make it easier for you to work with modules.</p>
                <p class="standard"><a id="p135"/>The <samp class="listingcharacter listingcharacter">resolve</samp> method of the <samp class="listingcharacter listingcharacter">require</samp> object enables you to find out in which file a certain module is located. For this purpose, you only have to provide the method with the information as to which module you want to load. The naming scheme is similar to the one used in the regular load operations<a class="indexanchor" id="i04_158"/>. The <samp class="listingcharacter listingcharacter">resolve</samp> method also performs the same search operations as the actual <samp class="listingcharacter listingcharacter">require</samp> method, the only difference being that the module isn’t loaded, but the absolute path of the file in which the module is located is returned as a string. For core modules, <samp class="listingcharacter listingcharacter">resolve</samp><a class="indexanchor" id="i04_159"/> returns only the name of the module. Moreover, this functionality is not only available in applications but also in the Node.js REPL.</p>
                <p class="standard">You’ve already learned about the Node.js module cache. You can read and edit this cache via the <samp class="listingcharacter listingcharacter">cache</samp> property of the <samp class="listingcharacter listingcharacter">require</samp> object. The <samp class="listingcharacter listingcharacter">cache</samp> object is a normal JavaScript object in which the information is stored. The keys consist of the absolute file names of the respective modules where in each case the value is the <samp class="listingcharacter listingcharacter">module</samp> object of the module. Thus, you can use the <samp class="listingcharacter listingcharacter">cache</samp> object to check whether a module has already been loaded within your application. However, there is one important aspect you need to keep in mind: no core modules are listed in the cache. In the module cache example in <span class="crossreference "><a href="04_004.html#l4.34">Listing 4.34</a></span> and <span class="crossreference "><a href="04_004.html#l4.35">Listing 4.35</a></span>, you saw that a module is evaluated only once and provided from the cache on the second call. The <samp class="listingcharacter listingcharacter">cache</samp> object allows you to change this behavior.</p>
                <p class="standard">If you delete the cache entry<a class="indexanchor" id="i04_160"/> for the module after the first <samp class="listingcharacter listingcharacter">require</samp> call, as shown in <span class="crossreference "><a href="04_004.html#l4.41">Listing 4.41</a></span>, the module will be completely removed from the cache, causing it to be reloaded and evaluated the next time it’s called, and any side effect that the module is intended to have will occur again. You can manipulate not only the cache but also the way Node.js loads the modules you include via <samp class="listingcharacter listingcharacter">require</samp>. For this purpose, the <samp class="listingcharacter listingcharacter">require</samp> module has the <samp class="listingcharacter listingcharacter">extensions</samp> property. The value is an object where the keys consist of various file extensions,<a class="indexanchor" id="i04_161"/> and the associated values consist of the functions used to load the files with the corresponding extensions. Now, if you want to add support for another file extension, all you need to do is extend the <samp class="listingcharacter listingcharacter">extensions</samp> object with a key that has the name of the file extension and then add a function that is responsible for loading the files. The easiest way to do this is to simply use one of the existing functions. In a later chapter, you’ll implement a slightly more extensive application where you can see the various aspects of Node.js in action.</p>
                <div class="listing " id="l4.41"><pre><span class="schwarz">require(</span><span class="hellblau">'./my-module'</span><span class="schwarz">);</span><span class="gruen"> // Output: myModule called</span><span class="schwarz"><br/></span><span class="rot">delete</span><span class="schwarz"> require</span><span class="schwarz">.</span><span class="schwarz">cache</span><span class="schwarz">[</span><span class="schwarz">require</span><span class="schwarz">.resolve(</span><span class="hellblau">'./my-module'</span><span class="schwarz">)];</span><span class="schwarz"><br/></span><span class="schwarz">require(</span><span class="hellblau">'./my-module'</span><span class="schwarz">);</span><span class="gruen"> // Output: myModule called</span><span class="schwarz"> </span></pre></div>
                <p class="caption "><b>Listing 4.41</b>    
            “app.js”</p>
            
        
    </div><p class="signatur"/>
                    </body>
                </html>