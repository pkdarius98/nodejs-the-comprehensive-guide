<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
                    
        <head><meta content="application/xhtml+xml; charset=utf-8" http-equiv="Content-Type"/>
            <meta content="application/xhtml+xml; charset=utf-8" name="content-type"/>
            <meta content="Asynchronous Programming" name="title"/>
            <meta content="Sebastian Springer" name="author"/>
            <meta content="Rheinwerk Publishing" name="publisher"/>
            <meta content="© 2022 by Rheinwerk Publishing Inc., Boston (MA)" name="copyright"/>
            <meta content="Node.js - The Comprehensive Guide - Asynchronous Programming" name="description"/>
            <meta content="en" name="language"/>
            <title>Asynchronous Programming</title>
            <link href="common/main.css" rel="stylesheet" type="text/css"/>
<meta content="urn:uuid:e0000000-0000-0000-0000-000029756394" name="Adept.expected.resource"/>
        </head>
    


                    <body class="office_us type_kapitel">
                        <div id="main">
        <h2 class="t2" id="h16.6">16.6    Promises<a class="indexanchor" id="i16_109"/> in Node.js</h2>
        <p class="standard">A <span class="italic">promise</span> represents the result of an asynchronous operation and a kind of return value<a class="indexanchor" id="i16_110"/> for such an operation that allows you to better handle asynchronicity in your application. What was only possible with libraries for a long time has now found its way into the JavaScript engine. <span class="crossreference "><a href="16_006.html#l16.20">Listing 16.20</a></span> shows how you can use promises based on a small example.</p>
        <div class="listing " id="l16.20"><pre><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> readFile </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'fs'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">promisedReadFile(</span><span class="schwarz">filename</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="rot">return</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">Promise((</span><span class="schwarz">resolve</span><span class="schwarz">,</span><span class="schwarz"> reject</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="schwarz">readFile(</span><span class="schwarz">filename</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="hellblau">'utf-8'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">err</span><span class="schwarz">,</span><span class="schwarz"> data</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>      <span class="rot">if</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">err</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>        <span class="schwarz">reject(</span><span class="schwarz">err</span><span class="schwarz">);</span><span class="schwarz"><br/></span>      <span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">else</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>        <span class="schwarz">resolve(</span><span class="schwarz">data</span><span class="schwarz">);</span><span class="schwarz"><br/></span>      <span class="schwarz">}</span><span class="schwarz"><br/></span>    <span class="schwarz">});</span><span class="schwarz"><br/></span>  <span class="schwarz">});</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"><br/></span> <br/><span class="schwarz">promisedReadFile(</span><span class="hellblau">'input.txt'</span><span class="schwarz">)</span><span class="schwarz"><br/></span>  <span class="schwarz">.then((</span><span class="schwarz">data</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="magenta">console</span><span class="schwarz">.log(</span><span class="hellblau">'Content of the file: '</span><span class="schwarz">,</span><span class="schwarz"> data</span><span class="schwarz">);</span><span class="schwarz"><br/></span>  <span class="schwarz">})</span><span class="schwarz"><br/></span>  <span class="schwarz">.catch((</span><span class="schwarz">error</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="magenta">console</span><span class="schwarz">.error(</span><span class="hellblau">'An error occured: '</span><span class="schwarz">,</span><span class="schwarz"> error</span><span class="schwarz">.</span><span class="schwarz">message</span><span class="schwarz">);</span><span class="schwarz"><br/></span>  <span class="schwarz">});</span><span class="schwarz"> </span></pre></div>
        <p class="caption "><b>Listing 16.20</b>    
            Promises in JavaScript</p>
        <p class="standard"><a id="p508"/>For the example in <span class="crossreference "><a href="16_006.html#l16.20">Listing 16.20</a></span> to work, you must first create a text file named <span class="italic">input.txt</span> that contains text. After that, you can run the sample code. The code from <span class="crossreference "><a href="16_006.html#l16.20">Listing 16.20</a></span> provides the <samp class="listingcharacter listingcharacter">promisedReadFile</samp> function, which reads the contents of a file. Usually this is done via the <samp class="listingcharacter listingcharacter">readFile</samp> function of the <samp class="listingcharacter listingcharacter">fs</samp> module. Here, this function is encapsulated by a promise object. The promise object is created via the <samp class="listingcharacter listingcharacter">promise</samp> constructor, which receives a callback function. This function is called with the <samp class="listingcharacter listingcharacter">resolve</samp> and <samp class="listingcharacter listingcharacter">reject</samp> arguments used for the success<a class="indexanchor" id="i16_111"/> and error cases<a class="indexanchor" id="i16_112"/>, respectively.</p>
        <p class="standard">A promise object knows a total of four statuses<a class="indexanchor" id="i16_113"/>:</p>
        <ul>
            <li>
                <p class="standard first-item last-item"><span class="bold">Pending</span><a class="indexanchor" id="i16_114"/><span class="screenelement"><br/></span>The promise is still waiting for the asynchronous operation to finish.</p>
            </li>
            <li>
                <p class="standard first-item last-item"><span class="bold">Settled</span><a class="indexanchor" id="i16_115"/><span class="screenelement"><br/></span>The asynchronous operation was terminated.</p>
            </li>
            <li>
                <p class="standard first-item last-item"><span class="bold">Resolved</span><a class="indexanchor" id="i16_116"/><span class="screenelement"><br/></span>The asynchronous operation was completed successfully.</p>
            </li>
            <li>
                <p class="standard first-item last-item"><span class="bold">Rejected</span><a class="indexanchor" id="i16_117"/><span class="screenelement"><br/></span>The asynchronous operation failed.</p>
            </li>
        </ul>
        <p class="standard"><span class="crossreference "><a href="16_006.html#f16.3">Figure 16.3</a></span> illustrates these relationships.</p>
        <div class="imagebox figure-type"><a href="img-f16.3.html" id="f16.3"><img alt="Lifecycle of a Promise" id="img-f16.3" src="bilderklein/klein16_003.png"/></a></div>
        <p class="caption "><b>Figure 16.3</b>    
            Lifecycle of a Promise</p>
        <p class="standard">As you’ve seen in <span class="crossreference "><a href="16_006.html#l16.20">Listing 16.20</a></span>, the <samp class="listingcharacter listingcharacter">promisedReadFile</samp> function returns a promise object. This object defines the <samp class="listingcharacter listingcharacter">then</samp> method. You can pass either one or two callback functions to it. The first of the two is executed when successful, that is, when you call the <samp class="listingcharacter listingcharacter">resolve</samp> function of the promise; the second is called when there is an error, that is, when you call <samp class="listingcharacter listingcharacter">reject</samp>. You can also catch the failure case via the <samp class="listingcharacter listingcharacter">catch</samp> method, as in the example. <a id="p509"/>The advantage here is that success and failure cases are much more cleanly separated from each other. At this point, as is often the case, there is no right way and no wrong way—just make sure that your source code remains understandable and consistent.</p>
        <p class="standard">You can pass arguments to both the <samp class="listingcharacter listingcharacter">resolve</samp> and <samp class="listingcharacter listingcharacter">reject</samp> functions, which are then passed to the corresponding callbacks. The <samp class="listingcharacter listingcharacter">then</samp> method<a class="indexanchor" id="i16_118"/> in turn returns a promise object, which also allows you to concatenate multiple promises. In an example such as reading a file, you still don’t save much worked compared to normal callback functions for asynchronous operations. However, this changes when you start to combine several asynchronous operations, that is, execute asynchronous operations one after the other or perform logical flow control<a class="indexanchor" id="i16_119"/>.</p>
        <p class="standard">Promises and an event architecture are often compared with each other. However, promises don’t replace the event architecture at all, but rather cover completely different use cases. With a promise, you can map two different statuses, namely, whether an operation was successful or not. Events, on the other hand, are much more diverse. Thus, an event source can trigger any number of different types of events, representing many more facets of an object’s state change. Promises are mainly used for modeling asynchronous operations. You use events when objects change their state over their lifetime, and these changes are relevant to the outside world or other parts of your application.</p>
        <p class="standard">A promise can also be resolved or rejected only once in its lifecycle. An event can be triggered any number of times. Just take the example of a web server. This is implemented as an event system. Each <samp class="listingcharacter listingcharacter">request</samp> triggers a request event to which you can register a callback function. If you were to implement the system on the basis of promises, the server would only be able to accept a single request.</p>
        <p class="standard"><span class="crossreference "><a href="16_006.html#l16.21">Listing 16.21</a></span> shows that it’s possible to encapsulate file system operations not only in promises but also in any other asynchronous actions, such as an HTTP request.</p>
        <div class="listing " id="l16.21"><pre><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> request </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'http'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">doRequest(</span><span class="schwarz">url</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="rot">return</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">Promise((</span><span class="schwarz">resolve</span><span class="schwarz">,</span><span class="schwarz"> reject</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="rot">const</span><span class="schwarz"> options </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>      hostname<span class="schwarz">:</span><span class="schwarz"> url</span><span class="schwarz">,</span><span class="schwarz"><br/></span>      port<span class="schwarz">:</span><span class="schwarz"> </span><span class="schwarz">80,</span><span class="schwarz"><br/></span>      method<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'GET'</span><span class="schwarz">,</span><span class="schwarz"><br/></span>    <span class="schwarz">};</span><span class="schwarz"><br/></span>    <span class="rot">const</span><span class="schwarz"> requestObject </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="schwarz">request(</span><span class="schwarz">options</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">response</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>      response<span class="schwarz">.setEncoding(</span><span class="hellblau">'utf8'</span><span class="schwarz">);</span><span class="schwarz"><br/></span>      <span class="rot">let</span><span class="schwarz"> data </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="hellblau">''</span><span class="schwarz">;</span><span class="schwarz"><br/></span>      response<span class="schwarz">.on(</span><span class="hellblau">'data'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">chunk</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">data </span><span class="dunkelblau">+=</span><span class="schwarz"> chunk</span><span class="schwarz">));</span><span class="schwarz"><br/></span>      response<span class="schwarz">.on(</span><span class="hellblau">'end'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">()</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">resolve(</span><span class="schwarz">data</span><span class="schwarz">));</span><span class="schwarz"><br/></span>      response<span class="schwarz">.on(</span><span class="hellblau">'error'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">e</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">reject(</span><span class="schwarz">e</span><span class="schwarz">));</span><span class="schwarz"><br/></span><a id="p510"/>    <span class="schwarz">});</span><span class="schwarz"><br/></span>    requestObject<span class="schwarz">.end();</span><span class="schwarz"><br/></span>  <span class="schwarz">});</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"><br/></span> <br/><span class="schwarz">doRequest(</span><span class="hellblau">'www.google.de'</span><span class="schwarz">).then(</span><span class="schwarz"><br/></span>  <span class="schwarz">(</span><span class="schwarz">data</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="magenta">console</span><span class="schwarz">.log(</span><span class="hellblau">'data: '</span><span class="schwarz">,</span><span class="schwarz"> data</span><span class="schwarz">);</span><span class="schwarz"><br/></span>  <span class="schwarz">},</span><span class="schwarz"><br/></span>  <span class="schwarz">(</span><span class="schwarz">err</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="magenta">console</span><span class="schwarz">.error(</span><span class="hellblau">'error: '</span><span class="schwarz">,</span><span class="schwarz"> err</span><span class="schwarz">);</span><span class="schwarz"><br/></span>  <span class="schwarz">},</span><span class="schwarz"><br/></span><span class="schwarz">);</span><span class="schwarz"> </span></pre></div>
        <p class="caption "><b>Listing 16.21</b>    
            Promise for an HTTP Request</p>
        <p class="standard">In this example, you encapsulate the asynchronous operation of a server request<a class="indexanchor" id="i16_120"/> with the <samp class="listingcharacter listingcharacter">doRequest</samp> function. The response of the web server doesn’t happen directly in the callback function, but via a readable stream. In the <samp class="listingcharacter listingcharacter">data</samp> events of the stream, you collect all the data sent by the server. Once the <samp class="listingcharacter listingcharacter">end</samp> event gets triggered, you can successfully resolve the promise by calling the <samp class="listingcharacter listingcharacter">resolve</samp> method. The <samp class="listingcharacter listingcharacter">resolve</samp> method is used to specify the data to be processed later. If an error occurred during the request, the <samp class="listingcharacter listingcharacter">error</samp> event gets triggered. In that case, you reject the promise by calling the <samp class="listingcharacter listingcharacter">reject</samp> method. Again, you pass more information in the form of the error object. With the two callback functions, you handle the success and the error case.</p>
        
            <h3 class="t3" id="h16.6.1">16.6.1    Using util.promisify<a class="indexanchor" id="i16_121"/> to Use Promises Where None Actually Exist</h3>
            <p class="standard">In the early days of Node.js development, you wouldn’t have found promises. All asynchronous operations were implemented via callbacks. Meanwhile, in some places, such as the <samp class="listingcharacter listingcharacter">fs</samp> module, you’ll increasingly find interfaces that natively support promises. For this purpose, for example, there is the <samp class="listingcharacter listingcharacter">fs/promise</samp> module which offers a promise-based variant for almost all functions of the <samp class="listingcharacter listingcharacter">fs</samp> module. Nevertheless, Node.js has a variety of functions that meet all the requirements for using promises as well. For this purpose, there is the <samp class="listingcharacter listingcharacter">promisify</samp> function of the <samp class="listingcharacter listingcharacter">util</samp> module. This function accepts as its only argument a function that follows the Node.js callback standard, that is, defines as its last parameter a callback function that in turn has an error object in its signature as its first parameter. The best way to demonstrate how this works is to use the <samp class="listingcharacter listingcharacter">readFile</samp> function of the <samp class="listingcharacter listingcharacter">fs</samp> module. As you know, this function accepts the name of a file, optionally additional options, and a callback function. In this callback function, you have access to an error object, which has the value <samp class="listingcharacter listingcharacter">null</samp> for success, as well as to the data from the read file. <span class="crossreference "><a href="16_006.html#l16.22">Listing 16.22</a></span> shows how you can use this feature together with <samp class="listingcharacter listingcharacter">promisify</samp>.</p>
            <div class="listing " id="l16.22"><pre><span class="rot"><a id="p511"/>import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> readFile </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'fs'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> promisify </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'util'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="rot">const</span><span class="schwarz"> promisedReadFile </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="schwarz">promisify(</span><span class="schwarz">readFile</span><span class="schwarz">);</span><span class="schwarz"><br/></span> <br/><span class="schwarz">promisedReadFile(</span><span class="hellblau">'input.txt'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="hellblau">'utf-8'</span><span class="schwarz">)</span><span class="schwarz"><br/></span>  <span class="schwarz">.then((</span><span class="schwarz">data</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="magenta">console</span><span class="schwarz">.log(</span><span class="schwarz">data</span><span class="schwarz">))</span><span class="schwarz"><br/></span>  <span class="schwarz">.catch((</span><span class="schwarz">error</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="magenta">console</span><span class="schwarz">.error(</span><span class="schwarz">error</span><span class="schwarz">));</span><span class="schwarz"> </span></pre></div>
            <p class="caption "><b>Listing 16.22</b>    
            Using “promisify” to Turn a Callback-Based Function into a Promise-Based Function</p>
            <p class="standard">As you can see in the code example, <samp class="listingcharacter listingcharacter">promisify</samp> returns a function object that, when called, generates a promise object you can use to process the result of the asynchronous operation and then no longer have to rely on the usual callback functionality.</p>
        
        
            <h3 class="t3" id="h16.6.2">16.6.2    Concatenating<a class="indexanchor" id="i16_122"/> Promises</h3>
            <p class="standard">When taking a look at the previous code examples, you’ll see that promises aren’t used to reduce the callback functions within your application. Actually, they have exactly the opposite effect: there are more callback functions present because you register separate functions for success and failure. Promises show their true strength when it comes to coordinating multiple asynchronous operations. In this context, you have a total of three different options: connect several operations in a sequence, run them in parallel, or use only the result of the fastest operation. <span class="crossreference "><a href="16_006.html#l16.23">Listing 16.23</a></span> shows an example of concatenating multiple asynchronous operations.</p>
            <div class="listing " id="l16.23"><pre><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">asyncOperation(</span><span class="schwarz">resolve</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="magenta">value</span><span class="schwarz">,</span><span class="schwarz"> time</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="rot">return</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">Promise((</span><span class="schwarz">res</span><span class="schwarz">,</span><span class="schwarz"> rej</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="schwarz">setTimeout(()</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>      <span class="rot">if</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">resolve</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>        <span class="schwarz">res(</span><span class="magenta">value</span><span class="schwarz">);</span><span class="schwarz"><br/></span>      <span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">else</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>        <span class="schwarz">rej(</span><span class="magenta">value</span><span class="schwarz">);</span><span class="schwarz"><br/></span>      <span class="schwarz">}</span><span class="schwarz"><br/></span>    <span class="schwarz">},</span><span class="schwarz"> time</span><span class="schwarz">);</span><span class="schwarz"><br/></span>  <span class="schwarz">});</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"><br/></span> <br/><span class="schwarz">asyncOperation(</span><span class="rot">true</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="hellblau">'Hello'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">100)</span><span class="schwarz"><br/></span>  <span class="schwarz">.then((</span><span class="schwarz">data</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="magenta">console</span><span class="schwarz">.log(</span><span class="schwarz">data </span><span class="dunkelblau">+</span><span class="schwarz"> </span><span class="hellblau">' '</span><span class="schwarz">);</span><span class="schwarz"><br/></span>    <span class="rot">return</span><span class="schwarz"> </span><span class="schwarz">asyncOperation(</span><span class="rot">true</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="hellblau">'World'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">200);</span><span class="schwarz"><br/></span>  <span class="schwarz">})</span><span class="schwarz"><br/></span><a id="p512"/>  <span class="schwarz">.then((</span><span class="schwarz">data</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="magenta">console</span><span class="schwarz">.log(</span><span class="schwarz">data</span><span class="schwarz">);</span><span class="schwarz"><br/></span>    <span class="rot">return</span><span class="schwarz"> </span><span class="hellblau">'!'</span><span class="schwarz">;</span><span class="schwarz"><br/></span>  <span class="schwarz">})</span><span class="schwarz"><br/></span>  <span class="schwarz">.then((</span><span class="schwarz">data</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="magenta">console</span><span class="schwarz">.log(</span><span class="schwarz">data</span><span class="schwarz">);</span><span class="schwarz"><br/></span>  <span class="schwarz">})</span><span class="schwarz"><br/></span>  <span class="schwarz">.catch((</span><span class="schwarz">err</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="magenta">console</span><span class="schwarz">.error(</span><span class="hellblau">'Error: '</span><span class="schwarz">,</span><span class="schwarz"> err</span><span class="schwarz">);</span><span class="schwarz"><br/></span>  <span class="schwarz">});</span><span class="schwarz"> </span></pre></div>
            <p class="caption "><b>Listing 16.23</b>    
            Concatenating Promises</p>
            <p class="standard">The <samp class="listingcharacter listingcharacter">asyncOperation</samp> function uses the first parameter to decide whether the returned promise should be resolved or rejected. The second parameter is the value returned by the promise, and, finally, the third parameter specifies the time after which the result should be available. The first operation is resolved after <samp class="listingcharacter listingcharacter">100</samp> milliseconds. In the <samp class="listingcharacter listingcharacter">then</samp> method, you register a callback function in which you output the result and return another promise object. In any case, the <samp class="listingcharacter listingcharacter">then</samp> method returns a promise object, which, in this case, is linked to the returned promise, so you can in turn register a callback function via a <samp class="listingcharacter listingcharacter">then</samp> call. This returns a simple character string instead of a promise, which you can access in the final <samp class="listingcharacter listingcharacter">then</samp> call. The end of the chain is an error handler<a class="indexanchor" id="i16_123"/>, which is bound using the <samp class="listingcharacter listingcharacter">catch</samp> method. If you change the first parameter to <samp class="listingcharacter listingcharacter">false</samp> when calling the <samp class="listingcharacter listingcharacter">asyncOperation</samp>, the error handler takes effect. Error objects run through the chain until an error handler is found, which then handles the error. If you don’t register an error handler, a promise rejection will cause your application to terminate and thus act like an uncaught exception.</p>
        
        
            <h3 class="t3" id="h16.6.3">16.6.3    Multiple Parallel Operations<a class="indexanchor" id="i16_124"/> with Promise.all<a class="indexanchor" id="i16_125"/></h3>
            <p class="standard">The <samp class="listingcharacter listingcharacter">all</samp> method of the promise object accepts an array of promises and in turn returns a promise itself. This promise is successfully resolved if all promises of the array were successful. As soon as one of the promises fails, the promise that returns the <samp class="listingcharacter listingcharacter">all</samp> method is also rejected. <span class="crossreference "><a href="16_006.html#l16.24">Listing 16.24</a></span> clarifies this for you.</p>
            <div class="listing " id="l16.24"><pre><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">asyncOperation(</span><span class="schwarz">resolve</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="magenta">value</span><span class="schwarz">,</span><span class="schwarz"> time</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="rot">return</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">Promise((</span><span class="schwarz">res</span><span class="schwarz">,</span><span class="schwarz"> rej</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="schwarz">setTimeout(()</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>      <span class="rot">if</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">resolve</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>        <span class="schwarz">res(</span><span class="magenta">value</span><span class="schwarz">);</span><span class="schwarz"><br/></span>      <span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">else</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>        <span class="schwarz">rej(</span><span class="magenta">value</span><span class="schwarz">);</span><span class="schwarz"><br/></span>      <span class="schwarz">}</span><span class="schwarz"><br/></span>    <span class="schwarz">},</span><span class="schwarz"> time</span><span class="schwarz">);</span><span class="schwarz"><br/></span><a id="p513"/>  <span class="schwarz">});</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"><br/></span> <br/><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter">Promise.all([<br/>  asyncOperation(<span class="rot">true</span><span class="schwarz">, </span><span class="hellblau">'World'</span><span class="schwarz">, 100),</span><br/>  asyncOperation(<span class="rot">true</span><span class="schwarz">, </span><span class="hellblau">'Hello'</span><span class="schwarz">, 50),</span><br/>]).then((values) <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>  <span class="magenta">console</span><span class="schwarz">.log(values.join(</span><span class="hellblau">' '</span><span class="schwarz">));</span><br/>});</samp></span> <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 16.24</b>    
            Promise.all in Use</p>
            <p class="standard">The <samp class="listingcharacter listingcharacter">asyncOperation</samp> function works according to the same scheme as in <span class="crossreference "><a href="16_006.html#l16.23">Listing 16.23</a></span>. You pass two promises to the <samp class="listingcharacter listingcharacter">all</samp> method; the first is successfully resolved after <samp class="listingcharacter listingcharacter">100</samp> milliseconds, and the second after <samp class="listingcharacter listingcharacter">50</samp> milliseconds. In the success callback of the <samp class="listingcharacter listingcharacter">then</samp> method, you have access to the return values of the promises via an array. The order of the values is determined by the order in which the promises are called, not by the order in which they are resolved. So, the output of the script on the console after 100 milliseconds is the string <samp class="listingcharacter listingcharacter">Hello World</samp>. However, if you’re not interested in the result of all promises, but only in the result of the fastest one, you can use the <samp class="listingcharacter listingcharacter">race</samp> method.</p>
        
        
            <h3 class="t3" id="h16.6.4">16.6.4    Fastest Asynchronous Operation<a class="indexanchor" id="i16_126"/> with Promise.race<a class="indexanchor" id="i16_127"/></h3>
            <p class="standard">The signature of <samp class="listingcharacter listingcharacter">Promise.race</samp> is similar to that of <samp class="listingcharacter listingcharacter">Promise.all</samp>, only its use is quite different. Where <samp class="listingcharacter listingcharacter">Promise.all</samp> summarizes all passed promises, <samp class="listingcharacter listingcharacter">Promise.race</samp> only considers the result of the first resolved promise, whether it’s resolved or rejected.</p>
            <p class="standard">As you can see in <span class="crossreference "><a href="16_006.html#l16.25">Listing 16.25</a></span>, when the source code is executed, the <samp class="listingcharacter listingcharacter">Second</samp> string is output on the command line. This is the value returned by the second promise after <samp class="listingcharacter listingcharacter">50</samp> milliseconds. The two remaining promises are ignored. You use the <samp class="listingcharacter listingcharacter">race</samp> method primarily when you want to obtain information from several sources, such as web services, and only want to continue working with the fastest result.</p>
            <div class="listing " id="l16.25"><pre><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">asyncOperation(</span><span class="schwarz">resolve</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="magenta">value</span><span class="schwarz">,</span><span class="schwarz"> time</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="rot">return</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">Promise((</span><span class="schwarz">res</span><span class="schwarz">,</span><span class="schwarz"> rej</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="schwarz">setTimeout(()</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>      <span class="rot">if</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">resolve</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>        <span class="schwarz">res(</span><span class="magenta">value</span><span class="schwarz">);</span><span class="schwarz"><br/></span>      <span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">else</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>        <span class="schwarz">rej(</span><span class="magenta">value</span><span class="schwarz">);</span><span class="schwarz"><br/></span>      <span class="schwarz">}</span><span class="schwarz"><br/></span>    <span class="schwarz">},</span><span class="schwarz"> time</span><span class="schwarz">);</span><span class="schwarz"><br/></span>  <span class="schwarz">});</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"><br/></span> <br/><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><a id="p514"/>Promise.race([</samp></span><br/>  asyncOperation(<span class="rot">true</span><span class="schwarz">, </span><span class="hellblau">'First'</span><span class="schwarz">, 100),</span><br/>  asyncOperation(<span class="rot">true</span><span class="schwarz">, </span><span class="hellblau">'Second'</span><span class="schwarz">, 50),</span><br/>  asyncOperation(<span class="rot">true</span><span class="schwarz">, </span><span class="hellblau">'Third'</span><span class="schwarz">, 75),</span><br/>]).then((<span class="magenta">value</span><span class="schwarz">) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>  <span class="magenta">console</span><span class="schwarz">.log(</span><span class="magenta">value</span><span class="schwarz">);</span><br/>}); <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 16.25</b>    
            Promise.race</p>
        
        
            <h3 class="t3" id="h16.6.5">16.6.5    Overview of the Promise Functions</h3>
            <p class="standard">The promise application programming interface (API) is part of the ECMAScript standard and applies in this form to both Node.js and the browser. <span class="crossreference "><a href="16_006.html#t16.6">Table 16.6</a></span> provides an overview of the various functions the promise API makes available to you.</p>
            <table class="standardtable" id="t16.6">
                <thead>
                    <tr>
                        <th class="tablehead tablecell_first top_border_cell">
                            <p class="standard first-item last-item">Method</p>
                        </th>
                        <th class="tablehead tablecell_last top_border_cell">
                            <p class="standard first-item last-item">Description</p>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="tablecell tablecell_first top_border_cell">
                            <p class="standard first-item last-item"><samp class="listingcharacter listingcharacter">Promise.all</samp></p>
                        </td>
                        <td class="tablecell tablecell_last top_border_cell">
                            <p class="standard first-item last-item">Returns a promise that will be resolved once all passed promises are resolved.</p>
                        </td>
                    </tr>
                    <tr class="light">
                        <td class="tablecell tablecell_first">
                            <p class="standard first-item last-item"><samp class="listingcharacter listingcharacter">Promise.allSettled</samp></p>
                        </td>
                        <td class="tablecell tablecell_last">
                            <p class="standard first-item last-item">Returns a promise that will be resolved once all passed promises are either resolved or rejected.</p>
                        </td>
                    </tr>
                    <tr>
                        <td class="tablecell tablecell_first">
                            <p class="standard first-item last-item"><samp class="listingcharacter listingcharacter">Promise.any</samp></p>
                        </td>
                        <td class="tablecell tablecell_last">
                            <p class="standard first-item last-item">Returns a promise that will be resolved as soon as the first of the passed promises is resolved.</p>
                        </td>
                    </tr>
                    <tr class="light">
                        <td class="tablecell tablecell_first">
                            <p class="standard first-item last-item"><samp class="listingcharacter listingcharacter">Promise.race</samp></p>
                        </td>
                        <td class="tablecell tablecell_last">
                            <p class="standard first-item last-item">Returns a promise that is either resolved or rejected depending on the status of the first promise passed.</p>
                        </td>
                    </tr>
                    <tr>
                        <td class="tablecell tablecell_first">
                            <p class="standard first-item last-item"><samp class="listingcharacter listingcharacter">Promise.reject</samp></p>
                        </td>
                        <td class="tablecell tablecell_last">
                            <p class="standard first-item last-item">Creates a promise that is immediately rejected.</p>
                        </td>
                    </tr>
                    <tr class="light">
                        <td class="tablecell tablecell_first">
                            <p class="standard first-item last-item"><samp class="listingcharacter listingcharacter">Promise.resolve</samp></p>
                        </td>
                        <td class="tablecell tablecell_last">
                            <p class="standard first-item last-item">Creates a promise that is immediately resolved.</p>
                        </td>
                    </tr>
                </tbody>
            </table>
            <p class="caption "><b>Table 16.6</b>    
            Overview of the Promise Methods</p>
        
    </div><p class="signatur"/>
                    </body>
                </html>