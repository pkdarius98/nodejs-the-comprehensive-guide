<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
                    
        <head><meta content="application/xhtml+xml; charset=utf-8" http-equiv="Content-Type"/>
            <meta content="application/xhtml+xml; charset=utf-8" name="content-type"/>
            <meta content="Real-Time Web Applications" name="title"/>
            <meta content="Sebastian Springer" name="author"/>
            <meta content="Rheinwerk Publishing" name="publisher"/>
            <meta content="© 2022 by Rheinwerk Publishing Inc., Boston (MA)" name="copyright"/>
            <meta content="Node.js - The Comprehensive Guide - Real-Time Web Applications" name="description"/>
            <meta content="en" name="language"/>
            <title>Real-Time Web Applications</title>
            <link href="common/main.css" rel="stylesheet" type="text/css"/>
<meta content="urn:uuid:e0000000-0000-0000-0000-000029756394" name="Adept.expected.resource"/>
        </head>
    


                    <body class="office_us type_kapitel">
                        <div id="main">
        <h2 class="t2" id="h12.2">12.2    Setup<a class="indexanchor" id="i12_11"/></h2>
        <p class="standard">The basic structure of your application consists of two files and a directory. The entry point to the application is the <span class="italic">index.js</span> file located in the root directory of the application. In addition to this file, you need the <span class="italic">package.json</span><a class="indexanchor" id="i12_12"/> file, which can be used to resolve the dependencies of your application on the Node Package Manager (npm). It’s also located in the root directory of the application. The directory you create is named <span class="italic">app</span> and contains all the files required for the backend of your application to function correctly. When you start implementing your application, the first step is to create the <span class="italic">package.json</span> file using the <samp class="listingcharacter listingcharacter">npm init -y</samp> command. For the sample application, you need Express, Pug, and the <samp class="listingcharacter listingcharacter">websocket</samp> package. You can install these tools via command <samp class="listingcharacter listingcharacter">npm install express pug ws</samp>. <span class="crossreference "><a href="12_002.html#l12.1">Listing 12.1</a></span> shows the resulting <span class="italic">package.json</span> file.</p>
        <div class="listing " id="l12.1"><pre><span class="schwarz"><a id="p359"/>{</span><span class="schwarz"><br/></span>  <span class="hellblau">"name"</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">"node-book"</span><span class="schwarz">,</span><span class="schwarz"><br/></span>  <span class="hellblau">"version"</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">"1.0.0"</span><span class="schwarz">,</span><span class="schwarz"><br/></span>  <span class="hellblau">"description"</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">"A realtime chat application in node.js"</span><span class="schwarz">,</span><span class="schwarz"><br/></span>  <span class="hellblau">"main"</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">"index.js"</span><span class="schwarz">,</span><span class="schwarz"><br/></span>  <span class="hellblau">"type"</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">"module"</span><span class="schwarz">,</span><span class="schwarz"><br/></span>  <span class="hellblau">"private"</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="rot">true</span><span class="schwarz">,</span><span class="schwarz"><br/></span>  <span class="hellblau">"scripts"</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="hellblau">"start"</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">"node index.js"</span><span class="schwarz"><br/></span>  <span class="schwarz">},</span><span class="schwarz"><br/></span>  <span class="hellblau">"keywords"</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="schwarz">[],</span><span class="schwarz"><br/></span>  <span class="hellblau">"author"</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">""</span><span class="schwarz">,</span><span class="schwarz"><br/></span>  <span class="hellblau">"license"</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">"ISC"</span><span class="schwarz">,</span><span class="schwarz"><br/></span>  <span class="hellblau">"dependencies"</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="hellblau">"express"</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">"^4.17.1"</span><span class="schwarz">,</span><span class="schwarz"><br/></span>    <span class="hellblau">"pug"</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">"^3.0.2"</span><span class="schwarz">,</span><span class="schwarz"><br/></span>    <span class="hellblau">"ws"</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">"^8.1.0"</span><span class="schwarz"><br/></span>  <span class="schwarz">}</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"> </span></pre></div>
        <p class="caption "><b>Listing 12.1</b>    
            “package.json” File</p>
        <p class="standard">The next step is to create the entry point to your application. It consists primarily of the contents of the <span class="italic">index.js</span> file, the basic structure of which is shown in <span class="crossreference "><a href="12_002.html#l12.2">Listing 12.2</a></span>. During the course of this chapter, you’ll expand this file more and more.</p>
        <div class="listing " id="l12.2"><pre><span class="rot">import</span><span class="schwarz"> express </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'express'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> dirname </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'path'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> fileURLToPath </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'url'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="rot">const</span><span class="schwarz"> app </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="schwarz">express();</span><span class="schwarz"><br/></span> <br/>app<span class="schwarz">.set(</span><span class="hellblau">'views'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="violett">`${dirname(fileURLToPath(import.meta.url))}/app/views`</span><span class="schwarz">);</span><span class="schwarz"><br/></span>app<span class="schwarz">.set(</span><span class="hellblau">'view engine'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="hellblau">'pug'</span><span class="schwarz">);</span><span class="schwarz"><br/></span> <br/>app<span class="schwarz">.get(</span><span class="hellblau">'/'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">request</span><span class="schwarz">,</span><span class="schwarz"> response</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  response<span class="schwarz">.render(</span><span class="hellblau">'login'</span><span class="schwarz">);</span><span class="schwarz"><br/></span><span class="schwarz">});</span><span class="schwarz"><br/></span> <br/>app<span class="schwarz">.listen(8080,</span><span class="schwarz"> </span><span class="schwarz">()</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"><br/></span>  <span class="magenta">console</span><span class="schwarz">.log(</span><span class="hellblau">'Server is listening to http://localhost:8080'</span><span class="schwarz">),</span><span class="schwarz"><br/></span><span class="schwarz">);</span><span class="schwarz"> </span></pre></div>
        <p class="caption "><b>Listing 12.2</b>    
            Entry Point into the Application (index.js)</p>
        <p class="standard"><a id="p360"/>The content of the <span class="italic">index.js</span> file currently consists only of the Express setup, that is, the import of the package and a subsequent call of the <samp class="listingcharacter listingcharacter">express</samp> function. Finally, on the application object, you call the <samp class="listingcharacter listingcharacter">listen</samp> method and bind your application to port <samp class="listingcharacter listingcharacter">8080</samp>. Pug is used as the template engine in your application. Using the <samp class="listingcharacter listingcharacter">set</samp> method, you set the <samp class="listingcharacter listingcharacter">view engine</samp> property<a class="indexanchor" id="i12_13"/> of your application to the value <samp class="listingcharacter listingcharacter">pug</samp> and specify via the <samp class="listingcharacter listingcharacter">views</samp> property where your templates are stored. Before you can test your application for the first time, you also need a route. You can create one by calling the <samp class="listingcharacter listingcharacter">get</samp> method of your application object. In the callback function of the route<a class="indexanchor" id="i12_14"/>, a template is rendered via the <samp class="listingcharacter listingcharacter">render</samp> method and returned to the requesting user. You then place this template in the <span class="italic">app/views</span> directory and name it <span class="italic">login.pug</span>. <span class="crossreference "><a href="12_002.html#l12.3">Listing 12.3</a></span> shows the contents of the template.</p>
        <div class="listing " id="l12.3"><pre>doctype html<br/><br/>html<br/>  head<br/>    title Node.js Chat<br/>  body<br/>    form(action="login" method="post")<br/>      div<br/>        label(for="username") Username:<br/>        input(type="text" name="username" id="username")<br/>      div<br/>        label(for="password") Password:<br/>        input(type="password" name="password" id="password")<br/>      div<br/>        input(type="submit" value="Log in") </pre></div>
        <p class="caption "><b>Listing 12.3</b>    
            Login Form (app/views/login.pug)</p>
        <p class="standard">When you now start your application via the <samp class="listingcharacter listingcharacter">npm start</samp> command, you can access it with your browser at <span class="italic">http://localhost:8080</span> and see, as a result, a webpage similar to the one shown in <span class="crossreference "><a href="12_002.html#f12.1">Figure 12.1</a></span>.</p>
        <p class="standard">When you enter a user name and password in your login screen<a class="indexanchor" id="i12_15"/> and click the <span class="screenelement">Log in</span> button, you’ll receive the error message; <samp class="listingcharacter listingcharacter">Cannot POST /login</samp>. This means that in the next step, you need to make sure your users log in to your application to use it. The error message pops up because your application doesn’t currently have a suitable route for the request. For the login<a class="indexanchor" id="i12_16"/> process to work on your application, you need to modify your <span class="italic">index.js</span> file. First, you’ll need some middleware<a class="indexanchor" id="i12_17"/> components to make your work easier. You can use the <samp class="listingcharacter listingcharacter">npm install cookie-session</samp> command to install the <samp class="listingcharacter listingcharacter">cookie-session</samp> package. <span class="crossreference "><a href="12_002.html#l12.4">Listing 12.4</a></span> shows how you can include the <samp class="listingcharacter listingcharacter">cookie-session</samp> and <samp class="listingcharacter listingcharacter">body-parser</samp> middleware.</p>
        <div class="imagebox figure-type"><a href="img-f12.1.html" id="f12.1"><img alt="Login Screen" id="img-f12.1" src="bilderklein/klein12_001.png"/></a></div>
        <p class="caption "><b>Figure 12.1</b>    
            <a id="p361"/>Login Screen</p>
        <div class="listing " id="l12.4"><pre><span class="rot">import</span><span class="schwarz"> express </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'express'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> dirname </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'path'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> fileURLToPath </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'url'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">import</span><span class="schwarz"> cookieSession </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'cookie-session'</span><span class="schwarz">;</span><br/> </samp></span><br/><span class="rot">const</span><span class="schwarz"> app </span><span class="dunkelblau">=</span><span class="schwarz"> express();</span><br/> <br/><span class="bold"><samp class="listingcharacter listingcharacter">app.use(<br/>  cookieSession({<br/>    name: <span class="hellblau">'session'</span><span class="schwarz">,</span><br/>    keys: [<span class="hellblau">'key1'</span><span class="schwarz">, </span><span class="hellblau">'key2'</span><span class="schwarz">],</span><br/>  }),<br/>);<br/>app.use(express.urlencoded({ extended: <span class="rot">false</span><span class="schwarz"> }));</span><br/> </samp></span><br/>app.set(<span class="hellblau">'views'</span><span class="schwarz">, </span><span class="violett">`${dirname(fileURLToPath(import.meta.url))}/app/views`</span><span class="schwarz">);</span><br/>app.set(<span class="hellblau">'view engine'</span><span class="schwarz">, </span><span class="hellblau">'pug'</span><span class="schwarz">);</span><br/> <br/>app.get(<span class="hellblau">'/'</span><span class="schwarz">, (request, response) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>  response.render(<span class="hellblau">'login'</span><span class="schwarz">);</span><br/>});<br/> <br/><a id="p362"/>app.listen(8080, () <span class="dunkelblau">=&gt;</span><span class="schwarz"><br/></span>  <span class="magenta">console</span><span class="schwarz">.log(</span><span class="hellblau">'Server is listening to http://localhost:8080'</span><span class="schwarz">),</span><br/>); <span class="schwarz"/></pre></div>
        <p class="caption "><b>Listing 12.4</b>    
            Middleware for the Login Process (index.js)</p>
        <p class="standard">The body parser<a class="indexanchor" id="i12_18"/> makes sure that you can easily access the data transmitted via <samp class="listingcharacter listingcharacter">POST</samp>, that is, the user name and password. The <samp class="listingcharacter listingcharacter">cookie-session</samp><a class="indexanchor" id="i12_19"/> middleware provides you with a session that allows you to store a user’s login status for a particular session<a class="indexanchor" id="i12_20"/>. With these adjustments, you can now move on to defining the other routes. In total, you need three more routes in your application for the next step. The first route is used for immediate login, the second as a destination for logged-in users, and the third allows a user to log out. To keep your application’s source code uncluttered, you should swap out the route definition<a class="indexanchor" id="i12_21"/> to a separate file named <span class="italic">index.js</span> in the <span class="italic">app</span> directory. <span class="crossreference "><a href="12_002.html#l12.5">Listing 12.5</a></span> contains the routes and their corresponding callback functions.</p>
        <div class="listing " id="l12.5"><pre><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> Router </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'express'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> checkAuth </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./check-auth.js'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="rot">const</span><span class="schwarz"> router </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="schwarz">Router();</span><span class="schwarz"><br/></span> <br/>router<span class="schwarz">.get(</span><span class="hellblau">'/'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">request</span><span class="schwarz">,</span><span class="schwarz"> response</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  response<span class="schwarz">.render(</span><span class="hellblau">'login'</span><span class="schwarz">);</span><span class="schwarz"><br/></span><span class="schwarz">});</span><span class="schwarz"><br/></span> <br/>router<span class="schwarz">.post(</span><span class="hellblau">'/login'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">request</span><span class="schwarz">,</span><span class="schwarz"> response</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="rot">const</span><span class="schwarz"> user </span><span class="dunkelblau">=</span><span class="schwarz"> request</span><span class="schwarz">.</span><span class="schwarz">body</span><span class="schwarz">.</span><span class="schwarz">username</span><span class="schwarz">;</span><span class="schwarz"><br/></span>  <span class="rot">const</span><span class="schwarz"> pw </span><span class="dunkelblau">=</span><span class="schwarz"> request</span><span class="schwarz">.</span><span class="schwarz">body</span><span class="schwarz">.</span><span class="schwarz">password</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/>  <span class="rot">if</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">user </span><span class="dunkelblau">===</span><span class="schwarz"> </span><span class="hellblau">'u1'</span><span class="schwarz"> </span><span class="dunkelblau">&amp;&amp;</span><span class="schwarz"> pw </span><span class="dunkelblau">===</span><span class="schwarz"> </span><span class="hellblau">'test'</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    request<span class="schwarz">.</span><span class="schwarz">session</span><span class="schwarz">.</span><span class="schwarz">user </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="hellblau">'u1'</span><span class="schwarz">;</span><span class="schwarz"><br/></span>  <span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">else</span><span class="schwarz"> </span><span class="rot">if</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">user </span><span class="dunkelblau">===</span><span class="schwarz"> </span><span class="hellblau">'u2'</span><span class="schwarz"> </span><span class="dunkelblau">&amp;&amp;</span><span class="schwarz"> pw </span><span class="dunkelblau">===</span><span class="schwarz"> </span><span class="hellblau">'test'</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    request<span class="schwarz">.</span><span class="schwarz">session</span><span class="schwarz">.</span><span class="schwarz">user </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="hellblau">'u2'</span><span class="schwarz">;</span><span class="schwarz"><br/></span>  <span class="schwarz">}</span><span class="schwarz"><br/></span> <br/>  response<span class="schwarz">.redirect(</span><span class="hellblau">'/chat'</span><span class="schwarz">);</span><span class="schwarz"><br/></span><span class="schwarz">});</span><span class="schwarz"><br/></span> <br/>router<span class="schwarz">.get(</span><span class="hellblau">'/chat'</span><span class="schwarz">,</span><span class="schwarz"> checkAuth</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">request</span><span class="schwarz">,</span><span class="schwarz"> response</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  response<span class="schwarz">.render(</span><span class="hellblau">'chat'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> user</span><span class="schwarz">:</span><span class="schwarz"> request</span><span class="schwarz">.</span><span class="schwarz">session</span><span class="schwarz">.</span><span class="schwarz">user </span><span class="schwarz">});</span><span class="schwarz"><br/></span><span class="schwarz">});</span><span class="schwarz"><br/></span> <br/>router<span class="schwarz">.get(</span><span class="hellblau">'/logout'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">request</span><span class="schwarz">,</span><span class="schwarz"> response</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="rot">delete</span><span class="schwarz"> request</span><span class="schwarz">.</span><span class="schwarz">session</span><span class="schwarz">.</span><span class="schwarz">user</span><span class="schwarz">;</span><span class="schwarz"><br/></span>  response<span class="schwarz">.redirect(</span><span class="hellblau">'/'</span><span class="schwarz">);</span><span class="schwarz"><br/></span><span class="schwarz"><a id="p363"/>});</span><span class="schwarz"><br/></span> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> router </span><span class="schwarz">};</span><span class="schwarz"> </span></pre></div>
        <p class="caption "><b>Listing 12.5</b>    
            Login and Logout (app/index.js)</p>
        <p class="standard">For the routes<a class="indexanchor" id="i12_22"/> to be included correctly, you must also make some adjustments to the entry file in your application. <span class="crossreference "><a href="12_002.html#l12.6">Listing 12.6</a></span> contains the corresponding changes.</p>
        <div class="listing " id="l12.6"><pre><span class="rot">import</span><span class="schwarz"> express </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'express'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> dirname </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'path'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> fileURLToPath </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'url'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> cookieSession </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'cookie-session'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">import</span><span class="schwarz"> { router } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./app/index.js'</span><span class="schwarz">;</span><br/> </samp></span><br/><span class="rot">const</span><span class="schwarz"> app </span><span class="dunkelblau">=</span><span class="schwarz"> express();</span><br/> <br/>app.use(<br/>  cookieSession({<br/>    name: <span class="hellblau">'session'</span><span class="schwarz">,</span><br/>    keys: [<span class="hellblau">'key1'</span><span class="schwarz">, </span><span class="hellblau">'key2'</span><span class="schwarz">],</span><br/>  }),<br/>);<br/>app.use(express.urlencoded({ extended: <span class="rot">false</span><span class="schwarz"> }));</span><br/> <br/>app.set(<span class="hellblau">'views'</span><span class="schwarz">, </span><span class="violett">`${dirname(fileURLToPath(import.meta.url))}/app/views`</span><span class="schwarz">);</span><br/>app.set(<span class="hellblau">'view engine'</span><span class="schwarz">, </span><span class="hellblau">'pug'</span><span class="schwarz">);</span><br/> <br/>app.get(<span class="hellblau">'/'</span><span class="schwarz">, (request, response) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>  response.render(<span class="hellblau">'login'</span><span class="schwarz">);</span><br/>});<br/> <br/><span class="bold"><samp class="listingcharacter listingcharacter">app.use(router);<br/> </samp></span><br/>app.listen(8080, () <span class="dunkelblau">=&gt;</span><span class="schwarz"><br/></span>  <span class="magenta">console</span><span class="schwarz">.log(</span><span class="hellblau">'Server is listening to http://localhost:8080'</span><span class="schwarz">),</span><br/>); <span class="schwarz"/></pre></div>
        <p class="caption "><b>Listing 12.6</b>    
            Customization of the Entry File (index.js)</p>
        <p class="standard">The most important part of the route definition at this moment is the <samp class="listingcharacter listingcharacter">post</samp> method for the <samp class="listingcharacter listingcharacter">/login route</samp>. The form from <span class="crossreference "><a href="12_002.html#l12.3">Listing 12.3</a></span> sends the login information directly to this route. Through the body parser, you can access the user name<a class="indexanchor" id="i12_23"/> and password<a class="indexanchor" id="i12_24"/> within the callback function via the <samp class="listingcharacter listingcharacter">request.body</samp> object. To keep the example simple and clear, only two users are provided here. Typically, at this point, you would include a database <a id="p364"/>and check to see if the user exists. The <samp class="listingcharacter listingcharacter">cookie-session</samp> middleware enables you to access the <samp class="listingcharacter listingcharacter">session</samp> property within the <samp class="listingcharacter listingcharacter">request</samp> object and store the user name here. Once the user name is verified, the user gets redirected to the <samp class="listingcharacter listingcharacter">/chat</samp> route. Once logged in, a user should also be able to log out. This task is enabled by the <samp class="listingcharacter listingcharacter">/logout</samp> route, which deletes the <samp class="listingcharacter listingcharacter">request.session.user</samp><a class="indexanchor" id="i12_25"/> property and then redirects the user back to the login page. The <samp class="listingcharacter listingcharacter">/chat</samp> route has a specific feature: this route uses the <samp class="listingcharacter listingcharacter">checkAuth</samp><a class="indexanchor" id="i12_26"/> middleware located in the <span class="italic">check-auth.js</span> file in the <span class="italic">app</span> directory and ensures that only logged-in users are allowed to use this route. <span class="crossreference "><a href="12_002.html#l12.7">Listing 12.7</a></span> shows the corresponding source code.</p>
        <div class="listing " id="l12.7"><pre><span class="rot">export</span><span class="schwarz"> </span><span class="rot">default</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">checkAuth(</span><span class="schwarz">request</span><span class="schwarz">,</span><span class="schwarz"> response</span><span class="schwarz">,</span><span class="schwarz"> next</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="rot">if</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="dunkelblau">!</span><span class="schwarz">request</span><span class="schwarz">.</span><span class="schwarz">session</span><span class="schwarz">.</span><span class="schwarz">user</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    response<span class="schwarz">.redirect(</span><span class="hellblau">'/'</span><span class="schwarz">);</span><span class="schwarz"><br/></span>  <span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">else</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="schwarz">next();</span><span class="schwarz"><br/></span>  <span class="schwarz">}</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"> </span></pre></div>
        <p class="caption "><b>Listing 12.7</b>    
            The “checkAuth” Middleware (app/check-auth.js)</p>
        <p class="standard">This middleware checks whether the <samp class="listingcharacter listingcharacter">request.session.user</samp> property is set. If this is the case, the next callback function of the routing chain is executed. If a user hasn’t logged in, they’ll be redirected to the registration form. The callback function of the <samp class="listingcharacter listingcharacter">/chat</samp> route ensures that the <span class="italic">chat.pug</span> template is rendered from the <span class="italic">app/views</span> directory. However, before we turn to its implementation, we first need to prepare the server-side WebSocket interface. The source code for the <span class="italic">chat.pug</span> template can be found in <span class="crossreference "><a href="12_003.html#h12.3.2">Section 12.3.2</a></span>. In this context, you pass the name of the currently logged-in user. This state of the application forms the basis for the adjustments that now follow, after which you’ll have a fully functional multiclient chat.</p>
    </div><p class="signatur"/>
                    </body>
                </html>