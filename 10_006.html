<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
                    
        <head><meta content="application/xhtml+xml; charset=utf-8" http-equiv="Content-Type"/>
            <meta content="application/xhtml+xml; charset=utf-8" name="content-type"/>
            <meta content="REST Server" name="title"/>
            <meta content="Sebastian Springer" name="author"/>
            <meta content="Rheinwerk Publishing" name="publisher"/>
            <meta content="© 2022 by Rheinwerk Publishing Inc., Boston (MA)" name="copyright"/>
            <meta content="Node.js - The Comprehensive Guide - REST Server" name="description"/>
            <meta content="en" name="language"/>
            <title>REST Server</title>
            <link href="common/main.css" rel="stylesheet" type="text/css"/>
<meta content="urn:uuid:e0000000-0000-0000-0000-000029756394" name="Adept.expected.resource"/>
        </head>
    


                    <body class="office_us type_kapitel">
                        <div id="main">
        <h2 class="t2" id="h10.6">10.6    Authentication via JWTs<a class="indexanchor" id="i10_48"/></h2>
        <p class="standard">Until now, anyone who has access to your REST interface can also query it and read the data. However, this is by no means acceptable for an application that works with sensitive data. The solution to this problem, as in the previous chapter, is authentication. However, classic authentication via a login form is out of the question for a web service because the user doesn’t usually work directly with the service. Furthermore, storing credentials in a server-side session violates the stateless nature of REST. As a result, a <a id="p317"/>token-based login process has become the accepted authentication mechanism for REST interfaces. In this context, <span class="italic">JSON web tokens</span> (JWTs<a class="indexanchor" id="i10_49"/>) are often used.</p>
        <p class="standard">JWTs are standardized in request for comment (RFC) 7519 and can thus be used for authentication processes within a system as well as between multiple systems. A JWT is an encoded character string consisting of three parts: the header, the payload, and a signature. The header contains information about the token itself, such as the type or the algorithm used to encode it. The payload contains payload data that can be used by the server, such as information about the user. Finally, the signature is used to verify the integrity of the token.</p>
        <p class="standard">For Node.js, there are a few libraries available for you to use. In this section, you’ll use the <samp class="listingcharacter listingcharacter">jsonwebtoken</samp><a class="indexanchor" id="i10_50"/> package to generate tokens for your users and the <samp class="listingcharacter listingcharacter">express-jwt</samp><a class="indexanchor" id="i10_51"/> package to verify the tokens. Both packages are installed via the following command: <samp class="listingcharacter listingcharacter">npm install jsonwebtoken express-jwt</samp>.</p>
        
            <h3 class="t3" id="h10.6.1">10.6.1    Login<a class="indexanchor" id="i10_52"/></h3>
            <p class="standard">For users of your REST interface to authenticate, you must first create an interface through which a new token can be generated. For this reason, you need a new route through which users send their credentials to the server; in response, you get the JWT. You swap out the generation of the route to a separate file named <span class="italic">auth.js</span>. <span class="crossreference "><a href="10_006.html#l10.26">Listing 10.26</a></span> contains the implementation of this route.</p>
            <div class="listing " id="l10.26"><pre><span class="rot">import</span><span class="schwarz"> jwt </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'jsonwebtoken'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> { Router } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'express'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> { </span><span class="rot">get</span><span class="schwarz"> } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./user/model.js'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> { createHash } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'crypto'</span><span class="schwarz">;</span><br/> <br/><span class="rot">const</span><span class="schwarz"> router </span><span class="dunkelblau">=</span><span class="schwarz"> Router();</span><br/> <br/>router.post(<span class="hellblau">'/'</span><span class="schwarz">, </span><span class="rot">async</span><span class="schwarz"> (request, response) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>  <span class="rot">try</span><span class="schwarz"> {</span><br/>    <span class="rot">const</span><span class="schwarz"> user </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> get({</span><br/>      username: request.body.username,<br/>      password: createHash(<span class="hellblau">'md5'</span><span class="schwarz">).update(request.body.password).digest(</span><span class="hellblau">'hex'</span><span class="schwarz">)</span><br/>    });<br/>    <span class="rot">if</span><span class="schwarz"> (user) {</span><br/>      <span class="rot">const</span><span class="schwarz"> payload </span><span class="dunkelblau">=</span><span class="schwarz"> { ...user };</span><br/>      <span class="rot">delete</span><span class="schwarz"> payload.password;</span><br/>      <span class="rot">const</span><span class="schwarz"> token </span><span class="dunkelblau">=</span><span class="schwarz"> jwt.sign(payload, </span><span class="hellblau">'secret'</span><span class="schwarz">);</span><br/>      response.json({ token });<br/>    } <span class="rot">else</span><span class="schwarz"> {</span><br/>      response.status(401).json(<span class="hellblau">'unauthorized'</span><span class="schwarz">);</span><br/>    }<br/><a id="p318"/>  } <span class="rot">catch </span><span class="schwarz">(</span><span class="rot">e</span><span class="schwarz">) {</span><br/>    <span class="magenta">console</span><span class="schwarz">.error(e);</span><br/>    response.status(401).json(<span class="hellblau">'unauthorized'</span><span class="schwarz">);</span><br/>  }<br/>});<br/> <br/><span class="rot">export</span><span class="schwarz"> { router }; </span><span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 10.26</b>    
            Route for Creating a New JWT (auth.js)</p>
            <p class="standard">The implementation in <span class="crossreference "><a href="10_006.html#l10.26">Listing 10.26</a></span> assumes that the user submits their data via a <samp class="listingcharacter listingcharacter">POST</samp> request in the <samp class="listingcharacter listingcharacter">username</samp> and <samp class="listingcharacter listingcharacter">password</samp> fields. The existing <samp class="listingcharacter listingcharacter">user</samp> model is used to verify the data and to read the remaining user data. The <samp class="listingcharacter listingcharacter">get</samp> method of the model is used to read the data record using the user name and password. You must make sure that the password is stored as a hash in the database. This means you have to search for the matching hash value and not for the password in plain text. If an error<a class="indexanchor" id="i10_53"/> occurs in the process, a message with status code <samp class="listingcharacter listingcharacter">401</samp>, <samp class="listingcharacter listingcharacter">unauthorized</samp><a class="indexanchor" id="i10_54"/>, is returned to the user. The same result occurs if the login process fails.</p>
            <p class="standard">Upon a successful login, the password is deleted from the user object and encoded into the token using the <samp class="listingcharacter listingcharacter">sign</samp> method<a class="indexanchor" id="i10_55"/> of the <samp class="listingcharacter listingcharacter">jwt</samp> object, and then the token is sent to the client. The router created in this file is then included in the initial file of your application, as shown in <span class="crossreference "><a href="10_006.html#l10.27">Listing 10.27</a></span>.</p>
            <div class="listing " id="l10.27"><pre><span class="rot">import</span><span class="schwarz"> express </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'express'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> morgan </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'morgan'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> { router </span><span class="rot">as</span><span class="schwarz"> movieRouter } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./movie/index.js'</span><span class="schwarz">;</span><br/><span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">import</span><span class="schwarz"> { router </span><span class="rot">as</span><span class="schwarz"> loginRouter } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./auth.js'</span><span class="schwarz">;</span><br/> </samp></span><br/><span class="rot">const</span><span class="schwarz"> app </span><span class="dunkelblau">=</span><span class="schwarz"> express();</span><br/> <br/>app.use(morgan(<span class="hellblau">'common'</span><span class="schwarz">, { immediate: </span><span class="rot">true</span><span class="schwarz"> }));</span><br/> <br/>app.use(express.json());<br/> <br/><span class="bold"><samp class="listingcharacter listingcharacter">app.use(<span class="hellblau">'/login'</span><span class="schwarz">, loginRouter);</span></samp></span><br/>app.use(<span class="hellblau">'/movie'</span><span class="schwarz">, movieRouter);</span><br/> <br/>app.get(<span class="hellblau">'/'</span><span class="schwarz">, (request, response) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> response.redirect(</span><span class="hellblau">'/movie'</span><span class="schwarz">));</span><br/> <br/>app.listen(8080, () <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>  <span class="magenta">console</span><span class="schwarz">.log(</span><span class="hellblau">'Server is listening to http://localhost:8080'</span><span class="schwarz">);</span><br/>}); <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 10.27</b>    
            Integrating the Login Route (index.js)</p>
            <p class="standard"><a id="p319"/>When you send your user name and password in a <samp class="listingcharacter listingcharacter">POST</samp> request to <span class="italic">http://localhost:8080/login</span> after restarting your application, you’ll receive a JSON response with the token in return. You’ll use this response in the following steps to access the resources of your application. <span class="crossreference "><a href="10_006.html#l10.28">Listing 10.28</a></span> contains a concrete example of such an application.</p>
            <div class="listing " id="l10.28"><pre><span class="bold"><samp class="listingcharacter listingcharacter">$ curl  -X POST -H "Content-Type: application/json" -d '{"username": "sspringer", "password": "test"}' http://localhost:8080/login</samp></span><br/>{"token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MSwiZmlyc3RuYW1lIjoiU2ViYXN0aWFuIiwibGFzdG5hbWUiOiJTcHJpbmdlciIsInVzZXJuYW1lIjoic3NwcmluZ2VyIiwiaWF0IjoxNjI4NzAzMzYyfQ.mycuTV9EtYhu7lbN_tKQgKCC2vDPBuy6JT_kMvN9JDk"} </pre></div>
            <p class="caption "><b>Listing 10.28</b>    
            Logging in to the Application</p>
            <p class="standard">The token request not only works on the console but also via a GUI, as shown in <span class="crossreference "><a href="10_006.html#f10.8">Figure 10.8</a></span>.</p>
            <div class="imagebox figure-type"><a href="img-f10.8.html" id="f10.8"><img alt="Login with Postman" id="img-f10.8" src="bilderklein/klein10_008.png"/></a></div>
            <p class="caption "><b>Figure 10.8</b>    
            Login with Postman</p>
        
        
            <h3 class="t3" id="h10.6.2">10.6.2    Safeguarding Resources<a class="indexanchor" id="i10_56"/></h3>
            <p class="standard">The <samp class="listingcharacter listingcharacter">express-jwt</samp> package now allows you to safeguard the entire movie resource. For this purpose, you include the <samp class="listingcharacter listingcharacter">express-jwt</samp> package in the initial file and use the middleware<a class="indexanchor" id="i10_57"/> provided by the package, as shown in <span class="crossreference "><a href="10_006.html#l10.29">Listing 10.29</a></span>.</p>
            <div class="listing " id="l10.29"><pre><span class="rot"><a id="p320"/>import</span><span class="schwarz"> express </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'express'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> morgan </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'morgan'</span><span class="schwarz">;</span><br/><span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">import</span><span class="schwarz"> expressJwt </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'express-jwt'</span><span class="schwarz">;</span></samp></span><br/><span class="rot">import</span><span class="schwarz"> { router </span><span class="rot">as</span><span class="schwarz"> movieRouter } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./movie/index.js'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> { router </span><span class="rot">as</span><span class="schwarz"> loginRouter } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./auth.js'</span><span class="schwarz">;</span><br/> <br/><span class="rot">const</span><span class="schwarz"> app </span><span class="dunkelblau">=</span><span class="schwarz"> express();</span><br/> <br/>app.use(morgan(<span class="hellblau">'common'</span><span class="schwarz">, { immediate: </span><span class="rot">true</span><span class="schwarz"> }));</span><br/> <br/>app.use(express.json());<br/> <br/>app.use(<span class="hellblau">'/login'</span><span class="schwarz">, loginRouter);</span><br/>app.use(<br/>  <span class="hellblau">'/movie'</span><span class="schwarz">,</span><br/>  <span class="bold"><samp class="listingcharacter listingcharacter">expressJwt({ secret: <span class="hellblau">'secret'</span><span class="schwarz">, algorithms: [</span><span class="hellblau">'HS256'</span><span class="schwarz">] }),</span></samp></span><br/>  movieRouter,<br/>);<br/> <br/><span class="bold"><samp class="listingcharacter listingcharacter">app.use((err, request, response, next) <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>  <span class="rot">if</span><span class="schwarz"> (err.name </span><span class="dunkelblau">===</span><span class="schwarz"> </span><span class="hellblau">'UnauthorizedError'</span><span class="schwarz">) {</span><br/>    response.status(401).json(<span class="hellblau">'unauthorized'</span><span class="schwarz">);</span><br/>  } <span class="rot">else</span><span class="schwarz"> {</span><br/>    next();<br/>  }<br/>});<br/> </samp></span><br/>app.get(<span class="hellblau">'/'</span><span class="schwarz">, (request, response) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> response.redirect(</span><span class="hellblau">'/movie'</span><span class="schwarz">));</span><br/> <br/>app.listen(8080, () <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>  <span class="magenta">console</span><span class="schwarz">.log(</span><span class="hellblau">'Server is listening to http://localhost:8080'</span><span class="schwarz">);</span><br/>}); <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 10.29</b>    
            Using the “express-jwt” Middleware (index.js)</p>
            <p class="standard">When you call the <samp class="listingcharacter listingcharacter">express-jwt</samp> middleware, you pass the same <samp class="listingcharacter listingcharacter">secret</samp> that you used to generate the token and the <samp class="listingcharacter listingcharacter">algorithms</samp> property with an array containing the value <samp class="listingcharacter listingcharacter">HS256</samp><a class="indexanchor" id="i10_58"/>. This value represents Hash-Based Message Authentication Code (HMAC)<a class="indexanchor" id="i10_59"/> with SHA-256<a class="indexanchor" id="i10_60"/> and instructs <samp class="listingcharacter listingcharacter">express-jwt</samp> to use this algorithm for verifying the token. The middleware checks the token<a class="indexanchor" id="i10_61"/> passed by the user and decrypts it with this information. If the middleware detects an invalid token, an exception is triggered. You can use the following middleware function to convert this exception into a message with status code <samp class="listingcharacter listingcharacter">401</samp>, <samp class="listingcharacter listingcharacter">unauthorized</samp>.</p>
            <p class="standard"><a id="p321"/>The token is transmitted during the request process via the <samp class="listingcharacter listingcharacter">authorization</samp> header. In Postman, you can configure this conveniently via a form. If you use cURL to test your interface, you must specify the header with the <samp class="listingcharacter listingcharacter">-H</samp> option. <span class="crossreference "><a href="10_006.html#l10.30">Listing 10.30</a></span> shows an example of such a request.</p>
            <div class="listing " id="l10.30"><pre>$ curl -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6 MSwiZmlyc3RuYW1lIjoiU2ViYXN0aWFuIiwibGFzdG5hbWUiOiJTcHJpbmdlciIsInVzZXJuYW1lIjoic3NwcmluZ2VyIiwiaWF0IjoxNjI4NzAzMzYyfQ.mycuTV9EtYhu7lbN_tKQgKCC2vDPBuy6JT_kMvN9JDk" -H "Accept: application/json" http://localhost:8080/movie </pre></div>
            <p class="caption "><b>Listing 10.30</b>    
            cURL Request with Authorization Header</p>
            <p class="standard">In Postman, you can use the <span class="screenelement">Headers</span> tab to set the authorization header for the queries. To do this, you must add the <span class="screenelement">Authorization</span> field as a header and set the value to <span class="screenelement">Bearer</span><a class="indexanchor" id="i10_62"/>, followed by the token you previously had issued to you via the login endpoint. <span class="crossreference "><a href="10_006.html#f10.9">Figure 10.9</a></span> shows the status in Postman.</p>
            <div class="imagebox figure-type"><a href="img-f10.9.html" id="f10.9"><img alt="Read Request with Authorization Header in Postman" id="img-f10.9" src="bilderklein/klein10_009.png"/></a></div>
            <p class="caption "><b>Figure 10.9</b>    
            Read Request with Authorization Header in Postman</p>
        
        
            <h3 class="t3" id="h10.6.3">10.6.3    Accessing User Information in the Token<a class="indexanchor" id="i10_63"/></h3>
            <p class="standard">However, the middleware of the <samp class="listingcharacter listingcharacter">express-jwt</samp> package not only checks the correctness of the token but also extends the <samp class="listingcharacter listingcharacter">request</samp> object with the user information so that you <a id="p322"/>can access the information via <samp class="listingcharacter listingcharacter">request.user</samp>. <span class="crossreference "><a href="10_006.html#l10.31">Listing 10.31</a></span> shows how you can read the user ID from the <samp class="listingcharacter listingcharacter">request</samp> object to use it in the database queries.</p>
            <div class="listing " id="l10.31"><pre><span class="rot">import</span><span class="schwarz"> { getAll, </span><span class="rot">get</span><span class="schwarz">, save, remove } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./model.js'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> jsonXml </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'jsontoxml'</span><span class="schwarz">;</span><br/> <br/><span class="rot">function</span><span class="schwarz"> getLinks(current, base) {</span><br/>  <span class="rot">const</span><span class="schwarz"> links </span><span class="dunkelblau">=</span><span class="schwarz"> [</span><br/>    { rel: <span class="hellblau">'base'</span><span class="schwarz">, href: base </span><span class="dunkelblau">+</span><span class="schwarz"> </span><span class="hellblau">'/'</span><span class="schwarz"> },</span><br/>    { rel: <span class="hellblau">'sort-ascending'</span><span class="schwarz">, href: base </span><span class="dunkelblau">+</span><span class="schwarz"> </span><span class="hellblau">'/?sort=asc'</span><span class="schwarz"> },</span><br/>    { rel: <span class="hellblau">'sort-descending'</span><span class="schwarz">, href: base </span><span class="dunkelblau">+</span><span class="schwarz"> </span><span class="hellblau">'/?sort=desc'</span><span class="schwarz"> },</span><br/>  ];<br/>  <span class="rot">return</span><span class="schwarz"> links.map((link) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>    <span class="rot">if</span><span class="schwarz"> (current.length </span><span class="dunkelblau">&gt;</span><span class="schwarz"> 0 </span><span class="dunkelblau">&amp;&amp;</span><span class="schwarz"> link.rel.includes(current)) {</span><br/>      link.rel <span class="dunkelblau">=</span><span class="schwarz"> </span><span class="hellblau">'self'</span><span class="schwarz">;</span><br/>    } <span class="rot">else</span><span class="schwarz"> </span><span class="rot">if</span><span class="schwarz"> (current.length </span><span class="dunkelblau">===</span><span class="schwarz"> 0 </span><span class="dunkelblau">&amp;&amp;</span><span class="schwarz"> link.rel </span><span class="dunkelblau">===</span><span class="schwarz"> </span><span class="hellblau">'base'</span><span class="schwarz">) {</span><br/>      link.rel <span class="dunkelblau">=</span><span class="schwarz"> </span><span class="hellblau">'self'</span><span class="schwarz">;</span><br/>    }<br/>    <span class="rot">return</span><span class="schwarz"> link;</span><br/>  });<br/>}<br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> listAction(request, response) {</span><br/>  <span class="rot">try</span><span class="schwarz"> {</span><br/>    <span class="rot">const</span><span class="schwarz"> options </span><span class="dunkelblau">=</span><span class="schwarz"> {</span><br/>      userId: <span class="bold"><samp class="listingcharacter listingcharacter">request.user.id</samp></span>,<br/>      sort: request.query.sort <span class="dunkelblau">?</span><span class="schwarz"> request.query.sort : </span><span class="hellblau">''</span><span class="schwarz">,</span><br/>    };<br/> <br/>    <span class="rot">const</span><span class="schwarz"> movies </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> getAll(options);</span><br/>    <span class="rot">const</span><span class="schwarz"> moviesResponse </span><span class="dunkelblau">=</span><span class="schwarz"> {</span><br/>      movies,<br/>      links: getLinks(options.sort, request.baseUrl),<br/>    };<br/> <br/>    response.format({<br/>      xml() {<br/>        moviesResponse.movies <span class="dunkelblau">=</span><span class="schwarz"> moviesResponse.movies.map((movie) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> ({</span><br/>          movie,<br/>        }));<br/>        response.send(jsonXml(moviesResponse));<br/>      },<br/>      json() {<br/>        response.json(moviesResponse);<br/><a id="p323"/>      },<br/>      default() {<br/>        response.json(moviesResponse);<br/>      },<br/>    });<br/>  } <span class="rot">catch </span><span class="schwarz">(</span><span class="rot">e</span><span class="schwarz">) {</span><br/>    <span class="magenta">console</span><span class="schwarz">.error(e);</span><br/>    response.status(500).send(<span class="hellblau">'An error happened'</span><span class="schwarz">);</span><br/>  }<br/>}<br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> detailAction(request, response) {</span><br/>  <span class="rot">try</span><span class="schwarz"> {</span><br/>    <span class="rot">const</span><span class="schwarz"> movie </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> get(request.params.id, </span><span class="bold"><samp class="listingcharacter listingcharacter">request.user.id</samp></span>);<br/>    <span class="rot">if</span><span class="schwarz"> (</span><span class="dunkelblau">!</span><span class="schwarz">movie) {</span><br/>      response.status(404).send(<span class="hellblau">'Not Found'</span><span class="schwarz">);</span><br/>      <span class="rot">return</span><span class="schwarz">;</span><br/>    }<br/> <br/>    <span class="rot">const</span><span class="schwarz"> moviesResponse </span><span class="dunkelblau">=</span><span class="schwarz"> {</span><br/>      ...movie,<br/>      links: [{ rel: <span class="hellblau">'self'</span><span class="schwarz">, href: </span><span class="violett">`${request.baseUrl}/${movie.id}`</span><span class="schwarz"> }],</span><br/>    };<br/>    response.json(moviesResponse);<br/>  } <span class="rot">catch </span><span class="schwarz">(</span><span class="rot">e</span><span class="schwarz">) {</span><br/>    <span class="magenta">console</span><span class="schwarz">.error(e);</span><br/>    response.status(500).send(<span class="hellblau">'An error happened'</span><span class="schwarz">);</span><br/>  }<br/>}<br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> createAction(request, response) {</span><br/>  <span class="rot">try</span><span class="schwarz"> {</span><br/>    <span class="rot">const</span><span class="schwarz"> movie </span><span class="dunkelblau">=</span><span class="schwarz"> {</span><br/>      title: request.body.title,<br/>      year: request.body.year,<br/>      <span class="rot">public</span><span class="schwarz">: parseInt(request.body.</span><span class="rot">public</span><span class="schwarz">, 10) </span><span class="dunkelblau">===</span><span class="schwarz"> 1 </span><span class="dunkelblau">?</span><span class="schwarz"> 1 : 0,</span><br/>    };<br/>    <span class="rot">const</span><span class="schwarz"> newMovie </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> save(movie, </span><span class="bold"><samp class="listingcharacter listingcharacter">request.user.id</samp></span>);<br/>    response.status(201).json(newMovie);<br/>  } <span class="rot">catch </span><span class="schwarz">(</span><span class="rot">e</span><span class="schwarz">) {</span><br/>    <span class="magenta">console</span><span class="schwarz">.error(e);</span><br/>    response.status(500).json(<span class="hellblau">'An error happened'</span><span class="schwarz">);</span><br/>  }<br/>}<br/> <br/><span class="rot"><a id="p324"/>export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> updateAction(request, response) {</span><br/>  <span class="rot">try</span><span class="schwarz"> {</span><br/>    <span class="rot">const</span><span class="schwarz"> movie </span><span class="dunkelblau">=</span><span class="schwarz"> {</span><br/>      id: request.params.id,<br/>      title: request.body.title,<br/>      year: request.body.year,<br/>      <span class="rot">public</span><span class="schwarz">: parseInt(request.body.</span><span class="rot">public</span><span class="schwarz">, 10) </span><span class="dunkelblau">===</span><span class="schwarz"> 1 </span><span class="dunkelblau">?</span><span class="schwarz"> 1 : 0,</span><br/>    };<br/> <br/>    <span class="rot">const</span><span class="schwarz"> updatedMovie </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> save(movie, </span><span class="bold"><samp class="listingcharacter listingcharacter">request.user.id</samp></span>);<br/>    response.json(movie);<br/>  } <span class="rot">catch </span><span class="schwarz">(</span><span class="rot">e</span><span class="schwarz">) {</span><br/>    <span class="magenta">console</span><span class="schwarz">.error(e);</span><br/>    response.status(500).json(<span class="hellblau">'An error happened'</span><span class="schwarz">);</span><br/>  }<br/>}<br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> deleteAction(request, response) {</span><br/>  <span class="rot">try</span><span class="schwarz"> {</span><br/>    <span class="rot">const</span><span class="schwarz"> id </span><span class="dunkelblau">=</span><span class="schwarz"> parseInt(request.params.id, 10);</span><br/>    <span class="rot">await</span><span class="schwarz"> remove(id, </span><span class="bold"><samp class="listingcharacter listingcharacter">request.user.id</samp></span>);<br/>    response.status(204).send();<br/>  } <span class="rot">catch </span><span class="schwarz">(</span><span class="rot">e</span><span class="schwarz">) {</span><br/>    <span class="magenta">console</span><span class="schwarz">.error(e);</span><br/>    response.status(500).send(<span class="hellblau">'An error happened'</span><span class="schwarz">);</span><br/>  }<br/>} <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 10.31</b>    
            Using the User ID from the JWT (movie/controller.js)</p>
            <p class="standard">With these customizations, you’ve created a REST interface that supports creating, reading, updating, and deleting data. You’ve also secured the interfaces with JWT. The next section describes how you can document this interface in such a way that it’s convenient for other developers to use it.</p>
        
    </div><p class="signatur"/>
                    </body>
                </html>