<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
                    
        <head><meta content="application/xhtml+xml; charset=utf-8" http-equiv="Content-Type"/>
            <meta content="application/xhtml+xml; charset=utf-8" name="content-type"/>
            <meta content="GraphQL" name="title"/>
            <meta content="Sebastian Springer" name="author"/>
            <meta content="Rheinwerk Publishing" name="publisher"/>
            <meta content="© 2022 by Rheinwerk Publishing Inc., Boston (MA)" name="copyright"/>
            <meta content="Node.js - The Comprehensive Guide - GraphQL" name="description"/>
            <meta content="en" name="language"/>
            <title>GraphQL</title>
            <link href="common/main.css" rel="stylesheet" type="text/css"/>
<meta content="urn:uuid:e0000000-0000-0000-0000-000029756394" name="Adept.expected.resource"/>
        </head>
    


                    <body class="office_us type_kapitel">
                        <div id="main">
        <h2 class="t2" id="h11.5">11.5    Write Accesses to the GraphQL Interface<a class="indexanchor" id="i11_28"/></h2>
        <p class="standard">In the following sections, you’ll learn how to add write operations to your interface. The core component of this type of query is the <samp class="listingcharacter listingcharacter">mutation</samp> type<a class="indexanchor" id="i11_29"/>, which, like the <samp class="listingcharacter listingcharacter">query</samp> type you’ve used so far for read accesses, is a special type in GraphQL. You may define both types only once in your schema. When implementing the resolver functions, you can draw on the already existing model function.</p>
        
            <h3 class="t3" id="h11.5.1">11.5.1    Creating New Data Records<a class="indexanchor" id="i11_30"/></h3>
            <p class="standard">To create new data records, you need to make two enhancements to your schema. You need the <samp class="listingcharacter listingcharacter">mutation</samp> type and a <samp class="listingcharacter listingcharacter">createMovie</samp> field below it. You can model this type similarly to querying a single data record by defining a parameter list that includes the data record you want to create. The return type is a new <samp class="listingcharacter listingcharacter">movie</samp> object. In GraphQL, you may not use an ordinary type you define with the <samp class="listingcharacter listingcharacter">type</samp> keyword as a parameter type for a <a id="p348"/>mutation, so you must define a separate input type. An input type<a class="indexanchor" id="i11_31"/> is introduced with the <samp class="listingcharacter listingcharacter">input</samp> keyword. The structure of the <samp class="listingcharacter listingcharacter">movie</samp> type and of the new input type are similar—the only difference being that the <samp class="listingcharacter listingcharacter">id</samp> may now be optional because it doesn’t yet exist for new data records to be created. <span class="crossreference "><a href="11_005.html#l11.9">Listing 11.9</a></span> shows the adjustments to the schema.</p>
            <div class="listing " id="l11.9"><pre><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> buildSchema </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'graphql'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> expressGraphql </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'express-graphql'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> getAll </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./movie/model.js'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="rot">const</span><span class="schwarz"> schema </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="schwarz">buildSchema(</span><span class="violett">`</span><br/>  type Movie {<br/>    id: Int!<br/>    title: String!<br/>    year: Int<br/>    public: Int<br/>    user: Int<br/>  }<br/> <br/>  <span class="bold"><samp class="listingcharacter listingcharacter">input MovieInput {<br/>    id: Int<br/>    title: String!<br/>    year: Int<br/>    public: Int<br/>    user: Int<br/>  }<br/> </samp></span><br/>  type Query {<br/>    greet: String<br/>    movie(id: Int): [Movie]<br/>  }<br/> <br/>  <span class="bold"><samp class="listingcharacter listingcharacter">type Mutation {<br/>    createMovie(movie: MovieInput): Movie<br/>  }</samp></span><br/>`<span class="schwarz">);</span><br/> <br/><span class="rot">const</span><span class="schwarz"> rootValue </span><span class="dunkelblau">=</span><span class="schwarz"> {...};</span><br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">default</span><span class="schwarz"> expressGraphql.graphqlHTTP({...} </span><span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 11.9</b>    
            Schema Extension for Creating New Data Records (graphql.js)</p>
            <p class="standard">After that, you can implement the corresponding resolver function. <span class="crossreference "><a href="11_005.html#l11.10">Listing 11.10</a></span> shows how this works.</p>
            <div class="listing " id="l11.10"><pre><span class="rot"><a id="p349"/>import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> buildSchema </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'graphql'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> expressGraphql </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'express-graphql'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> getAll</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter">save</samp></span> } <span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./movie/model.js'</span><span class="schwarz">;</span><br/> <br/><span class="rot">const</span><span class="schwarz"> schema </span><span class="dunkelblau">=</span><span class="schwarz"> buildSchema(</span><span class="violett">`...`</span><span class="schwarz">);</span><br/> <br/><span class="rot">const</span><span class="schwarz"> rootValue </span><span class="dunkelblau">=</span><span class="schwarz"> {</span><br/>  greet() {<br/>    <span class="rot">return</span><span class="schwarz"> </span><span class="hellblau">'Hello GraphQL'</span><span class="schwarz">;</span><br/>  },<br/>  <span class="rot">async</span><span class="schwarz"> movie({ id }) {</span><br/>    <span class="rot">const</span><span class="schwarz"> movies </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> getAll({ userId: 1 });</span><br/>    <span class="rot">if</span><span class="schwarz"> (id) {</span><br/>      <span class="rot">return</span><span class="schwarz"> movies.filter((movie) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> movie.id </span><span class="dunkelblau">===</span><span class="schwarz"> id);</span><br/>    }<br/>    <span class="rot">return</span><span class="schwarz"> movies;</span><br/>  },<br/>  <span class="bold"><samp class="listingcharacter listingcharacter">createMovie({ movie }) {<br/>    <span class="rot">return</span><span class="schwarz"> save(movie, 1);</span><br/>  },</samp></span><br/>};<br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">default</span><span class="schwarz"> expressGraphql.graphqlHTTP({...} </span><span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 11.10</b>    
            Resolver Function for Creating a Data Record (graphql.js)</p>
            <p class="standard">As with the parameterized reading of a data record, you also have access to the transferred data for mutations, except that here, it’s not a single <samp class="listingcharacter listingcharacter">id</samp>, but the data record to be created. Within the function, you use the model’s <samp class="listingcharacter listingcharacter">save</samp> function to write the data record to the database. In this call, too, you pass the user ID as a fixed value. With these adjustments, you can switch back to your browser after restarting the application and use GraphiQL to create a new data record.</p>
            <p class="standard">As you can see in <span class="crossreference "><a href="11_005.html#f11.4">Figure 11.4</a></span>, mutations follow the same syntax as the queries you’ve used so far. The only exception is that you must preface your query with the <samp class="listingcharacter listingcharacter">mutation</samp> keyword because GraphiQL assumes a query by default. Then you specify the name of the required mutation, pass the new to be created data record, and define what information you want to receive in return. On the right side of the window, you can see the result of the <samp class="listingcharacter listingcharacter">createMovie</samp> mutation: the newly created data record, including the ID assigned by the database.</p>
            <div class="imagebox figure-type"><a href="img-f11.4.html" id="f11.4"><img alt="Creating a New Data Record" id="img-f11.4" src="bilderklein/klein11_004.png"/></a></div>
            <p class="caption "><b>Figure 11.4</b>    
            <a id="p350"/>Creating a New Data Record</p>
        
        
            <h3 class="t3" id="h11.5.2">11.5.2    Updating and Deleting Data Records<a class="indexanchor" id="i11_32"/></h3>
            <p class="standard">The tasks of updating and deleting existing data records are based on the same concept. First, you extend the schema with two more mutations named <samp class="listingcharacter listingcharacter">updateMovie</samp> and <samp class="listingcharacter listingcharacter">deleteMovie</samp>, as you can see in <span class="crossreference "><a href="11_005.html#l11.11">Listing 11.11</a></span>.</p>
            <div class="listing " id="l11.11"><pre><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> buildSchema </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'graphql'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> expressGraphql </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'express-graphql'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> getAll</span><span class="schwarz">,</span><span class="schwarz"> save </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./movie/model.js'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="rot">const</span><span class="schwarz"> schema </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="schwarz">buildSchema(</span><span class="violett">`</span><br/>  type Movie {<br/>    id: Int!<br/>    title: String!<br/>    year: Int<br/>    public: Int<br/>    user: Int<br/>  }<br/> <br/>  input MovieInput {<br/>    id: Int<br/>    title: String!<br/>    year: Int<br/>    public: Int<br/><a id="p351"/>    user: Int<br/>  }<br/> <br/>  type Query {<br/>    greet: String<br/>    movie(id: Int): [Movie]<br/>  }<br/> <br/>  type Mutation {<br/>    createMovie(movie: MovieInput): Movie<br/>    <span class="bold"><samp class="listingcharacter listingcharacter">updateMovie(movie: MovieInput): Movie<br/>    deleteMovie(id: Int!): Boolean</samp></span><br/>  }<br/>`<span class="schwarz">);</span><br/> <br/><span class="rot">const</span><span class="schwarz"> rootValue </span><span class="dunkelblau">=</span><span class="schwarz"> {...};</span><br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">default</span><span class="schwarz"> expressGraphql.graphqlHTTP({...} </span><span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 11.11</b>    
            Schema Extension for Modifying and Deleting Data Records (graphql.js)</p>
            <p class="standard">As you can see here, with <samp class="listingcharacter listingcharacter">updateMovie</samp>, there’s also an input type<a class="indexanchor" id="i11_33"/> involved, and, as a result, you get the modified movie record back. When deleting via the <samp class="listingcharacter listingcharacter">deleteMovie</samp> mutation, you simply pass the ID of the data record to be deleted and return a Boolean value.</p>
            <p class="standard">The implementation of the corresponding resolver functions is shown in <span class="crossreference "><a href="11_005.html#l11.12">Listing 11.12</a></span>.</p>
            <div class="listing " id="l11.12"><pre><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> buildSchema </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'graphql'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> expressGraphql </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'express-graphql'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> getAll</span><span class="schwarz">,</span><span class="schwarz"> save</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter">remove</samp></span> } <span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./movie/model.js'</span><span class="schwarz">;</span><br/> <br/><span class="rot">const</span><span class="schwarz"> schema </span><span class="dunkelblau">=</span><span class="schwarz"> buildSchema(</span><span class="violett">`...`</span><span class="schwarz">);</span><br/> <br/><span class="rot">const</span><span class="schwarz"> rootValue </span><span class="dunkelblau">=</span><span class="schwarz"> {</span><br/>  greet() {<br/>    <span class="rot">return</span><span class="schwarz"> </span><span class="hellblau">'Hello GraphQL'</span><span class="schwarz">;</span><br/>  },<br/>  <span class="rot">async</span><span class="schwarz"> movie({ id }) {</span><br/>    <span class="rot">const</span><span class="schwarz"> movies </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> getAll({ userId: 1 });</span><br/>    <span class="rot">if</span><span class="schwarz"> (id) {</span><br/>      <span class="rot">return</span><span class="schwarz"> movies.filter((movie) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> movie.id </span><span class="dunkelblau">===</span><span class="schwarz"> id);</span><br/>    }<br/>    <span class="rot">return</span><span class="schwarz"> movies;</span><br/>  },<br/><a id="p352"/>  createMovie({ movie }) {<br/>    <span class="rot">return</span><span class="schwarz"> save(movie, 1);</span><br/>  },<br/>  <span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">async</span><span class="schwarz"> updateMovie({ movie }) {</span><br/>    <span class="rot">await</span><span class="schwarz"> save(movie, 1);</span><br/>    <span class="rot">return</span><span class="schwarz"> movie;</span><br/>  },<br/>  <span class="rot">async</span><span class="schwarz"> deleteMovie({ id }) {</span><br/>    <span class="rot">await</span><span class="schwarz"> remove(id, 1);</span><br/>    <span class="rot">return</span><span class="schwarz"> </span><span class="rot">true</span><span class="schwarz">;</span><br/>  },</samp></span><br/>};<br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">default</span><span class="schwarz"> expressGraphql.graphqlHTTP({...} </span><span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 11.12</b>    
            Resolver Functions for Updating and Deleting (graphql.js)</p>
            <p class="standard">You implement both the <samp class="listingcharacter listingcharacter">updateMovie</samp> and <samp class="listingcharacter listingcharacter">deleteMovie</samp> functions as <samp class="listingcharacter listingcharacter">async</samp> functions. They each expect the result of the model operation and return the modified record in the update case<a class="indexanchor" id="i11_34"/> and the value <samp class="listingcharacter listingcharacter">true</samp> in the delete case.</p>
            <p class="standard">With these adjustments, you can now modify the data record you just created. The corresponding query is shown in <span class="crossreference "><a href="11_005.html#f11.5">Figure 11.5</a></span>.</p>
            <div class="imagebox figure-type"><a href="img-f11.5.html" id="f11.5"><img alt="Modifying an Existing Data Record" id="img-f11.5" src="bilderklein/klein11_005.png"/></a></div>
            <p class="caption "><b>Figure 11.5</b>    
            Modifying an Existing Data Record</p>
            <p class="standard"><a id="p353"/>Deleting the data record works in the same way, as you can see in <span class="crossreference "><a href="11_005.html#f11.6">Figure 11.6</a></span>.</p>
            <div class="imagebox figure-type"><a href="img-f11.6.html" id="f11.6"><img alt="Deleting a Data Record" id="img-f11.6" src="bilderklein/klein11_006.png"/></a></div>
            <p class="caption "><b>Figure 11.6</b>    
            Deleting a Data Record</p>
            <p class="standard">You now have implemented the complete create, read, update, delete (CRUD)<a class="indexanchor" id="i11_35"/> functionality for your Movie database in GraphQL. Currently, however, there is still the problem that your interface is completely unprotected, so anyone who knows the address of your server can access it without restriction. Let’s change that in the next step and add token-based authentication, as we did with the REST interface.</p>
        
    </div><p class="signatur"/>
                    </body>
                </html>