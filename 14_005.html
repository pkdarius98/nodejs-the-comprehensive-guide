<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
                    
        <head><meta content="application/xhtml+xml; charset=utf-8" http-equiv="Content-Type"/>
            <meta content="application/xhtml+xml; charset=utf-8" name="content-type"/>
            <meta content="Web Applications with Nest" name="title"/>
            <meta content="Sebastian Springer" name="author"/>
            <meta content="Rheinwerk Publishing" name="publisher"/>
            <meta content="© 2022 by Rheinwerk Publishing Inc., Boston (MA)" name="copyright"/>
            <meta content="Node.js - The Comprehensive Guide - Web Applications with Nest" name="description"/>
            <meta content="en" name="language"/>
            <title>Web Applications with Nest</title>
            <link href="common/main.css" rel="stylesheet" type="text/css"/>
<meta content="urn:uuid:e0000000-0000-0000-0000-000029756394" name="Adept.expected.resource"/>
        </head>
    


                    <body class="office_us type_kapitel">
                        <div id="main">
        <h2 class="t2" id="h14.5">14.5    Controllers: Endpoints of an Application<a class="indexanchor" id="i14_59"/></h2>
        <p class="standard">At its core, Nest is based on Express and uses the routing<a class="indexanchor" id="i14_60"/> and middleware features of the framework. However, when it comes to defining the routes, both frameworks differ <a id="p424"/>significantly. Whereas in Express, you define routes either on your <samp class="listingcharacter listingcharacter">app</samp> object or separately via a router, in Nest, you work with a controller and with additional decorators to create new routes. But before we get to defining routes, you must first create and register the controller.</p>
        
            <h3 class="t3" id="h14.5.1">14.5.1    Creating a Controller<a class="indexanchor" id="i14_61"/></h3>
            <p class="standard">Although you can create your controllers by hand, it’s much more convenient to do it via the Nest CLI. When you switch to the command line and enter the <samp class="listingcharacter listingcharacter">nest generate controller movie</samp><a class="indexanchor" id="i14_62"/> command, you’ll get an output like the one shown in <span class="crossreference "><a href="14_005.html#l14.6">Listing 14.6</a></span>.</p>
            <div class="listing " id="l14.6"><pre>$ nest generate controller movie<br/>CREATE src/movie/movie.controller.spec.ts (485 bytes)<br/>CREATE src/movie/movie.controller.ts (99 bytes)<br/>UPDATE src/movie/movie.module.ts (170 bytes) </pre></div>
            <p class="caption "><b>Listing 14.6</b>    
            Output When Creating a Controller</p>
            <p class="standard">As you can see from the output on the console, the Nest CLI creates two new files for you in the <span class="italic">src/movie</span> directory. The <span class="italic">movie.controller.ts</span> file contains the source code of the controller, while the <span class="italic">movie.controller.spec.ts</span> contains the associated test code. In addition, the controller is registered in the <samp class="listingcharacter listingcharacter">controllers</samp> section of the movie module and thus activated.</p>
        
        
            <h3 class="t3" id="h14.5.2">14.5.2    Implementing a Controller</h3>
            <p class="standard">The task of a controller is to define endpoints<a class="indexanchor" id="i14_63"/>, that is, routes, to receive incoming requests and to generate appropriate responses. In this context, Nest again frequently uses decorators, as you can see in <span class="crossreference "><a href="14_005.html#l14.7">Listing 14.7</a></span>.</p>
            <div class="listing " id="l14.7"><pre><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  Body<span class="schwarz">,</span><span class="schwarz"><br/></span>  Controller<span class="schwarz">,</span><span class="schwarz"><br/></span>  Delete<span class="schwarz">,</span><span class="schwarz"><br/></span>  Get<span class="schwarz">,</span><span class="schwarz"><br/></span>  HttpCode<span class="schwarz">,</span><span class="schwarz"><br/></span>  Param<span class="schwarz">,</span><span class="schwarz"><br/></span>  Post<span class="schwarz">,</span><span class="schwarz"><br/></span>  Put<span class="schwarz">,</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'@nestjs/common'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/>@<span class="schwarz">Controller(</span><span class="hellblau">'movie'</span><span class="schwarz">)</span><span class="schwarz"><br/></span><span class="rot">export</span><span class="schwarz"> </span><span class="rot">class MovieController</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="rot">private</span><span class="schwarz"> data </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="schwarz">[</span><span class="schwarz"><br/></span>    <span class="schwarz">{</span><span class="schwarz"> id</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="schwarz">1,</span><span class="schwarz"> title</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'Iron Man'</span><span class="schwarz">,</span><span class="schwarz"> year</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="schwarz">2008</span><span class="schwarz"> </span><span class="schwarz">},</span><span class="schwarz"><br/></span>    <span class="schwarz">{</span><span class="schwarz"> id</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="schwarz">2,</span><span class="schwarz"> title</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'Thor'</span><span class="schwarz">,</span><span class="schwarz"> year</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="schwarz">2011</span><span class="schwarz"> </span><span class="schwarz">},</span><span class="schwarz"><br/></span><a id="p425"/>    <span class="schwarz">{</span><span class="schwarz"> id</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="schwarz">3,</span><span class="schwarz"> title</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'Captain America'</span><span class="schwarz">,</span><span class="schwarz"> year</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="schwarz">2011</span><span class="schwarz"> </span><span class="schwarz">},</span><span class="schwarz"><br/></span>  <span class="schwarz">];</span><span class="schwarz"><br/></span> <br/>  @<span class="schwarz">Get()</span><span class="schwarz"><br/></span>  <span class="schwarz">getAllMovies()</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="rot">return</span><span class="schwarz"> </span><span class="rot">this</span><span class="schwarz">.</span><span class="schwarz">data</span><span class="schwarz">;</span><span class="schwarz"><br/></span>  <span class="schwarz">}</span><span class="schwarz"><br/></span> <br/>  @<span class="schwarz">Get(</span><span class="hellblau">':id'</span><span class="schwarz">)</span><span class="schwarz"><br/></span>  <span class="schwarz">getOneMovie(</span><span class="schwarz">@</span><span class="schwarz">Param(</span><span class="hellblau">'id'</span><span class="schwarz">)</span><span class="schwarz"> id</span><span class="schwarz">:</span><span class="schwarz"> string</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="rot">return</span><span class="schwarz"> </span><span class="rot">this</span><span class="schwarz">.</span><span class="schwarz">data</span><span class="schwarz">.find((</span><span class="schwarz">movie</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> movie</span><span class="schwarz">.</span><span class="schwarz">id </span><span class="dunkelblau">===</span><span class="schwarz"> </span><span class="schwarz">parseInt(</span><span class="schwarz">id</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">10));</span><span class="schwarz"><br/></span>  <span class="schwarz">}</span><span class="schwarz"><br/></span> <br/>  @<span class="schwarz">Post()</span><span class="schwarz"><br/></span>  <span class="schwarz">createNewMovie(</span><span class="schwarz">@</span><span class="schwarz">Body()</span><span class="schwarz"> movie</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="rot">const</span><span class="schwarz"> nextId </span><span class="dunkelblau">=</span><span class="schwarz"> Math</span><span class="schwarz">.max(...</span><span class="rot">this</span><span class="schwarz">.</span><span class="schwarz">data</span><span class="schwarz">.map((</span><span class="schwarz">movie</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> movie</span><span class="schwarz">.</span><span class="schwarz">id</span><span class="schwarz">))</span><span class="schwarz"> </span><span class="dunkelblau">+</span><span class="schwarz"> </span><span class="schwarz">1;</span><span class="schwarz"><br/></span>    movie<span class="schwarz">.</span><span class="schwarz">id </span><span class="dunkelblau">=</span><span class="schwarz"> nextId</span><span class="schwarz">;</span><span class="schwarz"><br/></span>    <span class="rot">this</span><span class="schwarz">.</span><span class="schwarz">data</span><span class="schwarz">.push(</span><span class="schwarz">movie</span><span class="schwarz">);</span><span class="schwarz"><br/></span>    <span class="rot">return</span><span class="schwarz"> movie</span><span class="schwarz">;</span><span class="schwarz"><br/></span>  <span class="schwarz">}</span><span class="schwarz"><br/></span> <br/>  @<span class="schwarz">Put(</span><span class="hellblau">':id'</span><span class="schwarz">)</span><span class="schwarz"><br/></span>  <span class="schwarz">udpateMovie(</span><span class="schwarz">@</span><span class="schwarz">Param(</span><span class="hellblau">'id'</span><span class="schwarz">)</span><span class="schwarz"> id</span><span class="schwarz">:</span><span class="schwarz"> string</span><span class="schwarz">,</span><span class="schwarz"> @</span><span class="schwarz">Body()</span><span class="schwarz"> movie</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="rot">const</span><span class="schwarz"> index </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">this</span><span class="schwarz">.</span><span class="schwarz">data</span><span class="schwarz">.findIndex((</span><span class="schwarz">movie</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> movie</span><span class="schwarz">.</span><span class="schwarz">id </span><span class="dunkelblau">===</span><span class="schwarz"> </span><span class="schwarz">parseInt(</span><span class="schwarz">id</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">10));</span><span class="schwarz"><br/></span>    <span class="rot">this</span><span class="schwarz">.</span><span class="schwarz">data</span><span class="schwarz">[</span><span class="schwarz">index</span><span class="schwarz">]</span><span class="schwarz"> </span><span class="dunkelblau">=</span><span class="schwarz"> movie</span><span class="schwarz">;</span><span class="schwarz"><br/></span>    <span class="rot">return</span><span class="schwarz"> movie</span><span class="schwarz">;</span><span class="schwarz"><br/></span>  <span class="schwarz">}</span><span class="schwarz"><br/></span> <br/>  @<span class="schwarz">Delete(</span><span class="hellblau">':id'</span><span class="schwarz">)</span><span class="schwarz"><br/></span>  @<span class="schwarz">HttpCode(204)</span><span class="schwarz"><br/></span>  <span class="schwarz">removeMovie(</span><span class="schwarz">@</span><span class="schwarz">Param(</span><span class="hellblau">'id'</span><span class="schwarz">)</span><span class="schwarz"> id</span><span class="schwarz">:</span><span class="schwarz"> string</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="rot">this</span><span class="schwarz">.</span><span class="schwarz">data </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">this</span><span class="schwarz">.</span><span class="schwarz">data</span><span class="schwarz">.filter((</span><span class="schwarz">movie</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> movie</span><span class="schwarz">.</span><span class="schwarz">id </span><span class="dunkelblau">!==</span><span class="schwarz"> </span><span class="schwarz">parseInt(</span><span class="schwarz">id</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">10));</span><span class="schwarz"><br/></span>  <span class="schwarz">}</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"> </span></pre></div>
            <p class="caption "><b>Listing 14.7</b>    
            Implementation of the Movie Controller (src/movie/movie.controller.ts)</p>
            <p class="standard">The controller in our example is doing something it shouldn’t be doing: It takes care of the complete route, from incoming request to data management. But we’re going to look at that in the next section. First, let’s take a look at the controller.</p>
            <p class="standard">Like the module, the controller consists of a decorator and a class<a class="indexanchor" id="i14_64"/>. The decorator is named <samp class="listingcharacter listingcharacter">controller</samp> and originates from the <samp class="listingcharacter listingcharacter">@nestjs/common</samp> package. You can pass a prefix to it. In our case, this is the <samp class="listingcharacter listingcharacter">movie</samp> string. This string is placed before all endpoints of this controller in the URL path<a class="indexanchor" id="i14_65"/>. Thus, the base URL of the controller is <span class="italic">http://localhost:3000/movie</span>. Within the class, you first define the private <samp class="listingcharacter listingcharacter">data</samp> property that is <a id="p426"/>responsible for data storage. This is a temporary construct we’ll resolve in the following sections. After that, the methods of the controller will follow. The decorators <samp class="listingcharacter listingcharacter">Get</samp><a class="indexanchor" id="i14_66"/>, <samp class="listingcharacter listingcharacter">Post</samp><a class="indexanchor" id="i14_67"/>, <a class="indexanchor" id="i14_68"/><samp class="listingcharacter listingcharacter">Put</samp>, and<a class="indexanchor" id="i14_69"/><samp class="listingcharacter listingcharacter"> Delete</samp> represent the respective HTTP methods, each of which accepts an optional path. In the case of the <samp class="listingcharacter listingcharacter">getOneMovie</samp>, <samp class="listingcharacter listingcharacter">updateMovie</samp>, and <samp class="listingcharacter listingcharacter">removeMovie</samp> methods, the path consists of the <samp class="listingcharacter listingcharacter">id</samp> variable<a class="indexanchor" id="i14_70"/>. This path behaves similar to what we’ve seen in Express. For example, you can use a <samp class="listingcharacter listingcharacter">GET</samp> request to <span class="italic">http://localhost:3000/movie/1</span> to read the data record with ID <samp class="listingcharacter listingcharacter">1</samp>.</p>
            <p class="standard">The variables in the URL path can be accessed via the method parameter list and the <samp class="listingcharacter listingcharacter">param</samp> decorator. If you specify only the <samp class="listingcharacter listingcharacter">param</samp> decorator<a class="indexanchor" id="i14_71"/> without additional arguments, you get access to all variables. If you specify the name of the variable, as in the example here, you’ll only get the respective value. If you also need to access the request body, as with the <samp class="listingcharacter listingcharacter">createNewMovie</samp> or the <samp class="listingcharacter listingcharacter">updateMovie</samp> method, you can do this using the <samp class="listingcharacter listingcharacter">body</samp> decorator<a class="indexanchor" id="i14_72"/>. In this case, the information is available in the form of the <samp class="listingcharacter listingcharacter">movie</samp> parameter within the method.</p>
            <p class="standard">You don’t need to generate the response to the client manually via a function call as in Express, but can simply return the desired value. Nest automatically sets the status code<a class="indexanchor" id="i14_73"/> to the value <samp class="listingcharacter listingcharacter">200</samp> except for the <samp class="listingcharacter listingcharacter">createNewMovie</samp> method. The <samp class="listingcharacter listingcharacter">post</samp> decorator makes sure that the response is assigned a <samp class="listingcharacter listingcharacter">201</samp> status code. You can affect this behavior via the <samp class="listingcharacter listingcharacter">HttpCode</samp> decorator<a class="indexanchor" id="i14_74"/>, as is the case with the <samp class="listingcharacter listingcharacter">removeMovie</samp> method, for example. If a client requests this route, it will receive a response with status code <samp class="listingcharacter listingcharacter">204</samp> if successful. In addition to the status code, Nest also sets the content type header to the value <samp class="listingcharacter listingcharacter">application/json</samp> and converts the passed object structure into a correctly formatted JavaScript Object Notation (JSON) structure.</p>
        
        
            <h3 class="t3" id="h14.5.3">14.5.3    Integrating and Checking the Controller</h3>
            <p class="standard">The <samp class="listingcharacter listingcharacter">generate</samp> command of the Nest CLI registers the controller in the module—which in this case is the movie module—and enters the reference to the controller in the <samp class="listingcharacter listingcharacter">controllers</samp> property of the <samp class="listingcharacter listingcharacter">module</samp> decorator for this purpose (see <span class="crossreference "><a href="14_005.html#l14.8">Listing 14.8</a></span>).</p>
            <div class="listing " id="l14.8"><pre><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> Module </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'@nestjs/common'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">import</span><span class="schwarz"> { MovieController } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./movie.controller'</span><span class="schwarz">;</span><br/> </samp></span><br/>@Module({<br/>  imports: [],<br/>  <span class="bold"><samp class="listingcharacter listingcharacter">controllers: [MovieController],</samp></span><br/>  providers: [],<br/>  exports: [],<br/>})<br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">class MovieModule</span><span class="schwarz"> {} </span><span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 14.8</b>    
            Integration of the Controller in the Module (src/movie/movie.controller.ts)</p>
            <p class="standard"><a id="p427"/>When you launch your application, the output changes slightly. <span class="crossreference "><a href="14_005.html#l14.9">Listing 14.9</a></span> shows that the <samp class="listingcharacter listingcharacter">MovieController</samp> and all corresponding routes have been activated. This output helps you to check whether the controller has been registered correctly.</p>
            <div class="listing " id="l14.9"><pre>[Nest] 69838  - 09/09/2021, 05:48:39     LOG [NestFactory] <img alt="inline image" class="inline_image" src="bilder/umbruchpfeil.png"/><br/>  Starting Nest application...<br/>[Nest] 69838  - 09/09/2021, 05:48:39     LOG [InstanceLoader] <img alt="inline image" class="inline_image" src="bilder/umbruchpfeil.png"/><br/>  MovieModule dependencies initialized +36ms<br/>[Nest] 69838  - 09/09/2021, 05:48:39     LOG [InstanceLoader] <img alt="inline image" class="inline_image" src="bilder/umbruchpfeil.png"/><br/>  AppModule dependencies initialized +0ms<br/>[Nest] 69838  - 09/09/2021, 05:48:39     LOG [RoutesResolver] <img alt="inline image" class="inline_image" src="bilder/umbruchpfeil.png"/><br/>  AppController {/}: +6ms<br/>[Nest] 69838  - 09/09/2021, 05:48:39     LOG [RouterExplorer] <img alt="inline image" class="inline_image" src="bilder/umbruchpfeil.png"/><br/>  Mapped {/, GET} route +2ms<br/>[Nest] 69838  - 09/09/2021, 05:48:39     LOG [RoutesResolver] <img alt="inline image" class="inline_image" src="bilder/umbruchpfeil.png"/><br/>  MovieController {/movie}: +1ms<br/>[Nest] 69838  - 09/09/2021, 05:48:39     LOG [RouterExplorer] <img alt="inline image" class="inline_image" src="bilder/umbruchpfeil.png"/><br/>  Mapped {/movie, GET} route +0ms<br/>[Nest] 69838  - 09/09/2021, 05:48:39     LOG [RouterExplorer] <img alt="inline image" class="inline_image" src="bilder/umbruchpfeil.png"/><br/>  Mapped {/movie/:id, GET} route +1ms<br/>[Nest] 69838  - 09/09/2021, 05:48:39     LOG [RouterExplorer] <img alt="inline image" class="inline_image" src="bilder/umbruchpfeil.png"/><br/>  Mapped {/movie, POST} route +1ms<br/>[Nest] 69838  - 09/09/2021, 05:48:39     LOG [RouterExplorer] <img alt="inline image" class="inline_image" src="bilder/umbruchpfeil.png"/><br/>  Mapped {/movie/:id, PUT} route +1ms<br/>[Nest] 69838  - 09/09/2021, 05:48:39     LOG [RouterExplorer] <img alt="inline image" class="inline_image" src="bilder/umbruchpfeil.png"/><br/>  Mapped {/movie/:id, DELETE} route +0ms<br/>[Nest] 69838  - 09/09/2021, 05:48:39     LOG [NestApplication] <img alt="inline image" class="inline_image" src="bilder/umbruchpfeil.png"/><br/>  Nest application successfully started +2ms </pre></div>
            <p class="caption "><b>Listing 14.9</b>    
            Output at Application Startup</p>
            <p class="standard">If you don’t see the entries for the controller or the routes, you should check that the controller is correctly entered in the module and that the movie module is registered in the app module. If you get the output <samp class="listingcharacter listingcharacter">Nest application successfully started</samp> in the last line, you can check your controller by sending requests to it. The commands from <span class="crossreference "><a href="14_005.html#l14.10">Listing 14.10</a></span> first delete the data record with ID <samp class="listingcharacter listingcharacter">2</samp> and then query the list of all movies.</p>
            <div class="listing " id="l14.10"><pre>$ <span class="bold"><samp class="listingcharacter listingcharacter">curl -X DELETE http://localhost:3000/movie/2</samp></span><br/>$ <span class="bold"><samp class="listingcharacter listingcharacter">curl http://localhost:3000/movie <br/></samp></span>[<br/>  { "id": 1, "title": "Iron Man", "year": 2008 },<br/>  { "id": 3, "title": "Captain America", "year": 2011 }<br/>] </pre></div>
            <p class="caption "><b>Listing 14.10</b>    
            Requests to the Controller (Formatted)</p>
            <p class="standard"><a id="p428"/>You can also send such requests using a graphical tool such as Postman. The Nest application doesn’t differentiate here. However, when you use your application in its current state, you should keep in mind that when you restart your application, any changes you’ve made to the data will be reset.</p>
        
    </div><p class="signatur"/>
                    </body>
                </html>