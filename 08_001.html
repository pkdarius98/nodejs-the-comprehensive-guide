<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
                    
        <head><meta content="application/xhtml+xml; charset=utf-8" http-equiv="Content-Type"/>
            <meta content="application/xhtml+xml; charset=utf-8" name="content-type"/>
            <meta content="Connecting Databases" name="title"/>
            <meta content="Sebastian Springer" name="author"/>
            <meta content="Rheinwerk Publishing" name="publisher"/>
            <meta content="© 2022 by Rheinwerk Publishing Inc., Boston (MA)" name="copyright"/>
            <meta content="Node.js - The Comprehensive Guide - Connecting Databases" name="description"/>
            <meta content="en" name="language"/>
            <title>Connecting Databases</title>
            <link href="common/main.css" rel="stylesheet" type="text/css"/>
<meta content="urn:uuid:e0000000-0000-0000-0000-000029756394" name="Adept.expected.resource"/>
        </head>
    


                    <body class="office_us type_kapitel">
                        <div id="main"><h1 class="t1" id="h8">8    <a id="p241"/>Connecting Databases</h1><p class="introductorynote indent_chapter_single">I know that I know nothing.<br/>—Socrates</p><p class="standard">As<a class="indexanchor" id="i08_00"/> you’ve already seen in the previous chapters, when you implement applications, you also need to store data all the time. Node.js only provides you with the <samp class="listingcharacter listingcharacter">fs</samp> module for persisting<a class="indexanchor" id="i08_01"/> data. The drawback of storing data directly in the file system is that this method isn’t optimized for directly accessing specific information in large data sets. In the worst case, you’ll have to search an entire file for the information you need, which can be very time-consuming depending on the file size. This is one reason you should use databases to persist information in your application. They also offer additional features such as scalability or transaction security.</p><p class="standard">In most cases, databases aren’t accessed directly, but rather through a driver that serves as an interface to the database and implements the database’s communication protocol<a class="indexanchor" id="i08_02"/>. These drivers aren’t integral components of the Node.js platform. Either the drivers are provided by the database manufacturer, or they are a product of the open-source<a class="indexanchor" id="i08_03"/> community. They are usually available as Node Package Manager (npm) modules and can be installed if required.</p><p class="standard">Today, there is a driver for Node.js available for almost every database. For example, the supported systems include the relational databases MySQL<a class="indexanchor" id="i08_04"/>, MSSQL<a class="indexanchor" id="i08_05"/>, SQLite<a class="indexanchor" id="i08_06"/>, PostgreSQL<a class="indexanchor" id="i08_07"/>, OracleDB<a class="indexanchor" id="i08_08"/>, and many others. A large number of nonrelational databases such as Redis<a class="indexanchor" id="i08_09"/>, CouchDB, and<a class="indexanchor" id="i08_10"/> MongoDB<a class="indexanchor" id="i08_11"/> are also supported.</p><p class="standard">In this chapter, you’ll learn more about connecting various databases to your Node.js application. In particular, you’ll use MySQL, SQLite, Redis, and MongoDB. You’ll include each of these databases in the movie database and implement both read and write access.</p><p class="standard">You’ll also learn more about the areas of use and the pros and cons of the individual databases. To reproduce the examples in this chapter, you have several options, including installing the respective database systems locally on your development system or running the database in a container, which is the better alternative. The advantage of this method is that you don’t need to install all possible databases. For this reason, in the respective sections, we’ll show you how you can launch such a database container. This requires that you have Docker installed on your system. For more information on Docker<a class="indexanchor" id="i08_12"/>, see <span class="url"><a href="https://docker.com/">https://docker.com/</a></span>, as well as <span class="crossreference "><a href="25_001.html#h25">Chapter 25</a></span> and <span class="crossreference "><a href="27_001.html#h27">Chapter 27</a></span>.</p>
        <h2 class="t2" id="h8.1">8.1    <a id="p242"/>Node.js and Relational Databases</h2>
        <p class="standard">Relational databases have established themselves over the years as the database standard in the IT world. This type of database is based on a structure of tables in which the data is stored. In this context, a table<a class="indexanchor" id="i08_13"/> defines the structure of individual data records.</p>
        <p class="standard">You can think of a table in a relational database as just an ordinary table. The rows represent the individual records, and the columns represent the respective properties. This means that all data records in a table have the same structure. The aggregate of all tables and their structure finally represents the schema<a class="indexanchor" id="i08_14"/> of the database.</p>
        <p class="standard">In relational databases, you can define almost any number of tables. You can then use <span class="italic">foreign keys</span><a class="indexanchor" id="i08_15"/> to establish a relationship between the tables. For the example of the movie database, this means you can store the movie data in one table and the user ratings for the individual movies in another. Another example is storing the information about the movie studio in another table. This process is called <span class="italic">normalization</span><a class="indexanchor" id="i08_16"/> and is used to avoid duplicates in the database. You can create a relationship<a class="indexanchor" id="i08_17"/> between the records from both tables using a foreign key.</p>
        <p class="standard"><span class="italic">Structured Query Language</span> (SQL)<a class="indexanchor" id="i08_18"/> has become the language of choice for formulating database queries. SQL has been standardized by International Organization for Standardization (ISO) and International Electrotechnical Commission (IEC), with each specific implementation adding its own extensions to this standard. You can find more information at <span class="url"><a href="https://en.wikipedia.org/wiki/SQL">https://en.wikipedia.org/wiki/SQL</a></span>.</p>
        <p class="standard">The sections on the individual databases always follow the same structure. You’ll get to know some details about the database and the respective pros and cons. This is followed by the installation of the driver<a class="indexanchor" id="i08_19"/> for the database and a concrete example of how to use the database within the movie database application.</p>
        <p class="standard">The first part of this chapter deals with the connection of a MySQL database.</p>
        
            <h3 class="t3" id="h8.1.1">8.1.1    MySQL<a class="indexanchor" id="i08_20"/></h3>
            <p class="standard">MySQL is one of the most widely used databases on the web. You can access this database with almost all major programming languages. The connection of Node.js to MySQL can be realized via a special database driver.</p>
            <p class="standard">MySQL has already proven itself as a database for many years, even in very large applications. Not only does the system have a simple server component, but it also allows you to run a database on multiple servers in a primary-secondary compound structure. The benefit of this is that you can distribute the requests across several systems and thus ensure resilience.</p>
            <p class="standard">In addition, for very large data volumes, a database can be partitioned and distributed across multiple systems, which offers further opportunities in terms of performance improvements. MySQL has many other useful features, including triggers (functions <a id="p243"/>that are executed when certain operations are performed), and transactions. A <span class="italic">transaction</span> is a group of operations that may only be performed in their entirety or not at all.</p>
            <p class="standard">Another advantage of MySQL is that this database is available on a large number of different operating systems, such as Linux, Windows, and macOS. The availability and widespread use have led to a very active community that you can call on if you have any questions or problems. There are also forks of MySQL, such as MariaDB<a class="indexanchor" id="i08_21"/>, which offer similar functionality.</p>
            <p class="standard">One of the drawbacks of MySQL is that it can’t quite keep up with the big SQL databases such as Oracle or DB2 in terms of its feature set. However, the advanced development of the database is increasingly compensating for this disadvantage.</p>
            <p class="standard">In general, there are two different approaches to connecting to a MySQL database. For one thing, there is a driver that directly implements the MySQL protocol<a class="indexanchor" id="i08_22"/> and is written entirely in JavaScript. No other software is needed for this driver, and it can be used directly to work with a database.</p>
            <p class="standard">Another variant of MySQL drivers is based on the MySQL client libraries<a class="indexanchor" id="i08_23"/>. These have the advantage of being slightly more performant than drivers implemented entirely in JavaScript. However, they have the disadvantage that the MySQL client libraries must be installed on the system running the Node.js application.</p>
            
                <h4 class="t4" id="h8.1.1.1">MySQL in a Container<a class="indexanchor" id="i08_24"/></h4>
                <p class="standard">As mentioned earlier, you don’t need to install MySQL on your development system. Especially for experimenting, running the database in a container is a viable alternative. But containers are also becoming increasingly popular for day-to-day development operations, as this approach allows both the configuration to be shared between developer systems and the container configuration to be versioned along with the rest of the application’s source code. You can launch the MySQL container using the command shown in <span class="crossreference "><a href="08_001.html#l8.1">Listing 8.1</a></span>.</p>
                <div class="listing " id="l8.1"><pre>docker run <br/>  --name mysql <br/>  -v db-data:/etc/mysql/conf.d <br/>  -e MYSQL_ROOT_PASSWORD=topSecret <br/>  -e MYSQL_ROOT_HOST=% -p 3306:3306 <br/>  -d <br/>  mysql:latest </pre></div>
                <p class="caption "><b>Listing 8.1</b>    
            Launching the MySQL Container with Docker</p>
                <p class="standard">The <samp class="listingcharacter listingcharacter">docker run</samp> command creates a new container from the image named <samp class="listingcharacter listingcharacter">mysql:latest</samp>. The <samp class="listingcharacter listingcharacter">mysql</samp> image<a class="indexanchor" id="i08_25"/> is officially provided by MySQL on Docker Hub<a class="indexanchor" id="i08_26"/> (<span class="url"><a href="https://hub.docker.com/">https://hub.docker.com/</a></span>), which is downloaded by the command in the specified version—here <samp class="listingcharacter listingcharacter">:latest</samp>—that is, <a id="p244"/>the latest version. The <samp class="listingcharacter listingcharacter">--name</samp> option assigns a name to the container so that it’s easier to manage and doesn’t need to be addressed by its ID. You can use the <samp class="listingcharacter listingcharacter">-v</samp> option to specify that a local directory is mounted as a volume in the container, so that the database files are located on the host system rather than in the container. The subsequent <samp class="listingcharacter listingcharacter">-e</samp> option sets environment variables for the container, which MySQL uses in this case to set the <samp class="listingcharacter listingcharacter">root</samp> password<a class="indexanchor" id="i08_27"/> and allow the <samp class="listingcharacter listingcharacter">root</samp> user to log on from outside the container. Finally, you use <samp class="listingcharacter listingcharacter">-d</samp> to specify that the container should run in the background. When you execute the command, you’ll get a cryptic-looking character string as a result. This is the ID of the container, which you can also use to manage the container in addition to the name. Once you’ve launched the container, you can use MySQL on your system.</p>
                <div class="box box_standard">
                    <h6 class="boxheading">The Most Important Docker<a class="indexanchor" id="i08_28"/> Commands<a class="indexanchor" id="i08_29"/> at a Glance</h6>
                    <p class="standard first last"><span class="crossreference "><a href="08_001.html#t8.1">Table 8.1</a></span> contains an overview of the most important commands for the Docker command line. A comprehensive list of all commands, including descriptions and all available options, can be found in the official documentation at <span class="url"><a href="https://docs.docker.com/engine/reference/commandline/cli/">https://docs.docker.com/engine/reference/commandline/cli/</a></span>. </p>
                </div>
                <table class="standardtable" id="t8.1">
                    <thead>
                        <tr>
                            <th class="tablehead tablecell_first top_border_cell">
                                <p class="standard first-item last-item">Command</p>
                            </th>
                            <th class="tablehead tablecell_last top_border_cell">
                                <p class="standard first-item last-item">Description</p>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="tablecell tablecell_first top_border_cell">
                                <p class="standard first-item last-item"><samp class="listingcharacter listingcharacter">docker run &lt;image&gt;</samp></p>
                            </td>
                            <td class="tablecell tablecell_last top_border_cell">
                                <p class="standard first-item last-item">Creates and runs a new container</p>
                            </td>
                        </tr>
                        <tr class="light">
                            <td class="tablecell tablecell_first">
                                <p class="standard first-item last-item"><samp class="listingcharacter listingcharacter">docker rm &lt;container&gt;</samp></p>
                            </td>
                            <td class="tablecell tablecell_last">
                                <p class="standard first-item last-item">Deletes the specified container</p>
                            </td>
                        </tr>
                        <tr>
                            <td class="tablecell tablecell_first">
                                <p class="standard first-item last-item"><samp class="listingcharacter listingcharacter">docker rmi &lt;image&gt;</samp></p>
                            </td>
                            <td class="tablecell tablecell_last">
                                <p class="standard first-item last-item">Deletes the specified image</p>
                            </td>
                        </tr>
                        <tr class="light">
                            <td class="tablecell tablecell_first">
                                <p class="standard first-item last-item"><samp class="listingcharacter listingcharacter">docker ps</samp></p>
                            </td>
                            <td class="tablecell tablecell_last">
                                <p class="standard first-item last-item">Displays a list of all containers</p>
                            </td>
                        </tr>
                        <tr>
                            <td class="tablecell tablecell_first">
                                <p class="standard first-item last-item"><samp class="listingcharacter listingcharacter">docker stop &lt;container&gt;</samp></p>
                            </td>
                            <td class="tablecell tablecell_last">
                                <p class="standard first-item last-item">Stops the container</p>
                            </td>
                        </tr>
                        <tr class="light">
                            <td class="tablecell tablecell_first">
                                <p class="standard first-item last-item"><samp class="listingcharacter listingcharacter">docker start &lt;container&gt;</samp></p>
                            </td>
                            <td class="tablecell tablecell_last">
                                <p class="standard first-item last-item">Starts a stopped container</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <p class="caption "><b>Table 8.1</b>    
            Most Important Docker Commands</p>
            
            
                <h4 class="t4" id="h8.1.1.2">Installation<a class="indexanchor" id="i08_30"/></h4>
                <p class="standard">The MySQL driver for Node.js is available as an npm module and can be installed from the command line using the <samp class="listingcharacter listingcharacter">npm install mysql2</samp><a class="indexanchor" id="i08_31"/> command. The driver implements the MySQL protocol entirely in JavaScript, so it doesn’t require you to install any other external libraries or perform any compilation steps during the installation process.</p>
                <p class="standard">Once the installation is complete and you have a MySQL database available, you can access the MySQL database from your application.</p>
            
            
                <h4 class="t4" id="h8.1.1.3">Database Structure<a class="indexanchor" id="i08_32"/></h4>
                <p class="standard">To reproduce the examples in this chapter, you need a running instance of a MySQL database with a data structure to work on. <span class="crossreference "><a href="08_001.html#l8.2">Listing 8.2</a></span> contains the required SQL <a id="p245"/>commands to create a database with the two tables, <samp class="listingcharacter listingcharacter">Movies</samp> and <samp class="listingcharacter listingcharacter">Ratings</samp>, and to fill the database with initial values. Once you’ve executed these statements, you can start implementing the sample application in the next step. To create the structure, you must either use the <samp class="listingcharacter listingcharacter">mysql</samp> command locally on the console of your system, or, if you’re running the database in a Docker container, you should use the <samp class="listingcharacter listingcharacter">docker exec -it mysql mysql -p</samp> command to execute the <samp class="listingcharacter listingcharacter">mysql</samp> command in the container named <samp class="listingcharacter listingcharacter">mysql</samp>. Then you can execute the statements shown in <span class="crossreference "><a href="08_001.html#l8.2">Listing 8.2</a></span>.</p>
                <div class="listing " id="l8.2"><pre><span class="dunkelblau">CREATE</span><span class="schwarz"> </span><span class="dunkelblau">DATABASE</span><span class="schwarz"> </span><span class="rot">`movie-db`</span><span class="schwarz">;</span><br/>USE <span class="rot">`movie-db`</span><span class="schwarz">;</span><br/><span class="dunkelblau">CREATE</span><span class="schwarz"> </span><span class="dunkelblau">TABLE</span><span class="schwarz"> </span><span class="rot">`Movies`</span><span class="schwarz"> (</span><br/>  <span class="rot">`id`</span><span class="schwarz"> int(</span><span class="schwarz">11</span><span class="schwarz">) </span><span class="dunkelblau">NOT</span><span class="schwarz"> </span><span class="dunkelblau">NULL</span><span class="schwarz"> AUTO_INCREMENT,</span><br/>  <span class="rot">`title`</span><span class="schwarz"> </span><span class="dunkelblau">varchar</span><span class="schwarz">(</span><span class="schwarz">255</span><span class="schwarz">) </span><span class="dunkelblau">DEFAULT</span><span class="schwarz"> </span><span class="dunkelblau">NULL</span><span class="schwarz">,</span><br/>  <span class="rot">`year`</span><span class="schwarz"> int(</span><span class="schwarz">11</span><span class="schwarz">) </span><span class="dunkelblau">DEFAULT</span><span class="schwarz"> </span><span class="dunkelblau">NULL</span><span class="schwarz">,</span><br/>  <span class="dunkelblau">PRIMARY</span><span class="schwarz"> </span><span class="dunkelblau">KEY</span><span class="schwarz"> (</span><span class="rot">`id`</span><span class="schwarz">)</span><br/>) ENGINE=InnoDB <span class="dunkelblau">DEFAULT</span><span class="schwarz"> CHARSET=utf8;</span><br/><span class="dunkelblau">INSERT</span><span class="schwarz"> </span><span class="dunkelblau">INTO</span><span class="schwarz"> </span><span class="rot">`Movies`</span><span class="schwarz"> (</span><span class="rot">`title`</span><span class="schwarz">, </span><span class="rot">`year`</span><span class="schwarz">) VALUES</span><br/>(<span class="rot">'Iron Man'</span><span class="schwarz">, </span><span class="schwarz">2008</span><span class="schwarz">),</span><br/>(<span class="rot">'Thor'</span><span class="schwarz">, </span><span class="schwarz">2011</span><span class="schwarz">),</span><br/>(<span class="rot">'Captain America'</span><span class="schwarz">, </span><span class="schwarz">2011</span><span class="schwarz">); </span></pre></div>
                <p class="caption "><b>Listing 8.2</b>    
            MySQL Database Structure</p>
            
            
                <h4 class="t4" id="h8.1.1.4">Establishing<a class="indexanchor" id="i08_33"/> the Connection</h4>
                <p class="standard">In any application that uses a database, before using this database, a connection must first be established through which the commands are sent to the database system and the information from the database can flow back to the application. The application is based on the source code from <span class="crossreference "><a href="07_001.html#h7">Chapter 7</a></span>, and it uses the Pug template engine. The database connection is established in the <span class="italic">movie/model.js</span> file. <span class="crossreference "><a href="08_001.html#l8.3">Listing 8.3</a></span> shows how you can do this in the source code.</p>
                <div class="listing " id="l8.3"><pre><span class="rot">import</span><span class="schwarz"> mysql </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'mysql2/promise'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="rot">const</span><span class="schwarz"> connection </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> mysql</span><span class="schwarz">.createConnection({</span><span class="schwarz"><br/></span>  host<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'localhost'</span><span class="schwarz">,</span><span class="schwarz"><br/></span>  user<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'root'</span><span class="schwarz">,</span><span class="schwarz"><br/></span>  password<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'topSecret'</span><span class="schwarz">,</span><span class="schwarz"><br/></span>  database<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'movie-db'</span><span class="schwarz">,</span><span class="schwarz"><br/></span><span class="schwarz">});</span><span class="schwarz"><br/></span> <br/><span class="rot">await</span><span class="schwarz"> connection</span><span class="schwarz">.connect();</span><span class="schwarz"><br/></span> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">getAll()</span><span class="schwarz"> </span><span class="schwarz">{}</span><span class="schwarz"><br/></span><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">get(</span><span class="schwarz">id</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{}</span><span class="schwarz"><br/></span><span class="rot"><a id="p246"/>export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">remove(</span><span class="schwarz">id</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{}</span><span class="schwarz"><br/></span><span class="rot">export</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">save(</span><span class="schwarz">movie</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{}</span><span class="schwarz"> </span></pre></div>
                <p class="caption "><b>Listing 8.3</b>    
            Establishing a Database Connection (movie/model.js)</p>
                <p class="standard">After including the promise interface of the <samp class="listingcharacter listingcharacter">mysql2</samp> module, you can use the <samp class="listingcharacter listingcharacter">createConnection</samp><a class="indexanchor" id="i08_34"/> function to configure the connection and then use the <samp class="listingcharacter listingcharacter">connect</samp> method of the connection object to connect to the database. Much of the driver’s functionality in this case is based on promises. For the <samp class="listingcharacter listingcharacter">createConnection</samp> function, it returns a promise object that you can wait to be resolved using the <samp class="listingcharacter listingcharacter">await</samp> keyword. You can also terminate an open connection by calling the <samp class="listingcharacter listingcharacter">end</samp> method. The <samp class="listingcharacter listingcharacter">connect</samp> method also returns a promise object. You can use the <samp class="listingcharacter listingcharacter">catch</samp> method of this object to implement error handling related to the connection establishment. Alternatively, you can use the <samp class="listingcharacter listingcharacter">await</samp> keyword and perform error handling with <samp class="listingcharacter listingcharacter">try-catch</samp>.</p>
                <p class="standard">The connection can also be established implicitly by calling the <samp class="listingcharacter listingcharacter">query</samp> method on the connection object.</p>
            
            
                <h4 class="t4" id="h8.1.1.5">Reading Data Records<a class="indexanchor" id="i08_35"/></h4>
                <p class="standard">Because you’ve already created some data records when initializing<a class="indexanchor" id="i08_36"/> the database, you can already read them. To do this, you must first define an appropriate query and pass it to the <samp class="listingcharacter listingcharacter">query</samp> method of the <samp class="listingcharacter listingcharacter">connection</samp> object. Communication with the database takes place asynchronously and also uses promises<a class="indexanchor" id="i08_37"/>. Alternatively, the <samp class="listingcharacter listingcharacter">mysql2</samp> package also provides a callback-based interface, but this is much less convenient to use. The source code in <span class="crossreference "><a href="08_001.html#l8.4">Listing 8.4</a></span> shows how you can read data from a table.</p>
                <div class="listing " id="l8.4"><pre><span class="rot">import</span><span class="schwarz"> mysql </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'mysql2/promise'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="rot">const</span><span class="schwarz"> connection </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> mysql</span><span class="schwarz">.createConnection({</span><span class="schwarz"><br/></span>  host<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'127.0.0.1'</span><span class="schwarz">,</span><span class="schwarz"><br/></span>  user<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'root'</span><span class="schwarz">,</span><span class="schwarz"><br/></span>  password<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'topSecret'</span><span class="schwarz">,</span><span class="schwarz"><br/></span>  database<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'movie-db'</span><span class="schwarz">,</span><span class="schwarz"><br/></span><span class="schwarz">});</span><span class="schwarz"><br/></span> <br/><span class="rot">await</span><span class="schwarz"> connection</span><span class="schwarz">.connect();</span><span class="schwarz"><br/></span> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">getAll()</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">const</span><span class="schwarz"> query </span><span class="dunkelblau">=</span></samp></span><span class="schwarz"> </span><span class="hellblau">'</span><span class="bold"><samp class="listingcharacter listingcharacter">SELECT * FROM Movies</samp></span>'<span class="bold"><samp class="listingcharacter listingcharacter"><span class="schwarz">;</span><br/>  <span class="rot">const</span><span class="schwarz"> [data] </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> connection.query(query);</span><br/>  <span class="rot">return</span><span class="schwarz"> data;</span></samp></span><br/>}<br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> get(id) {}</span><br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> remove(id) {}</span><br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> save(movie) {} </span><span class="schwarz"/></pre></div>
                <p class="caption "><b>Listing 8.4</b>    
            Reading Data Records from a MySQL Table</p>
                <p class="standard"><a id="p247"/>The <samp class="listingcharacter listingcharacter">query</samp> method of the <samp class="listingcharacter listingcharacter">connection</samp> object returns a promise object that is resolved with an array of multiple elements. The first element of this array contains the queried data from the database, which you can extract and return using a destructuring statement. After you mark the <samp class="listingcharacter listingcharacter">getAll</samp> function as an <samp class="listingcharacter listingcharacter">async</samp> function, you can work inside the function with the <samp class="listingcharacter listingcharacter">await</samp> keyword, and the function will automatically return a promise object. If successful, the returned promise object contains the data from the database; if there’s an error, the corresponding error is returned from the database.</p>
                <p class="standard">Because the signature of the <samp class="listingcharacter listingcharacter">getAll</samp> method hasn’t changed due to the connection of the database, you don’t need to adjust anything else in the controller.</p>
                <p class="standard">Currently, the source code of your application assumes only the success case, which is sufficient for our purpose, namely, connecting the database. However, for a productive application, you also need to take care of error handling and send at least a generic error message to inform your users without revealing too many internal details about your application to a potential attacker.</p>
                <p class="standard">The MySQL driver for Node.js supports many other features, such as escaping, which is described in more detail in the following sections.</p>
            
            
                <h4 class="t4" id="h8.1.1.6">Creating New Data Records<a class="indexanchor" id="i08_38"/></h4>
                <p class="standard">After implementing read access to the database, the next step deals with write access. Basically, the operation process here is similar because you also use the <samp class="listingcharacter listingcharacter">query</samp> method of the connection object to send the <samp class="listingcharacter listingcharacter">INSERT</samp> query. A special feature here is that you don’t directly compose the values entered by the users into a query via string concatenation, but rather use placeholders<a class="indexanchor" id="i08_39"/> and let the database driver do the escaping<a class="indexanchor" id="i08_40"/>. This reduces the risk of an SQL injection<a class="indexanchor" id="i08_41"/>.</p>
                <p class="standard">As was the case with the read process, you also use the <span class="italic">movie/model.js</span> file as the starting point when creating new records. <span class="crossreference "><a href="08_001.html#l8.5">Listing 8.5</a></span> shows the customized source code of the file.</p>
                <div class="listing " id="l8.5"><pre><span class="rot">import</span><span class="schwarz"> mysql </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'mysql2/promise'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="rot">const</span><span class="schwarz"> connection </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> mysql</span><span class="schwarz">.createConnection({...});</span><span class="schwarz"><br/></span> <br/><span class="rot">await</span><span class="schwarz"> connection</span><span class="schwarz">.connect();</span><span class="schwarz"><br/></span> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">getAll()</span><span class="schwarz"> </span><span class="schwarz">{...}</span><span class="schwarz"><br/></span> <br/><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> insert(movie) {</span><br/>  <span class="rot">const</span><span class="schwarz"> query </span><span class="dunkelblau">=</span></samp></span><span class="schwarz"> </span><span class="hellblau">'</span><span class="bold"><samp class="listingcharacter listingcharacter">INSERT INTO Movies (title, year) VALUES (?, ?)</samp></span>'<span class="bold"><samp class="listingcharacter listingcharacter"><span class="schwarz">;</span><br/>  <span class="rot">const</span><span class="schwarz"> [result] </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> connection.query(query, [movie.title, movie.year]);</span><br/>  <span class="rot">return</span><span class="schwarz"> { ...movie, id: result.insertId };</span><br/>}<br/> </samp></span><br/><span class="rot"><a id="p248"/>export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> get(id) {}</span><br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> remove(id) {}</span><br/><span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">export</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> save(movie) {</span><br/>  <span class="rot">if</span><span class="schwarz"> (</span><span class="dunkelblau">!</span><span class="schwarz">movie.id) {</span><br/>    <span class="rot">return</span><span class="schwarz"> insert(movie);</span><br/>  }<br/>}</samp></span> <span class="schwarz"/></pre></div>
                <p class="caption "><b>Listing 8.5</b>    
            Creating a New Data Record (movie/model.js)</p>
                <p class="standard">The central place of the model file that takes care of saving the data is the <samp class="listingcharacter listingcharacter">save</samp> function. Based on the presence of the <samp class="listingcharacter listingcharacter">id</samp> property of the passed data record, the function decides whether it to create a new record or update an existing record later. In the current case of a new creation, the <samp class="listingcharacter listingcharacter">save</samp> function then calls the <samp class="listingcharacter listingcharacter">insert</samp> function with the data record to be created.</p>
                <p class="standard">You can implement the <samp class="listingcharacter listingcharacter">insert</samp> function as an <samp class="listingcharacter listingcharacter">async</samp> function to be able to use the promise-based interface<a class="indexanchor" id="i08_42"/> of the <samp class="listingcharacter listingcharacter">mysql2</samp> driver comfortably. In the first step, you must prepare the <samp class="listingcharacter listingcharacter">INSERT</samp> statement by writing the query completely and providing question marks for the values to be inserted. The driver then replaces these question marks with the values when they are called and takes care of escaping the values correctly. The <samp class="listingcharacter listingcharacter">query</samp> method of the <samp class="listingcharacter listingcharacter">connection</samp> object accepts the SQL statement as a string as the first argument and an array with the values for the placeholders as the second argument. The return value is a promise object with an array whose first element contains a set of metadata about the request. Here you’ll find, among other things, the <samp class="listingcharacter listingcharacter">insertId</samp><a class="indexanchor" id="i08_43"/> property, which contains the ID of the newly created data record. You must use this ID together with the information from the originally passed object to create a new object with the spread operator and return it to the calling instance.</p>
                <p class="standard">You don’t need to adjust the controller and its <samp class="listingcharacter listingcharacter">saveAction</samp> because the interface of the model hasn’t changed.</p>
            
            
                <h4 class="t4" id="h8.1.1.7">Updating Data Records<a class="indexanchor" id="i08_44"/></h4>
                <p class="standard">To update the data records in your application, you must first connect the model method for reading individual data records to the database to populate the form with the existing data. In the implementation, you should combine the structure of the reading request from <span class="crossreference "><a href="08_001.html#l8.4">Listing 8.4</a></span> with escaping<a class="indexanchor" id="i08_45"/> to safely insert the passed ID into the request. <span class="crossreference "><a href="08_001.html#l8.6">Listing 8.6</a></span> shows the necessary adjustments to the <span class="italic">movie/model.js</span> file.</p>
                <div class="listing " id="l8.6"><pre><span class="rot">import</span><span class="schwarz"> mysql </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'mysql2/promise'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="rot">const</span><span class="schwarz"> connection </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> mysql</span><span class="schwarz">.createConnection({</span><span class="schwarz"><br/></span>  host<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'127.0.0.1'</span><span class="schwarz">,</span><span class="schwarz"><br/></span>  user<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'root'</span><span class="schwarz">,</span><span class="schwarz"><br/></span>  password<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'topSecret'</span><span class="schwarz">,</span><span class="schwarz"><br/></span><a id="p249"/>  database<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'movie-db'</span><span class="schwarz">,</span><span class="schwarz"><br/></span><span class="schwarz">});</span><span class="schwarz"><br/></span> <br/><span class="rot">await</span><span class="schwarz"> connection</span><span class="schwarz">.connect();</span><span class="schwarz"><br/></span> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">getAll()</span><span class="schwarz"> </span><span class="schwarz">{...}</span><span class="schwarz"><br/></span> <br/><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">insert(</span><span class="schwarz">movie</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{...}</span><span class="schwarz"><br/></span> <br/><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> get(id) {</span><br/>  <span class="rot">const</span><span class="schwarz"> query </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="hellblau">'SELECT * from Movies WHERE id = ?'</span><span class="schwarz">;</span><br/>  <span class="rot">const</span><span class="schwarz"> [data] </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> connection.query(query, [id]);</span><br/>  <span class="rot">return</span><span class="schwarz"> data.pop();</span><br/>}</samp></span><br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> remove(id) {}</span><br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> save(movie) {...} </span><span class="schwarz"/></pre></div>
                <p class="caption "><b>Listing 8.6</b>    
            Reading a Single Data Record (movie/model.js)</p>
                <p class="standard">Again, no further adjustments to the controller or view are required, so in the final step, you can turn your attention to implementing the functionality for updating the data in the database. For this purpose, you must use an update request to the database.</p>
                <p class="standard">The adjustments for the update are limited to the changes shown in <span class="crossreference "><a href="08_001.html#l8.7">Listing 8.7</a></span> because the controller passes the requests directly to the model for both updates and new installations.</p>
                <div class="listing " id="l8.7"><pre><span class="rot">import</span><span class="schwarz"> mysql </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'mysql2/promise'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="rot">const</span><span class="schwarz"> connection </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> mysql</span><span class="schwarz">.createConnection({...});</span><span class="schwarz"><br/></span> <br/><span class="rot">await</span><span class="schwarz"> connection</span><span class="schwarz">.connect();</span><span class="schwarz"><br/></span> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">getAll()</span><span class="schwarz"> </span><span class="schwarz">{...}</span><span class="schwarz"><br/></span> <br/><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">insert(</span><span class="schwarz">movie</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{...}</span><span class="schwarz"><br/></span> <br/><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> update(movie) {</span><br/>  <span class="rot">const</span><span class="schwarz"> query </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="hellblau">'UPDATE Movies SET title = ?, year = ? WHERE id = ?'</span><span class="schwarz">;</span><br/>  <span class="rot">await</span><span class="schwarz"> connection.query(query, [movie.title, movie.year, movie.id]);</span><br/>  <span class="rot">return</span><span class="schwarz"> movie;</span><br/>}<br/> </samp></span><br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> get(id) {...}</span><br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> remove(id) {}</span><br/><span class="rot"><a id="p250"/>export</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> save(movie) {</span><br/>  <span class="rot">if</span><span class="schwarz"> (</span><span class="dunkelblau">!</span><span class="schwarz">movie.id) {</span><br/>    <span class="rot">return</span><span class="schwarz"> insert(movie);</span><br/>  } <span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">else</span><span class="schwarz"> {</span><br/>    <span class="rot">return</span><span class="schwarz"> update(movie);</span><br/>  }</samp></span><br/>} <span class="schwarz"/></pre></div>
                <p class="caption "><b>Listing 8.7</b>    
            Sending the Update Request to the Database (movie/model.js)</p>
            
            
                <h4 class="t4" id="h8.1.1.8">Removing Data Records<a class="indexanchor" id="i08_46"/></h4>
                <p class="standard">The last operation you’ll learn about here in connection with MySQL is deleting data records from the database. Deleting<a class="indexanchor" id="i08_47"/> data records can’t be easily undone. If you work with referential integrity via foreign keys, deleting one record can result in a cascade<a class="indexanchor" id="i08_48"/> of deletions of other data records that are based on that record. You should therefore always exercise caution with such operations and, if in doubt, prompt the user for confirmation via a dialog. <span class="crossreference "><a href="08_001.html#l8.8">Listing 8.8</a></span> shows how you can remove data records from your database.</p>
                <div class="listing " id="l8.8"><pre><span class="rot">import</span><span class="schwarz"> mysql </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'mysql2/promise'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="rot">const</span><span class="schwarz"> connection </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> mysql</span><span class="schwarz">.createConnection({...});</span><span class="schwarz"><br/></span> <br/><span class="rot">await</span><span class="schwarz"> connection</span><span class="schwarz">.connect();</span><span class="schwarz"><br/></span> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">getAll()</span><span class="schwarz"> </span><span class="schwarz">{...}</span><span class="schwarz"><br/></span> <br/><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">insert(</span><span class="schwarz">movie</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{...}</span><span class="schwarz"><br/></span> <br/><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">update(</span><span class="schwarz">movie</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{...}</span><span class="schwarz"><br/></span> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">get(</span><span class="schwarz">id</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{...}</span><span class="schwarz"><br/></span> <br/><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> remove(id) {</span><br/>  <span class="rot">const</span><span class="schwarz"> query </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="hellblau">'DELETE FROM Movies WHERE id = ?'</span><span class="schwarz">;</span><br/>  <span class="rot">await</span><span class="schwarz"> connection.query(query, [id]);</span><br/>  <span class="rot">return</span><span class="schwarz">;</span><br/>}<br/> </samp></span><br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> save(movie) {...} </span><span class="schwarz"/></pre></div>
                <p class="caption "><b>Listing 8.8</b>    
            Deleting Data Records (movie/model.js)</p>
                <p class="standard">With regard to the structure, the <samp class="listingcharacter listingcharacter">remove</samp> function is similar to the <samp class="listingcharacter listingcharacter">get</samp> function except that you use a <samp class="listingcharacter listingcharacter">DELETE</samp> statement<a class="indexanchor" id="i08_49"/> instead of a <samp class="listingcharacter listingcharacter">SELECT</samp> statement<a class="indexanchor" id="i08_50"/>. With these customizations, <a id="p251"/>you can now manage the data records in your application. You can create new records, view existing ones, and modify them. You can delete data records from the database that are no longer needed.</p>
                <p class="standard">An alternative to the final deletion of data records is the marking<a class="indexanchor" id="i08_51"/> of records. In the database, this is represented by an additional field within the table. This field contains the value <samp class="listingcharacter listingcharacter">0</samp> for active data records and the value <samp class="listingcharacter listingcharacter">1</samp> for deleted data records. The drawback of this variant is that you have to take care of the referential integrity of your database by yourself; that is, you have to mark dependent data records as deleted yourself.</p>
                <p class="standard">The fact that you need to install a driver for each respective database access enables you to connect different databases. Besides MySQL, there are numerous other relational databases. A lightweight alternative, for example, is SQLite.</p>
            
        
        
            <h3 class="t3" id="h8.1.2">8.1.2    SQLite<a class="indexanchor" id="i08_52"/></h3>
            <p class="standard">An important difference between MySQL and SQLite is that SQLite doesn’t require a server process. The client software directly accesses the database stored in a file during queries. SQLite also requires no configuration. You can use the database immediately after initialization.</p>
            <p class="standard">SQLite is available for a wide range of systems. For example, there are precompiled binary packages<a class="indexanchor" id="i08_53"/> for Linux, macOS, and Windows.</p>
            <p class="standard">Because SQLite stores the database data in a file, it can be copied and backed up in a very simple way.</p>
            <p class="standard">Unlike MySQL, SQLite doesn’t have its own user management. This means you can’t assign any permissions, which makes a multiuser system at the database level impossible. You can only solve the permissions problem at the file system level by assigning the appropriate read and write permissions to the respective users. Ideally, this is done via group assignment so that you can give permissions to multiple users.</p>
            
                <h4 class="t4" id="h8.1.2.1">Installation<a class="indexanchor" id="i08_54"/></h4>
                <p class="standard">There are several drivers for SQLite that you can use to access the database. In the following sections, you’ll learn about the <samp class="listingcharacter listingcharacter">sqlite3</samp> driver. It’s available as an npm package and can be installed via the <samp class="listingcharacter listingcharacter">npm install sqlite3</samp> command.</p>
                <p class="standard">Once you’ve installed the package, you can attach an SQLite database to your application and use it to persist data.</p>
            
            
                <h4 class="t4" id="h8.1.2.2">Database Structure<a class="indexanchor" id="i08_55"/></h4>
                <p class="standard">However, before you can interact with the database, you must create it. <span class="crossreference "><a href="08_001.html#l8.9">Listing 8.9</a></span> guides you through this process, at the end of which, you’ll have a working database with a <samp class="listingcharacter listingcharacter">movies</samp> table that you’ll use as a starting point in the following sections.</p>
                <div class="listing " id="l8.9"><pre><span class="bold"><a id="p252"/>$ sqlite3 movie.db</span><br/>Enter ".help" for usage hints.<br/>sqlite&gt; CREATE TABLE `Movies` (<br/>   ...&gt; id INTEGER PRIMARY KEY,<br/>   ...&gt; title TEXT,<br/>   ...&gt; year INTEGER);<br/>sqlite&gt; INSERT INTO `Movies` (`title`, `year`) VALUES<br/>   ...&gt; ('Iron Man', 2008),<br/>   ...&gt; ('Thor', 2011),<br/>   ...&gt; ('Captain America', 2011);<br/>sqlite&gt; </pre></div>
                <p class="caption "><b>Listing 8.9</b>    
            SQLite Database Structure</p>
                <p class="standard">Both the structure and the initial information are the same as in the MySQL example. The SQLite database is stored in a file<a class="indexanchor" id="i08_56"/> named <span class="italic">movie.db</span> in the root directory of your application. You’ll need this information to establish a connection to the database.</p>
            
            
                <h4 class="t4" id="h8.1.2.3">Establishing<a class="indexanchor" id="i08_57"/> a Connection</h4>
                <p class="standard">Because SQLite doesn’t have any internal user management, the connection setup is limited to specifying the file name. <span class="crossreference "><a href="08_001.html#l8.10">Listing 8.10</a></span> shows how you can connect to the database from the model in the <span class="italic">movie/model.js</span> file.</p>
                <div class="listing " id="l8.10"><pre><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">import</span><span class="schwarz"> sqlite </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'sqlite3'</span><span class="schwarz">;</span><br/> <br/><span class="rot">const</span><span class="schwarz"> db </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">new sqlite</span><span class="schwarz">.Database(</span><span class="hellblau">'./movie.db'</span><span class="schwarz">);</span><br/> </samp></span><br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> getAll() {}</span><br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> get(id) {}</span><br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> save(movie) {}</span><br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> remove(id) {} </span><span class="schwarz"/></pre></div>
                <p class="caption "><b>Listing 8.10</b>    
            Establishing a Connection to an SQLite Database</p>
                <p class="standard">To establish a connection to your database, two statements are sufficient. In the first step, you include the <samp class="listingcharacter listingcharacter">sqlite3</samp> package that allows you to connect to the database. Finally, in the second step, you initialize the actual database connection by creating a database object<a class="indexanchor" id="i08_58"/>, specifying the name of the file where the database is located. As your application progresses further, you can use this database object to send your queries to the database.</p>
                <p class="standard">Like the MySQL driver, the SQLite driver works asynchronously, but it doesn’t natively support promises, so you have to take care of that yourself. However, the adjustments to the application are limited to the model file because its interface remains unchanged. The following sections describe step by step how you can read the data from <a id="p253"/>the database, and then create new data records, modify the existing records, and finally delete records.</p>
            
            
                <h4 class="t4" id="h8.1.2.4">Reading Data Records<a class="indexanchor" id="i08_59"/></h4>
                <p class="standard">The SQLite driver comprises several methods that allow you to read data from your database. In the first use case, you read the complete <samp class="listingcharacter listingcharacter">movies</samp> table. For this purpose, the <samp class="listingcharacter listingcharacter">all</samp> method of the connection object is used.</p>
                <p class="standard">As the source code in <span class="crossreference "><a href="08_001.html#l8.11">Listing 8.11</a></span> shows, the signature of the <samp class="listingcharacter listingcharacter">getAll</samp> function is preserved, so you don’t need to make any changes to the rest of the application. Because the SQLite driver doesn’t support promises, you must create a promise object<a class="indexanchor" id="i08_60"/> yourself and return it. In the callback function that you pass when you create it, you then perform the actual database operation. The query remains unchanged because both MySQL and SQLite are SQL databases that largely support the same syntax. On the connection object, you must call the <samp class="listingcharacter listingcharacter">all</samp> method. It expects the query and a callback function that is called with an error object and the results of the query in the form of an array of objects. Inside the callback function, you resolve the promise with the results of the query. If an error occurs—that is, if the <samp class="listingcharacter listingcharacter">error</samp> object isn’t <samp class="listingcharacter listingcharacter">null</samp>—you must use the <samp class="listingcharacter listingcharacter">reject</samp> function to signal a failure. With a restart of your application, you can already view the movie list with the contents of your SQLite database.</p>
                <div class="listing " id="l8.11"><pre><span class="rot">import</span><span class="schwarz"> sqlite </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'sqlite3'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="rot">const</span><span class="schwarz"> db </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">new sqlite</span><span class="schwarz">.Database(</span><span class="hellblau">'./movie.db'</span><span class="schwarz">);</span><span class="schwarz"><br/></span> <br/><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> getAll() {</span><br/>  <span class="rot">return</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">Promise((resolve, reject) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>    <span class="rot">const</span><span class="schwarz"> query </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="hellblau">'SELECT * FROM Movies'</span><span class="schwarz">;</span><br/>    db.all(query, (error, results) <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>      <span class="rot">if</span><span class="schwarz"> (error) {</span><br/>        reject(error);<br/>      } <span class="rot">else</span><span class="schwarz"> {</span><br/>        resolve(results);<br/>      }<br/>    });<br/>  });<br/>}<br/> </samp></span><br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> get(id) {}</span><br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> save(movie) {}</span><br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> remove(id) {} </span><span class="schwarz"/></pre></div>
                <p class="caption "><b>Listing 8.11</b>    
            Reading the Existing Data Records (movie/model.js)</p>
            
            
                <h4 class="t4" id="h8.1.2.5"><a id="p254"/>Creating Data Records<a class="indexanchor" id="i08_61"/></h4>
                <p class="standard">Unlike the <samp class="listingcharacter listingcharacter">mysql</samp> driver, the SQLite driver distinguishes between read and write accesses. Using the <samp class="listingcharacter listingcharacter">run</samp> method<a class="indexanchor" id="i08_62"/> of the connection object, you’ll implement the write operations in the following sections.</p>
                <div class="listing " id="l8.12"><pre><span class="rot">import</span><span class="schwarz"> sqlite </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'sqlite3'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="rot">const</span><span class="schwarz"> db </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">new sqlite</span><span class="schwarz">.Database(</span><span class="hellblau">'./movie.db'</span><span class="schwarz">);</span><span class="schwarz"><br/></span> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">getAll()</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="rot">return</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">Promise((</span><span class="schwarz">resolve</span><span class="schwarz">,</span><span class="schwarz"> reject</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="rot">const</span><span class="schwarz"> query </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="hellblau">'SELECT * FROM Movies'</span><span class="schwarz">;</span><span class="schwarz"><br/></span>    db<span class="schwarz">.all(</span><span class="schwarz">query</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">error</span><span class="schwarz">,</span><span class="schwarz"> results</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>      <span class="rot">if</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">error</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>        <span class="schwarz">reject(</span><span class="schwarz">error</span><span class="schwarz">);</span><span class="schwarz"><br/></span>      <span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">else</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>        <span class="schwarz">resolve(</span><span class="schwarz">results</span><span class="schwarz">);</span><span class="schwarz"><br/></span>      <span class="schwarz">}</span><span class="schwarz"><br/></span>    <span class="schwarz">});</span><span class="schwarz"><br/></span>  <span class="schwarz">});</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"><br/></span> <br/><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">function</span><span class="schwarz"> insert(movie) {</span><br/>  <span class="rot">return</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">Promise((resolve, reject) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>    <span class="rot">const</span><span class="schwarz"> query </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="hellblau">'INSERT INTO Movies (title, year) VALUES (?, ?)'</span><span class="schwarz">;</span><br/>    db.run(query, [movie.title, movie.year], (error, results) <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>      <span class="rot">if</span><span class="schwarz"> (error) {</span><br/>        reject(error);<br/>      } <span class="rot">else</span><span class="schwarz"> {</span><br/>        resolve(results);<br/>      }<br/>    });<br/>  });<br/>}<br/> </samp></span><br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> get(id) {}</span><br/> <br/><span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> save(movie) {</span><br/>  <span class="rot">if</span><span class="schwarz"> (</span><span class="dunkelblau">!</span><span class="schwarz">movie.id) {</span><br/>    <span class="rot">return</span><span class="schwarz"> insert(movie);</span><br/>  }<br/>}<br/> </samp></span><br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> remove(id) {} </span><span class="schwarz"/></pre></div>
                <p class="caption "><b>Listing 8.12</b>    
            Creating Data Records with SQLite (movie/model.js)</p>
                <p class="standard"><a id="p255"/>The <samp class="listingcharacter listingcharacter">save</samp> function works similar to the MySQL example. If the object doesn’t have an ID, it’s a new data record, and the <samp class="listingcharacter listingcharacter">insert</samp> function is executed.</p>
                <p class="standard">The content of the <samp class="listingcharacter listingcharacter">insert</samp> function is again encapsulated in a promise. Inside the callback function, you prepare the SQL statement to insert the record, and you use the <samp class="listingcharacter listingcharacter">run</samp> method of the database object to execute the query. The driver carries out the escaping<a class="indexanchor" id="i08_63"/> job here as well. After the request is complete, the driver executes the function you pass as the third parameter.</p>
                <p class="standard">At this point, we need to take a look at a peculiarity in accessing the ID field the database has assigned to the new data record: In the callback function of the <samp class="listingcharacter listingcharacter">run</samp> method, you can access more information using <samp class="listingcharacter listingcharacter">this</samp> within the callback function. For an <samp class="listingcharacter listingcharacter">INSERT</samp> query,<a class="indexanchor" id="i08_64"/> the <samp class="listingcharacter listingcharacter">lastID</samp> property is available here and contains the <samp class="listingcharacter listingcharacter">rowid</samp> of the record you inserted with this command. For this reason, you can’t use an arrow function at this point because <samp class="listingcharacter listingcharacter">this</samp> can’t take the required value here.</p>
            
            
                <h4 class="t4" id="h8.1.2.6">Editing Data Records<a class="indexanchor" id="i08_65"/></h4>
                <p class="standard"><span class="crossreference "><a href="08_001.html#l8.13">Listing 8.13</a></span> summarizes the adjustments you need to make to edit the data records.</p>
                <div class="listing " id="l8.13"><pre><span class="rot">import</span><span class="schwarz"> sqlite </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'sqlite3'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="rot">const</span><span class="schwarz"> db </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">new sqlite</span><span class="schwarz">.Database(</span><span class="hellblau">'./movie.db'</span><span class="schwarz">);</span><span class="schwarz"><br/></span> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">getAll()</span><span class="schwarz"> </span><span class="schwarz">{...}</span><span class="schwarz"><br/></span> <br/><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">insert(</span><span class="schwarz">movie</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{...}</span><span class="schwarz"><br/></span> <br/><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">function</span><span class="schwarz"> update(movie) {</span><br/>  <span class="rot">return</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">Promise((resolve, reject) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>    <span class="rot">const</span><span class="schwarz"> query </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="hellblau">'UPDATE Movies SET title = ?, year = ? WHERE id = ?'</span><span class="schwarz">;</span><br/>    db.run(query, [movie.title, movie.year, movie.id], (error, results) <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>      <span class="rot">if</span><span class="schwarz"> (error) {</span><br/>        reject(error);<br/>      } <span class="rot">else</span><span class="schwarz"> {</span><br/>        resolve(results);<br/>      }<br/>    });<br/>  });<br/>}<br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> get(id) {</span><br/>  <span class="rot">return</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">Promise((resolve, reject) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>    <span class="rot">const</span><span class="schwarz"> query </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="hellblau">'SELECT * FROM Movies WHERE id = ?'</span><span class="schwarz">;</span><br/>    db.get(query, [id], (error, results) <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>      <span class="rot">if</span><span class="schwarz"> (error) {</span><br/><a id="p256"/>        reject(error);<br/>      } <span class="rot">else</span><span class="schwarz"> {</span><br/>        resolve(results);<br/>      }<br/>    });<br/>  });<br/>}<br/> </samp></span><br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> save(movie) {</span><br/>  <span class="rot">if</span><span class="schwarz"> (</span><span class="dunkelblau">!</span><span class="schwarz">movie.id) {</span><br/>    <span class="rot">return</span><span class="schwarz"> insert(movie);</span><br/>  <span class="bold"><samp class="listingcharacter listingcharacter">} <span class="rot">else</span><span class="schwarz"> {</span><br/>    <span class="rot">return</span><span class="schwarz"> update(movie);</span><br/>  }</samp></span><br/>}<br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> remove(id) {} </span><span class="schwarz"/></pre></div>
                <p class="caption "><b>Listing 8.13</b>    
            Editing and Reading Data Records (movie/model.js)</p>
                <p class="standard">In addition to the <samp class="listingcharacter listingcharacter">all</samp> method<a class="indexanchor" id="i08_66"/> for reading all data records returned by a query, you can use the <samp class="listingcharacter listingcharacter">get</samp> method<a class="indexanchor" id="i08_67"/> to read only one data record. You use this method to read the data record within the <samp class="listingcharacter listingcharacter">get</samp> function so that you can fill the form with the appropriate data. The remainder of the implementation process for the <samp class="listingcharacter listingcharacter">get</samp> function, which you export for the controller, as well as the update <samp class="listingcharacter listingcharacter">function</samp>, follows the same pattern as for adding and reading all records: You encapsulate the function in a promise, prepare the query, then use the driver and its escaping feature, and finally register a callback function in which you then resolve or reject the promise, depending on whether the query was successful or not.</p>
            
            
                <h4 class="t4" id="h8.1.2.7">Deleting Data Records<a class="indexanchor" id="i08_68"/></h4>
                <p class="standard">The last operation to be ported is deleting data records. After that, you’ll have a fully functional movie database on the basis of SQLite. Again, you follow the familiar pattern of creating a new promise object, preparing the database operation in the callback function, and sending the request using the <samp class="listingcharacter listingcharacter">run</samp> method of the database object. Finally, you set the result and thus the state of the promise object in the callback function that you pass to the <samp class="listingcharacter listingcharacter">run</samp> method. You can see the corresponding source code in <span class="crossreference "><a href="08_001.html#l8.14">Listing 8.14</a></span>.</p>
                <div class="listing " id="l8.14"><pre><span class="rot">import</span><span class="schwarz"> sqlite </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'sqlite3'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="rot">const</span><span class="schwarz"> db </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">new sqlite</span><span class="schwarz">.Database(</span><span class="hellblau">'./movie.db'</span><span class="schwarz">);</span><span class="schwarz"><br/></span> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">getAll()</span><span class="schwarz"> </span><span class="schwarz">{...}</span><span class="schwarz"><br/></span> <br/><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">insert(</span><span class="schwarz">movie</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{...}</span><span class="schwarz"><br/></span><a id="p257"/> <br/><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">update(</span><span class="schwarz">movie</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{...}</span><span class="schwarz"><br/></span> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">get(</span><span class="schwarz">id</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{...}</span><span class="schwarz"><br/></span> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">save(</span><span class="schwarz">movie</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{...}</span><span class="schwarz"><br/></span> <br/><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> remove(id) {</span><br/>  <span class="rot">return</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">Promise((resolve, reject) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>    <span class="rot">const</span><span class="schwarz"> query </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="hellblau">'DELETE FROM Movies WHERE id = ?'</span><span class="schwarz">;</span><br/>    db.run(query, [id], (error, results) <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>      <span class="rot">if</span><span class="schwarz"> (error) {</span><br/>        reject(error);<br/>      } <span class="rot">else</span><span class="schwarz"> {</span><br/>        resolve(results);<br/>      }<br/>    });<br/>  });</samp></span><br/>} <span class="schwarz"/></pre></div>
                <p class="caption "><b>Listing 8.14</b>    
            Deleting Data Records in SQLite</p>
                <p class="standard">In the previous sections, you’ve seen that although the two databases—MySQL and SQLite—differ significantly, it makes relatively little difference in the source code of your application which database you use. The basic principles of accessing them are always the same. You issue a query and handle the result asynchronously in your application. The biggest differences here are in the specific driver implementations and whether they provide you with native promises or if you must take care of that yourself.</p>
                <p class="standard">In the following section, we’ll introduce another abstraction layer<a class="indexanchor" id="i08_69"/> for database access with object-relational mapping (ORM) for Node.js, which makes both the connection and an eventual replacement of the database yet another bit easier.</p>
            
        
        
            <h3 class="t3" id="h8.1.3">8.1.3    Object-Relational Mapping<a class="indexanchor" id="i08_70"/></h3>
            <p class="standard">ORM<a class="indexanchor" id="i08_71"/> refers to the mapping of database relations to objects. With such a tool, you normally hardly need to write SQL queries yourself because the tool does it for you. You can focus on describing operations in terms of objects and method calls. Several ORM libraries exist for Node.js, such as Sequelize<a class="indexanchor" id="i08_72"/>, Waterline<a class="indexanchor" id="i08_73"/>, and ORM2<a class="indexanchor" id="i08_74"/>. In this section, we’ll introduce you to Sequelize. The other libraries are based on the same principle, but they differ somewhat in syntax and supported features.</p>
            <p class="standard">One of the great advantages of ORM is that you’re relatively independent of the database you use. ORM abstracts the access to the database for you. For this reason, you <a id="p258"/>must always install the appropriate database driver for ORM. In the case of the current example, you must install ORM and the appropriate SQLite driver via the <samp class="listingcharacter listingcharacter">npm install sequelize sqlite</samp> command.</p>
            <p class="standard">When integrating ORM into the movie database, the customizations are limited to the <span class="italic">movie/model.js</span> file, as before. The rest of the application remains unchanged. Before you can make your queries, you must first configure ORM, much like a database driver. For the SQLite database used, this requires the steps shown in <span class="crossreference "><a href="08_001.html#l8.15">Listing 8.15</a></span>.</p>
            <div class="listing " id="l8.15"><pre><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> Sequelize </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'sequelize'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="rot">const</span><span class="schwarz"> sequelize </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">Sequelize({</span><span class="schwarz"><br/></span>  dialect<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'sqlite'</span><span class="schwarz">,</span><span class="schwarz"><br/></span>  storage<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'./movie.db'</span><span class="schwarz">,</span><span class="schwarz"><br/></span><span class="schwarz">});</span><span class="schwarz"><br/></span> <br/><span class="rot">const</span><span class="schwarz"> Movies </span><span class="dunkelblau">=</span><span class="schwarz"> sequelize</span><span class="schwarz">.define(</span><span class="schwarz"><br/></span>  <span class="hellblau">'Movies'</span><span class="schwarz">,</span><span class="schwarz"><br/></span>  <span class="schwarz">{</span><span class="schwarz"><br/></span>    title<span class="schwarz">:</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>      type<span class="schwarz">:</span><span class="schwarz"> Sequelize</span><span class="schwarz">.</span><span class="schwarz">STRING</span><span class="schwarz">,</span><span class="schwarz"><br/></span>    <span class="schwarz">},</span><span class="schwarz"><br/></span>    year<span class="schwarz">:</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>      type<span class="schwarz">:</span><span class="schwarz"> Sequelize</span><span class="schwarz">.</span><span class="schwarz">INTEGER</span><span class="schwarz">,</span><span class="schwarz"><br/></span>    <span class="schwarz">},</span><span class="schwarz"><br/></span>  <span class="schwarz">},</span><span class="schwarz"><br/></span>  <span class="schwarz">{</span><span class="schwarz"> timestamps</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="rot">false</span><span class="schwarz"> </span><span class="schwarz">},</span><span class="schwarz"><br/></span><span class="schwarz">);</span><span class="schwarz"> </span></pre></div>
            <p class="caption "><b>Listing 8.15</b>    
            Configuration of Sequelize for SQLite (movie/model.js)</p>
            <p class="standard">When you create the new Sequelize instance, you use the <samp class="listingcharacter listingcharacter">dialect</samp> property to pass the type of database. In this case, it’s the <samp class="listingcharacter listingcharacter">sqlite</samp> value. Based on this information, Sequelize selects the correct driver for the connection and uses its application programming interface (API) accordingly. For SQLite, you also use the <samp class="listingcharacter listingcharacter">storage</samp> property to specify the location of the database file. For databases such as MySQL, which may reside on a remote system and have authentication, you pass the database name and a user name and password to the constructor. You can pass the host name via the options object, such as the <samp class="listingcharacter listingcharacter">dialect</samp><a class="indexanchor" id="i08_75"/>.</p>
            <p class="standard">Once you’ve created the Sequelize instance<a class="indexanchor" id="i08_76"/> and thus have a connection to the database, you can define models representing the table in your database. In the example, this is the <samp class="listingcharacter listingcharacter">movies</samp> table. Use the <samp class="listingcharacter listingcharacter">define</samp> method of the Sequelize instance to create such a model. You pass the table name and the structure of the table as an object to the method, in which you specify the data types of the respective columns. The last argument represents an optional configuration object<a class="indexanchor" id="i08_77"/>. Specifying <samp class="listingcharacter listingcharacter">timestamps: false</samp> here <a id="p259"/>ensures that the <samp class="listingcharacter listingcharacter">createdAt</samp> and <samp class="listingcharacter listingcharacter">updatedAt</samp> fields aren’t automatically inserted by Sequelize. Based on this model, you can formulate the queries to your database.</p>
            <p class="standard">As you can see in <span class="crossreference "><a href="08_001.html#l8.16">Listing 8.16</a></span>, the source code of your model becomes quite compact due to the use of Sequelize. The <samp class="listingcharacter listingcharacter">findAll</samp> and <samp class="listingcharacter listingcharacter">findByPk</samp> methods are used to read all data records and a single data record, respectively. The <samp class="listingcharacter listingcharacter">destroy</samp> method deletes the specified data record, while <samp class="listingcharacter listingcharacter">upsert</samp> either re-creates or updates the passed data record, depending on whether or not it already exists. The method can distinguish between an inserting and an updating operation, so you don’t have to worry about that yourself.</p>
            <div class="listing " id="l8.16"><pre><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> Sequelize </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'sequelize'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="rot">const</span><span class="schwarz"> sequelize </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">Sequelize({</span><span class="schwarz"><br/></span>  dialect<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'sqlite'</span><span class="schwarz">,</span><span class="schwarz"><br/></span>  storage<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'./movie.db'</span><span class="schwarz">,</span><span class="schwarz"><br/></span><span class="schwarz">});</span><span class="schwarz"><br/></span> <br/><span class="rot">const</span><span class="schwarz"> Movies </span><span class="dunkelblau">=</span><span class="schwarz"> sequelize</span><span class="schwarz">.define(</span><span class="schwarz"><br/></span>  <span class="hellblau">'Movies'</span><span class="schwarz">,</span><span class="schwarz"><br/></span>  <span class="schwarz">{</span><span class="schwarz"><br/></span>    title<span class="schwarz">:</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>      type<span class="schwarz">:</span><span class="schwarz"> Sequelize</span><span class="schwarz">.</span><span class="schwarz">STRING</span><span class="schwarz">,</span><span class="schwarz"><br/></span>    <span class="schwarz">},</span><span class="schwarz"><br/></span>    year<span class="schwarz">:</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>      type<span class="schwarz">:</span><span class="schwarz"> Sequelize</span><span class="schwarz">.</span><span class="schwarz">INTEGER</span><span class="schwarz">,</span><span class="schwarz"><br/></span>    <span class="schwarz">},</span><span class="schwarz"><br/></span>  <span class="schwarz">},</span><span class="schwarz"><br/></span>  <span class="schwarz">{</span><span class="schwarz"> timestamps</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="rot">false</span><span class="schwarz"> </span><span class="schwarz">},</span><span class="schwarz"><br/></span><span class="schwarz">);</span><span class="schwarz"><br/></span> <br/><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">export</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> getAll() {</span><br/>  <span class="rot">return</span><span class="schwarz"> Movies.findAll();</span><br/>}<br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> get(id) {</span><br/>  <span class="rot">return</span><span class="schwarz"> Movies.findByPk(id);</span><br/>}<br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> remove(id) {</span><br/>  <span class="rot">return</span><span class="schwarz"> Movies.destroy({ where: { id } });</span><br/>}<br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> save(movie) {</span><br/>  <span class="rot">return</span><span class="schwarz"> Movies.upsert(movie);</span><br/>}</samp></span> <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 8.16</b>    
            Querying the Database via the Sequelize Model (movie/model.js)</p>
            <p class="standard"><a id="p260"/>After this excursion into the world of relational databases, we’ll devote the second part of this chapter to the connection of nonrelational databases.</p>
        
    </div><p class="signatur"/>
                    </body>
                </html>