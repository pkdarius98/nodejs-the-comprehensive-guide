<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
                    
        <head><meta content="application/xhtml+xml; charset=utf-8" http-equiv="Content-Type"/>
            <meta content="application/xhtml+xml; charset=utf-8" name="content-type"/>
            <meta content="Web Applications with Nest" name="title"/>
            <meta content="Sebastian Springer" name="author"/>
            <meta content="Rheinwerk Publishing" name="publisher"/>
            <meta content="© 2022 by Rheinwerk Publishing Inc., Boston (MA)" name="copyright"/>
            <meta content="Node.js - The Comprehensive Guide - Web Applications with Nest" name="description"/>
            <meta content="en" name="language"/>
            <title>Web Applications with Nest</title>
            <link href="common/main.css" rel="stylesheet" type="text/css"/>
<meta content="urn:uuid:e0000000-0000-0000-0000-000029756394" name="Adept.expected.resource"/>
        </head>
    


                    <body class="office_us type_kapitel">
                        <div id="main">
        <h2 class="t2" id="h14.9">14.9    Authentication<a class="indexanchor" id="i14_119"/></h2>
        <p class="standard">For authentication, Nest uses an established library—Passport—and integrates it into the framework via an abstraction layer. The flexibility of Passport allows you to implement different logon strategies. In our case, we use JSON web tokens (JWTs)<a class="indexanchor" id="i14_120"/>.</p>
        
            <h3 class="t3" id="h14.9.1">14.9.1    Setup</h3>
            <p class="standard">First you need to install some additional packages via the <samp class="listingcharacter listingcharacter">npm install @nestjs/passport passport @nestjs/jwt passport-jwt</samp> command. In addition, you must install the type definitions of <samp class="listingcharacter listingcharacter">passport-jwt</samp> as <samp class="listingcharacter listingcharacter">DevDependency</samp> via the <samp class="listingcharacter listingcharacter">npm install --save-dev @types/passport-jwt</samp> command.</p>
            <p class="standard"><a id="p443"/>Theoretically, you can store your users’ credentials permanently in the source code, but because there’s already an existing database connection, it makes sense to use this database to store user data as well. Therefore, you should first create a new module named <samp class="listingcharacter listingcharacter">auth</samp> using the <samp class="listingcharacter listingcharacter">nest generate module auth</samp> command. Within this module, you then create a user entity using the <samp class="listingcharacter listingcharacter">nest generate class user.entity auth</samp> command. Then you modify this class in such a way that it represents a valid entity and reflects the structure of the database table. <span class="crossreference "><a href="14_009.html#l14.27">Listing 14.27</a></span> shows what this class should look like.</p>
            <div class="listing " id="l14.27"><pre><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> Column</span><span class="schwarz">,</span><span class="schwarz"> Entity</span><span class="schwarz">,</span><span class="schwarz"> PrimaryGeneratedColumn </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'typeorm'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/>@<span class="schwarz">Entity(</span><span class="hellblau">'User'</span><span class="schwarz">)</span><span class="schwarz"><br/></span><span class="rot">export</span><span class="schwarz"> </span><span class="rot">class User</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  @<span class="schwarz">PrimaryGeneratedColumn()</span><span class="schwarz"><br/></span>  id<span class="schwarz">:</span><span class="schwarz"> number</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/>  @<span class="schwarz">Column()</span><span class="schwarz"><br/></span>  username<span class="schwarz">:</span><span class="schwarz"> string</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/>  @<span class="schwarz">Column()</span><span class="schwarz"><br/></span>  password<span class="schwarz">:</span><span class="schwarz"> string</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"> </span></pre></div>
            <p class="caption "><b>Listing 14.27</b>    
            Implementing a User Entity (src/auth/user.entity.ts)</p>
            <p class="standard">After that, you include the entity in the import of the TypeORM module within the app and auth modules in the <samp class="listingcharacter listingcharacter">entities</samp> array, just as you did with the movie entity. <span class="crossreference "><a href="14_009.html#l14.28">Listing 14.28</a></span> contains the current state of the auth module.</p>
            <div class="listing " id="l14.28"><pre><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> Module </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'@nestjs/common'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> TypeOrmModule </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'@nestjs/typeorm'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> User </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./user.entity'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/>@<span class="schwarz">Module({</span><span class="schwarz"> imports</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="schwarz">[</span><span class="schwarz">TypeOrmModule</span><span class="schwarz">.forFeature([</span><span class="schwarz">User</span><span class="schwarz">])]</span><span class="schwarz"> </span><span class="schwarz">})</span><span class="schwarz"><br/></span><span class="rot">export</span><span class="schwarz"> </span><span class="rot">class AuthModule</span><span class="schwarz"> </span><span class="schwarz">{}</span><span class="schwarz"> </span></pre></div>
            <p class="caption "><b>Listing 14.28</b>    
            Integration of the TypeORM Module in the Auth Module (src/auth/auth.module.ts)</p>
        
        
            <h3 class="t3" id="h14.9.2">14.9.2    Authentication Service<a class="indexanchor" id="i14_121"/></h3>
            <p class="standard">In the next step, you implement the central service that takes care of authentication issues such as verifying a user and generating a JWT<a class="indexanchor" id="i14_122"/>. You can create this service via the <samp class="listingcharacter listingcharacter">nest generate service auth</samp> command. In the service class, you implement the <samp class="listingcharacter listingcharacter">validateUser</samp> and <samp class="listingcharacter listingcharacter">login</samp> methods, as you can see in <span class="crossreference "><a href="14_009.html#l14.29">Listing 14.29</a></span>.</p>
            <div class="listing " id="l14.29"><pre><span class="rot"><a id="p444"/>import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> Injectable </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'@nestjs/common'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> JwtService </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'@nestjs/jwt'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> InjectRepository </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'@nestjs/typeorm'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> Repository </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'typeorm'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> User </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./user.entity'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/>@<span class="schwarz">Injectable()</span><span class="schwarz"><br/></span><span class="rot">export</span><span class="schwarz"> </span><span class="rot">class AuthService</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="schwarz">constructor(</span><span class="schwarz"><br/></span>    @<span class="schwarz">InjectRepository(</span><span class="schwarz">User</span><span class="schwarz">)</span><span class="schwarz"><br/></span>    <span class="rot">private</span><span class="schwarz"> userRepository</span><span class="schwarz">:</span><span class="schwarz"> Repository</span><span class="dunkelblau">&lt;</span><span class="schwarz">User</span><span class="dunkelblau">&gt;</span><span class="schwarz">,</span><span class="schwarz"><br/></span>    <span class="rot">private</span><span class="schwarz"> jwtService</span><span class="schwarz">:</span><span class="schwarz"> JwtService</span><span class="schwarz">,</span><span class="schwarz"><br/></span>  <span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{}</span><span class="schwarz"><br/></span> <br/>  <span class="rot">async</span><span class="schwarz"> </span><span class="schwarz">validateUser(</span><span class="schwarz">username</span><span class="schwarz">:</span><span class="schwarz"> string</span><span class="schwarz">,</span><span class="schwarz"> password</span><span class="schwarz">:</span><span class="schwarz"> string</span><span class="schwarz">):</span><span class="schwarz"> Promise</span><span class="dunkelblau">&lt;</span><span class="schwarz">Omit</span><span class="dunkelblau">&lt;</span><span class="schwarz">User</span><span class="schwarz">,</span><span class="schwarz"> </span><img alt="inline image" class="inline_image" src="bilder/umbruchpfeil.png"/><br/>    <span class="hellblau">'password'</span><span class="dunkelblau">&gt;&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="rot">const</span><span class="schwarz"> user </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> </span><span class="rot">this</span><span class="schwarz">.</span><span class="schwarz">userRepository</span><span class="schwarz">.findOne({</span><span class="schwarz">username</span><span class="schwarz">,</span><span class="schwarz"> password</span><span class="schwarz">});</span><span class="schwarz"><br/></span>    <span class="rot">if</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">user</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>      <span class="rot">const</span><span class="schwarz"> validatedUser </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="schwarz">{...</span><span class="schwarz">user</span><span class="schwarz">};</span><span class="schwarz"><br/></span>      <span class="rot">delete</span><span class="schwarz"> validatedUser</span><span class="schwarz">.</span><span class="schwarz">password</span><span class="schwarz">;</span><span class="schwarz"><br/></span>      <span class="rot">return</span><span class="schwarz"> validatedUser</span><span class="schwarz">;</span><span class="schwarz"><br/></span>    <span class="schwarz">}</span><span class="schwarz"><br/></span>    <span class="rot">return</span><span class="schwarz"> </span><span class="rot">null</span><span class="schwarz">;</span><span class="schwarz"><br/></span>  <span class="schwarz">}</span><span class="schwarz"><br/></span> <br/>  <span class="rot">async</span><span class="schwarz"> </span><span class="schwarz">login(</span><span class="schwarz">user</span><span class="schwarz">:</span><span class="schwarz"> User</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="rot">const</span><span class="schwarz"> payload </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> username</span><span class="schwarz">:</span><span class="schwarz"> user</span><span class="schwarz">.</span><span class="schwarz">username</span><span class="schwarz">,</span><span class="schwarz"> sub</span><span class="schwarz">:</span><span class="schwarz"> user</span><span class="schwarz">.</span><span class="schwarz">id </span><span class="schwarz">};</span><span class="schwarz"><br/></span>    <span class="rot">return</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>      access_token<span class="schwarz">:</span><span class="schwarz"> </span><span class="rot">this</span><span class="schwarz">.</span><span class="schwarz">jwtService</span><span class="schwarz">.sign(</span><span class="schwarz">payload</span><span class="schwarz">),</span><span class="schwarz"><br/></span>    <span class="schwarz">};</span><span class="schwarz"><br/></span>  <span class="schwarz">}</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"> </span></pre></div>
            <p class="caption "><b>Listing 14.29</b>    
            Implementing the Auth Service (src/auth/auth.service.ts)</p>
            <p class="standard">In the constructor, you have Nest create an instance of the user repository and the JWT service. The <samp class="listingcharacter listingcharacter">validateUser</samp> method receives the user name and password entered at login as arguments. These two pieces of information are used to search for the matching data record in the database. If this search returns a hit, you delete the password from the received data record and return it. If the information was invalid, that is, no matching record was found, you return the value <samp class="listingcharacter listingcharacter">null</samp>.</p>
            <p class="standard">The <samp class="listingcharacter listingcharacter">login</samp> method receives a <samp class="listingcharacter listingcharacter">user</samp> object as an argument and returns an object with a signed JWT. This token contains the user name and the ID of the user. At this point you must make sure not to include passwords or similar critical data in a token under any circumstances.</p>
        
        
            <h3 class="t3" id="h14.9.3">14.9.3    <a id="p445"/>Login Controller: Endpoint for User Login<a class="indexanchor" id="i14_123"/></h3>
            <p class="standard">For your users to be able to log in, you need to create a suitable endpoint. This is done by the auth controller in the auth module<a class="indexanchor" id="i14_124"/>, which you create using the <samp class="listingcharacter listingcharacter">nest generate controller auth</samp> command. You can see the source code of the controller in <span class="crossreference "><a href="14_009.html#l14.30">Listing 14.30</a></span>.</p>
            <div class="listing " id="l14.30"><pre><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> Body</span><span class="schwarz">,</span><span class="schwarz"> Controller</span><span class="schwarz">,</span><span class="schwarz"> Post</span><span class="schwarz">,</span><span class="schwarz"> UnauthorizedException </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'@nestjs/common'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> AuthService </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./auth.service'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> User </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./user.entity'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/>@<span class="schwarz">Controller(</span><span class="hellblau">'auth'</span><span class="schwarz">)</span><span class="schwarz"><br/></span><span class="rot">export</span><span class="schwarz"> </span><span class="rot">class AuthController</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="schwarz">constructor(</span><span class="rot">private</span><span class="schwarz"> readonly authService</span><span class="schwarz">:</span><span class="schwarz"> AuthService</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{}</span><span class="schwarz"><br/></span> <br/>  @<span class="schwarz">Post(</span><span class="hellblau">'login'</span><span class="schwarz">)</span><span class="schwarz"><br/></span>  <span class="rot">async</span><span class="schwarz"> </span><span class="schwarz">login(</span><span class="schwarz">@</span><span class="schwarz">Body()</span><span class="schwarz"> user</span><span class="schwarz">:</span><span class="schwarz"> User</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="rot">const</span><span class="schwarz"> validUser </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> </span><span class="rot">this</span><span class="schwarz">.</span><span class="schwarz">authService</span><span class="schwarz">.validateUser(</span><span class="schwarz"><br/></span>      user<span class="schwarz">.</span><span class="schwarz">username</span><span class="schwarz">,</span><span class="schwarz"><br/></span>      user<span class="schwarz">.</span><span class="schwarz">password</span><span class="schwarz">,</span><span class="schwarz"><br/></span>    <span class="schwarz">);</span><span class="schwarz"><br/></span>    <span class="rot">if</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">validUser</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>      <span class="rot">return</span><span class="schwarz"> </span><span class="rot">this</span><span class="schwarz">.</span><span class="schwarz">authService</span><span class="schwarz">.login(</span><span class="schwarz">user</span><span class="schwarz">);</span><span class="schwarz"><br/></span>    <span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">else</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>      <span class="rot">throw</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">UnauthorizedException();</span><span class="schwarz"><br/></span>    <span class="schwarz">}</span><span class="schwarz"><br/></span>  <span class="schwarz">}</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"> </span></pre></div>
            <p class="caption "><b>Listing 14.30</b>    
            Auth Controller (src/auth/auth.controller.ts)</p>
            <p class="standard">The job of the auth controller is to provide your users with a <samp class="listingcharacter listingcharacter">POST</samp> endpoint with the path <span class="italic">/auth/login</span> to which they can send their login details to receive a JWT. To validate the user name and password, the controller uses the <samp class="listingcharacter listingcharacter">validateUser</samp> method of the auth service. If a valid user is found, a token is generated; otherwise, the controller returns an <samp class="listingcharacter listingcharacter">UnauthorizedException</samp><a class="indexanchor" id="i14_125"/>, which results in a return message to the client with a <samp class="listingcharacter listingcharacter">401</samp> status code.</p>
            <p class="standard">For the controller and especially the <samp class="listingcharacter listingcharacter">JwtService</samp> used in the <samp class="listingcharacter listingcharacter">AuthService</samp> to work, you still need to slightly adjust the auth module. <span class="crossreference "><a href="14_009.html#l14.31">Listing 14.31</a></span> contains the relevant details.</p>
            <div class="listing " id="l14.31"><pre><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> Module </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'@nestjs/common'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> TypeOrmModule </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'@nestjs/typeorm'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> User </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./user.entity'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> AuthService </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./auth.service'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> AuthController </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./auth.controller'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot"><a id="p446"/>import</span><span class="schwarz"> { JwtModule } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'@nestjs/jwt'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> { PassportModule } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'@nestjs/passport'</span><span class="schwarz">;</span><br/> </samp></span><br/>@Module({<br/>  imports: [<br/>    TypeOrmModule.forFeature([User]),<br/>    <span class="bold"><samp class="listingcharacter listingcharacter">PassportModule,<br/>    JwtModule.register({<br/>      secret: <span class="hellblau">'secret'</span><span class="schwarz">,</span><br/>      signOptions: { expiresIn: <span class="hellblau">'1h'</span><span class="schwarz"> },</span><br/>    }),</samp></span><br/>  ],<br/>  providers: [AuthService],<br/>  controllers: [AuthController],<br/>})<br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">class AuthModule</span><span class="schwarz"> {} </span><span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 14.31</b>    
            Integrating Passport in the Auth Module (src/auth/auth.module.ts)</p>
            <p class="standard">You can integrate the Passport module without any further configuration. Instead, you pass a configuration object to the <samp class="listingcharacter listingcharacter">register</samp> method of the <samp class="listingcharacter listingcharacter">Jwt</samp> module, similar to the configuration of TypeORM. Here, you define the basic configuration for your JWT. The <samp class="listingcharacter listingcharacter">secret</samp> field is especially critical because this information is used to sign your tokens—so it’s again a good candidate for removing it from the source code and including it in an external configuration such as environment variables. You must also specify how long the token should be valid. The shorter you choose this period, the more secure your tokens are, but the faster your users will have to renew them. At this point, you can already issue tokens, but your application’s resources are still unsecured.</p>
        
        
            <h3 class="t3" id="h14.9.4">14.9.4    Protecting Routes<a class="indexanchor" id="i14_126"/></h3>
            <p class="standard">To protect routes, Nest provides the concept of guards. You can think of a guard as a bouncer who only lets authorized requests through to the endpoint. In a first step, you must create such a guard<a class="indexanchor" id="i14_127"/> for the JWT strategy<a class="indexanchor" id="i14_128"/>. To do this, you use the <samp class="listingcharacter listingcharacter">nest generate class jwt.guard auth</samp> command to generate a new class in the <span class="italic">auth</span> directory. You can see the contents of this file in <span class="crossreference "><a href="14_009.html#l14.32">Listing 14.32</a></span>.</p>
            <div class="listing " id="l14.32"><pre><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> Injectable </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'@nestjs/common'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> AuthGuard </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'@nestjs/passport'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/>@<span class="schwarz">Injectable()</span><span class="schwarz"><br/></span><span class="rot">export</span><span class="schwarz"> </span><span class="rot">class JwtAuthGuard</span><span class="schwarz"> </span><span class="rot">extends </span><span class="schwarz">AuthGuard(</span><span class="hellblau">'jwt'</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{}</span><span class="schwarz"> </span></pre></div>
            <p class="caption "><b>Listing 14.32</b>    
            JWT Guard for the Resources of the Application (<span class="italic">src/auth/jwt.guard.ts</span>)</p>
            <p class="standard"><a id="p447"/>For your application to handle JWT correctly, you need to implement an appropriate strategy. This is a standard task, so Nest already takes a lot off your plate here. First, you must create a new file named <span class="italic">jwt.strategy.ts</span> in the <span class="italic">src/auth</span> directory. In this file, you now implement the <samp class="listingcharacter listingcharacter">JwtStrategy</samp> class. You can see the source code of this class in <span class="crossreference "><a href="14_009.html#l14.33">Listing 14.33</a></span>.</p>
            <div class="listing " id="l14.33"><pre><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> ExtractJwt</span><span class="schwarz">,</span><span class="schwarz"> Strategy </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'passport-jwt'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> PassportStrategy </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'@nestjs/passport'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> Injectable </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'@nestjs/common'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/>@<span class="schwarz">Injectable()</span><span class="schwarz"><br/></span><span class="rot">export</span><span class="schwarz"> </span><span class="rot">class JwtStrategy</span><span class="schwarz"> </span><span class="rot">extends </span><span class="schwarz">PassportStrategy(</span><span class="schwarz">Strategy</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="schwarz">constructor()</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="schwarz">super({</span><span class="schwarz"><br/></span>      jwtFromRequest<span class="schwarz">:</span><span class="schwarz"> ExtractJwt</span><span class="schwarz">.fromAuthHeaderAsBearerToken(),</span><span class="schwarz"><br/></span>      ignoreExpiration<span class="schwarz">:</span><span class="schwarz"> </span><span class="rot">false</span><span class="schwarz">,</span><span class="schwarz"><br/></span>      secretOrKey<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'secret'</span><span class="schwarz">,</span><span class="schwarz"><br/></span>    <span class="schwarz">});</span><span class="schwarz"><br/></span>  <span class="schwarz">}</span><span class="schwarz"><br/></span> <br/>  <span class="rot">async</span><span class="schwarz"> </span><span class="schwarz">validate(</span><span class="schwarz">payload</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> sub</span><span class="schwarz">:</span><span class="schwarz"> number</span><span class="schwarz">;</span><span class="schwarz"> username</span><span class="schwarz">:</span><span class="schwarz"> string </span><span class="schwarz">})</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="rot">return</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> id</span><span class="schwarz">:</span><span class="schwarz"> payload</span><span class="schwarz">.</span><span class="schwarz">sub</span><span class="schwarz">,</span><span class="schwarz"> username</span><span class="schwarz">:</span><span class="schwarz"> payload</span><span class="schwarz">.</span><span class="schwarz">username </span><span class="schwarz">};</span><span class="schwarz"><br/></span>  <span class="schwarz">}</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"> </span></pre></div>
            <p class="caption "><b>Listing 14.33</b>    
            Implementing the “JwtStrategy” (src/auth/jwt.strategy.ts)</p>
            <p class="standard">At its core, the <samp class="listingcharacter listingcharacter">JwtStrategy</samp> simply derives from the <samp class="listingcharacter listingcharacter">PassportStrategy</samp> class and adapts it for your application.</p>
            <p class="standard">Now you can link the <samp class="listingcharacter listingcharacter">JwtGuard</samp><a class="indexanchor" id="i14_129"/> to the movie controller. You can do this using the <samp class="listingcharacter listingcharacter">UseGuards</samp> decorator<a class="indexanchor" id="i14_130"/>, which you can bind either to specific methods or to the complete controller. <span class="crossreference "><a href="14_009.html#l14.34">Listing 14.34</a></span> contains the modification of the controller.</p>
            <div class="listing " id="l14.34"><pre><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  Body<span class="schwarz">,</span><span class="schwarz"><br/></span>  Controller<span class="schwarz">,</span><span class="schwarz"><br/></span>  Delete<span class="schwarz">,</span><span class="schwarz"><br/></span>  Get<span class="schwarz">,</span><span class="schwarz"><br/></span>  HttpCode<span class="schwarz">,</span><span class="schwarz"><br/></span>  Param<span class="schwarz">,</span><span class="schwarz"><br/></span>  Post<span class="schwarz">,</span><span class="schwarz"><br/></span>  Put<span class="schwarz">,</span><span class="schwarz"><br/></span>  <span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter">UseGuards,</samp></span><br/>} <span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'@nestjs/common'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> { ApiOkResponse, ApiTags } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'@nestjs/swagger'</span><span class="schwarz">;</span><br/><span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot"><a id="p448"/>import</span><span class="schwarz"> { JwtAuthGuard } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'../auth/jwt.guard'</span><span class="schwarz">;</span></samp></span><br/><span class="rot">import</span><span class="schwarz"> { Movie } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./movie.entity'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> { InputMovie } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./movie.interface'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> { MovieService } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./movie.service'</span><span class="schwarz">;</span><br/> <br/>@ApiTags(<span class="hellblau">'movies'</span><span class="schwarz">)</span><br/><span class="bold"><samp class="listingcharacter listingcharacter">@UseGuards(JwtAuthGuard)</samp></span><br/>@Controller(<span class="hellblau">'movie'</span><span class="schwarz">)</span><br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">class MovieController</span><span class="schwarz"> {</span><br/>  ...<br/>} <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 14.34</b>    
            Integrating the JWT Guard in the Controller (src/movie/movie.controller.ts)</p>
            <p class="standard">If you now access one of the routes of the movie controller without having provided for a valid token before, you’ll receive a response with status code <samp class="listingcharacter listingcharacter">401</samp>, <samp class="listingcharacter listingcharacter">unauthorized</samp>. For a valid response, you must first send your user name and the corresponding password to <span class="italic">http://localhost:3000/auth/login</span> in a <samp class="listingcharacter listingcharacter">POST</samp> request and use the token you receive there in the authorization header<a class="indexanchor" id="i14_131"/> to send the request to the movie controller. <span class="crossreference "><a href="14_009.html#f14.4">Figure 14.4</a></span> shows an example of such a request with Postman.</p>
            <div class="imagebox figure-type"><a href="img-f14.4.html" id="f14.4"><img alt="Request to the Movie Controller with a Valid Token" id="img-f14.4" src="bilderklein/klein14_004.png"/></a></div>
            <p class="caption "><b>Figure 14.4</b>    
            Request to the Movie Controller with a Valid Token</p>
        
    </div><p class="signatur"/>
                    </body>
                </html>