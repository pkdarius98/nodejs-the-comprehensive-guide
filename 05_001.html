<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
                    
        <head><meta content="application/xhtml+xml; charset=utf-8" http-equiv="Content-Type"/>
            <meta content="application/xhtml+xml; charset=utf-8" name="content-type"/>
            <meta content="HTTP" name="title"/>
            <meta content="Sebastian Springer" name="author"/>
            <meta content="Rheinwerk Publishing" name="publisher"/>
            <meta content="© 2022 by Rheinwerk Publishing Inc., Boston (MA)" name="copyright"/>
            <meta content="Node.js - The Comprehensive Guide - HTTP" name="description"/>
            <meta content="en" name="language"/>
            <title>HTTP</title>
            <link href="common/main.css" rel="stylesheet" type="text/css"/>
<meta content="urn:uuid:e0000000-0000-0000-0000-000029756394" name="Adept.expected.resource"/>
        </head>
    


                    <body class="office_us type_kapitel">
                        <div id="main"><h1 class="t1" id="h5">5    <a id="p137"/>HTTP</h1><p class="introductorynote indent_chapter_single">No one serves another of his own free will, but if he knows that he is serving himself, he does it gladly.<br/>—Johann Wolfgang von Goethe</p><p class="standard">One<a class="indexanchor" id="i05_00"/> of the most well-known and also most important modules of Node.js is the <samp class="listingcharacter listingcharacter">http</samp> module. This module enables you to create a web server<a class="indexanchor" id="i05_01"/> with Node.js. What is important for you to know at this point is that this is a full-fledged web server that you can run independently from other server applications such as Nginx<a class="indexanchor" id="i05_02"/> or Apache<a class="indexanchor" id="i05_03"/>. With a Node.js web server, you can respond to incoming HTTP requests and send an appropriate response back to your users’ browsers. However, the <samp class="listingcharacter listingcharacter">http</samp> module can do much more than just send HTML structures to a user’s browser<a class="indexanchor" id="i05_04"/>. The <samp class="listingcharacter listingcharacter">http</samp> module and its secure variant, the <samp class="listingcharacter listingcharacter">https</samp> module, allow you to respond to different types of requests, accept file uploads, and also take on the role of a browser yourself and send requests to other web servers. In addition to the <samp class="listingcharacter listingcharacter">http</samp> module for the first version of the HTTP protocol<a class="indexanchor" id="i05_05"/>, Node.js contains a separate module for HTTP/2<a class="indexanchor" id="i05_06"/>—the <samp class="listingcharacter listingcharacter">http2</samp> module.</p><p class="standard">In this chapter, you’ll learn about the numerous facets of <samp class="listingcharacter listingcharacter">http</samp> modules. A practical example will demonstrate how you can solve various tasks with relatively little source code.</p>
        <h2 class="t2" id="h5.1">5.1    Web Server</h2>
        <p class="standard">In the first part of this chapter, you’ll learn more about Node.js in the role of an <samp class="listingcharacter listingcharacter">http</samp> server. In a step-by-step process, you’ll implement a simple address book where you can create, read, update, and delete records.</p>
        
            <h3 class="t3" id="h5.1.1">5.1.1    Server<a class="indexanchor" id="i05_07"/> Object</h3>
            <p class="standard">In <span class="crossreference "><a href="03_001.html#h3">Chapter 3</a></span>, you were able to gain some initial experience with implementing a web server in Node.js. You’ve also seen that the platform already does some of the work for you in this respect. Before you start with the actual implementation, you must first create a <span class="italic">package.json</span> file in a new directory using the <samp class="listingcharacter listingcharacter">npm init -y</samp><a class="indexanchor" id="i05_08"/> command, as shown in <span class="crossreference "><a href="05_001.html#l5.1">Listing 5.1</a></span>.</p>
            <div class="listing " id="l5.1"><pre><span class="schwarz"><a id="p138"/>{</span><span class="schwarz"><br/></span>  <span class="hellblau">"name"</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">"node-book"</span><span class="schwarz">,</span><span class="schwarz"><br/></span>  <span class="hellblau">"version"</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">"1.0.0"</span><span class="schwarz">,</span><span class="schwarz"><br/></span>  <span class="hellblau">"description"</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">""</span><span class="schwarz">,</span><span class="schwarz"><br/></span>  <span class="hellblau">"main"</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">"index.js"</span><span class="schwarz">,</span><span class="schwarz"><br/></span>  <span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="hellblau">"type"</span><span class="schwarz">: </span><span class="hellblau">"module"</span><span class="schwarz">,</span></samp></span><br/>  <span class="hellblau">"scripts"</span><span class="schwarz">: {</span><br/>    <span class="bold"><samp class="listingcharacter listingcharacter"><span class="hellblau">"start"</span><span class="schwarz">: </span><span class="hellblau">"node index.js"</span></samp></span><span class="schwarz"><br/></span>  },<br/>  <span class="hellblau">"author"</span><span class="schwarz">: </span><span class="hellblau">""</span><span class="schwarz">,</span><br/>  <span class="hellblau">"license"</span><span class="schwarz">: </span><span class="hellblau">"ISC"</span><span class="schwarz"><br/></span>} <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 5.1</b>    
            The package.json File of the Address Book</p>
            <p class="standard">The two changes to the default version of <span class="italic">package.json</span> shown in <span class="crossreference "><a href="05_001.html#l5.1">Listing 5.1</a></span> are the activation of the ECMAScript module system via the <samp class="listingcharacter listingcharacter">type</samp> property and the <samp class="listingcharacter listingcharacter">start</samp> entry under <samp class="listingcharacter listingcharacter">scripts</samp>. The latter is a Node Package Manager (npm) script that allows you to launch the application on the console using the <samp class="listingcharacter listingcharacter">npm start</samp> command instead of entering <samp class="listingcharacter listingcharacter">node index.js</samp>. The advantage here is that you can customize and add options to the startup script as you wish, but for those who want to use your application, the command to launch it always remains the same. <span class="crossreference "><a href="05_001.html#l5.2">Listing 5.2</a></span> contains the source code of the startup file named <span class="italic">index.js</span>, which serves as the basis for the example in this chapter.</p>
            <div class="listing " id="l5.2"><pre><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> createServer </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'http'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="schwarz">createServer((</span><span class="schwarz">request</span><span class="schwarz">,</span><span class="schwarz"> response</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  response<span class="schwarz">.writeHead(200,</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> </span><span class="hellblau">'content-type'</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'text/html'</span><span class="schwarz"> </span><span class="schwarz">});</span><span class="schwarz"><br/></span>  <span class="rot">const</span><span class="schwarz"> responseBody </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="violett">`&lt;!DOCTYPE html&gt;</span><br/>    &lt;html&gt;<br/>      &lt;head&gt;<br/>        &lt;title&gt;Address book&lt;/title&gt;<br/>      &lt;/head&gt;<br/>      &lt;body&gt;<br/>        &lt;h1&gt;Address book&lt;/h1&gt;<br/>      &lt;/body&gt;<br/>    &lt;/html&gt;`<span class="schwarz">;</span><span class="schwarz"><br/></span>  response<span class="schwarz">.end(</span><span class="schwarz">responseBody</span><span class="schwarz">);</span><span class="schwarz"><br/></span><span class="schwarz">}).listen(8080,</span><span class="schwarz"> </span><span class="schwarz">()</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="magenta">console</span><span class="schwarz">.log(</span><span class="hellblau">'Adress book reachable via http://localhost:8080'</span><span class="schwarz">);</span><span class="schwarz"><br/></span><span class="schwarz">});</span><span class="schwarz"> </span></pre></div>
            <p class="caption "><b>Listing 5.2</b>    
            Getting Started with the Web Server with Node.js (index.js)</p>
            <p class="standard">In <span class="crossreference "><a href="05_001.html#l5.3">Listing 5.3</a></span>, you can see what Node.js does with the code in this example.</p>
            <div class="listing " id="l5.3"><pre><span class="rot"><a id="p139"/>import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> Server </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'http'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="rot">const</span><span class="schwarz"> server </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">Server();</span><span class="schwarz"><br/></span> <br/>server<span class="schwarz">.on(</span><span class="hellblau">'request'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">request</span><span class="schwarz">,</span><span class="schwarz"> response</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  response<span class="schwarz">.</span><span class="schwarz">statusCode </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="schwarz">200;</span><span class="schwarz"><br/></span>  response<span class="schwarz">.setHeader(</span><span class="hellblau">'content-type'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="hellblau">'text/html'</span><span class="schwarz">);</span><span class="schwarz"><br/></span>  <span class="rot">const</span><span class="schwarz"> responseBody </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="violett">`&lt;!DOCTYPE html&gt;</span><br/>  &lt;html&gt;<br/>    &lt;head&gt;<br/>      &lt;title&gt;Address book&lt;/title&gt;<br/>    &lt;/head&gt;<br/>    &lt;body&gt;<br/>      &lt;h1&gt;Address book&lt;/h1&gt;<br/>    &lt;/body&gt;<br/>  &lt;/html&gt;`<span class="schwarz">;</span><span class="schwarz"><br/></span>  response<span class="schwarz">.write(</span><span class="schwarz">responseBody</span><span class="schwarz">);</span><span class="schwarz"><br/></span>  response<span class="schwarz">.end();</span><span class="schwarz"><br/></span><span class="schwarz">});</span><span class="schwarz"><br/></span> <br/>server<span class="schwarz">.on(</span><span class="hellblau">'listening'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">()</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="magenta">console</span><span class="schwarz">.log(</span><span class="hellblau">'Adress book reachable via http://localhost:8080'</span><span class="schwarz">);</span><span class="schwarz"><br/></span><span class="schwarz">});</span><span class="schwarz"><br/></span> <br/>server<span class="schwarz">.listen(8080);</span><span class="schwarz"> </span></pre></div>
            <p class="caption "><b>Listing 5.3</b>    
            The Web Server in Detail (index.js)</p>
            <p class="standard">If you start the server process and then access it from the browser via the address <span class="italic">http://localhost:8080/</span>, you should see a view like the one shown in <span class="crossreference "><a href="05_001.html#f5.1">Figure 5.1</a></span>. The source code from the examples in <span class="crossreference "><a href="05_001.html#l5.2">Listing 5.2</a></span> and <span class="crossreference "><a href="05_001.html#l5.3">Listing 5.3</a></span> has the same functionality with the only difference being that care has been taken in <span class="crossreference "><a href="05_001.html#l5.3">Listing 5.3</a></span> to make the individual steps happening in the background clearer for you.</p>
            <ul>
                <li>
                    <p class="standard first-item last-item"><span class="bold"><samp class="listingcharacter listingcharacter">createServer</samp></span><a class="indexanchor" id="i05_09"/><br/>This function creates an instance of the <samp class="listingcharacter listingcharacter">server</samp> class. You can also do this yourself by creating a new instance using the <samp class="listingcharacter listingcharacter">server</samp> constructor of the <samp class="listingcharacter listingcharacter">http</samp> module and the <samp class="listingcharacter listingcharacter">new</samp> operator. The callback function you pass to the <samp class="listingcharacter listingcharacter">createServer</samp> method is bound to the server’s <samp class="listingcharacter listingcharacter">request</samp> event.</p>
                </li>
                <li>
                    <p class="standard first-item last-item"><span class="bold"><samp class="listingcharacter listingcharacter">listen</samp></span><br/>With the <samp class="listingcharacter listingcharacter">listen</samp> method of the <samp class="listingcharacter listingcharacter">server</samp> object, you instruct your server to listen for incoming connections on the specified Transmission Control Protocol (TCP) port<a class="indexanchor" id="i05_10"/> and an Internet Protocol (IP) address<a class="indexanchor" id="i05_11"/>.</p>
                </li>
                <li>
                    <p class="standard first-item last-item"><span class="bold"><samp class="listingcharacter listingcharacter"><a id="p140"/>write</samp></span><br/>The <samp class="listingcharacter listingcharacter">write</samp> method allows you to write only a part of the body. You can call this method several times per response. Calling the <samp class="listingcharacter listingcharacter">write</samp> method causes the specified content to be sent as a chunk, that is, as part of the message to the client. Optionally, you can pass the encoding<a class="indexanchor" id="i05_12"/> of the string as the second argument and a callback function as the third argument. This function is called as soon as the chunk<a class="indexanchor" id="i05_13"/> has been sent.</p>
                </li>
                <li>
                    <p class="standard first-item last-item"><span class="bold"><samp class="listingcharacter listingcharacter">end</samp></span><br/>The <samp class="listingcharacter listingcharacter">write</samp> method sends only a part of the message but keeps the response open for further parts. If you want to signal to the client that it has received the entire message with a particular data packet, you must use the <samp class="listingcharacter listingcharacter">end</samp> method. If you don’t do this, the client terminates the connection itself after a preconfigured period of time and evaluates this as a time-out. The <samp class="listingcharacter listingcharacter">end</samp> method has the same signature as the <samp class="listingcharacter listingcharacter">write</samp> method. You can use it to send the last chunk of a message. After calling the <samp class="listingcharacter listingcharacter">end</samp> method, the response is completed. You can’t send any further chunks.</p>
                </li>
            </ul>
            <div class="imagebox figure-type"><a href="img-f5.1.html" id="f5.1"><img alt="Initial View of the Address Book" id="img-f5.1" src="bilderklein/klein05_001.png"/></a></div>
            <p class="caption "><b>Figure 5.1</b>    
            Initial View of the Address Book</p>
            <p class="standard">In the simplest case, you merely pass a TCP port to the <samp class="listingcharacter listingcharacter">listen</samp> method. The server is then bound to all available IPv6<a class="indexanchor" id="i05_14"/> interfaces on the specified port. If IPv6 isn’t available, IPv4<a class="indexanchor" id="i05_15"/> is used. If the port number is 0, the server is bound to a random port that you can identify using the <samp class="listingcharacter listingcharacter">address</samp> function of the server object. You can also specify an IP address or a host name<a class="indexanchor" id="i05_16"/>, and then the server will be bound to this address.</p>
            <p class="standard">The third optional argument of the <samp class="listingcharacter listingcharacter">listen</samp> method allows you to specify the size of the queue<a class="indexanchor" id="i05_17"/> for incoming connections. The standard value is <samp class="listingcharacter listingcharacter">511</samp>.</p>
            <p class="standard">If you specify a function last, regardless of the number of arguments, it will be executed as soon as the server is successfully connected. This callback function is bound to the <samp class="listingcharacter listingcharacter">listening</samp> event of the server. It’s often used to generate console output, signaling to a user that the server is waiting for incoming connections. If you don’t provide an output, the console prompt disappears without another message.</p>
            <p class="standard">Once you’ve bound the server by calling the <samp class="listingcharacter listingcharacter">listen</samp> method, it waits for requests. You can stop this process by calling the <samp class="listingcharacter listingcharacter">close</samp> method on the server object. This ensures that the server doesn’t accept any new requests.</p>
            <p class="standard"><a id="p141"/>Both <samp class="listingcharacter listingcharacter">write</samp> and <samp class="listingcharacter listingcharacter">end</samp> accept strings and <samp class="listingcharacter listingcharacter">buffer</samp> objects as their first argument. The default value for the encoding is <samp class="listingcharacter listingcharacter">utf8</samp><a class="indexanchor" id="i05_18"/>. If you haven’t yet called <samp class="listingcharacter listingcharacter">writeHead</samp> (i.e., the method to prepare for sending the header information<a class="indexanchor" id="i05_19"/>) before calling <samp class="listingcharacter listingcharacter">write</samp>, then <samp class="listingcharacter listingcharacter">write</samp> will do this for you and also send the implicit header information to the client. If the <samp class="listingcharacter listingcharacter">write</samp> method returns <samp class="listingcharacter listingcharacter">true</samp>, it means that the message was successfully passed to the kernel. The value <samp class="listingcharacter listingcharacter">false</samp>, on the other hand, means that the message has been queued. When the buffer is freed up again, the <samp class="listingcharacter listingcharacter">drain</samp> event gets triggered. Before you finalize the message by calling the <samp class="listingcharacter listingcharacter">end</samp> method, you can use the message trailer to add more metadata to the message. The <samp class="listingcharacter listingcharacter">addTrailers</samp> method allows you to specify an object with the appropriate information, which is then sent to the client.</p>
            <div class="box box_standard">
                <h6 class="boxheading">Arrow Functions<a class="indexanchor" id="i05_20"/></h6>
                <p class="standard first"><span class="italic">Arrow functions</span> are a feature of ECMAScript 2015<a class="indexanchor" id="i05_21"/>. This syntax is a shorthand notation for functions with some handy effects. <span class="crossreference "><a href="05_001.html#l5.4">Listing 5.4</a></span> shows an example of such an arrow function.</p>
                <div class="listing " id="l5.4"><pre><span class="rot">const</span><span class="schwarz"> arr </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="schwarz">[1,</span><span class="schwarz"> </span><span class="schwarz">2,</span><span class="schwarz"> </span><span class="schwarz">3];</span><span class="schwarz"><br/></span><span class="rot">const</span><span class="schwarz"> mappedArr </span><span class="dunkelblau">=</span><span class="schwarz"> arr</span><span class="schwarz">.map((</span><span class="schwarz">el</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="rot">return</span><span class="schwarz"> el </span><span class="dunkelblau">*</span><span class="schwarz"> </span><span class="schwarz">2;</span><span class="schwarz"><br/></span><span class="schwarz">});</span><span class="schwarz"><br/></span><span class="magenta">console</span><span class="schwarz">.log(</span><span class="schwarz">mappedArr</span><span class="schwarz">);</span><span class="gruen"> // Output: [ 2, 4, 6 ]</span><span class="schwarz"> </span></pre></div>
                <p class="caption "><b>Listing 5.4</b>    
            Arrow Function in Connection with the Array “map” Function</p>
                <p class="standard">The code in the example applies the arrow function to each array element and creates a modified copy of the original array. After that, the copy will be output. A special feature of arrow functions is that the parentheses of the parameter list<a class="indexanchor" id="i05_22"/> are optional if there is only one parameter. In addition, if there is only one expression, the return value<a class="indexanchor" id="i05_23"/> is returned directly. As a result, you get a very abbreviated notation, as you can see in <span class="crossreference "><a href="05_001.html#l5.5">Listing 5.5</a></span>.</p>
                <div class="listing " id="l5.5"><pre><span class="rot">const</span><span class="schwarz"> arr </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="schwarz">[1,</span><span class="schwarz"> </span><span class="schwarz">2,</span><span class="schwarz"> </span><span class="schwarz">3];</span><span class="schwarz"><br/></span><span class="rot">const</span><span class="schwarz"> mappedArr </span><span class="dunkelblau">=</span><span class="schwarz"> arr</span><span class="schwarz">.map(</span><span class="schwarz">el </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> el </span><span class="dunkelblau">*</span><span class="schwarz"> </span><span class="schwarz">2);</span><span class="schwarz"><br/></span><span class="magenta">console</span><span class="schwarz">.log(</span><span class="schwarz">mappedArr</span><span class="schwarz">);</span><span class="gruen"> // Output: [ 2, 4, 6 ]</span><span class="schwarz"> </span></pre></div>
                <p class="caption "><b>Listing 5.5</b>    
            Shortened Arrow Function</p>
                <p class="standard">Another special feature concerns the value of <samp class="listingcharacter listingcharacter">this</samp><a class="indexanchor" id="i05_24"/> in an arrow function. In a normal callback function used inside an object, as in <span class="crossreference "><a href="05_001.html#l5.6">Listing 5.6</a></span>, the value of <samp class="listingcharacter listingcharacter">this</samp> is the global object. This behavior can be changed by specifying the <samp class="listingcharacter listingcharacter">use strict</samp> string. In strict mode<a class="indexanchor" id="i05_25"/>, <samp class="listingcharacter listingcharacter">this</samp> then has the value <samp class="listingcharacter listingcharacter">undefined</samp>. The situation is made even more error-prone by the fact that you can bind a function to another context via the <samp class="listingcharacter listingcharacter">bind</samp> method and thus additionally influence the value of <samp class="listingcharacter listingcharacter">this</samp>.</p>
                <div class="listing " id="l5.6"><pre><span class="rot">const</span><span class="schwarz"> myObj </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="schwarz">myMethod()</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="schwarz">setTimeout(function()</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span><a id="p142"/>      <span class="magenta">console</span><span class="schwarz">.log(</span><span class="rot">this</span><span class="schwarz">);</span><span class="gruen"> // Output: Timeout { ... }</span><span class="schwarz"><br/></span>    <span class="schwarz">});</span><span class="schwarz"><br/></span>  <span class="schwarz">},</span><span class="schwarz"><br/></span><span class="schwarz">};</span><span class="schwarz"><br/></span><br/>myObj<span class="schwarz">.myMethod();</span><span class="schwarz"> </span></pre></div>
                <p class="caption "><b>Listing 5.6</b>    
            Callback Function</p>
                <p class="standard">This fact is especially relevant for asynchronous operations in objects. In this case, you can access the object context<a class="indexanchor" id="i05_26"/> by storing it in a separate variable or binding the callback function to the correct context. Alternatively, you can also use an arrow function, as shown in <span class="crossreference "><a href="05_001.html#l5.7">Listing 5.7</a></span>.</p>
                <div class="listing " id="l5.7"><pre><span class="rot">const</span><span class="schwarz"> myObj </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="schwarz">myMethod()</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="schwarz">setTimeout(()</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>      <span class="magenta">console</span><span class="schwarz">.log(</span><span class="rot">this</span><span class="schwarz">);</span><span class="gruen"> // Output: { myMethod: [Function: myMethod] }</span><span class="schwarz"><br/></span>    <span class="schwarz">});</span><span class="schwarz"><br/></span>  <span class="schwarz">},</span><span class="schwarz"><br/></span><span class="schwarz">};</span><span class="schwarz"><br/></span><br/>myObj<span class="schwarz">.myMethod();</span><span class="schwarz"> </span></pre></div>
                <p class="caption "><b>Listing 5.7</b>    
            Arrow Functions as Callback</p>
                <p class="standard last">Arrow functions are mainly used where short functions are used, such as most array functions. As soon as a function becomes more extensive, you should no longer write it inline, but consider using a normal function.</p>
            </div>
        
        
            <h3 class="t3" id="h5.1.2">5.1.2    Server Events<a class="indexanchor" id="i05_27"/></h3>
            <p class="standard">As you’ve seen from the callbacks of the <samp class="listingcharacter listingcharacter">request</samp> and <samp class="listingcharacter listingcharacter">listening</samp> events, when building the web server, the event-driven architecture of Node.js also runs through the <samp class="listingcharacter listingcharacter">http</samp> module. In your implementation, you can draw on a set of events that help you respond asynchronously to various incidents.</p>
            <p class="standard"><span class="crossreference "><a href="05_001.html#t5.1">Table 5.1</a></span> shows the most important events of the HTTP server. The <samp class="listingcharacter listingcharacter">listening</samp> event isn’t part of the <samp class="listingcharacter listingcharacter">http</samp> server itself, but originates from the <samp class="listingcharacter listingcharacter">net</samp> module and the <samp class="listingcharacter listingcharacter">server</samp> class, which serves as the parent class of the <samp class="listingcharacter listingcharacter">http</samp> server.</p>
            <table class="standardtable" id="t5.1">
                <thead>
                    <tr>
                        <th class="tablehead tablecell_first top_border_cell">
                            <p class="standard first-item last-item">Event</p>
                        </th>
                        <th class="tablehead tablecell_last top_border_cell">
                            <p class="standard first-item last-item">Description</p>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="tablecell tablecell_first top_border_cell">
                            <p class="standard first-item last-item"><samp class="listingcharacter listingcharacter">request</samp></p>
                        </td>
                        <td class="tablecell tablecell_last top_border_cell">
                            <p class="standard first-item last-item">This represents an incoming client request.</p>
                        </td>
                    </tr>
                    <tr class="light">
                        <td class="tablecell tablecell_first">
                            <p class="standard first-item last-item"><samp class="listingcharacter listingcharacter">connection</samp></p>
                        </td>
                        <td class="tablecell tablecell_last">
                            <p class="standard first-item last-item">A connection with a client has been established.</p>
                        </td>
                    </tr>
                    <tr>
                        <td class="tablecell tablecell_first">
                            <p class="standard first-item last-item"><samp class="listingcharacter listingcharacter"><a id="p143"/>close</samp></p>
                        </td>
                        <td class="tablecell tablecell_last">
                            <p class="standard first-item last-item">The server is terminated.</p>
                        </td>
                    </tr>
                    <tr class="light">
                        <td class="tablecell tablecell_first">
                            <p class="standard first-item last-item"><samp class="listingcharacter listingcharacter">checkContinue</samp></p>
                        </td>
                        <td class="tablecell tablecell_last">
                            <p class="standard first-item last-item">This occurs when a request is sent with an <samp class="listingcharacter listingcharacter">Expect: 100-continue</samp> header. The server should respond with a <samp class="listingcharacter listingcharacter">100</samp> status code.</p>
                        </td>
                    </tr>
                    <tr>
                        <td class="tablecell tablecell_first">
                            <p class="standard first-item last-item"><samp class="listingcharacter listingcharacter">checkExpectation</samp></p>
                        </td>
                        <td class="tablecell tablecell_last">
                            <p class="standard first-item last-item">This is triggered when a request is received with an <samp class="listingcharacter listingcharacter">Expect</samp> header whose value isn’t <samp class="listingcharacter listingcharacter">100-continue</samp>. If you don’t implement this function, the server responds with a <samp class="listingcharacter listingcharacter">417 Expectation Failed</samp>.</p>
                        </td>
                    </tr>
                    <tr class="light">
                        <td class="tablecell tablecell_first">
                            <p class="standard first-item last-item"><samp class="listingcharacter listingcharacter">connect</samp></p>
                        </td>
                        <td class="tablecell tablecell_last">
                            <p class="standard first-item last-item">A client sends a request to the server using the HTTP method <samp class="listingcharacter listingcharacter">CONNECT</samp>.</p>
                        </td>
                    </tr>
                    <tr>
                        <td class="tablecell tablecell_first">
                            <p class="standard first-item last-item"><samp class="listingcharacter listingcharacter">upgrade</samp></p>
                        </td>
                        <td class="tablecell tablecell_last">
                            <p class="standard first-item last-item">A client requests an HTTP upgrade.</p>
                        </td>
                    </tr>
                    <tr class="light">
                        <td class="tablecell tablecell_first">
                            <p class="standard first-item last-item"><samp class="listingcharacter listingcharacter">clientError</samp></p>
                        </td>
                        <td class="tablecell tablecell_last">
                            <p class="standard first-item last-item">A client has sent an error message.</p>
                        </td>
                    </tr>
                </tbody>
            </table>
            <p class="caption "><b>Table 5.1</b>    
            Server Events</p>
            <p class="standard">In the callback functions of the individual events, you have access to different objects. These are provided to you as arguments and contain details about the event in question so that you can respond accordingly.</p>
            
                <h4 class="t4" id="h5.1.2.1">Delivery<a class="indexanchor" id="i05_28"/> of the Address Book</h4>
                <p class="standard">At this point, your address book consists only of a heading. To change this and make the result more dynamic, the first step is to take care of data management. For the address book, we use a simple JavaScript object that holds the state of the application. The disadvantage of this is that all information is lost as soon as you restart the server. <span class="crossreference "><a href="05_001.html#l5.8">Listing 5.8</a></span> contains the customized code of the address book.</p>
                <div class="listing " id="l5.8"><pre><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> createServer </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'http'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><br/><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">const</span><span class="schwarz"> addresses </span><span class="dunkelblau">=</span><span class="schwarz"> [</span><br/>  {<br/>    id: 1,<br/>    firstname: <span class="hellblau">'James'</span><span class="schwarz">,</span><br/>    lastname: <span class="hellblau">'Bond'</span><span class="schwarz">,</span><br/>    street: <span class="hellblau">'12 Millbank'</span><span class="schwarz">,</span><br/>    city: <span class="hellblau">'London'</span><span class="schwarz">,</span><br/>    country: <span class="hellblau">'United Kingdom'</span><span class="schwarz">,</span><br/>  },<br/>  {<br/>    id: 2,<br/>    firstname: <span class="hellblau">'Sherlock'</span><span class="schwarz">,</span><br/>    lastname: <span class="hellblau">'Holmes'</span><span class="schwarz">,</span><br/>    street: <span class="hellblau">'221b Baker St'</span><span class="schwarz">,</span><br/>    city: <span class="hellblau">'London'</span><span class="schwarz">,</span><br/><a id="p144"/>    country: <span class="hellblau">'United Kingdom'</span><span class="schwarz">,</span><br/>  },<br/>];<br/></samp></span><br/>createServer((request, response) <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>  response.writeHead(200, { <span class="hellblau">'content-type'</span><span class="schwarz">: </span><span class="hellblau">'text/html'</span><span class="schwarz"> });</span><br/>  <span class="rot">const</span><span class="schwarz"> responseBody </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="violett">`&lt;!DOCTYPE html&gt;</span><br/>    &lt;html&gt;<br/>      &lt;head&gt;<br/>        &lt;title&gt;Address book&lt;/title&gt;<br/>      &lt;/head&gt;<br/>      &lt;body&gt;<br/>        &lt;h1&gt;Address book&lt;/h1&gt;<br/>        <span class="bold">&lt;table&gt;<br/>          &lt;thead&gt;<br/>            &lt;tr&gt;<br/>              &lt;th&gt;Id&lt;/th&gt;<br/>              &lt;th&gt;First Name&lt;/th&gt;<br/>              &lt;th&gt;Last Name&lt;/th&gt;<br/>            &lt;/tr&gt;<br/>          &lt;/thead&gt;<br/>          &lt;tbody&gt;<br/>            ${addresses.map(createRow).join(<span class="hellblau">''</span><span class="violett">)}</span><br/>          &lt;/tbody&gt;<br/>        &lt;/table&gt;</span><br/>      &lt;/body&gt;<br/>    &lt;/html&gt;`<span class="schwarz">;</span><br/>  response.end(responseBody);<br/>}).listen(8080, () <span class="dunkelblau">=&gt;</span><span class="schwarz"><br/></span>  <span class="magenta">console</span><span class="schwarz">.log(</span><span class="hellblau">'Address book reachable at http://localhost:8080'</span><span class="schwarz">),</span><br/>);<br/><br/><span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">function</span><span class="schwarz"> createRow(address) {</span><br/>  <span class="rot">return</span><span class="schwarz"> </span><span class="violett">`&lt;tr&gt;</span><br/>    &lt;td&gt;${address.id}&lt;/td&gt;<br/>    &lt;td&gt;${address.firstname}&lt;/td&gt;<br/>    &lt;td&gt;${address.lastname}&lt;/td&gt;<br/>  &lt;/tr&gt;`<span class="schwarz">;</span><br/>}</samp></span> <span class="schwarz"/></pre></div>
                <p class="caption "><b>Listing 5.8</b>    
            Extended Address Book (index.js)</p>
                <p class="standard">The most important changes consist of defining the information to be displayed in the <samp class="listingcharacter listingcharacter">addresses</samp> array and extending the HTML<a class="indexanchor" id="i05_29"/> code. Within the template string, the table is <a id="p145"/>built using the <samp class="listingcharacter listingcharacter">map</samp> function. To keep the source code as clear and manageable as possible, the task of generating the individual rows was outsourced to the <samp class="listingcharacter listingcharacter">createRow</samp> function. After that, you must join the returned array into a string using the <samp class="listingcharacter listingcharacter">join</samp> method. You then pass the string you want to use for joining the individual array elements to this method as a parameter. In the example, an empty string is used so that the elements are appended directly to each other. The result of the extension displays in the browser as shown in <span class="crossreference "><a href="05_001.html#f5.2">Figure 5.2</a></span>.</p>
                <div class="imagebox figure-type"><a href="img-f5.2.html" id="f5.2"><img alt="List View of the Address Book" id="img-f5.2" src="bilderklein/klein05_002.png"/></a></div>
                <p class="caption "><b>Figure 5.2</b>    
            List View of the Address Book</p>
            
        
        
            <h3 class="t3" id="h5.1.3">5.1.3    Request Object<a class="indexanchor" id="i05_30"/></h3>
            <p class="standard">In the next step, you must add the possibility to delete addresses from the list. Your web server must then perform two different tasks: display the address list and delete data. Therefore, it can no longer respond to all requests in the same way. The way in which the server responds determines the URL<a class="indexanchor" id="i05_31"/> requested by the client. To identify that URL, you need to evaluate the request. This can be done via the <samp class="listingcharacter listingcharacter">request</samp> object, which contains all the information you need on the server side to answer the request accordingly.</p>
            
                <h4 class="t4" id="h5.1.3.1">Structure of a Request<a class="indexanchor" id="i05_32"/></h4>
                <p class="standard">An HTTP request normally consists of two parts: the header<a class="indexanchor" id="i05_33"/> and the message body<a class="indexanchor" id="i05_34"/>. <span class="crossreference "><a href="05_001.html#f5.3">Figure 5.3</a></span> contains a graphical representation of this structure.</p>
                <p class="standard">The header contains metadata<a class="indexanchor" id="i05_35"/> such as what format the server’s response should be in. It consists of a set of key-value pairs defined in the HTTP standard. The message body (or just body<a class="indexanchor" id="i05_36"/> for short) contains the use data of the request. Depending on the type of the request, the body doesn’t necessarily have to contain any data. A request without a body occurs when, for example, you inform a web server that you want to see a particular page or delete a resource<a class="indexanchor" id="i05_37"/> on the server. In this case, the header contains all the relevant information.</p>
                <div class="imagebox figure-type"><a href="img-f5.3.html" id="f5.3"><img alt="Structure of an HTTP Request" id="img-f5.3" src="bilderklein/klein05_003.png"/></a></div>
                <p class="caption "><b>Figure 5.3</b>    
            <a id="p146"/>Structure of an HTTP Request</p>
                <p class="standard">The situation is different with regard to sending forms. Here you have to submit data to the server. The form data usually resides as key-value pairs in the body of the message. Another example where you submit data to the server via requests are file uploads. Depending on what kind of data you’re uploading, this case can also generate very large amounts of data that you need to handle correctly on the server side.</p>
            
            
                <h4 class="t4" id="h5.1.3.2">Restructuring the Address Book</h4>
                <p class="standard">To help you implement the additional functionality in your address book, you should make use of the Node.js module system<a class="indexanchor" id="i05_38"/> and divide your application into multiple sections. The <span class="italic">index.js</span> file is the entry point. It contains the setup of the web server. <span class="crossreference "><a href="05_001.html#l5.9">Listing 5.9</a></span> contains the source code of the file.</p>
                <div class="listing " id="l5.9"><pre><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> createServer </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'http'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">import</span><span class="schwarz"> data </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./data.js'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> { getList } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./list.js'</span><span class="schwarz">;</span><br/> </samp></span><br/>createServer((request, response) <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>  response.writeHead(200, { <span class="hellblau">'content-type'</span><span class="schwarz">: </span><span class="hellblau">'text/html'</span><span class="schwarz"> });</span><br/>  <span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">const</span><span class="schwarz"> responseBody </span><span class="dunkelblau">=</span><span class="schwarz"> getList(data.addresses);</span></samp></span><br/>  response.end(responseBody);<br/>}).listen(8080, () <span class="dunkelblau">=&gt;</span><span class="schwarz"><br/></span>  <span class="magenta">console</span><span class="schwarz">.log(</span><span class="hellblau">'Address book reachable at http://localhost:8080'</span><span class="schwarz">),</span><br/>); <span class="schwarz"/></pre></div>
                <p class="caption "><b>Listing 5.9</b>    
            Getting Started with the Address Book (index.js)</p>
                <p class="standard"><a id="p147"/>The <samp class="listingcharacter listingcharacter">getList</samp> function and the array that holds the data are swapped out into separate modules. In the <span class="italic">list.js</span> file that generates the HTML structure, you can add one more column per line that contains a link to delete the entry. <span class="crossreference "><a href="05_001.html#l5.10">Listing 5.10</a></span> shows the customized source code.</p>
                <div class="listing " id="l5.10"><pre><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">export</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> getList(addresses) {</span></samp></span><br/>  <span class="rot">return</span><span class="schwarz"> </span><span class="violett">`&lt;!DOCTYPE html&gt;</span><br/>    &lt;html&gt;<br/>      &lt;head&gt;<br/>        &lt;title&gt;Address book&lt;/title&gt;<br/>        &lt;meta charset=<span class="hellblau">"utf-8"</span><span class="violett">&gt;</span><br/>      &lt;/head&gt;<br/>      &lt;body&gt;<br/>        &lt;h1&gt;Address book&lt;/h1&gt;<br/>        &lt;table&gt;<br/>          &lt;thead&gt;<br/>            &lt;tr&gt;<br/>              &lt;th&gt;Id&lt;/th&gt;<br/>              &lt;th&gt;First Name&lt;/th&gt;<br/>              &lt;th&gt;Last Name&lt;/th&gt;<br/>              <span class="bold">&lt;th&gt;delete&lt;/th&gt;</span><br/>            &lt;/tr&gt;<br/>          &lt;/thead&gt;<br/>          &lt;tbody&gt;<br/>            ${addresses.map(createRow).join(<span class="hellblau">''</span><span class="violett">)}</span><br/>          &lt;/tbody&gt;<br/>        &lt;/table&gt;<br/>      &lt;/body&gt;<br/>    &lt;/html&gt;`<span class="schwarz">;</span><br/>}<br/> <br/><span class="rot">function</span><span class="schwarz"> createRow(address) {</span><br/>  <span class="rot">return</span><span class="schwarz"> </span><span class="violett">`&lt;tr&gt;</span><br/>    &lt;td&gt;${address.id}&lt;/td&gt;<br/>    &lt;td&gt;${address.firstname}&lt;/td&gt;<br/>    &lt;td&gt;${address.lastname}&lt;/td&gt;<br/>    <span class="bold">&lt;td&gt;&lt;a href=<span class="hellblau">"/delete/${address.id}"</span><span class="violett">&gt;delete&lt;/a&gt;&lt;/td&gt;</span></span><br/>  &lt;/tr&gt;`<span class="schwarz">;</span><br/>} <span class="schwarz"/></pre></div>
                <p class="caption "><b>Listing 5.10</b>    
            List Display (list.js)</p>
                <p class="standard"><a id="p148"/>You must add the additional column in both the <samp class="listingcharacter listingcharacter">getList</samp> and <samp class="listingcharacter listingcharacter">createRow</samp> functions. In the latter, the table cell contains a link pointing to the address <span class="italic">/delete/&lt;id&gt;</span>, where <samp class="listingcharacter listingcharacter">id</samp> identifies the particular data record.</p>
                <p class="standard">What you can also see in this code example is that not only can you collect a central<a class="indexanchor" id="i05_39"/> export at the end of a file, but you can directly tag the structures you want to make available as an interface to the outside world using the <samp class="listingcharacter listingcharacter">export</samp> keyword, like the <samp class="listingcharacter listingcharacter">getList</samp> function here. The final part of the application extension is the <span class="italic">data.js</span> file, which represents the data storage.</p>
                <div class="listing " id="l5.11"><pre><span class="rot">export</span><span class="schwarz"> </span><span class="rot">default</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  addresses<span class="schwarz">:</span><span class="schwarz"> </span><span class="schwarz">[</span><span class="schwarz"><br/></span>    <span class="schwarz">{</span><span class="schwarz"><br/></span>      id<span class="schwarz">:</span><span class="schwarz"> </span><span class="schwarz">1,</span><span class="schwarz"><br/></span>      firstname<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'James'</span><span class="schwarz">,</span><span class="schwarz"><br/></span>      lastname<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'Bond'</span><span class="schwarz">,</span><span class="schwarz"><br/></span>      street<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'12 Millbank'</span><span class="schwarz">,</span><span class="schwarz"><br/></span>      city<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'London'</span><span class="schwarz">,</span><span class="schwarz"><br/></span>      country<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'United Kingdom'</span><span class="schwarz">,</span><span class="schwarz"><br/></span>    <span class="schwarz">},</span><span class="schwarz"><br/></span>    <span class="schwarz">{</span><span class="schwarz"><br/></span>      id<span class="schwarz">:</span><span class="schwarz"> </span><span class="schwarz">2,</span><span class="schwarz"><br/></span>      firstname<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'Sherlock'</span><span class="schwarz">,</span><span class="schwarz"><br/></span>      lastname<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'Holmes'</span><span class="schwarz">,</span><span class="schwarz"><br/></span>      street<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'221b Baker St'</span><span class="schwarz">,</span><span class="schwarz"><br/></span>      city<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'London'</span><span class="schwarz">,</span><span class="schwarz"><br/></span>      country<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'United Kingdom'</span><span class="schwarz">,</span><span class="schwarz"><br/></span>    <span class="schwarz">},</span><span class="schwarz"><br/></span>  <span class="schwarz">],</span><span class="schwarz"><br/></span><span class="schwarz">};</span><span class="schwarz"> </span></pre></div>
                <p class="caption "><b>Listing 5.11</b>    
            Data Management in the Application (data.js)</p>
                <p class="standard">In this case, you export an object to make it easier to modify the data later.</p>
                <p class="standard">In general, you can also solve the import of data by importing a JavaScript Object Notation (JSON) file<a class="indexanchor" id="i05_40"/>. Unlike the CommonJS module system, the ECMAScript module system doesn’t currently support such imports. This feature is still in experimental status and must first be enabled via the <samp class="listingcharacter listingcharacter">--experimental-json-modules</samp> flag. Alternatively, you can read a JSON file with the file system module or use <samp class="listingcharacter listingcharacter">module.createRequire</samp> to access the CommonJS module system. Due to the adjustments to the source code, the link to delete a record is now also visible in the browser after a restart of the server process, as shown in <span class="crossreference "><a href="05_001.html#f5.4">Figure 5.4</a></span>.</p>
                <div class="imagebox figure-type"><a href="img-f5.4.html" id="f5.4"><img alt="Possibility to Delete Records" id="img-f5.4" src="bilderklein/klein05_004.png"/></a></div>
                <p class="caption "><b>Figure 5.4</b>    
            <a id="p149"/>Possibility to Delete Records</p>
            
            
                <h4 class="t4" id="h5.1.3.3">Properties of the Request Object<a class="indexanchor" id="i05_41"/></h4>
                <p class="standard">The <samp class="listingcharacter listingcharacter">request</samp> object is the means by which the client tells the server what to do. The header information of the request is directly available as properties of the <samp class="listingcharacter listingcharacter">request</samp> object, and the message body is processed as a stream<a class="indexanchor" id="i05_42"/> of one or more data packages. You should treat the <samp class="listingcharacter listingcharacter">request</samp> object as a read-only object, or the information received could be corrupted. The most important properties of the <samp class="listingcharacter listingcharacter">request</samp> object are as follows:</p>
                <ul>
                    <li>
                        <p class="standard first-item last-item"><span class="bold"><samp class="listingcharacter listingcharacter">method</samp></span><br/>The HTTP method<a class="indexanchor" id="i05_43"/> specifies what to do with the requested resource. The value of this property is a string that can assume the value <samp class="listingcharacter listingcharacter">GET</samp>, <samp class="listingcharacter listingcharacter">POST</samp>, <samp class="listingcharacter listingcharacter">PUT</samp>, <samp class="listingcharacter listingcharacter">DELETE</samp>, <samp class="listingcharacter listingcharacter">HEAD</samp>, <samp class="listingcharacter listingcharacter">PATCH</samp>, <samp class="listingcharacter listingcharacter">TRACE</samp>, or <samp class="listingcharacter listingcharacter">OPTIONS</samp>, for example. In web development, <samp class="listingcharacter listingcharacter">GET</samp> and <samp class="listingcharacter listingcharacter">POST</samp> are most commonly used.</p>
                    </li>
                    <li>
                        <p class="standard first-item last-item"><span class="bold"><samp class="listingcharacter listingcharacter">url</samp></span><br/>In a request, the URL<a class="indexanchor" id="i05_44"/> represents the resource the client wants to use. If in the browser, you click the link to delete the first record, and the <samp class="listingcharacter listingcharacter">url</samp> property assumes the value <samp class="listingcharacter listingcharacter">/delete/1</samp>. If you specify a query string in addition to the path, the <samp class="listingcharacter listingcharacter">url</samp> property will contain that string as well.</p>
                    </li>
                    <li>
                        <p class="standard first-item last-item"><span class="bold"><samp class="listingcharacter listingcharacter">header</samp></span><br/>Metadata about the request is transmitted as key-value pairs via the HTTP header<a class="indexanchor" id="i05_45"/>. For example, the <samp class="listingcharacter listingcharacter">accept</samp> header with the value <samp class="listingcharacter listingcharacter">application/json</samp> defines that the client expects a JSON structure from the server. However, the HTTP header is relevant not only for the server but also for caches<a class="indexanchor" id="i05_46"/> located along the way. For example, you use the <samp class="listingcharacter listingcharacter">cache-control</samp> header to control caching behavior. In total, the W3C specifies more than 40 different header directives for HTTP. You can find further details on this topic at <span class="url"><a href="http://www.ietf.org/rfc/rfc2616.txt">www.ietf.org/rfc/rfc2616.txt</a></span>.</p>
                    </li>
                    <li>
                        <p class="standard first-item last-item"><span class="bold"><samp class="listingcharacter listingcharacter">trailers</samp></span><br/>Trailers serve as the counterpart to the header information <a class="indexanchor" id="i05_47"/>. You can access them in a similar way to the headers, namely, via the <samp class="listingcharacter listingcharacter">trailers</samp> property.</p>
                    </li>
                    <li>
                        <p class="standard first-item last-item"><span class="bold"><samp class="listingcharacter listingcharacter"><a id="p150"/>httpVersion</samp></span><br/>This property contains the HTTP version<a class="indexanchor" id="i05_48"/> that was used for the request. You can access the individual components of the version number via <samp class="listingcharacter listingcharacter">httpVersionMajor</samp> or <samp class="listingcharacter listingcharacter">httpVersionMinor</samp>.</p>
                    </li>
                    <li>
                        <p class="standard first-item last-item"><span class="bold"><samp class="listingcharacter listingcharacter">connection</samp></span><br/>Finally, this property provides access to a socket object that represents the connection between client and server.</p>
                    </li>
                </ul>
            
            
                <h4 class="t4" id="h5.1.3.4">Deleting Records</h4>
                <p class="standard">In the initial file of your application, you must now decide what to do based on the requested URL. If the client requests the URL <span class="italic">/</span>, you must display the address list; if the client calls <span class="italic">/delete/1</span>, the record with <samp class="listingcharacter listingcharacter">id 1</samp> gets deleted. First, you must implement a function that deletes an element from the <samp class="listingcharacter listingcharacter">addresses</samp> array. You should outsource this function to a separate module with the file name <span class="italic">delete.js</span>. The source code of this module is shown in <span class="crossreference "><a href="05_001.html#l5.12">Listing 5.12</a></span>.</p>
                <div class="listing " id="l5.12"><pre><span class="rot">export</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">deleteAddress(</span><span class="schwarz">addresses</span><span class="schwarz">,</span><span class="schwarz"> id</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="rot">const</span><span class="schwarz"> parsedId </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="schwarz">parseInt(</span><span class="schwarz">id</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">10);</span><span class="schwarz"><br/></span>  <span class="rot">const</span><span class="schwarz"> filteredAddresses </span><span class="dunkelblau">=</span><span class="schwarz"> addresses</span><span class="schwarz">.filter(</span><span class="schwarz"><br/></span>    <span class="schwarz">(</span><span class="schwarz">address</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> address</span><span class="schwarz">.</span><span class="schwarz">id </span><span class="dunkelblau">!==</span><span class="schwarz"> parsedId</span><span class="schwarz">,</span><span class="schwarz"><br/></span>  <span class="schwarz">);</span><span class="schwarz"><br/></span>  <span class="rot">return</span><span class="schwarz"> filteredAddresses</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"> </span></pre></div>
                <p class="caption "><b>Listing 5.12</b>    
            Deleting an Address (delete.js)</p>
                <p class="standard">When implementing the <samp class="listingcharacter listingcharacter">deleteAddress</samp> function, you must make sure that the information coming from the client—in this case, the <samp class="listingcharacter listingcharacter">id</samp>—is a string, not a number. For this reason, you must first explicitly convert it to a number before you can perform a strict check for equality with three equal signs. There are several ways to remove an element from an array in JavaScript, including filtering it out using the <samp class="listingcharacter listingcharacter">filter</samp> method shown here or using the <samp class="listingcharacter listingcharacter">splice</samp> method.</p>
                <div class="box box_standard">
                    <h6 class="boxheading">Equality<a class="indexanchor" id="i05_49"/> in JavaScript</h6>
                    <p class="standard first last">If you want to check in JavaScript whether two values match, you should always do so with three equal signs. Similarly, you should check for inequality with an exclamation point and two equal signs. This prevents the JavaScript engine from changing the type of the values. Such a strict comparison returns <samp class="listingcharacter listingcharacter">false</samp> if you compare string 1 with number 1. With two equal signs, this comparison would return <samp class="listingcharacter listingcharacter">true</samp>. If you always use the strict variant for comparisons, you can exclude this source of error. If the types don’t match, you should take typecasting into your own hands. This makes your source code easier to understand.</p>
                </div>
                <p class="standard"><a id="p151"/>In the request callback function in the initial file of your application, you decide which action to perform based on the URL. In case of a delete operation, you must execute the <samp class="listingcharacter listingcharacter">deleteAddress</samp> function and then forward the request back to the list using the <samp class="listingcharacter listingcharacter">request</samp> function. This ensures that the updated list is displayed to the user. <span class="crossreference "><a href="05_001.html#l5.13">Listing 5.13</a></span> shows the customized <span class="italic">index.js</span> file.</p>
                <div class="listing " id="l5.13"><pre><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> createServer </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'http'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> data </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./data.js'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> getList </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./list.js'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="bold"><samp class="listingcharacter listingcharacter"><span class="schwarz"> { deleteAddress }</span></samp></span> <span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./delete.js'</span><span class="bold"><samp class="listingcharacter listingcharacter"><span class="schwarz">;</span><br/> </samp></span><br/>createServer((request, response) <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>  <span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">let</span><span class="schwarz"> responseBody;</span><br/>  <span class="rot">const</span></samp></span><span class="schwarz"> parts</span><span class="bold"><samp class="listingcharacter listingcharacter"> <span class="dunkelblau">=</span><span class="schwarz"> request.url.</span></samp></span>split<span class="bold"><samp class="listingcharacter listingcharacter">(</samp></span><span class="hellblau">'/'</span><span class="bold"><samp class="listingcharacter listingcharacter"><span class="schwarz">);</span></samp></span><br/>  <span class="rot">if</span><span class="bold"><samp class="listingcharacter listingcharacter"><span class="schwarz"> (</span></samp></span>parts<span class="bold"><samp class="listingcharacter listingcharacter">.</samp></span>includes<span class="bold"><samp class="listingcharacter listingcharacter">(</samp></span><span class="hellblau">'delete'</span><span class="bold"><samp class="listingcharacter listingcharacter"><span class="schwarz">)) {</span><br/>    data.</samp></span>addresses<span class="bold"><samp class="listingcharacter listingcharacter"> <span class="dunkelblau">=</span></samp></span><span class="schwarz"> deleteAddress</span><span class="bold"><samp class="listingcharacter listingcharacter">(data.</samp></span>addresses<span class="bold"><samp class="listingcharacter listingcharacter">,</samp></span> parts<span class="bold"><samp class="listingcharacter listingcharacter">[</samp></span>2<span class="bold"><samp class="listingcharacter listingcharacter">]);</samp></span><br/>    redirect<span class="bold"><samp class="listingcharacter listingcharacter">(response,</samp></span> <span class="hellblau">'/'</span><span class="bold"><samp class="listingcharacter listingcharacter"><span class="schwarz">);</span><br/>  }</samp></span> <span class="rot">else</span><span class="bold"><samp class="listingcharacter listingcharacter"><span class="schwarz"> {</span></samp></span><br/>    response.writeHead(200, { <span class="hellblau">'content-type'</span><span class="schwarz">: </span><span class="hellblau">'text/html'</span><span class="schwarz"> });</span><br/>    responseBody <span class="dunkelblau">=</span><span class="schwarz"> getList(data.addresses);</span><br/>    response.end(responseBody);<br/> <span class="bold"><samp class="listingcharacter listingcharacter"> }</samp></span><br/>}).listen(8080, () <span class="dunkelblau">=&gt;</span><span class="schwarz"><br/></span>  <span class="magenta">console</span><span class="schwarz">.log(</span><span class="hellblau">'Address book reachable at http://localhost:8080'</span><span class="schwarz">),</span><br/>);<br/> <br/><span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">function</span><span class="schwarz"> redirect(response, to) {</span><br/>  response.writeHead(302, { location: <span class="hellblau">'/'</span><span class="schwarz">, </span><span class="hellblau">'content-type'</span><span class="schwarz">: </span><span class="hellblau">'text/plain'</span><span class="schwarz"> });</span><br/>  response.end(<span class="hellblau">'302 Redirecting to /'</span><span class="schwarz">);</span><br/>}</samp></span> <span class="schwarz"/></pre></div>
                <p class="caption "><b>Listing 5.13</b>    
            Adjustments to the Initial File (index.js)</p>
                <p class="standard">The user is redirected<a class="indexanchor" id="i05_50"/> in the <samp class="listingcharacter listingcharacter">redirect</samp> function, which sets the status code <samp class="listingcharacter listingcharacter">302</samp> and the <samp class="listingcharacter listingcharacter">location</samp> header to <samp class="listingcharacter listingcharacter">/</samp>. This information signals the browser to request this address, which results in an updated list display.</p>
                <div class="box box_standard">
                    <h6 class="boxheading">HTTP Status Codes<a class="indexanchor" id="i05_51"/></h6>
                    <p class="standard first">The status code signals the status of the request to the browser. The status codes <samp class="listingcharacter listingcharacter">200</samp> and <samp class="listingcharacter listingcharacter">302</samp> have already been introduced in two examples. The status codes can be divided into five groups, each of which has its own meaning:</p>
                    <ul>
                        <li>
                            <p class="standard first-item last-item">100–199: Information is provided by the request.</p>
                        </li>
                        <li>
                            <p class="standard first-item last-item">200–299: Feedback is provided on the success of the request.</p>
                        </li>
                        <li>
                            <p class="standard first-item last-item"><a id="p152"/>300–399: The client must take further actions (redirection).</p>
                        </li>
                        <li>
                            <p class="standard first-item last-item">400–499: A client-side error has occurred.</p>
                        </li>
                        <li>
                            <p class="standard first-item last-item">500–599: A server-side error has occurred.</p>
                        </li>
                    </ul>
                    <p class="standard last">Not only are the categories of status codes standardized, but the individual codes are also subject to strict rules. Node.js provides a way to resolve the individual status codes into strings with the <samp class="listingcharacter listingcharacter">http.STATUS_CODES</samp> object.</p>
                </div>
                <p class="standard">The easiest way to formulate a correct response header<a class="indexanchor" id="i05_52"/> is to use the <samp class="listingcharacter listingcharacter">writeHead</samp> method, which normally requires two arguments. The first argument consists of a number representing the status code, while the second consists of an object with header information. You can use this method only once; after that, you can’t make any modifications to the header. You must also call this method before using <samp class="listingcharacter listingcharacter">write</samp> or <samp class="listingcharacter listingcharacter">end</samp> to send the body of the message.</p>
                <p class="standard">You can also set the header information of the <samp class="listingcharacter listingcharacter">response</samp> object individually using the <samp class="listingcharacter listingcharacter">statusCode</samp> property and the <samp class="listingcharacter listingcharacter">setHeader</samp> method. To set the status code, you must assign a valid number to the property. To set the header information, you must pass the name of the field you want to set to the <samp class="listingcharacter listingcharacter">setHeader</samp> method as the first argument, and the corresponding value as the second argument. For example, you use <samp class="listingcharacter listingcharacter">location</samp> as the field name and <samp class="listingcharacter listingcharacter">/</samp> as the value. To modify a header information, you can read the value using the <samp class="listingcharacter listingcharacter">getHeader</samp> method and set it via <samp class="listingcharacter listingcharacter">setHeader</samp>. The <samp class="listingcharacter listingcharacter">removeHeader</samp> method enables you to remove individual fields from the header.</p>
            
        
        
            <h3 class="t3" id="h5.1.4">5.1.4    Handling the Request Body (Update)</h3>
            <p class="standard">The last two operations that are still to be done for your address book are creating and modifying data records. Both operations apply similar structures, so you can combine most of the steps.</p>
            
                <h4 class="t4" id="h5.1.4.1">Delivering the Form<a class="indexanchor" id="i05_53"/></h4>
                <p class="standard">First, you need an HTML form that you deliver to the client to create or modify the data records. The required structures can be found in <span class="crossreference "><a href="05_001.html#l5.14">Listing 5.14</a></span>.</p>
                <div class="listing " id="l5.14"><pre><span class="rot">export</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">getForm(</span><span class="schwarz">addresses</span><span class="schwarz">,</span><span class="schwarz"> id</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="rot">let</span><span class="schwarz"> address </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    id<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">''</span><span class="schwarz">,</span><span class="schwarz"><br/></span>    firstname<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">''</span><span class="schwarz">,</span><span class="schwarz"><br/></span>    lastname<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">''</span><span class="schwarz">,</span><span class="schwarz"><br/></span>    street<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">''</span><span class="schwarz">,</span><span class="schwarz"><br/></span>    city<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">''</span><span class="schwarz">,</span><span class="schwarz"><br/></span>    country<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">''</span><span class="schwarz">,</span><span class="schwarz"><br/></span>  <span class="schwarz">};</span><span class="schwarz"><br/></span>  <span class="rot">if</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">id</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span><a id="p153"/>    address <span class="dunkelblau">=</span><span class="schwarz"> addresses</span><span class="schwarz">.find((</span><span class="schwarz">adr</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> adr</span><span class="schwarz">.</span><span class="schwarz">id </span><span class="dunkelblau">===</span><span class="schwarz"> </span><span class="schwarz">parseInt(</span><span class="schwarz">id</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">10));</span><span class="schwarz"><br/></span>  <span class="schwarz">}</span><span class="schwarz"><br/></span>  <span class="rot">const</span><span class="schwarz"> form </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="violett">`&lt;!DOCTYPE html&gt;</span><br/>&lt;html&gt;<br/>  &lt;head&gt;<br/>    &lt;title&gt;Address book&lt;/title&gt;<br/>    &lt;meta charset=<span class="hellblau">"utf-8"</span><span class="violett">&gt;</span><br/>  &lt;/head&gt;<br/>  &lt;body&gt;<br/>    &lt;form action=<span class="hellblau">"/save"</span><span class="violett"> method=</span><span class="hellblau">"POST"</span><span class="violett">&gt;</span><br/>      &lt;input type=<span class="hellblau">"hidden"</span><span class="violett"> id=</span><span class="hellblau">"id"</span><span class="violett"> name=</span><span class="hellblau">"id"</span><span class="violett"> value=</span><span class="hellblau">"${address.id}"</span><span class="violett"> /&gt;</span><br/>      &lt;div&gt;<br/>        &lt;label for=<span class="hellblau">"firstname"</span><span class="violett">&gt;First Name&lt;/label&gt;</span><br/>        &lt;input type=<span class="hellblau">"text"</span><span class="violett"> id=</span><span class="hellblau">"firstname"</span><span class="violett"> name=</span><span class="hellblau">"firstname"</span><span class="violett"> </span><img alt="inline image" class="inline_image" src="bilder/umbruchpfeil.png"/><br/>          value=<span class="hellblau">"${address.firstname}"</span><span class="violett"> /&gt;</span><br/>      &lt;/div&gt;<br/>      &lt;div&gt;<br/>        &lt;label for=<span class="hellblau">"lastname"</span><span class="violett">&gt;Last Name&lt;/label&gt;</span><br/>        &lt;input type=<span class="hellblau">"text"</span><span class="violett"> id=</span><span class="hellblau">"lastname"</span><span class="violett"> name=</span><span class="hellblau">"lastname"</span><span class="violett"> </span><img alt="inline image" class="inline_image" src="bilder/umbruchpfeil.png"/><br/>          value=<span class="hellblau">"${address.lastname}"</span><span class="violett"> /&gt;</span><br/>      &lt;/div&gt;<br/>      &lt;div&gt;<br/>        &lt;label for=<span class="hellblau">"street"</span><span class="violett">&gt;Street&lt;/label&gt;</span><br/>        &lt;input type=<span class="hellblau">"text"</span><span class="violett"> id=</span><span class="hellblau">"street"</span><span class="violett"> name=</span><span class="hellblau">"street"</span><span class="violett"> value=</span><span class="hellblau">"${address.street}"</span><span class="violett"> /&gt;</span><br/>      &lt;/div&gt;<br/>      &lt;div&gt;<br/>        &lt;label for=<span class="hellblau">"city"</span><span class="violett">&gt;City&lt;/label&gt;</span><br/>        &lt;input type=<span class="hellblau">"text"</span><span class="violett"> id=</span><span class="hellblau">"city"</span><span class="violett"> name=</span><span class="hellblau">"city"</span><span class="violett"> value=</span><span class="hellblau">"${address.city}"</span><span class="violett"> /&gt;</span><br/>      &lt;/div&gt;<br/>      &lt;div&gt;<br/>        &lt;label for=<span class="hellblau">"country"</span><span class="violett">&gt;Country&lt;/label&gt;</span><br/>        &lt;input type=<span class="hellblau">"text"</span><span class="violett"> id=</span><span class="hellblau">"country"</span><span class="violett"> name=</span><span class="hellblau">"country"</span><span class="violett"> value=</span><span class="hellblau">"${address.country}"</span><span class="violett"> /&gt;</span><br/>      &lt;/div&gt;<br/>      &lt;div&gt;<br/>        &lt;button type=<span class="hellblau">"submit"</span><span class="violett">&gt;save&lt;/button&gt;</span><br/>      &lt;/div&gt;<br/>    &lt;/form&gt;<br/>  &lt;/body&gt;<br/>&lt;/html&gt;`<span class="schwarz">;</span><span class="schwarz"><br/></span>  <span class="rot">return</span><span class="schwarz"> form</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"> </span></pre></div>
                <p class="caption "><b>Listing 5.14</b>    
            Form for Creating and Editing Addresses (form.js)</p>
                <p class="standard"><a id="p154"/>If you want to edit an existing data record, you must pass the array of addresses and the ID to be edited. Otherwise, you don’t have to transfer anything. The form itself is in a template string<a class="indexanchor" id="i05_54"/>, which ensures that the values are correctly inserted into the form elements. Finally, you can return the completed form.</p>
            
            
                <h4 class="t4" id="h5.1.4.2">Customizing the Router<a class="indexanchor" id="i05_55"/></h4>
                <p class="standard">The next step is to include your form in the <span class="italic">index.js</span> file of your application. The source code of this file is shown in <span class="crossreference "><a href="05_001.html#l5.15">Listing 5.15</a></span>.</p>
                <div class="listing " id="l5.15"><pre><span class="rot">const</span><span class="schwarz"> http </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="schwarz">require(</span><span class="hellblau">'http'</span><span class="schwarz">);</span><span class="schwarz"><br/></span><span class="rot">let</span><span class="schwarz"> addresses </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="schwarz">require(</span><span class="hellblau">'./data'</span><span class="schwarz">);</span><span class="schwarz"><br/></span><span class="rot">const</span><span class="schwarz"> getList </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="schwarz">require(</span><span class="hellblau">'./list'</span><span class="schwarz">);</span><span class="schwarz"><br/></span><span class="rot">const</span><span class="schwarz"> deleteAddress </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="schwarz">require(</span><span class="hellblau">'./delete'</span><span class="schwarz">);</span><span class="schwarz"><br/></span><span class="rot">const</span><span class="schwarz"> getForm </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="schwarz">require(</span><span class="hellblau">'./form'</span><span class="schwarz">);</span><span class="schwarz"><br/></span><br/>http<br/>  <span class="schwarz">.createServer((</span><span class="schwarz">request</span><span class="schwarz">,</span><span class="schwarz"> response</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="rot">const</span><span class="schwarz"> parts </span><span class="dunkelblau">=</span><span class="schwarz"> request</span><span class="schwarz">.</span><span class="schwarz">url</span><span class="schwarz">.split(</span><span class="hellblau">'/'</span><span class="schwarz">);</span><span class="schwarz"><br/></span>    <span class="rot">if</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">parts</span><span class="schwarz">.includes(</span><span class="hellblau">'delete'</span><span class="schwarz">))</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>      addresses <span class="dunkelblau">=</span><span class="schwarz"> </span><span class="schwarz">deleteAddress(</span><span class="schwarz">addresses</span><span class="schwarz">,</span><span class="schwarz"> parts</span><span class="schwarz">[2]);</span><span class="schwarz"><br/></span>      <span class="schwarz">redirect(</span><span class="schwarz">response</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="hellblau">'/'</span><span class="schwarz">);</span><span class="schwarz"><br/></span>    <span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">else</span><span class="schwarz"> </span><span class="rot">if</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">parts</span><span class="schwarz">.includes(</span><span class="hellblau">'new'</span><span class="schwarz">))</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>      <span class="schwarz">send(</span><span class="schwarz">response</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">getForm());</span><span class="schwarz"><br/></span>    <span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">else</span><span class="schwarz"> </span><span class="rot">if</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">parts</span><span class="schwarz">.includes(</span><span class="hellblau">'edit'</span><span class="schwarz">))</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>      <span class="schwarz">send(</span><span class="schwarz">response</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">getForm(</span><span class="schwarz">addresses</span><span class="schwarz">,</span><span class="schwarz"> parts</span><span class="schwarz">[2]));</span><span class="schwarz"><br/></span>    <span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">else</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>      <span class="schwarz">send(</span><span class="schwarz">response</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">getList(</span><span class="schwarz">addresses</span><span class="schwarz">));</span><span class="schwarz"><br/></span>    <span class="schwarz">}</span><span class="schwarz"><br/></span>  <span class="schwarz">})</span><span class="schwarz"><br/></span>  <span class="schwarz">.listen(8080,</span><span class="schwarz"> </span><span class="schwarz">()</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"><br/></span>    <span class="magenta">console</span><span class="schwarz">.log(</span><span class="hellblau">'Address book reachable at http://localhost:8080'</span><span class="schwarz">),</span><span class="schwarz"><br/></span>  <span class="schwarz">);</span><span class="schwarz"><br/></span><br/><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">send(</span><span class="schwarz">response</span><span class="schwarz">,</span><span class="schwarz"> responseBody</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  response<span class="schwarz">.writeHead(200,</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> </span><span class="hellblau">'content-type'</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'text/html'</span><span class="schwarz"> </span><span class="schwarz">});</span><span class="schwarz"><br/></span>  response<span class="schwarz">.end(</span><span class="schwarz">responseBody</span><span class="schwarz">);</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"><br/></span><br/><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">redirect(</span><span class="schwarz">response</span><span class="schwarz">,</span><span class="schwarz"> to</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  response<span class="schwarz">.writeHead(302,</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> location</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'/'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="hellblau">'content-type'</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'text/plain'</span><span class="schwarz"> </span><span class="schwarz">});</span><span class="schwarz"><br/></span>  response<span class="schwarz">.end(</span><span class="hellblau">'302 Redirecting to /'</span><span class="schwarz">);</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"> </span></pre></div>
                <p class="caption "><b>Listing 5.15</b>    
            Getting Started with the Application (index.js)</p>
                <p class="standard"><a id="p155"/>To avoid duplicates in the code, the actual task of sending the response to the client was swapped out to the <samp class="listingcharacter listingcharacter">send</samp> function. Restart the server process, and then call the address <span class="italic">http://localhost:8080/new</span>; you’ll see the form for creating new data records.</p>
                <div class="imagebox figure-type"><a href="img-f5.5.html" id="f5.5"><img alt="Form for New Data Records" id="img-f5.5" src="bilderklein/klein05_005.png"/></a></div>
                <p class="caption "><b>Figure 5.5</b>    
            Form for New Data Records</p>
            
            
                <h4 class="t4" id="h5.1.4.3">Responding to the Form Submission<a class="indexanchor" id="i05_56"/></h4>
                <p class="standard">The actual logic can be found in the callback function of the <samp class="listingcharacter listingcharacter">createServer</samp> method. The task of this function is to decide which function to call to create the response; thus, it performs the task of a very simple router in the application. The form is sent to <samp class="listingcharacter listingcharacter">/save</samp> using the POST method<a class="indexanchor" id="i05_57"/>. Currently, the server still responds to the call of this address by delivering the list. However, you can change that by extending your routing functionality. In this case, you can extend the decision for an action to the HTTP method used. <span class="crossreference "><a href="05_001.html#l5.16">Listing 5.16</a></span> contains the customized source code of the <samp class="listingcharacter listingcharacter">createServer</samp> callback function.</p>
                <div class="listing " id="l5.16"><pre><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">import</span><span class="schwarz"> { parse } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'querystring'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> { saveAddress } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./save.js'</span><span class="schwarz">;</span></samp></span><br/>...<br/>createServer((request, response) <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>  <span class="rot">const</span><span class="schwarz"> parts </span><span class="dunkelblau">=</span><span class="schwarz"> request.url.split(</span><span class="hellblau">'/'</span><span class="schwarz">);</span><br/>  <span class="rot">if</span><span class="schwarz"> (parts.includes(</span><span class="hellblau">'delete'</span><span class="schwarz">)) {</span><br/>    data.addresses <span class="dunkelblau">=</span><span class="schwarz"> deleteAddress(data.addresses, parts[2]);</span><br/>    redirect(response, <span class="hellblau">'/'</span><span class="schwarz">);</span><br/>  } <span class="rot">else</span><span class="schwarz"> </span><span class="rot">if</span><span class="schwarz"> (parts.includes(</span><span class="hellblau">'new'</span><span class="schwarz">)) {</span><br/>    send(response, getForm());<br/>  } <span class="rot">else</span><span class="schwarz"> </span><span class="rot">if</span><span class="schwarz"> (parts.includes(</span><span class="hellblau">'edit'</span><span class="schwarz">)) {</span><br/>    send(response, getForm(data.addresses, parts[2]));<br/>  <span class="bold"><samp class="listingcharacter listingcharacter">} <span class="rot">else</span><span class="schwarz"> </span><span class="rot">if</span><span class="schwarz"> (parts.includes(</span><span class="hellblau">'save'</span><span class="schwarz">) </span><span class="dunkelblau">&amp;&amp;</span><span class="schwarz"> request.method </span><span class="dunkelblau">===</span><span class="schwarz"> </span><span class="hellblau">'POST'</span><span class="schwarz">) {</span><br/>    <span class="rot">let</span><span class="schwarz"> body </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="hellblau">''</span><span class="schwarz">;</span><br/>    request.on(<span class="hellblau">'readable'</span><span class="schwarz">, () </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>      <span class="rot">const</span><span class="schwarz"> data </span><span class="dunkelblau">=</span><span class="schwarz"> request.read();</span><br/>      body <span class="dunkelblau">+=</span><span class="schwarz"> data </span><span class="dunkelblau">!==</span><span class="schwarz"> </span><span class="rot">null</span><span class="schwarz"> </span><span class="dunkelblau">?</span><span class="schwarz"> data : </span><span class="hellblau">''</span><span class="schwarz">;</span><br/>    });<br/><a id="p156"/>    request.on(<span class="hellblau">'end'</span><span class="schwarz">, () </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>      <span class="rot">const</span><span class="schwarz"> address </span><span class="dunkelblau">=</span><span class="schwarz"> parse(body);</span><br/>      addresses <span class="dunkelblau">=</span><span class="schwarz"> saveAddress(data.addresses, address);</span><br/>      redirect(response, <span class="hellblau">'/'</span><span class="schwarz">);</span><br/>    });</samp></span><br/>  } <span class="rot">else</span><span class="schwarz"> {</span><br/>    send(response, getList(data.addresses));<br/>  }<br/>}).listen(8080, () <span class="dunkelblau">=&gt;</span><span class="schwarz"><br/></span>  <span class="magenta">console</span><span class="schwarz">.log(</span><span class="hellblau">'Address book reachable at http://localhost:8080'</span><span class="schwarz">),</span><br/>);<br/>... <span class="schwarz"/></pre></div>
                <p class="caption "><b>Listing 5.16</b>    
            Saving Addresses (index.js)</p>
                <p class="standard">In contrast to the header information of the request, the body isn’t available as a property, but must be received via a data stream<a class="indexanchor" id="i05_58"/>. The request can be transmitted in one or more parts, called chunks<a class="indexanchor" id="i05_59"/>. As soon as a part of the request is available, the <samp class="listingcharacter listingcharacter">readable</samp> event gets triggered. In the handler function, you can retrieve the data using the <samp class="listingcharacter listingcharacter">read</samp> method and merge it into a variable. Once the request is completely accepted, the <samp class="listingcharacter listingcharacter">end</samp> event gets triggered. At this point, you can use the <samp class="listingcharacter listingcharacter">querystring</samp> module of Node.js to process the URL. The <samp class="listingcharacter listingcharacter">parse</samp> method ensures that the address formatted as <samp class="listingcharacter listingcharacter">querystring</samp> is converted into an object.</p>
            
            
                <h4 class="t4" id="h5.1.4.4">Saving the Information</h4>
                <p class="standard">For the change in <span class="crossreference "><a href="05_001.html#l5.16">Listing 5.16</a></span> to work properly, you must implement and load the <samp class="listingcharacter listingcharacter">saveAddress</samp> function. If you save the function in a file named <span class="italic">save.js</span>, the import is done via <samp class="listingcharacter listingcharacter">import { saveAddress } from './save.js';</samp> in the <span class="italic">index.js</span> file. <span class="crossreference "><a href="05_001.html#l5.17">Listing 5.17</a></span> shows the implementation of the function.</p>
                <div class="listing " id="l5.17"><pre><span class="rot">export</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">saveAddress(</span><span class="schwarz">addresses</span><span class="schwarz">,</span><span class="schwarz"> address</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="rot">if</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">address</span><span class="schwarz">.</span><span class="schwarz">id</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="rot">const</span><span class="schwarz"> index </span><span class="dunkelblau">=</span><span class="schwarz"> addresses</span><span class="schwarz">.findIndex((</span><span class="schwarz">adr</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>      <span class="rot">return</span><span class="schwarz"> adr</span><span class="schwarz">.</span><span class="schwarz">id </span><span class="dunkelblau">===</span><span class="schwarz"> </span><span class="schwarz">parseInt(</span><span class="schwarz">address</span><span class="schwarz">.</span><span class="schwarz">id</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">10);</span><span class="schwarz"><br/></span>    <span class="schwarz">});</span><span class="schwarz"><br/></span>    address<span class="schwarz">.</span><span class="schwarz">id </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="schwarz">parseInt(</span><span class="schwarz">address</span><span class="schwarz">.</span><span class="schwarz">id</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">10);</span><span class="schwarz"><br/></span>    addresses<span class="schwarz">[</span><span class="schwarz">index</span><span class="schwarz">]</span><span class="schwarz"> </span><span class="dunkelblau">=</span><span class="schwarz"> address</span><span class="schwarz">;</span><span class="schwarz"><br/></span>  <span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">else</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="rot">const</span><span class="schwarz"> nextId </span><span class="dunkelblau">=</span><span class="schwarz"> Math</span><span class="schwarz">.max(...</span><span class="schwarz">addresses</span><span class="schwarz">.map((</span><span class="schwarz">address</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> address</span><span class="schwarz">.</span><span class="schwarz">id</span><span class="schwarz">))</span><span class="schwarz"> </span><span class="dunkelblau">+</span><span class="schwarz"> </span><span class="schwarz">1;</span><span class="schwarz"><br/></span>    address<span class="schwarz">.</span><span class="schwarz">id </span><span class="dunkelblau">=</span><span class="schwarz"> nextId</span><span class="schwarz">;</span><span class="schwarz"><br/></span>    addresses<span class="schwarz">.push(</span><span class="schwarz">address</span><span class="schwarz">);</span><span class="schwarz"><br/></span><a id="p157"/>  <span class="schwarz">}</span><span class="schwarz"><br/></span>  <span class="rot">return</span><span class="schwarz"> addresses</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"> </span></pre></div>
                <p class="caption "><b>Listing 5.17</b>    
            Implementing the “saveAddress” Function (save.js)</p>
                <p class="standard">In the <samp class="listingcharacter listingcharacter">saveAddress</samp> function, you distinguish between creating and updating data records depending on whether the passed data record has an <samp class="listingcharacter listingcharacter">id</samp> field. For a new data record, you must identify the next free <samp class="listingcharacter listingcharacter">id</samp> before inserting it. To do this, you should use the <samp class="listingcharacter listingcharacter">map</samp> method to extract the <samp class="listingcharacter listingcharacter">id</samp> properties of the address records, apply the result to the <samp class="listingcharacter listingcharacter">Math.max method</samp> using the spread operator, and add the value <samp class="listingcharacter listingcharacter">1</samp> to the result.</p>
            
        
        
            <h3 class="t3" id="h5.1.5">5.1.5    Delivering Static Content<a class="indexanchor" id="i05_60"/></h3>
            <p class="standard">So far, you’ve only delivered dynamic content with your web server. For purely static content such as HTML<a class="indexanchor" id="i05_61"/>, CSS<a class="indexanchor" id="i05_62"/>, or image files<a class="indexanchor" id="i05_63"/>, it makes little sense to store them in a JavaScript template string. For this purpose, you can either use existing packages such as <samp class="listingcharacter listingcharacter">node-static</samp> or write the implementation yourself. For example, to style the address list with CSS<a class="indexanchor" id="i05_64"/>, you must first create a stylesheet<a class="indexanchor" id="i05_65"/>. <span class="crossreference "><a href="05_001.html#l5.18">Listing 5.18</a></span> contains its source code, which you must save in the <span class="italic">public</span> subdirectory in the <span class="italic">style.css</span> file of your application.</p>
            <div class="listing " id="l5.18"><pre><span class="gruen">table</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="magenta">border-spacing</span><span class="schwarz">:</span><span class="dunkelblau"> 0</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"><br/></span><br/>td <span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="magenta">width</span><span class="schwarz">:</span><span class="dunkelblau"> 80px</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"><br/></span><br/><span class="magenta">tr</span><span class="schwarz">:</span><span class="dunkelblau">first-child th </span><span class="schwarz">{</span><span class="dunkelblau"><br/></span>  <span class="magenta">font-weight</span><span class="schwarz">:</span><span class="dunkelblau"> bold</span><span class="schwarz">;</span><span class="schwarz"><br/></span>  <span class="magenta">text-align</span><span class="schwarz">:</span><span class="dunkelblau"> left</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"><br/></span><br/><span class="magenta">tr</span><span class="schwarz">:</span><span class="dunkelblau">nth-child</span><span class="schwarz">(</span><span class="dunkelblau">2n</span><span class="schwarz">)</span><span class="dunkelblau"> td </span><span class="schwarz">{</span><span class="dunkelblau"><br/></span>  <span class="magenta">background-color</span><span class="schwarz">:</span><span class="dunkelblau"> lightgrey</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"> </span></pre></div>
            <p class="caption "><b>Listing 5.18</b>    
            Stylesheet (public/style.css)</p>
            <p class="standard">In the subsequent step, you must add the following line in the <samp class="listingcharacter listingcharacter">head</samp> section in the list template<a class="indexanchor" id="i05_66"/> of the <span class="italic">list.js</span> file: <samp class="listingcharacter listingcharacter">&lt;link rel="stylesheet" href=" style.css" /&gt;</samp>. After that, you just need to make sure that the server delivers the stylesheet correctly. <span class="crossreference "><a href="05_001.html#l5.19">Listing 5.19</a></span> shows the adjustments to the <samp class="listingcharacter listingcharacter">createServer</samp> callback function.</p>
            <div class="listing " id="l5.19"><pre><span class="schwarz"><a id="p158"/>...</span><span class="schwarz"><br/></span><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">import</span><span class="schwarz"> { readFile } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'fs'</span><span class="schwarz">;</span><br/> </samp></span><br/>createServer((request, response) <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>  <span class="rot">const</span><span class="schwarz"> parts </span><span class="dunkelblau">=</span><span class="schwarz"> request.url.split(</span><span class="hellblau">'/'</span><span class="schwarz">);</span><br/>  <span class="rot">if</span><span class="schwarz"> (parts.includes(</span><span class="hellblau">'delete'</span><span class="schwarz">)) {</span><br/>    data.addresses <span class="dunkelblau">=</span><span class="schwarz"> deleteAddress(data.addresses, parts[2]);</span><br/>    redirect(response, <span class="hellblau">'/'</span><span class="schwarz">);</span><br/>  } <span class="rot">else</span><span class="schwarz"> </span><span class="rot">if</span><span class="schwarz"> (parts.includes(</span><span class="hellblau">'new'</span><span class="schwarz">)) {</span><br/>    send(response, getForm());<br/>  } <span class="rot">else</span><span class="schwarz"> </span><span class="rot">if</span><span class="schwarz"> (parts.includes(</span><span class="hellblau">'edit'</span><span class="schwarz">)) {</span><br/>    send(response, getForm(data.addresses, parts[2]));<br/>  } <span class="rot">else</span><span class="schwarz"> </span><span class="rot">if</span><span class="schwarz"> (parts.includes(</span><span class="hellblau">'save'</span><span class="schwarz">) </span><span class="dunkelblau">&amp;&amp;</span><span class="schwarz"> request.method </span><span class="dunkelblau">===</span><span class="schwarz"> </span><span class="hellblau">'POST'</span><span class="schwarz">) {</span><br/>    <span class="rot">let</span><span class="schwarz"> body </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="hellblau">''</span><span class="schwarz">;</span><br/>    request.on(<span class="hellblau">'readable'</span><span class="schwarz">, () </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>      <span class="rot">const</span><span class="schwarz"> data </span><span class="dunkelblau">=</span><span class="schwarz"> request.read();</span><br/>      body <span class="dunkelblau">+=</span><span class="schwarz"> data </span><span class="dunkelblau">!==</span><span class="schwarz"> </span><span class="rot">null</span><span class="schwarz"> </span><span class="dunkelblau">?</span><span class="schwarz"> data : </span><span class="hellblau">''</span><span class="schwarz">;</span><br/>    });<br/>    request.on(<span class="hellblau">'end'</span><span class="schwarz">, () </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>      <span class="rot">const</span><span class="schwarz"> address </span><span class="dunkelblau">=</span><span class="schwarz"> parse(body);</span><br/>      data.addresses <span class="dunkelblau">=</span><span class="schwarz"> saveAddress(data.addresses, address);</span><br/>      redirect(response, <span class="hellblau">'/'</span><span class="schwarz">);</span><br/>    });<br/>  <span class="bold"><samp class="listingcharacter listingcharacter">} <span class="rot">else</span><span class="schwarz"> </span><span class="rot">if</span><span class="schwarz"> (request.url </span><span class="dunkelblau">===</span><span class="schwarz"> </span><span class="hellblau">'/style.css'</span><span class="schwarz">) {</span><br/>    readFile(<span class="hellblau">'public/style.css'</span><span class="schwarz">, </span><span class="hellblau">'utf8'</span><span class="schwarz">, (err, data) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>      <span class="rot">if</span><span class="schwarz"> (err) {</span><br/>        response.statusCode <span class="dunkelblau">=</span><span class="schwarz"> 404;</span><br/>        response.end();<br/>      } <span class="rot">else</span><span class="schwarz"> {</span><br/>        response.end(data);<br/>      }<br/>    });</samp></span><br/>  } <span class="rot">else</span><span class="schwarz"> {</span><br/>    send(response, getList(data.addresses));<br/>  }<br/>}).listen(8080, () <span class="dunkelblau">=&gt;</span><span class="schwarz"><br/></span>  <span class="magenta">console</span><span class="schwarz">.log(</span><span class="hellblau">'Address book reachable at http://localhost:8080'</span><span class="schwarz">),</span><br/>);<br/>... <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 5.19</b>    
            Adjustments to the “createServer” Callback Function (index.js)</p>
            <p class="standard">The last <samp class="listingcharacter listingcharacter">else if</samp> statement is particularly interesting here. Here, you use the <samp class="listingcharacter listingcharacter">readFile</samp> function from the <samp class="listingcharacter listingcharacter">fs</samp> module to read the requested file from the file system and send it to the client. Unlike in the previous implementations, you send the response to the client asynchronously in this case. This means that your web server will wait until the <a id="p159"/>contents of the file are available before sending the response. After restarting the server, you’ll see a slightly nicer form of the address list at <span class="italic">http://localhost:8080/</span>.</p>
            <div class="imagebox figure-type"><a href="img-f5.6.html" id="f5.6"><img alt="Address List with Stylesheet" id="img-f5.6" src="bilderklein/klein05_006.png"/></a></div>
            <p class="caption "><b>Figure 5.6</b>    
            Address List with Stylesheet</p>
            <p class="standard">When delivering static files, you should always make sure to strictly limit the files a client can request to avoid security problems on your server. The more dynamics you insert at this point, the greater the risk to your system. You should make sure that one directory is shared with your clients at most and that requests from there can’t break out by jumping up the directory tree. In the example, you work around the problem by delivering only that one file when you request the <span class="italic">style.css</span> file. However, such a single implementation works only for very few static files. In the next chapter, you’ll learn even more about static file delivery when we take a look at the Express framework.</p>
        
        
            <h3 class="t3" id="h5.1.6">5.1.6    File Upload<a class="indexanchor" id="i05_67"/></h3>
            <p class="standard">Your application is now capable of delivering dynamic and static information as well as handling form input. So far, all features could be implemented with integrated Node.js tools. Next, you should implement a way to upload files. You can implement this yourself and should make use of an already existing functionality. An example of this is the <samp class="listingcharacter listingcharacter">formidable</samp><a class="indexanchor" id="i05_68"/> package. If you haven’t yet created a <span class="italic">package.json</span> file for your application, now would be a good time to do so, namely, before you install the package. You can create a standard <span class="italic">package.json</span> file using the <samp class="listingcharacter listingcharacter">npm init -y</samp> command. After this step, you must use the <samp class="listingcharacter listingcharacter">npm install formidable</samp> command to install the package. Then the source code of <samp class="listingcharacter listingcharacter">formidable</samp> will be downloaded and unpacked into a directory named <span class="italic">node_modules</span>. In addition, the package is entered as a dependency in the <span class="italic">package.json</span> file in the <samp class="listingcharacter listingcharacter">dependencies</samp> section, and a <span class="italic">package-lock.json</span><a class="indexanchor" id="i05_69"/> is created, which contains detailed information about the dependencies of your application. For more information, refer to <span class="crossreference "><a href="21_001.html#h21">Chapter 21</a></span>.</p>
            <p class="standard">To support file uploads, you need to make adjustments in a few places. The first adjustment concerns the form. Here, you must insert a new <samp class="listingcharacter listingcharacter">input</samp> element of the <samp class="listingcharacter listingcharacter">file</samp> type. Furthermore, the form additionally receives the attribute<a class="indexanchor" id="i05_70"/><samp class="listingcharacter listingcharacter"> enctype="multipart/form-data"</samp>. <span class="crossreference "><a href="05_001.html#l5.20">Listing 5.20</a></span> shows the sections of the form that are affected by the changes.</p>
            <div class="listing " id="l5.20"><pre><span class="rot"><a id="p160"/>const</span><span class="schwarz"> form </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="violett">`&lt;!DOCTYPE html&gt;</span><br/>...<br/>  &lt;form action=<span class="hellblau">"/save"</span><span class="violett"> method=</span><span class="hellblau">"POST"</span><span class="violett"> </span><span class="bold">enctype=<span class="hellblau">"multipart/form-data"</span></span><span class="violett">&gt;</span><br/>...<br/>    <span class="bold">&lt;div&gt;<br/>      &lt;label for=<span class="hellblau">"upload"</span><span class="violett">&gt;file&lt;/label&gt;</span><br/>      &lt;input type=<span class="hellblau">"file"</span><span class="violett"> id=</span><span class="hellblau">"upload"</span><span class="violett"> name=</span><span class="hellblau">"upload"</span><span class="violett"> /&gt;</span><br/>    &lt;/div&gt;</span><br/>    &lt;div&gt;<br/>      &lt;button type=<span class="hellblau">"submit"</span><span class="violett">&gt;save&lt;/button&gt;</span><br/>    &lt;/div&gt;<br/>...<br/>&lt;/html&gt;`<span class="schwarz">; </span><span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 5.20</b>    
            Upload Element in the Form (<span class="italic">form.js</span>)</p>
            <p class="standard">After adjusting the source code, the <span class="screenelement">Choose file</span> button will display in the form view after a server restart.</p>
            <div class="imagebox figure-type"><a href="img-f5.7.html" id="f5.7"><img alt="Upload Button in the Form" id="img-f5.7" src="bilderklein/klein05_007.png"/></a></div>
            <p class="caption "><b>Figure 5.7</b>    
            Upload Button in the Form</p>
            <p class="standard">The biggest change concerns the <span class="italic">index.js</span> file. In it, you must adjust the area responsible for saving the data. Moreover, you must ensure that the uploaded files are delivered statically.</p>
            <div class="listing " id="l5.21"><pre><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">import</span><span class="schwarz"> formidable </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'formidable'</span><span class="schwarz">;</span></samp></span><br/>...<br/><br/>  <span class="bold"><samp class="listingcharacter listingcharacter">} <span class="rot">else</span><span class="schwarz"> </span><span class="rot">if</span><span class="schwarz"> (parts.includes(</span><span class="hellblau">'save'</span><span class="schwarz">) </span><span class="dunkelblau">&amp;&amp;</span><span class="schwarz"> request.method </span><span class="dunkelblau">===</span><span class="schwarz"> </span><span class="hellblau">'POST'</span><span class="schwarz">) {</span><br/>    <span class="rot">const</span><span class="schwarz"> form </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">new formidable</span><span class="schwarz">.IncomingForm();</span><br/>    form.parse(request, (err, address, files) <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>      <span class="rot">if</span><span class="schwarz"> (files.upload) {</span><br/>        rename(files.upload.path, <span class="violett">`public/assets/${files.upload.name}`</span><span class="schwarz">, () </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>          address[<span class="hellblau">'file'</span><span class="schwarz">] </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="violett">`/assets/${files.upload.name}`</span><span class="schwarz">;</span><br/><a id="p161"/>        });<br/>      }<br/>      data.addresses <span class="dunkelblau">=</span><span class="schwarz"> saveAddress(data.addresses, address);</span><br/>      redirect(response, <span class="hellblau">'/'</span><span class="schwarz">);</span><br/>    });<br/>  } <span class="rot">else</span><span class="schwarz"> </span><span class="rot">if</span><span class="schwarz"> (parts.includes(</span><span class="hellblau">'assets'</span><span class="schwarz">)) {</span><br/>    readFile(<span class="violett">`public${request.url.replaceAll(</span><span class="hellblau">'%20'</span><span class="violett">, </span><span class="hellblau">' '</span><span class="violett">)}`</span><span class="schwarz">, (err, data) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>      <span class="rot">if</span><span class="schwarz"> (err) {</span><br/>        response.statusCode <span class="dunkelblau">=</span><span class="schwarz"> 404;</span><br/>        response.end();<br/>      } <span class="rot">else</span><span class="schwarz"> {</span><br/>        response.end(data);<br/>      }<br/>    });</samp></span><br/>  } <span class="rot">else</span><span class="schwarz"> {</span><br/>    send(response, getList(data.addresses));<br/>  }<br/>}).listen(8080, () <span class="dunkelblau">=&gt;</span><span class="schwarz"><br/></span>  <span class="magenta">console</span><span class="schwarz">.log(</span><span class="hellblau">'Address book reachable at http://localhost:8080'</span><span class="schwarz">),</span><br/>);<br/>... <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 5.21</b>    
            Adjusting the index.js File</p>
            <div class="box box_standard">
                <h6 class="boxheading">Best Practice in Handling node_modules<a class="indexanchor" id="i05_71"/></h6>
                <p class="standard first last">When you install dependencies in a Node.js application, they and all their subdependencies are stored in the local <span class="italic">node_modules</span> directory. This directory is usually not included in the version control system; instead, the complete <span class="italic">node_modules</span> directory is ignored<a class="indexanchor" id="i05_72"/>. When you download the code of a Node.js application for the first time, no dependencies are installed, and the application isn’t functional. For this reason, you need to install the dependencies in the first step. You can do so via the <samp class="listingcharacter listingcharacter">npm install</samp> command in the root directory of your application, where the <span class="italic">package.json</span> file is usually located. The <span class="italic">package-lock.json</span> file must be included in the version control system that specifies which packages are installed in which version.</p>
            </div>
            <p class="standard">Using <samp class="listingcharacter listingcharacter">formidable</samp> simplifies the handling of the form. The <samp class="listingcharacter listingcharacter">parse</samp> function extracts both the form data<a class="indexanchor" id="i05_73"/> and the submitted files from the request. Finally, you must use the <samp class="listingcharacter listingcharacter">rename</samp> method from the <samp class="listingcharacter listingcharacter">fs</samp> module to make sure that the file gets moved to its destination. Besides handling the files, you also need to make sure that they are delivered. The corresponding section is similar to the one that delivers the stylesheets, except for the fact that binary data<a class="indexanchor" id="i05_74"/> and not text data is delivered here. To support spaces in the file names of the requested files, you should use the <samp class="listingcharacter listingcharacter">replaceAll</samp> method and replace the string <samp class="listingcharacter listingcharacter">%20</samp>, which represents a space character with a real space character when reading <a id="p162"/>the file. For the code example to work smoothly, you should create a subdirectory named <span class="italic">assets</span> in the <span class="italic">public</span> directory. In the final step, you only need to display the image files<a class="indexanchor" id="i05_75"/> in the list. For this purpose, you must insert a new column in the table and display an <samp class="listingcharacter listingcharacter">img</samp> element with the file as its source. For data records without an image, no image will be displayed.</p>
            <div class="listing " id="l5.22"><pre><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">getList(</span><span class="schwarz">addresses</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="rot">return</span><span class="schwarz"> </span><span class="violett">`&lt;!DOCTYPE html&gt;</span><br/>... <br/>      <span class="bold">&lt;th&gt;Image&lt;/th&gt;</span><br/>      &lt;th&gt;Id&lt;/th&gt;<br/>      &lt;th&gt;First Name&lt;/th&gt;<br/>      &lt;th&gt;Last Name&lt;/th&gt;<br/>      &lt;th&gt;delete&lt;/th&gt;<br/>      &lt;th&gt;edit&lt;/th&gt;<br/>...`<span class="schwarz"><br/></span><span class="rot">function</span><span class="schwarz"> createRow(address) {</span><br/>  <span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">const</span><span class="schwarz"> img </span><span class="dunkelblau">=</span><span class="schwarz"> address.file</span><br/>    <span class="dunkelblau">?</span><span class="schwarz"> </span><span class="violett">`&lt;img src=</span><span class="hellblau">"${address.file}"</span><span class="violett"> height=</span><span class="hellblau">"20"</span><span class="violett"> width=</span><span class="hellblau">"20"</span><span class="violett">&gt;`</span><span class="schwarz"><br/></span>    : <span class="hellblau">''</span><span class="schwarz">;</span><br/></samp></span><br/>  <span class="rot">return</span><span class="schwarz"> </span><span class="violett">`&lt;tr&gt;</span><br/>    <span class="bold">&lt;td&gt;${img}&lt;/td&gt;</span><br/>    &lt;td&gt;${address.id}&lt;/td&gt;<br/>...`<span class="schwarz"> </span><span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 5.22</b>    
            Display of the Uploaded Image in the List (list.js)</p>
            <p class="standard">If you create a new record, including image upload after restarting the server, you can see the image in a thumbnail view, as shown in <span class="crossreference "><a href="05_001.html#f5.8">Figure 5.8</a></span>.</p>
            <div class="imagebox figure-type"><a href="img-f5.8.html" id="f5.8"><img alt="Displaying the Image" id="img-f5.8" src="bilderklein/klein05_008.png"/></a></div>
            <p class="caption "><b>Figure 5.8</b>    
            Displaying the Image</p>
            <p class="standard"><a id="p163"/>Before we move on to <span class="crossreference "><a href="05_002.html#h5.2">Section 5.2</a></span>, let’s make a few small changes to the application to make it a bit more usable.</p>
        
        
            <h3 class="t3" id="h5.1.7">5.1.7    Fine-Tuning the Frontend</h3>
            <p class="standard">To create and edit records, you currently need to adjust the URL manually. To make the application even easier to use, you should add links to the <span class="italic">list.js</span> file to make both features accessible directly from the browser. The required changes can be found in <span class="crossreference "><a href="05_001.html#l5.23">Listing 5.23</a></span>.</p>
            <div class="listing " id="l5.23"><pre><span class="rot">export</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">getList(</span><span class="schwarz">addresses</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="rot">return</span><span class="schwarz"> </span><span class="violett">`&lt;!DOCTYPE html&gt;</span><br/>...<br/>        &lt;table&gt;<br/>          &lt;thead&gt;<br/>            &lt;tr&gt;<br/>...<br/>             &lt;th&gt;delete&lt;/th&gt;<br/>             <span class="bold">&lt;th&gt;edit&lt;/th&gt;</span><br/>            &lt;/tr&gt;<br/>          &lt;/thead&gt;<br/>          &lt;tbody&gt;<br/>            ${addresses.map(createRow).join(<span class="hellblau">''</span><span class="violett">)}</span><br/>          &lt;/tbody&gt;<br/>        &lt;/table&gt;<br/>        &lt;a href=<span class="hellblau">"/new"</span><span class="violett">&gt;create new data record&lt;/a&gt;</span><br/>      &lt;/body&gt;<br/>    &lt;/html&gt;`<span class="schwarz">;</span><br/>}<br/> <br/><span class="rot">function</span><span class="schwarz"> createRow(address) {</span><br/>...<br/>  <span class="rot">return</span><span class="schwarz"> </span><span class="violett">`&lt;tr&gt;</span><br/>...<br/>    &lt;td&gt;&lt;a href=<span class="hellblau">"/delete/${address.id}"</span><span class="violett">&gt;delete&lt;/a&gt;&lt;/td&gt;</span><br/>    <span class="bold">&lt;td&gt;&lt;a href=<span class="hellblau">"/edit/${address.id}"</span><span class="violett">&gt;edit&lt;/a&gt;&lt;/td&gt;</span></span><br/>  &lt;/tr&gt;`<span class="schwarz">;</span><br/>} <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 5.23</b>    
            Links to Edit and Delete Records (list.js)</p>
            <p class="standard">The HTTP server enables you to respond to the requests from clients. However, if you want to retrieve data from other web servers, for example, via a web service, the HTTP server is of little use. This is where the HTTP client comes into play.</p>
            <div class="imagebox figure-type"><a href="img-f5.9.html" id="f5.9"><img alt="Extended List Display" id="img-f5.9" src="bilderklein/klein05_009.png"/></a></div>
            <p class="caption "><b>Figure 5.9</b>    
            <a id="p164"/>Extended List Display</p>
        
    </div><p class="signatur"/>
                    </body>
                </html>