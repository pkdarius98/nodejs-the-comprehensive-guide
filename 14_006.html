<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
                    
        <head><meta content="application/xhtml+xml; charset=utf-8" http-equiv="Content-Type"/>
            <meta content="application/xhtml+xml; charset=utf-8" name="content-type"/>
            <meta content="Web Applications with Nest" name="title"/>
            <meta content="Sebastian Springer" name="author"/>
            <meta content="Rheinwerk Publishing" name="publisher"/>
            <meta content="© 2022 by Rheinwerk Publishing Inc., Boston (MA)" name="copyright"/>
            <meta content="Node.js - The Comprehensive Guide - Web Applications with Nest" name="description"/>
            <meta content="en" name="language"/>
            <title>Web Applications with Nest</title>
            <link href="common/main.css" rel="stylesheet" type="text/css"/>
<meta content="urn:uuid:e0000000-0000-0000-0000-000029756394" name="Adept.expected.resource"/>
        </head>
    


                    <body class="office_us type_kapitel">
                        <div id="main">
        <h2 class="t2" id="h14.6">14.6    Providers: Business Logic of the Application<a class="indexanchor" id="i14_75"/></h2>
        <p class="standard">The more extensive the logic behind an endpoint becomes, the longer the methods will be. To counteract this problem and to prevent the controller from growing to the point of being unmaintainable, Nest provides the services<a class="indexanchor" id="i14_76"/>. These are classes you can load and use as needed in your controllers or even in other services. A service is a special type of provider. Other types of providers include repositories<a class="indexanchor" id="i14_77"/>, factories<a class="indexanchor" id="i14_78"/>, and helpers<a class="indexanchor" id="i14_79"/>. Because services represent the most common type, we’ll focus on it. Later in this book, you’ll get to know yet another form of provider with repositories.</p>
        
            <h3 class="t3" id="h14.6.1">14.6.1    Creating and Including a Service<a class="indexanchor" id="i14_80"/></h3>
            <p class="standard">To move the logic for data management out of the controller, you first need to create a new service via the <samp class="listingcharacter listingcharacter">nest generate service movie</samp> command. As you can see from the output of the command in <span class="crossreference "><a href="14_006.html#l14.11">Listing 14.11</a></span>, the Nest CLI has created two new files in the <span class="italic">src/movie</span> directory, named <span class="italic">movie.service.ts</span> for the service and <span class="italic">movie.service.spec.ts</span> for the unit tests of the service.</p>
            <div class="listing " id="l14.11"><pre><span class="bold"><samp class="listingcharacter listingcharacter">$ nest generate service movie</samp></span><br/>CREATE src/movie/movie.service.spec.ts (453 bytes)<br/>CREATE src/movie/movie.service.ts (89 bytes)<br/>UPDATE src/movie/movie.module.ts (278 bytes) </pre></div>
            <p class="caption "><b>Listing 14.11</b>    
            Service Generation Output</p>
            <p class="standard">In addition, the service is registered<a class="indexanchor" id="i14_81"/> in the movie module. This step is of particular importance, as otherwise you won’t be able to include it in your controller. <span class="crossreference "><a href="14_006.html#l14.12">Listing 14.12</a></span> contains the updated source code of the module file.</p>
            <div class="listing " id="l14.12"><pre><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> Module </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'@nestjs/common'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> MovieController </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./movie.controller'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">import</span><span class="schwarz"> { MovieService } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./movie.service'</span><span class="schwarz">;</span><br/> </samp></span><br/>@Module({<br/>  imports: [],<br/>  controllers: [MovieController],<br/> <span class="bold"><samp class="listingcharacter listingcharacter"> providers: [MovieService],</samp></span><br/>  exports: [],<br/><a id="p429"/>})<br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">class MovieModule</span><span class="schwarz"> {} </span><span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 14.12</b>    
            Including the Service in the Movie Module (src/movie/movie.module.ts)</p>
            <p class="standard">The next step consists of moving the logic from the controller to the service.</p>
        
        
            <h3 class="t3" id="h14.6.2">14.6.2    Implementing the Service<a class="indexanchor" id="i14_82"/></h3>
            <p class="standard">Because Nest is based on TypeScript, you should at this point make sure that you’re using defined types. Because currently this isn’t yet the case for the movie objects, you should first create an appropriate data structure before implementing the service. At this point, you can choose between a TypeScript class and an interface. However, because you aren’t currently using concrete movie instances, but rather assigning a type to data structures, an interface is more appropriate. You can generate this interface via the <samp class="listingcharacter listingcharacter">nest generate interface movie movie</samp> command. This command creates the <span class="italic">movie.interface.ts</span> file in the <span class="italic">src/movie</span> directory, which is why <samp class="listingcharacter listingcharacter">movie</samp> is used twice here: The first occurrence of “movie” denotes the name of the interface, while the second refers to the path where the file should be created. <span class="crossreference "><a href="14_006.html#l14.13">Listing 14.13</a></span> shows the source code of the interface.</p>
            <div class="listing " id="l14.13"><pre><span class="rot">export</span><span class="schwarz"> </span><span class="rot">interface Movie</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  id<span class="schwarz">:</span><span class="schwarz"> number</span><span class="schwarz">;</span><span class="schwarz"><br/></span>  title<span class="schwarz">:</span><span class="schwarz"> string</span><span class="schwarz">;</span><span class="schwarz"><br/></span>  year<span class="schwarz">:</span><span class="schwarz"> number</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"><br/></span> <br/><span class="rot">export</span><span class="schwarz"> type InputMovie </span><span class="dunkelblau">=</span><span class="schwarz"> Omit</span><span class="dunkelblau">&lt;</span><span class="schwarz">Movie</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="hellblau">'id'</span><span class="dunkelblau">&gt;</span><span class="schwarz">;</span><span class="schwarz"> </span></pre></div>
            <p class="caption "><b>Listing 14.13</b>    
            Definition of the Movie Interface (src/movie/movie.interface.ts)</p>
            <p class="standard">In addition to the interface, you must also define an input type. The structure of the input type is similar to that of the <samp class="listingcharacter listingcharacter">movie</samp> interface with the difference that the <samp class="listingcharacter listingcharacter">id</samp> property isn’t included. You can achieve this using the <samp class="listingcharacter listingcharacter">omit</samp> type from TypeScript, to which you pass the base type and the properties you want to omit.</p>
            <p class="standard">With this basic structure in place, the next step is to implement the service. To do this, you copy the methods from the controller class, paste them into the <samp class="listingcharacter listingcharacter">MovieService</samp> class, and adjust the signatures, as shown in <span class="crossreference "><a href="14_006.html#l14.14">Listing 14.14</a></span>.</p>
            <div class="listing " id="l14.14"><pre><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> Injectable </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'@nestjs/common'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> InputMovie</span><span class="schwarz">,</span><span class="schwarz"> Movie </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./movie.interface'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/>@<span class="schwarz">Injectable()</span><span class="schwarz"><br/></span><span class="rot">export</span><span class="schwarz"> </span><span class="rot">class MovieService</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="rot">private</span><span class="schwarz"> data</span><span class="schwarz">:</span><span class="schwarz"> Movie</span><span class="schwarz">[]</span><span class="schwarz"> </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="schwarz">[</span><span class="schwarz"><br/></span><a id="p430"/>    <span class="schwarz">{</span><span class="schwarz"> id</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="schwarz">1,</span><span class="schwarz"> title</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'Iron Man'</span><span class="schwarz">,</span><span class="schwarz"> year</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'2008'</span><span class="schwarz"> </span><span class="schwarz">},</span><span class="schwarz"><br/></span>    <span class="schwarz">{</span><span class="schwarz"> id</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="schwarz">2,</span><span class="schwarz"> title</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'Thor'</span><span class="schwarz">,</span><span class="schwarz"> year</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'2011'</span><span class="schwarz"> </span><span class="schwarz">},</span><span class="schwarz"><br/></span>    <span class="schwarz">{</span><span class="schwarz"> id</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="schwarz">3,</span><span class="schwarz"> title</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'Captain America'</span><span class="schwarz">,</span><span class="schwarz"> year</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'2011'</span><span class="schwarz"> </span><span class="schwarz">},</span><span class="schwarz"><br/></span>  <span class="schwarz">];</span><span class="schwarz"><br/></span> <br/>  <span class="schwarz">getAllMovies():</span><span class="schwarz"> Movie</span><span class="schwarz">[]</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="rot">return</span><span class="schwarz"> </span><span class="rot">this</span><span class="schwarz">.</span><span class="schwarz">data</span><span class="schwarz">;</span><span class="schwarz"><br/></span>  <span class="schwarz">}</span><span class="schwarz"><br/></span> <br/>  <span class="schwarz">getOneMovie(</span><span class="schwarz">id</span><span class="schwarz">:</span><span class="schwarz"> number</span><span class="schwarz">):</span><span class="schwarz"> Movie </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="rot">return</span><span class="schwarz"> </span><span class="rot">this</span><span class="schwarz">.</span><span class="schwarz">data</span><span class="schwarz">.find((</span><span class="schwarz">movie</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> movie</span><span class="schwarz">.</span><span class="schwarz">id </span><span class="dunkelblau">===</span><span class="schwarz"> id</span><span class="schwarz">);</span><span class="schwarz"><br/></span>  <span class="schwarz">}</span><span class="schwarz"><br/></span> <br/>  <span class="schwarz">createNewMovie(</span><span class="schwarz">movie</span><span class="schwarz">:</span><span class="schwarz"> InputMovie</span><span class="schwarz">):</span><span class="schwarz"> Movie </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="rot">const</span><span class="schwarz"> nextId </span><span class="dunkelblau">=</span><span class="schwarz"> Math</span><span class="schwarz">.max(...</span><span class="rot">this</span><span class="schwarz">.</span><span class="schwarz">data</span><span class="schwarz">.map((</span><span class="schwarz">movie</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> movie</span><span class="schwarz">.</span><span class="schwarz">id</span><span class="schwarz">))</span><span class="schwarz"> </span><span class="dunkelblau">+</span><span class="schwarz"> </span><span class="schwarz">1;</span><span class="schwarz"><br/></span>    <span class="rot">const</span><span class="schwarz"> newMovie</span><span class="schwarz">:</span><span class="schwarz"> Movie </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> </span><span class="schwarz">...</span><span class="schwarz">movie</span><span class="schwarz">,</span><span class="schwarz"> id</span><span class="schwarz">:</span><span class="schwarz"> nextId </span><span class="schwarz">};</span><span class="schwarz"><br/></span>    <span class="rot">this</span><span class="schwarz">.</span><span class="schwarz">data</span><span class="schwarz">.push(</span><span class="schwarz">newMovie</span><span class="schwarz">);</span><span class="schwarz"><br/></span>    <span class="rot">return</span><span class="schwarz"> newMovie</span><span class="schwarz">;</span><span class="schwarz"><br/></span>  <span class="schwarz">}</span><span class="schwarz"><br/></span> <br/>  <span class="schwarz">udpateMovie(</span><span class="schwarz">id</span><span class="schwarz">:</span><span class="schwarz"> number</span><span class="schwarz">,</span><span class="schwarz"> movie</span><span class="schwarz">:</span><span class="schwarz"> Movie</span><span class="schwarz">):</span><span class="schwarz"> Movie </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="rot">const</span><span class="schwarz"> index </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">this</span><span class="schwarz">.</span><span class="schwarz">data</span><span class="schwarz">.findIndex((</span><span class="schwarz">movie</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> movie</span><span class="schwarz">.</span><span class="schwarz">id </span><span class="dunkelblau">===</span><span class="schwarz"> id</span><span class="schwarz">);</span><span class="schwarz"><br/></span>    <span class="rot">this</span><span class="schwarz">.</span><span class="schwarz">data</span><span class="schwarz">[</span><span class="schwarz">index</span><span class="schwarz">]</span><span class="schwarz"> </span><span class="dunkelblau">=</span><span class="schwarz"> movie</span><span class="schwarz">;</span><span class="schwarz"><br/></span>    <span class="rot">return</span><span class="schwarz"> movie</span><span class="schwarz">;</span><span class="schwarz"><br/></span>  <span class="schwarz">}</span><span class="schwarz"><br/></span> <br/>  <span class="schwarz">removeMovie(</span><span class="schwarz">id</span><span class="schwarz">:</span><span class="schwarz"> number</span><span class="schwarz">):</span><span class="schwarz"> </span><span class="rot">void</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="rot">this</span><span class="schwarz">.</span><span class="schwarz">data </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">this</span><span class="schwarz">.</span><span class="schwarz">data</span><span class="schwarz">.filter((</span><span class="schwarz">movie</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> movie</span><span class="schwarz">.</span><span class="schwarz">id </span><span class="dunkelblau">!==</span><span class="schwarz"> </span><span class="schwarz">parseInt(</span><span class="schwarz">id</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">10));</span><span class="schwarz"><br/></span>  <span class="schwarz">}</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"> </span></pre></div>
            <p class="caption "><b>Listing 14.14</b>    
            Implementation of the “MovieService” (src/movie/movie.service.ts)</p>
            <p class="standard">You’ve probably already noticed the <samp class="listingcharacter listingcharacter">injectable</samp> decorator<a class="indexanchor" id="i14_83"/> in the service class. This decorator adds some metadata to the class so that Nest can manage it via the dependency injection container. We’ll describe the topic of dependency injection in greater detail in the following section.</p>
            <p class="standard">Otherwise, the service is enriched with additional type information, and the respective parameters or return values are correctly typed. The only major change is to the <samp class="listingcharacter listingcharacter">createNewMovie</samp> method because you can’t turn the <samp class="listingcharacter listingcharacter">InputMovie</samp> type into a <samp class="listingcharacter listingcharacter">movie</samp> interface simply by using the interface. At this point, you use the spread operator to create a simple copy of the input object, adding the <samp class="listingcharacter listingcharacter">id</samp> property and assigning the type of the <samp class="listingcharacter listingcharacter">movie</samp> interface to the variable.</p>
        
        
            <h3 class="t3" id="h14.6.3">14.6.3    <a id="p431"/>Integrating the Service via Nest’s Dependency Injection<a class="indexanchor" id="i14_84"/></h3>
            <p class="standard">Now that this preliminary work has been done, you can connect the controller and the service. The key to this task can be found in Nest’s dependency injection. Within the module, you register the controller and service, thus making the structures known to the framework. Dependency injection works like a constructor injection in the frontend in Angular. In this case, this means you specify the service as a dependency<a class="indexanchor" id="i14_85"/> in the constructor of the controller. If Nest encounters such a definition, the framework searches for an appropriately registered provider. As an optimization, Nest has a cache layer that stores instances<a class="indexanchor" id="i14_86"/> of providers already in use. If a controller or other service now needs an instance of a particular provider, Nest first searches the cache for an existing instance. If it doesn’t find any, the framework creates an instance of the provider, caches it, and passes it to the requesting structure.</p>
            <p class="standard">The most important place in the controller is the constructor. As soon as you specify a parameter with access modifier here and, as in the example, the optional <samp class="listingcharacter listingcharacter">readonly</samp> keyword that prevents accidental modifications of the reference, you signal Nest to load a provider. This is available to you throughout the class via the specified name in conjunction with the <samp class="listingcharacter listingcharacter">this</samp> keyword, which is <samp class="listingcharacter listingcharacter">this.movieService</samp>, as shown in <span class="crossreference "><a href="14_006.html#l14.15">Listing 14.15</a></span>.</p>
            <div class="listing " id="l14.15"><pre><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  Body<span class="schwarz">,</span><span class="schwarz"><br/></span>  Controller<span class="schwarz">,</span><span class="schwarz"><br/></span>  Delete<span class="schwarz">,</span><span class="schwarz"><br/></span>  Get<span class="schwarz">,</span><span class="schwarz"><br/></span>  HttpCode<span class="schwarz">,</span><span class="schwarz"><br/></span>  Param<span class="schwarz">,</span><span class="schwarz"><br/></span>  Post<span class="schwarz">,</span><span class="schwarz"><br/></span>  Put<span class="schwarz">,</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'@nestjs/common'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">import</span><span class="schwarz"> { InputMovie, Movie } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./movie.interface'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> { MovieService } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./movie.service'</span><span class="schwarz">;</span><br/> </samp></span><br/>@Controller(<span class="hellblau">'movie'</span><span class="schwarz">)</span><br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">class MovieController</span><span class="schwarz"> {</span><br/>  <span class="bold"><samp class="listingcharacter listingcharacter">constructor(<span class="rot">private</span><span class="schwarz"> readonly movieService: MovieService) {}</span><br/> </samp></span><br/>  @Get()<br/>  getAllMovies()<span class="bold"><samp class="listingcharacter listingcharacter">: Movie[]</samp></span> {<br/>    <span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">return</span><span class="schwarz"> </span><span class="rot">this</span><span class="schwarz">.movieService.getAllMovies();</span></samp></span><br/>  }<br/> <br/>  @Get(<span class="hellblau">':id'</span><span class="schwarz">)</span><br/>  getOneMovie(@Param(<span class="hellblau">'id'</span><span class="schwarz">) id: string)</span><span class="bold"><samp class="listingcharacter listingcharacter">: Movie</samp></span> {<br/>    <span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">return</span><span class="schwarz"> </span><span class="rot">this</span><span class="schwarz">.movieService.getOneMovie(parseInt(id, 10));</span></samp></span><br/>  }<br/><a id="p432"/> <br/>  @Post()<br/>  createNewMovie(@Body() movie<span class="bold"><samp class="listingcharacter listingcharacter">: InputMovie</samp></span>)<span class="bold"><samp class="listingcharacter listingcharacter">: Movie</samp></span> {<br/>    <span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">return</span><span class="schwarz"> </span><span class="rot">this</span><span class="schwarz">.movieService.createNewMovie(movie);</span></samp></span><br/>  }<br/> <br/>  @Put(<span class="hellblau">':id'</span><span class="schwarz">)</span><br/>  udpateMovie(@Param(<span class="hellblau">'id'</span><span class="schwarz">) id: string, @Body() movie</span><span class="bold"><samp class="listingcharacter listingcharacter">: Movie): Movie</samp></span> {<br/>    <span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">return</span><span class="schwarz"> </span><span class="rot">this</span><span class="schwarz">.movieService.udpateMovie(parseInt(id, 10), movie);</span></samp></span><br/>  }<br/> <br/>  @Delete(<span class="hellblau">':id'</span><span class="schwarz">)</span><br/>  @HttpCode(204)<br/>  removeMovie(@Param(<span class="hellblau">'id'</span><span class="schwarz">) id: string)</span><span class="bold"><samp class="listingcharacter listingcharacter">: <span class="rot">void</span></samp></span><span class="schwarz"> {</span><br/>    <span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">this</span><span class="schwarz">.movieService.removeMovie(parseInt(id, 10));</span></samp></span><br/>  }<br/>} <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 14.15</b>    
            Integrating the Movie Service in the Controller (src/movie/movie.service.ts)</p>
            <p class="standard">What you’ve seen here in the example of a controller requiring a service works in the same way for services among themselves. You just need to make sure that the service is available via dependency injection.</p>
        
    </div><p class="signatur"/>
                    </body>
                </html>