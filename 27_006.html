<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
                    
        <head><meta content="application/xhtml+xml; charset=utf-8" http-equiv="Content-Type"/>
            <meta content="application/xhtml+xml; charset=utf-8" name="content-type"/>
            <meta content="Microservices with Node.js" name="title"/>
            <meta content="Sebastian Springer" name="author"/>
            <meta content="Rheinwerk Publishing" name="publisher"/>
            <meta content="© 2022 by Rheinwerk Publishing Inc., Boston (MA)" name="copyright"/>
            <meta content="Node.js - The Comprehensive Guide - Microservices with Node.js" name="description"/>
            <meta content="en" name="language"/>
            <title>Microservices with Node.js</title>
            <link href="common/main.css" rel="stylesheet" type="text/css"/>
<meta content="urn:uuid:e0000000-0000-0000-0000-000029756394" name="Adept.expected.resource"/>
        </head>
    


                    <body class="office_us type_kapitel">
                        <div id="main">
        <h2 class="t2" id="h27.6">27.6    Synchronous Microservice with Express<a class="indexanchor" id="i27_78"/></h2>
        <p class="standard">The second microservice you implement for your application is the movie service. This is a classic Express application that can be accessed via HTTP. The difference with the <a id="p781"/>Express applications you’ve developed so far is that the movie service has a higher level of specialization. This microservice only takes care of all tasks related to the movie database, that is, reading and writing records as well as validating them. In this section, you implement read-only and create-only access for all create, read, update, delete (CRUD) operations<a class="indexanchor" id="i27_79"/> as examples.</p>
        
            <h3 class="t3" id="h27.6.1">27.6.1    Setup</h3>
            <p class="standard">The basis of the movie microservice is Express with some extensions. You save the files of this service in the <span class="italic">movie</span> directory. The first step is again to create a <span class="italic">package.json</span> file using the <samp class="listingcharacter listingcharacter">npm init</samp> command. The required packages will then be installed via the <samp class="listingcharacter listingcharacter">npm install express mysql2</samp> command. The MySQL driver<a class="indexanchor" id="i27_80"/> is used to connect to the database. You can see the <span class="italic">package.json</span> of the movie service in <span class="crossreference "><a href="27_006.html#l27.27">Listing 27.27</a></span>.</p>
            <div class="listing " id="l27.27"><pre><span class="schwarz">{</span><br/>  <span class="hellblau">"name"</span><span class="schwarz">: </span><span class="hellblau">"movie-service"</span><span class="schwarz">,</span><br/>  <span class="hellblau">"version"</span><span class="schwarz">: </span><span class="hellblau">"1.0.0"</span><span class="schwarz">,</span><br/>  <span class="hellblau">"description"</span><span class="schwarz">: </span><span class="hellblau">""</span><span class="schwarz">,</span><br/>  <span class="hellblau">"main"</span><span class="schwarz">: </span><span class="hellblau">"index.js"</span><span class="schwarz">,</span><br/>  <span class="hellblau">"</span><span class="bold"><samp class="listingcharacter listingcharacter">private</samp></span>"<span class="bold"><samp class="listingcharacter listingcharacter"><span class="schwarz">: </span><span class="rot">true</span><span class="schwarz">,</span></samp></span><br/>  <span class="hellblau">"</span><span class="bold"><samp class="listingcharacter listingcharacter">type</samp></span>"<span class="bold"><samp class="listingcharacter listingcharacter"><span class="schwarz">:</span></samp></span> <span class="hellblau">"</span><span class="bold"><samp class="listingcharacter listingcharacter">module</samp></span>"<span class="bold"><samp class="listingcharacter listingcharacter"><span class="schwarz">,</span></samp></span><br/>  <span class="hellblau">"scripts"</span><span class="schwarz">: {</span><br/>    <span class="hellblau">"</span><span class="bold"><samp class="listingcharacter listingcharacter">start</samp></span>"<span class="bold"><samp class="listingcharacter listingcharacter"><span class="schwarz">:</span></samp></span> <span class="hellblau">"</span><span class="bold"><samp class="listingcharacter listingcharacter">node index.js</samp></span>"<span class="schwarz"><br/></span>  },<br/>  <span class="hellblau">"keywords"</span><span class="schwarz">: [],</span><br/>  <span class="hellblau">"author"</span><span class="schwarz">: </span><span class="hellblau">""</span><span class="schwarz">,</span><br/>  <span class="hellblau">"license"</span><span class="schwarz">: </span><span class="hellblau">"ISC"</span><span class="schwarz"> ,</span><br/>  <span class="hellblau">"</span><span class="bold"><samp class="listingcharacter listingcharacter">dependencies</samp></span>"<span class="bold"><samp class="listingcharacter listingcharacter"><span class="schwarz">: {</span></samp></span><br/>    <span class="hellblau">"</span><span class="bold"><samp class="listingcharacter listingcharacter">express</samp></span>"<span class="bold"><samp class="listingcharacter listingcharacter"><span class="schwarz">:</span></samp></span> <span class="hellblau">"</span><span class="bold"><samp class="listingcharacter listingcharacter">^4.17.1</samp></span>"<span class="bold"><samp class="listingcharacter listingcharacter"><span class="schwarz">,</span></samp></span><br/>    <span class="hellblau">"</span><span class="bold"><samp class="listingcharacter listingcharacter">mysql2</samp></span>"<span class="bold"><samp class="listingcharacter listingcharacter"><span class="schwarz">:</span></samp></span> <span class="hellblau">"</span><span class="bold"><samp class="listingcharacter listingcharacter">^2.3.0</samp></span>"<span class="schwarz"><br/></span>  <span class="bold"><samp class="listingcharacter listingcharacter">}</samp></span><br/>} <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 27.27</b>    
            “package.json” File of the Movie Service (movie/package.json)</p>
            <p class="standard">The initial file is similar to that of the API gateway. <span class="crossreference "><a href="27_006.html#l27.28">Listing 27.28</a></span> shows the source code of this file.</p>
            <div class="listing " id="l27.28"><pre><span class="rot">import</span><span class="schwarz"> express </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'express'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> { getAllAction, createAction } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./controller.js'</span><span class="schwarz">;</span><br/> <br/><span class="rot">const</span><span class="schwarz"> app </span><span class="dunkelblau">=</span><span class="schwarz"> express();</span><br/>app.use(express.json());<br/> <br/>app.get(<span class="hellblau">'/movie'</span><span class="schwarz">, getAllAction);</span><br/><a id="p782"/>app.post(<span class="hellblau">'/movie'</span><span class="schwarz">, createAction);</span><br/> <br/>app.listen(8181, () <span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="magenta">console</span><span class="schwarz">.log(</span><span class="hellblau">'Movie service is listening'</span><span class="schwarz">)); </span><span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 27.28</b>    
            Entry Point to the Movie Microservice (movie/index.js)</p>
            <p class="standard">The entry file is relatively compact, so the routes to the current state of implementation are also still located here. However, as soon as you define more than four or five routes, you should swap them out to a separate file.</p>
        
        
            <h3 class="t3" id="h27.6.2">27.6.2    Controller<a class="indexanchor" id="i27_81"/></h3>
            <p class="standard">You swap out the callback functions behind the routes to a separate controller for a better overview. This controller is responsible for generating a response from the incoming request, based on the functionality provided by the model. The controller code is shown in <span class="crossreference "><a href="27_006.html#l27.29">Listing 27.29</a></span>.</p>
            <div class="listing " id="l27.29"><pre><span class="rot">import</span><span class="schwarz"> { getAll, create } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./model.js'</span><span class="schwarz">;</span><br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> getAllAction(request, response) {</span><br/>  <span class="rot">try</span><span class="schwarz"> {</span><br/>    <span class="rot">const</span><span class="schwarz"> movies </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> getAll();</span><br/>    response.json(movies);<br/>  } <span class="rot">catch </span><span class="schwarz">(</span><span class="rot">e</span><span class="schwarz">) {</span><br/>    response.status(500).json(e);<br/>  }<br/>}<br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> createAction(request, response) {</span><br/>  <span class="rot">try</span><span class="schwarz"> {</span><br/>    <span class="rot">const</span><span class="schwarz"> movie </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> create(request.body);</span><br/>    response.json(movie);<br/>  } <span class="rot">catch </span><span class="schwarz">(</span><span class="rot">e</span><span class="schwarz">) {</span><br/>    response.status(500).json(e);<br/>  }<br/>} <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 27.29</b>    
            Movie Controller Implementation (movie/controller.js)</p>
        
        
            <h3 class="t3" id="h27.6.3">27.6.3    Model Implementation<a class="indexanchor" id="i27_82"/></h3>
            <p class="standard">The final step in the implementation of the microservice consists of implementing the model that manages the access to the database<a class="indexanchor" id="i27_83"/>. In this case, the endpoint is a MySQL database, so you need the MySQL driver for Node.js to communicate. <span class="crossreference "><a href="27_006.html#l27.30">Listing 27.30</a></span> contains the source code of the model.</p>
            <div class="listing " id="l27.30"><pre><span class="rot"><a id="p783"/>import</span><span class="schwarz"> mysql </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'mysql2/promise'</span><span class="schwarz">;</span><br/> <br/><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> connect() {</span><br/>  <span class="rot">const</span><span class="schwarz"> connection </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> mysql.createConnection({</span><br/>    host: <span class="hellblau">'mysql'</span><span class="schwarz">,</span><br/>    user: <span class="hellblau">'root'</span><span class="schwarz">,</span><br/>    password: <span class="hellblau">'topSecret'</span><span class="schwarz">,</span><br/>    database: <span class="hellblau">'Movie'</span><span class="schwarz">,</span><br/>  });<br/> <br/>  connection.connect();<br/> <br/>  <span class="rot">return</span><span class="schwarz"> connection;</span><br/>}<br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> getAll() {</span><br/>  <span class="rot">const</span><span class="schwarz"> connection </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> connect();</span><br/> <br/>  <span class="rot">const</span><span class="schwarz"> query </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="hellblau">'SELECT * FROM Movie'</span><span class="schwarz">;</span><br/>  <span class="rot">const</span><span class="schwarz"> [data] </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> connection.query(query);</span><br/> <br/>  connection.end();<br/> <br/>  <span class="rot">return</span><span class="schwarz"> data;</span><br/>}<br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> create(movie) {</span><br/>  <span class="rot">const</span><span class="schwarz"> connection </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> connect();</span><br/> <br/>  <span class="rot">const</span><span class="schwarz"> query </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="hellblau">'INSERT INTO Movie (title, year) VALUES (?, ?)'</span><span class="schwarz">;</span><br/>  <span class="rot">const</span><span class="schwarz"> [result] </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> connection.query(query, [movie.title, movie.year]);</span><br/> <br/>  connection.end();<br/> <br/>  <span class="rot">return</span><span class="schwarz"> { ...movie, id: result.insertId };</span><br/>} <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 27.30</b>    
            Movie Model for Querying the MySQL Database (movie/model.js)</p>
            <p class="standard">In the model, you first generate a helper function that establishes the connection to the database. It returns the object representation of the connection. You use this helper function in both the <samp class="listingcharacter listingcharacter">getAll</samp> and <samp class="listingcharacter listingcharacter">create</samp> functions to set up the connection and then send the appropriate query using the <samp class="listingcharacter listingcharacter">query</samp> method of the connection object. Once you get the result back, you terminate the connection and return the result. Because both <a id="p784"/>functions are implemented as <samp class="listingcharacter listingcharacter">async</samp> functions and the <samp class="listingcharacter listingcharacter">mysql2</samp> driver works with native promises, you won’t have any problem at this point and don’t need any additional boilerplate code.</p>
        
        
            <h3 class="t3" id="h27.6.4">27.6.4    Docker Setup<a class="indexanchor" id="i27_84"/></h3>
            <p class="standard">To be able to start the movie microservice, you also need a Dockerfile, the structure of which is shown in <span class="crossreference "><a href="27_006.html#l27.31">Listing 27.31</a></span>.</p>
            <div class="listing " id="l27.31"><pre>FROM node<span class="schwarz">:16.8.0</span><br/>WORKDIR <span class="dunkelblau">/</span><span class="schwarz">usr</span><span class="dunkelblau">/</span><span class="schwarz">src</span><span class="dunkelblau">/</span><span class="schwarz">app</span><br/>COPY <span class="rot">package</span><span class="dunkelblau">*</span><span class="schwarz">.json .</span><span class="dunkelblau">/</span><span class="schwarz"><br/></span>RUN npm install<br/>COPY . .<br/>EXPOSE 8181<br/>CMD [ <span class="hellblau">"node"</span><span class="schwarz">, </span><span class="hellblau">"index.js"</span><span class="schwarz"> ] </span><span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 27.31</b>    
            Dockerfile for the Movie Service</p>
            <p class="standard">In addition to this Dockerfile, you integrate the service as well as the container that contains the database into your <span class="italic">docker-compose.yml</span><a class="indexanchor" id="i27_85"/>. The results are shown in <span class="crossreference "><a href="27_006.html#l27.32">Listing 27.32</a></span>.</p>
            <div class="listing " id="l27.32"><pre>version<span class="schwarz">: </span><span class="hellblau">'3'</span><span class="schwarz"><br/></span>services:<br/>  mongodb:<br/>    image: mongo:latest<br/>    container_name: <span class="hellblau">'mongodb'</span><span class="schwarz"><br/></span>    ports:<br/>      <span class="dunkelblau">-</span><span class="schwarz"> 27017:27017</span><br/>  mongo<span class="dunkelblau">-</span><span class="schwarz">seed:</span><br/>    image: mongo:latest<br/>    links:<br/>      <span class="dunkelblau">-</span><span class="schwarz"> mongodb</span><br/>    volumes:<br/>      <span class="dunkelblau">-</span><span class="schwarz"> .</span><span class="dunkelblau">/</span><span class="schwarz">initUser.json:</span><span class="dunkelblau">/</span><span class="schwarz">initUser.json</span><br/>    command: <span class="hellblau">'mongoimport --host mongodb --db users --collection users  </span><img alt="inline image" class="inline_image" src="bilder/umbruchpfeil.png"/><br/>      --type json --file /initUser.json --jsonArray'<span class="schwarz"><br/></span>  rabbitmq:<br/>    image: rabbitmq:latest<br/>    ports:<br/>      <span class="dunkelblau">-</span><span class="schwarz"> 5672:5672</span><br/>  user:<br/>    build:<br/>      context: user<br/><a id="p785"/>    depends_on:<br/>      <span class="dunkelblau">-</span><span class="schwarz"> </span><span class="hellblau">'mongodb'</span><span class="schwarz"><br/></span>      <span class="dunkelblau">-</span><span class="schwarz"> </span><span class="hellblau">'rabbitmq'</span><span class="schwarz"><br/></span>    restart: on<span class="dunkelblau">-</span><span class="schwarz">failure</span><br/>    links:<br/>      <span class="dunkelblau">-</span><span class="schwarz"> rabbitmq</span><br/>  <span class="bold"><samp class="listingcharacter listingcharacter">mysql:<br/>    image: mysql:latest<br/>    environment:<br/>      MYSQL_ROOT_PASSWORD: <span class="hellblau">'topSecret'</span><span class="schwarz"><br/></span>      MYSQL_ROOT_HOST: <span class="hellblau">'%'</span><span class="schwarz"><br/></span>    ports:<br/>      <span class="dunkelblau">-</span><span class="schwarz"> 3306:3306</span><br/>    volumes:<br/>      <span class="dunkelblau">-</span><span class="schwarz"> .</span><span class="dunkelblau">/</span><span class="schwarz">initMovie.sql:</span><span class="dunkelblau">/</span><span class="schwarz">initMovie.sql</span><br/>    command: <span class="hellblau">'mysqld --init-file=/initMovie.sql'</span><span class="schwarz"><br/></span>  movie:<br/>    build:<br/>      context: movie<br/>    depends_on:<br/>      <span class="dunkelblau">-</span><span class="schwarz"> </span><span class="hellblau">'mysql'</span><span class="schwarz"><br/></span>    restart: on<span class="dunkelblau">-</span><span class="schwarz">failure</span></samp></span><br/>  api:<br/>    build:<br/>      context: api<br/>    ports:<br/>      <span class="dunkelblau">-</span><span class="schwarz"> 8080:8080</span><br/>    depends_on:<br/>      <span class="dunkelblau">-</span><span class="schwarz"> </span><span class="hellblau">'user'</span><span class="schwarz"><br/></span>      <span class="dunkelblau">-</span><span class="schwarz"> </span><span class="hellblau">'movie'</span><span class="schwarz"><br/></span>    restart: on<span class="dunkelblau">-</span><span class="schwarz">failure</span><br/>    links:<br/>      <span class="dunkelblau">-</span><span class="schwarz"> rabbitmq </span><span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 27.32</b>    
            Integration into the “docker-compose.yml” File</p>
            <p class="standard">You create the initial MySQL database structure similar to MongoDB with a file and the <samp class="listingcharacter listingcharacter">command</samp> you pass when starting the container. The structure of the <span class="italic">initMovie.sql</span> file is shown in <span class="crossreference "><a href="27_006.html#l27.33">Listing 27.33</a></span>.</p>
            <div class="listing " id="l27.33"><pre><span class="dunkelblau">CREATE</span><span class="schwarz"> </span><span class="dunkelblau">DATABASE</span><span class="schwarz"> </span><span class="rot">`Movie`</span><span class="schwarz">;</span><br/><br/>USE <span class="rot">`Movie`</span><span class="schwarz">;</span><br/><br/><span class="dunkelblau">CREATE</span><span class="schwarz"> </span><span class="dunkelblau">TABLE</span><span class="schwarz"> </span><span class="rot">`Movie`</span><span class="schwarz"> (</span><br/><a id="p786"/>  <span class="rot">`id`</span><span class="schwarz"> int(11) </span><span class="dunkelblau">NOT</span><span class="schwarz"> </span><span class="dunkelblau">NULL</span><span class="schwarz"> AUTO_INCREMENT,</span><br/>  <span class="rot">`title`</span><span class="schwarz"> </span><span class="dunkelblau">varchar</span><span class="schwarz">(255) </span><span class="dunkelblau">DEFAULT</span><span class="schwarz"> </span><span class="dunkelblau">NULL</span><span class="schwarz">,</span><br/>  <span class="rot">`year`</span><span class="schwarz"> int(11) </span><span class="dunkelblau">DEFAULT</span><span class="schwarz"> </span><span class="dunkelblau">NULL</span><span class="schwarz">,</span><br/>  <span class="dunkelblau">PRIMARY</span><span class="schwarz"> </span><span class="dunkelblau">KEY</span><span class="schwarz"> (</span><span class="rot">`id`</span><span class="schwarz">)</span><br/>) ENGINE=InnoDB <span class="dunkelblau">DEFAULT</span><span class="schwarz"> CHARSET=utf8;</span><br/><span class="dunkelblau">INSERT</span><span class="schwarz"> </span><span class="dunkelblau">INTO</span><span class="schwarz"> </span><span class="rot">`Movie`</span><span class="schwarz"> (</span><span class="rot">`title`</span><span class="schwarz">, </span><span class="rot">`year`</span><span class="schwarz">) VALUES</span><br/>(<span class="rot">'Iron Man'</span><span class="schwarz">, 2008),</span><br/>(<span class="rot">'Thor'</span><span class="schwarz">, 2011),</span><br/>(<span class="rot">'Captain America'</span><span class="schwarz">, 2011); </span><span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 27.33</b>    
            Initial Movie Structure (initMovie.sql)</p>
            <p class="standard">With the movie service, you’ve completed the last microservice of the application. <span class="crossreference "><a href="27_006.html#f27.8">Figure 27.8</a></span> shows this last component in the overall architecture.</p>
            <div class="imagebox figure-type"><a href="img-f27.8.html" id="f27.8"><img alt="Movie Service in the Microservice Architecture" id="img-f27.8" src="bilderklein/klein27_008.png"/></a></div>
            <p class="caption "><b>Figure 27.8</b>    
            Movie Service in the Microservice Architecture</p>
        
        
            <h3 class="t3" id="h27.6.5">27.6.5    Integration into the API Gateway</h3>
            <p class="standard">To integrate the movie microservice into the API gateway, you must first install the <samp class="listingcharacter listingcharacter">request</samp> package using the <samp class="listingcharacter listingcharacter">npm install request</samp> command. Then you extend the entry file with the entry to the movie module, which you must also secure against unauthorized access<a class="indexanchor" id="i27_86"/>. For this purpose, you use the <samp class="listingcharacter listingcharacter">express-jwt</samp> command. <span class="crossreference "><a href="27_006.html#l27.34">Listing 27.34</a></span> shows the customized source code.</p>
            <div class="listing " id="l27.34"><pre><span class="rot"><a id="p787"/>import</span><span class="schwarz"> express </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'express'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> expressJwt </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'express-jwt'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> { router </span><span class="rot">as</span><span class="schwarz"> userRouter } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./user/index.js'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> { router </span><span class="rot">as</span><span class="schwarz"> loginRouter } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./auth.js'</span><span class="schwarz">;</span><br/><span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">import</span><span class="schwarz"> { router </span><span class="rot">as</span><span class="schwarz"> movieRouter } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./movie/index.js'</span><span class="schwarz">;</span></samp></span><br/><span class="rot">import</span><span class="schwarz"> { getChannel, registerHandler } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./connect.js'</span><span class="schwarz">;</span><br/> <br/><span class="rot">const</span><span class="schwarz"> channel </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> getChannel();</span><br/>registerHandler(channel);<br/> <br/><span class="rot">const</span><span class="schwarz"> app </span><span class="dunkelblau">=</span><span class="schwarz"> express();</span><br/> <br/>app.use(express.json());<br/>app.use(<span class="hellblau">'/login'</span><span class="schwarz">, loginRouter);</span><br/>app.use(<br/>  <span class="hellblau">'/user'</span><span class="schwarz">,</span><br/>  expressJwt({ secret: <span class="hellblau">'secret'</span><span class="schwarz">, algorithms: [</span><span class="hellblau">'HS256'</span><span class="schwarz">] }),</span><br/>  userRouter,<br/>);<br/><span class="bold"><samp class="listingcharacter listingcharacter">app.use(<br/>  <span class="hellblau">'/movie'</span><span class="schwarz">,</span><br/>  expressJwt({ secret: <span class="hellblau">'secret'</span><span class="schwarz">, algorithms: [</span><span class="hellblau">'HS256'</span><span class="schwarz">] }),</span><br/>  movieRouter,<br/>);<br/> </samp></span><br/>app.use((err, request, response, next) <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>  <span class="rot">if</span><span class="schwarz"> (err.name </span><span class="dunkelblau">===</span><span class="schwarz"> </span><span class="hellblau">'UnauthorizedError'</span><span class="schwarz">) {</span><br/>    response.status(401).json(<span class="hellblau">'unauthorized'</span><span class="schwarz">);</span><br/>  } <span class="rot">else</span><span class="schwarz"> {</span><br/>    next();<br/>  }<br/>});<br/> <br/>app.listen(8080, () <span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="magenta">console</span><span class="schwarz">.log(</span><span class="hellblau">'API Gateway is listening'</span><span class="schwarz">)); </span><span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 27.34</b>    
            Integrating the Movie Router into the Entry File of the API Gateway (api/index.js)</p>
            <p class="standard">As with the user module, the source code for the movie module is stored in a separate directory named <span class="italic">movie</span>. Here, you first create a file named <span class="italic">index.js</span>, which contains the movie router (see <span class="crossreference "><a href="27_006.html#l27.35">Listing 27.35</a></span>).</p>
            <div class="listing " id="l27.35"><pre><span class="rot">import</span><span class="schwarz"> { Router } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'express'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> { getAllAction, createAction } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./controller.js'</span><span class="schwarz">;</span><br/> <br/><span class="rot"><a id="p788"/>const</span><span class="schwarz"> router </span><span class="dunkelblau">=</span><span class="schwarz"> Router();</span><br/> <br/>router.get(<span class="hellblau">'/'</span><span class="schwarz">, getAllAction);</span><br/>router.post(<span class="hellblau">'/'</span><span class="schwarz">, createAction);</span><br/> <br/><span class="rot">export</span><span class="schwarz"> { router }; </span><span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 27.35</b>    
            Router of the Movie Module (api/movie/index.js)</p>
            <p class="standard">The implementation of the callback functions that are mapped to the routes and originate from the <span class="italic">controller.js</span> file is shown in <span class="crossreference "><a href="27_006.html#l27.36">Listing 27.36</a></span>.</p>
            <div class="listing " id="l27.36"><pre><span class="rot">import</span><span class="schwarz"> { getAll, create } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./model.js'</span><span class="schwarz">;</span><br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> getAllAction(request, response) {</span><br/>  <span class="rot">try</span><span class="schwarz"> {</span><br/>    <span class="rot">const</span><span class="schwarz"> movies </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> getAll();</span><br/>    response.json(movies);<br/>  } <span class="rot">catch </span><span class="schwarz">(</span><span class="rot">e</span><span class="schwarz">) {</span><br/>    response.status(500).json(e);<br/>  }<br/>}<br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> createAction(request, response) {</span><br/>  <span class="rot">try</span><span class="schwarz"> {</span><br/>    <span class="rot">const</span><span class="schwarz"> newMovie </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> create(request.body);</span><br/>    response.json(newMovie);<br/>  } <span class="rot">catch </span><span class="schwarz">(</span><span class="rot">e</span><span class="schwarz">) {</span><br/>    response.status(500).json(e);<br/>  }<br/>} <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 27.36</b>    
            Controller of the Movie Module (api/movie/controller.js)</p>
            <p class="standard">The biggest difference between the user and movie modules can be found in the implementation of the model, which, in both cases, provides a promise interface to the outside world. In the case of the user model, communication is asynchronous via a message queue. With the movie module, you use synchronous communication via HTTP requests. In this case, you use the <samp class="listingcharacter listingcharacter">axios</samp> package<a class="indexanchor" id="i27_87"/>, which you install via the <samp class="listingcharacter listingcharacter">npm install axios</samp> command, to route the requests to the microservice (see <span class="crossreference "><a href="27_006.html#l27.37">Listing 27.37</a></span>).</p>
            <div class="listing " id="l27.37"><pre><span class="rot">import</span><span class="schwarz"> axios </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'axios'</span><span class="schwarz">;</span><br/> <br/><span class="rot">const</span><span class="schwarz"> url </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="hellblau">'http://movie:8181/movie'</span><span class="schwarz">;</span><br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> getAll() {</span><br/>  <span class="rot">const</span><span class="schwarz"> { data } </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> axios.get(url);</span><br/><a id="p789"/>  <span class="rot">return</span><span class="schwarz"> data;</span><br/>}<br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> create(movie) {</span><br/>  <span class="rot">const</span><span class="schwarz"> { data } </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> axios.post(url, movie);</span><br/>  <span class="rot">return</span><span class="schwarz"> data;</span><br/>} <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 27.37</b>    
            Movie Model for Connecting the Movie Microservice</p>
            <p class="standard">With this module, you’ve implemented a complete cross section of your microservice application and implemented both a synchronous and an asynchronous microservice. When you start your application now using the <samp class="listingcharacter listingcharacter">docker-compose up</samp> command, you can use Postman or cURL<a class="indexanchor" id="i27_88"/> to communicate with the application, get a JWT issued, and query the application’s interfaces. <span class="crossreference "><a href="27_006.html#l27.38">Listing 27.38</a></span> shows how you can use cURL to read the list of movies stored in the database.</p>
            <div class="listing " id="l27.38"><pre><span class="bold"><samp class="listingcharacter listingcharacter">$ curl -H "Content-Type: application/json" -H "Authorization:  Bearer eyJhbGciO iJIUzI1NiIsInR5cCI6IkpXVCJ9.eyIwIjp7Il9pZCI6IjViMzc0ZWI2NzQ0MDQzMDQ1OGRmN2JhMCIsInVzZXJuYW1lIjoic3NwcmluZ2VyIiwicGFzc3dvcmQiOiJ0ZXN0In0sIjEiOnsiX2lkIjoiNWIzNzUwNWUzYzg3YzljMjJlNzIyMGU2IiwidXNlcm5hbWUiOiJzc3ByaW5nZXIiLCJwYXNzd29yZCI6InRlc3QifSwiMiI6eyJfaWQiOiI1YjM3NTBiYzAxN2MxODk1ZjA1MzFlM2EiLCJ1c2VybmFtZSI6InNzcHJpbmdlciIsInBhc3N3b3JkIjoidGVzdCJ9LCIzIjp7Il9pZCI6IjViM2IwYWQwMDE3YzE4OTVmMDUzMWVkMyIsInVzZXJuYW1lIjoic3NwcmluZ2VyIiwicGFzc3dvcmQiOiJ0ZXN0In0sImlhdCI6MTUzMDY4MTIxN30.skb4ubpta8-YcA35cIJML54Cm2-Ty6UFTik2tHMgzJ0"  http://localhost:8080/movie</samp></span><br/>[<br/>  {"id":1,"title":"Iron Man","year":2008},<br/>  {"id":2,"title":"Thor","year":2011},<br/>  {"id":3,"title":"Captain America","year":2011}<br/>] </pre></div>
            <p class="caption "><b>Listing 27.38</b>    
            Reading the Stored Movie Data</p>
        
    </div><p class="signatur"/>
                    </body>
                </html>