<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
                    
        <head><meta content="application/xhtml+xml; charset=utf-8" http-equiv="Content-Type"/>
            <meta content="application/xhtml+xml; charset=utf-8" name="content-type"/>
            <meta content="HTTP" name="title"/>
            <meta content="Sebastian Springer" name="author"/>
            <meta content="Rheinwerk Publishing" name="publisher"/>
            <meta content="© 2022 by Rheinwerk Publishing Inc., Boston (MA)" name="copyright"/>
            <meta content="Node.js - The Comprehensive Guide - HTTP" name="description"/>
            <meta content="en" name="language"/>
            <title>HTTP</title>
            <link href="common/main.css" rel="stylesheet" type="text/css"/>
<meta content="urn:uuid:e0000000-0000-0000-0000-000029756394" name="Adept.expected.resource"/>
        </head>
    


                    <body class="office_us type_kapitel">
                        <div id="main">
        <h2 class="t2" id="h5.4">5.4    HTTP/2<a class="indexanchor" id="i05_96"/></h2>
        <p class="standard">Since version 8.4, the <samp class="listingcharacter listingcharacter">http2</samp> module is shipped with Node.js and supports the new protocol version for both the server and the client. The handling is slightly different from the <samp class="listingcharacter listingcharacter">http</samp> module. Furthermore, HTTP/2 provides some interesting additional features. First, HTTP/2 should no longer be used in the unencrypted version. Originally, it was planned that HTTP/2 should only exist in an encrypted variant, but the standardization consortium didn’t come to a uniform solution here, so HTTP/2 can be used both encrypted and unencrypted. However, because most browser developers now display warnings for unsecured connections, this shouldn’t be an option for you.</p>
        
            <h3 class="t3" id="h5.4.1">5.4.1    HTTP/2 Server<a class="indexanchor" id="i05_97"/></h3>
            <p class="standard">The interface of the <samp class="listingcharacter listingcharacter">http2</samp> module is slightly different from that of the <samp class="listingcharacter listingcharacter">http</samp> module. The new module also builds on an event-based model, so the basic approach to development remains the same. You must import the <samp class="listingcharacter listingcharacter">createSecureServer</samp> function from the <samp class="listingcharacter listingcharacter">http2</samp> module and use it instead of the <samp class="listingcharacter listingcharacter">createServer</samp> function. The rest of the code remains unchanged. The interaction with external libraries such as <samp class="listingcharacter listingcharacter">formidable</samp> also continues to work without any problems. <span class="crossreference "><a href="05_004.html#l5.31">Listing 5.31</a></span> shows the necessary adjustments to the source code.</p>
            <div class="listing " id="l5.31"><pre><span class="schwarz">...</span><span class="schwarz"><br/></span><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">import</span><span class="schwarz"> { createSecureServer } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'http2'</span><span class="schwarz">;</span><br/> </samp></span><br/><span class="rot">const</span><span class="schwarz"> options </span><span class="dunkelblau">=</span><span class="schwarz"> {</span><br/>  <span class="magenta">key</span><span class="schwarz">: readFileSync(</span><span class="hellblau">'./localhost.key'</span><span class="schwarz">),</span><br/>  cert: readFileSync(<span class="hellblau">'./localhost.cert'</span><span class="schwarz">),</span><br/>};<br/> <br/><span class="bold"><samp class="listingcharacter listingcharacter">createSecureServer</samp></span>(options, (request, response) <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>... <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 5.31</b>    
            Using the HTTP/2 Protocol (index.js)</p>
            <p class="standard">If you want to use the more modern variant of the <samp class="listingcharacter listingcharacter">http2</samp> module, you have to modify your initial file significantly more. In this case, you can’t use the <samp class="listingcharacter listingcharacter">request</samp> event as usual, but the <samp class="listingcharacter listingcharacter">stream</samp> event. In <span class="crossreference "><a href="05_004.html#l5.32">Listing 5.32</a></span>, you can see a shortened variant of the initial file, which only ensures that the list gets displayed.</p>
            <div class="listing " id="l5.32"><pre><span class="rot"><a id="p171"/>import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> </span><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter">constants</samp></span>, createSecureServer } <span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'http2'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> data </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./data.js'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> { getList } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./list.js'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> { parse } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'querystring'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> { readFile, readFileSync } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'fs'</span><span class="schwarz">;</span><br/> <br/><span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">const</span><span class="schwarz"> { </span><br/>  HTTP2_HEADER_PATH, <br/>  HTTP2_HEADER_STATUS, <br/>  HTTP2_HEADER_METHOD <br/>} <span class="dunkelblau">=</span><span class="schwarz"> constants;</span><br/> </samp></span><br/><span class="rot">const</span><span class="schwarz"> options </span><span class="dunkelblau">=</span><span class="schwarz"> {</span><br/>  <span class="magenta">key</span><span class="schwarz">: readFileSync(</span><span class="hellblau">'./localhost.key'</span><span class="schwarz">),</span><br/>  cert: readFileSync(<span class="hellblau">'./localhost.cert'</span><span class="schwarz">),</span><br/>};<br/> <br/><span class="rot">const</span><span class="schwarz"> server </span><span class="dunkelblau">=</span><span class="schwarz"> createSecureServer(options);</span><br/> <br/>server<br/>  .on(<span class="hellblau">'stream'</span><span class="schwarz">, (stream, headers) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>    <span class="rot">const</span><span class="schwarz"> parts </span><span class="dunkelblau">=</span><span class="schwarz"> headers[</span><span class="bold"><samp class="listingcharacter listingcharacter">HTTP2_HEADER_PATH</samp></span>].split(<span class="hellblau">'/'</span><span class="schwarz">);</span><br/>    <span class="rot">if</span><span class="schwarz"> (headers[</span><span class="bold"><samp class="listingcharacter listingcharacter">HTTP2_HEADER_PATH</samp></span>] <span class="dunkelblau">===</span><span class="schwarz"> </span><span class="hellblau">'/style.css'</span><span class="schwarz">) {</span><br/>      readFile(<span class="hellblau">'public/style.css'</span><span class="schwarz">, </span><span class="hellblau">'utf8'</span><span class="schwarz">, (err, data) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>        <span class="rot">if</span><span class="schwarz"> (err) {</span><br/>          stream.respond({<br/>            <span class="hellblau">'content-type'</span><span class="schwarz">: </span><span class="hellblau">'text/plain'</span><span class="schwarz">,</span><br/>            [<span class="bold"><samp class="listingcharacter listingcharacter">HTTP2_HEADER_STATUS</samp></span>]: 404,<br/>          });<br/>          stream.end();<br/>        } <span class="rot">else</span><span class="schwarz"> {</span><br/>          stream.end(data);<br/>        }<br/>      });<br/>    } <span class="rot">else</span><span class="schwarz"> </span><span class="rot">if</span><span class="schwarz"> (parts.includes(</span><span class="hellblau">'assets'</span><span class="schwarz">)) {</span><br/>      readFile(<br/>        <span class="violett">`public${headers[</span><span class="bold"><samp class="listingcharacter listingcharacter">HTTP2_HEADER_PATH</samp></span>].replaceAll(<span class="hellblau">'%20'</span><span class="violett">, </span><span class="hellblau">' '</span><span class="violett">)}`</span><span class="schwarz">,</span><br/>        (err, data) <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>          <span class="rot">if</span><span class="schwarz"> (err) {</span><br/>            <span class="magenta">console</span><span class="schwarz">.log(err);</span><br/>            stream.respond({<br/>              [<span class="bold"><samp class="listingcharacter listingcharacter">HTTP2_HEADER_STATUS</samp></span>]: 404,<br/>            });<br/>            stream.end();<br/><a id="p172"/>          } <span class="rot">else</span><span class="schwarz"> {</span><br/>            stream.end(data);<br/>          }<br/>        },<br/>      );<br/>    } <span class="rot">else</span><span class="schwarz"> {</span><br/>      send(stream, getList(data.addresses));<br/>    }<br/>  })<br/>  .listen(8080, () <span class="dunkelblau">=&gt;</span><span class="schwarz"><br/></span>    <span class="magenta">console</span><span class="schwarz">.log(</span><span class="hellblau">'Address book reachable at https://localhost:8080'</span><span class="schwarz">),</span><br/>  );<br/> <br/><span class="rot">function</span><span class="schwarz"> send(stream, responseBody) {</span><br/>  stream.respond({<br/>    <span class="hellblau">'content-type'</span><span class="schwarz">: </span><span class="hellblau">'text/html'</span><span class="schwarz">,</span><br/>    [<span class="bold"><samp class="listingcharacter listingcharacter">HTTP2_HEADER_STATUS</samp></span>]: 200,<br/>  });<br/>  stream.end(responseBody);<br/>} <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 5.32</b>    
            List Display via HTTP2 (index.js)</p>
            <p class="standard">The most important difference is that the HTTP/2 server supports the <samp class="listingcharacter listingcharacter">stream</samp> event in addition to the <samp class="listingcharacter listingcharacter">request</samp> event, which is largely compatible with the <samp class="listingcharacter listingcharacter">http</samp> and <samp class="listingcharacter listingcharacter">https</samp> modules. This event is triggered when a request is made through an HTTP/2 session<a class="indexanchor" id="i05_98"/> and is similar to the <samp class="listingcharacter listingcharacter">request</samp> event—the only difference being that this is a socket connection<a class="indexanchor" id="i05_99"/>. In the event handler, you have access to the stream representation and the headers. For example, you can use the stream to formulate the response to the client. The headers provide access to the URL path or the requested HTTP method. The header information is read via constants<a class="indexanchor" id="i05_100"/> defined in the <samp class="listingcharacter listingcharacter">http2</samp> module. In the example, the <samp class="listingcharacter listingcharacter">HTTP2_HEADER_PATH</samp> constant is used to access the URL path. Using the <samp class="listingcharacter listingcharacter">respond</samp> method of the stream, you can send a part of the response. The constants of the <samp class="listingcharacter listingcharacter">http2</samp> module are also used to generate the response. The specification of <samp class="listingcharacter listingcharacter">[HTTP2_HEADER_STATUS]: 404</samp> is a <span class="italic">computed property</span><a class="indexanchor" id="i05_101"/>, that is, a computed property name, which ensures that the value behind the constant is used as an object property. Calling the <samp class="listingcharacter listingcharacter">end</samp> method completes the response. Once you’ve made the adjustments to the source code, you can start the server and test your application.</p>
            <p class="standard">In <span class="crossreference "><a href="05_004.html#f5.11">Figure 5.11</a></span>, you can see the application delivered via HTTP/2. When you open the developer tools of your browser, you’ll see <span class="screenelement">h2</span> entries in the <span class="screenelement">Protocol</span> column of the <span class="screenelement">Network</span> section. These entries represent the HTTP/2 protocol.</p>
            <div class="imagebox figure-type"><a href="img-f5.11.html" id="f5.11"><img alt="Delivery of the Application via HTTP/2" id="img-f5.11" src="bilderklein/klein05_011.png"/></a></div>
            <p class="caption "><b>Figure 5.11</b>    
            <a id="p173"/>Delivery of the Application via HTTP/2</p>
        
        
            <h3 class="t3" id="h5.4.2">5.4.2    HTTP/2 Client<a class="indexanchor" id="i05_102"/></h3>
            <p class="standard">Like the <samp class="listingcharacter listingcharacter">http</samp> module, the <samp class="listingcharacter listingcharacter">http2</samp> module can assume the role of an HTTP client and query other servers. For the following example, you must start the HTTP/2 server you created in <span class="crossreference "><a href="05_004.html#l5.32">Listing 5.32</a></span>. Then you must create the HTTP/2 client using the source code from <span class="crossreference "><a href="05_004.html#l5.33">Listing 5.33</a></span>.</p>
            <div class="listing " id="l5.33"><pre><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> connect</span><span class="schwarz">,</span><span class="schwarz"> constants </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'http2'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> readFileSync </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'fs'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> cheerio </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'cheerio'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="rot">const</span><span class="schwarz"> client </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="schwarz">connect(</span><span class="hellblau">'https://localhost:8080'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  ca<span class="schwarz">:</span><span class="schwarz"> </span><span class="schwarz">readFileSync(</span><span class="hellblau">'./localhost.cert'</span><span class="schwarz">),</span><span class="schwarz"><br/></span><span class="schwarz">});</span><span class="schwarz"><br/></span><a id="p174"/>client<span class="schwarz">.on(</span><span class="hellblau">'error'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">err</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="magenta">console</span><span class="schwarz">.error(</span><span class="schwarz">err</span><span class="schwarz">));</span><span class="schwarz"><br/></span> <br/><span class="rot">const</span><span class="schwarz"> req </span><span class="dunkelblau">=</span><span class="schwarz"> client</span><span class="schwarz">.request({</span><span class="schwarz"> </span><span class="schwarz">[</span><span class="schwarz">constants</span><span class="schwarz">.</span><span class="schwarz">HTTP2_HEADER_PATH</span><span class="schwarz">]:</span><span class="schwarz"> </span><span class="hellblau">'/'</span><span class="schwarz"> </span><span class="schwarz">});</span><span class="schwarz"><br/></span> <br/>req<span class="schwarz">.setEncoding(</span><span class="hellblau">'utf8'</span><span class="schwarz">);</span><span class="schwarz"><br/></span><span class="rot">let</span><span class="schwarz"> body </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="hellblau">''</span><span class="schwarz">;</span><span class="schwarz"><br/></span>req<span class="schwarz">.on(</span><span class="hellblau">'data'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">chunk</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  body <span class="dunkelblau">+=</span><span class="schwarz"> chunk</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="schwarz">});</span><span class="schwarz"><br/></span>req<span class="schwarz">.on(</span><span class="hellblau">'end'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">()</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="rot">const</span><span class="schwarz"> addresses </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="schwarz">[];</span><span class="schwarz"><br/></span>  <span class="rot">const</span><span class="schwarz"> $ </span><span class="dunkelblau">=</span><span class="schwarz"> cheerio</span><span class="schwarz">.load(</span><span class="schwarz">body</span><span class="schwarz">);</span><span class="schwarz"><br/></span>  <span class="rot">const</span><span class="schwarz"> tr </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="orange">$</span><span class="schwarz">(</span><span class="hellblau">'tr'</span><span class="schwarz">);</span><span class="schwarz"><br/></span>  tr<span class="schwarz">.each((</span><span class="schwarz">index</span><span class="schwarz">,</span><span class="schwarz"> element</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="rot">if</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">index </span><span class="dunkelblau">===</span><span class="schwarz"> </span><span class="schwarz">0)</span><span class="schwarz"> </span><span class="rot">return</span><span class="schwarz">;</span><span class="schwarz"><br/></span>    addresses<span class="schwarz">.push({</span><span class="schwarz"><br/></span>      id<span class="schwarz">:</span><span class="schwarz"> element</span><span class="schwarz">.</span><span class="schwarz">children</span><span class="schwarz">[3].</span><span class="schwarz">children</span><span class="schwarz">[0].</span><span class="schwarz">data</span><span class="schwarz">,</span><span class="schwarz"><br/></span>      firstname<span class="schwarz">:</span><span class="schwarz"> element</span><span class="schwarz">.</span><span class="schwarz">children</span><span class="schwarz">[5].</span><span class="schwarz">children</span><span class="schwarz">[0].</span><span class="schwarz">data</span><span class="schwarz">,</span><span class="schwarz"><br/></span>      lastname<span class="schwarz">:</span><span class="schwarz"> element</span><span class="schwarz">.</span><span class="schwarz">children</span><span class="schwarz">[7].</span><span class="schwarz">children</span><span class="schwarz">[0].</span><span class="schwarz">data</span><span class="schwarz">,</span><span class="schwarz"><br/></span>    <span class="schwarz">});</span><span class="schwarz"><br/></span>  <span class="schwarz">});</span><span class="schwarz"><br/></span> <br/>  <span class="magenta">console</span><span class="schwarz">.log(</span><span class="schwarz">addresses</span><span class="schwarz">);</span><span class="schwarz"><br/></span><span class="schwarz">});</span><span class="schwarz"><br/></span>req<span class="schwarz">.end();</span><span class="schwarz"> </span></pre></div>
            <p class="caption "><b>Listing 5.33</b>    
            HTTP/2 Client for Querying the Address List</p>
            <p class="standard">To make a request to an HTTP/2 server, you must first establish a connection<a class="indexanchor" id="i05_103"/>. This can be done via the <samp class="listingcharacter listingcharacter">connect</samp> method to which you pass the target server. In the example, self-signed certificates are used, which usually leads to the termination of the connection. For this reason, you must define the <samp class="listingcharacter listingcharacter">ca</samp> key in the second argument and pass the server certificate.</p>
            <p class="standard">You can start the actual request using the <samp class="listingcharacter listingcharacter">request</samp> method. In this context, you must pass an object with the computed property <samp class="listingcharacter listingcharacter">HTTP2_HEADER_PATH</samp> from the HTTP/2 constants and the value <samp class="listingcharacter listingcharacter">/</samp>. On the data stream thus generated, you must then bind a handler to each of the <samp class="listingcharacter listingcharacter">data</samp> and <samp class="listingcharacter listingcharacter">end</samp> events. In the <samp class="listingcharacter listingcharacter">data</samp> handler, you collect the data that you receive from the server as a response. In the <samp class="listingcharacter listingcharacter">end</samp> handler, you process this data with the <samp class="listingcharacter listingcharacter">cheerio</samp> package; read the <samp class="listingcharacter listingcharacter">id</samp>, <samp class="listingcharacter listingcharacter">firstname</samp>, and <samp class="listingcharacter listingcharacter">lastname</samp> information from the table, as shown earlier in <span class="crossreference "><a href="05_002.html#l5.27">Listing 5.27</a></span>; and output it to the console.</p>
        
    </div><p class="signatur"/>
                    </body>
                </html>