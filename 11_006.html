<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
                    
        <head><meta content="application/xhtml+xml; charset=utf-8" http-equiv="Content-Type"/>
            <meta content="application/xhtml+xml; charset=utf-8" name="content-type"/>
            <meta content="GraphQL" name="title"/>
            <meta content="Sebastian Springer" name="author"/>
            <meta content="Rheinwerk Publishing" name="publisher"/>
            <meta content="© 2022 by Rheinwerk Publishing Inc., Boston (MA)" name="copyright"/>
            <meta content="Node.js - The Comprehensive Guide - GraphQL" name="description"/>
            <meta content="en" name="language"/>
            <title>GraphQL</title>
            <link href="common/main.css" rel="stylesheet" type="text/css"/>
<meta content="urn:uuid:e0000000-0000-0000-0000-000029756394" name="Adept.expected.resource"/>
        </head>
    


                    <body class="office_us type_kapitel">
                        <div id="main">
        <h2 class="t2" id="h11.6">11.6    Authentication for the GraphQL Interface<a class="indexanchor" id="i11_36"/></h2>
        <p class="standard">The integration of GraphQL is done via regular middleware<a class="indexanchor" id="i11_37"/>, which means you can combine it with other middleware software such as a logger or even authentication. All you need to do for this is to secure the <span class="italic">/graphql</span> route. In our example, you use the <samp class="listingcharacter listingcharacter">express-jwt</samp><a class="indexanchor" id="i11_38"/> package to secure the interface like you did with the REST interface. <span class="crossreference "><a href="11_006.html#l11.13">Listing 11.13</a></span> shows how you can include it in the <span class="italic">index.js</span> file.</p>
        <div class="listing " id="l11.13"><pre><span class="rot">import</span><span class="schwarz"> express </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'express'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> morgan </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'morgan'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> expressJwt </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'express-jwt'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> swaggerUi </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'swagger-ui-express'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> router </span><span class="rot">as</span><span class="schwarz"> movieRouter </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./movie/index.js'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> router </span><span class="rot">as</span><span class="schwarz"> loginRouter </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./auth.js'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot"><a id="p354"/>import</span><span class="schwarz"> swaggerSpec </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./swagger.js'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> graphql </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./graphql.js'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="rot">const</span><span class="schwarz"> app </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="schwarz">express();</span><span class="schwarz"><br/></span> <br/>app<span class="schwarz">.use(morgan(</span><span class="hellblau">'common'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> immediate</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="rot">true</span><span class="schwarz"> </span><span class="schwarz">}));</span><span class="schwarz"><br/></span> <br/>app<span class="schwarz">.use(</span><span class="schwarz">express</span><span class="schwarz">.json());</span><span class="schwarz"><br/></span> <br/>app<span class="schwarz">.use(</span><span class="hellblau">'/login'</span><span class="schwarz">,</span><span class="schwarz"> loginRouter</span><span class="schwarz">);</span><span class="schwarz"><br/></span>app<span class="schwarz">.use(</span><span class="schwarz"><br/></span>  <span class="hellblau">'/movie'</span><span class="schwarz">,</span><span class="schwarz"><br/></span>  <span class="schwarz">expressJwt({</span><span class="schwarz"> secret</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'secret'</span><span class="schwarz">,</span><span class="schwarz"> algorithms</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="schwarz">[</span><span class="hellblau">'HS256'</span><span class="schwarz">]</span><span class="schwarz"> </span><span class="schwarz">}),</span><span class="schwarz"><br/></span>  movieRouter<span class="schwarz">,</span><span class="schwarz"><br/></span><span class="schwarz">);</span><span class="schwarz"><br/></span> <br/>app<span class="schwarz">.use((</span><span class="schwarz">err</span><span class="schwarz">,</span><span class="schwarz"> request</span><span class="schwarz">,</span><span class="schwarz"> response</span><span class="schwarz">,</span><span class="schwarz"> next</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="rot">if</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">err</span><span class="schwarz">.</span><span class="schwarz">name </span><span class="dunkelblau">===</span><span class="schwarz"> </span><span class="hellblau">'UnauthorizedError'</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    response<span class="schwarz">.status(401).json(</span><span class="hellblau">'unauthorized'</span><span class="schwarz">);</span><span class="schwarz"><br/></span>  <span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">else</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="schwarz">next();</span><span class="schwarz"><br/></span>  <span class="schwarz">}</span><span class="schwarz"><br/></span><span class="schwarz">});</span><span class="schwarz"><br/></span> <br/>app<span class="schwarz">.get(</span><span class="hellblau">'/'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">request</span><span class="schwarz">,</span><span class="schwarz"> response</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> response</span><span class="schwarz">.redirect(</span><span class="hellblau">'/movie'</span><span class="schwarz">));</span><span class="schwarz"><br/></span> <br/>app<span class="schwarz">.use(</span><span class="hellblau">'/api-docs'</span><span class="schwarz">,</span><span class="schwarz"> swaggerUi</span><span class="schwarz">.</span><span class="schwarz">serve</span><span class="schwarz">,</span><span class="schwarz"> swaggerUi</span><span class="schwarz">.setup(</span><span class="schwarz">swaggerSpec</span><span class="schwarz">));</span><span class="schwarz"><br/></span> <br/>app<span class="schwarz">.use(</span><span class="schwarz"><br/></span>  <span class="hellblau">'/graphql'</span><span class="schwarz">,</span><span class="schwarz"><br/></span>  <span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter">expressJwt({ secret: <span class="hellblau">'secret'</span><span class="schwarz">, algorithms: [</span><span class="hellblau">'HS256'</span><span class="schwarz">] }),</span></samp></span><br/>  graphql,<br/>);<br/> <br/>app.listen(8080, () <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>  <span class="magenta">console</span><span class="schwarz">.log(</span><span class="hellblau">'Server is listening to http://localhost:8080'</span><span class="schwarz">);</span><br/>}); <span class="schwarz"/></pre></div>
        <p class="caption "><b>Listing 11.13</b>    
            Securing the GraphQL Interface (index.js)</p>
        <p class="standard">If you access GraphiQL or the interface via cURL with this change, you’ll receive a response with an <samp class="listingcharacter listingcharacter">UnauthorizedError</samp><a class="indexanchor" id="i11_39"/> and status code <samp class="listingcharacter listingcharacter">401</samp>, which means you’re trying to access GraphQL without a valid token. To solve this problem, you first need to get a token. This can be done using the cURL call from <span class="crossreference "><a href="11_006.html#l11.14">Listing 11.14</a></span>.</p>
        <div class="listing " id="l11.14"><pre><a id="p355"/>$ <span class="bold"><samp class="listingcharacter listingcharacter">curl <br/>  -X POST <br/>  -H "Content-Type: application/json" <br/>  -d '{"username": "sspringer", "password": "test"}' <br/>  http://localhost:8080/login<br/></samp></span><br/>{"token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MSwiZmlyc3RuYW1lIjoiU2ViYXN0aWFuIiwibGFzdG5hbWUiOiJTcHJpbmdlciIsInVzZXJuYW1lIjoic3NwcmluZ2VyIiwiaWF0IjoxNjMyMDgxMzAxfQ.Hby4jag13i5ELdq-Ga8NK3vrOGpLKJyKzi6zfariAzQ"} </pre></div>
        <p class="caption "><b>Listing 11.14</b>    
            Logging In to the Application</p>
        <p class="standard">Using the token you obtain from your application, you can now communicate with the GraphQL interface, as shown in <span class="crossreference "><a href="11_006.html#l11.15">Listing 11.15</a></span>, for example.</p>
        <div class="listing " id="l11.15"><pre>$ <span class="bold"><samp class="listingcharacter listingcharacter">curl <br/>  -X POST <br/>  -H "Content-Type: application/json" <br/>  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MSwiZm lyc3RuYW1lIjoiU2ViYXN0aWFuIiwibGFzdG5hbWUiOiJTcHJpbmdlciIsInVzZXJuYW1lIjoic3NwcmluZ2VyIiwiaWF0IjoxNjMyMDgxMzAxfQ.Hby4jag13i5ELdq-Ga8NK3vrOGpLKJyKzi6zfariAzQ" <br/>  -d '{"query": "{ movie(id: 2) { id title year } }"}'<br/>  http://localhost:8080/graphql <br/></samp></span><br/>{"data":{<br/>  "movie":[{<br/>    "id":2,<br/>    "title":"Thor",<br/>    "year":2011<br/>  }]<br/>}} </pre></div>
        <p class="caption "><b>Listing 11.15</b>    
            Authorized Query of the GraphQL Interface</p>
        <p class="standard">With these adjustments to the source code, it’s now no longer possible to use the interface without a valid login. Your interface thus has a certain basic protection, which you can now extend as you wish, for example, by implementing a roles and permissions system that allows a more fine-grained access control.</p>
    </div><p class="signatur"/>
                    </body>
                </html>