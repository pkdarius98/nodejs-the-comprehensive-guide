<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
                    
        <head><meta content="application/xhtml+xml; charset=utf-8" http-equiv="Content-Type"/>
            <meta content="application/xhtml+xml; charset=utf-8" name="content-type"/>
            <meta content="Connecting Databases" name="title"/>
            <meta content="Sebastian Springer" name="author"/>
            <meta content="Rheinwerk Publishing" name="publisher"/>
            <meta content="© 2022 by Rheinwerk Publishing Inc., Boston (MA)" name="copyright"/>
            <meta content="Node.js - The Comprehensive Guide - Connecting Databases" name="description"/>
            <meta content="en" name="language"/>
            <title>Connecting Databases</title>
            <link href="common/main.css" rel="stylesheet" type="text/css"/>
<meta content="urn:uuid:e0000000-0000-0000-0000-000029756394" name="Adept.expected.resource"/>
        </head>
    


                    <body class="office_us type_kapitel">
                        <div id="main">
        <h2 class="t2" id="h8.2">8.2    Node.js and Nonrelational Databases<a class="indexanchor" id="i08_78"/></h2>
        <p class="standard">For a long time, relational databases were the only widely used way of storing data in a structured way and making it available again for quick access. In the meantime, however, another type of database has established itself on the market. These types of databases are deliberately based on a different approach. Unlike relational databases with their fixed table structures, nonrelational databases don’t impose such a structure, and data is organized in other ways, for example, in the form of documents.</p>
        <p class="standard">Often, nonrelational databases store object or document structures that you can access using specific key or index values. These are summarized under the collective term <span class="italic">NoSQL</span><a class="indexanchor" id="i08_79"/>. In the following sections, you’ll get to know Redis and MongoDB—two representatives of the nonrelational database category.</p>
        
            <h3 class="t3" id="h8.2.1">8.2.1    Redis<a class="indexanchor" id="i08_80"/></h3>
            <p class="standard">At its core, Redis is a simple key-value store<a class="indexanchor" id="i08_81"/> that allows you to save values and to provide them with a key. This key then enables you to access the corresponding value again.</p>
            <p class="standard">Redis stores the values in memory<a class="indexanchor" id="i08_82"/>, which results in very good performance for read and write operations. The drawback of this technology is that the has RAM contents are irretrievably lost after a system crash. However, the developers of Redis have found a very elegant solution to this problem. The system can write a backup copy<a class="indexanchor" id="i08_83"/> of the database to the hard disk at definable times, from which it’s easy to restore the contents.</p>
            <p class="standard">Redis is primarily available for Portable Operating System Interface (POSIX) systems, such as Linux, Berkeley Source Distribution (BSD), or macOS, and is even developed on these systems. Although there is a version of the Redis server available for Windows, it isn’t very well supported. As an alternative to installing Redis, you can also run it in a Docker container<a class="indexanchor" id="i08_84"/>. The developers of Redis provide official images for this purpose. To launch a container, you must execute the command shown in <span class="crossreference "><a href="08_002.html#l8.17">Listing 8.17</a></span> on the command line.</p>
            <div class="listing " id="l8.17"><pre><span class="violett">docker run </span><br/>  --name redis <br/> <span class="dunkelblau"> -v</span><span class="violett"> db-data:/data </span><br/> <span class="dunkelblau"> -p</span><span class="violett"> 6379:6379 </span><br/> <span class="dunkelblau"> -d</span><span class="violett"> </span><br/>  redis:latest<span class="schwarz"> </span></pre></div>
            <p class="caption "><b>Listing 8.17</b>    
            Launching a Redis Container</p>
            
                <h4 class="t4" id="h8.2.1.1"><a id="p261"/>Installation<a class="indexanchor" id="i08_85"/></h4>
                <p class="standard">Like the other drivers for databases, the Redis client for Node.js is also available as an npm package and can be installed via the command line using <samp class="listingcharacter listingcharacter">npm install redis</samp>. Once you’ve installed the Redis server and the npm package with the Redis client<a class="indexanchor" id="i08_86"/> on your system and started Redis, you can use Redis in your Node.js application.</p>
                <p class="standard">Because Redis isn’t based on any fixed structures, you don’t need to perform any further operations to initialize a database but can directly take care of connecting to the server.</p>
            
            
                <h4 class="t4" id="h8.2.1.2">Establishing<a class="indexanchor" id="i08_87"/> a Connection</h4>
                <p class="standard"><span class="crossreference "><a href="08_002.html#l8.18">Listing 8.18</a></span> shows how you can set up a connection to a local Redis server in your <span class="italic">movie/model.js</span> file.</p>
                <div class="listing " id="l8.18"><pre><span class="rot">const</span><span class="schwarz"> redis </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="schwarz">require(</span><span class="hellblau">'redis'</span><span class="schwarz">);</span><span class="schwarz"><br/></span><span class="rot">const</span><span class="schwarz"> client </span><span class="dunkelblau">=</span><span class="schwarz"> redis</span><span class="schwarz">.createClient();</span><span class="schwarz"><br/></span><br/>client<span class="schwarz">.on(</span><span class="hellblau">'error'</span><span class="schwarz">,</span><span class="schwarz"> error </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="magenta">console</span><span class="schwarz">.error(</span><span class="schwarz">error</span><span class="schwarz">));</span><span class="schwarz"> </span></pre></div>
                <p class="caption "><b>Listing 8.18</b>    
            Connecting to the Redis Server</p>
                <p class="standard">You can also optionally pass the address of a remote server or a reference to a Unix socket to the <samp class="listingcharacter listingcharacter">createClient</samp><a class="indexanchor" id="i08_88"/> method, depending on how you want to address the server. For our example, a local connection is established via port 6379<a class="indexanchor" id="i08_89"/> without any further specifications.</p>
                <p class="standard">Communication is asynchronous and event-based. Strictly speaking, this means you can bind callback functions to different events and thus react to every single event. <span class="crossreference "><a href="08_002.html#l8.18">Listing 8.18</a></span> shows this on the basis of the <samp class="listingcharacter listingcharacter">error</samp> event that is triggered if an error occurs when connecting to the Redis server. Other events<a class="indexanchor" id="i08_90"/> you can react to are <samp class="listingcharacter listingcharacter">ready</samp>, <samp class="listingcharacter listingcharacter">connect</samp>, <samp class="listingcharacter listingcharacter">end</samp>, <samp class="listingcharacter listingcharacter">drain</samp>, and <samp class="listingcharacter listingcharacter">idle</samp>.</p>
                <p class="standard">When you no longer need the connection to the server, you should terminate it by calling the <samp class="listingcharacter listingcharacter">exit</samp> or <samp class="listingcharacter listingcharacter">quit</samp> method. Otherwise, the connection is kept open, and the application isn’t closed. The difference between the two methods is that <samp class="listingcharacter listingcharacter">exit</samp> terminates the connection immediately, regardless of whether responses from the server are still pending or not. <samp class="listingcharacter listingcharacter">quit</samp>, on the other hand, waits until all responses from the server have been received and then terminates the connection.</p>
            
            
                <h4 class="t4" id="h8.2.1.3">Creating<a class="indexanchor" id="i08_91"/> and Editing Data Records<a class="indexanchor" id="i08_92"/></h4>
                <p class="standard">You can use the <samp class="listingcharacter listingcharacter">set</samp> method to create new data records in Redis; if a data record with the specified key already exists, it will be overwritten<a class="indexanchor" id="i08_93"/>. To access your data records, you should choose a unique key. <span class="crossreference "><a href="08_002.html#l8.19">Listing 8.19</a></span> shows how to use the <samp class="listingcharacter listingcharacter">set</samp> method.</p>
                <div class="listing " id="l8.19"><pre><span class="rot"><a id="p262"/>import</span><span class="schwarz"> redis </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'redis'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="rot">const</span><span class="schwarz"> client </span><span class="dunkelblau">=</span><span class="schwarz"> redis</span><span class="schwarz">.createClient();</span><span class="schwarz"><br/></span> <br/>client<span class="schwarz">.on(</span><span class="hellblau">'error'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">error</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="magenta">console</span><span class="schwarz">.error(</span><span class="schwarz">error</span><span class="schwarz">));</span><span class="schwarz"><br/></span> <br/><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">export</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> getAll() {</span><br/>  <span class="rot">return</span><span class="schwarz"> Promise.resolve([]);</span><br/>}<br/> </samp></span><br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> get(id) {}</span><br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> remove(id) {}</span><br/> <br/><span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">export</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> save(movie) {</span><br/>  <span class="rot">return</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">Promise((resolve, reject) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>    <span class="rot">if</span><span class="schwarz"> (</span><span class="dunkelblau">!</span><span class="schwarz">movie.id) {</span><br/>      movie.id <span class="dunkelblau">=</span><span class="schwarz"> Date.now();</span><br/>    }<br/>    client.set(movie.id, JSON.stringify(movie), (error) <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>      <span class="rot">if</span><span class="schwarz"> (error) {</span><br/>        reject(error);<br/>      } <span class="rot">else</span><span class="schwarz"> {</span><br/>        resolve();<br/>      }<br/>    });<br/>  });<br/>}</samp></span> <span class="schwarz"/></pre></div>
                <p class="caption "><b>Listing 8.19</b>    
            Creating a Data Record in Redis (movie/model.js)</p>
                <p class="standard">For the example to work in general, the first step is to make sure that the <samp class="listingcharacter listingcharacter">getAll</samp> function returns a promise object with an array; otherwise, the template engine will return an exception.</p>
                <p class="standard">First, you must create a promise object<a class="indexanchor" id="i08_94"/> inside the <samp class="listingcharacter listingcharacter">save</samp> method, which you use as a return value. Within the callback function, you use the <samp class="listingcharacter listingcharacter">set</samp> method of Redis, which receives a total of three arguments. The first argument is a character string that specifies the key you can later use to access the data you pass in the second argument again. Finally, the third argument is a callback function that is executed as soon as the server sends a response. This callback function receives two values: the first one is an error object<a class="indexanchor" id="i08_95"/>, and the second is the server’s response. If no problems occurred while inserting the data, you’ll get the string <samp class="listingcharacter listingcharacter">OK</samp>.</p>
                <p class="standard">Because it’s only possible to create new data records or to completely overwrite existing ones, you merely need to check in the <samp class="listingcharacter listingcharacter">save</samp> method whether the passed object <a id="p263"/>already has an <samp class="listingcharacter listingcharacter">id</samp> property. In this case, you use it as a key; otherwise, you must generate a current time stamp and use that as a key. The problem with this solution is that it isn’t possible to create two data records in the same millisecond. For the movie database, this doesn’t cause any problems, but for an application with more users, you should use a different alternative for generating unique keys at this point, such as the <samp class="listingcharacter listingcharacter">uuid</samp> or <samp class="listingcharacter listingcharacter">shortid</samp> packages.</p>
                <p class="standard">For editing records, you must also implement the reading of a single record by its ID in addition to the storage routine. In the <samp class="listingcharacter listingcharacter">get</samp> function in the <span class="italic">movie/model.js</span> file, you can use the <samp class="listingcharacter listingcharacter">get</samp> method of the Redis client to do this. To leave the interface unchanged from the previous examples, you should embed the query in a promise. <span class="crossreference "><a href="08_002.html#l8.20">Listing 8.20</a></span> contains the corresponding source code.</p>
                <div class="listing " id="l8.20"><pre><span class="rot">import</span><span class="schwarz"> redis </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'redis'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="rot">const</span><span class="schwarz"> client </span><span class="dunkelblau">=</span><span class="schwarz"> redis</span><span class="schwarz">.createClient();</span><span class="schwarz"><br/></span> <br/>client<span class="schwarz">.on(</span><span class="hellblau">'error'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">error</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="magenta">console</span><span class="schwarz">.error(</span><span class="schwarz">error</span><span class="schwarz">));</span><span class="schwarz"><br/></span> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">getAll()</span><span class="schwarz"> </span><span class="schwarz">{...}</span><span class="schwarz"><br/></span> <br/><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">export</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> get(id) {</span><br/>  <span class="rot">return</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">Promise((resolve, reject) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>    client.get(id, (err, data) <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>      <span class="rot">if</span><span class="schwarz"> (error) {</span><br/>        reject(error);<br/>      } <span class="rot">else</span><span class="schwarz"> {</span><br/>        resolve(JSON.parse(data));<br/>      }<br/>    });<br/>  });<br/>}<br/> </samp></span><br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> remove(id) {}</span><br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> save(movie) {...} </span><span class="schwarz"/></pre></div>
                <p class="caption "><b>Listing 8.20</b>    
            Reading a Data Record (movie/model.js)</p>
            
            
                <h4 class="t4" id="h8.2.1.4">Reading Data Records<a class="indexanchor" id="i08_96"/></h4>
                <p class="standard">In <span class="crossreference "><a href="08_002.html#l8.20">Listing 8.20</a></span>, you’ve already seen how you can read individual records from a Redis database. However, for the display of the total list, you need to go one step further. You can use the <samp class="listingcharacter listingcharacter">keys</samp> method of the Redis client to read all the keys<a class="indexanchor" id="i08_97"/> of the database and use this information to get to the individual data records. <span class="crossreference "><a href="08_002.html#l8.21">Listing 8.21</a></span> shows the implementation of the <samp class="listingcharacter listingcharacter">getAll</samp> function.</p>
                <div class="listing " id="l8.21"><pre><span class="rot"><a id="p264"/>import</span><span class="schwarz"> redis </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'redis'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="rot">const</span><span class="schwarz"> client </span><span class="dunkelblau">=</span><span class="schwarz"> redis</span><span class="schwarz">.createClient();</span><span class="schwarz"><br/></span> <br/>client<span class="schwarz">.on(</span><span class="hellblau">'error'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">error</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="magenta">console</span><span class="schwarz">.error(</span><span class="schwarz">error</span><span class="schwarz">));</span><span class="schwarz"><br/></span> <br/><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">export</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> getAll() {</span><br/>  <span class="rot">return</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">Promise((resolve, reject) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>    client.keys(<span class="hellblau">'*'</span><span class="schwarz">, (error, keys) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>      <span class="rot">const</span><span class="schwarz"> promises </span><span class="dunkelblau">=</span><span class="schwarz"> keys.map((</span><span class="magenta">key</span><span class="schwarz">) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> get(</span><span class="magenta">key</span><span class="schwarz">));</span><br/>      Promise.all(promises).then(<br/>        (values) <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>          resolve(values);<br/>        },<br/>        (error) <span class="dunkelblau">=&gt;</span><span class="schwarz"> reject(error),</span><br/>      );<br/>    });<br/>  });<br/>}<br/> </samp></span><br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> get(id) {...}</span><br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> remove(id) {}</span><br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> save(movie) {...} </span><span class="schwarz"/></pre></div>
                <p class="caption "><b>Listing 8.21</b>    
            Reading All Data Records (movie/model.js)</p>
            
            
                <h4 class="t4" id="h8.2.1.5">Removing Data Records<a class="indexanchor" id="i08_98"/></h4>
                <p class="standard">The Redis server command set includes the <samp class="listingcharacter listingcharacter">del</samp> command, which you can use to remove entries from your database. <span class="crossreference "><a href="08_002.html#l8.22">Listing 8.22</a></span> describes the use of the <samp class="listingcharacter listingcharacter">del</samp> method using a simple example.</p>
                <div class="listing " id="l8.22"><pre><span class="rot">import</span><span class="schwarz"> redis </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'redis'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="rot">const</span><span class="schwarz"> client </span><span class="dunkelblau">=</span><span class="schwarz"> redis</span><span class="schwarz">.createClient();</span><span class="schwarz"><br/></span> <br/>client<span class="schwarz">.on(</span><span class="hellblau">'error'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">error</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="magenta">console</span><span class="schwarz">.error(</span><span class="schwarz">error</span><span class="schwarz">));</span><span class="schwarz"><br/></span> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">getAll()</span><span class="schwarz"> </span><span class="schwarz">{...}</span><span class="schwarz"><br/></span> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">get(</span><span class="schwarz">id</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{...}</span><span class="schwarz"><br/></span> <br/><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">export</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> remove(id) {</span><br/>  <span class="rot">return</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">Promise((resolve, reject) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/><a id="p265"/>    client.del(id, (error) <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>      <span class="rot">if</span><span class="schwarz"> (error) {</span><br/>        reject(error);<br/>      } <span class="rot">else</span><span class="schwarz"> {</span><br/>        resolve();<br/>      }<br/>    });<br/>  });<br/>}<br/> </samp></span><br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> save(movie) {...} </span><span class="schwarz"/></pre></div>
                <p class="caption "><b>Listing 8.22</b>    
            Deleting Data Records from the Redis Database (movie/model.js)</p>
                <p class="standard">To remove a data record from your database, you must pass the <samp class="listingcharacter listingcharacter">del</samp> method the key of the record you want to delete. As a second argument, this method accepts a callback function that will be executed once the deletion is done. Here you get access to both an error object and the number of data records deleted during this operation.</p>
                <p class="standard">Through the Redis client, you can access the entire command set<a class="indexanchor" id="i08_99"/> provided by the Redis server. For example, you can create and work with hashes and lists. If you want to learn more about Redis, <span class="url"><a href="http://redis.io">http://redis.io</a></span> is a good place to start.</p>
                <p class="standard">With MongoDB, you’ll get to know another representative of nonrelational databases in the following sections.</p>
            
        
        
            <h3 class="t3" id="h8.2.2">8.2.2    MongoDB<a class="indexanchor" id="i08_100"/></h3>
            <p class="standard">MongoDB is a representative of document-based databases<a class="indexanchor" id="i08_101"/>. This means that the storage of information in this database is based on documents that exist in Binary JavaScript Object Notation (BSON) format<a class="indexanchor" id="i08_102"/>. For more information about this format, visit <span class="url"><a href="http://bsonspec.org">http://bsonspec.org</a></span>.</p>
            <p class="standard">MongoDB is also suitable for larger applications due to its good performance and also comes with some additional features such as clustering<a class="indexanchor" id="i08_103"/> and sharding<a class="indexanchor" id="i08_104"/>, which provide decisive advantages, especially for very large data volumes.</p>
            <p class="standard">MongoDB is available for a wide variety of operating systems, including Linux, Windows, Solaris, and macOS. So, you can install MongoDB on any system that also runs Node.js. If you don’t want to install MongoDB on your system, but you can launch Docker containers<a class="indexanchor" id="i08_105"/> on it, you can also run MongoDB as a container. As with the other databases, official images are available for you to use. Use the command from <span class="crossreference "><a href="08_002.html#l8.23">Listing 8.23</a></span> to launch the container.</p>
            <div class="listing " id="l8.23"><pre>docker run <br/>  --name mongo <br/>  -v db-data:/data/db <br/><a id="p266"/>  -p 27017:27017 <br/>  -d <br/>  mongo:latest </pre></div>
            <p class="caption "><b>Listing 8.23</b>    
            Launching the MongoDB Container</p>
            
                <h4 class="t4" id="h8.2.2.1">Installation<a class="indexanchor" id="i08_106"/></h4>
                <p class="standard">Once you’ve installed the server software of MongoDB on your system and started the server process, all you need is a driver to access your database. For Node.js, a driver implemented in JavaScript exists as an npm package that you can install using the <samp class="listingcharacter listingcharacter">npm install mongodb command</samp>.</p>
                <p class="standard">As with the previous databases, in the first step, you’ll now learn how to establish a connection to your database, which you can then later be used to create, read, modify, and delete records.</p>
            
            
                <h4 class="t4" id="h8.2.2.2">Establishing<a class="indexanchor" id="i08_107"/> a Connection</h4>
                <p class="standard">The connection to the database is based on the MongoDB client<a class="indexanchor" id="i08_108"/>. Make sure that you initialize this client correctly. <span class="crossreference "><a href="08_002.html#l8.24">Listing 8.24</a></span> shows how to do that.</p>
                <div class="listing " id="l8.24"><pre><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> MongoClient </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'mongodb'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><br/><span class="rot">let</span><span class="schwarz"> collection </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">null</span><span class="schwarz">;</span><span class="schwarz"><br/></span><br/><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">connect()</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="rot">if</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">collection</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="rot">return</span><span class="schwarz"> collection</span><span class="schwarz">;</span><span class="schwarz"><br/></span>  <span class="schwarz">}</span><span class="schwarz"><br/></span>  <span class="rot">const</span><span class="schwarz"> client </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">MongoClient(</span><span class="hellblau">'mongodb://localhost:27017'</span><span class="schwarz">);</span><span class="schwarz"><br/></span><br/>  <span class="rot">await</span><span class="schwarz"> client</span><span class="schwarz">.connect();</span><span class="schwarz"><br/></span><br/>  <span class="rot">const</span><span class="schwarz"> db </span><span class="dunkelblau">=</span><span class="schwarz"> client</span><span class="schwarz">.db(</span><span class="hellblau">'moviedb'</span><span class="schwarz">);</span><span class="schwarz"><br/></span>  collection <span class="dunkelblau">=</span><span class="schwarz"> db</span><span class="schwarz">.collection(</span><span class="hellblau">'Movie'</span><span class="schwarz">);</span><span class="schwarz"><br/></span><br/>  <span class="rot">return</span><span class="schwarz"> collection</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"><br/></span><br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">getAll()</span><span class="schwarz"> </span><span class="schwarz">{}</span><span class="schwarz"><br/></span><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">get(</span><span class="schwarz">id</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{}</span><span class="schwarz"><br/></span><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">remove(</span><span class="schwarz">id</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{}</span><span class="schwarz"><br/></span><span class="rot">export</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">save(</span><span class="schwarz">movie</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{}</span><span class="schwarz"> </span></pre></div>
                <p class="caption "><b>Listing 8.24</b>    
            Connecting to the Database (movie/model.js)</p>
                <p class="standard"><a id="p267"/>The connection is established by the asynchronous <samp class="listingcharacter listingcharacter">connect</samp> function. Here, you must first check whether a <samp class="listingcharacter listingcharacter">collection</samp> already exists, that is, whether a connection exists, and return it. If there is no connection yet, you must create a new instance of the <samp class="listingcharacter listingcharacter">MongoClient</samp> class<a class="indexanchor" id="i08_109"/> from the <samp class="listingcharacter listingcharacter">mongodb</samp> driver and pass the address of the database. Then you must use the <samp class="listingcharacter listingcharacter">connect</samp> method of the client to establish a connection. This method returns a promise object that you await via the <samp class="listingcharacter listingcharacter">await</samp> keyword. Once the connection is established, you create a new database object via the <samp class="listingcharacter listingcharacter">db</samp> method of the client and, on top of that, a new <samp class="listingcharacter listingcharacter">collection</samp> object via the <samp class="listingcharacter listingcharacter">collection</samp> method. The collection is responsible for managing the documents. The <samp class="listingcharacter listingcharacter">collection</samp> object<a class="indexanchor" id="i08_110"/> is the return value of the <samp class="listingcharacter listingcharacter">connect</samp> function and is used as a basis by the other functions in this file.</p>
            
            
                <h4 class="t4" id="h8.2.2.3">Creating Data Records<a class="indexanchor" id="i08_111"/></h4>
                <p class="standard">The MongoDB client<a class="indexanchor" id="i08_112"/> provides you with the <samp class="listingcharacter listingcharacter">insert</samp> method for creating new data records. <span class="crossreference "><a href="08_002.html#l8.25">Listing 8.25</a></span> shows how you can use this method.</p>
                <div class="listing " id="l8.25"><pre><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> MongoClient </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'mongodb'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="rot">let</span><span class="schwarz"> collection </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">null</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">connect()</span><span class="schwarz"> </span><span class="schwarz">{...}</span><span class="schwarz"><br/></span> <br/><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">export</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> getAll() {</span><br/>  <span class="rot">return</span><span class="schwarz"> Promise.resolve([]);</span><br/>}<br/> </samp></span><br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> get(id) {}</span><br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> remove(id) {}</span><br/> <br/><span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> insert(movie) {</span><br/>  movie.id <span class="dunkelblau">=</span><span class="schwarz"> Date.now();</span><br/>  <span class="rot">const</span><span class="schwarz"> collection </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> connect();</span><br/>  <span class="rot">const</span><span class="schwarz"> data </span><span class="dunkelblau">=</span><span class="schwarz"> collection.insertOne(movie);</span><br/>  <span class="rot">return</span><span class="schwarz"> data;</span><br/>}<br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> save(movie) {</span><br/>  <span class="rot">if</span><span class="schwarz"> (</span><span class="dunkelblau">!</span><span class="schwarz">movie.id) {</span><br/>    <span class="rot">return</span><span class="schwarz"> insert(movie);</span><br/>  }<br/>}</samp></span> <span class="schwarz"/></pre></div>
                <p class="caption "><b>Listing 8.25</b>    
            Inserting Data Records into a MongoDB (movie/model.js)</p>
                <p class="standard"><a id="p268"/>MongoDB assigns a unique ID<a class="indexanchor" id="i08_113"/> to each data record via the <samp class="listingcharacter listingcharacter">_id</samp> field. To avoid changes to the rest of the application’s source code, at this point, as with the Redis example, you should use the current time stamp to generate an additional ID that will be used as a reference in the rest of the application.</p>
                <p class="standard">The asynchronous <samp class="listingcharacter listingcharacter">insert</samp> function is responsible for inserting a new data record. First, you create a connection to the database using the <samp class="listingcharacter listingcharacter">connect</samp> function. Then you use the <samp class="listingcharacter listingcharacter">insertOne</samp> method to save the data record. As an argument, the method<a class="indexanchor" id="i08_114"/> accepts an object structure representing the new data record, that is, our movie.</p>
                <p class="standard">The <samp class="listingcharacter listingcharacter">save</samp> function, in turn, uses the ID of the data record passed to decide whether it’s a new record, and then calls the <samp class="listingcharacter listingcharacter">insert</samp> function accordingly.</p>
            
            
                <h4 class="t4" id="h8.2.2.4">Reading Data Records<a class="indexanchor" id="i08_115"/></h4>
                <p class="standard">Once you’ve created data records in the database, you can read them via the <samp class="listingcharacter listingcharacter">find</samp> method. <span class="crossreference "><a href="08_002.html#l8.26">Listing 8.26</a></span><a class="indexanchor" id="i08_116"/> shows the extension of the model, with which you can read all data records from the collection.</p>
                <div class="listing " id="l8.26"><pre><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> MongoClient </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'mongodb'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="rot">let</span><span class="schwarz"> collection </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">null</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">connect()</span><span class="schwarz"> </span><span class="schwarz">{...}</span><span class="schwarz"><br/></span> <br/><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> getAll() {</span><br/>  <span class="rot">const</span><span class="schwarz"> collection </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> connect();</span><br/>  <span class="rot">const</span><span class="schwarz"> docs </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> collection.find({});</span><br/>  <span class="rot">return</span><span class="schwarz"> docs.toArray();</span><br/>}<br/> </samp></span><br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> get(id) {}</span><br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> remove(id) {}</span><br/> <br/><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> insert(movie) {...}</span><br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> save(movie) {...} </span><span class="schwarz"/></pre></div>
                <p class="caption "><b>Listing 8.26</b>    
            Reading Data Records from a MongoDB (movie/model.js)</p>
                <p class="standard">After you’ve connected to the database using the <samp class="listingcharacter listingcharacter">connect</samp> function and obtained the reference to the collection, you can call the <samp class="listingcharacter listingcharacter">find</samp> method on this object to search for documents there that meet certain criteria. If you pass an empty object to the <samp class="listingcharacter listingcharacter">find</samp> method, all documents will be read. However, you can also define queries here and thus select only certain documents.</p>
                <p class="standard"><a id="p269"/>You can call the <samp class="listingcharacter listingcharacter">toArray</samp> method on the object returned by <samp class="listingcharacter listingcharacter">find</samp>. This ensures that an array with all documents found is available to you in a callback function in addition to an error object<a class="indexanchor" id="i08_117"/>.</p>
            
            
                <h4 class="t4" id="h8.2.2.5">Updating Data Records<a class="indexanchor" id="i08_118"/></h4>
                <p class="standard">To update data records, you need to implement two functions, as in the previous examples. First, you must modify the <samp class="listingcharacter listingcharacter">getAll</samp> function so that you can pass it an optional query. You also rename the function to <samp class="listingcharacter listingcharacter">get</samp> to better reflect the character of the function. At this point, you should note that the <samp class="listingcharacter listingcharacter">get</samp> function always returns an array, so you must extract the movie object. In the next step, you implement the update function, which is responsible for updating a data record. The corresponding changes to the <span class="italic">movie/model.js</span> file are shown in <span class="crossreference "><a href="08_002.html#l8.27">Listing 8.27</a></span>.</p>
                <div class="listing " id="l8.27"><pre><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> MongoClient </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'mongodb'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="rot">let</span><span class="schwarz"> collection </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">null</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">connect()</span><span class="schwarz"> </span><span class="schwarz">{...}</span><span class="schwarz"><br/></span> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">getAll()</span><span class="schwarz"> </span><span class="schwarz">{...}</span><span class="schwarz"><br/></span> <br/><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> get(id) {</span><br/>  <span class="rot">const</span><span class="schwarz"> collection </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> connect();</span><br/>  <span class="rot">const</span><span class="schwarz"> doc </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> collection.findOne({ id });</span><br/>  <span class="rot">return</span><span class="schwarz"> doc;</span><br/>}<br/> </samp></span><br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> remove(id) {}</span><br/> <br/><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> insert(movie) {...}</span><br/> <br/><span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> update(movie) {</span><br/>  movie.id <span class="dunkelblau">=</span><span class="schwarz"> parseInt(movie.id, 10);</span><br/>  <span class="rot">const</span><span class="schwarz"> collection </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> connect();</span><br/>  <span class="rot">await</span><span class="schwarz"> collection.updateOne({ id: movie.id }, { $</span><span class="rot">set</span><span class="schwarz">: movie });</span><br/>  <span class="rot">return</span><span class="schwarz"> movie;</span><br/>}<br/> </samp></span><br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> save(movie) {</span><br/>  <span class="rot">if</span><span class="schwarz"> (</span><span class="dunkelblau">!</span><span class="schwarz">movie.id) {</span><br/>    <span class="rot">return</span><span class="schwarz"> insert(movie);</span><br/>  <span class="bold"><samp class="listingcharacter listingcharacter">} <span class="rot">else</span><span class="schwarz"> {</span><br/>    <span class="rot">return</span><span class="schwarz"> update(movie);</span></samp></span><br/>  }<br/>} <span class="schwarz"/></pre></div>
                <p class="caption "><b>Listing 8.27</b>    
            Modifying Data Records (movie/model.js)</p>
                <p class="standard"><a id="p270"/>In the extension of the <samp class="listingcharacter listingcharacter">save</samp> function from <span class="crossreference "><a href="08_002.html#l8.27">Listing 8.27</a></span>, you must call the <samp class="listingcharacter listingcharacter">update</samp> function for data records to be updated. This function first converts the <samp class="listingcharacter listingcharacter">id</samp> property to a number, ensures that the connection is established, and at the same time gets a reference to the collection object. Then, you use the <samp class="listingcharacter listingcharacter">updateOne</samp> method of the collection to update the data record. As the first argument, this method accepts the selector<a class="indexanchor" id="i08_119"/> you use to locate the data record, and, as the second argument, you pass the updated data record. As a return value, you get a promise object.</p>
                <p class="standard">When reading a single data record to populate the form, you access the <samp class="listingcharacter listingcharacter">findOne</samp> method of the collection, which you pass the ID you’re looking for as a selector.</p>
            
            
                <h4 class="t4" id="h8.2.2.6">Removing Data Records<a class="indexanchor" id="i08_120"/></h4>
                <p class="standard">To remove data records, you can use the <samp class="listingcharacter listingcharacter">deleteOne</samp> method of the <samp class="listingcharacter listingcharacter">collection</samp> object. This method has a signature similar to the <samp class="listingcharacter listingcharacter">findOne</samp> method. As an argument, you pass an object that contains the search criteria for the data record. The integration with your model is shown in <span class="crossreference "><a href="08_002.html#l8.28">Listing 8.28</a></span>.</p>
                <div class="listing " id="l8.28"><pre><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> MongoClient </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'mongodb'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="rot">let</span><span class="schwarz"> collection </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">null</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">connect()</span><span class="schwarz"> </span><span class="schwarz">{...}</span><span class="schwarz"><br/></span> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">getAll()</span><span class="schwarz"> </span><span class="schwarz">{...}</span><span class="schwarz"><br/></span> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">get(</span><span class="schwarz">id</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{...}</span><span class="schwarz"><br/></span> <br/><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> remove(id) {</span><br/>  <span class="rot">const</span><span class="schwarz"> collection </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> connect();</span><br/>  <span class="rot">return</span><span class="schwarz"> collection.deleteOne({ id });</span><br/>}<br/> </samp></span><br/><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> insert(movie) {...}</span><br/> <br/><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> update(movie) {...}</span><br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> save(movie) {...} </span><span class="schwarz"/></pre></div>
                <p class="caption "><b>Listing 8.28</b>    
            Deleting Data Records (movie/model.js)</p>
                <p class="standard">Once you’ve made these adjustments to your model, you can restart your application, then manage the data records in it, and store them in a MongoDB instance.</p>
            
            
                <h4 class="t4" id="h8.2.2.7"><a id="p271"/>Mongoose<a class="indexanchor" id="i08_121"/></h4>
                <p class="standard">Similar to ORM in SQL databases, Mongoose is an abstraction layer<a class="indexanchor" id="i08_122"/> between the database and your application. Mongoose allows you to view the documents in your database directly as objects in your application and provides you with a variety of methods for handling the data. This package is installed via npm using the <samp class="listingcharacter listingcharacter">npm install mongoose</samp> command. <span class="crossreference "><a href="08_002.html#l8.29">Listing 8.29</a></span> shows how you can use Mongoose on the basis of the movie database.</p>
                <div class="listing " id="l8.29"><pre><span class="rot">import</span><span class="schwarz"> mongoose </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'mongoose'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/>mongoose<span class="schwarz">.connect(</span><span class="hellblau">'mongodb://localhost:27017/moviedb'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  useNewUrlParser<span class="schwarz">:</span><span class="schwarz"> </span><span class="rot">true</span><span class="schwarz">,</span><span class="schwarz"><br/></span>  useUnifiedTopology<span class="schwarz">:</span><span class="schwarz"> </span><span class="rot">true</span><span class="schwarz">,</span><span class="schwarz"><br/></span><span class="schwarz">});</span><span class="schwarz"><br/></span> <br/><span class="rot">const</span><span class="schwarz"> Movie </span><span class="dunkelblau">=</span><span class="schwarz"> mongoose</span><span class="schwarz">.model(</span><span class="hellblau">'Movie'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  id<span class="schwarz">:</span><span class="schwarz"> Number</span><span class="schwarz">,</span><span class="schwarz"><br/></span>  title<span class="schwarz">:</span><span class="schwarz"> String</span><span class="schwarz">,</span><span class="schwarz"><br/></span>  year<span class="schwarz">:</span><span class="schwarz"> Number</span><span class="schwarz">,</span><span class="schwarz"><br/></span><span class="schwarz">});</span><span class="schwarz"><br/></span> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">getAll()</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="rot">return</span><span class="schwarz"> Movie</span><span class="schwarz">.find({});</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"><br/></span> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">get(</span><span class="schwarz">id</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="rot">return</span><span class="schwarz"> Movie</span><span class="schwarz">.findOne({</span><span class="schwarz"> id </span><span class="schwarz">});</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"><br/></span> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">remove(</span><span class="schwarz">id</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="rot">const</span><span class="schwarz"> movie </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> </span><span class="schwarz">get(</span><span class="schwarz">id</span><span class="schwarz">);</span><span class="schwarz"><br/></span>  <span class="rot">return</span><span class="schwarz"> movie</span><span class="schwarz">.remove();</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"><br/></span> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">save(</span><span class="schwarz">movie</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="rot">if</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="dunkelblau">!</span><span class="schwarz">movie</span><span class="schwarz">.</span><span class="schwarz">id</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="rot">const</span><span class="schwarz"> newMovie </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">Movie(</span><span class="schwarz">movie</span><span class="schwarz">);</span><span class="schwarz"><br/></span>    newMovie<span class="schwarz">.</span><span class="schwarz">id </span><span class="dunkelblau">=</span><span class="schwarz"> Date</span><span class="schwarz">.now();</span><span class="schwarz"><br/></span>    <span class="rot">return</span><span class="schwarz"> newMovie</span><span class="schwarz">.save();</span><span class="schwarz"><br/></span>  <span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">else</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="rot">const</span><span class="schwarz"> existingMovie </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> </span><span class="schwarz">get(parseInt(</span><span class="schwarz">movie</span><span class="schwarz">.</span><span class="schwarz">id</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">10));</span><span class="schwarz"><br/></span>    existingMovie<span class="schwarz">.</span><span class="schwarz">title </span><span class="dunkelblau">=</span><span class="schwarz"> movie</span><span class="schwarz">.</span><span class="schwarz">title</span><span class="schwarz">;</span><span class="schwarz"><br/></span>    existingMovie<span class="schwarz">.</span><span class="schwarz">year </span><span class="dunkelblau">=</span><span class="schwarz"> movie</span><span class="schwarz">.</span><span class="schwarz">year</span><span class="schwarz">;</span><span class="schwarz"><br/></span><a id="p272"/>    <span class="rot">return</span><span class="schwarz"> existingMovie</span><span class="schwarz">.save();</span><span class="schwarz"><br/></span>  <span class="schwarz">}</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"> </span></pre></div>
                <p class="caption "><b>Listing 8.29</b>    
            Using Mongoose</p>
                <p class="standard">In Mongoose, a model represents a collection. You define your models using the <samp class="listingcharacter listingcharacter">model</samp> method of Mongoose and specify the data type per property. The result of this method call is a class of which you can create instances. Calling the <samp class="listingcharacter listingcharacter">save</samp> method of the model saves the data to the database. You can use the <samp class="listingcharacter listingcharacter">find</samp> method to find existing data records and the <samp class="listingcharacter listingcharacter">remove</samp> method to delete these documents. The project’s official website can be found at <span class="url"><a href="http://mongoosejs.com/">http://mongoosejs.com/</a></span>.</p>
            
        
    </div><p class="signatur"/>
                    </body>
                </html>