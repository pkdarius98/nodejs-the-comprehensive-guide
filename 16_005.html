<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
                    
        <head><meta content="application/xhtml+xml; charset=utf-8" http-equiv="Content-Type"/>
            <meta content="application/xhtml+xml; charset=utf-8" name="content-type"/>
            <meta content="Asynchronous Programming" name="title"/>
            <meta content="Sebastian Springer" name="author"/>
            <meta content="Rheinwerk Publishing" name="publisher"/>
            <meta content="© 2022 by Rheinwerk Publishing Inc., Boston (MA)" name="copyright"/>
            <meta content="Node.js - The Comprehensive Guide - Asynchronous Programming" name="description"/>
            <meta content="en" name="language"/>
            <title>Asynchronous Programming</title>
            <link href="common/main.css" rel="stylesheet" type="text/css"/>
<meta content="urn:uuid:e0000000-0000-0000-0000-000029756394" name="Adept.expected.resource"/>
        </head>
    


                    <body class="office_us type_kapitel">
                        <div id="main">
        <h2 class="t2" id="h16.5">16.5    Worker Threads<a class="indexanchor" id="i16_100"/></h2>
        <p class="standard">Since version 10.5, Node.js has had another module besides the <samp class="listingcharacter listingcharacter">child_process</samp> module that deals with creating parallel execution threads in an application. The newer <samp class="listingcharacter listingcharacter">worker_threads</samp> module is used to swap out CPU-intensive subprocesses<a class="indexanchor" id="i16_101"/> into a separate worker thread. The strength of the child processes of the <samp class="listingcharacter listingcharacter">child_process</samp> module rather lies in operations involving many input and output operations. The concept behind both modules is quite similar: Both make sure that a certain part of the application gets swapped out, and they provide methods and events for communication between the main process and the child processes or child threads<a class="indexanchor" id="i16_102"/>. <span class="crossreference "><a href="16_005.html#l16.16">Listing 16.16</a></span> contains the implementation of the worker for realizing the example with 1,000 prime numbers via the <samp class="listingcharacter listingcharacter">worker_threads</samp> module.</p>
        <div class="listing " id="l16.16"><pre><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">import</span><span class="schwarz"> { parentPort, workerData } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'worker_threads'</span><span class="schwarz">;</span><br/> <br/><span class="rot">let</span><span class="schwarz"> n </span><span class="dunkelblau">=</span><span class="schwarz"> workerData.start;</span></samp></span><br/><span class="rot">let</span><span class="schwarz"> results </span><span class="dunkelblau">=</span><span class="schwarz"> 0;</span><br/>outerLoop: <span class="rot">while</span><span class="schwarz"> (results </span><span class="dunkelblau">&lt;=</span><span class="schwarz"> 1000) {</span><br/>  n <span class="dunkelblau">+=</span><span class="schwarz"> 1;</span><br/>  <span class="rot">for</span><span class="schwarz"> (</span><span class="rot">let</span><span class="schwarz"> i </span><span class="dunkelblau">=</span><span class="schwarz"> 2; i </span><span class="dunkelblau">&lt;=</span><span class="schwarz"> Math.sqrt(n); i </span><span class="dunkelblau">+=</span><span class="schwarz"> 1) {</span><br/>    <span class="rot">if</span><span class="schwarz"> (n </span><span class="dunkelblau">%</span><span class="schwarz"> i </span><span class="dunkelblau">===</span><span class="schwarz"> 0) {</span><br/>      <span class="rot">continue</span><span class="schwarz"> outerLoop;</span><br/>    }<br/>  }<br/>  <span class="bold"><samp class="listingcharacter listingcharacter">parentPort.postMessage(n);</samp></span><br/>  results <span class="dunkelblau">+=</span><span class="schwarz"> 1;</span><br/>}<br/> <br/>process.exit(); <span class="schwarz"/></pre></div>
        <p class="caption "><b>Listing 16.16</b>    
            Implementation of the Worker Thread (worker.js)</p>
        <p class="standard"><a id="p505"/>In the worker process, you import the <samp class="listingcharacter listingcharacter">parentPort</samp> and <samp class="listingcharacter listingcharacter">workerData</samp> objects from the <samp class="listingcharacter listingcharacter">worker_threads</samp> module. You can use the <samp class="listingcharacter listingcharacter">postMessage</samp> method of the <samp class="listingcharacter listingcharacter">parentPort</samp> object to send messages to the main thread of your application. The <samp class="listingcharacter listingcharacter">workerData</samp> object allows you to access information passed to the worker thread upon its creation. In this case, <samp class="listingcharacter listingcharacter">workerData.start</samp> defines the start value from which the prime numbers are to be searched. Calling <samp class="listingcharacter listingcharacter">process.exit</samp> terminates the worker thread.</p>
        <p class="standard">The counterpart to the worker thread, that is, the main thread, is shown in <span class="crossreference "><a href="16_005.html#l16.17">Listing 16.17</a></span>.</p>
        <div class="listing " id="l16.17"><pre><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> Worker </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'worker_threads'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="rot">const</span><span class="schwarz"> worker </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">Worker(</span><span class="hellblau">'./worker.js'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  workerData<span class="schwarz">:</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    start<span class="schwarz">:</span><span class="schwarz"> </span><span class="schwarz">42,</span><span class="schwarz"><br/></span>  <span class="schwarz">},</span><span class="schwarz"><br/></span><span class="schwarz">});</span><span class="schwarz"><br/></span> <br/>worker<span class="schwarz">.on(</span><span class="hellblau">'message'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">data</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="magenta">console</span><span class="schwarz">.log(</span><span class="violett">`worker =&gt; main: ${data}`</span><span class="schwarz">);</span><span class="schwarz"><br/></span><span class="schwarz">});</span><span class="schwarz"> </span></pre></div>
        <p class="caption "><b>Listing 16.17</b>    
            Source Code of the Main Thread (index.js)</p>
        <p class="standard">To create a worker thread, you import the <samp class="listingcharacter listingcharacter">worker</samp> class from the <samp class="listingcharacter listingcharacter">worker_threads</samp> module and instantiate it with the name of the worker file and an optional configuration object. The <samp class="listingcharacter listingcharacter">workerData</samp> property allows you to define an object structure the worker can access via the <samp class="listingcharacter listingcharacter">workerData</samp> object. In the main thread, you can respond to different worker events. In this case, it’s the <samp class="listingcharacter listingcharacter">message</samp> event<a class="indexanchor" id="i16_103"/>, which is triggered by the worker’s <samp class="listingcharacter listingcharacter">postMessage</samp> method<a class="indexanchor" id="i16_104"/>. Other events include <samp class="listingcharacter listingcharacter">exit</samp>, for example, if the worker is terminated, or <samp class="listingcharacter listingcharacter">error</samp>, if an error has occurred.</p>
        
            <h3 class="t3" id="h16.5.1">16.5.1    Shared Memory in the worker_threads Module</h3>
            <p class="standard">An interesting feature of the <samp class="listingcharacter listingcharacter">worker_threads</samp> module that isn’t available in the <samp class="listingcharacter listingcharacter">child_process</samp> module is the sharing of memory between the main thread and the worker. In this context, you use a <samp class="listingcharacter listingcharacter">SharedArrayBuffer</samp><a class="indexanchor" id="i16_105"/> object as shown in <span class="crossreference "><a href="16_005.html#l16.18">Listing 16.18</a></span>.</p>
            <div class="listing " id="l16.18"><pre><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> Worker </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'worker_threads'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">const</span><span class="schwarz"> sharedBuffer </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">SharedArrayBuffer(Int32Array.BYTES_PER_ELEMENT </span><span class="dunkelblau">*</span><span class="schwarz"> 1000);</span><br/><span class="rot">const</span><span class="schwarz"> arr </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">Int32Array(sharedBuffer);</span><br/> </samp></span><br/><span class="rot">const</span><span class="schwarz"> worker </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">Worker(</span><span class="hellblau">'./worker.js'</span><span class="schwarz">, {</span><br/> <span class="bold"><samp class="listingcharacter listingcharacter"> workerData: arr,</samp></span><br/>});<br/> <br/><a id="p506"/>worker.on(<span class="hellblau">'message'</span><span class="schwarz">, (data) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>  <span class="bold"><samp class="listingcharacter listingcharacter"><span class="magenta">console</span><span class="schwarz">.log(</span><span class="violett">`Worker seems to be ${data}`</span><span class="schwarz">);</span><br/>  arr.forEach((element) <span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="magenta">console</span><span class="schwarz">.log(element));</span></samp></span><br/>}); <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 16.18</b>    
            Main Thread with Shared Memory (index.js)</p>
            <p class="standard">You first create an instance of the <samp class="listingcharacter listingcharacter">SharedArrayBuffer</samp> class that can contain a total of 1,000 32-bit integers. You pass this <samp class="listingcharacter listingcharacter">SharedArrayBuffer</samp> object to the <samp class="listingcharacter listingcharacter">Int32Array</samp><a class="indexanchor" id="i16_106"/> constructor as a storage location and additionally pass this typed array object as input when the worker thread is created. Instead of reporting each value back to the main thread individually, the worker in this example simply sends a message when all numbers have been found. The message also doesn’t contain any data, but only a string that is output to the console. The calculated numbers are located in the memory of the typed array<a class="indexanchor" id="i16_107"/>, which you output to the console using the <samp class="listingcharacter listingcharacter">forEach</samp> method of the array. So, in this example, you’re not passing any data, but just memory references between the two threads. The implementation of the worker is shown in <span class="crossreference "><a href="16_005.html#l16.19">Listing 16.19</a></span>.</p>
            <div class="listing " id="l16.19"><pre><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> parentPort</span><span class="schwarz">,</span><span class="schwarz"> workerData </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'worker_threads'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">let</span><span class="schwarz"> n </span><span class="dunkelblau">=</span><span class="schwarz"> 1;</span></samp></span><br/><span class="rot">let</span><span class="schwarz"> results </span><span class="dunkelblau">=</span><span class="schwarz"> 0;</span><br/> <br/>outerLoop: <span class="rot">while</span><span class="schwarz"> (results </span><span class="dunkelblau">&lt;=</span><span class="schwarz"> 1000) {</span><br/>  n <span class="dunkelblau">+=</span><span class="schwarz"> 1;</span><br/>  <span class="rot">for</span><span class="schwarz"> (</span><span class="rot">let</span><span class="schwarz"> i </span><span class="dunkelblau">=</span><span class="schwarz"> 2; i </span><span class="dunkelblau">&lt;=</span><span class="schwarz"> Math.sqrt(n); i </span><span class="dunkelblau">+=</span><span class="schwarz"> 1) {</span><br/>    <span class="rot">if</span><span class="schwarz"> (n </span><span class="dunkelblau">%</span><span class="schwarz"> i </span><span class="dunkelblau">===</span><span class="schwarz"> 0) {</span><br/>      <span class="rot">continue</span><span class="schwarz"> outerLoop;</span><br/>    }<br/>  }<br/>  <span class="bold"><samp class="listingcharacter listingcharacter">workerData[results] <span class="dunkelblau">=</span><span class="schwarz"> n;</span></samp></span><br/>  results <span class="dunkelblau">+=</span><span class="schwarz"> 1;</span><br/>}<br/> <br/><span class="bold"><samp class="listingcharacter listingcharacter">parentPort.postMessage(<span class="hellblau">'ready'</span><span class="schwarz">);</span><br/> </samp></span><br/>process.exit(); <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 16.19</b>    
            Worker Thread with Shared Memory (worker.js)</p>
            <p class="standard">Instead of sending each number to the main thread as a message, you write the results to the typed array that the main thread passed to the worker during the initialization process. When the calculation is complete, you use the <samp class="listingcharacter listingcharacter">postMessage</samp> method to send the <samp class="listingcharacter listingcharacter">ready</samp> string to the main thread, signaling that the data calculation has finished. Finally, you terminate the worker by calling the <samp class="listingcharacter listingcharacter">exit</samp> method. When you run the script, Node.js <a id="p507"/>outputs 1,000 prime numbers, as in the previous examples. However, the mass exchange of data between the two threads is omitted in this case.</p>
            <p class="standard">With child processes and worker threads, you now know two ways to swap out potentially blocking operations from your Node.js process. These two concepts are based on an event architecture so that they can handle asynchronicity.</p>
            <p class="standard">The promises tool is also increasingly used with Node.js. In the following sections, you’ll learn more about the promises concept. Promises serve as a tool for applications in which a large number of tasks are performed asynchronously and thus the reading flow of the source code is disturbed. Furthermore, it’s used for the purpose of flow control<a class="indexanchor" id="i16_108"/> in asynchronous applications.</p>
        
    </div><p class="signatur"/>
                    </body>
                </html>