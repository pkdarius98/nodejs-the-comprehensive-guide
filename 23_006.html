<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
                    
        <head><meta content="application/xhtml+xml; charset=utf-8" http-equiv="Content-Type"/>
            <meta content="application/xhtml+xml; charset=utf-8" name="content-type"/>
            <meta content="Testing" name="title"/>
            <meta content="Sebastian Springer" name="author"/>
            <meta content="Rheinwerk Publishing" name="publisher"/>
            <meta content="© 2022 by Rheinwerk Publishing Inc., Boston (MA)" name="copyright"/>
            <meta content="Node.js - The Comprehensive Guide - Testing" name="description"/>
            <meta content="en" name="language"/>
            <title>Testing</title>
            <link href="common/main.css" rel="stylesheet" type="text/css"/>
<meta content="urn:uuid:e0000000-0000-0000-0000-000029756394" name="Adept.expected.resource"/>
        </head>
    


                    <body class="office_us type_kapitel">
                        <div id="main">
        <h2 class="t2" id="h23.6">23.6    Dealing with Dependencies: Mocking<a class="indexanchor" id="i23_81"/></h2>
        <p class="standard">The tests we’ve written so far all look like they came out of a textbook. There is a function that receives a defined input and generates a specific output from it. Unfortunately, real life isn’t always that nice. Sometimes, the need arises to enter dependencies<a class="indexanchor" id="i23_82"/> between different files or to include modules. However, in your unit test, you only want to test your own function and not a third-party package. The solution to this problem is called <span class="italic">mocking</span>. In this context, you replace the external dependency with something that is completely under your control within your test environment.</p>
        <p class="standard">As an example of this problem, let’s assume we need to implement a <samp class="listingcharacter listingcharacter">countLines</samp> function. This function accepts a file name of a text file and counts the lines of this file. To test this functionality, you can provide a test file and use the <samp class="listingcharacter listingcharacter">fs</samp> module<a class="indexanchor" id="i23_83"/> of Node.js directly. However, this means you always need an external file and to check the file system module as well. In addition, the file system access in the test impacts the runtime of the tests. <span class="crossreference "><a href="23_006.html#l23.33">Listing 23.33</a></span> contains the test for the <samp class="listingcharacter listingcharacter">countLines</samp> function to be implemented.</p>
        <div class="listing " id="l23.33"><pre><a id="p680"/>jest<span class="schwarz">.mock(</span><span class="hellblau">'fs'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">()</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="rot">return</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="schwarz">readFile(</span><span class="schwarz">name</span><span class="schwarz">,</span><span class="schwarz"> encoding</span><span class="schwarz">,</span><span class="schwarz"> cb</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>      <span class="schwarz">cb(</span><span class="rot">null</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="hellblau">'a\nb\nc'</span><span class="schwarz">);</span><span class="schwarz"><br/></span>    <span class="schwarz">},</span><span class="schwarz"><br/></span>  <span class="schwarz">};</span><span class="schwarz"><br/></span><span class="schwarz">});</span><span class="schwarz"><br/></span> <br/><span class="rot">const</span><span class="schwarz"> countLines </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="schwarz">require(</span><span class="hellblau">'./countLines'</span><span class="schwarz">);</span><span class="schwarz"><br/></span> <br/><span class="schwarz">describe(</span><span class="hellblau">'countLines'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">()</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="schwarz">it(</span><span class="hellblau">'should count the lines of a 3-lined file correctly'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="schwarz">()</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="rot">const</span><span class="schwarz"> lines </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> </span><span class="schwarz">countLines(</span><span class="hellblau">'input.txt'</span><span class="schwarz">);</span><span class="schwarz"><br/></span>    <span class="schwarz">expect(</span><span class="schwarz">lines</span><span class="schwarz">).toBe(3);</span><span class="schwarz"><br/></span>  <span class="schwarz">});</span><span class="schwarz"><br/></span><span class="schwarz">});</span><span class="schwarz"> </span></pre></div>
        <p class="caption "><b>Listing 23.33</b>    
            Test for the “countLines” Function (countLines.test.js)</p>
        <p class="standard">When mocking dependencies in Jest, there is still a limitation: The development team is currently working on support for the ECMAScript module system, so, at the moment, this feature is of very limited use. Potential solutions to this problem include using TypeScript or Babel. For this reason, the example in <span class="crossreference "><a href="23_006.html#l23.33">Listing 23.33</a></span> is based on the CommonJS module system to show you the principle of mocking dependencies.</p>
        <p class="standard">When mocking with Jest, several options are available. You can place files in a <span class="italic">__mocks__</span><a class="indexanchor" id="i23_84"/> directory, and they will automatically overwrite any files and packages with the same name. You can also explicitly mock modules using the <samp class="listingcharacter listingcharacter">jest.mock</samp> method. If you want to mock a Node.js core module, such as the <samp class="listingcharacter listingcharacter">fs</samp> module, as in the example, there is no way around the <samp class="listingcharacter listingcharacter">jest.mock</samp><a class="indexanchor" id="i23_85"/> call because core modules aren’t mocked automatically. In addition to swapping to a separate file, you can also insert your mock implementation directly into the test file, as shown in the example.</p>
        <p class="standard">In the example, you mock the <samp class="listingcharacter listingcharacter">fs</samp> module by calling <samp class="listingcharacter listingcharacter">jest.mock</samp> with the <samp class="listingcharacter listingcharacter">fs</samp> string and a callback function. This returns an object with the mocked functions, in this case <samp class="listingcharacter listingcharacter">readFile</samp>. Then you load the functionality to be tested and formulate your test as usual. The next step is to implement the <samp class="listingcharacter listingcharacter">countLines</samp> function. <span class="crossreference "><a href="23_006.html#l23.34">Listing 23.34</a></span> shows an example of this.</p>
        <div class="listing " id="l23.34"><pre><span class="rot">const</span><span class="schwarz"> fs </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="schwarz">require(</span><span class="hellblau">'fs'</span><span class="schwarz">);</span><span class="schwarz"><br/></span> <br/>module<span class="schwarz">.</span><span class="schwarz">exports </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">countLines(</span><span class="schwarz">filename</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="rot">return</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">Promise((</span><span class="schwarz">resolve</span><span class="schwarz">,</span><span class="schwarz"> reject</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    fs<span class="schwarz">.readFile(</span><span class="schwarz">filename</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="hellblau">'utf-8'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">err</span><span class="schwarz">,</span><span class="schwarz"> data</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>      <span class="schwarz">resolve(</span><span class="schwarz">data</span><span class="schwarz">.split(</span><span class="hellblau">'\n'</span><span class="schwarz">).</span><span class="schwarz">length</span><span class="schwarz">);</span><span class="schwarz"><br/></span><a id="p681"/>    <span class="schwarz">});</span><span class="schwarz"><br/></span>  <span class="schwarz">});</span><span class="schwarz"><br/></span><span class="schwarz">};</span><span class="schwarz"> </span></pre></div>
        <p class="caption "><b>Listing 23.34</b>    
            Implementation of the “countLines” Function (countLines.js)</p>
        <p class="standard">To implement the function, you must first load the <samp class="listingcharacter listingcharacter">fs</samp> module and define the <samp class="listingcharacter listingcharacter">countLines</samp> function that accepts a file name as input. Then you create a new promise object, read the specified file, and resolve the promise with the number of lines. You can get this value by splitting the contents of the file at the line break marked by the control character <samp class="listingcharacter listingcharacter">\n</samp> and reading the length of the resulting array.</p>
        <p class="standard">If you now run your test via the <samp class="listingcharacter listingcharacter">jest</samp> command or if you’ve stored an appropriate test script in your <span class="italic">package.json</span> via <samp class="listingcharacter listingcharacter">npm test</samp>, you’ll receive an output like the one shown in <span class="crossreference "><a href="23_006.html#l23.35">Listing 23.35</a></span>.</p>
        <div class="listing " id="l23.35"><pre><span class="bold"><samp class="listingcharacter listingcharacter">$ npm test<br/></samp></span><br/>&gt; node-book@1.0.0 test<br/>&gt; jest<br/><br/> PASS  ./countLines.test.js<br/>  countLines<br/>    ✓ should count the lines of a 3-lined file correctly (2 ms)<br/><br/>Test Suites: 1 passed, 1 total<br/>Tests:       1 passed, 1 total<br/>Snapshots:   0 total<br/>Time:        0.34 s, estimated 1 s<br/>Ran all test suites. </pre></div>
        <p class="caption "><b>Listing 23.35</b>    
            Result of the Mock Test</p>
        <p class="standard">This makes your test independent of the system it runs on, and you actually check only the logic you’ve implemented yourself and no other packages or modules, which has a positive effect on both the stability and the runtime of the test.</p>
    </div><p class="signatur"/>
                    </body>
                </html>