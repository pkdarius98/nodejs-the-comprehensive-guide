<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
                    
        <head><meta content="application/xhtml+xml; charset=utf-8" http-equiv="Content-Type"/>
            <meta content="application/xhtml+xml; charset=utf-8" name="content-type"/>
            <meta content="REST Server" name="title"/>
            <meta content="Sebastian Springer" name="author"/>
            <meta content="Rheinwerk Publishing" name="publisher"/>
            <meta content="© 2022 by Rheinwerk Publishing Inc., Boston (MA)" name="copyright"/>
            <meta content="Node.js - The Comprehensive Guide - REST Server" name="description"/>
            <meta content="en" name="language"/>
            <title>REST Server</title>
            <link href="common/main.css" rel="stylesheet" type="text/css"/>
<meta content="urn:uuid:e0000000-0000-0000-0000-000029756394" name="Adept.expected.resource"/>
        </head>
    


                    <body class="office_us type_kapitel">
                        <div id="main">
        <h2 class="t2" id="h10.8">10.8    Validation<a class="indexanchor" id="i10_73"/></h2>
        <p class="standard">In addition to the documentation, there is another important issue regarding our interface we’ve grossly neglected so far: validation. Currently, the application accepts all user input and writes it to the database unchecked, albeit with correct escaping. It’s also possible to create a new data record without information. This then contains only an ID and the user ID. To conclude this chapter, we’ll present the <samp class="listingcharacter listingcharacter">express-validator</samp><a class="indexanchor" id="i10_74"/> package—a fairly convenient solution for validation in Express. The validator allows you to check individual fields via middleware functions as well as a complete request via a validation scheme and to force values into a specific form with the Sanitizer feature.</p>
        
            <h3 class="t3" id="h10.8.1">10.8.1    <a id="p330"/>Installation and First Validation<a class="indexanchor" id="i10_75"/></h3>
            <p class="standard">You can install the <samp class="listingcharacter listingcharacter">express-validator</samp> package using the <samp class="listingcharacter listingcharacter">npm install express-validator</samp> command. For the first inclusion, you use <samp class="listingcharacter listingcharacter">deleteAction</samp> and make sure that only numbers can be passed as IDs to be deleted. For this purpose, the validator<a class="indexanchor" id="i10_76"/> uses middleware functions and provides you with another function called <samp class="listingcharacter listingcharacter">validationResult</samp>, which you can use to access the validation errors. In the first step, you extend the router in the <span class="italic">movie/index.js</span> file to validate the routing parameter<a class="indexanchor" id="i10_77"/>, as you can see in the code in <span class="crossreference "><a href="10_008.html#l10.35">Listing 10.35</a></span>.</p>
            <div class="listing " id="l10.35"><pre><span class="rot">import</span><span class="schwarz"> { Router } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'express'</span><span class="schwarz">;</span><br/><span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">import</span><span class="schwarz"> validator </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'express-validator'</span><span class="schwarz">;</span></samp></span><br/><span class="rot">import</span><span class="schwarz"> {</span><br/>  listAction,<br/>  detailAction,<br/>  createAction,<br/>  updateAction,<br/>  deleteAction,<br/>} <span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./controller.js'</span><span class="schwarz">;</span><br/> <br/><span class="rot">const</span><span class="schwarz"> router </span><span class="dunkelblau">=</span><span class="schwarz"> Router();</span><br/> <br/>router.get(<span class="hellblau">'/'</span><span class="schwarz">, listAction);</span><br/>router.get(<span class="hellblau">'/:id'</span><span class="schwarz">, detailAction);</span><br/>router.post(<span class="hellblau">'/'</span><span class="schwarz">, createAction);</span><br/>router.put(<span class="hellblau">'/:id'</span><span class="schwarz">, updateAction);</span><br/>router.delete(<span class="hellblau">'/:id'</span><span class="schwarz">, </span><span class="bold"><samp class="listingcharacter listingcharacter">validator.params(<span class="hellblau">'id'</span><span class="schwarz">).isInt(),</span></samp></span> deleteAction);<br/> <br/><span class="rot">export</span><span class="schwarz"> { router }; </span><span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 10.35</b>    
            Validating the Routing Parameter (movie/index.js)</p>
            <p class="standard">In addition to the <samp class="listingcharacter listingcharacter">param</samp> function, the <samp class="listingcharacter listingcharacter">express-validator</samp> package offers even more options to check other aspects of the query, such as the <samp class="listingcharacter listingcharacter">body</samp> function. If you now specify an arbitrary character string instead of a number when deleting a record, the validation fails. You can check this within the controller using the <samp class="listingcharacter listingcharacter">validationResult</samp> function. <span class="crossreference "><a href="10_008.html#l10.36">Listing 10.36</a></span> contains the corresponding source code.</p>
            <div class="listing " id="l10.36"><pre><span class="rot">import</span><span class="schwarz"> { getAll, </span><span class="rot">get</span><span class="schwarz">, save, remove } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./model.js'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> jsonXml </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'jsontoxml'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> { validationResult } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'express-validator'</span><span class="schwarz">;</span><br/> <br/><span class="rot">function</span><span class="schwarz"> getLinks(current, base) {...}</span><br/> <br/><span class="rot"><a id="p331"/>export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> listAction(request, response) {...}</span><br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> detailAction(request, response) {...}</span><br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> createAction(request, response) {...}</span><br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> updateAction(request, response) {...}</span><br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> deleteAction(request, response) {</span><br/>  <span class="rot">try</span><span class="schwarz"> {</span><br/>    <span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">const</span><span class="schwarz"> errors </span><span class="dunkelblau">=</span><span class="schwarz"> validationResult(request);</span><br/>    <span class="rot">if</span><span class="schwarz"> (</span><span class="dunkelblau">!</span><span class="schwarz">errors.isEmpty()) {</span><br/>      <span class="rot">return</span><span class="schwarz"> response.status(400).json({ errors: errors.array() });</span><br/>    }<br/> </samp></span><br/>    <span class="rot">const</span><span class="schwarz"> id </span><span class="dunkelblau">=</span><span class="schwarz"> parseInt(request.params.id, 10);</span><br/>    <span class="rot">await</span><span class="schwarz"> remove(id, request.user.id);</span><br/>    response.status(204).send();<br/>  } <span class="rot">catch </span><span class="schwarz">(</span><span class="rot">e</span><span class="schwarz">) {</span><br/>    <span class="magenta">console</span><span class="schwarz">.error(e);</span><br/>    response.status(500).send(<span class="hellblau">'An error happened'</span><span class="schwarz">);</span><br/>  }<br/>} <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 10.36</b>    
            Evaluating Validation Errors in the Controller (movie/controller.js)</p>
            <p class="standard">If you try to submit a <samp class="listingcharacter listingcharacter">DELETE</samp> request on the <span class="italic">http://localhost:8080/movie/IronMan</span> path with these changes (see <span class="crossreference "><a href="10_008.html#l10.37">Listing 10.37</a></span>), you’ll receive an <samp class="listingcharacter listingcharacter">Invalid value</samp> error message.<a class="indexanchor" id="i10_78"/></p>
            <div class="listing " id="l10.37"><pre>$ <span class="bold"><samp class="listingcharacter listingcharacter">curl -X DELETE -H "Authorization: Bearer eyJ...H38" http://localhost:8080/movie/IronMan</samp></span><br/>{"errors":[{"value":"IronMan","msg":"Invalid value","param":"id","location":"params"}]} </pre></div>
            <p class="caption "><b>Listing 10.37</b>    
            Invalid cURL Request</p>
            <p class="standard">If you place the same request in Postman, you’ll get some more detailed information, such as the status code. <span class="crossreference "><a href="10_008.html#f10.11">Figure 10.11</a></span> shows the result of such a request in the Postman GUI.</p>
            <p class="standard">In particular with regard to more extensive requests, using the middleware functions quickly becomes confusing. For this reason, the validator package provides schema validation, which allows you to define the rules in a single object structure.</p>
            <div class="imagebox figure-type"><a href="img-f10.11.html" id="f10.11"><img alt="Invalid DELETE Request with Postman" id="img-f10.11" src="bilderklein/klein10_011.png"/></a></div>
            <p class="caption "><b>Figure 10.11</b>    
            <a id="p332"/>Invalid DELETE Request with Postman</p>
        
        
            <h3 class="t3" id="h10.8.2">10.8.2    Checking Requests with a Validation Schema<a class="indexanchor" id="i10_79"/></h3>
            <p class="standard">The big advantage of the validation schema over the middleware approach is that you can define the validation rules in an object structure within the schema. In addition, the configuration options are much more convenient than if you have to chain several middleware functions. The schema<a class="indexanchor" id="i10_80"/> is therefore mainly worthwhile for more elaborate checks or larger objects that need validating. <span class="crossreference "><a href="10_008.html#l10.38">Listing 10.38</a></span> shows how you can use the validation schema via the POST route.</p>
            <div class="listing " id="l10.38"><pre><span class="rot">import</span><span class="schwarz"> { Router } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'express'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> validator </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'express-validator'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> {</span><br/>  listAction,<br/>  detailAction,<br/>  createAction,<br/>  updateAction,<br/>  deleteAction,<br/>} <span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./controller.js'</span><span class="schwarz">;</span><br/> <br/><span class="rot">const</span><span class="schwarz"> router </span><span class="dunkelblau">=</span><span class="schwarz"> Router();</span><br/> <br/>router.get(<span class="hellblau">'/'</span><span class="schwarz">, listAction);</span><br/><a id="p333"/>router.get(<span class="hellblau">'/:id'</span><span class="schwarz">, detailAction);</span><br/>router.post(<br/>  <span class="hellblau">'/'</span><span class="schwarz">,</span><br/>  <span class="bold"><samp class="listingcharacter listingcharacter">validator.checkSchema({<br/>    title: {<br/>      errorMessage: <span class="hellblau">'Title is invalid'</span><span class="schwarz">,</span><br/>      isString: <span class="rot">true</span><span class="schwarz">,</span><br/>      isLength: {<br/>        errorMessage: <span class="hellblau">'Title has to be between 1 and 20'</span><span class="schwarz">,</span><br/>        options: {<br/>          min: 1,<br/>          max: 20,<br/>        },<br/>      },<br/>    },<br/>    year: {<br/>      errorMessage: <span class="hellblau">'Year is invalid'</span><span class="schwarz">,</span><br/>      isInt: <span class="rot">true</span><span class="schwarz">,</span><br/>    },<br/>  }),</samp></span><br/>  createAction,<br/>);<br/>router.put(<span class="hellblau">'/:id'</span><span class="schwarz">, updateAction);</span><br/>router.delete(<span class="hellblau">'/:id'</span><span class="schwarz">, validator.param(</span><span class="hellblau">'id'</span><span class="schwarz">).isInt(), deleteAction);</span><br/> <br/><span class="rot">export</span><span class="schwarz"> { router }; </span><span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 10.38</b>    
            Validation Schema for Creating New Data Records (movie/index.js)</p>
            <p class="standard">The schema you define with the <samp class="listingcharacter listingcharacter">checkSchema</samp><a class="indexanchor" id="i10_81"/> function covers the two fields, <samp class="listingcharacter listingcharacter">title</samp> and <samp class="listingcharacter listingcharacter">year</samp>, where <samp class="listingcharacter listingcharacter">title</samp> must be a string of between 1 and 20 characters in length. Depending on whether there is a general validation error or a length violation, the respective error message gets selected. Validating the <samp class="listingcharacter listingcharacter">year</samp> field is much easier because the condition is merely that it must be a number.</p>
            <p class="standard">As is the case with middleware, defining and registering the schema alone does nothing for you; you must also pick up the validation result in the controller and respond to it accordingly. To do so, you should use the <samp class="listingcharacter listingcharacter">validationResult</samp> function, as you’ve already done before. In <span class="crossreference "><a href="10_008.html#l10.39">Listing 10.39</a></span>, you can see what its code looks like.</p>
            <div class="listing " id="l10.39"><pre><span class="rot">import</span><span class="schwarz"> { getAll, </span><span class="rot">get</span><span class="schwarz">, save, remove } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./model.js'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> jsonXml </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'jsontoxml'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> validator </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'express-validator'</span><span class="schwarz">;</span><br/> <br/><span class="rot">function</span><span class="schwarz"> getLinks(current, base) {...}</span><br/> <br/><span class="rot"><a id="p334"/>export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> listAction(request, response) {...}</span><br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> detailAction(request, response) {...}</span><br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> createAction(request, response) {</span><br/>  <span class="rot">try</span><span class="schwarz"> {</span><br/>    <span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">const</span><span class="schwarz"> errors </span><span class="dunkelblau">=</span><span class="schwarz"> validator.validationResult(request);</span><br/>    <span class="rot">if</span><span class="schwarz"> (</span><span class="dunkelblau">!</span><span class="schwarz">errors.isEmpty()) {</span><br/>      <span class="rot">return</span><span class="schwarz"> response.status(400).json({ errors: errors.array() });</span><br/>    }<br/> </samp></span><br/>    <span class="rot">const</span><span class="schwarz"> movie </span><span class="dunkelblau">=</span><span class="schwarz"> {</span><br/>      title: request.body.title,<br/>      year: request.body.year,<br/>      <span class="rot">public</span><span class="schwarz">: parseInt(request.body.</span><span class="rot">public</span><span class="schwarz">, 10) </span><span class="dunkelblau">===</span><span class="schwarz"> 1 </span><span class="dunkelblau">?</span><span class="schwarz"> 1 : 0,</span><br/>    };<br/>    <span class="rot">const</span><span class="schwarz"> newMovie </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> save(movie, request.user.id);</span><br/>    response.status(201).json(newMovie);<br/>  } <span class="rot">catch </span><span class="schwarz">(</span><span class="rot">e</span><span class="schwarz">) {</span><br/>    <span class="magenta">console</span><span class="schwarz">.error(e);</span><br/>    response.status(500).json(<span class="hellblau">'An error happened'</span><span class="schwarz">);</span><br/>  }<br/>}<br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> updateAction(request, response) {...}</span><br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> deleteAction(request, response) {...} </span><span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 10.39</b>    
            Checking the Validation Result in the Controller (movie/controller.js)</p>
            <p class="standard">With these adjustments, you can now restart your server process and test the creation of data records. <span class="crossreference "><a href="10_008.html#l10.40">Listing 10.40</a></span> also shows clearly that in case of an erroneous request, not only the first error is listed but all validation violations that were found.</p>
            <div class="listing " id="l10.40"><pre><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="violett">$ curl</span><span class="dunkelblau"> -X</span><span class="violett"> </span><span class="hellblau">POST</span><span class="dunkelblau"> -d</span><span class="violett"> </span><span class="braun">"{public: 1}"</span><span class="dunkelblau"> -H</span><span class="violett"> </span><span class="braun">"Authorization: Bearer eyJ…H38"</span><span class="violett"> http://localhost:8080/movie/</span></samp></span><br/>{<span class="braun">"errors"</span><span class="violett">:[{</span><span class="braun">"msg"</span><span class="violett">:</span><span class="braun">"Title is invalid"</span><span class="violett">,</span><span class="braun">"param"</span><span class="violett">:</span><span class="braun">"title"</span><span class="violett">,</span><span class="braun">"location"</span><span class="violett">:</span><span class="braun">"body"</span><span class="violett">}, </span><br/>{<span class="braun">"msg"</span><span class="violett">:</span><span class="braun">"Title has to be between 1 and 20"</span><span class="violett">,</span><span class="braun">"param"</span><span class="violett">:</span><span class="braun">"title"</span><span class="violett">,</span><span class="braun">"location"</span><span class="violett">:</span><span class="braun">"body"</span><span class="violett">},{</span><span class="braun">"msg"</span><span class="violett">:</span><span class="braun">"Year is invalid"</span><span class="violett">,</span><span class="braun">"param"</span><span class="violett">:</span><span class="braun">"year"</span><span class="violett">,</span><span class="braun">"location"</span><span class="violett">:</span><span class="braun">"body"</span><span class="violett">}]}</span><span class="schwarz"> </span><span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 10.40</b>    
            Invalid Request to Create a New Data Record</p>
            <p class="standard"><span class="crossreference "><a href="10_008.html#f10.12">Figure 10.12</a></span> shows a similar request in Postman with the difference being that here, the data type of the <samp class="listingcharacter listingcharacter">title</samp> field was chosen incorrectly as a Boolean, which triggers a corresponding error message.</p>
            <div class="imagebox figure-type"><a href="img-f10.12.html" id="f10.12"><img alt="Incorrect Request with Postman" id="img-f10.12" src="bilderklein/klein10_012.png"/></a></div>
            <p class="caption "><b>Figure 10.12</b>    
            <a id="p335"/>Incorrect Request with Postman</p>
        
    </div><p class="signatur"/>
                    </body>
                </html>