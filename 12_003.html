<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
                    
        <head><meta content="application/xhtml+xml; charset=utf-8" http-equiv="Content-Type"/>
            <meta content="application/xhtml+xml; charset=utf-8" name="content-type"/>
            <meta content="Real-Time Web Applications" name="title"/>
            <meta content="Sebastian Springer" name="author"/>
            <meta content="Rheinwerk Publishing" name="publisher"/>
            <meta content="© 2022 by Rheinwerk Publishing Inc., Boston (MA)" name="copyright"/>
            <meta content="Node.js - The Comprehensive Guide - Real-Time Web Applications" name="description"/>
            <meta content="en" name="language"/>
            <title>Real-Time Web Applications</title>
            <link href="common/main.css" rel="stylesheet" type="text/css"/>
<meta content="urn:uuid:e0000000-0000-0000-0000-000029756394" name="Adept.expected.resource"/>
        </head>
    


                    <body class="office_us type_kapitel">
                        <div id="main">
        <h2 class="t2" id="h12.3">12.3    WebSockets<a class="indexanchor" id="i12_27"/></h2>
        <p class="standard">The central component of the chat application is the communication link between client and server. Through it, the user can send messages to the server and receive messages from the server. The WebSocket API is an established and widely used technology developed in the wake of HTML5<a class="indexanchor" id="i12_28"/> that solves the problem of bidirectional communication in web applications at the protocol level. (Details of this specification can be obtained from W3C at <span class="url"><a href="http://www.w3.org/TR/2009/WD-websockets-20091222/">www.w3.org/TR/2009/WD-websockets-20091222/</a></span>.) Its browser provides you—the programmer—with an interface in JavaScript through which you can communicate with the other side using the WebSocket. The actual connection, that is, the WebSocket, is independent of HTTP. Instead, the WebSocket specification, which you can read at <span class="url"><a href="https://tools.ietf.org/html/rfc6455">https://tools.ietf.org/html/rfc6455</a></span>, describes a separate protocol that exists in parallel to HTTP. Like HTTP, the WebSocket protocol<a class="indexanchor" id="i12_29"/> is also based on the Transmission Control Protocol (TCP). A major advantage of the WebSocket API is its simplicity. <a id="p365"/>The API includes only a few methods and some events that can occur when dealing with WebSockets. <span class="crossreference "><a href="12_003.html#l12.8">Listing 12.8</a></span> shows a simple example that illustrates the use of WebSockets on the client side.</p>
        <div class="listing " id="l12.8"><pre><span class="rot">const</span><span class="schwarz"> socket </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">WebSocket(</span><span class="hellblau">'ws://localhost:8181/'</span><span class="schwarz">);</span><span class="schwarz"><br/></span><br/>socket<span class="schwarz">.send(</span><span class="hellblau">'Hello Server'</span><span class="schwarz">);</span><span class="schwarz"><br/></span><br/>socket<span class="schwarz">.</span><span class="schwarz">onmessage </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">msg</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="magenta">console</span><span class="schwarz">.log(</span><span class="schwarz">msg</span><span class="schwarz">.</span><span class="schwarz">data</span><span class="schwarz">);</span><span class="schwarz"><br/></span><span class="schwarz">};</span><span class="schwarz"> </span></pre></div>
        <p class="caption "><b>Listing 12.8</b>    
            WebSocket API Methods in Use</p>
        <p class="standard">As you can see in the example shown in <span class="crossreference "><a href="12_003.html#l12.8">Listing 12.8</a></span>, before you can use the WebSocket API, you must first create an instance of the <samp class="listingcharacter listingcharacter">WebSocket</samp> class. This is provided to you by your browser. The constructor accepts the URL you want to connect to as its first argument. Because WebSockets represent a protocol of their own, the URL also doesn’t start with <span class="italic">http://</span> as usual, but with <span class="italic">ws://</span>, which stands for WebSocket. Similar to HTTP, which has an encrypted<a class="indexanchor" id="i12_30"/> and thus secure version of the protocol in the form of HTTPS, there is also a secure version of the protocol for WebSockets in the form of secure WebSockets. The prefix for secure WebSockets is <span class="italic">wss://</span>. As a second optional argument, you can pass a string to the constructor that specifies the subprotocol. The subprotocol is used when you want to ensure that the client and server send messages to each other that they both understand. For example, you can define a specific message format for your own application. If such a specification exists, you can specify the name of your application or, even better, the name of your communication protocol as a subprotocol<a class="indexanchor" id="i12_31"/>. The client and server then only accept connections with the corresponding subprotocol.</p>
        <p class="standard">To send messages, the <samp class="listingcharacter listingcharacter">send</samp> method is used. Because the WebSocket object on which you call the method is attached to a specific connection, you don’t need to specify anything other than the message you want to pass.</p>
        <p class="standard">The <samp class="listingcharacter listingcharacter">onmessage</samp> property of the WebSocket object is assigned a function as its value, as shown in <span class="crossreference "><a href="12_003.html#l12.8">Listing 12.8</a></span>. This function serves as a callback that is called as soon as the event occurs, in this case, the arrival of a new message. This function receives a representation of the original message of the remote system as an argument.</p>
        <p class="standard">In addition to these two mechanisms for communicating via WebSockets, there are other methods and events that can be useful when developing an application. Once you’ve established a WebSocket connection, it must also be closed again at some point. This is done using the <samp class="listingcharacter listingcharacter">close</samp> method of the WebSocket object. This method doesn’t receive any parameters. If the WebSocket connection is closed by the remote system, an event is triggered. This causes the callback function you assign to the <samp class="listingcharacter listingcharacter">onclose</samp> property to be executed. Finally, the last event you should know about in the context <a id="p366"/>of the WebSocket API is the <samp class="listingcharacter listingcharacter">open</samp> event. You can assign a callback function to the <samp class="listingcharacter listingcharacter">onopen</samp> property of the WebSocket object, as you did with <samp class="listingcharacter listingcharacter">onclose</samp>, which is executed as soon as the WebSocket connection is established.</p>
        
            <h3 class="t3" id="h12.3.1">12.3.1    The Server Side<a class="indexanchor" id="i12_32"/></h3>
            <p class="standard">With this knowledge, you can now move on to adding a WebSocket connection<a class="indexanchor" id="i12_33"/> to your application. <span class="crossreference "><a href="12_003.html#l12.9">Listing 12.9</a></span> shows the first step of the required adjustments. You should save this source code in the <span class="italic">websocket.js</span> file in the <span class="italic">app</span> directory.</p>
            <div class="listing " id="l12.9"><pre><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> WebSocketServer </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'ws'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">default</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">init(</span><span class="schwarz">app</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="rot">const</span><span class="schwarz"> wss </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">WebSocketServer({</span><span class="schwarz"> port</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="schwarz">8181</span><span class="schwarz"> </span><span class="schwarz">});</span><span class="schwarz"><br/></span> <br/>  <span class="rot">const</span><span class="schwarz"> connections </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="schwarz">[];</span><span class="schwarz"><br/></span> <br/>  wss<span class="schwarz">.on(</span><span class="hellblau">'connection'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">ws</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    connections<span class="schwarz">.push(</span><span class="schwarz">ws</span><span class="schwarz">);</span><span class="schwarz"><br/></span> <br/>    connection<span class="schwarz">.on(</span><span class="hellblau">'message'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">message</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>      connections<span class="schwarz">.forEach((</span><span class="schwarz">connection</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>        connection<span class="schwarz">.</span><span class="schwarz">send </span><span class="dunkelblau">&amp;&amp;</span><span class="schwarz"> connection</span><span class="schwarz">.send(</span><span class="schwarz">message</span><span class="schwarz">);</span><span class="schwarz"><br/></span>      <span class="schwarz">});</span><span class="schwarz"><br/></span>    <span class="schwarz">});</span><span class="schwarz"><br/></span>  <span class="schwarz">});</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"> </span></pre></div>
            <p class="caption "><b>Listing 12.9</b>    
            WebSocket Backend (app/websocket.js)</p>
            <p class="standard">The <samp class="listingcharacter listingcharacter">init</samp> function creates a new <samp class="listingcharacter listingcharacter">WebSocketServer</samp>, which is also bound to port <samp class="listingcharacter listingcharacter">8181</samp> at the same time. You use the <samp class="listingcharacter listingcharacter">connections</samp> array to manage all connections so that you can address all connected clients. The <samp class="listingcharacter listingcharacter">connection</samp> event<a class="indexanchor" id="i12_34"/> is triggered when a new client connects to the server. The <samp class="listingcharacter listingcharacter">ws</samp> object of the callback function represents this client-server connection, which you can use both to receive and send messages. The <samp class="listingcharacter listingcharacter">message</samp> object occurs when a client sends a message, and you use the <samp class="listingcharacter listingcharacter">send</samp> method of the WebSocket object to send a message from the server to the client.</p>
            <p class="standard">The code of the example causes an incoming message to be distributed to all connected clients. You still need to include the <span class="italic">websocket.js</span> file you just created into the central <span class="italic">index.js</span> file of your application to enable a connection. <span class="crossreference "><a href="12_003.html#l12.10">Listing 12.10</a></span> shows the corresponding source code.</p>
            <div class="listing " id="l12.10"><pre><span class="rot"><a id="p367"/>import</span><span class="schwarz"> express </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'express'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> dirname </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'path'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> fileURLToPath </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'url'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> cookieSession </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'cookie-session'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> router </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./app/index.js'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">import</span><span class="schwarz"> initWebsocket </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./app/websocket.js'</span><span class="schwarz">;</span><br/> </samp></span><br/><span class="rot">const</span><span class="schwarz"> app </span><span class="dunkelblau">=</span><span class="schwarz"> express();</span><br/> <br/>app.use(<br/>  cookieSession({<br/>    name: <span class="hellblau">'session'</span><span class="schwarz">,</span><br/>    keys: [<span class="hellblau">'key1'</span><span class="schwarz">, </span><span class="hellblau">'key2'</span><span class="schwarz">],</span><br/>  }),<br/>);<br/>app.use(express.urlencoded({ extended: <span class="rot">false</span><span class="schwarz"> }));</span><br/> <br/>app.set(<span class="hellblau">'views'</span><span class="schwarz">, </span><span class="violett">`${dirname(fileURLToPath(import.meta.url))}/app/views`</span><span class="schwarz">);</span><br/>app.set(<span class="hellblau">'view engine'</span><span class="schwarz">, </span><span class="hellblau">'pug'</span><span class="schwarz">);</span><br/> <br/>app.get(<span class="hellblau">'/'</span><span class="schwarz">, (request, response) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>  response.render(<span class="hellblau">'login'</span><span class="schwarz">);</span><br/>});<br/> <br/>app.use(router);<br/> <br/>app.listen(8080, () <span class="dunkelblau">=&gt;</span><span class="schwarz"><br/></span>  <span class="magenta">console</span><span class="schwarz">.log(</span><span class="hellblau">'Server is listening to http://localhost:8080'</span><span class="schwarz">),</span><br/>);<br/> <br/><span class="bold"><samp class="listingcharacter listingcharacter">initWebsocket();</samp></span> <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 12.10</b>    
            WebSocket Integration (index.js)</p>
            <p class="standard">Now that the server-side implementation is complete, you can move on to the client in the next step.</p>
        
        
            <h3 class="t3" id="h12.3.2">12.3.2    The Client Side<a class="indexanchor" id="i12_35"/></h3>
            <p class="standard">The frontend of your chat application basically consists of one file—the <span class="italic">chat.pug</span> template in the <span class="italic">app/views</span> directory. <span class="crossreference "><a href="12_003.html#l12.11">Listing 12.11</a></span> shows the structure of this file.</p>
            <div class="listing " id="l12.11"><pre>html<br/>  head<br/>  body<br/><a id="p368"/>    div#<span class="schwarz">msgs(</span><span class="schwarz">style</span><span class="dunkelblau">=</span><span class="hellblau">"height:400; width:400; overflow: scroll;"</span><span class="schwarz">)</span><span class="schwarz"><br/></span><br/>    form#chatForm<br/>      input#<span class="schwarz">name(</span><span class="schwarz">type</span><span class="dunkelblau">=</span><span class="hellblau">"text"</span><span class="schwarz">)</span><span class="schwarz"><br/></span>      input#<span class="schwarz">msg(</span><span class="schwarz">type</span><span class="dunkelblau">=</span><span class="hellblau">"text"</span><span class="schwarz">)</span><span class="schwarz"><br/></span>      button#sendBtn Send<br/><br/>      script<span class="schwarz">.</span><span class="schwarz"><br/></span>        <span class="rot">const</span><span class="schwarz"> socket </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">WebSocket(</span><span class="hellblau">'ws://localhost:8181/'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="hellblau">'chat'</span><span class="schwarz">);</span><span class="schwarz"><br/></span><br/>        <span class="violett">document</span><span class="schwarz">.querySelector(</span><span class="hellblau">'#sendBtn'</span><span class="schwarz">).</span><span class="schwarz"> </span><img alt="inline image" class="inline_image" src="bilder/umbruchpfeil.png"/><br/>          <span class="schwarz">addEventListener(</span><span class="hellblau">'click'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">clickEvent</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>            clickEvent<span class="schwarz">.preventDefault();</span><span class="schwarz"><br/></span>            <span class="rot">const</span><span class="schwarz"> name </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="violett">document</span><span class="schwarz">.querySelector(</span><span class="hellblau">'#name'</span><span class="schwarz">).</span><span class="magenta">value</span><span class="schwarz">;</span><span class="schwarz"><br/></span>            <span class="rot">const</span><span class="schwarz"> msg </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="violett">document</span><span class="schwarz">.querySelector(</span><span class="hellblau">'#msg'</span><span class="schwarz">).</span><span class="magenta">value</span><span class="schwarz">;</span><span class="schwarz"><br/></span><br/>            socket<span class="schwarz">.send(</span><span class="violett">`{</span><span class="hellblau">"name"</span><span class="violett">: </span><span class="hellblau">"${name}"</span><span class="violett">, </span><span class="hellblau">"msg"</span><span class="violett">: </span><span class="hellblau">"${msg}"</span><span class="violett">}`</span><span class="schwarz">);</span><span class="schwarz"><br/></span>            <span class="violett">document</span><span class="schwarz">.querySelector(</span><span class="hellblau">'#msg'</span><span class="schwarz">).</span><span class="magenta">value</span><span class="schwarz"> </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="hellblau">''</span><span class="schwarz">;</span><span class="schwarz"><br/></span>        <span class="schwarz">});</span><span class="schwarz"><br/></span><br/>        socket<span class="schwarz">.</span><span class="schwarz">onmessage </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">msg</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>            <span class="rot">const</span><span class="schwarz"> data </span><span class="dunkelblau">=</span><span class="schwarz"> JSON</span><span class="schwarz">.parse(</span><span class="rot">await</span><span class="schwarz"> msg</span><span class="schwarz">.</span><span class="schwarz">data</span><span class="schwarz">.text());</span><span class="schwarz"><br/></span><br/>            <span class="rot">const</span><span class="schwarz"> msgEl </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="violett">document</span><span class="schwarz">.createElement(</span><span class="hellblau">'div'</span><span class="schwarz">)</span><span class="schwarz"><br/></span>            msgEl<span class="schwarz">.</span><span class="schwarz">innerText </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="violett">`${data.name}: ${data.msg}`</span><span class="schwarz">;</span><span class="schwarz"><br/></span><br/>            <span class="violett">document</span><span class="schwarz">.querySelector(</span><span class="hellblau">'#msgs'</span><span class="schwarz">).appendChild(</span><span class="schwarz">msgEl</span><span class="schwarz">);</span><span class="schwarz"><br/></span>        <span class="schwarz">};</span><span class="schwarz"> </span></pre></div>
            <p class="caption "><b>Listing 12.11</b>    
            The chat.pug Template (app/views/chat.pug)</p>
            <p class="standard">The frontend of the chat application doesn’t require any additional libraries. The first step is to create an interface<a class="indexanchor" id="i12_36"/> for your users that consists of two parts. The first part is a container in which the received messages are displayed. You can create this container in the simplest case via a <samp class="listingcharacter listingcharacter">div</samp> element. To this element, you must assign a unique ID to facilitate accessing it later. The second part of the user interface is a form through which a user can compose a message and then send it. The form contains three elements in total. With two input fields, users can define their name and formulate messages. A button is then used to send the message to the server. Finally, you need to make sure that messages get to the server and messages received from the server are displayed to the user. This task is performed by a set of JavaScript functions. As you’ve already seen in <span class="crossreference "><a href="12_003.html#l12.8">Listing 12.8</a></span>, you can create a new connection using the <samp class="listingcharacter listingcharacter">WebSocket</samp><a class="indexanchor" id="i12_37"/> constructor function of the browser’s WebSocket API. To this function, you pass the address. You use the resulting WebSocket instance to send and receive messages.</p>
            <p class="standard"><a id="p369"/>To send a message, you now register a callback function to the button’s <samp class="listingcharacter listingcharacter">click</samp> event. Within this function, you collect the values of the two input fields and send them as properties in an object using the <samp class="listingcharacter listingcharacter">send</samp> method<a class="indexanchor" id="i12_38"/> of the WebSocket object. After that, you clear the input field for the message and thus prepare the input for the next message. You can then use the <samp class="listingcharacter listingcharacter">onmessage</samp> property of the WebSocket object to handle incoming messages. For this purpose, you only need to define a callback function. This function receives the <samp class="listingcharacter listingcharacter">message</samp> object as an argument from which you can extract the text asynchronously. You can create an object from this character string by calling <samp class="listingcharacter listingcharacter">JSON.parse</samp>, which you can continue to use. For each incoming message, you generate a separate <samp class="listingcharacter listingcharacter">div</samp> container that you append to the contents of the display container.</p>
            <p class="standard">Once you’ve made these adjustments to the client and server source code, you can start your application via the <samp class="listingcharacter listingcharacter">npm start</samp> command and test it by accessing <span class="italic">http://localhost:8080</span> from your browser. First, you need to log in, then you’ll be redirected to the actual chat. With a connected client, you can only send messages to yourself. However, you won’t see the effects of the real-time web application until you connect to the server with a second browser and start sending messages. In this case, the display container is updated in both browser windows, regardless of which browser you sent the message from. The results are shown in <span class="crossreference "><a href="12_003.html#f12.2">Figure 12.2</a></span>.</p>
            <div class="imagebox figure-type"><a href="img-f12.2.html" id="f12.2"><img alt="Chat between Two Users" id="img-f12.2" src="bilderklein/klein12_002.png"/></a></div>
            <p class="caption "><b>Figure 12.2</b>    
            Chat between Two Users</p>
            <p class="standard">In the following sections, you’ll move on to extending the existing functionality of your application.</p>
        
        
            <h3 class="t3" id="h12.3.3">12.3.3    <a id="p370"/>User List</h3>
            <p class="standard">At this point, you can log in to your chat application and send messages to other users in a global chat room. The first extension of your application will now consist of adding a list of active users, so that each user<a class="indexanchor" id="i12_39"/> knows who is there to chat with. With this extension, also comes the need to establish different types of messages. Text-only messages will now be joined by status messages<a class="indexanchor" id="i12_40"/>. As soon as a user logs in to the chat server, such a status message must be sent so that the server learns the name of the new user, and every other user of the chat is also aware of the existence of the new participant. <span class="crossreference "><a href="12_003.html#l12.12">Listing 12.12</a></span> shows the customized <span class="italic">chat.pug</span> template for the frontend.</p>
            <div class="listing " id="l12.12"><pre>html<br/>  head<br/>  body<br/>    div#<span class="schwarz">msgs(</span><span class="schwarz">style</span><span class="dunkelblau">=</span><span class="hellblau">"height:400; width:400; overflow: scroll; </span><span class="bold">float:left;</span>"<span class="schwarz">)</span><br/>    <span class="bold"><samp class="listingcharacter listingcharacter">div#users(style<span class="dunkelblau">=</span><span class="hellblau">"height:400px; width:100px; overflow: scroll;"</span><span class="schwarz">)</span><br/></samp></span><br/>    form#chatForm<br/>      <span class="bold"><samp class="listingcharacter listingcharacter">label(<span class="rot">for</span><span class="dunkelblau">=</span><span class="hellblau">"msg"</span><span class="schwarz">) #{user}:</span><span class="dunkelblau">&amp;</span><span class="schwarz">nbsp;</span><br/>      input#name(type<span class="dunkelblau">=</span><span class="hellblau">"hidden"</span><span class="schwarz">, </span><span class="magenta">value</span><span class="dunkelblau">=</span><span class="schwarz">user)</span></samp></span><br/>      input#msg(type<span class="dunkelblau">=</span><span class="hellblau">"text"</span><span class="schwarz">)</span><br/>      button#sendBtn Send<br/><br/>      script.<br/>        <span class="rot">const</span><span class="schwarz"> socket </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">WebSocket(</span><span class="hellblau">'ws://localhost:8181/'</span><span class="schwarz">, </span><span class="hellblau">'chat'</span><span class="schwarz">);</span><br/>        <span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">const</span><span class="schwarz"> name </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="violett">document</span><span class="schwarz">.querySelector(</span><span class="hellblau">'#name'</span><span class="schwarz">).</span><span class="magenta">value</span><span class="schwarz">;</span><br/><br/>        socket.onopen <span class="dunkelblau">=</span><span class="schwarz"> () </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>          socket.send(JSON.stringify({type: <span class="hellblau">'join'</span><span class="schwarz">, name}));</span><br/>        }<br/></samp></span><br/>        <span class="violett">document</span><span class="schwarz">.querySelector(</span><span class="hellblau">'#sendBtn'</span><span class="schwarz">) </span><img alt="inline image" class="inline_image" src="bilder/umbruchpfeil.png"/><br/>          .addEventListener(<span class="hellblau">'click'</span><span class="schwarz">, (clickEvent) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>            clickEvent.preventDefault();<br/> <br/>            <span class="rot">const</span><span class="schwarz"> msg </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="violett">document</span><span class="schwarz">.querySelector(</span><span class="hellblau">'#msg'</span><span class="schwarz">).</span><span class="magenta">value</span><span class="schwarz">;</span><br/><br/>            socket.send(<span class="violett">`{</span><span class="bold"><span class="hellblau">"type"</span><span class="violett">: </span><span class="hellblau">"msg"</span></span><span class="violett">, </span><span class="hellblau">"name"</span><span class="violett">: </span><img alt="inline image" class="inline_image" src="bilder/umbruchpfeil.png"/><br/>              <span class="hellblau">"${name}"</span><span class="violett">, </span><span class="hellblau">"msg"</span><span class="violett">: </span><span class="hellblau">"${msg}"</span><span class="violett">}`</span><span class="schwarz">);</span><br/>            <span class="violett">document</span><span class="schwarz">.querySelector(</span><span class="hellblau">'#msg'</span><span class="schwarz">).</span><span class="magenta">value</span><span class="schwarz"> </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="hellblau">''</span><span class="schwarz">;</span><br/>        });<br/><br/>        socket.onmessage <span class="dunkelblau">=</span><span class="schwarz"> (msg) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>            <span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">const</span><span class="schwarz"> data </span><span class="dunkelblau">=</span><span class="schwarz"> JSON.parse(msg.data);</span><br/><br/><a id="p371"/>            <span class="rot">switch</span><span class="schwarz"> (data.type) {</span><br/>              <span class="rot">case</span><span class="schwarz"> </span><span class="hellblau">'msg'</span><span class="schwarz">:</span><br/>                <span class="rot">const</span><span class="schwarz"> msgEl </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="violett">document</span><span class="schwarz">.createElement(</span><span class="hellblau">'div'</span><span class="schwarz">);</span><br/>                msgEl.innerText <span class="dunkelblau">=</span><span class="schwarz"> </span><span class="violett">`${data.name}: ${data.msg}`</span><span class="schwarz">;</span><br/><br/>                <span class="violett">document</span><span class="schwarz">.querySelector(</span><span class="hellblau">'#msgs'</span><span class="schwarz">).appendChild(msgEl);</span><br/>                <span class="rot">break</span><span class="schwarz">;</span><br/>              <span class="rot">case</span><span class="schwarz"> </span><span class="hellblau">'join'</span><span class="schwarz">:</span><br/>                <span class="violett">document</span><span class="schwarz">.querySelector(</span><span class="hellblau">'#users'</span><span class="schwarz">).innerHTML </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="hellblau">''</span><span class="schwarz">;</span><br/>                data.names.forEach(name <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>                  <span class="rot">const</span><span class="schwarz"> userEl </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="violett">document</span><span class="schwarz">.createElement(</span><span class="hellblau">'div'</span><span class="schwarz">);</span><br/>                  userEl.innerText <span class="dunkelblau">=</span><span class="schwarz"> name;</span><br/><br/>                  <span class="violett">document</span><span class="schwarz">.querySelector(</span><span class="hellblau">'#users'</span><span class="schwarz">).appendChild(userEl);</span><br/>                });<br/>                <span class="rot">break</span><span class="schwarz">;</span><br/>            }</samp></span><br/>        }; <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 12.12</b>    
            Frontend with Support for Message Types (app/views/chat.pug)</p>
            <p class="standard">The customizations to the frontend consist of defining a container that contains the user list. This container has the ID <samp class="listingcharacter listingcharacter">users</samp> and is located right next to the container for displaying messages. In addition, the input field for the name is omitted. Instead of a typed name, the user’s login name should be used. The name of the user is used as a label for the input field of the message. The connection process<a class="indexanchor" id="i12_41"/> remains unchanged. Then, you use the <samp class="listingcharacter listingcharacter">onopen</samp> property to send a <samp class="listingcharacter listingcharacter">join</samp> type message to the server in a callback function. This message contains the name of the user. For sending the messages, you also add a <samp class="listingcharacter listingcharacter">type</samp> property. Furthermore, in the callback function registered on the button’s <samp class="listingcharacter listingcharacter">click</samp> event, you should remove the reference to the user name input field.</p>
            <p class="standard">When receiving messages, you must now also be able to handle different types of messages. This means you need to modify the <samp class="listingcharacter listingcharacter">onmessage</samp> handler accordingly. The character string you receive from the server is in JSON<a class="indexanchor" id="i12_42"/> format and has a field named <samp class="listingcharacter listingcharacter">type</samp>. At this point, you need to distinguish two types of messages: (1) the <samp class="listingcharacter listingcharacter">msg</samp> type used when you receive new messages (the original logic remains unchanged), and (2) the <samp class="listingcharacter listingcharacter">join</samp> type, for which you receive an array with all logged-in users next to the type. Now you still need to make sure that the user list content is removed and the modified user list, encapsulated in <samp class="listingcharacter listingcharacter">div</samp> elements, gets inserted. In the next step, you need to customize the server side so that it too can handle the new message types. <span class="crossreference "><a href="12_003.html#l12.13">Listing 12.13</a></span> contains the customized chat server source code.</p>
            <div class="listing " id="l12.13"><pre><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> WebSocketServer </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'ws'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">default</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">init(</span><span class="schwarz">app</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span><a id="p372"/>  <span class="rot">const</span><span class="schwarz"> wss </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">WebSocketServer({</span><span class="schwarz"> port</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="schwarz">8181</span><span class="schwarz"> </span><span class="schwarz">});</span><span class="schwarz"><br/></span> <br/>  <span class="rot">const</span><span class="schwarz"> connections </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter">{}</samp></span>;<br/> <br/>  wss.on(<span class="hellblau">'connection'</span><span class="schwarz">, (ws) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>    ws.on(<span class="hellblau">'message'</span><span class="schwarz">, (message) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>      <span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">const</span><span class="schwarz"> data </span><span class="dunkelblau">=</span><span class="schwarz"> JSON.parse(message);</span><br/> <br/>      <span class="rot">let</span><span class="schwarz"> msg;</span><br/> <br/>      <span class="rot">switch</span><span class="schwarz"> (data.type) {</span><br/>        <span class="rot">case</span><span class="schwarz"> </span><span class="hellblau">'join'</span><span class="schwarz">:</span><br/>          connections[data.name] <span class="dunkelblau">=</span><span class="schwarz"> ws;</span><br/>          msg <span class="dunkelblau">=</span><span class="schwarz"> JSON.stringify({</span><br/>            type: <span class="hellblau">'join'</span><span class="schwarz">,</span><br/>            names: Object.keys(connections),<br/>          });<br/>          <span class="rot">break</span><span class="schwarz">;</span><br/>        <span class="rot">case</span><span class="schwarz"> </span><span class="hellblau">'msg'</span><span class="schwarz">:</span><br/>          msg <span class="dunkelblau">=</span><span class="schwarz"> JSON.stringify({ type: </span><span class="hellblau">'msg'</span><span class="schwarz">, </span></samp></span><img alt="inline image" class="inline_image" src="bilder/umbruchpfeil.png"/><span class="bold"><samp class="listingcharacter listingcharacter"><br/>            name: data.name, msg: data.msg });<br/>          <span class="rot">break</span><span class="schwarz">;</span><br/>      }<br/> <br/>      Object.values(connections).forEach((connection) <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>        connection.send <span class="dunkelblau">&amp;&amp;</span><span class="schwarz"> connection.send(msg);</span><br/>      });</samp></span><br/>    });<br/>  });<br/>} <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 12.13</b>    
            Backend with Message Type Support (app/websocket.js)</p>
            <p class="standard">On the server side, the changes are limited to the area of WebSockets. The Express part of the application remains unchanged. An important change is that instead of using an array to store the references<a class="indexanchor" id="i12_43"/> to the individual socket connections, an object is now used for this purpose. Each socket connection is stored in this object with the name of the respective logged-in user. This mechanism allows you to assign connections to individual users. The main part of the <samp class="listingcharacter listingcharacter">message</samp> event callback function is a <samp class="listingcharacter listingcharacter">switch</samp> statement that you use to handle the different message types. The incoming data is available as JSON data and must be converted into an object before it can be used. After that, you can access the <samp class="listingcharacter listingcharacter">type</samp> property of the message and decide accordingly how to proceed with the data. In the case of a message of the <samp class="listingcharacter listingcharacter">msg</samp> type, that is, a text message, you only need to format the message accordingly. For <samp class="listingcharacter listingcharacter">join</samp> type messages, that is, when a new <a id="p373"/>user joins the chat, you must first make sure that the connection is added to the <samp class="listingcharacter listingcharacter">connections</samp> object under the user’s name. In addition, here you also prepare the <samp class="listingcharacter listingcharacter">join</samp> type message to all chat participants and insert the names of all users as a JSON array. After this case discrimination, a loop ensures that the prepared message is sent to all participants. With this adaptation of the source code, you now have a real-time list of the users currently logged in to your chat application. You can see the result in <span class="crossreference "><a href="12_003.html#f12.3">Figure 12.3</a></span>.</p>
            <div class="imagebox figure-type"><a href="img-f12.3.html" id="f12.3"><img alt="Chat Application with Participants List" id="img-f12.3" src="bilderklein/klein12_003.png"/></a></div>
            <p class="caption "><b>Figure 12.3</b>    
            Chat Application with Participants List</p>
            <p class="standard">The adjustments you made to the application now allow you to implement another feature. A user should be able to log out properly after using the application.</p>
        
        
            <h3 class="t3" id="h12.3.4">12.3.4    Logout<a class="indexanchor" id="i12_44"/></h3>
            <p class="standard">To implement the logout feature, you must first integrate a link for the user to log out. This is best placed above the display container. <span class="crossreference "><a href="12_003.html#l12.14">Listing 12.14</a></span> shows the corresponding section of the <span class="italic">chat.pug</span> template.</p>
            <div class="listing " id="l12.14"><pre><a id="p374"/>html<br/>  head<br/>  body<br/>    <span class="schwarz">div(</span><span class="schwarz">style</span><span class="dunkelblau">=</span><span class="hellblau">"width:500px; text-align:right;"</span><span class="schwarz">)</span><span class="schwarz"><br/></span>      <span class="schwarz">a(</span><span class="schwarz">href</span><span class="dunkelblau">=</span><span class="hellblau">"/logout"</span><span class="schwarz">)</span><span class="schwarz"> Logout</span><br/><br/>    div#<span class="schwarz">msgs(</span><span class="schwarz">style</span><span class="dunkelblau">=</span><span class="hellblau">"height:400; width:400; overflow: scroll; float:left;"</span><span class="schwarz">)</span><span class="schwarz"><br/></span>    div#<span class="schwarz">users(</span><span class="schwarz">style</span><span class="dunkelblau">=</span><span class="hellblau">"height:400px; width:100px; overflow: scroll;"</span><span class="schwarz">)</span><span class="schwarz"><br/></span><br/>    form#chatForm<br/>      <span class="schwarz">label(</span><span class="rot">for</span><span class="dunkelblau">=</span><span class="hellblau">"msg"</span><span class="schwarz">)</span><span class="schwarz"> #</span><span class="schwarz">{</span><span class="schwarz">user</span><span class="schwarz">}:</span><span class="dunkelblau">&amp;</span><span class="schwarz">nbsp</span><span class="schwarz">;</span><span class="schwarz"><br/></span>      input#<span class="schwarz">name(</span><span class="schwarz">type</span><span class="dunkelblau">=</span><span class="hellblau">"hidden"</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="magenta">value</span><span class="dunkelblau">=</span><span class="schwarz">user</span><span class="schwarz">)</span><span class="schwarz"><br/></span>      input#<span class="schwarz">msg(</span><span class="schwarz">type</span><span class="dunkelblau">=</span><span class="hellblau">"text"</span><span class="schwarz">)</span><span class="schwarz"><br/></span>      button#sendBtn Send<br/><br/>      script<span class="schwarz">.</span><span class="schwarz"> </span><br/><span class="schwarz">...</span><span class="schwarz"> </span></pre></div>
            <p class="caption "><b>Listing 12.14</b>    
            Logout Link (app/views/chat.pug)</p>
            <p class="standard">If a logged-in user clicks on this link, the user will be redirected to the <span class="italic">/logout</span> route of your application. You’ve already created this route as part of the base application. Currently, it ensures that the user name is deleted from the session<a class="indexanchor" id="i12_45"/> and the browser is redirected to the homepage afterwards. Because the WebSocket implementation is currently separated from the Express application, you need to create a way to communicate between the two. First, you must implement the logout feature in the WebSocket implementation. <span class="crossreference "><a href="12_003.html#l12.15">Listing 12.15</a></span> shows the associated source code.</p>
            <div class="listing " id="l12.15"><pre><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> WebSocketServer </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'ws'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">default</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">init(</span><span class="schwarz">app</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="rot">const</span><span class="schwarz"> wss </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">WebSocketServer({</span><span class="schwarz"> port</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="schwarz">8181</span><span class="schwarz"> </span><span class="schwarz">});</span><span class="schwarz"><br/></span> <br/>  <span class="rot">const</span><span class="schwarz"> connections </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="schwarz">{};</span><span class="schwarz"><br/></span> <br/>  wss<span class="schwarz">.on(</span><span class="hellblau">'connection'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">ws</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{...});</span><span class="schwarz"><br/></span> <br/>  <span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">return</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> logout(user) {</span><br/>    connections[user].close();<br/>    <span class="rot">delete</span><span class="schwarz"> connections[user];</span><br/> <br/>    <span class="rot">const</span><span class="schwarz"> msg </span><span class="dunkelblau">=</span><span class="schwarz"> JSON.stringify({</span><br/>      type: <span class="hellblau">'join'</span><span class="schwarz">,</span><br/><a id="p375"/>      names: Object.keys(connections),<br/>    });<br/> <br/>    Object.values(connections).forEach((connection) <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>      connection.send <span class="dunkelblau">&amp;&amp;</span><span class="schwarz"> connection.send(msg);</span><br/>    });<br/>  };</samp></span><br/>} <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 12.15</b>    
            Logout Support in the WebSocket (app/websocket.js)</p>
            <p class="standard">The initialization function of the WebSocket module returns a function named <samp class="listingcharacter listingcharacter">logout</samp>. This function makes sure that the user’s connection gets closed, and the representation is deleted from the <samp class="listingcharacter listingcharacter">connections</samp> object. Then a new <samp class="listingcharacter listingcharacter">join</samp> message is sent to all remaining users. In the next step, you must extend the router implementation<a class="indexanchor" id="i12_46"/> of the Express application and pass it the return value of the WebSocket <samp class="listingcharacter listingcharacter">init</samp> function. <span class="crossreference "><a href="12_003.html#l12.16">Listing 12.16</a></span> contains the customized source code.</p>
            <div class="listing " id="l12.16"><pre><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> Router </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'express'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> checkAuth </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./check-auth.js'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">export</span><span class="schwarz"> </span><span class="rot">default</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> init(logoutWebsocket) {</span></samp></span><br/>  <span class="rot">const</span><span class="schwarz"> router </span><span class="dunkelblau">=</span><span class="schwarz"> Router();</span><br/> <br/>  router.get(<span class="hellblau">'/'</span><span class="schwarz">, (request, response) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {...});</span><br/> <br/>  router.post(<span class="hellblau">'/login'</span><span class="schwarz">, (request, response) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {...});</span><br/> <br/>  router.get(<span class="hellblau">'/chat'</span><span class="schwarz">, checkAuth, (request, response) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {...});</span><br/> <br/>  router.get(<span class="hellblau">'/logout'</span><span class="schwarz">, (request, response) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>    <span class="bold"><samp class="listingcharacter listingcharacter">logoutWebsocket(request.session.user);</samp></span><br/>    <span class="rot">delete</span><span class="schwarz"> request.session.user;</span><br/>    response.redirect(<span class="hellblau">'/'</span><span class="schwarz">);</span><br/>  });<br/> <br/>  <span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">return</span><span class="schwarz"> router;</span><br/>}</samp></span> <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 12.16</b>    
            Changes to the Logout Route (app/index.js)</p>
            <p class="standard">After adapting the source code, the router is no longer returned directly, but it’s the result of the <samp class="listingcharacter listingcharacter">init</samp> function. This function received the <samp class="listingcharacter listingcharacter">logoutWebsocket</samp> function, which you can use in the <samp class="listingcharacter listingcharacter">logout</samp> route to disconnect<a class="indexanchor" id="i12_47"/> the user. The last step of the restructuring <a id="p376"/>concerns the entry file of your application, in which you still have to link the individual components, as shown in <span class="crossreference "><a href="12_003.html#l12.17">Listing 12.17</a></span>.</p>
            <div class="listing " id="l12.17"><pre><span class="rot">import</span><span class="schwarz"> express </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'express'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> dirname </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'path'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> fileURLToPath </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'url'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> cookieSession </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'cookie-session'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter">router</samp></span> <span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./app/index.js'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> initWebsocket </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./app/websocket.js'</span><span class="schwarz">;</span><br/> <br/><span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">const</span><span class="schwarz"> logoutWebsocket </span><span class="dunkelblau">=</span><span class="schwarz"> initWebsocket();</span><br/> </samp></span><br/><span class="rot">const</span><span class="schwarz"> app </span><span class="dunkelblau">=</span><span class="schwarz"> express();</span><br/> <br/>app.use(<br/>  cookieSession({<br/>    name: <span class="hellblau">'session'</span><span class="schwarz">,</span><br/>    keys: [<span class="hellblau">'key1'</span><span class="schwarz">, </span><span class="hellblau">'key2'</span><span class="schwarz">],</span><br/>  }),<br/>);<br/>app.use(express.urlencoded({ extended: <span class="rot">false</span><span class="schwarz"> }));</span><br/> <br/>app.set(<span class="hellblau">'views'</span><span class="schwarz">, </span><span class="violett">`${dirname(fileURLToPath(import.meta.url))}/app/views`</span><span class="schwarz">);</span><br/>app.set(<span class="hellblau">'view engine'</span><span class="schwarz">, </span><span class="hellblau">'pug'</span><span class="schwarz">);</span><br/> <br/>app.get(<span class="hellblau">'/'</span><span class="schwarz">, (request, response) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>  response.render(<span class="hellblau">'login'</span><span class="schwarz">);</span><br/>});<br/> <br/><span class="bold"><samp class="listingcharacter listingcharacter">app.use(router(logoutWebsocket));<br/> </samp></span><br/>app.listen(8080, () <span class="dunkelblau">=&gt;</span><span class="schwarz"><br/></span>  <span class="magenta">console</span><span class="schwarz">.log(</span><span class="hellblau">'Server is listening to http://localhost:8080'</span><span class="schwarz">),</span><br/>); <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 12.17</b>    
            Adjustment for Logout in the Entry File (index.js)</p>
            <p class="standard">The order of the calls is crucial in this case. You need to perform the WebSocket setup<a class="indexanchor" id="i12_48"/> first and only then include the router. After these changes, you should restart your application, and now you can both log in and log out your users. <span class="crossreference "><a href="12_003.html#f12.4">Figure 12.4</a></span> shows the view of the chat application after one of the two users has logged out. For the first user, the view remains unchanged, and the messages of the second user are still visible. However, the user list now only shows one user instead of two.</p>
            <div class="imagebox figure-type"><a href="img-f12.4.html" id="f12.4"><img alt="Logout Routine in the Chat" id="img-f12.4" src="bilderklein/klein12_004.png"/></a></div>
            <p class="caption "><b>Figure 12.4</b>    
            <a id="p377"/>Logout Routine in the Chat</p>
            <p class="standard">As an alternative to the WebSocket module presented here, you can use the Socket.IO library, which offers some interesting features.</p>
        
    </div><p class="signatur"/>
                    </body>
                </html>