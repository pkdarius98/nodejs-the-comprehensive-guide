<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
                    
        <head><meta content="application/xhtml+xml; charset=utf-8" http-equiv="Content-Type"/>
            <meta content="application/xhtml+xml; charset=utf-8" name="content-type"/>
            <meta content="Authentication and Session Handling" name="title"/>
            <meta content="Sebastian Springer" name="author"/>
            <meta content="Rheinwerk Publishing" name="publisher"/>
            <meta content="© 2022 by Rheinwerk Publishing Inc., Boston (MA)" name="copyright"/>
            <meta content="Node.js - The Comprehensive Guide - Authentication and Session Handling" name="description"/>
            <meta content="en" name="language"/>
            <title>Authentication and Session Handling</title>
            <link href="common/main.css" rel="stylesheet" type="text/css"/>
<meta content="urn:uuid:e0000000-0000-0000-0000-000029756394" name="Adept.expected.resource"/>
        </head>
    


                    <body class="office_us type_kapitel">
                        <div id="main">
        <h2 class="t2" id="h9.2">9.2    Setup<a class="indexanchor" id="i09_13"/> and Configuration<a class="indexanchor" id="i09_14"/></h2>
        <p class="standard">Compared to other middleware components for Express, Passport is a bit more complex to set up. You need to create a set of prerequisites and configure your application correctly. Afterwards, securing the routes requires very little effort.</p>
        
            <h3 class="t3" id="h9.2.1">9.2.1    Installation<a class="indexanchor" id="i09_15"/></h3>
            <p class="standard">Passport itself is available under the npm package of the same name. You can install it via the <samp class="listingcharacter listingcharacter">npm install passport</samp> command. In addition to Express, which has already been installed, you also need the <samp class="listingcharacter listingcharacter">express-session</samp> package.</p>
        
        
            <h3 class="t3" id="h9.2.2">9.2.2    Configuration<a class="indexanchor" id="i09_16"/></h3>
            <p class="standard">Passport is usually configured at a central location. In your application, you should do this in the <span class="italic">index.js</span> file. To keep this file manageable, you can configure Passport in a separate help file.</p>
            <p class="standard"><span class="crossreference "><a href="09_002.html#l9.1">Listing 9.1</a></span> contains the source code of the <span class="italic">auth.js</span> file with the Passport configuration.</p>
            <div class="listing " id="l9.1"><pre><span class="rot">import</span><span class="schwarz"> passport </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'passport'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> expressSession </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'express-session'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">default</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">app</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  passport<span class="schwarz">.serializeUser((</span><span class="schwarz">user</span><span class="schwarz">,</span><span class="schwarz"> done</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">done(</span><span class="rot">null</span><span class="schwarz">,</span><span class="schwarz"> user</span><span class="schwarz">.</span><span class="schwarz">username</span><span class="schwarz">));</span><span class="schwarz"><br/></span>  passport<span class="schwarz">.deserializeUser((</span><span class="schwarz">id</span><span class="schwarz">,</span><span class="schwarz"> done</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="rot">const</span><span class="schwarz"> user </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>      username<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'sspringer'</span><span class="schwarz">,</span><span class="schwarz"><br/></span>      firstname<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'Sebastian'</span><span class="schwarz">,</span><span class="schwarz"><br/></span>      lastname<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'Springer'</span><span class="schwarz">,</span><span class="schwarz"><br/></span>    <span class="schwarz">};</span><span class="schwarz"><br/></span>    <span class="schwarz">done(</span><span class="rot">null</span><span class="schwarz">,</span><span class="schwarz"> user</span><span class="schwarz">);</span><span class="schwarz"><br/></span>  <span class="schwarz">});</span><span class="schwarz"><br/></span>  app<span class="schwarz">.use(</span><span class="schwarz"><br/></span>    <span class="schwarz">expressSession({</span><span class="schwarz"><br/></span>      secret<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'top secret'</span><span class="schwarz">,</span><span class="schwarz"><br/></span>      resave<span class="schwarz">:</span><span class="schwarz"> </span><span class="rot">false</span><span class="schwarz">,</span><span class="schwarz"><br/></span>      saveUninitialized<span class="schwarz">:</span><span class="schwarz"> </span><span class="rot">false</span><span class="schwarz">,</span><span class="schwarz"><br/></span>    <span class="schwarz">}),</span><span class="schwarz"><br/></span>  <span class="schwarz">);</span><span class="schwarz"><br/></span><a id="p275"/>  app<span class="schwarz">.use(</span><span class="schwarz">passport</span><span class="schwarz">.initialize());</span><span class="schwarz"><br/></span>  app<span class="schwarz">.use(</span><span class="schwarz">passport</span><span class="schwarz">.session());</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"> </span></pre></div>
            <p class="caption "><b>Listing 9.1</b>    
            Authentication Configuration (auth.js)</p>
            <p class="standard">The <samp class="listingcharacter listingcharacter">serializeUser</samp> and <samp class="listingcharacter listingcharacter">deserializeUser</samp> methods<a class="indexanchor" id="i09_17"/> accept a function that is used to restore the user data for subsequent requests. Passport stores the information in a session<a class="indexanchor" id="i09_18"/>. To keep this data as compact as possible, you need unique information to get back to the complete user data. In the example, the user name is this unique key.</p>
            <p class="standard">In the callback of the <samp class="listingcharacter listingcharacter">serializeUser</samp> method, you get access to the <samp class="listingcharacter listingcharacter">user</samp> object. The second argument is another callback function. You pass an error object to it when it’s called, or the value <samp class="listingcharacter listingcharacter">zero</samp> and the serialized user information in the case of success.</p>
            <p class="standard">The <samp class="listingcharacter listingcharacter">deserializeUser</samp> method works exactly the opposite way. You also pass a callback function to it, which receives the serialized user information and another callback function. This callback function is in turn called with an optional error object as well as the deserialized user information.</p>
            <p class="standard">Usually, the callback functions are named <samp class="listingcharacter listingcharacter">done</samp> because they are called as soon as the potentially asynchronous serialization or deserialization is completed.</p>
            <p class="standard">In the current implementation, authentication as well as serialization and deserialization are still static. Throughout this chapter, the database will be integrated at these points, making the entire process much more flexible.</p>
            <p class="standard">To enable Passport to remember the user’s login data across multiple requests, you must use the session middleware for Express. This makes sure the session gets saved in a browser cookie<a class="indexanchor" id="i09_19"/>. As an option, you should use the <samp class="listingcharacter listingcharacter">secret</samp> property to pass a character string that will be used to sign the session cookie. In addition, you must set the <samp class="listingcharacter listingcharacter">saveUninitialized</samp> property to <samp class="listingcharacter listingcharacter">false</samp> to prevent new uninitialized sessions from being saved on the server. The <samp class="listingcharacter listingcharacter">resave</samp> property ensures that unchanged session information is also saved back. To change this behavior, the value must be set to <samp class="listingcharacter listingcharacter">false</samp>. For both <samp class="listingcharacter listingcharacter">saveUninitialized</samp> and <samp class="listingcharacter listingcharacter">resave</samp>, you must set a value in both cases, as otherwise a warning will be triggered.</p>
            <p class="standard">By calling <samp class="listingcharacter listingcharacter">passport.initialize</samp>, you initialize Passport and thus create the connection between Express and Passport. Using <samp class="listingcharacter listingcharacter">passport.session</samp> ensures that login sessions are stored using the Express session middleware.</p>
        
        
            <h3 class="t3" id="h9.2.3">9.2.3    Strategy Configuration<a class="indexanchor" id="i09_20"/></h3>
            <p class="standard">Depending on the strategy used, the appropriate package must be installed and configured. The <samp class="listingcharacter listingcharacter">npm install passport-local</samp> command installs the <samp class="listingcharacter listingcharacter">local</samp> strategy<a class="indexanchor" id="i09_21"/> package, which allows simple authentication against a user name and password combination. You include the configuration of the strategy in the <span class="italic">auth.js</span> file, as shown in <span class="crossreference "><a href="09_002.html#l9.2">Listing 9.2</a></span>.</p>
            <div class="listing " id="l9.2"><pre><span class="rot"><a id="p276"/>import</span><span class="schwarz"> passport </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'passport'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> expressSession </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'express-session'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">import</span><span class="schwarz"> LocalStrategy </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'passport-local'</span><span class="schwarz">;</span><br/> </samp></span><br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">default</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> (app) {</span><br/>  passport.serializeUser((user, done) <span class="dunkelblau">=&gt;</span><span class="schwarz"> done(</span><span class="rot">null</span><span class="schwarz">, user.username));</span><br/>  passport.deserializeUser((id, done) <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>    <span class="rot">const</span><span class="schwarz"> user </span><span class="dunkelblau">=</span><span class="schwarz"> {</span><br/>      username: <span class="hellblau">'sspringer'</span><span class="schwarz">,</span><br/>      firstname: <span class="hellblau">'Sebastian'</span><span class="schwarz">,</span><br/>      lastname: <span class="hellblau">'Springer'</span><span class="schwarz">,</span><br/>    };<br/>    done(<span class="rot">null</span><span class="schwarz">, user);</span><br/>  });<br/> <br/>  <span class="bold"><samp class="listingcharacter listingcharacter">passport.use(<br/>    <span class="rot">new </span><span class="schwarz">LocalStrategy((username, password, done) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>      <span class="rot">if</span><span class="schwarz"> (username </span><span class="dunkelblau">===</span><span class="schwarz"> </span><span class="hellblau">'sspringer'</span><span class="schwarz"> </span><span class="dunkelblau">&amp;&amp;</span><span class="schwarz"> password </span><span class="dunkelblau">===</span><span class="schwarz"> </span><span class="hellblau">'test'</span><span class="schwarz">) {</span><br/>        done(<span class="rot">null</span><span class="schwarz">, {</span><br/>          username: <span class="hellblau">'sspringer'</span><span class="schwarz">,</span><br/>          firstname: <span class="hellblau">'Sebastian'</span><span class="schwarz">,</span><br/>          lastname: <span class="hellblau">'Springer'</span><span class="schwarz">,</span><br/>        });<br/>      } <span class="rot">else</span><span class="schwarz"> {</span><br/>        done(<span class="rot">null</span><span class="schwarz">, </span><span class="rot">false</span><span class="schwarz">);</span><br/>      }<br/>    }),<br/>  );<br/> <br/></samp></span>  app.use(<br/>    expressSession({<br/>      secret: <span class="hellblau">'top secret'</span><span class="schwarz">,</span><br/>      resave: <span class="rot">false</span><span class="schwarz">,</span><br/>      saveUninitialized: <span class="rot">false</span><span class="schwarz">,</span><br/>    }),<br/>  );<br/>  app.use(passport.initialize());<br/>  app.use(passport.session());<br/>} <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 9.2</b>    
            Integrating the “local” Strategy</p>
            <p class="standard">When integrating the strategy plug-ins<a class="indexanchor" id="i09_22"/>, Passport takes its cue from the middleware system of Express. You can use the <samp class="listingcharacter listingcharacter">use</samp> method to add a new instance of the strategy. To <a id="p277"/>create this instance, you can use the constructor exported for you by the <samp class="listingcharacter listingcharacter">local</samp> strategy package.</p>
            <p class="standard">In the specific case of <samp class="listingcharacter listingcharacter">local</samp> strategy, you pass a callback function that receives the user name and password as arguments. The third argument is a callback function you can use to indicate the success or failure<a class="indexanchor" id="i09_23"/> of the login. This callback function is required because the user name and password verification is asynchronous in most cases. If the login was successful, you should call this callback function, which you should name <samp class="listingcharacter listingcharacter">done</samp> according to the naming convention, with the value <samp class="listingcharacter listingcharacter">null</samp> and an object representation of the user. If the information entered by the user isn’t correct, that is, there is no matching user object, you must call the <samp class="listingcharacter listingcharacter">done</samp> function with the values <samp class="listingcharacter listingcharacter">null</samp> and <samp class="listingcharacter listingcharacter">false</samp>.</p>
            <p class="standard">Passport expects the user name and password to be sent to the server via a <samp class="listingcharacter listingcharacter">POST</samp> request and to be named <samp class="listingcharacter listingcharacter">username</samp> and <samp class="listingcharacter listingcharacter">password</samp> by default. You can customize this behavior via an options object that you pass as the first argument to the constructor.</p>
            <p class="standard">With these changes to your application, you’ve completed the basic setup for Passport. The next step consists of integrating the library<a class="indexanchor" id="i09_24"/> into your application’s workflow with the goal of allowing your users to log in.</p>
        
    </div><p class="signatur"/>
                    </body>
                </html>