<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
                    
        <head><meta content="application/xhtml+xml; charset=utf-8" http-equiv="Content-Type"/>
            <meta content="application/xhtml+xml; charset=utf-8" name="content-type"/>
            <meta content="Real-Time Web Applications" name="title"/>
            <meta content="Sebastian Springer" name="author"/>
            <meta content="Rheinwerk Publishing" name="publisher"/>
            <meta content="© 2022 by Rheinwerk Publishing Inc., Boston (MA)" name="copyright"/>
            <meta content="Node.js - The Comprehensive Guide - Real-Time Web Applications" name="description"/>
            <meta content="en" name="language"/>
            <title>Real-Time Web Applications</title>
            <link href="common/main.css" rel="stylesheet" type="text/css"/>
<meta content="urn:uuid:e0000000-0000-0000-0000-000029756394" name="Adept.expected.resource"/>
        </head>
    


                    <body class="office_us type_kapitel">
                        <div id="main">
        <h2 class="t2" id="h12.4">12.4    Socket.IO<a class="indexanchor" id="i12_49"/></h2>
        <p class="standard">Socket.IO is an abstraction library for real-time-enabled web applications. The goal of this library is to enable cross-browser real-time web applications<a class="indexanchor" id="i12_50"/> that aren’t tied to a specific communication protocol. For this purpose, Socket.IO supports a whole range of communication options that allow for a bidirectional connection between client and server. Socket.IO consists of two components: a server component and a file the client must load to use the library. Socket.IO is completely implemented in JavaScript, which means that you don’t need any additional plug-ins in your browser. On the server side, Socket.IO is available as an npm package. Once installed and integrated, Socket.IO is responsible for negotiating the type of connection itself. In this context, Socket.IO uses a number of technologies that are checked for one after the other. For example, it checks whether the browser supports WebSockets. If this isn’t the case, an attempt is made to establish the connection via JSON with Padding (JSONP) polling<a class="indexanchor" id="i12_51"/>, Flash sockets<a class="indexanchor" id="i12_52"/>, or Asynchronous JavaScript and XML (AJAX) long polling<a class="indexanchor" id="i12_53"/> as an alternative. In most cases, at least one of these technologies is supported by a browser, and you can then use this connection to implement your real-time web application. In the following step, you’ll first prepare your chat application to use Socket.IO.</p>
        
            <h3 class="t3" id="h12.4.1">12.4.1    <a id="p378"/>Installation<a class="indexanchor" id="i12_54"/> and Integration<a class="indexanchor" id="i12_55"/></h3>
            <p class="standard">As just described, Socket.IO is available on the server side as an npm package. This means you can easily install this library using the <samp class="listingcharacter listingcharacter">npm install socket.io</samp> command. Socket.IO is quite an extensive library with some dependencies<a class="indexanchor" id="i12_56"/> that npm resolves automatically during installation. For the extension of your application, you can remove the <samp class="listingcharacter listingcharacter">websocket</samp> package again. To do this, you must use command <samp class="listingcharacter listingcharacter">npm uninstall websocket</samp>. This removes the package from both the local <span class="italic">node_modules</span> directory and from <span class="italic">package.json</span>.</p>
            <p class="standard">The customizations of your application are mainly limited to the part outside the Express.js application. Once the installation is complete, you can proceed to integrating the library on the server side. To do this, you need to make some adjustments to the <span class="italic">index.js</span> file. <span class="crossreference "><a href="12_004.html#l12.18">Listing 12.18</a></span> contains the new source code of this file.</p>
            <div class="listing " id="l12.18"><pre><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">import</span><span class="schwarz"> { createServer } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'http'</span><span class="schwarz">;</span></samp></span><br/><span class="rot">import</span><span class="schwarz"> express </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'express'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> { dirname } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'path'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> { fileURLToPath } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'url'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> cookieSession </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'cookie-session'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> router </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./app/index.js'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> initWebsocket </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./app/websocket.js'</span><span class="schwarz">;</span><br/><span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">import</span><span class="schwarz"> { Server } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'socket.io'</span><span class="schwarz">;</span><br/> </samp></span><br/><span class="rot">const</span><span class="schwarz"> app </span><span class="dunkelblau">=</span><span class="schwarz"> express();</span><br/> <br/><span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">const</span><span class="schwarz"> server </span><span class="dunkelblau">=</span><span class="schwarz"> createServer(app);</span><br/>server.listen(8080, () <span class="dunkelblau">=&gt;</span><span class="schwarz"><br/></span>  <span class="magenta">console</span><span class="schwarz">.log(</span><span class="hellblau">'Server is listening to http://localhost:8080'</span><span class="schwarz">),</span><br/>);<br/><span class="rot">const</span><span class="schwarz"> io </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">Server().listen(server);</span><br/> <br/><span class="rot">const</span><span class="schwarz"> logoutWebsocket </span><span class="dunkelblau">=</span><span class="schwarz"> initWebsocket(io);</span><br/> </samp></span><br/>app.use(<br/>  cookieSession({<br/>    name: <span class="hellblau">'session'</span><span class="schwarz">,</span><br/>    keys: [<span class="hellblau">'key1'</span><span class="schwarz">, </span><span class="hellblau">'key2'</span><span class="schwarz">],</span><br/>  }),<br/>);<br/>app.use(express.urlencoded({ extended: <span class="rot">false</span><span class="schwarz"> }));</span><br/> <br/>app.set(<span class="hellblau">'views'</span><span class="schwarz">, </span><span class="violett">`${dirname(fileURLToPath(import.meta.url))}/app/views`</span><span class="schwarz">);</span><br/>app.set(<span class="hellblau">'view engine'</span><span class="schwarz">, </span><span class="hellblau">'pug'</span><span class="schwarz">);</span><br/> <br/><a id="p379"/>app.get(<span class="hellblau">'/'</span><span class="schwarz">, (request, response) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>  response.render(<span class="hellblau">'login'</span><span class="schwarz">);</span><br/>});<br/> <br/>app.use(router(logoutWebsocket)); <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 12.18</b>    
            Server-Side Integration of Socket.IO (index.js)</p>
            <p class="standard">With these changes, you not only create the foundation for a functioning server implementation but also use it to build the basis for implementing the client side. Socket.IO provides you with the source code of the library for the server and takes care of the delivery<a class="indexanchor" id="i12_57"/> of the source file for the client<a class="indexanchor" id="i12_58"/> at the same time. This mechanism works automatically, so you only need to add one line to your template to use Socket.IO there. <span class="crossreference "><a href="12_004.html#l12.19">Listing 12.19</a></span> contains the corresponding extension of the template.</p>
            <div class="listing " id="l12.19"><pre>html<br/>  head<br/>    <span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter">script(src<span class="dunkelblau">=</span><span class="hellblau">"/socket.io/socket.io.js"</span><span class="schwarz">)</span></samp></span><br/>  body<br/>... <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 12.19</b>    
            Client-Side Integration of Socket.IO (app/views/chat.pug.js)</p>
            <p class="standard">With these two changes, you’ve already met all the requirements for the additional adjustments. In the next sections, you’ll see which parts of your application you need to modify to switch from WebSockets to Socket.IO.</p>
        
        
            <h3 class="t3" id="h12.4.2">12.4.2    Socket.IO API<a class="indexanchor" id="i12_59"/></h3>
            <p class="standard">The Socket.IO API is similar to that of the WebSocket API. However, the two technologies differ in some details. The frontend<a class="indexanchor" id="i12_60"/> customizations are limited to the JavaScript portion of the template shown in <span class="crossreference "><a href="12_004.html#l12.20">Listing 12.20</a></span>.</p>
            <div class="listing " id="l12.20"><pre>html<br/>  head<br/>    <span class="schwarz">script(</span><span class="schwarz">src</span><span class="dunkelblau">=</span><span class="hellblau">"/socket.io/socket.io.js"</span><span class="schwarz">)</span><span class="schwarz"><br/></span>  body<br/>    <span class="schwarz">div(</span><span class="schwarz">style</span><span class="dunkelblau">=</span><span class="hellblau">"width:500px; text-align:right;"</span><span class="schwarz">)</span><span class="schwarz"><br/></span>      <span class="schwarz">a(</span><span class="schwarz">href</span><span class="dunkelblau">=</span><span class="hellblau">"/logout"</span><span class="schwarz">)</span><span class="schwarz"> Logout</span><br/><br/>    div#<span class="schwarz">msgs(</span><span class="schwarz">style</span><span class="dunkelblau">=</span><span class="hellblau">"height:400; width:400; overflow: scroll; float:left;"</span><span class="schwarz">)</span><span class="schwarz"><br/></span>    div#<span class="schwarz">users(</span><span class="schwarz">style</span><span class="dunkelblau">=</span><span class="hellblau">"height:400px; width:100px; overflow: scroll;"</span><span class="schwarz">)</span><span class="schwarz"><br/></span><br/>    form#chatForm<br/>      <span class="schwarz">label(</span><span class="rot">for</span><span class="dunkelblau">=</span><span class="hellblau">"msg"</span><span class="schwarz">)</span><span class="schwarz"> #</span><span class="schwarz">{</span><span class="schwarz">user</span><span class="schwarz">}:</span><span class="dunkelblau">&amp;</span><span class="schwarz">nbsp</span><span class="schwarz">;</span><span class="schwarz"><br/></span><a id="p380"/>      input#<span class="schwarz">name(</span><span class="schwarz">type</span><span class="dunkelblau">=</span><span class="hellblau">"hidden"</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="magenta">value</span><span class="dunkelblau">=</span><span class="schwarz">user</span><span class="schwarz">)</span><span class="schwarz"><br/></span>      input#<span class="schwarz">msg(</span><span class="schwarz">type</span><span class="dunkelblau">=</span><span class="hellblau">"text"</span><span class="schwarz">)</span><span class="schwarz"><br/></span>      button#sendBtn Send<br/><br/>      script<span class="schwarz">.</span><span class="schwarz"><br/></span>        <span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">const</span><span class="schwarz"> socket </span><span class="dunkelblau">=</span><span class="schwarz"> io.connect(</span><span class="hellblau">'http://localhost:8080'</span><span class="schwarz">);</span></samp></span><br/>        <span class="rot">const</span><span class="schwarz"> name </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="violett">document</span><span class="schwarz">.querySelector(</span><span class="hellblau">'#name'</span><span class="schwarz">).</span><span class="magenta">value</span><span class="schwarz">;</span><br/><br/>        <span class="bold"><samp class="listingcharacter listingcharacter">socket.on(<span class="hellblau">'connect'</span><span class="schwarz">, () </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>          socket.emit(<span class="hellblau">'join'</span><span class="schwarz">, {name})</span><br/>        })<br/></samp></span><br/>        <span class="violett">document</span><span class="schwarz">.querySelector(</span><span class="hellblau">'#sendBtn'</span><span class="schwarz">) </span><br/>          .addEventListener(<span class="hellblau">'click'</span><span class="schwarz">, (clickEvent) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>            clickEvent.preventDefault();<br/> <br/>            <span class="rot">const</span><span class="schwarz"> msg </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="violett">document</span><span class="schwarz">.querySelector(</span><span class="hellblau">'#msg'</span><span class="schwarz">).</span><span class="magenta">value</span><span class="schwarz">;</span><br/><br/>            <span class="bold"><samp class="listingcharacter listingcharacter">socket.emit(<span class="hellblau">'msg'</span><span class="schwarz">, {msg});</span></samp></span><br/>            <span class="violett">document</span><span class="schwarz">.querySelector(</span><span class="hellblau">'#msg'</span><span class="schwarz">).</span><span class="magenta">value</span><span class="schwarz"> </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="hellblau">''</span><span class="schwarz">;</span><br/>        });<br/><br/>        <span class="bold"><samp class="listingcharacter listingcharacter">socket.on(<span class="hellblau">'msg'</span><span class="schwarz">, (data) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>          <span class="rot">const</span><span class="schwarz"> msgEl </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="violett">document</span><span class="schwarz">.createElement(</span><span class="hellblau">'div'</span><span class="schwarz">);</span><br/>          msgEl.innerText <span class="dunkelblau">=</span><span class="schwarz"> </span><span class="violett">`${data.name}: ${data.msg}`</span><span class="schwarz">;</span><br/><br/>          <span class="violett">document</span><span class="schwarz">.querySelector(</span><span class="hellblau">'#msgs'</span><span class="schwarz">).appendChild(msgEl);</span><br/>        });<br/><br/>        socket.on(<span class="hellblau">'join'</span><span class="schwarz">, (data) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>          <span class="violett">document</span><span class="schwarz">.querySelector(</span><span class="hellblau">'#users'</span><span class="schwarz">).innerHTML </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="hellblau">''</span><span class="schwarz">;</span><br/>          data.names.forEach(name <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>            <span class="rot">const</span><span class="schwarz"> userEl </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="violett">document</span><span class="schwarz">.createElement(</span><span class="hellblau">'div'</span><span class="schwarz">);</span><br/>            userEl.innerText <span class="dunkelblau">=</span><span class="schwarz"> name;</span><br/><br/>            <span class="violett">document</span><span class="schwarz">.querySelector(</span><span class="hellblau">'#users'</span><span class="schwarz">).appendChild(userEl);</span><br/>          });<br/>        });</samp></span> <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 12.20</b>    
            Adapting the Frontend to Socket.IO (app/views/chat.pug)</p>
            <p class="standard">You now establish the connection to the server using the <samp class="listingcharacter listingcharacter">connect</samp> method of the <samp class="listingcharacter listingcharacter">io</samp> object instead of the <samp class="listingcharacter listingcharacter">WebSocket</samp> constructor function. This provides you with an instance of the connection<a class="indexanchor" id="i12_61"/> to the Socket.IO server, which you can use later. You implement the <a id="p381"/>notification of the server about a new user within the callback function of the <samp class="listingcharacter listingcharacter">connect</samp> event, which is triggered as soon as the connection is established. Instead of the WebSocket <samp class="listingcharacter listingcharacter">send</samp>, Socket.IO uses the <samp class="listingcharacter listingcharacter">emit</samp> method<a class="indexanchor" id="i12_62"/> of the connection object. Socket.IO already natively supports various message types, which you emulated in WebSockets via a property of the message itself. So, in this case, you can directly send a <samp class="listingcharacter listingcharacter">join</samp> type message. The callback function you bind to the button’s <samp class="listingcharacter listingcharacter">click</samp> event remains unchanged except that it uses the <samp class="listingcharacter listingcharacter">emit</samp> method and that the message type was adapted to <samp class="listingcharacter listingcharacter">msg</samp>. In addition, when handling incoming messages, you can now use the different message types of Socket.IO and don’t need to handle the two different types in a callback function. Incoming messages cause a <samp class="listingcharacter listingcharacter">msg</samp> event<a class="indexanchor" id="i12_63"/> to be triggered. You bind a callback function to that event, which is responsible for inserting the transferred data into the display container. The logic for incoming <samp class="listingcharacter listingcharacter">join</samp> type messages also remains almost unchanged. In the callback function of the <samp class="listingcharacter listingcharacter">join</samp> event, you must first empty the container that contains the user names, and then reinsert the new list of users.</p>
            <p class="standard"><span class="crossreference "><a href="12_004.html#l12.21">Listing 12.21</a></span> shows the required server-side modifications to the WebSocket part of the application.</p>
            <div class="listing " id="l12.21"><pre><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">function</span><span class="schwarz"> getName(connections, socket) {</span><br/>  <span class="rot">let</span><span class="schwarz"> name;</span><br/>  <span class="rot">for</span><span class="schwarz"> (</span><span class="rot">const</span><span class="schwarz"> </span><span class="magenta">key</span><span class="schwarz"> </span><span class="rot">in</span><span class="schwarz"> connections) {</span><br/>    <span class="rot">if</span><span class="schwarz"> (socket </span><span class="dunkelblau">===</span><span class="schwarz"> connections[</span><span class="magenta">key</span><span class="schwarz">]) {</span><br/>      name <span class="dunkelblau">=</span><span class="schwarz"> </span><span class="magenta">key</span><span class="schwarz">;</span><br/>    }<br/>  }<br/>  <span class="rot">return</span><span class="schwarz"> name;</span><br/>}<br/> </samp></span><br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">default</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> init(io) {</span><br/>  <span class="rot">const</span><span class="schwarz"> connections </span><span class="dunkelblau">=</span><span class="schwarz"> {};</span><br/> <br/>  <span class="bold"><samp class="listingcharacter listingcharacter">io.sockets.on(<span class="hellblau">'connection'</span><span class="schwarz">, (socket) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>    socket.on(<span class="hellblau">'msg'</span><span class="schwarz">, (message) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>      <span class="rot">const</span><span class="schwarz"> name </span><span class="dunkelblau">=</span><span class="schwarz"> getName(connections, socket);</span><br/> <br/>      <span class="rot">const</span><span class="schwarz"> msg </span><span class="dunkelblau">=</span><span class="schwarz"> {</span><br/>        name,<br/>        msg: message.msg,<br/>      };<br/> <br/>      socket.emit(<span class="hellblau">'msg'</span><span class="schwarz">, msg);</span><br/>      socket.broadcast.emit(<span class="hellblau">'msg'</span><span class="schwarz">, msg);</span><br/>    });<br/> <br/><a id="p382"/>    socket.on(<span class="hellblau">'join'</span><span class="schwarz">, </span><span class="rot">function</span><span class="schwarz"> (message) {</span><br/>      <span class="rot">const</span><span class="schwarz"> name </span><span class="dunkelblau">=</span><span class="schwarz"> getName(connections, socket);</span><br/> <br/>      connections[message.name] <span class="dunkelblau">=</span><span class="schwarz"> socket;</span><br/> <br/>      <span class="rot">const</span><span class="schwarz"> msg </span><span class="dunkelblau">=</span><span class="schwarz"> { names: Object.keys(connections) };</span><br/> <br/>      socket.emit(<span class="hellblau">'join'</span><span class="schwarz">, msg);</span><br/>      socket.broadcast.emit(<span class="hellblau">'join'</span><span class="schwarz">, msg);</span><br/>    });<br/>  });<br/> </samp></span><br/>  <span class="rot">return</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> logout(user) {</span><br/>    <span class="rot">const</span><span class="schwarz"> msg </span><span class="dunkelblau">=</span><span class="schwarz"> JSON.stringify({</span><br/>      type: <span class="hellblau">'join'</span><span class="schwarz">,</span><br/>      names: Object.keys(connections),<br/>    });<br/> <br/>    <span class="bold"><samp class="listingcharacter listingcharacter">connections[user].broadcast.emit(<span class="hellblau">'join'</span><span class="schwarz">, msg);</span><br/>    connections[user].disconnect();<br/> <br/>    <span class="rot">delete</span><span class="schwarz"> connections[user];</span></samp></span><br/>  };<br/>} <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 12.21</b>    
            Adapting the Backend to Socket.IO (app/websocket.js)</p>
            <p class="standard">The <samp class="listingcharacter listingcharacter">getName</samp> helper function is used to find out the name of the user responsible for sending a particular message. In contrast to the <samp class="listingcharacter listingcharacter">websocket</samp> package, the event that is triggered as soon as a client establishes a connection to the server<a class="indexanchor" id="i12_64"/> is now called <samp class="listingcharacter listingcharacter">connection</samp> instead of <samp class="listingcharacter listingcharacter">request</samp>. Within the callback function that you bind to this event, you then handle the two message types, <samp class="listingcharacter listingcharacter">msg</samp> and <samp class="listingcharacter listingcharacter">join</samp>. In the callback function of the <samp class="listingcharacter listingcharacter">msg</samp> event, you format the message accordingly and then send it to all logged-in users using the <samp class="listingcharacter listingcharacter">emit</samp> method. Two different types of this method are used here: the <samp class="listingcharacter listingcharacter">socket.emit</samp> method makes sure that the client to which the current connection exists receives the message, and the <samp class="listingcharacter listingcharacter">socket.broadcast.emit</samp><a class="indexanchor" id="i12_65"/> method forwards the message to all other clients. You proceed similarly with the <samp class="listingcharacter listingcharacter">join</samp> event, the only difference being that here, as with WebSockets, you build a data structure that stores all references to the existing connections. Logging out users works according to the same logic as before with the pure WebSocket implementation. The Socket.IO object also provides a <samp class="listingcharacter listingcharacter">close</samp> method that can be used to terminate a connection. You send the updated user list to all other connections using the <samp class="listingcharacter listingcharacter">broadcast.emit</samp> method of the connection of the user to be logged out. Then you disconnect, delete the reference from the <samp class="listingcharacter listingcharacter">connections</samp> object, clear the user session, and redirect the user to the login page. With these adjustments, <a id="p383"/>you’ve completely changed your application from WebSockets to Socket.IO, so now even older browsers can use your application.</p>
        
    </div><p class="signatur"/>
                    </body>
                </html>