<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
                    
        <head><meta content="application/xhtml+xml; charset=utf-8" http-equiv="Content-Type"/>
            <meta content="application/xhtml+xml; charset=utf-8" name="content-type"/>
            <meta content="Security" name="title"/>
            <meta content="Sebastian Springer" name="author"/>
            <meta content="Rheinwerk Publishing" name="publisher"/>
            <meta content="© 2022 by Rheinwerk Publishing Inc., Boston (MA)" name="copyright"/>
            <meta content="Node.js - The Comprehensive Guide - Security" name="description"/>
            <meta content="en" name="language"/>
            <title>Security</title>
            <link href="common/main.css" rel="stylesheet" type="text/css"/>
<meta content="urn:uuid:e0000000-0000-0000-0000-000029756394" name="Adept.expected.resource"/>
        </head>
    


                    <body class="office_us type_kapitel">
                        <div id="main">
        <h2 class="t2" id="h24.2">24.2    Protecting the Server<a class="indexanchor" id="i24_15"/></h2>
        <p class="standard">Usually, Node.js is used as a platform for web applications. Such an application often faces attacks from outside, especially if it’s publicly accessible on the Internet. Securing a web application<a class="indexanchor" id="i24_16"/> primarily means ensuring continuous availability and protecting users and their data. However, security doesn’t start at the interface to the user, but at very fundamental points in the application.</p>
        
            <h3 class="t3" id="h24.2.1">24.2.1    User Permissions<a class="indexanchor" id="i24_17"/></h3>
            <p class="standard">A service or application always runs under a specific user. If you start your application on the command line, it has the same access permissions to the file system as the user <a id="p687"/>who’s currently logged in<a class="indexanchor" id="i24_18"/>. This means that the application can create, modify, and delete the same files as you do.</p>
            <p class="standard">Basically, this fact isn’t yet a problem as long as you create a separate user for each application. However, the access permissions do become a problem when you use either the account of a normal user or—even worse—the administrator account<a class="indexanchor" id="i24_19"/> of the system. Running an application under a normal user account doesn’t seem to be a problem at first glance. However, if this is the account of a real user with personal files on the system, the application may be able to access these files, which in turn poses a security risk, as it can leak information through an attack. An even bigger problem is the use of the system administrator’s account. In this case, Node.js has access to the entire system. The importance of the user under which you run your application quickly becomes clear when you look at the permissions of certain system directories<a class="indexanchor" id="i24_20"/>.</p>
            <p class="standard">For example, on Unix systems, the <span class="italic">/bin</span> directory contains most of the commands you can run as a normal user. If you delete this directory, the system will be of limited use. The case is even more devastating if you delete the <span class="italic">/etc</span> directory, which contains all configuration files of the system. To prevent the files in these directories from being easily deleted by any user, you only have permission to read and execute, but not to write to most of these files.</p>
            <p class="standard">As long as you don’t have write permission<a class="indexanchor" id="i24_21"/> at the directory level, you can’t delete any files within this directory. However, if you do have permission to write to individual files, you can overwrite them, which is equivalent to deleting them. <span class="crossreference "><a href="24_002.html#l24.3">Listing 24.3</a></span> demonstrates this.</p>
            <div class="box box_standard">
                <h6 class="boxheading">Warning!</h6>
                <p class="standard first last">You should only run the commands from this example on a test system and never on a critical system.</p>
            </div>
            <div class="listing " id="l24.3"><pre><span class="bold"><samp class="listingcharacter listingcharacter">testuser@server$ rm -rf /bin</samp></span><br/>rm: /bin/: Permission denied<br/>rm: /bin/: Permission denied<br/>... </pre></div>
            <p class="caption "><b>Listing 24.3</b>    
            Program-Independent Permission Check</p>
            <p class="standard">Strictly speaking, this means that you should never run for your application with administrator privileges. It has become standard practice to create a separate user<a class="indexanchor" id="i24_22"/> for each application and run the application under this user account with its permissions. If you need access to certain resources, you can cover this by having the user join certain groups without having to give them extensive access to the system. In general, you should always provide a user with as few rights as possible and always grant access only <a id="p688"/>when necessary. This means you have a little more work, but it also ensures a higher degree of security for the overall system.</p>
            <p class="standard">Another problem can be caused by the architecture of Node.js. The single-threaded approach of the platform provides attackers with a starting point to manipulate your application.</p>
        
        
            <h3 class="t3" id="h24.2.2">24.2.2    Problems Caused by the Single-Threaded Approach<a class="indexanchor" id="i24_23"/></h3>
            <p class="standard">The principle of the Node.js platform is that all input/output (I/O) operations<a class="indexanchor" id="i24_24"/> are executed asynchronously. However, by default, your application code runs in only one process with one thread. If you process requests from clients directly in your application process, this means that CPU-intensive<a class="indexanchor" id="i24_25"/> requests have the potential to block the execution of your application. <span class="crossreference "><a href="24_002.html#l24.4">Listing 24.4</a></span> clarifies this problem.</p>
            <div class="listing " id="l24.4"><pre><span class="rot">import</span><span class="schwarz"> { createServer } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'http'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> { parse } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'url'</span><span class="schwarz">;</span><br/> <br/>createServer((req, res) <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>  <span class="rot">const</span><span class="schwarz"> number </span><span class="dunkelblau">=</span><span class="schwarz"> parse(req.url, </span><span class="rot">true</span><span class="schwarz">).query.number;</span><br/>  <span class="rot">let</span><span class="schwarz"> result </span><span class="dunkelblau">=</span><span class="schwarz"> 1;</span><br/>  <span class="rot">const</span><span class="schwarz"> start </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">Date().getTime();</span><br/> <br/>  <span class="rot">if</span><span class="schwarz"> (number </span><span class="dunkelblau">!==</span><span class="schwarz"> undefined) {</span><br/>    <span class="rot">for</span><span class="schwarz"> (</span><span class="rot">let</span><span class="schwarz"> i </span><span class="dunkelblau">=</span><span class="schwarz"> 1; i </span><span class="dunkelblau">&lt;=</span><span class="schwarz"> number; i</span><span class="dunkelblau">++</span><span class="schwarz">) {</span><br/>      result <span class="dunkelblau">+=</span><span class="schwarz"> i </span><span class="dunkelblau">*</span><span class="schwarz"> i;</span><br/>    }<br/>  }<br/> <br/>  <span class="rot">const</span><span class="schwarz"> end </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">Date().getTime();</span><br/> <br/>  res.end(<span class="violett">`Time: ${end - start} Result: ${result}`</span><span class="schwarz">);</span><br/>}).listen(8080); <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 24.4</b>    
            Blocking Request</p>
            <p class="standard">In the example in <span class="crossreference "><a href="24_002.html#l24.4">Listing 24.4</a></span>, you can see a simple implementation of a web server. The code does nothing more than accept requests from clients and, if a <samp class="listingcharacter listingcharacter">number</samp> parameter is passed, perform a calculation. If you now start a query from a browser using the URL <span class="italic">http://localhost:8080/?number=100</span>, you should receive an output like the one shown in <span class="crossreference "><a href="24_002.html#l24.5">Listing 24.5</a></span>.</p>
            <div class="listing " id="l24.5"><pre>Time<span class="schwarz">: 0 Result: 338351 </span><span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 24.5</b>    
            Output for a Request with 100 Iterations</p>
            <p class="standard"><a id="p689"/>In this case, you’ll receive the response very quickly. This type of request isn’t a major problem for the web server. However, if you adjust the URL to the value <span class="italic">http://localhost:8080/?number=1000000000</span> in the subsequent step, you have to wait significantly longer. After a few seconds you’ll get an output in your browser that should look similar to the one shown in <span class="crossreference "><a href="24_002.html#l24.6">Listing 24.6</a></span>.</p>
            <div class="listing " id="l24.6"><pre>Time: 4571 Result: 3.333333383334632e+23 </pre></div>
            <p class="caption "><b>Listing 24.6</b>    
            Output for a Request with 100,000,000 Iterations</p>
            <p class="standard">Because the application has no restriction in this case, you can increase the parameter as you wish. If it isn’t just a single request, but several clients request the server at the same time, such requests block the entire application.</p>
            <p class="standard">Two partial solutions exist for this problem. The first approach is to restrict all arguments that are the basis for extensive calculations on the server side by a certain range of values<a class="indexanchor" id="i24_26"/>, which is equivalent to an input filter. The second part of the solution is to swap out such calculations to a separate process so that the main thread doesn’t get blocked by calculations. A corresponding implementation of this solution is shown in <span class="crossreference "><a href="24_002.html#l24.7">Listing 24.7</a></span>.</p>
            <div class="listing " id="l24.7"><pre><span class="rot">import</span><span class="schwarz"> { createServer } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'http'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> { fork } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'child_process'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> { parse } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'url'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> { fileURLToPath } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'url'</span><span class="schwarz">;</span><br/> <br/><span class="rot">if</span><span class="schwarz"> (process.argv[2] </span><span class="dunkelblau">===</span><span class="schwarz"> </span><span class="hellblau">'child'</span><span class="schwarz">) {</span><br/>  <span class="rot">const</span><span class="schwarz"> number </span><span class="dunkelblau">=</span><span class="schwarz"> process.argv[3];</span><br/>  <span class="rot">let</span><span class="schwarz"> result </span><span class="dunkelblau">=</span><span class="schwarz"> 1;</span><br/>  <span class="rot">const</span><span class="schwarz"> start </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">Date().getTime();</span><br/> <br/>  <span class="rot">if</span><span class="schwarz"> (number </span><span class="dunkelblau">!==</span><span class="schwarz"> undefined) {</span><br/>    <span class="rot">for</span><span class="schwarz"> (</span><span class="rot">let</span><span class="schwarz"> i </span><span class="dunkelblau">=</span><span class="schwarz"> 1; i </span><span class="dunkelblau">&lt;=</span><span class="schwarz"> number; i</span><span class="dunkelblau">++</span><span class="schwarz">) {</span><br/>      result <span class="dunkelblau">+=</span><span class="schwarz"> i </span><span class="dunkelblau">*</span><span class="schwarz"> i;</span><br/>    }<br/>  }<br/> <br/>  <span class="rot">const</span><span class="schwarz"> end </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">Date().getTime();</span><br/> <br/>  process.send({ time: end <span class="dunkelblau">-</span><span class="schwarz"> start, result: result });</span><br/>} <span class="rot">else</span><span class="schwarz"> {</span><br/>  createServer((req, res) <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>    <span class="rot">const</span><span class="schwarz"> number </span><span class="dunkelblau">=</span><span class="schwarz"> parse(req.url, </span><span class="rot">true</span><span class="schwarz">).query.number;</span><br/> <br/>    <span class="rot">if</span><span class="schwarz"> (number </span><span class="dunkelblau">&lt;</span><span class="schwarz"> 0 </span><span class="dunkelblau">||</span><span class="schwarz"> number </span><span class="dunkelblau">&gt;</span><span class="schwarz"> 1000) {</span><br/><a id="p690"/>      res.end(<span class="hellblau">'Please provide a number between 0 and 1000'</span><span class="schwarz">);</span><br/>    }<br/> <br/>    <span class="rot">const</span><span class="schwarz"> child </span><span class="dunkelblau">=</span><span class="schwarz"> fork(fileURLToPath(</span><span class="rot">import</span><span class="schwarz">.meta.url), [</span><span class="hellblau">'child'</span><span class="schwarz">, number]);</span><br/> <br/>    child.on(<span class="hellblau">'message'</span><span class="schwarz">, (data) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>      res.end(<span class="violett">`Time: ${data.time} Result: ${data.result}`</span><span class="schwarz">);</span><br/>    });<br/>  }).listen(8080);<br/>} <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 24.7</b>    
            Dealing with Problematic Requests</p>
            <p class="standard">Despite all the advantages of swapping out to child processes<a class="indexanchor" id="i24_27"/>, you should still keep in mind that this technique also has its drawbacks. The child processes also require system resources, so the maximum number of child processes is limited by the available resources. In addition, you should always think about this risk when implementing your application. In this case, an attacker could simply make a very large number of simultaneous requests to your system, creating a huge number of child processes, which in turn pushes your system to its limits. When in doubt, it’s always an option to reject requests that exceed your system’s capacity before your entire system stops working.</p>
            <div class="box box_standard">
                <h6 class="boxheading">Warning!</h6>
                <p class="standard first last">You should limit the number of possible child processes<a class="indexanchor" id="i24_28"/> to no more than the number of cores on your system. All requests that exceed this number have to wait and, in case of doubt, are aborted by the requesting system with a time-out error after a certain period of time.</p>
            </div>
            <p class="standard">As you can see in the implementation in <span class="crossreference "><a href="24_002.html#l24.7">Listing 24.7</a></span>, securing against certain types of attacks always requires a bit more work than implementing an unsecured application. However, you should always keep in mind that saving this extra effort may backfire at a later point in the lifecycle of your software—at the latest when your application is made inoperable by such an attack.</p>
        
        
            <h3 class="t3" id="h24.2.3">24.2.3    Denial-of-Service<a class="indexanchor" id="i24_29"/> Attacks</h3>
            <p class="standard">Denial-of-service (DOS) attacks are very closely related to the issues caused by the single-threaded approach of Node.js. They are another method by which external attackers can attack your application to the point of inaccessibility to your users. In this type of attack, the services of your application are overused so that so many resources<a class="indexanchor" id="i24_30"/> are being utilized that the service can no longer be provided reliably.</p>
            <p class="standard"><a id="p691"/>However, you can take quite a few countermeasures against such attacks within an application. If the requests originate from one source, that is, from an IP address<a class="indexanchor" id="i24_31"/>, you can reject the requests from this source directly.</p>
            <p class="standard">The source code in <span class="crossreference "><a href="24_002.html#l24.8">Listing 24.8</a></span> ensures that only 10 requests per 10 seconds can come from each IP address. Any request that exceeds this limit is automatically rejected with status code <samp class="listingcharacter listingcharacter">400</samp>. After 10 seconds, the values are reset. Because the configuration options are kept in separate variables, it’s easy to change these directives. However, if you include such a mechanism in your application, always keep in mind that the rejection of unwanted requests must happen as early as possible in your application to keep the wasted resources as low as possible.</p>
            <div class="listing " id="l24.8"><pre><span class="rot">import</span><span class="schwarz"> { createServer } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'http'</span><span class="schwarz">;</span><br/> <br/><span class="rot">const</span><span class="schwarz"> sources </span><span class="dunkelblau">=</span><span class="schwarz"> {};</span><br/><span class="rot">const</span><span class="schwarz"> timeThreshold </span><span class="dunkelblau">=</span><span class="schwarz"> 10000;</span><br/><span class="rot">const</span><span class="schwarz"> countLimit </span><span class="dunkelblau">=</span><span class="schwarz"> 10;</span><br/> <br/>createServer((req, res) <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>  <span class="rot">const</span><span class="schwarz"> client </span><span class="dunkelblau">=</span><span class="schwarz"> req.connection.remoteAddress;</span><br/>  <span class="rot">const</span><span class="schwarz"> now </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">Date().getTime();</span><br/> <br/>  <span class="rot">if</span><span class="schwarz"> (sources[client]) {</span><br/>    <span class="rot">if</span><span class="schwarz"> (</span><br/>      now <span class="dunkelblau">-</span><span class="schwarz"> sources[client].time </span><span class="dunkelblau">&lt;</span><span class="schwarz"> timeThreshold </span><span class="dunkelblau">&amp;&amp;</span><span class="schwarz"><br/></span>      sources[client].count <span class="dunkelblau">&gt;</span><span class="schwarz"> countLimit</span><br/>    ) {<br/>      res.statusCode <span class="dunkelblau">=</span><span class="schwarz"> 400;</span><br/>      res.end(<span class="hellblau">'Bad Request'</span><span class="schwarz">);</span><br/>      <span class="rot">return</span><span class="schwarz"> </span><span class="rot">false</span><span class="schwarz">;</span><br/>    } <span class="rot">else</span><span class="schwarz"> </span><span class="rot">if</span><span class="schwarz"> (now </span><span class="dunkelblau">-</span><span class="schwarz"> sources[client].time </span><span class="dunkelblau">&gt;</span><span class="schwarz"> timeThreshold) {</span><br/>      sources[client] <span class="dunkelblau">=</span><span class="schwarz"> { time: now, count: 1 };</span><br/>    } <span class="rot">else</span><span class="schwarz"> {</span><br/>      sources[client].count <span class="dunkelblau">+=</span><span class="schwarz"> 1;</span><br/>    }<br/>  } <span class="rot">else</span><span class="schwarz"> {</span><br/>    sources[client] <span class="dunkelblau">=</span><span class="schwarz"> { time: now, count: 1 };</span><br/>  }<br/> <br/>  res.end(<span class="hellblau">'Hello Client'</span><span class="schwarz">);</span><br/>}).listen(8080); <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 24.8</b>    
            Rejecting Specific Requests</p>
            <p class="standard"><a id="p692"/>A better solution against such attacks is to implement a firewall in front of your Node.js server. In most cases, this already provides mechanisms that can handle such attacks and automatically rejects requests that are candidates for DOS attacks.</p>
        
        
            <h3 class="t3" id="h24.2.4">24.2.4    Regular Expressions<a class="indexanchor" id="i24_32"/></h3>
            <p class="standard">An often-underestimated topic with regard to security is regular expressions. In this context, there is a separate type of DOS attack—the <span class="italic">regular expression denial-of-service</span> (ReDoS) attacks<a class="indexanchor" id="i24_33"/>. The problem with this type of attack is that attackers take advantage of the fact that evaluating certain regular expressions can take a long time. Especially when it comes to grouping and repetition, expressions quickly become slow. <span class="crossreference "><a href="24_002.html#l24.9">Listing 24.9</a></span> shows how you can cause a performance problem with just a simple regular expression and an ordinary looking string.</p>
            <div class="listing " id="l24.9"><pre><span class="rot">const</span><span class="schwarz"> pattern </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="dunkelblau">/</span><span class="schwarz">([a</span><span class="dunkelblau">-</span><span class="schwarz">z]</span><span class="dunkelblau">+</span><span class="schwarz">)</span><span class="dunkelblau">+</span><span class="schwarz">$</span><span class="dunkelblau">/</span><span class="schwarz">;</span><br/> <br/><span class="magenta">console</span><span class="schwarz">.time(</span><span class="hellblau">'ReDoS'</span><span class="schwarz">);</span><br/><span class="rot">const</span><span class="schwarz"> attack </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="hellblau">'aaaaaaaaaaaaaaaaaaaaaaaaaaaa!'</span><span class="schwarz">;</span><br/>pattern.test(attack);<br/><span class="magenta">console</span><span class="schwarz">.timeEnd(</span><span class="hellblau">'ReDoS'</span><span class="schwarz">);  </span><span class="gruen"> // Output: ReDoS 21.151s</span><span class="schwarz"><br/></span> <br/><span class="magenta">console</span><span class="schwarz">.time(</span><span class="hellblau">'NoReDoS'</span><span class="schwarz">);</span><br/><span class="rot">const</span><span class="schwarz"> normalValue </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="hellblau">'asdf'</span><span class="schwarz">;</span><br/>pattern.test(normalValue);<br/><span class="magenta">console</span><span class="schwarz">.timeEnd(</span><span class="hellblau">'NoReDoS'</span><span class="schwarz">);</span><span class="gruen"> // Output: NoReDoS: 0.144ms</span><span class="schwarz"> </span><span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 24.9</b>    
            Attacks on Regular Expression</p>
            <p class="standard">If you run the source code, you’ll see that the first check takes about 21 seconds, while the second one takes well under a second.</p>
            <p class="standard">As the length of the character string increases, the regular expression takes longer to evaluate. The reason for this can be found in patterns such as <samp class="listingcharacter listingcharacter">([a-z]+)+</samp>. The parentheses and the multipliers make the regular expression extremely non-performant. If an attacker notices this, they can use long inputs to block your application until it becomes unusable, so make sure to avoid such patterns when formulating regular expressions.</p>
            <p class="standard">However, within a Node.js application, it’s not only the source code of the server itself that is vulnerable to attacks. Frequently, the communication between client and server is also the target of attacks. The following sections will show you how to work with HTTP headers to increase the security of your application, as well as discover the potential damage that can result from error messages.</p>
        
        
            <h3 class="t3" id="h24.2.5">24.2.5    <a id="p693"/>HTTP Header<a class="indexanchor" id="i24_34"/></h3>
            <p class="standard">Web application<a class="indexanchor" id="i24_35"/> security isn’t just in your hands as an application developer. Manufacturers of web browsers have also integrated some mechanisms to protect users from attacks. You must enable some of these security mechanisms via the header information of the responses you send to the user. The most important of these header fields<a class="indexanchor" id="i24_36"/> are listed in <span class="crossreference "><a href="24_002.html#t24.1">Table 24.1</a></span>.</p>
            <table class="standardtable" id="t24.1">
                <thead>
                    <tr>
                        <th class="tablehead tablecell_first top_border_cell">
                            <p class="standard first-item last-item">Header</p>
                        </th>
                        <th class="tablehead tablecell_last top_border_cell">
                            <p class="standard first-item last-item">Description</p>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="tablecell tablecell_first top_border_cell">
                            <p class="standard first-item last-item"><samp class="listingcharacter listingcharacter">Strict-Transport-Security</samp></p>
                        </td>
                        <td class="tablecell tablecell_last top_border_cell">
                            <p class="standard first-item last-item">Forces a secure connection to the server. Connections via HTTP to the server are no longer allowed.</p>
                        </td>
                    </tr>
                    <tr class="light">
                        <td class="tablecell tablecell_first">
                            <p class="standard first-item last-item"><samp class="listingcharacter listingcharacter">X-Frame-Options</samp></p>
                        </td>
                        <td class="tablecell tablecell_last">
                            <p class="standard first-item last-item">This header specifies who can load your application into a frame. It can be used to prevent clickjacking, for example.</p>
                        </td>
                    </tr>
                    <tr>
                        <td class="tablecell tablecell_first">
                            <p class="standard first-item last-item"><samp class="listingcharacter listingcharacter">X-XSS-Protection</samp></p>
                        </td>
                        <td class="tablecell tablecell_last">
                            <p class="standard first-item last-item">With this header, the browser itself prevents some cross-site scripting attacks. (Cross-site scripting is covered in more detail later in this chapter.)</p>
                        </td>
                    </tr>
                    <tr class="light">
                        <td class="tablecell tablecell_first">
                            <p class="standard first-item last-item"><samp class="listingcharacter listingcharacter">X-Content-Type-Options</samp></p>
                        </td>
                        <td class="tablecell tablecell_last">
                            <p class="standard first-item last-item">Browsers try to find out the file type based on the file signature in addition to the content type. External parties can use this behavior to perform attacks. This header can be used to disable multipurpose internet mail extension (MIME) sniffing.</p>
                        </td>
                    </tr>
                    <tr>
                        <td class="tablecell tablecell_first">
                            <p class="standard first-item last-item"><samp class="listingcharacter listingcharacter">Content-Security-Policy</samp></p>
                        </td>
                        <td class="tablecell tablecell_last">
                            <p class="standard first-item last-item">In the content security policy, inline JavaScript can be prohibited, and it can be specified from where resources may be reloaded.</p>
                        </td>
                    </tr>
                    <tr class="light">
                        <td class="tablecell tablecell_first">
                            <p class="standard first-item last-item"><samp class="listingcharacter listingcharacter">Cache-Control</samp></p>
                        </td>
                        <td class="tablecell tablecell_last">
                            <p class="standard first-item last-item">You can disable the browser cache to ensure that the user always gets the latest version of your application, including all security and bug fixes. If you disable browser caching, this can affect the performance.</p>
                        </td>
                    </tr>
                </tbody>
            </table>
            <p class="caption "><b>Table 24.1</b>    
            Security-Relevant HTTP Headers</p>
            <p class="standard">The headers presented here are only a part of the security-related settings you can make. For a more extensive list and additional explanations, visit the Open Web Application Security Project (OWASP) Secure Headers Project at <span class="url"><a href="https://owasp.org/www-project-secure-headers/">https://owasp.org/www-project-secure-headers/</a></span>.<a class="indexanchor" id="i24_37"/> You can easily set the corresponding header information in your application. If you use a web server that you implement with the <samp class="listingcharacter listingcharacter">http</samp> module of Node.js, <span class="crossreference "><a href="24_002.html#l24.10">Listing 24.10</a></span> can serve as a guide.</p>
            <div class="listing " id="l24.10"><pre><span class="rot">import</span><span class="schwarz"> { createServer } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'http'</span><span class="schwarz">;</span><br/> <br/>createServer((req, res) <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>  <span class="rot">const</span><span class="schwarz"> headers </span><span class="dunkelblau">=</span><span class="schwarz"> {</span><br/>    <span class="bold"><samp class="listingcharacter listingcharacter"><span class="hellblau">'Strict-Transport-Security'</span><span class="schwarz">: </span><span class="hellblau">'max-age=31536000; includeSubDomains'</span><span class="schwarz">,</span><br/><a id="p694"/>    <span class="hellblau">'X-Frame-Options'</span><span class="schwarz">: </span><span class="hellblau">'SAMEORIGIN'</span><span class="schwarz">,</span><br/>    <span class="hellblau">'X-XSS-Protection'</span><span class="schwarz">: </span><span class="hellblau">'1'</span><span class="schwarz">,</span><br/>    <span class="hellblau">'X-Content-Type-Options'</span><span class="schwarz">: </span><span class="hellblau">'nosniff'</span><span class="schwarz">,</span><br/>    <span class="hellblau">'Content-Security-Policy'</span><span class="schwarz">: '</span><span class="rot">default</span><span class="dunkelblau">-</span><span class="schwarz">src </span><span class="hellblau">"self"',</span><br/>    '<span class="schwarz">Cache</span><span class="dunkelblau">-</span><span class="schwarz">Control</span><span class="hellblau">': '</span><span class="schwarz">no</span><span class="dunkelblau">-</span><span class="schwarz">store, no</span><span class="dunkelblau">-</span><span class="schwarz">cache, must</span><span class="dunkelblau">-</span><span class="schwarz">revalidate, proxy</span><span class="dunkelblau">-</span><span class="schwarz">revalidate</span><span class="hellblau">',</span><br/>    Pragma: '<span class="schwarz">no</span><span class="dunkelblau">-</span><span class="schwarz">cache</span><span class="hellblau">',</span><br/>    Expires: '<span class="schwarz">0</span><span class="hellblau">',</span><br/>    '<span class="schwarz">Surrogate</span><span class="dunkelblau">-</span><span class="schwarz">Control</span><span class="hellblau">': '</span><span class="schwarz">no</span><span class="dunkelblau">-</span><span class="schwarz">store</span><span class="hellblau">',</span></samp></span><br/>  };<br/>  res.writeHead(200, headers);<br/>  res.end('<span class="schwarz">Hello Client');</span><br/>}).listen(8080); <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 24.10</b>    
            Setting Security Headers</p>
            <p class="standard">As you can see, setting the relevant header fields turns out to be quite cumbersome. You can solve this task elegantly through an additional package called Helmet<a class="indexanchor" id="i24_38"/> when using Express. The package acts as middleware and by default enables the headers described previously and some others. After installing Helmet using the <samp class="listingcharacter listingcharacter">npm install helmet</samp> command, you can include it in your application as shown in <span class="crossreference "><a href="24_002.html#l24.11">Listing 24.11</a></span>.</p>
            <div class="listing " id="l24.11"><pre><span class="rot">import</span><span class="schwarz"> express </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'express'</span><span class="schwarz">;</span><br/><span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">import</span><span class="schwarz"> helmet </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'helmet'</span><span class="schwarz">;</span><br/> </samp></span><br/><span class="rot">const</span><span class="schwarz"> app </span><span class="dunkelblau">=</span><span class="schwarz"> express();</span><br/> <br/><span class="bold"><samp class="listingcharacter listingcharacter">app.use(helmet());<br/> </samp></span><br/>app.get(<span class="hellblau">'/'</span><span class="schwarz">, (req, res) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>  res.send(<span class="hellblau">'Hello World'</span><span class="schwarz">);</span><br/>});<br/> <br/>app.listen(8080); <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 24.11</b>    
            Integrating Helmet into an Express Application</p>
            <p class="standard">By default, all Helmet headers are enabled. You can find out exactly what these are in the project documentation at <span class="url"><a href="https://github.com/helmetjs/helmet">https://github.com/helmetjs/helmet</a></span>. Alternatively, you can use only individual parts of Helmet. For example, if you only want to disable caching<a class="indexanchor" id="i24_39"/>, you can do so by calling <samp class="listingcharacter listingcharacter">helmet.noCache()</samp> instead of <samp class="listingcharacter listingcharacter">helmet()</samp> that’s used in <span class="crossreference "><a href="24_002.html#l24.11">Listing 24.11</a></span>. However, setting security-related header fields is only part of the actions you need to perform to secure your application. You should also think about the information you give out to your users.</p>
        
        
            <h3 class="t3" id="h24.2.6">24.2.6    <a id="p695"/>Error Messages<a class="indexanchor" id="i24_40"/></h3>
            <p class="standard">A good example of information getting to the user is <samp class="listingcharacter listingcharacter">X-Powered-By</samp> header, which in Express is set to the value <samp class="listingcharacter listingcharacter">Express</samp>, for example. With this information, an attacker can rule out specific attack vectors and focus on known security gaps of Express. You can use Helmet’s <samp class="listingcharacter listingcharacter">hidePoweredBy</samp><a class="indexanchor" id="i24_41"/> method to disable this header.</p>
            <p class="standard">Other examples that can give an attacker a lot of information about your application’s architecture are error messages. For example, you should never give out file names or paths that are on the server to the client. In this context, it’s always recommended to use hash values<a class="indexanchor" id="i24_42"/> that can be resolved via mapping tables<a class="indexanchor" id="i24_43"/> on the server. Absolute path specifications in particular reveal a lot about the structure of your server system and make it easy for an attacker to access system paths through various path modifications. In addition, the indication that a certain file wasn’t found on the server isn’t ideal because this again furthers conclusions about the existence of files, so it can be found out by trial and error where specific files are located, which can be accessed afterwards.</p>
            <p class="standard">In general, you should make sure that you disclose as little information as possible about your system and its structure to the outside world. This applies to directory paths and file names<a class="indexanchor" id="i24_44"/>, the software<a class="indexanchor" id="i24_45"/> used, and version numbers<a class="indexanchor" id="i24_46"/>. In addition, the structure of database queries shouldn’t be sent to the user in error messages. When communicating errors, be as general as possible and preferably limit yourself to the standard HTTP status codes. For debugging purposes, you can write specific error messages to log files or send them to central log servers for evaluation as needed.</p>
        
        
            <h3 class="t3" id="h24.2.7">24.2.7    SQL Injections<a class="indexanchor" id="i24_47"/></h3>
            <p class="standard">Database queries lead us to another area of attack on web applications. Most of the time, your application’s database<a class="indexanchor" id="i24_48"/> is where the data of your users is stored. In this function, the database represents the core of your application, as this is where all the information comes together. This makes databases particularly important for attackers, as there is often a lot to be gained in that area. The data of specific interest ranges from user names and passwords to email and postal addresses to account and credit card information. If this sensitive data falls into the hands of third parties through an attack, your users’ trust in your application is permanently destroyed.</p>
            <p class="standard">This section covers attacks on SQL databases and what you can do about them. Similar attack vectors exist for all common NoSQL databases<a class="indexanchor" id="i24_49"/>. A good place to start looking at attacks on NoSQL databases is <span class="url"><a href="https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/07-Input_Validation_Testing/05.6-Testing_for_NoSQL_Injection">https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/07-Input_Validation_Testing/05.6-Testing_for_NoSQL_Injection</a></span><a class="indexanchor" id="i24_50"/>.</p>
            <p class="standard">With the SQL injections, external attackers target the database backend of your application. This type of attack exploits the ability of SQL databases to issue commands. To facilitate the implementation of the following example, you should launch a Docker <a id="p696"/>container with MySQL. You can do this by executing the command from <span class="crossreference "><a href="24_002.html#l24.12">Listing 24.12</a></span> on the command line.</p>
            <div class="listing " id="l24.12"><pre>docker run <br/>  --name mysql <br/>  -e MYSQL_ROOT_PASSWORD=topSecret <br/>  -e MYSQL_ROOT_HOST=% <br/>  -e MYSQL_DATABASE=test <br/>  -p 3306:3306 <br/>  -d <br/>  mysql:latest </pre></div>
            <p class="caption "><b>Listing 24.12</b>    
            Launching a MySQL Container</p>
            <p class="standard">In addition, you must first make sure that the MySQL driver for Node.js is installed. You can do this using the <samp class="listingcharacter listingcharacter">npm install mysql2</samp> command. Then you can run the source code from <span class="crossreference "><a href="24_002.html#l24.13">Listing 24.13</a></span>, which first sets up a database connection, prepares the database, and then starts a web server.</p>
            <div class="listing " id="l24.13"><pre><span class="rot">import</span><span class="schwarz"> { createServer } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'http'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> { parse } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'url'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> { promisify } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'util'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> mysql </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'mysql2/promise'</span><span class="schwarz">;</span><br/> <br/><span class="rot">const</span><span class="schwarz"> connection </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> mysql.createConnection({</span><br/>  host: <span class="hellblau">'127.0.0.1'</span><span class="schwarz">,</span><br/>  user: <span class="hellblau">'root'</span><span class="schwarz">,</span><br/>  password: <span class="hellblau">'topSecret'</span><span class="schwarz">,</span><br/>  database: <span class="hellblau">'test'</span><span class="schwarz">,</span><br/>  multipleStatements: <span class="rot">true</span><span class="schwarz">,</span><br/>});<br/> <br/>connection.connect();<br/> <br/><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> prepareDatabase() {</span><br/>  <span class="rot">await</span><span class="schwarz"> connection.query(</span><span class="hellblau">'DROP TABLE IF EXISTS users'</span><span class="schwarz">);</span><br/>  <span class="rot">await</span><span class="schwarz"> connection.query(</span><br/>    <span class="hellblau">'CREATE TABLE users (id INTEGER PRIMARY KEY AUTO_INCREMENT, </span><img alt="inline image" class="inline_image" src="bilder/umbruchpfeil.png"/><br/>      username VARCHAR(255))'<span class="schwarz">,</span><br/>  );<br/>  <span class="rot">await</span><span class="schwarz"> connection.query(</span><br/>    'INSERT INTO users (username) VALUES (<span class="hellblau">"Rachel"</span><span class="schwarz">), (</span><span class="hellblau">"John"</span><span class="schwarz">),  </span><img alt="inline image" class="inline_image" src="bilder/umbruchpfeil.png"/><br/>      (<span class="hellblau">"Maria"</span><span class="schwarz">), (</span><span class="hellblau">"Tim"</span><span class="schwarz">)',</span><br/>  );<br/>}<br/> <br/><span class="rot"><a id="p697"/>await</span><span class="schwarz"> prepareDatabase();</span><br/> <br/>createServer(<span class="rot">async</span><span class="schwarz"> (req, res) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>  <span class="rot">const</span><span class="schwarz"> id </span><span class="dunkelblau">=</span><span class="schwarz"> parse(req.url, </span><span class="rot">true</span><span class="schwarz">).query.id;</span><br/> <br/>  <span class="rot">if</span><span class="schwarz"> (id </span><span class="dunkelblau">!=</span><span class="schwarz"> undefined) {</span><br/>    <span class="rot">const</span><span class="schwarz"> sql </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="violett">`SELECT * FROM users WHERE id = ${id}`</span><span class="schwarz">;</span><br/> <br/>    <span class="rot">const</span><span class="schwarz"> result </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> connection.query(sql);</span><br/>    <span class="rot">const</span><span class="schwarz"> data </span><span class="dunkelblau">=</span><span class="schwarz"> result[0][0];</span><br/> <br/>    res.end(<span class="violett">`ID: ${data.id} name: ${data.username}`</span><span class="schwarz">);</span><br/>  }<br/>}).listen(8080); <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 24.13</b>    
            Web Server Vulnerable to SQL Injections</p>
            <p class="standard">The server process in <span class="crossreference "><a href="24_002.html#l24.13">Listing 24.13</a></span> is intended to allow you to get the ID and user name for a particular ID. For this purpose, you query the server with the ID as a query parameter. For example, for the data record with ID 3, the query would be <span class="italic">http://localhost:8080/?id=3</span>. However, due to the way it’s implemented, the server is vulnerable to SQL injections. You can test this by calling the URL <span class="italic">http://localhost:8080/?id=1;truncate users;</span> in the browser. This has the effect of emptying the entire <samp class="listingcharacter listingcharacter">users</samp> table. The execution of this type of command is typical of SQL injections. In addition to deleting data records from a database, you can also read<a class="indexanchor" id="i24_51"/> and modify<a class="indexanchor" id="i24_52"/> information with appropriately prepared queries. When reading data, an attacker could, for example, spy on your users’ account information. If an attacker is able to gain modifying access to your database, they can gain access to the application or break into another user’s account by changing the password. If your users can make purchases through your application, an attacker could place orders through an SQL injection and cause significant financial damage. Depending on how porous your security measures are, it’s quite possible that the attack could make it through to your enterprise resource planning system.</p>
            <p class="standard">The <samp class="listingcharacter listingcharacter">mysql2</samp> package for Node.js has some security mechanisms that can be used to prevent SQL injections. As a first step, you leave the <samp class="listingcharacter listingcharacter">multipleStatements</samp> value at its default value of <samp class="listingcharacter listingcharacter">false</samp> in the connection configuration<a class="indexanchor" id="i24_53"/>. This prevents multiple commands from being issued within one query.</p>
            <p class="standard">Another countermeasure is to escape<a class="indexanchor" id="i24_54"/> the input values for queries. However, you don’t have to bother about escaping correctly yourself. The <samp class="listingcharacter listingcharacter">escape</samp> method of the <samp class="listingcharacter listingcharacter">connection</samp> object does this job for you. Alternatively, you can use wildcard notation, where you use a <samp class="listingcharacter listingcharacter">?</samp> as a placeholder instead of the actual values. You then pass the values as the second argument to the <samp class="listingcharacter listingcharacter">query</samp> method, and the database driver then takes care of escaping them correctly itself. You can see both variants in <span class="crossreference "><a href="24_002.html#l24.14">Listing 24.14</a></span>, where the <samp class="listingcharacter listingcharacter">escape</samp> method is currently active, and the placeholder variant is commented out, so you can <a id="p698"/>easily switch back and forth between the two and try them both.</p>
            <div class="listing " id="l24.14"><pre><span class="rot">import</span><span class="schwarz"> { createServer } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'http'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> { parse } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'url'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> { promisify } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'util'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> mysql </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'mysql2/promise'</span><span class="schwarz">;</span><br/> <br/><span class="rot">const</span><span class="schwarz"> connection </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> mysql.createConnection({</span><br/>  host: <span class="hellblau">'127.0.0.1'</span><span class="schwarz">,</span><br/>  user: <span class="hellblau">'root'</span><span class="schwarz">,</span><br/>  password: <span class="hellblau">'topSecret'</span><span class="schwarz">,</span><br/>  database: <span class="hellblau">'test'</span><span class="schwarz">,</span><br/>  <span class="bold"><samp class="listingcharacter listingcharacter">multipleStatements: <span class="rot">false</span><span class="schwarz">,</span></samp></span><br/>});<br/> <br/>connection.connect();<br/> <br/><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> prepareDatabase() {...}</span><br/> <br/><span class="rot">await</span><span class="schwarz"> prepareDatabase();</span><br/> <br/>createServer(<span class="rot">async</span><span class="schwarz"> (req, res) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>  <span class="rot">const</span><span class="schwarz"> id </span><span class="dunkelblau">=</span><span class="schwarz"> parse(req.url, </span><span class="rot">true</span><span class="schwarz">).query.id;</span><br/> <br/>  <span class="rot">if</span><span class="schwarz"> (id </span><span class="dunkelblau">!=</span><span class="schwarz"> undefined) {</span><br/>    <span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">const</span><span class="schwarz"> sql </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="hellblau">'SELECT * FROM users WHERE id = ${connection.escape(id)} '</span><span class="schwarz">;</span><br/>    <span class="rot">const</span><span class="schwarz"> result </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> connection.query(sql);</span><br/> <br/>   <span class="gruen"> // const sql = 'SELECT * FROM users WHERE id = ?';</span><span class="schwarz"><br/></span>   <span class="gruen"> // const result = await connection.query(sql, [id]);</span><span class="schwarz"><br/></span> </samp></span><br/>    <span class="rot">const</span><span class="schwarz"> data </span><span class="dunkelblau">=</span><span class="schwarz"> result[0][0];</span><br/> <br/>    res.end(<span class="violett">`ID: ${data.id} name: ${data.username}`</span><span class="schwarz">);</span><br/>  }<br/>}).listen(8080); <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 24.14</b>    
            Safe Queries Due to Escaping</p>
            <p class="standard">With these simple measures, you increase the protection of your application many times over because you make it harder for potential attackers to issue commands at the database level.</p>
        
        
            <h3 class="t3" id="h24.2.8">24.2.8    <a id="p699"/>eval<a class="indexanchor" id="i24_55"/></h3>
            <p class="standard">The ECMAScript standard defines the <samp class="listingcharacter listingcharacter">eval</samp> function, which can be used to have a character string interpreted and executed as JavaScript. As helpful as this function may seem, it offers a lot of risk and potential for attack. You should be especially careful not to allow any user to execute JavaScript code in an uncontrolled manner.</p>
            <p class="standard">In the worst case, a user of your application injects a string, which then gets evaluated and executed by <samp class="listingcharacter listingcharacter">eval</samp>. <span class="crossreference "><a href="24_002.html#l24.15">Listing 24.15</a></span> demonstrates such a case, where it’s possible for an attacker to execute malicious code<a class="indexanchor" id="i24_56"/> through a server request.</p>
            <div class="listing " id="l24.15"><pre><span class="rot">import</span><span class="schwarz"> { createServer } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'http'</span><span class="schwarz">;</span><br/> <br/>createServer((req, res) <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>  <span class="rot">if</span><span class="schwarz"> (req.method </span><span class="dunkelblau">===</span><span class="schwarz"> </span><span class="hellblau">'POST'</span><span class="schwarz">) {</span><br/>    <span class="rot">let</span><span class="schwarz"> command </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="hellblau">''</span><span class="schwarz">;</span><br/>    req.on(<span class="hellblau">'data'</span><span class="schwarz">, (data) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>      command <span class="dunkelblau">+=</span><span class="schwarz"> data.toString();</span><br/>    });<br/>    req.on(<span class="hellblau">'end'</span><span class="schwarz">, () </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>      <span class="bold"><samp class="listingcharacter listingcharacter">eval(command);</samp></span><br/>      res.end();<br/>    });<br/>  }<br/>}).listen(8080); <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 24.15</b>    
            Security Gaps Due to “eval”</p>
            <p class="standard">The security gap really stands out in this example. An attacker is given the opportunity by this piece of source code to execute arbitrary source code that they have injected using a <samp class="listingcharacter listingcharacter">POST</samp> request. You can see such a <samp class="listingcharacter listingcharacter">POST</samp> request in <span class="crossreference "><a href="24_002.html#l24.16">Listing 24.16</a></span>.</p>
            <div class="listing " id="l24.16"><pre>curl -X POST --data "command=console.log('This could harm your system')" <br/>localhost:8080 </pre></div>
            <p class="caption "><b>Listing 24.16</b>    
            Injecting Malicious Code</p>
            <p class="standard">If you execute the source code from <span class="crossreference "><a href="24_002.html#l24.15">Listing 24.15</a></span> and then enter the request from <span class="crossreference "><a href="24_002.html#l24.16">Listing 24.16</a></span> on the command line, the <samp class="listingcharacter listingcharacter">console.log</samp> command gets executed. This doesn’t cause any direct damage yet. However, when you realize that you have all the permissions<a class="indexanchor" id="i24_57"/> the user under whom the application is running also has, the full extent of the risk becomes clear. Combined with other antipatterns, such as running applications with administrator privileges, this security gap can have devastating consequences.</p>
            <p class="standard">Another way to increase the security of your application is to use the strict mode<a class="indexanchor" id="i24_58"/>. This mode is already enabled by default for ECMAScript modules. In CommonJS, you enable <a id="p700"/>it by specifying the <samp class="listingcharacter listingcharacter">use strict</samp> string inside a function. This strict mode ensures that you can’t initialize any new variables via <samp class="listingcharacter listingcharacter">eval</samp> in the source code you run.</p>
            <p class="standard">One possible measure against the <samp class="listingcharacter listingcharacter">eval</samp> risk is to completely avoid using <samp class="listingcharacter listingcharacter">eval</samp> and provide the features that a user of your application can access directly as methods that are executed according to user requests. This way, you can significantly reduce the risk potential within your application.</p>
            <p class="standard">It’s now common knowledge among most JavaScript developers that using <samp class="listingcharacter listingcharacter">eval</samp> is an antipattern. However, there is another way to execute source code from within a character string. The <samp class="listingcharacter listingcharacter">function</samp> constructor<a class="indexanchor" id="i24_59"/> can be used to make any source code executable, which is close to <samp class="listingcharacter listingcharacter">eval</samp> in terms of its effect. <span class="crossreference "><a href="24_002.html#l24.17">Listing 24.17</a></span> shows an example of such potentially malicious source code.</p>
            <div class="listing " id="l24.17"><pre><span class="rot">const</span><span class="schwarz"> code </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="hellblau">'console.log(process.pid)'</span><span class="schwarz">;</span><br/><br/><span class="rot">const</span><span class="schwarz"> func </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">Function(code);</span><br/><br/>func(); <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 24.17</b>    
            Command Execution Using the “function” Constructor</p>
            <p class="standard">The source code in <span class="crossreference "><a href="24_002.html#l24.17">Listing 24.17</a></span> outputs the ID of the current process. The execution context of the source code is the global scope, which means, in this case, you can’t access the module system for loading modules and can only use modules that have already been loaded. Despite this limitation, you should avoid executing user-generated source code in this uncontrolled manner.</p>
        
        
            <h3 class="t3" id="h24.2.9">24.2.9    Method Invocation<a class="indexanchor" id="i24_60"/></h3>
            <p class="standard">Another potential risk factor—although not as severe as code execution via <samp class="listingcharacter listingcharacter">eval</samp>—is the execution of methods triggered by users. Normally, a request from a client to the server causes the execution<a class="indexanchor" id="i24_61"/> of a very specific part of the application’s source code. In this case, you as the operator of the application can control which routines the users of your application can execute and which parts of the application aren’t accessible or not directly accessible. In JavaScript, however, you can also dynamically specify the names of the methods you call. <span class="crossreference "><a href="24_002.html#l24.18">Listing 24.18</a></span> illustrates this.</p>
            <div class="listing " id="l24.18"><pre>myObj<span class="schwarz">[methodName](); </span><span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 24.18</b>    
            Variable Method Names</p>
            <p class="standard">The <samp class="listingcharacter listingcharacter">methodName</samp> variable from <span class="crossreference "><a href="24_002.html#l24.18">Listing 24.18</a></span> can take the value of any method available in <samp class="listingcharacter listingcharacter">myObj</samp>. Overall, the source code in <span class="crossreference "><a href="24_002.html#l24.18">Listing 24.18</a></span> then makes sure that this method is called. If you now start from this source code and connect it to an HTTP server through <a id="p701"/>which users of your application can then dynamically call methods on specific objects, this has the potential for a security gap<a class="indexanchor" id="i24_62"/> within your application (see <span class="crossreference "><a href="24_002.html#l24.19">Listing 24.19</a></span>).</p>
            <div class="listing " id="l24.19"><pre><span class="rot">import</span><span class="schwarz"> { createServer } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'http'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> { parse } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'url'</span><span class="schwarz">;</span><br/> <br/><span class="rot">class User</span><span class="schwarz"> {</span><br/>  create() {<br/>    <span class="magenta">console</span><span class="schwarz">.log(</span><span class="hellblau">'create'</span><span class="schwarz">);</span><br/>  }<br/>  read() {<br/>    <span class="magenta">console</span><span class="schwarz">.log(</span><span class="hellblau">'read'</span><span class="schwarz">);</span><br/>  }<br/>  update() {<br/>    <span class="magenta">console</span><span class="schwarz">.log(</span><span class="hellblau">'update'</span><span class="schwarz">);</span><br/>  }<br/>  delete() {<br/>    <span class="magenta">console</span><span class="schwarz">.log(</span><span class="hellblau">'delete'</span><span class="schwarz">);</span><br/>  }<br/>}<br/> <br/>createServer((req, res) <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>  <span class="rot">const</span><span class="schwarz"> reqData </span><span class="dunkelblau">=</span><span class="schwarz"> parse(req.url, </span><span class="rot">true</span><span class="schwarz">).query;</span><br/>  <span class="rot">const</span><span class="schwarz"> user </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">User(reqData.id);</span><br/> <br/>  res.end(user[reqData.method]());<br/>}).listen(8080); <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 24.19</b>    
            Dynamic Call of Methods</p>
            <p class="standard">When a request is made to the web server in <span class="crossreference "><a href="24_002.html#l24.19">Listing 24.19</a></span>, an instance of the <samp class="listingcharacter listingcharacter">user</samp> class is generated based on the data passed. In the further course of the process, the result of a dynamic method call<a class="indexanchor" id="i24_63"/> is returned to the client. This type of source code can be helpful if information such as email addresses or names of users are to be read. The situation becomes more difficult when it comes to confidential data such as passwords. However, the source code from <span class="crossreference "><a href="24_002.html#l24.19">Listing 24.19</a></span> doesn’t only allow for calling methods to read user properties. Through this source code, all methods of the <samp class="listingcharacter listingcharacter">user</samp> object can be called. For example, if the <samp class="listingcharacter listingcharacter">user</samp> object has a <samp class="listingcharacter listingcharacter">delete</samp> method that can be used to delete the object, you can trigger this method via the call shown in <span class="crossreference "><a href="24_002.html#l24.20">Listing 24.20</a></span>.</p>
            <div class="listing " id="l24.20"><pre>curl -X GET 'http://localhost:8080/?id=1&amp;method=delete' </pre></div>
            <p class="caption "><b>Listing 24.20</b>    
            Calling the “delete” Method</p>
            <p class="standard"><a id="p702"/>You can solve this problem in several ways. The simplest way is to completely do without a dynamic method call and instead make all methods available directly via URLs. This way, you can immediately control which functionality you want to publish. If you don’t want to omit dynamic method calls, you can also secure this in a simple way by keeping a whitelist. A whitelist in this case means that you keep a list of the methods you want to allow. Calling the remaining methods isn’t allowed and results in a response with the status code <samp class="listingcharacter listingcharacter">403 Forbidden</samp>. <span class="crossreference "><a href="24_002.html#l24.21">Listing 24.21</a></span> what such an implementation could look like.</p>
            <div class="listing " id="l24.21"><pre><span class="rot">import</span><span class="schwarz"> { createServer } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'http'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> { parse } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'url'</span><span class="schwarz">;</span><br/> <br/><span class="rot">class User</span><span class="schwarz"> {...}</span><br/> <br/>createServer((req, res) <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>  <span class="rot">const</span><span class="schwarz"> reqData </span><span class="dunkelblau">=</span><span class="schwarz"> parse(req.url, </span><span class="rot">true</span><span class="schwarz">).query;</span><br/>  <span class="rot">const</span><span class="schwarz"> user </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">User(reqData.id);</span><br/>  <span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">const</span><span class="schwarz"> whitelist </span><span class="dunkelblau">=</span><span class="schwarz"> [</span><span class="hellblau">'create'</span><span class="schwarz">, </span><span class="hellblau">'read'</span><span class="schwarz">];</span><br/> <br/>  <span class="rot">if</span><span class="schwarz"> (reqData.method </span><span class="dunkelblau">&amp;&amp;</span><span class="schwarz"> whitelist.indexOf(reqData.method) </span><span class="dunkelblau">!=</span><span class="schwarz"> </span><span class="dunkelblau">-</span><span class="schwarz">1) {</span><br/>    res.end(user[reqData.method]());<br/>  } <span class="rot">else</span><span class="schwarz"> {</span><br/>    req.statusCode <span class="dunkelblau">=</span><span class="schwarz"> 403;</span><br/>    res.end();<br/>  }</samp></span><br/>}).listen(8080); <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 24.21</b>    
            Whitelisting for Method Calls</p>
            <p class="standard">But there are more than just the obvious sources of danger lurking in the data that reaches your application from outside. It’s also important to pay attention to security within the application.</p>
        
        
            <h3 class="t3" id="h24.2.10">24.2.10    Overwriting Built-Ins<a class="indexanchor" id="i24_64"/></h3>
            <p class="standard">JavaScript is a dynamic language that allows you to override almost anything. However, this flexibility also comes at a price. It’s possible for an attacker to inject malicious code into your application and disguise it as standard functionality. For example, you can overwrite the <samp class="listingcharacter listingcharacter">log</samp> method of the <samp class="listingcharacter listingcharacter">console</samp> object or the <samp class="listingcharacter listingcharacter">toLowerCase</samp> method of the <samp class="listingcharacter listingcharacter">string</samp> prototype. As long as you do it yourself, the worst thing you’ll encounter is problems with the standard functions<a class="indexanchor" id="i24_65"/> the V8 engine offers you. However, if a stranger does this, it becomes critical because it’s quite possible to send sensitive data of your application via an outgoing HTTP connection. <span class="crossreference "><a href="24_002.html#l24.22">Listing 24.22</a></span> shows how such an override of standard functionality can occur.</p>
            <div class="listing " id="l24.22"><pre><span class="rot"><a id="p703"/>import</span><span class="schwarz"> myModule </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./myModule.js'</span><span class="schwarz">;</span><br/> <br/><span class="magenta">console</span><span class="schwarz">.log(myModule.name.toLowerCase()); </span><span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 24.22</b>    
            Overwriting Standard Functionality (index.js)</p>
            <p class="standard">At first glance, the source code from the example loads a module and outputs the value of the <samp class="listingcharacter listingcharacter">name</samp> property in lowercase to the console. However, if you run the source code of this example, the output you’ll receive looks like the one shown in <span class="crossreference "><a href="24_002.html#l24.23">Listing 24.23</a></span>.</p>
            <div class="listing " id="l24.23"><pre><span class="bold"><samp class="listingcharacter listingcharacter">$ node index.js</samp></span><br/>This is String.toLowerCase<br/>Another Implementation </pre></div>
            <p class="caption "><b>Listing 24.23</b>    
            Output of the Overwritten Standard Functionality</p>
            <p class="standard">In <span class="crossreference "><a href="24_002.html#l24.24">Listing 24.24</a></span>, you can see the source code that causes this unexpected output.</p>
            <div class="listing " id="l24.24"><pre><span class="rot">const</span><span class="schwarz"> myLog </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="magenta">console</span><span class="schwarz">.log;</span><br/> <br/><span class="magenta">console</span><span class="schwarz">.log </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> () {</span><br/>  myLog(<span class="hellblau">'Another Implementation'</span><span class="schwarz">);</span><br/>};<br/> <br/>String.prototype.toLowerCase <span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> () {</span><br/>  myLog(<span class="hellblau">'This is String.toLowerCase'</span><span class="schwarz">);</span><br/>};<br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">default</span><span class="schwarz"> {</span><br/>  name: <span class="hellblau">'MyModule'</span><span class="schwarz">,</span><br/>}; <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 24.24</b>    
            Injecting Source Code (myModule.js)</p>
            <p class="standard">Here, you first save a reference to the original implementation of <samp class="listingcharacter listingcharacter">console.log</samp>. After that, you overwrite this implementation coming from the JavaScript engine with your own one. Because this is a global functionality<a class="indexanchor" id="i24_66"/>, this action also affects files that include this file. In addition, you overwrite the <samp class="listingcharacter listingcharacter">toLowerCase</samp> method of the <samp class="listingcharacter listingcharacter">string</samp> class. This operation also potentially affects other files if you include the file through the module system. Finally, you export an object you actually want to use.</p>
            <p class="standard">The full impact of this security issue doesn’t become apparent until you consider how you normally develop your applications. Even before you start with the actual programming, you’ve already installed at least one Node Package Manager (npm) package<a class="indexanchor" id="i24_67"/>. And such packages are nothing more than what you just did with the file in <span class="crossreference "><a href="24_002.html#l24.24">Listing 24.24</a></span>. Thus, it’s possible that an attacker could plant malicious code on you through a <a id="p704"/>crafted npm package without you noticing. For this reason, you should always be suspicious of packages from third-party providers. However, that’s not all when it comes to the security of npm packages.</p>
        
    </div><p class="signatur"/>
                    </body>
                </html>