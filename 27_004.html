<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
                    
        <head><meta content="application/xhtml+xml; charset=utf-8" http-equiv="Content-Type"/>
            <meta content="application/xhtml+xml; charset=utf-8" name="content-type"/>
            <meta content="Microservices with Node.js" name="title"/>
            <meta content="Sebastian Springer" name="author"/>
            <meta content="Rheinwerk Publishing" name="publisher"/>
            <meta content="© 2022 by Rheinwerk Publishing Inc., Boston (MA)" name="copyright"/>
            <meta content="Node.js - The Comprehensive Guide - Microservices with Node.js" name="description"/>
            <meta content="en" name="language"/>
            <title>Microservices with Node.js</title>
            <link href="common/main.css" rel="stylesheet" type="text/css"/>
<meta content="urn:uuid:e0000000-0000-0000-0000-000029756394" name="Adept.expected.resource"/>
        </head>
    


                    <body class="office_us type_kapitel">
                        <div id="main">
        <h2 class="t2" id="h27.4">27.4    Asynchronous Microservice with RabbitMQ<a class="indexanchor" id="i27_36"/></h2>
        <p class="standard">The first microservice of the application we’ll implement works asynchronously, that is, relatively strongly decoupled. The user service isn’t an ideal example here because communication via a message queue such as <span class="italic">RabbitMQ</span> also entails a potential time delay due to the strong decoupling. However, this example nicely illustrates the bidirectional<a class="indexanchor" id="i27_37"/> and thus equal communication between the services as well as the resulting problems.</p>
        <p class="standard">The direct question-answer pattern we implement in this example is rather unusual for an asynchronous service, and a common web protocol such as HTTP would work just as well, if not better, for the implementation. Message queues are typically used in places <a id="p760"/>where the request is decoupled from the response. Take, for example, the creation of a new user account. In this case, users enter their data via the frontend and send the request to an API gateway, and then the gateway sends the message on to the message queue. Once the message is submitted there, users will be notified that the request was successfully received. Then, the system processes the message by reading it from the message queue, creating the account, and informing users, for example, by email, that the account can be activated via a separate link. The message queue here ensures that the message about the creation of a new account is processed in any case. For example, if the user service crashes during creation, the message isn’t acknowledged and is processed again once the service is restarted or another instance of the service processes the message.</p>
        
            <h3 class="t3" id="h27.4.1">27.4.1    Installation and Setup<a class="indexanchor" id="i27_38"/></h3>
            <p class="standard">Each microservice of your application is an independent small application within a larger overall system. For this reason, you also start developing the user service in a new subdirectory named <span class="italic">user</span>. In this directory, you first run the <samp class="listingcharacter listingcharacter">npm init</samp> command. Then you should add the <samp class="listingcharacter listingcharacter">type</samp> and <samp class="listingcharacter listingcharacter">private</samp> properties to the default configuration and set the startup script. Next, you use the <samp class="listingcharacter listingcharacter">npm install mongodb amqplib</samp> command to install the MongoDB driver for data storage and the Advanced Message Queuing Protocol (AMQP) library for communication. The resulting <span class="italic">package.json</span> file should look like the one shown in <span class="crossreference "><a href="27_004.html#l27.2">Listing 27.2</a></span>.</p>
            <div class="listing " id="l27.2"><pre><span class="schwarz">{</span><br/>  <span class="hellblau">"name"</span><span class="schwarz">: </span><span class="hellblau">"user-service"</span><span class="schwarz">,</span><br/>  <span class="hellblau">"version"</span><span class="schwarz">: </span><span class="hellblau">"1.0.0"</span><span class="schwarz">,</span><br/>  <span class="hellblau">"description"</span><span class="schwarz">: </span><span class="hellblau">""</span><span class="schwarz">,</span><br/>  <span class="bold"><samp class="listingcharacter listingcharacter"><span class="hellblau">"type"</span><span class="schwarz">: </span><span class="hellblau">"module"</span><span class="schwarz">,</span><br/>  <span class="hellblau">"private"</span><span class="schwarz">: </span><span class="rot">true</span><span class="schwarz">,</span></samp></span><br/>  <span class="hellblau">"main"</span><span class="schwarz">: </span><span class="hellblau">"index.js"</span><span class="schwarz">,</span><br/>  <span class="hellblau">"scripts"</span><span class="schwarz">: {</span><br/>    <span class="bold"><samp class="listingcharacter listingcharacter"><span class="hellblau">"start"</span><span class="schwarz">: </span><span class="hellblau">"node index.js"</span></samp></span><span class="schwarz"><br/></span>  },<br/>  <span class="hellblau">"keywords"</span><span class="schwarz">: [],</span><br/>  <span class="hellblau">"author"</span><span class="schwarz">: </span><span class="hellblau">""</span><span class="schwarz">,</span><br/>  <span class="hellblau">"license"</span><span class="schwarz">: </span><span class="hellblau">"ISC"</span><span class="schwarz">,</span><br/>  <span class="bold"><samp class="listingcharacter listingcharacter"><span class="hellblau">"dependencies"</span><span class="schwarz">: {</span><br/>      <span class="hellblau">"amqplib"</span><span class="schwarz">: </span><span class="hellblau">"^0.8.0"</span><span class="schwarz">,</span><br/>    <span class="hellblau">"mongodb"</span><span class="schwarz">: </span><span class="hellblau">"^4.1.1"</span><span class="schwarz"><br/></span>  }</samp></span><br/>} <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 27.2</b>    
            “package.json” File of the User Service (user/package.json)</p>
            <p class="standard"><a id="p761"/>In the <span class="italic">index.js</span> file, the entry point to the service, you build the basic framework of the application. This differs significantly from the previous web backends you’ve implemented by using the AMQP<a class="indexanchor" id="i27_39"/> library. However, again, you should make the entry point to your application as slim and lightweight as possible. <span class="crossreference "><a href="27_004.html#l27.3">Listing 27.3</a></span> shows an example of such a basic setup. You save this source code in a file named <span class="italic">index.js</span> in the <span class="italic">user</span> directory.</p>
            <div class="listing " id="l27.3"><pre><span class="rot">import</span><span class="schwarz"> { getAllAction, createAction } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./controller.js'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> { getChannel, queue } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./connect.js'</span><span class="schwarz">;</span><br/> <br/><span class="rot">const</span><span class="schwarz"> channel </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> getChannel();</span><br/> <br/>channel.consume(queue, (message) <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>  <span class="rot">const</span><span class="schwarz"> messageData </span><span class="dunkelblau">=</span><span class="schwarz"> JSON.parse(message.content.toString());</span><br/>  <span class="rot">if</span><span class="schwarz"> (messageData.role </span><span class="dunkelblau">===</span><span class="schwarz"> </span><span class="hellblau">'user'</span><span class="schwarz">) {</span><br/>    <span class="rot">switch</span><span class="schwarz"> (messageData.cmd) {</span><br/>      <span class="rot">case</span><span class="schwarz"> </span><span class="hellblau">'getAll'</span><span class="schwarz">:</span><br/>        getAllAction(channel, messageData.id);<br/>        <span class="rot">break</span><span class="schwarz">;</span><br/>      <span class="rot">case</span><span class="schwarz"> </span><span class="hellblau">'create'</span><span class="schwarz">:</span><br/>        createAction(channel, messageData.id, messageData.data);<br/>        <span class="rot">break</span><span class="schwarz">;</span><br/>      <span class="rot">default</span><span class="schwarz">:</span><br/>        <span class="magenta">console</span><span class="schwarz">.error(</span><span class="hellblau">'Unknown command'</span><span class="schwarz">);</span><br/>        channel.nack(message);<br/>        <span class="rot">break</span><span class="schwarz">;</span><br/>    }<br/>  }<br/>});<br/>  <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 27.3</b>    
            Basic Setup for the User Service (user/index.js)</p>
            <p class="standard">In <span class="crossreference "><a href="27_004.html#l27.3">Listing 27.3</a></span>, you can see that the entry file is responsible for receiving and correctly redistributing the incoming messages. For this purpose, you must first connect to the message queue server. This is taken care of by the <samp class="listingcharacter listingcharacter">getChannel</samp> function, which is swapped out into a separate file. This function makes sure that the connection to the server is established and a communication channel is opened. Messages can then be received on this channel using the <samp class="listingcharacter listingcharacter">consume</samp> method. A new message triggers an event, based on which the callback function registered in the <samp class="listingcharacter listingcharacter">consume</samp> method gets run.</p>
            <p class="standard">The received message object must be decoded and converted into an object in the first step. At this point, it’s important that all entities involved in the communication agree on a uniform message format, that is, in the broadest sense, on a communication protocol<a class="indexanchor" id="i27_40"/>. For our example, a message looks like the one shown in <span class="crossreference "><a href="27_004.html#l27.4">Listing 27.4</a></span>.</p>
            <div class="listing " id="l27.4"><pre><span class="schwarz"><a id="p762"/>{</span><br/>  id: <span class="hellblau">'95ab6062-ded3-41db-8d65-2059232c67e2'</span><span class="schwarz">,</span><br/>  role: <span class="hellblau">'user'</span><span class="schwarz">,</span><br/>  cmd: <span class="hellblau">'getAll'</span><span class="schwarz"><br/></span>} <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 27.4</b>    
            Format of a RabbitMQ Message</p>
            <p class="standard">The message has a unique ID, called a <span class="italic">correlation identifier</span><a class="indexanchor" id="i27_41"/>, which is used to link the request to the response (go to <span class="url"><a href="http://www.enterpriseintegrationpatterns.com/CorrelationIdentifier.html">www.enterpriseintegrationpatterns.com/CorrelationIdentifier.html</a></span> for more on correlation identifiers). In addition, there are the <samp class="listingcharacter listingcharacter">role</samp> and <samp class="listingcharacter listingcharacter">cmd</samp> properties. Aside from that, the message may have an optional <samp class="listingcharacter listingcharacter">data</samp> field to which you can transfer further information. The <samp class="listingcharacter listingcharacter">role</samp> field is used to narrow down the recipient. This is already done via the name of the communication channel, but should the user service send or receive metadata or logging data via the message queue in the future, for example, this can be mapped via the <samp class="listingcharacter listingcharacter">role</samp> property. The <samp class="listingcharacter listingcharacter">cmd</samp> property contains the command to be executed, which can be a value such as <samp class="listingcharacter listingcharacter">getAll</samp> or <samp class="listingcharacter listingcharacter">create</samp>. Based on the <samp class="listingcharacter listingcharacter">role</samp> and <samp class="listingcharacter listingcharacter">cmd</samp> property, the user service decides which function to execute. Thus, the <span class="italic">index.js</span> file performs the task of a router.</p>
        
        
            <h3 class="t3" id="h27.4.2">27.4.2    Connecting to the RabbitMQ Server<a class="indexanchor" id="i27_42"/></h3>
            <p class="standard">Basically, using the message queue, in this case, RabbitMQ, is similar to using a database. First you establish a connection to the server, and then you can write to and read from the queue. In <span class="crossreference "><a href="27_004.html#l27.5">Listing 27.5</a></span>, you can see the implementation of the <samp class="listingcharacter listingcharacter">getChannel</samp> function in the <span class="italic">connect.js</span> file of the user service.</p>
            <div class="listing " id="l27.5"><pre><span class="rot">import</span><span class="schwarz"> { connect } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'amqplib'</span><span class="schwarz">;</span><br/> <br/><span class="rot">let</span><span class="schwarz"> channel </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">null</span><span class="schwarz">;</span><br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">const</span><span class="schwarz"> queue </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="hellblau">'user'</span><span class="schwarz">;</span><br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> getChannel() {</span><br/>  <span class="rot">try</span><span class="schwarz"> {</span><br/>    <span class="rot">if</span><span class="schwarz"> (channel) {</span><br/>      <span class="rot">return</span><span class="schwarz"> channel;</span><br/>    }<br/>    <span class="rot">const</span><span class="schwarz"> connection </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> connect(</span><span class="hellblau">'amqp://rabbitmq'</span><span class="schwarz">);</span><br/>    channel <span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> connection.createChannel();</span><br/> <br/>    <span class="rot">const</span><span class="schwarz"> ok </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> channel.assertQueue(queue);</span><br/> <br/>    <span class="rot">if</span><span class="schwarz"> (ok) {</span><br/>      <span class="rot">return</span><span class="schwarz"> channel;</span><br/><a id="p763"/>    }<br/>  } <span class="rot">catch </span><span class="schwarz">(</span><span class="rot">error</span><span class="schwarz">) {</span><br/>    <span class="magenta">console</span><span class="schwarz">.error(error);</span><br/>    <span class="rot">throw</span><span class="schwarz"> error;</span><br/>  }<br/>} <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 27.5</b>    
            Connecting to RabbitMQ (user/connect.js)</p>
            <p class="standard">First, you import the <samp class="listingcharacter listingcharacter">connect</samp> function from the <samp class="listingcharacter listingcharacter">amqplib</samp> package, which you use to connect to the message queue. The interface of the package supports both a callback-based and a promise-based variant. In the example, you use the promise-based interface in conjunction with the asynchronous <samp class="listingcharacter listingcharacter">getChannel</samp> function and the <samp class="listingcharacter listingcharacter">await</samp> keyword to first connect to RabbitMQ via <span class="italic">amqp://rabbitmq</span><a class="indexanchor" id="i27_43"/>. The host name <samp class="listingcharacter listingcharacter">rabbitmq</samp> is provided to you by <samp class="listingcharacter listingcharacter">docker-compose</samp> through the local network. Then you create a channel on this connection and build an initial queue named <samp class="listingcharacter listingcharacter">user</samp>.</p>
            <p class="standard">You return the created channel object after the operations are completed. If an error occurs in this process, it’s caught by the <samp class="listingcharacter listingcharacter">try-catch</samp> statement, output to the console, and continues to be thrown. For the purpose of optimization, you should store the reference to the channel in a variable named <samp class="listingcharacter listingcharacter">channel</samp>. If the <samp class="listingcharacter listingcharacter">getChannel</samp> function is called more than once, it returns the previously created channel object.</p>
        
        
            <h3 class="t3" id="h27.4.3">27.4.3    Handling Incoming Messages<a class="indexanchor" id="i27_44"/></h3>
            <p class="standard">As is the case with Express, you can implement message handling directly in the event handler. However, a better variant is to swap out these routines to functions of their own. If, in addition to that, you assign meaningful names to these functions, you can significantly increase the readability of your source code and also facilitate testing the application. To implement this message queue controller, you must first create a new <span class="italic">controller.js</span> file in the <span class="italic">user</span> directory of your application and save the source code from <span class="crossreference "><a href="27_004.html#l27.6">Listing 27.6</a></span> there.</p>
            <div class="listing " id="l27.6"><pre><span class="rot">import</span><span class="schwarz"> { create, getAll } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./model.js'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> { getChannel, queue } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./connect.js'</span><span class="schwarz">;</span><br/> <br/><span class="rot">function</span><span class="schwarz"> createMessage(id, data) {</span><br/>  <span class="rot">return</span><span class="schwarz"> {</span><br/>    role: <span class="hellblau">'user'</span><span class="schwarz">,</span><br/>    cmd: <span class="hellblau">'answer'</span><span class="schwarz">,</span><br/>    id,<br/>    data,<br/>  };<br/>}<br/> <br/><span class="rot"><a id="p764"/>async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> send(message) {</span><br/>  <span class="rot">const</span><span class="schwarz"> channel </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> getChannel();</span><br/>  channel.sendToQueue(queue, Buffer.from(JSON.stringify(message)));<br/>}<br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> getAllAction(channel, id) {</span><br/>  <span class="rot">const</span><span class="schwarz"> data </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> getAll();</span><br/>  <span class="rot">const</span><span class="schwarz"> message </span><span class="dunkelblau">=</span><span class="schwarz"> createMessage(id, data);</span><br/>  send(message);<br/>}<br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> createAction(channel, id, data) {</span><br/>  <span class="rot">const</span><span class="schwarz"> newData </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> create(data);</span><br/>  <span class="rot">const</span><span class="schwarz"> message </span><span class="dunkelblau">=</span><span class="schwarz"> createMessage(id, newData);</span><br/>  send(message);<br/>} <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 27.6</b>    
            User Controller (user/controller.js)</p>
            <p class="standard">You structure the two exported functions <samp class="listingcharacter listingcharacter">getAllAction</samp> and <samp class="listingcharacter listingcharacter">createAction</samp> according to the same schema: In the first step, you trigger the actual action, either reading or creating a record in the model; wait for the action to complete; create a message; and send it to the message queue. The sent messages, like the received ones before, follow a certain format. They also contain the <samp class="listingcharacter listingcharacter">role</samp> and <samp class="listingcharacter listingcharacter">cmd</samp> fields. The <samp class="listingcharacter listingcharacter">cmd</samp> field contains the value <samp class="listingcharacter listingcharacter">answer</samp> to indicate that it’s an asynchronous response to a command. The <samp class="listingcharacter listingcharacter">id</samp> corresponds to the <samp class="listingcharacter listingcharacter">id</samp> of the request to be responded to. This allows the requesting entity to establish the link between the request and the response. The last component in the implementation of the user service is the connection of the database.</p>
        
        
            <h3 class="t3" id="h27.4.4">27.4.4    Database Connection<a class="indexanchor" id="i27_45"/></h3>
            <p class="standard">A MongoDB<a class="indexanchor" id="i27_46"/> database is for storing the <samp class="listingcharacter listingcharacter">user</samp> objects. You’ve already installed the appropriate driver in <span class="crossreference "><a href="27_004.html#h27.4.1">Section 27.4.1</a></span>, using the <samp class="listingcharacter listingcharacter">npm install mongodb</samp> command. After that, you can implement your model in the <span class="italic">model.js</span> file in the <span class="italic">user</span> directory of your application, as shown in <span class="crossreference "><a href="27_004.html#l27.7">Listing 27.7</a></span>.</p>
            <div class="listing " id="l27.7"><pre><span class="rot">import</span><span class="schwarz"> { MongoClient } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'mongodb'</span><span class="schwarz">;</span><br/> <br/><span class="rot">const</span><span class="schwarz"> url </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="hellblau">'mongodb://mongodb:27017'</span><span class="schwarz">;</span><br/><span class="rot">const</span><span class="schwarz"> dbName </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="hellblau">'users'</span><span class="schwarz">;</span><br/> <br/><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> connect() {</span><br/>  <span class="rot">const</span><span class="schwarz"> client </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> MongoClient.connect(url);</span><br/>  <span class="rot">const</span><span class="schwarz"> db </span><span class="dunkelblau">=</span><span class="schwarz"> client.db(dbName);</span><br/>  <span class="rot">const</span><span class="schwarz"> usersCollection </span><span class="dunkelblau">=</span><span class="schwarz"> db.collection(</span><span class="hellblau">'users'</span><span class="schwarz">);</span><br/><a id="p765"/>  <span class="rot">return</span><span class="schwarz"> {</span><br/>    client,<br/>    usersCollection,<br/>  };<br/>}<br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> getAll() {</span><br/>  <span class="rot">const</span><span class="schwarz"> { client, usersCollection } </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> connect();</span><br/>  <span class="rot">const</span><span class="schwarz"> data </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> usersCollection.find().toArray();</span><br/>  client.close();<br/>  <span class="rot">return</span><span class="schwarz"> data;</span><br/>}<br/> <br/><span class="rot">export</span><span class="schwarz"> </span><span class="rot">async</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> create(user) {</span><br/>  <span class="rot">const</span><span class="schwarz"> { client, usersCollection } </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">await</span><span class="schwarz"> connect();</span><br/>  <span class="rot">await</span><span class="schwarz"> usersCollection.insertOne(user);</span><br/>  client.close();<br/>  <span class="rot">return</span><span class="schwarz"> user;</span><br/>} <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 27.7</b>    
            Model Implementation (user/model.js)</p>
            <p class="standard">The model provides the two functions, <samp class="listingcharacter listingcharacter">getAll</samp> and <samp class="listingcharacter listingcharacter">create</samp>. Both are async functions that first set up a connection, then communicate with the database, disconnect, and return the result wrapped in a promise object. In this case, you set the database URL to the value <samp class="listingcharacter listingcharacter">mongodb://mongodb:27017</samp><a class="indexanchor" id="i27_47"/> because using <samp class="listingcharacter listingcharacter">docker-compose</samp> changes the host name from <samp class="listingcharacter listingcharacter">localhost</samp> to <samp class="listingcharacter listingcharacter">mongodb</samp>. In <span class="crossreference "><a href="27_004.html#l27.9">Listing 27.9</a></span>, up ahead in this section, you can find the corresponding <span class="italic">docker-compose.yml</span> file.</p>
            <p class="standard">With this implementation, you’ve realized the first complete process from the incoming request to the database and back to the client via the outgoing response.</p>
        
        
            <h3 class="t3" id="h27.4.5">27.4.5    Docker Setup<a class="indexanchor" id="i27_48"/></h3>
            <p class="standard">You’ve implemented the first microservice of your application with this source code. To be able to start it, you need to boot the MongoDB instance<a class="indexanchor" id="i27_49"/>, the RabbitMQ server<a class="indexanchor" id="i27_50"/>, and the actual user service. This can be done by starting each of these services in their own Docker container. To avoid having to start the containers individually by hand, you should integrate them into your <samp class="listingcharacter listingcharacter">docker-compose</samp> configuration.</p>
            <p class="standard">For RabbitMQ and MongoDB, we’ll use the default images. The user service is created via a Dockerfile. The Dockerfile required for this is shown in <span class="crossreference "><a href="27_004.html#l27.8">Listing 27.8</a></span>.</p>
            <div class="listing " id="l27.8"><pre>FROM node<span class="schwarz">:16.8.0</span><br/>WORKDIR <span class="dunkelblau">/</span><span class="schwarz">usr</span><span class="dunkelblau">/</span><span class="schwarz">src</span><span class="dunkelblau">/</span><span class="schwarz">app</span><br/>COPY <span class="rot">package</span><span class="dunkelblau">*</span><span class="schwarz">.json .</span><span class="dunkelblau">/</span><span class="schwarz"><br/></span><a id="p766"/>RUN npm install<br/>COPY . .<br/>CMD [ <span class="hellblau">"npm"</span><span class="schwarz">, </span><span class="hellblau">"start"</span><span class="schwarz"> ]   </span><span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 27.8</b>    
            Dockerfile of the User Service</p>
            <p class="standard">With this Dockerfile, you’ve created the basis for the user service. <span class="crossreference "><a href="27_004.html#l27.9">Listing 27.9</a></span> contains the source code of the <span class="italic">docker-compose.yml</span> file, which you can use to start the service.</p>
            <div class="listing " id="l27.9"><pre>version<span class="schwarz">: </span><span class="hellblau">'3'</span><span class="schwarz"><br/></span>services:<br/>  mongodb:<br/>    image: mongo:latest<br/>    container_name: <span class="hellblau">'mongodb'</span><span class="schwarz"><br/></span>    ports:<br/>      <span class="dunkelblau">-</span><span class="schwarz"> 27017:27017</span><br/>  mongo<span class="dunkelblau">-</span><span class="schwarz">seed:</span><br/>    image: mongo:latest<br/>    links:<br/>      <span class="dunkelblau">-</span><span class="schwarz"> mongodb</span><br/>    volumes:<br/>      <span class="dunkelblau">-</span><span class="schwarz"> .</span><span class="dunkelblau">/</span><span class="schwarz">initUser.json:</span><span class="dunkelblau">/</span><span class="schwarz">initUser.json</span><br/>    command: <span class="hellblau">'mongoimport --host mongodb --db users --collection users </span><img alt="inline image" class="inline_image" src="bilder/umbruchpfeil.png"/><br/>      --type json --file /initUser.json --jsonArray'<span class="schwarz"><br/></span>  rabbitmq:<br/>    image: rabbitmq:latest<br/>    ports:<br/>      <span class="dunkelblau">-</span><span class="schwarz"> 5672:5672</span><br/>  user:<br/>    build:<br/>      context: user<br/>    depends_on:<br/>      <span class="dunkelblau">-</span><span class="schwarz"> </span><span class="hellblau">'mongodb'</span><span class="schwarz"><br/></span>      <span class="dunkelblau">-</span><span class="schwarz"> </span><span class="hellblau">'rabbitmq'</span><span class="schwarz"><br/></span>    restart: on<span class="dunkelblau">-</span><span class="schwarz">failure</span><br/>    links:<br/>      <span class="dunkelblau">-</span><span class="schwarz"> </span><span class="hellblau">'rabbitmq'</span><span class="schwarz"> </span><span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 27.9</b>    
            docker-compose.yml File for the User Service</p>
            <p class="standard">In this file, you define four containers: <samp class="listingcharacter listingcharacter">user</samp>, <samp class="listingcharacter listingcharacter">mongo-seed</samp>, <samp class="listingcharacter listingcharacter">mongodb</samp>, and <samp class="listingcharacter listingcharacter">rabbitmq</samp>. For the <samp class="listingcharacter listingcharacter">user</samp> container, you reference the Dockerfile generated earlier. For <samp class="listingcharacter listingcharacter">mongodb</samp> and <samp class="listingcharacter listingcharacter">rabbitmq</samp>, you reference the respective default images and release the ports for access. By specifying <samp class="listingcharacter listingcharacter">restart: on-failure</samp>, you ensure that the <samp class="listingcharacter listingcharacter">user</samp> container is automatically restarted<a class="indexanchor" id="i27_51"/> if the other two haven’t yet started and an error occurs.</p>
            <p class="standard"><a id="p767"/>For you to be able to log in to your application later, you must make sure to initially populate your database. You can do this by specifying the <samp class="listingcharacter listingcharacter">mongoimport</samp> command as <samp class="listingcharacter listingcharacter">command</samp> with the <samp class="listingcharacter listingcharacter">mongo-seed</samp> container. This command uses the <span class="italic">initUser.json</span> file as input. You can find the contents of the file in <span class="crossreference "><a href="27_004.html#l27.10">Listing 27.10</a></span>.</p>
            <div class="listing " id="l27.10"><pre><span class="schwarz">[</span><br/>  {<br/>    <span class="hellblau">"username"</span><span class="schwarz">: </span><span class="hellblau">"sspringer"</span><span class="schwarz">,</span><br/>    <span class="hellblau">"password"</span><span class="schwarz">: </span><span class="hellblau">"test"</span><span class="schwarz"><br/></span>  }<br/>] <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 27.10</b>    
            Data for a First Test User (initUser.json)</p>
            <p class="standard">Then, you can start this part of your application via the <samp class="listingcharacter listingcharacter">docker-compose up</samp><a class="indexanchor" id="i27_52"/> command in the root directory of your application. At this point, the service can’t be tested directly unless you connect directly to the message queue and generate the required messages. In <span class="crossreference "><a href="27_004.html#f27.5">Figure 27.5</a></span>, you can see the current state of the implementation in the original architecture.</p>
            <div class="imagebox figure-type"><a href="img-f27.5.html" id="f27.5"><img alt="User Service in the Microservice Architecture" id="img-f27.5" src="bilderklein/klein27_005.png"/></a></div>
            <p class="caption "><b>Figure 27.5</b>    
            User Service in the Microservice Architecture</p>
            <p class="standard">To make the application’s interface more convenient to use, the next step is to take care of implementing your application’s API gateway.</p>
        
    </div><p class="signatur"/>
                    </body>
                </html>