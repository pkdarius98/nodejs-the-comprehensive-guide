<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
                    
        <head><meta content="application/xhtml+xml; charset=utf-8" http-equiv="Content-Type"/>
            <meta content="application/xhtml+xml; charset=utf-8" name="content-type"/>
            <meta content="Express" name="title"/>
            <meta content="Sebastian Springer" name="author"/>
            <meta content="Rheinwerk Publishing" name="publisher"/>
            <meta content="© 2022 by Rheinwerk Publishing Inc., Boston (MA)" name="copyright"/>
            <meta content="Node.js - The Comprehensive Guide - Express" name="description"/>
            <meta content="en" name="language"/>
            <title>Express</title>
            <link href="common/main.css" rel="stylesheet" type="text/css"/>
<meta content="urn:uuid:e0000000-0000-0000-0000-000029756394" name="Adept.expected.resource"/>
        </head>
    


                    <body class="office_us type_kapitel">
                        <div id="main">
        <h2 class="t2" id="h6.6">6.6    Middleware<a class="indexanchor" id="i06_52"/></h2>
        <p class="standard">A key design feature of Express is the middleware concept<a class="indexanchor" id="i06_53"/>, which makes the framework a very flexible tool. Simply put, middleware here refers to a function that stands <a id="p194"/>between the incoming request and the outgoing response. You can put as many of these functions in succession as you like. There are already numerous predefined middleware functions that you can include in your application and that perform specific tasks for you. If all this doesn’t provide any solution to your problem, you can even write such a function yourself.</p>
        
            <h3 class="t3" id="h6.6.1">6.6.1    Custom Middleware<a class="indexanchor" id="i06_54"/></h3>
            <p class="standard">You can use a middleware function to extract information from the incoming request and store it, such as with a logger. However, you can also enrich the response based on information from the request. A middleware function must have a specific signature so that it doesn’t break the chain of middleware functions. Suppose you wanted to define a logger for your application that writes each request to the console. To do this, you must adjust the contents of your application’s initial file according to <span class="crossreference "><a href="06_006.html#l6.14">Listing 6.14</a></span>.</p>
            <div class="listing " id="l6.14"><pre><span class="rot">import</span><span class="schwarz"> express </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'express'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> router </span><span class="rot">as</span><span class="schwarz"> movieRouter </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./movie/index.js'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="rot">const</span><span class="schwarz"> app </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="schwarz">express();</span><span class="schwarz"><br/></span> <br/><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">function</span><span class="schwarz"> log(request, response, next) {</span><br/>  <span class="magenta">console</span><span class="schwarz">.log(request.url);</span><br/>  next();<br/>}<br/>app.use(log);<br/> </samp></span><br/>app.use(<span class="hellblau">'/movie'</span><span class="schwarz">, movieRouter);</span><br/> <br/>app.get(<span class="hellblau">'/'</span><span class="schwarz">, (request, response) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> response.redirect(</span><span class="hellblau">'/movie'</span><span class="schwarz">));</span><br/> <br/>app.listen(8080, () <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>  <span class="magenta">console</span><span class="schwarz">.log(</span><span class="hellblau">'Server is listening to http://localhost:8080'</span><span class="schwarz">);</span><br/>}); <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 6.14</b>    
            A Simple Logger (index.js)</p>
            <p class="standard">As you can see in <span class="crossreference "><a href="06_006.html#l6.14">Listing 6.14</a></span>, the signature of a middleware function is similar to that of an ordinary routing function. A middleware function always has the three parameters: request, response, and a callback function. The request and response parameters provide access to the request and response, just like in the controller actions. The <samp class="listingcharacter listingcharacter">request</samp> object is used in the example to output the requested URL to the console. The passed callback function, which by convention is named <samp class="listingcharacter listingcharacter">next</samp>, ensures that the next middleware function in the chain is called when the function is called. If you don’t perform this callback function, usually no response is sent to the client, and the client <a id="p195"/>receives a time-out error<a class="indexanchor" id="i06_55"/>. You can register your middleware using the <samp class="listingcharacter listingcharacter">use</samp> method of your application. As the first argument, this method optionally accepts a URL path to which the middleware should be applied. If you only pass a callback function, the middleware will be executed on every request. The order in which you register your functions is important. If you first register a regular routing method that doesn’t call the <samp class="listingcharacter listingcharacter">next</samp> callback function<a class="indexanchor" id="i06_56"/>, your middleware component, which is registered afterwards, won’t be executed. If your middleware is to perform calculations or modifications you need later in the call chain of the functions, you can cache this information in the <samp class="listingcharacter listingcharacter">request</samp> object or, better yet, in the <samp class="listingcharacter listingcharacter">response</samp> object within a property. These objects are available to all functions as a reference and can therefore also be used to transport information.</p>
            <p class="standard">Especially for standard tasks,<a class="indexanchor" id="i06_57"/> such as the creation of an access log, there are prefabricated components that you only have to install and integrate. For a list of middleware components, see <span class="url"><a href="http://expressjs.com/en/resources/middleware.html">http://expressjs.com/en/resources/middleware.html</a></span>.</p>
        
        
            <h3 class="t3" id="h6.6.2">6.6.2    Morgan: <a class="indexanchor" id="i06_58"/>Logging Middleware<a class="indexanchor" id="i06_59"/> for Express</h3>
            <p class="standard">Logging<a class="indexanchor" id="i06_60"/> incoming requests is a standard problem for which there are established solutions. Morgan is one of the most popular middleware components available that does this work for you. Use the <samp class="listingcharacter listingcharacter">npm install morgan</samp> command to install the package in your application. At its core, Morgan consists of a function that accepts a format for the log entries and additional options. This means you can replace your current logger implementation with Morgan in the next step, as shown in <span class="crossreference "><a href="06_006.html#l6.15">Listing 6.15</a></span>.</p>
            <div class="listing " id="l6.15"><pre><span class="rot">import</span><span class="schwarz"> express </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'express'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">import</span><span class="schwarz"> morgan </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'morgan'</span><span class="schwarz">;</span></samp></span><br/><span class="rot">import</span><span class="schwarz"> { router </span><span class="rot">as</span><span class="schwarz"> movieRouter } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./movie/index.js'</span><span class="schwarz">;</span><br/> <br/><span class="rot">const</span><span class="schwarz"> app </span><span class="dunkelblau">=</span><span class="schwarz"> express();</span><br/> <br/><span class="bold"><samp class="listingcharacter listingcharacter">app.use(morgan(<span class="hellblau">'common'</span><span class="schwarz">, { immediate: </span><span class="rot">true</span><span class="schwarz"> }));</span><br/> </samp></span><br/>app.use(<span class="hellblau">'/movie'</span><span class="schwarz">, movieRouter);</span><br/> <br/>app.get(<span class="hellblau">'/'</span><span class="schwarz">, (request, response) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> response.redirect(</span><span class="hellblau">'/movie'</span><span class="schwarz">));</span><br/> <br/>app.listen(8080, () <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>  <span class="magenta">console</span><span class="schwarz">.log(</span><span class="hellblau">'Server is listening to http://localhost:8080'</span><span class="schwarz">);</span><br/>});  <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 6.15</b>    
            Morgan Middleware</p>
            <p class="standard">Concerning the format, you can choose from a number of predefined formats such as <samp class="listingcharacter listingcharacter">combined</samp>, <samp class="listingcharacter listingcharacter">short</samp>, or <samp class="listingcharacter listingcharacter">dev</samp>. The <samp class="listingcharacter listingcharacter">common</samp> format used in the example is similar to the format <a id="p196"/>used by the Apache web server in the access log. As an alternative to the predefined formats, you can also define a format yourself. For example, if you want to record only the date, HTTP method, URL, and status code, the corresponding format looks like this: <samp class="listingcharacter listingcharacter">':date :method :url :status'</samp>. The third variant for defining a format consists of using a function instead of a character string. Irrespective of the variant you decide on, you must pass it to the <samp class="listingcharacter listingcharacter">morgan</samp> function as the first argument. The <samp class="listingcharacter listingcharacter">option</samp> object, which you pass as the second argument to Morgan, allows you to manipulate the behavior of the logger. With the <samp class="listingcharacter listingcharacter">immediate</samp> key used in the example, you specify whether the log entry should be written immediately or only when the response is sent to the client. The <samp class="listingcharacter listingcharacter">stream</samp> property allows you to specify a writable stream to which the log entries are written. This allows you to write the log entries to not only the console but also a file<a class="indexanchor" id="i06_61"/>.</p>
            <p class="standard">In <span class="crossreference "><a href="06_006.html#l6.16">Listing 6.16</a></span>, you can see how to use the <samp class="listingcharacter listingcharacter">createWriteStream</samp> function from the <samp class="listingcharacter listingcharacter">fs</samp> module to open a data stream<a class="indexanchor" id="i06_62"/> that writes to the <span class="italic">access.log</span> file and pass it to Morgan using the <samp class="listingcharacter listingcharacter">stream</samp> property of the configuration object. This results in a new entry being written to the file each time it’s accessed. The configuration object of the <samp class="listingcharacter listingcharacter">createWriteStream</samp> function with the <samp class="listingcharacter listingcharacter">flags</samp> property and the <samp class="listingcharacter listingcharacter">a</samp> value ensures that new entries are appended and the existing content isn’t overwritten. Furthermore, the file gets created, if it doesn’t already exist.</p>
            <p class="standard">The <samp class="listingcharacter listingcharacter">skip</samp> property allows you to specify a function that can access the request and response and whose return value determines whether an entry is written to the log or not. If the <samp class="listingcharacter listingcharacter">skip</samp> function returns the <samp class="listingcharacter listingcharacter">false</samp> value, the entry won’t be written.</p>
            <div class="listing " id="l6.16"><pre><span class="rot">import</span><span class="schwarz"> express </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'express'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> morgan </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'morgan'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">import</span><span class="schwarz"> { createWriteStream } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'fs'</span><span class="schwarz">;</span></samp></span><br/><span class="rot">import</span><span class="schwarz"> { router </span><span class="rot">as</span><span class="schwarz"> movieRouter } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./movie/index.js'</span><span class="schwarz">;</span><br/> <br/><span class="rot">const</span><span class="schwarz"> app </span><span class="dunkelblau">=</span><span class="schwarz"> express();</span><br/> <br/><span class="bold"><samp class="listingcharacter listingcharacter"><span class="rot">const</span><span class="schwarz"> accessLogStream </span><span class="dunkelblau">=</span><span class="schwarz"> createWriteStream(</span><span class="hellblau">'access.log'</span><span class="schwarz">, { flags: </span><span class="hellblau">'a'</span><span class="schwarz"> });</span><br/>app.use(morgan(<span class="hellblau">'common'</span><span class="schwarz">, { </span><br/>  immediate: <span class="rot">true</span><span class="schwarz">, </span><br/>  stream: accessLogStream <br/>}));<br/> </samp></span><br/>app.use(<span class="hellblau">'/movie'</span><span class="schwarz">, movieRouter);</span><br/> <br/>app.get(<span class="hellblau">'/'</span><span class="schwarz">, (request, response) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> response.redirect(</span><span class="hellblau">'/movie'</span><span class="schwarz">));</span><br/> <br/>app.listen(8080, () <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>  <span class="magenta">console</span><span class="schwarz">.log(</span><span class="hellblau">'Server is listening to http://localhost:8080'</span><span class="schwarz">);</span><br/>}); <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 6.16</b>    
            Writing Log Entries to a File (index.js)</p>
        
        
            <h3 class="t3" id="h6.6.3">6.6.3    <a id="p197"/>Delivering Static Content<a class="indexanchor" id="i06_63"/></h3>
            <p class="standard">Web applications that you implement with Express usually not only consist of dynamic content but also require static files. For this reason, HTML, JavaScript, CSS, and image files must be loaded. Although you can use the <samp class="listingcharacter listingcharacter">fs</samp> module to read the contents of these files and send them to the client as a response, this task becomes much easier if you use the <samp class="listingcharacter listingcharacter">static</samp> middleware<a class="indexanchor" id="i06_64"/>. Unlike Morgan, that is a component of Express, so you don’t need to install any additional packages. If you take a look at the movie list in your browser, you won’t be presented with a particularly attractive sight. However, this can be changed with a little bit of CSS. The CSS code shown in <span class="crossreference "><a href="06_006.html#l6.17">Listing 6.17</a></span> makes the table look slightly more appealing.</p>
            <div class="listing " id="l6.17"><pre><span class="gruen">table</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="magenta">border-spacing</span><span class="schwarz">:</span><span class="dunkelblau"> 0</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"><br/></span>th <span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="magenta">background-color</span><span class="schwarz">:</span><span class="dunkelblau"> black</span><span class="schwarz">;</span><span class="schwarz"><br/></span>  <span class="magenta">font-weight</span><span class="schwarz">:</span><span class="dunkelblau"> bold</span><span class="schwarz">;</span><span class="schwarz"><br/></span>  <span class="magenta">color</span><span class="schwarz">:</span><span class="dunkelblau"> lightgrey</span><span class="schwarz">;</span><span class="schwarz"><br/></span>  <span class="magenta">text-align</span><span class="schwarz">:</span><span class="dunkelblau"> left</span><span class="schwarz">;</span><span class="schwarz"><br/></span>  <span class="magenta">padding</span><span class="schwarz">:</span><span class="dunkelblau"> 5px</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"><br/></span>td <span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="magenta">border-top</span><span class="schwarz">:</span><span class="dunkelblau"> 1px solid darkgrey</span><span class="schwarz">;</span><span class="schwarz"><br/></span>  <span class="magenta">padding</span><span class="schwarz">:</span><span class="dunkelblau"> 5px</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"><br/></span>tbody <span class="magenta">tr</span><span class="schwarz">:</span><span class="dunkelblau">hover </span><span class="schwarz">{</span><span class="dunkelblau"><br/></span>  <span class="magenta">background-color</span><span class="schwarz">:</span><span class="dunkelblau"> lightgrey</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"> </span></pre></div>
            <p class="caption "><b>Listing 6.17</b>    
            Styling the List (public/style.css)</p>
            <p class="standard">To apply the styling to the movie list, you must adjust your application in two places. First, you need to make sure that the server delivers the CSS file and that the browser actually loads it. The delivery is carried out via the already mentioned <samp class="listingcharacter listingcharacter">static</samp> middleware. As was the case with the logger or the router, you include the static middleware via the <samp class="listingcharacter listingcharacter">use</samp> method of the <samp class="listingcharacter listingcharacter">app</samp> object. <span class="crossreference "><a href="06_006.html#l6.18">Listing 6.18</a></span> shows the customized initial file of your application.</p>
            <div class="listing " id="l6.18"><pre><span class="rot">import</span><span class="schwarz"> express </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'express'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> morgan </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'morgan'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="bold"><span class="schwarz"/><samp class="listingcharacter listingcharacter"><span class="rot">import</span><span class="schwarz"> { dirname } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'path'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> { fileURLToPath } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'url'</span><span class="schwarz">;</span></samp></span><br/><span class="rot">import</span><span class="schwarz"> { router </span><span class="rot">as</span><span class="schwarz"> movieRouter } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'./movie/index.js'</span><span class="schwarz">;</span><br/> <br/><span class="rot"><a id="p198"/>const</span><span class="schwarz"> app </span><span class="dunkelblau">=</span><span class="schwarz"> express();</span><br/> <br/><span class="bold"><samp class="listingcharacter listingcharacter">app.use(express.static(<span class="violett">`${dirname(fileURLToPath(import.meta.url))}/public`</span><span class="schwarz">));</span><br/> </samp></span><br/>app.use(morgan(<span class="hellblau">'common'</span><span class="schwarz">, { immediate: </span><span class="rot">true</span><span class="schwarz"> }));</span><br/> <br/>app.use(<span class="hellblau">'/movie'</span><span class="schwarz">, movieRouter);</span><br/> <br/>app.get(<span class="hellblau">'/'</span><span class="schwarz">, (request, response) </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> response.redirect(</span><span class="hellblau">'/movie'</span><span class="schwarz">));</span><br/> <br/>app.listen(8080, () <span class="dunkelblau">=&gt;</span><span class="schwarz"> {</span><br/>  <span class="magenta">console</span><span class="schwarz">.log(</span><span class="hellblau">'Server is listening to http://localhost:8080'</span><span class="schwarz">);</span><br/>}); <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 6.18</b>    
            Integrating the “static” Middleware (index.js)</p>
            <p class="standard">When you call the <samp class="listingcharacter listingcharacter">static</samp> middleware, you pass the name of the directory where the static content resides. For the movie list, this is the <span class="italic">public</span> directory in the root of your application. In the next step, you can now reference the CSS file via a <samp class="listingcharacter listingcharacter">link</samp> tag in the HTML code of the list, as shown in <span class="crossreference "><a href="06_006.html#l6.19">Listing 6.19</a></span>.</p>
            <div class="listing " id="l6.19"><pre><span class="rot">export</span><span class="schwarz"> </span><span class="rot">function</span><span class="schwarz"> </span><span class="schwarz">render(</span><span class="schwarz">movies</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="rot">return</span><span class="schwarz"> </span><span class="violett">`</span><br/>&lt;!DOCTYPE html&gt;<br/>&lt;html lang=<span class="hellblau">"en"</span><span class="violett">&gt;</span><br/>&lt;head&gt;<br/>  &lt;meta charset=<span class="hellblau">"UTF-8"</span><span class="violett">&gt;</span><br/>  &lt;title&gt;Movie list&lt;/title&gt;<br/>  <span class="bold">&lt;link rel=<span class="hellblau">"stylesheet"</span><span class="violett"> href=</span><span class="hellblau">"style.css"</span><span class="violett"> /&gt;</span></span><br/>&lt;/head&gt;<br/>&lt;body&gt;<br/>  &lt;table&gt;...&lt;/table&gt;<br/>&lt;/body&gt;<br/>&lt;/html&gt;<br/>  `<span class="schwarz">;</span><br/>} <span class="schwarz"/></pre></div>
            <p class="caption "><b>Listing 6.19</b>    
            Embedding the CSS File into the HTML Code (movie/view.js)</p>
            <p class="standard">If you modify the list view source code according to <span class="crossreference "><a href="06_006.html#l6.19">Listing 6.19</a></span> and restart your application, you’ll get a view similar to the one shown in <span class="crossreference "><a href="06_006.html#f6.8">Figure 6.8</a></span>.</p>
            <div class="imagebox figure-type"><a href="img-f6.8.html" id="f6.8"><img alt="List View with CSS" id="img-f6.8" src="bilderklein/klein06_008.png"/></a></div>
            <p class="caption "><b>Figure 6.8</b>    
            <a id="p199"/>List View with CSS</p>
        
    </div><p class="signatur"/>
                    </body>
                </html>