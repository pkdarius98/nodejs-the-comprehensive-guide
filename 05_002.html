<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
                    
        <head><meta content="application/xhtml+xml; charset=utf-8" http-equiv="Content-Type"/>
            <meta content="application/xhtml+xml; charset=utf-8" name="content-type"/>
            <meta content="HTTP" name="title"/>
            <meta content="Sebastian Springer" name="author"/>
            <meta content="Rheinwerk Publishing" name="publisher"/>
            <meta content="© 2022 by Rheinwerk Publishing Inc., Boston (MA)" name="copyright"/>
            <meta content="Node.js - The Comprehensive Guide - HTTP" name="description"/>
            <meta content="en" name="language"/>
            <title>HTTP</title>
            <link href="common/main.css" rel="stylesheet" type="text/css"/>
<meta content="urn:uuid:e0000000-0000-0000-0000-000029756394" name="Adept.expected.resource"/>
        </head>
    


                    <body class="office_us type_kapitel">
                        <div id="main">
        <h2 class="t2" id="h5.2">5.2    Node.js as HTTP Client<a class="indexanchor" id="i05_76"/></h2>
        <p class="standard">The client allows you to formulate requests to servers and have all aspects of the request under your control, from the header to the body. In the following sections, Node.js plays the role of the client and interacts with the address book you created earlier. In this context, there are different options available to you to formulate a request. You can either use the <samp class="listingcharacter listingcharacter">http</samp> module of Node.js itself or install an additional module.</p>
        
            <h3 class="t3" id="h5.2.1">5.2.1    Requests with the http Module</h3>
            <p class="standard">The <samp class="listingcharacter listingcharacter">request</samp><a class="indexanchor" id="i05_77"/> function of the <samp class="listingcharacter listingcharacter">http</samp> module allows you to send requests to any web server. The advantage of this method is that you don’t need to install any additional packages, whereas its disadvantage is a somewhat inconvenient interface. To generate a request, you must pass a configuration object and a callback function to the <samp class="listingcharacter listingcharacter">request</samp> function, which is executed as soon as the response is received. For a simple request like the one that’s sent to the address book, you can use a <samp class="listingcharacter listingcharacter">URL</samp> object instead of an option object. In <span class="crossreference "><a href="05_002.html#l5.24">Listing 5.24</a></span>, you can see the source code for this.</p>
            <div class="listing " id="l5.24"><pre><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> request </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'http'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="rot">const</span><span class="schwarz"> options </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">URL(</span><span class="hellblau">'http://localhost:8080/'</span><span class="schwarz">);</span><span class="schwarz"><br/></span> <br/><span class="schwarz">request(</span><span class="schwarz">options</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">response</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="rot">let</span><span class="schwarz"> body </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="hellblau">''</span><span class="schwarz">;</span><span class="schwarz"><br/></span>  response<span class="schwarz">.on(</span><span class="hellblau">'data'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">chunk</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">body </span><span class="dunkelblau">+=</span><span class="schwarz"> chunk</span><span class="schwarz">));</span><span class="schwarz"><br/></span><a id="p165"/>  response<span class="schwarz">.on(</span><span class="hellblau">'end'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">()</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="magenta">console</span><span class="schwarz">.log(</span><span class="schwarz">body</span><span class="schwarz">);</span><span class="schwarz"><br/></span>  <span class="schwarz">});</span><span class="schwarz"><br/></span><span class="schwarz">}).end();</span><span class="schwarz"> </span></pre></div>
            <p class="caption "><b>Listing 5.24</b>    
            Querying the Address Book Using the HTTP Request (index.js)</p>
            <p class="standard">The <samp class="listingcharacter listingcharacter">URL</samp> object contains all the important information for the request, such as the server, port, and path. For all other information, such as the HTTP method<a class="indexanchor" id="i05_78"/>, use the default values<a class="indexanchor" id="i05_79"/>, in this case, <samp class="listingcharacter listingcharacter">GET</samp>. Handling the server’s response is similar to the HTTP server implementation. The response is considered as a data stream consisting of one or more parts. You consume this by means of the <samp class="listingcharacter listingcharacter">data</samp> event. When the response is over, the <samp class="listingcharacter listingcharacter">end</samp> event gets triggered. The actual processing of the response then takes place at this point.</p>
            <p class="standard">A prerequisite for this example to work is that the web server you developed earlier has been launched. If you run the example shown in <span class="crossreference "><a href="05_002.html#l5.24">Listing 5.24</a></span>, you’ll get the HTML code of the server’s response on the command line.</p>
            <p class="standard">Instead of the <samp class="listingcharacter listingcharacter">request</samp> function, you can also use the <samp class="listingcharacter listingcharacter">get</samp> function of the <samp class="listingcharacter listingcharacter">http</samp> module. That function is similar to the <samp class="listingcharacter listingcharacter">request</samp> function, but it provides a better description of your intention.</p>
        
        
            <h3 class="t3" id="h5.2.2">5.2.2    The request Package<a class="indexanchor" id="i05_80"/></h3>
            <p class="standard">A very widely used alternative to the <samp class="listingcharacter listingcharacter">request</samp> function of Node.js is the <samp class="listingcharacter listingcharacter">request</samp> package. This is an open-source project managed on GitHub and distributed via npm. It’s installed via the <samp class="listingcharacter listingcharacter">npm install request</samp> command.</p>
            
                <h4 class="t4" id="h5.2.2.1">Read Accesses<a class="indexanchor" id="i05_81"/></h4>
                <p class="standard">After the installation, you can send read requests to a web server by using just a few lines. <span class="crossreference "><a href="05_002.html#l5.25">Listing 5.25</a></span> shows the request of the address book example.</p>
                <div class="listing " id="l5.25"><pre><span class="rot">import</span><span class="schwarz"> request </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'request'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="schwarz">request(</span><span class="hellblau">'http://localhost:8080/'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">err</span><span class="schwarz">,</span><span class="schwarz"> response</span><span class="schwarz">,</span><span class="schwarz"> body</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="magenta">console</span><span class="schwarz">.log(</span><span class="schwarz">body</span><span class="schwarz">);</span><span class="schwarz"><br/></span><span class="schwarz">});</span><span class="schwarz"> </span></pre></div>
                <p class="caption "><b>Listing 5.25</b>    
            Read Request Using the “request” Package (index.js)</p>
                <p class="standard">The prerequisite for this example to work is that the previously implemented web server has been launched. As shown earlier in <span class="crossreference "><a href="05_002.html#l5.24">Listing 5.24</a></span>, the server’s response will be output to the command line.</p>
                <p class="standard"><a id="p166"/>As you can see, specifying the destination URL as a string is sufficient in this case. The handling of the response is also made much easier because it’s directly available as a variable.</p>
            
            
                <h4 class="t4" id="h5.2.2.2">Write Accesses<a class="indexanchor" id="i05_82"/></h4>
                <p class="standard">In addition to read accesses, you can also use the <samp class="listingcharacter listingcharacter">request</samp> package to create data records in the address book. The source code shown in <span class="crossreference "><a href="05_002.html#l5.26">Listing 5.26</a></span> creates a new record, including the associated file upload<a class="indexanchor" id="i05_83"/>.</p>
                <div class="listing " id="l5.26"><pre><span class="rot">import</span><span class="schwarz"> request </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'request'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> createReadStream </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'fs'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="rot">const</span><span class="schwarz"> formData </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  firstname<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'Jason'</span><span class="schwarz">,</span><span class="schwarz"><br/></span>  lastname<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'Bourne'</span><span class="schwarz">,</span><span class="schwarz"><br/></span>  street<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'1000 Colonial Farm Rd'</span><span class="schwarz">,</span><span class="schwarz"><br/></span>  city<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'Langley'</span><span class="schwarz">,</span><span class="schwarz"><br/></span>  country<span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'USA'</span><span class="schwarz">,</span><span class="schwarz"><br/></span>  upload<span class="schwarz">:</span><span class="schwarz"> </span><span class="schwarz">createReadStream(</span><span class="hellblau">'./bild.png'</span><span class="schwarz">),</span><span class="schwarz"><br/></span><span class="schwarz">};</span><span class="schwarz"><br/></span> <br/>request<span class="schwarz">.post(</span><span class="schwarz"><br/></span>  <span class="schwarz">{</span><span class="schwarz"> url</span><span class="schwarz">:</span><span class="schwarz"> </span><span class="hellblau">'http://localhost:8080/save'</span><span class="schwarz">,</span><span class="schwarz"> formData </span><span class="schwarz">},</span><span class="schwarz"><br/></span>  <span class="schwarz">(</span><span class="schwarz">err</span><span class="schwarz">,</span><span class="schwarz"> response</span><span class="schwarz">,</span><span class="schwarz"> body</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="rot">if</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">err</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>      <span class="magenta">console</span><span class="schwarz">.error(</span><span class="schwarz">err</span><span class="schwarz">);</span><span class="schwarz"><br/></span>    <span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">else</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>      <span class="magenta">console</span><span class="schwarz">.log(</span><span class="schwarz">body</span><span class="schwarz">);</span><span class="schwarz"><br/></span>    <span class="schwarz">}</span><span class="schwarz"><br/></span>  <span class="schwarz">},</span><span class="schwarz"><br/></span><span class="schwarz">);</span><span class="schwarz"> </span></pre></div>
                <p class="caption "><b>Listing 5.26</b>    
            Creating New Entries on the Server (index.js)</p>
                <p class="standard">The <samp class="listingcharacter listingcharacter">post</samp> function of the <samp class="listingcharacter listingcharacter">request</samp> package generates a <samp class="listingcharacter listingcharacter">POST</samp> request to the server. To this request, you must pass an object with the URL to which the information should be sent and the form data. For the key-value combination of <samp class="listingcharacter listingcharacter">formData: formData</samp>, you can use the standardized JavaScript shorthand notation <samp class="listingcharacter listingcharacter">formData</samp>. You should specify the information to be transmitted as an object. For the file upload, you must pass a <samp class="listingcharacter listingcharacter">readableStream</samp> as the value, which you can create via the <samp class="listingcharacter listingcharacter">createReadStream</samp> function from the <samp class="listingcharacter listingcharacter">fs</samp> module. In the callback function, which is executed after the response arrives, you have access to an error object, the representation of the response, and its body.</p>
            
        
        
            <h3 class="t3" id="h5.2.3">5.2.3    <a id="p167"/>HTML Parser<a class="indexanchor" id="i05_84"/></h3>
            <p class="standard">In the previous examples, you retrieved HTML pages from the server and displayed their contents on the console. However, you normally use Node.js HTTP clients to read information from a page and process it further. This means that you locate and extract specific data within the HTML structure<a class="indexanchor" id="i05_85"/>. This section introduces you to the <samp class="listingcharacter listingcharacter">cheerio</samp> package, a tool that allows you to work with HTML structures in a similar way to the browser. In addition to this package, there are many other HTML parsers available for Node.js such as the <samp class="listingcharacter listingcharacter">htmlparser2</samp> package or <samp class="listingcharacter listingcharacter">jsdom</samp>.</p>
            <p class="standard">You can install <samp class="listingcharacter listingcharacter">cheerio</samp><a class="indexanchor" id="i05_86"/> using the <samp class="listingcharacter listingcharacter">npm install cheerio</samp> command. For the following example, you also need the <samp class="listingcharacter listingcharacter">request</samp> package. In <span class="crossreference "><a href="05_002.html#l5.27">Listing 5.27</a></span>, a read request is sent to the server, as in the previous example shown in <span class="crossreference "><a href="05_002.html#l5.25">Listing 5.25</a></span>. For this purpose, you should make sure that the server is up and running.</p>
            <div class="listing " id="l5.27"><pre><span class="rot">import</span><span class="schwarz"> request </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'request'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> cheerio </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'cheerio'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="schwarz">request(</span><span class="hellblau">'http://localhost:8080/'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">err</span><span class="schwarz">,</span><span class="schwarz"> response</span><span class="schwarz">,</span><span class="schwarz"> body</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="rot">const</span><span class="schwarz"> addresses </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="schwarz">[];</span><span class="schwarz"><br/></span> <br/>  <span class="rot">const</span><span class="schwarz"> $ </span><span class="dunkelblau">=</span><span class="schwarz"> cheerio</span><span class="schwarz">.load(</span><span class="schwarz">body</span><span class="schwarz">);</span><span class="schwarz"><br/></span>  <span class="rot">const</span><span class="schwarz"> tr </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="orange">$</span><span class="schwarz">(</span><span class="hellblau">'tr'</span><span class="schwarz">);</span><span class="schwarz"><br/></span>  tr<span class="schwarz">.each((</span><span class="schwarz">index</span><span class="schwarz">,</span><span class="schwarz"> element</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="rot">if</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">index </span><span class="dunkelblau">===</span><span class="schwarz"> </span><span class="schwarz">0)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>      <span class="rot">return</span><span class="schwarz">;</span><span class="schwarz"><br/></span>    <span class="schwarz">}</span><span class="schwarz"><br/></span>    addresses<span class="schwarz">.push({</span><span class="schwarz"><br/></span>      id<span class="schwarz">:</span><span class="schwarz"> element</span><span class="schwarz">.</span><span class="schwarz">children</span><span class="schwarz">[3].</span><span class="schwarz">children</span><span class="schwarz">[0].</span><span class="schwarz">data</span><span class="schwarz">,</span><span class="schwarz"><br/></span>      firstname<span class="schwarz">:</span><span class="schwarz"> element</span><span class="schwarz">.</span><span class="schwarz">children</span><span class="schwarz">[5].</span><span class="schwarz">children</span><span class="schwarz">[0].</span><span class="schwarz">data</span><span class="schwarz">,</span><span class="schwarz"><br/></span>      lastname<span class="schwarz">:</span><span class="schwarz"> element</span><span class="schwarz">.</span><span class="schwarz">children</span><span class="schwarz">[7].</span><span class="schwarz">children</span><span class="schwarz">[0].</span><span class="schwarz">data</span><span class="schwarz">,</span><span class="schwarz"><br/></span>    <span class="schwarz">});</span><span class="schwarz"><br/></span>  <span class="schwarz">});</span><span class="schwarz"><br/></span> <br/>  <span class="magenta">console</span><span class="schwarz">.log(</span><span class="schwarz">addresses</span><span class="schwarz">);</span><span class="schwarz"><br/></span><span class="schwarz">});</span><span class="schwarz"> </span></pre></div>
            <p class="caption "><b>Listing 5.27</b>    
            Using the HTML Parser (index.js)</p>
            <p class="standard">Once the server’s data is available to you, you must use the <samp class="listingcharacter listingcharacter">load</samp> method of <samp class="listingcharacter listingcharacter">cheerio</samp> to load the HTML string. After that you can use selectors<a class="indexanchor" id="i05_87"/> to select and use the individual Document Object Model (DOM) nodes<a class="indexanchor" id="i05_88"/>. The address data is available in a table structure. This means you need access to the individual table rows, which you get via the <samp class="listingcharacter listingcharacter">tr</samp> selector. In the resulting object, the <samp class="listingcharacter listingcharacter">each</samp> method is defined, which you can use to iterate across all found elements. In the callback function, you have access to the index as well as the representation of the object. You can use the index to ignore the first line <a id="p168"/>containing the headings. The line contains alternating <samp class="listingcharacter listingcharacter">td</samp> nodes and space characters caused by the indentions in the code. The <samp class="listingcharacter listingcharacter">td</samp> nodes in turn contain the text nodes that contain the actual information. You must extract these into an object and insert this object into an array, which you finally output to the console. You can see the output of the script in <span class="crossreference "><a href="05_002.html#l5.28">Listing 5.28</a></span>.</p>
            <div class="listing " id="l5.28"><pre>$ <span class="bold"><samp class="listingcharacter listingcharacter">npm start<br/> </samp></span><br/>&gt; node-book@1.0.0 start<br/>&gt; node index.js<br/> <br/>[<br/>  ID '1', firstname: 'James', lastname: 'Bond' },<br/>  ID '2', firstname: 'Sherlock', lastname: 'Holmes' },<br/>  ID '3', firstname: 'Peter', lastname: 'Pan' },<br/>  ID '4', firstname: 'Jason', lastname: 'Bourne' }<br/>] </pre></div>
            <p class="caption "><b>Listing 5.28</b>    
            Output of the “cheerio” Script (index.js)</p>
        
    </div><p class="signatur"/>
                    </body>
                </html>