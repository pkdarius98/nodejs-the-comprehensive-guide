<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
                    
        <head><meta content="application/xhtml+xml; charset=utf-8" http-equiv="Content-Type"/>
            <meta content="application/xhtml+xml; charset=utf-8" name="content-type"/>
            <meta content="Working with Files" name="title"/>
            <meta content="Sebastian Springer" name="author"/>
            <meta content="Rheinwerk Publishing" name="publisher"/>
            <meta content="© 2022 by Rheinwerk Publishing Inc., Boston (MA)" name="copyright"/>
            <meta content="Node.js - The Comprehensive Guide - Working with Files" name="description"/>
            <meta content="en" name="language"/>
            <title>Working with Files</title>
            <link href="common/main.css" rel="stylesheet" type="text/css"/>
<meta content="urn:uuid:e0000000-0000-0000-0000-000029756394" name="Adept.expected.resource"/>
        </head>
    


                    <body class="office_us type_kapitel">
                        <div id="main">
        <h2 class="t2" id="h19.5">19.5    Writing to Files<a class="indexanchor" id="i19_31"/></h2>
        <p class="standard">Writing to files is similar to reading them. Here, too, the <samp class="listingcharacter listingcharacter">open</samp> and <samp class="listingcharacter listingcharacter">close</samp> methods are used to prepare access and to close the file handle<a class="indexanchor" id="i19_32"/> after use, respectively. The <samp class="listingcharacter listingcharacter">fs</samp> module provides several methods of write access to files. In the first step, you’ll see the use of the <samp class="listingcharacter listingcharacter">write</samp> method.</p>
        <p class="standard">You’ll also learn how you can write to a file based on a small example. For this purpose, you now need to create a logger<a class="indexanchor" id="i19_33"/>. This is a small application or a module for larger applications that helps you write information into a file. Loggers are used in applications whenever it’s necessary to record events during operation or development for later <a id="p583"/>analysis. For example, when errors occur, you can have the corresponding message written to the log file.</p>
        <p class="standard">The most important requirement for the logger is that it should be as lightweight as possible, so that it doesn’t unnecessarily make the source code of the application unreadable. In addition, the logger is supposed to provide the option to write entries with different priorities, for example, error, warning, or information. An application is usually used in different stages. For example, you write more messages during the development phase than is usually the case in production operation. To meet this requirement, it’s necessary to design the logger in such a way that you can configure what types of messages are to be logged.</p>
        <p class="standard"><span class="crossreference "><a href="19_005.html#l19.11">Listing 19.11</a></span> contains the source code of the logger. In the following sections, you’ll receive further explanations on the individual steps of the implementation.</p>
        <div class="listing " id="l19.11"><pre><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> open</span><span class="schwarz">,</span><span class="schwarz"> write</span><span class="schwarz">,</span><span class="schwarz"> close </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'fs'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> EventEmitter </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'events'</span><span class="schwarz">;</span><span class="schwarz"><br/></span><span class="rot">import</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"> format </span><span class="schwarz">}</span><span class="schwarz"> </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'util'</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/><span class="rot">class EventLogger</span><span class="schwarz"> </span><span class="rot">extends EventEmitter</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>  <span class="schwarz">constructor(</span><span class="schwarz">file</span><span class="schwarz">,</span><span class="schwarz"> levels</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="schwarz">super();</span><span class="schwarz"><br/></span>    <span class="rot">this</span><span class="schwarz">.</span><span class="schwarz">file </span><span class="dunkelblau">=</span><span class="schwarz"> file</span><span class="schwarz">;</span><span class="schwarz"><br/></span>    <span class="rot">this</span><span class="schwarz">.</span><span class="schwarz">levels </span><span class="dunkelblau">=</span><span class="schwarz"> levels</span><span class="schwarz">;</span><span class="schwarz"><br/></span> <br/>    <span class="rot">this</span><span class="schwarz">.on(</span><span class="hellblau">'error'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="rot">this</span><span class="schwarz">.</span><span class="schwarz">log</span><span class="schwarz">.bind(</span><span class="rot">this</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="hellblau">'ERR'</span><span class="schwarz">));</span><span class="schwarz"><br/></span>    <span class="rot">this</span><span class="schwarz">.on(</span><span class="hellblau">'warning'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="rot">this</span><span class="schwarz">.</span><span class="schwarz">log</span><span class="schwarz">.bind(</span><span class="rot">this</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="hellblau">'WARN'</span><span class="schwarz">));</span><span class="schwarz"><br/></span>    <span class="rot">this</span><span class="schwarz">.on(</span><span class="hellblau">'info'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="rot">this</span><span class="schwarz">.</span><span class="schwarz">log</span><span class="schwarz">.bind(</span><span class="rot">this</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="hellblau">'INFO'</span><span class="schwarz">));</span><span class="schwarz"><br/></span>  <span class="schwarz">}</span><span class="schwarz"><br/></span> <br/>  <span class="schwarz">log(</span><span class="schwarz">level</span><span class="schwarz">,</span><span class="schwarz"> data</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>    <span class="rot">if</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="rot">this</span><span class="schwarz">.</span><span class="schwarz">levels</span><span class="schwarz">.indexOf(</span><span class="schwarz">level</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">&gt;</span><span class="schwarz"> </span><span class="dunkelblau">-</span><span class="schwarz">1)</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>      <span class="schwarz">open(</span><span class="rot">this</span><span class="schwarz">.</span><span class="schwarz">file</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="hellblau">'a'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">(</span><span class="schwarz">err</span><span class="schwarz">,</span><span class="schwarz"> handle</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>        <span class="rot">const</span><span class="schwarz"> buffer </span><span class="dunkelblau">=</span><span class="schwarz"> Buffer</span><span class="schwarz">.from(</span><span class="schwarz"><br/></span>          <span class="schwarz">format(</span><span class="hellblau">'%s (%s) %s\n'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">Date(),</span><span class="schwarz"> level</span><span class="schwarz">,</span><span class="schwarz"> data</span><span class="schwarz">),</span><span class="schwarz"><br/></span>        <span class="schwarz">);</span><span class="schwarz"><br/></span>        <span class="schwarz">write(</span><span class="schwarz"><br/></span>          handle<span class="schwarz">,</span><span class="schwarz"><br/></span>          buffer<span class="schwarz">,</span><span class="schwarz"><br/></span>          <span class="schwarz">0,</span><span class="schwarz"><br/></span>          buffer<span class="schwarz">.</span><span class="schwarz">length</span><span class="schwarz">,</span><span class="schwarz"><br/></span>          <span class="rot">null</span><span class="schwarz">,</span><span class="schwarz"><br/></span>          <span class="schwarz">(</span><span class="schwarz">err</span><span class="schwarz">,</span><span class="schwarz"> written</span><span class="schwarz">,</span><span class="schwarz"> buffer</span><span class="schwarz">)</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{</span><span class="schwarz"><br/></span>            <span class="schwarz">close(</span><span class="schwarz">handle</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">()</span><span class="schwarz"> </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> </span><span class="schwarz">{});</span><span class="schwarz"><br/></span>          <span class="schwarz">},</span><span class="schwarz"><br/></span><a id="p584"/>        <span class="schwarz">);</span><span class="schwarz"><br/></span>      <span class="schwarz">});</span><span class="schwarz"><br/></span>    <span class="schwarz">}</span><span class="schwarz"><br/></span>  <span class="schwarz">}</span><span class="schwarz"><br/></span><span class="schwarz">}</span><span class="schwarz"><br/></span> <br/><span class="rot">const</span><span class="schwarz"> logger </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">EventLogger(</span><span class="hellblau">'error.log'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="schwarz">[</span><span class="hellblau">'ERR'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="hellblau">'WARN'</span><span class="schwarz">]);</span><span class="schwarz"><br/></span> <br/>logger<span class="schwarz">.emit(</span><span class="hellblau">'error'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="hellblau">'Something happened'</span><span class="schwarz">);</span><span class="schwarz"><br/></span>logger<span class="schwarz">.emit(</span><span class="hellblau">'warning'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="hellblau">'Something else happened'</span><span class="schwarz">);</span><span class="schwarz"><br/></span>logger<span class="schwarz">.emit(</span><span class="hellblau">'info'</span><span class="schwarz">,</span><span class="schwarz"> </span><span class="hellblau">'Not relevant'</span><span class="schwarz">);</span><span class="schwarz"> </span></pre></div>
        <p class="caption "><b>Listing 19.11</b>    
            Writing Files Using “EventLogger”</p>
        <p class="standard">To implement the logger, you need the <samp class="listingcharacter listingcharacter">events</samp> and <samp class="listingcharacter listingcharacter">util</samp> modules in addition to the <samp class="listingcharacter listingcharacter">fs</samp> module.</p>
        <p class="standard">First, you define the <samp class="listingcharacter listingcharacter">EventLogger</samp> class and derive it from the <samp class="listingcharacter listingcharacter">EventEmitter</samp><a class="indexanchor" id="i19_34"/> of Node.js. The constructor receives two arguments: the file to write to and the levels to log as an array. Before you can use <samp class="listingcharacter listingcharacter">this</samp> in the constructor, you must call the constructor of the parent class via the <samp class="listingcharacter listingcharacter">super</samp> keyword. Then you register callback functions for the different error levels<a class="indexanchor" id="i19_35"/>. Note that, at this point, you must use the <samp class="listingcharacter listingcharacter">bind</samp> method of the function object so that the method is executed in the correct context. If you only pass the reference to the method, you’ll lose the <samp class="listingcharacter listingcharacter">this</samp> reference within the method and no longer have a reference to the file name, for example. The <samp class="listingcharacter listingcharacter">bind</samp> method binds a function to a specific object—in this case, the instance of <samp class="listingcharacter listingcharacter">EventLogger</samp>—ensuring that <samp class="listingcharacter listingcharacter">this</samp> points to the correct object.</p>
        <p class="standard">The <samp class="listingcharacter listingcharacter">log</samp> method represents the core of the logger. It makes sure that the correct messages are written to the file. For the logger to meet the requirements, you should check in the first step, whether the desired message should be recorded at all, as shown in the example. After that, a combination of <samp class="listingcharacter listingcharacter">open</samp>, <samp class="listingcharacter listingcharacter">write</samp>, and <samp class="listingcharacter listingcharacter">close</samp> is used.</p>
        <p class="standard">The <samp class="listingcharacter listingcharacter">open</samp> method needs the access flag<a class="indexanchor" id="i19_36"/> <samp class="listingcharacter listingcharacter">a</samp> to be able to write to the file. Within the callback function, you then create the string that will eventually be captured in the log. The format should look like this: the date and time, followed by the type of message, and finally the actual message. Because the <samp class="listingcharacter listingcharacter">write</samp> method only writes the string to the file, and this operation isn’t carried out on a line-by-line basis, you should append the escape sequence <samp class="listingcharacter listingcharacter">\n</samp> for inserting line breaks.</p>
        <p class="standard">The formatted character string then gets embedded in a <samp class="listingcharacter listingcharacter">buffer</samp> object<a class="indexanchor" id="i19_37"/>, which you pass as the second argument to the <samp class="listingcharacter listingcharacter">write</samp> method. The first argument is the file handle from the <samp class="listingcharacter listingcharacter">open</samp> method. The next two arguments of the <samp class="listingcharacter listingcharacter">write</samp> method are used to select the correct section from the <samp class="listingcharacter listingcharacter">buffer</samp> object to write. In your case, the offset is <samp class="listingcharacter listingcharacter">0</samp>, and the length of the string to be written is the entire length of the <samp class="listingcharacter listingcharacter">buffer</samp> object. Finally, the penultimate argument is the position within the file to write to. If you choose the value <samp class="listingcharacter listingcharacter"><a id="p585"/>null</samp>, as shown in the example in <span class="crossreference "><a href="19_005.html#l19.11">Listing 19.11</a></span>, this means you want to write to the current position, that is, to the end of the file. Finally, the last argument is a callback function. You should use this argument to close the file handle via the <samp class="listingcharacter listingcharacter">close</samp> method<a class="indexanchor" id="i19_38"/>.</p>
        <p class="standard">With this source code, the logger is now fully functional and can be used. You can see how this works in the last lines of the example in <span class="crossreference "><a href="19_005.html#l19.11">Listing 19.11</a></span>. All you have to do is instantiate the logger and then use the <samp class="listingcharacter listingcharacter">emit</samp> method inherited from the <samp class="listingcharacter listingcharacter">EventEmitter</samp> to trigger the respective events. You can now export the <samp class="listingcharacter listingcharacter">EventLogger</samp> via <samp class="listingcharacter listingcharacter">export</samp> and include and use it in your application via <samp class="listingcharacter listingcharacter">import</samp>.</p>
        <p class="standard">As is the case with the read access, there are also other methods you can use for writing to files. The <samp class="listingcharacter listingcharacter">writeFile</samp><a class="indexanchor" id="i19_39"/> and <samp class="listingcharacter listingcharacter">appendFile</samp> methods are particularly interesting in this context. In terms of functionality, both methods are similar, except that <samp class="listingcharacter listingcharacter">writeFile</samp> overwrites the file in its entirety, whereas <samp class="listingcharacter listingcharacter">appendFile</samp> merely appends the data to the already existing file. Internally, both methods represent an encapsulation of the three method calls <samp class="listingcharacter listingcharacter">open</samp>, <samp class="listingcharacter listingcharacter">write</samp>, and <samp class="listingcharacter listingcharacter">close</samp> and, for this reason, serve rather to simplify your application code. In <samp class="listingcharacter listingcharacter">EventLogger</samp>, you should use the <samp class="listingcharacter listingcharacter">appendFile</samp><a class="indexanchor" id="i19_40"/> method because you want to append data to the log file continuously and not overwrite and lose information. The adjustments you need to make to the <samp class="listingcharacter listingcharacter">EventLogger</samp> source code in this respect are limited to the <samp class="listingcharacter listingcharacter">log</samp> method. <span class="crossreference "><a href="19_005.html#l19.12">Listing 19.12</a></span> shows the adjustments you need to make.</p>
        <div class="listing " id="l19.12"><pre><span class="bold"><span class="rot">import</span><span class="schwarz"> { appendFile } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'fs'</span><span class="schwarz">;</span></span><br/><span class="rot">import</span><span class="schwarz"> EventEmitter </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'events'</span><span class="schwarz">;</span><br/><span class="rot">import</span><span class="schwarz"> { format } </span><span class="rot">from</span><span class="schwarz"> </span><span class="hellblau">'util'</span><span class="schwarz">;</span><br/> <br/><span class="rot">class EventLogger</span><span class="schwarz"> </span><span class="rot">extends EventEmitter</span><span class="schwarz"> {</span><br/>  constructor(file, levels) {<br/>    super();<br/>    <span class="rot">this</span><span class="schwarz">.file </span><span class="dunkelblau">=</span><span class="schwarz"> file;</span><br/>    <span class="rot">this</span><span class="schwarz">.levels </span><span class="dunkelblau">=</span><span class="schwarz"> levels;</span><br/> <br/>    <span class="rot">this</span><span class="schwarz">.on(</span><span class="hellblau">'error'</span><span class="schwarz">, </span><span class="rot">this</span><span class="schwarz">.log.bind(</span><span class="rot">this</span><span class="schwarz">, </span><span class="hellblau">'ERR'</span><span class="schwarz">));</span><br/>    <span class="rot">this</span><span class="schwarz">.on(</span><span class="hellblau">'warning'</span><span class="schwarz">, </span><span class="rot">this</span><span class="schwarz">.log.bind(</span><span class="rot">this</span><span class="schwarz">, </span><span class="hellblau">'WARN'</span><span class="schwarz">));</span><br/>    <span class="rot">this</span><span class="schwarz">.on(</span><span class="hellblau">'info'</span><span class="schwarz">, </span><span class="rot">this</span><span class="schwarz">.log.bind(</span><span class="rot">this</span><span class="schwarz">, </span><span class="hellblau">'INFO'</span><span class="schwarz">));</span><br/>  }<br/> <br/>  log(level, data) {<br/>    <span class="rot">if</span><span class="schwarz"> (</span><span class="rot">this</span><span class="schwarz">.levels.indexOf(level) </span><span class="dunkelblau">&gt;</span><span class="schwarz"> </span><span class="dunkelblau">-</span><span class="schwarz">1) {</span><br/>      <span class="bold"><span class="rot">const</span><span class="schwarz"> logData </span><span class="dunkelblau">=</span><span class="schwarz"> format(</span><span class="hellblau">'%s (%s) %s\n'</span><span class="schwarz">, </span><span class="rot">new </span><span class="schwarz">Date(), level, data);</span><br/>      appendFile(<span class="rot">this</span><span class="schwarz">.file, logData, () </span><span class="dunkelblau">=&gt;</span><span class="schwarz"> {});</span></span><br/>    }<br/>  }<br/>}<br/> <br/><span class="rot">const</span><span class="schwarz"> logger </span><span class="dunkelblau">=</span><span class="schwarz"> </span><span class="rot">new </span><span class="schwarz">EventLogger(</span><span class="hellblau">'error.log'</span><span class="schwarz">, [</span><span class="hellblau">'ERR'</span><span class="schwarz">, </span><span class="hellblau">'WARN'</span><span class="schwarz">]);</span><br/> <br/><a id="p586"/>logger.emit(<span class="hellblau">'error'</span><span class="schwarz">, </span><span class="hellblau">'Something happened'</span><span class="schwarz">);</span><br/>logger.emit(<span class="hellblau">'warning'</span><span class="schwarz">, </span><span class="hellblau">'Something else happened'</span><span class="schwarz">);</span><br/>logger.emit(<span class="hellblau">'info'</span><span class="schwarz">, </span><span class="hellblau">'Not relevant'</span><span class="schwarz">); </span><span class="schwarz"/></pre></div>
        <p class="caption "><b>Listing 19.12</b>    
            “EventLogger” with “appendFile”</p>
        <p class="standard">As you can see, the required changes aren’t very extensive. You just need to swap out the generation of the log data from the callback function of <samp class="listingcharacter listingcharacter">open</samp> and replace the calls of <samp class="listingcharacter listingcharacter">open</samp>, <samp class="listingcharacter listingcharacter">write</samp>, and <samp class="listingcharacter listingcharacter">close</samp> with a call of <samp class="listingcharacter listingcharacter">appendFile</samp>, including the file name and message as arguments.</p>
        <p class="standard">Now that you can handle both reading and writing to files, it’s time for you to deal with another category of features of the <samp class="listingcharacter listingcharacter">fs</samp> module: directory operations.</p>
    </div><p class="signatur"/>
                    </body>
                </html>